id,original query
1,"WITH ""cte1"" AS (SELECT ""spend_date"",""user_id"" FROM ""spending"" GROUP BY ""spend_date"",""user_id"" HAVING COUNT(1)=1), ""cte2"" AS (SELECT ""c"".""spend_date"",'desktop' AS ""platform"",SUM(""amount"") AS ""total_amount"",COUNT(""c"".""user_id"") AS ""total_users"" FROM ""cte1"" AS ""c"" JOIN ""spending"" AS ""s"" ON ""c"".""spend_date""=""s"".""spend_date"" AND ""c"".""user_id""=""s"".""user_id"" WHERE ""platform""='desktop' GROUP BY ""c"".""spend_date"" UNION ALL SELECT ""c"".""spend_date"",'mobile' AS ""platform"",SUM(""amount"") AS ""total_amount"",COUNT(""c"".""user_id"") AS ""total_users"" FROM ""cte1"" AS ""c"" JOIN ""spending"" AS ""s"" ON ""c"".""spend_date""=""s"".""spend_date"" AND ""c"".""user_id""=""s"".""user_id"" WHERE ""platform""='mobile' GROUP BY ""c"".""spend_date"" UNION ALL SELECT ""spend_date"",'both' AS ""plat"",SUM(""sub"") AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM (SELECT ""spend_date"",""user_id"",SUM(""amount"") AS ""sub"" FROM ""spending"" GROUP BY ""spend_date"",""user_id"" HAVING COUNT(1)=2) AS ""r1"" GROUP BY ""spend_date""), ""cte3"" AS (SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""spending"" UNION ALL SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""spending"" UNION ALL SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""spending"") SELECT ""c3"".""spend_date"",""c3"".""platform"",COALESCE(""c2"".""total_amount"", 0) AS ""total_amount"",COALESCE(""c2"".""total_users"", 0) AS ""total_users"" FROM ""cte3"" AS ""c3"" LEFT JOIN ""cte2"" AS ""c2"" ON ""c3"".""spend_date""=""c2"".""spend_date"" AND ""c3"".""platform""=""c2"".""platform"""
2,"WITH ""all_date"" AS (SELECT ""spend_date"" FROM ""spending""), ""all_platform"" AS (SELECT 'desktop' AS ""platform"" UNION SELECT 'mobile' UNION SELECT 'both'), ""cte1"" AS (SELECT ""spend_date"",""platform"" FROM ""all_date"" AS ""d"" CROSS JOIN ""all_platform"" AS ""p""), ""cte2"" AS (SELECT ""user_id"",""spend_date"",STRING_AGG(""platform"", ',') AS ""platform"" FROM ""spending"" GROUP BY 1,2), ""cte3"" AS (SELECT ""c"".""spend_date"",(CASE WHEN ""c"".""platform""='desktop' THEN 'desktop' WHEN ""c"".""platform""='mobile' THEN 'mobile' ELSE 'both' END) AS ""platform"",SUM(""s"".""amount"") AS ""total_amount"",COUNT(DISTINCT ""s"".""user_id"") AS ""total_users"" FROM ""cte2"" AS ""c"" JOIN ""spending"" AS ""s"" ON ""c"".""user_id""=""s"".""user_id"" AND ""c"".""spend_date""=""s"".""spend_date"" GROUP BY 1,2) SELECT ""c1"".""spend_date"",""c1"".""platform"",COALESCE(""c3"".""total_amount"", 0) AS ""total_amount"",COALESCE(""c3"".""total_users"", 0) AS ""total_users"" FROM ""cte1"" AS ""c1"" LEFT JOIN ""cte3"" AS ""c3"" ON ""c1"".""spend_date""=""c3"".""spend_date"" AND ""c1"".""platform""=""c3"".""platform"" GROUP BY 1,2,3,4"
3,"WITH ""platform"" AS (SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""Spending"" UNION ALL SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""spending"" UNION ALL SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""spending"") SELECT ""p"".""spend_date"",""p"".""platform"",COALESCE(SUM(""s"".""amount""), 0) AS ""total_amount"",COALESCE(COUNT(DISTINCT ""s"".""user_id""), 0) AS ""total_users"" FROM ""platform"" AS ""p"" LEFT JOIN (SELECT ""user_id"",""spend_date"",SUM(""amount"") AS ""amount"",CASE WHEN COUNT(DISTINCT ""platform"")=2 THEN 'both' ELSE ""platform"" END AS ""platform"" FROM ""Spending"" GROUP BY ""user_id"",""spend_date"") AS ""s"" ON ""p"".""spend_date""=""s"".""spend_Date"" AND ""p"".""platform""=""s"".""platform"" GROUP BY ""p"".""spend_date"",""p"".""platform"""
4,"WITH ""date_platform"" AS (SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""Spending""), ""spending_platform"" AS (SELECT ""user_id"",""spend_date"",SUM(""amount"") AS ""amount"",CASE WHEN COUNT(""platform"")=1 THEN ""platform"" ELSE 'both' END AS ""platform"" FROM ""Spending"" GROUP BY ""user_id"",""spend_date"") SELECT ""spend_date"",""date_platform"".""platform"",SUM(COALESCE(""amount"", 0)) AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM ""date_platform"" LEFT JOIN ""spending_platform"" USING (""spend_date"",""platform"") GROUP BY ""spend_date"",""platform"""
5,"WITH ""cte"" AS (SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""spending"" UNION SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""spending"" UNION SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""spending"") SELECT ""a"".""spend_date"",""a"".""platform"",SUM(CASE WHEN ""b"".""platform"" IS NULL THEN 0 ELSE ""b"".""tot"" END) AS ""total_amount"",SUM(CASE WHEN ""b"".""platform"" IS NULL THEN 0 ELSE 1 END) AS ""total_users"" FROM ""cte"" AS ""a"" LEFT JOIN (SELECT ""user_id"",""spend_date"",COUNT(DISTINCT ""platform"") AS ""cnt"",(CASE WHEN COUNT(DISTINCT ""platform"")=2 THEN 'both' ELSE ""platform"" END) AS ""platform"",SUM(""amount"") AS ""tot"" FROM ""Spending"" GROUP BY ""user_id"",""spend_date"") AS ""b"" ON ""a"".""spend_date""=""b"".""spend_date"" AND ""a"".""platform""=""b"".""platform"" GROUP BY ""a"".""spend_date"",""a"".""platform"""
6,"WITH ""cte"" AS (SELECT ""user_id"",""spend_date"",SUM(DISTINCT CASE WHEN ""platform""='desktop' THEN 1 ELSE 2 END) AS ""type"",SUM(""amount"") AS ""amount"" FROM ""Spending"" GROUP BY ""spend_date"",""user_id"") SELECT ""sub1"".""spend_date"",""sub1"".""platform"",COALESCE(""sub2"".""total_amount"", 0) AS ""total_amount"",COALESCE(""sub2"".""total_users"", 0) AS ""total_users"" FROM (SELECT DISTINCT ""cte"".""spend_date"",""p"".""platform"" FROM ""cte"" CROSS JOIN (SELECT 'desktop' AS ""platform"" UNION SELECT 'mobile' UNION SELECT 'both') AS ""p"") AS ""sub1"" LEFT JOIN (SELECT ""spend_date"",CASE WHEN ""type""=1 THEN 'desktop' WHEN ""type""=2 THEN 'mobile' ELSE 'both' END AS ""platform"",SUM(""amount"") AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM ""cte"" GROUP BY ""spend_date"",""type"") AS ""sub2"" ON ""sub1"".""spend_date""=""sub2"".""spend_date"" AND ""sub1"".""platform""=""sub2"".""platform"""
7,"WITH ""t1"" AS (SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""Spending""), ""t2"" AS (SELECT ""user_id"",""spend_date"",CASE WHEN COUNT(DISTINCT ""platform"")=2 THEN 'both' ELSE ""platform"" END AS ""platform"",SUM(""amount"") AS ""amount"" FROM ""Spending"" GROUP BY ""spend_date"",""user_id"") SELECT ""t1"".*,COALESCE(SUM(""amount""), 0) AS ""total_amount"",COUNT(DISTINCT ""user_id"") AS ""total_users"" FROM ""t1"" LEFT JOIN ""t2"" USING (""spend_date"",""platform"") GROUP BY 1,2"
8,"WITH ""a"" AS (SELECT ""user_id"",""spend_date"",(CASE WHEN COUNT(""platform"")=2 THEN 'both' ELSE ""platform"" END) AS ""platform"",SUM(""amount"") AS ""amount"",1 AS ""isboth"" FROM ""spending"" GROUP BY ""user_id"",""spend_date""), ""aa"" AS (SELECT * FROM ""a"" UNION ALL SELECT ""user_id"",""spend_date"",'desktop' AS ""platform"",0 AS ""amount"",0 AS ""isboth"" FROM ""a"" UNION ALL SELECT ""user_id"",""spend_date"",'mobile' AS ""platform"",0 AS ""amount"",0 AS ""isboth"" FROM ""a"" UNION ALL SELECT ""user_id"",""spend_date"",'both' AS ""platform"",0 AS ""amount"",0 AS ""isboth"" FROM ""a"") SELECT ""spend_date"",""platform"",SUM(""amount"") AS ""total_amount"",SUM(""isboth"") AS ""total_users"" FROM ""aa"" GROUP BY ""spend_date"",""platform"" ORDER BY FIELD(""platform"", 'desktop', 'mobile', 'both'),""spend_date"""
9,"WITH ""cte"" AS ((SELECT ""user_id"",""spend_date"",""platform"",SUM(""amount"") AS ""amount"" FROM ""Spending"" GROUP BY 1,2 HAVING COUNT(DISTINCT ""platform"")=1) UNION ALL (SELECT ""user_id"",""spend_date"",'both' AS ""platform"",SUM(""amount"") AS ""amount"" FROM ""Spending"" GROUP BY ""user_id"",""spend_date"" HAVING COUNT(DISTINCT ""platform"")=2)), ""cte1"" AS (SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""Spending"" UNION (SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""Spending"") UNION (SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""Spending"")) SELECT ""cte1"".""spend_date"",""cte1"".""platform"",COALESCE(SUM(""cte"".""amount""), 0) AS ""total_amount"",COUNT(DISTINCT ""cte"".""user_id"") AS ""total_users"" FROM ""cte1"" LEFT JOIN ""cte"" ON ""cte1"".""spend_date""=""cte"".""spend_date"" AND ""cte1"".""platform""=""cte"".""platform"" GROUP BY ""cte1"".""spend_date"",""cte1"".""platform"""
10,"ERROR: mysql parse error: line 1 column 236 near ""as s1 right join spending as s2 on s1.spend_date=s2.spend_date and s1.user_id=s2.user_id)) select t2.spend_date , t2.platform , if(t1.total_amount is null, 0, t1.total_amount) as total_amount , if(t1.total_users is null, 0, t1.total_users) as total_users from ( select spend_date , platform , sum(amount) as total_amount , count(distinct user_id) as total_users from temp group by spend_date, platform order by platform, spend_date) as t1 right join ( select distinct(spend_date), 'desktop' platform from Spending union select distinct(spend_date), 'mobile' platform from Spending union select distinct(spend_date), 'both' platform from Spending) as t2 on t1.spend_date = t2.spend_date and t1.platform = t2.platform "" "
11,"WITH ""t1"" AS (SELECT ""user_id"",""spend_date"",SUM(""amount"") AS ""total_amount"",CASE WHEN SUM(""platform""='desktop')=0 THEN 1 ELSE 0 END AS ""mobile"",CASE WHEN SUM(""platform""='mobile')=0 THEN 1 ELSE 0 END AS ""desktop"",CASE WHEN SUM(""platform""='desktop')=0 OR SUM(""platform""='mobile')=0 THEN 0 ELSE 1 END AS ""both"" FROM ""Spending"" GROUP BY 1,2) SELECT ""spend_date"",'mobile' AS ""platform"",SUM(""total_amount""*""mobile"") AS ""total_amount"",SUM(""mobile"") AS ""total_users"" FROM ""t1"" GROUP BY 1 UNION ALL SELECT ""spend_date"",'desktop' AS ""platform"",SUM(""total_amount""*""desktop"") AS ""total_amount"",SUM(""desktop"") AS ""total_users"" FROM ""t1"" GROUP BY 1 UNION ALL SELECT ""spend_date"",'both' AS ""platform"",SUM(""total_amount""*""both"") AS ""total_amount"",SUM(""both"") AS ""total_users"" FROM ""t1"" GROUP BY 1"
12,"WITH ""cte"" AS (SELECT ""spend_date"",""user_id"",SUM(CASE WHEN ""platform""='mobile' THEN ""amount"" ELSE 0 END) AS ""mobile_spent"",SUM(CASE WHEN ""platform""='desktop' THEN ""amount"" ELSE 0 END) AS ""desktop_spent"" FROM ""Spending"" GROUP BY 1,2), ""cte_2"" AS (SELECT ""spend_date"",""user_id"",CASE WHEN ""mobile_spent"">0 AND ""desktop_spent"">0 THEN ""mobile_spent""+""desktop_spent"" ELSE 0 END AS ""both_spent"",CASE WHEN ""mobile_spent"">0 AND ""desktop_spent""=0 THEN ""mobile_spent"" ELSE 0 END AS ""mobile_spent"",CASE WHEN ""mobile_spent""=0 AND ""desktop_spent"">0 THEN ""desktop_spent"" ELSE 0 END AS ""desktop_spent"" FROM ""cte"") SELECT ""spend_date"",'both' AS ""platform"",SUM(""both_spent"") AS ""total_amount"",SUM(CASE WHEN ""both_spent"">0 THEN 1 ELSE 0 END) AS ""total_users"" FROM ""cte_2"" GROUP BY 1,2 UNION SELECT ""spend_date"",'mobile' AS ""platform"",SUM(""mobile_spent"") AS ""total_amount"",SUM(CASE WHEN ""mobile_spent"">0 THEN 1 ELSE 0 END) AS ""total_users"" FROM ""cte_2"" GROUP BY 1,2 UNION SELECT ""spend_date"",'desktop' AS ""platform"",SUM(""desktop_spent"") AS ""total_amount"",SUM(CASE WHEN ""desktop_spent"">0 THEN 1 ELSE 0 END) AS ""total_users"" FROM ""cte_2"" GROUP BY 1,2"
13,"WITH ""agg"" AS (SELECT ""spend_date"",""user_id"",CASE WHEN COUNT(DISTINCT ""platform"")>1 THEN 'both' ELSE MAX(""platform"") END AS ""platform"",SUM(""amount"") AS ""amt"" FROM ""spending"" GROUP BY 1,2), ""agg2"" AS (SELECT ""spend_date"",""platform"",SUM(""amt"") AS ""total_amount"",COUNT(DISTINCT ""user_id"") AS ""total_users"" FROM ""agg"" GROUP BY 1,2 ORDER BY 1,4), ""rec"" AS (SELECT DISTINCT ""spend_date"",""p"".""platform"" FROM ""spending"" AS ""s"" CROSS JOIN (SELECT 'desktop' AS ""platform"" UNION SELECT 'mobile' UNION SELECT 'both') AS ""p"") SELECT ""r"".""spend_date"",""r"".""platform"",COALESCE(""a"".""total_amount"", 0) AS ""total_amount"",COALESCE(""a"".""total_users"", 0) AS ""total_users"" FROM ""rec"" AS ""r"" LEFT JOIN ""agg2"" AS ""a"" ON ""r"".""spend_date""=""a"".""spend_date"" AND ""r"".""platform""=""a"".""platform"""
14,"WITH ""cte"" AS (SELECT ""s"".*,CASE WHEN ""cnt""=2 THEN 'both' ELSE ""s"".""platform"" END AS ""new_platform"" FROM (SELECT ""s"".*,COUNT(""platform"") OVER (PARTITION BY ""user_id"", ""spend_date"") AS ""cnt"" FROM ""Spending"" AS ""s"") AS ""s""), ""cte2"" AS (SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""Spending"" UNION ALL SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""Spending"" UNION ALL SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""Spending"") SELECT ""cte2"".""spend_date"",""cte2"".""platform"",COALESCE(SUM(""amount""), 0) AS ""total_amount"",COUNT(DISTINCT ""user_id"") AS ""total_users"" FROM ""cte2"" LEFT JOIN ""cte"" ON ""cte2"".""spend_date""=""cte"".""spend_date"" AND ""cte2"".""platform""=""new_platform"" GROUP BY ""cte2"".""spend_date"",""cte2"".""platform"""
15,"SELECT ""p"".""spend_date"",""p"".""platform"",COALESCE(SUM(""amount""), 0) AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM (SELECT DISTINCT (""spend_date""),'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'both' AS ""platform"" FROM ""Spending"") AS ""p"" LEFT JOIN (SELECT ""spend_date"",""user_id"",CASE WHEN ""mobile_amount"">0 THEN CASE WHEN ""desktop_amount"">0 THEN 'both' ELSE 'mobile' END ELSE 'desktop' END AS ""platform"",(""mobile_amount""+""desktop_amount"") AS ""amount"" FROM (SELECT ""spend_date"",""user_id"",SUM(CASE ""platform"" WHEN 'mobile' THEN ""amount"" ELSE 0 END) AS ""mobile_amount"",SUM(CASE ""platform"" WHEN 'desktop' THEN ""amount"" ELSE 0 END) AS ""desktop_amount"" FROM ""Spending"" GROUP BY ""spend_date"",""user_id"") AS ""o"") AS ""t"" ON ""p"".""platform""=""t"".""platform"" AND ""p"".""spend_date""=""t"".""spend_date"" GROUP BY ""spend_date"",""platform"""
16,"SELECT ""tmp2"".""spend_date"",""tmp2"".""platform"",COALESCE(SUM(""total_amount""), 0) AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM (SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""Spending"") AS ""tmp2"" LEFT JOIN (SELECT ""spend_date"",""user_id"",(CASE WHEN ""ma"">0 AND ""da"">0 THEN 'both' WHEN ""ma"">0 AND ""da""=0 THEN 'mobile' ELSE 'desktop' END) AS ""platform"",(""da""+""ma"") AS ""total_amount"" FROM (SELECT ""spend_date"",""user_id"",SUM(CASE WHEN ""platform""='mobile' THEN ""amount"" ELSE 0 END) AS ""ma"",SUM(CASE WHEN ""platform""='desktop' THEN ""amount"" ELSE 0 END) AS ""da"" FROM ""Spending"" GROUP BY ""spend_date"",""user_id"") AS ""tmp1"") AS ""tmp3"" ON ""tmp2"".""platform""=""tmp3"".""platform"" AND ""tmp2"".""spend_date""=""tmp3"".""spend_date"" GROUP BY ""spend_date"",""platform"""
17,"WITH ""cte"" AS (SELECT ""user_id"",""spend_date"",SUM(""amount"") AS ""amount"",CASE WHEN SUM(""platform_n"")=3 THEN 'both' ELSE ""platform"" END AS ""new_platform"" FROM (SELECT ""user_id"",""spend_date"",""platform"",""amount"",CASE WHEN ""platform""='mobile' THEN 2 ELSE 1 END AS ""platform_n"" FROM ""Spending"") AS ""A"" GROUP BY ""user_id"",""spend_date"") SELECT DISTINCT ""A"".""spend_date"",""platform"",COALESCE(SUM(""B"".""amount""), 0) AS ""total_amount"",COALESCE(COUNT(DISTINCT ""B"".""user_id""), 0) AS ""total_users"" FROM (SELECT DISTINCT (""spend_date""),'desktop' AS ""platform"" FROM ""Spending"" UNION ALL SELECT DISTINCT (""spend_date""),'mobile' AS ""platform"" FROM ""Spending"" UNION ALL SELECT DISTINCT (""spend_date""),'both' AS ""platform"" FROM ""Spending"") AS ""A"" LEFT JOIN ""cte"" AS ""B"" ON ""A"".""spend_date""=""B"".""spend_date"" AND ""A"".""platform""=""B"".""new_platform"" GROUP BY ""A"".""spend_date"",""A"".""platform"""
18,"WITH ""platforms_per_user"" AS (SELECT ""user_id"",""spend_date"",COUNT(1) AS ""total_platforms"" FROM ""spending"" GROUP BY 1,2), ""all_combos"" AS (SELECT ""spend_date"",""platform"" FROM (SELECT 'mobile' AS ""platform"" UNION ALL SELECT 'desktop' AS ""platform"" UNION ALL SELECT 'both' AS ""platform"") AS ""f"" CROSS JOIN (SELECT DISTINCT ""spend_date"" FROM ""spending"") AS ""g"") SELECT ""a"".""spend_date"",""a"".""platform"",COALESCE(""total_amount"", 0) AS ""total_amount"",COALESCE(""total_users"", 0) AS ""total_users"" FROM ""all_combos"" AS ""a"" LEFT JOIN (SELECT ""s"".""spend_date"",CASE WHEN ""total_platforms""=2 THEN 'both' ELSE ""platform"" END AS ""platform"",SUM(""amount"") AS ""total_amount"",COUNT(DISTINCT ""s"".""user_id"") AS ""total_users"" FROM ""spending"" AS ""s"" JOIN ""platforms_per_user"" AS ""p"" ON ""p"".""user_id""=""s"".""user_id"" AND ""p"".""spend_date""=""s"".""spend_date"" GROUP BY 1,2) AS ""g"" ON ""a"".""spend_date""=""g"".""spend_date"" AND ""a"".""platform""=""g"".""platform"""
19,"WITH ""user_platform"" AS (SELECT ""user_id"",""spend_date"",CASE WHEN COUNT(DISTINCT ""platform"")=2 THEN 'both' ELSE ""platform"" END AS ""platform_new"",SUM(""amount"") AS ""amount"" FROM ""Spending"" GROUP BY 1,2), ""report_platform"" AS (SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""Spending"") SELECT ""report_platform"".""spend_date"" AS ""spend_date"",""report_platform"".""platform"" AS ""platform"",COALESCE(SUM(""amount""), 0) AS ""total_amount"",COALESCE(COUNT(DISTINCT ""user_id""), 0) AS ""total_users"" FROM ""report_platform"" LEFT JOIN ""user_platform"" ON ""report_platform"".""platform""=""user_platform"".""platform_new"" AND ""report_platform"".""spend_date""=""user_platform"".""spend_date"" GROUP BY 1,2"
20,"WITH ""t1"" AS (SELECT ""spend_date"",""user_id"",CASE WHEN COUNT(DISTINCT ""platform"")=2 THEN 'both' ELSE ""platform"" END AS ""platform"",SUM(""amount"") AS ""amount"" FROM ""Spending"" GROUP BY 1,2), ""t2"" AS (SELECT DISTINCT (""spend_date""),'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'both' AS ""platform"" FROM ""Spending"") SELECT ""t2"".*,COALESCE(SUM(""amount""), 0) AS ""total_amount"",COUNT(DISTINCT ""user_id"") AS ""total_users"" FROM ""t2"" LEFT JOIN ""t1"" ON ""t2"".""spend_date""=""t1"".""spend_date"" AND ""t2"".""platform""=""t1"".""platform"" GROUP BY 1,2"
21,"WITH ""platform_id"" AS (SELECT ""user_id"",""spend_date"",CASE WHEN (COUNT(""platform"") OVER (PARTITION BY ""user_id"", ""spend_date""))=2 THEN 'both' ELSE ""platform"" END AS ""platform"",""amount"" FROM ""spending""), ""platform_spend"" AS (SELECT ""spend_date"",""platform"",SUM(""amount"") AS ""total_amount"",COUNT(DISTINCT ""user_id"") AS ""total_users"" FROM ""platform_id"" GROUP BY ""spend_date"",""platform""), ""all_platform"" (""platform"") AS (VALUES ROW('mobile'), ROW('desktop'), ROW('both')), ""data_platform_combo"" AS (SELECT DISTINCT ""a"".""spend_date"",""b"".""platform"" FROM (""platform_id"" AS ""a"") CROSS JOIN ""all_platform"" AS ""b"") SELECT ""d"".""spend_date"",""d"".""platform"",COALESCE(""total_amount"", 0) AS ""total_amount"",COALESCE(""total_users"", 0) AS ""total_users"" FROM ""data_platform_combo"" AS ""d"" LEFT JOIN ""platform_spend"" AS ""p"" USING (""spend_date"",""platform"") ORDER BY ""spend_date"""
22,"WITH ""CTE"" AS (SELECT ""user_id"",""spend_date"",SUM(CASE ""platform"" WHEN 'mobile' THEN ""amount"" ELSE 0 END) AS ""ma"",SUM(CASE ""platform"" WHEN 'desktop' THEN ""amount"" ELSE 0 END) AS ""da"" FROM ""Spending"" GROUP BY ""user_id"",""spend_date"") SELECT ""spend_date"",'desktop' AS ""platform"",SUM(CASE WHEN ""da"">0 AND ""ma""=0 THEN ""da"" ELSE 0 END) AS ""total_amount"",SUM(CASE WHEN ""da"">0 AND ""ma""=0 THEN 1 ELSE 0 END) AS ""total_users"" FROM ""CTE"" GROUP BY ""spend_date"" UNION ALL SELECT ""spend_date"",'mobile' AS ""platform"",SUM(CASE WHEN ""ma"">0 AND ""da""=0 THEN ""ma"" ELSE 0 END) AS ""total_amount"",SUM(CASE WHEN ""ma"">0 AND ""da""=0 THEN 1 ELSE 0 END) AS ""total_users"" FROM ""CTE"" GROUP BY ""spend_date"" UNION ALL SELECT ""spend_date"",'both' AS ""platform"",SUM(CASE WHEN ""da"">0 AND ""ma"">0 THEN ""ma""+""da"" ELSE 0 END) AS ""total_amount"",SUM(CASE WHEN ""da"">0 AND ""ma"">0 THEN 1 ELSE 0 END) AS ""total_users"" FROM ""CTE"" GROUP BY ""spend_date"""
23,"WITH ""CTE"" AS (SELECT DISTINCT ""spend_date"",""t1"".""platform"" FROM ""Spending"" AS ""s"" CROSS JOIN (SELECT 'desktop' AS ""platform"" UNION SELECT 'mobile' AS ""platform"" UNION SELECT 'both' AS ""platform"") AS ""t1"") SELECT ""CTE"".""spend_date"",""CTE"".""platform"",COALESCE(SUM(""amount""), 0) AS ""total_amount"",COALESCE(COUNT(""user_id""), 0) AS ""total_users"" FROM (SELECT ""user_id"",""spend_date"",CASE WHEN COUNT(""platform"")=2 THEN 'both' ELSE ""platform"" END AS ""platform"",SUM(""amount"") AS ""amount"" FROM ""Spending"" AS ""s"" GROUP BY ""user_id"",""spend_date"") AS ""temp"" RIGHT JOIN ""CTE"" ON ""temp"".""spend_date""=""CTE"".""spend_date"" AND ""temp"".""platform""=""CTE"".""platform"" GROUP BY ""CTE"".""spend_date"",""CTE"".""platform"""
24,"SELECT ""c"".""spend_date"",""c"".""platform"",SUM(COALESCE(""amount"", 0)) AS ""total_amount"",SUM(CASE WHEN ""amount"" IS NULL THEN 0 ELSE 1 END) AS ""total_users"" FROM (SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""spending"" UNION ALL SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""spending"" UNION ALL SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""spending"") AS ""c"" LEFT JOIN (SELECT ""user_id"",""spend_date"",CASE WHEN COUNT(1)=1 THEN ""platform"" ELSE 'both' END AS ""platform"",SUM(""amount"") AS ""amount"" FROM ""spending"" GROUP BY ""user_id"",""spend_date"") AS ""v"" ON ""c"".""spend_date""=""v"".""spend_date"" AND ""c"".""platform""=""v"".""platform"" GROUP BY ""spend_date"",""platform"""
25,"WITH ""user_platform"" AS (SELECT ""user_id"",""spend_date"",(CASE WHEN COUNT(1)=2 THEN 'both' ELSE ""platform"" END) AS ""platform"",SUM(""amount"") AS ""amount"" FROM ""Spending"" GROUP BY ""user_id"",""spend_date""), ""platform"" AS ((SELECT 'both' AS ""platform"") UNION (SELECT 'mobile' AS ""platform"") UNION (SELECT 'desktop' AS ""platform"")), ""spend_date"" AS (SELECT DISTINCT ""spend_date"" FROM ""Spending"") SELECT ""a"".""spend_date"",""b"".""platform"",COALESCE(SUM(""c"".""amount""), 0) AS ""total_amount"",COUNT(DISTINCT ""c"".""user_id"") AS ""total_users"" FROM (""spend_date"" AS ""a"" JOIN ""platform"" AS ""b"" ON 1=1) LEFT JOIN ""user_platform"" AS ""c"" ON ""a"".""spend_date""=""c"".""spend_date"" AND ""b"".""platform""=""c"".""platform"" GROUP BY ""a"".""spend_date"",""b"".""platform"""
26,"WITH ""cte"" AS (SELECT DISTINCT ""spend_Date"",'both' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT ""spend_Date"",'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT ""spend_Date"",'mobile' AS ""platform"" FROM ""Spending"") SELECT ""c"".""spend_date"",""c"".""platform"",SUM(CASE WHEN ""a"".""platform"" IS NULL THEN 0 ELSE ""amount"" END) AS ""total_amount"",SUM(CASE WHEN ""a"".""platform"" IS NULL THEN 0 ELSE 1 END) AS ""total_users"" FROM ""cte"" AS ""c"" LEFT JOIN (SELECT ""user_id"",""spend_Date"",SUM(""amount"") AS ""amount"",COUNT(DISTINCT ""platform"") AS ""cnt"",CASE WHEN COUNT(DISTINCT ""platform"")=2 THEN 'both' ELSE ""platform"" END AS ""platform"" FROM ""Spending"" AS ""s"" GROUP BY ""user_id"",""spend_date"") AS ""a"" ON ""c"".""spend_date""=""a"".""spend_date"" AND ""c"".""platform""=""a"".""platform"" GROUP BY ""c"".""spend_date"",""c"".""platform"""
27,"WITH ""cte"" AS (SELECT ""spend_date"",""user_id"",MAX(""platform"") AS ""platform"",COUNT(DISTINCT ""platform"") AS ""cnt"",SUM(""amount"") AS ""amount"" FROM ""Spending"" GROUP BY ""spend_date"",""user_id"" ORDER BY 1,2) SELECT ""d"".""spend_date"",""p"".""platform"",COALESCE(SUM(""cte2"".""amount""), 0) AS ""total_amount"",COALESCE(COUNT(DISTINCT ""cte2"".""user_id""), 0) AS ""total_users"" FROM ((SELECT DISTINCT ""spend_date"" FROM ""Spending"") AS ""d"" JOIN (SELECT 'desktop' AS ""platform"" UNION ALL SELECT 'mobile' UNION ALL SELECT 'both') AS ""p"" ON 1=1) LEFT JOIN (SELECT ""spend_date"",""user_id"",""amount"",CASE WHEN ""cnt"">1 THEN 'both' ELSE ""platform"" END AS ""platform"" FROM ""cte"") AS ""cte2"" ON ""d"".""spend_date""=""cte2"".""spend_date"" AND ""cte2"".""platform""=""p"".""platform"" GROUP BY ""d"".""spend_date"",""p"".""platform"" ORDER BY 1"
28,"WITH ""agg"" AS (SELECT ""spend_date"",""user_id"",CASE WHEN COUNT(DISTINCT ""platform"")>1 THEN 'both' ELSE MAX(""platform"") END AS ""platform"",SUM(""amount"") AS ""amt"" FROM ""spending"" GROUP BY 1,2), ""agg2"" AS (SELECT ""spend_date"",""platform"",SUM(""amt"") AS ""total_amount"",COUNT(DISTINCT ""user_id"") AS ""total_users"" FROM ""agg"" GROUP BY 1,2 ORDER BY 1,4), ""rec"" AS (SELECT DISTINCT ""spend_date"",""p"".""platform"" FROM ""spending"" AS ""s"" CROSS JOIN (SELECT 'desktop' AS ""platform"" UNION SELECT 'mobile' UNION SELECT 'both') AS ""p"") SELECT ""r"".""spend_date"",""r"".""platform"",COALESCE(""a"".""total_amount"", 0) AS ""total_amount"",COALESCE(""a"".""total_users"", 0) AS ""total_users"" FROM ""rec"" AS ""r"" LEFT JOIN ""agg2"" AS ""a"" ON ""r"".""spend_date""=""a"".""spend_date"" AND ""r"".""platform""=""a"".""platform"""
29,"WITH ""cnt"" AS (SELECT ""spend_date"",""user_id"",SUM(CASE WHEN ""platform""='mobile' THEN ""amount"" ELSE 0 END) AS ""mobile_amount"",SUM(CASE WHEN ""platform""='desktop' THEN ""amount"" ELSE 0 END) AS ""desktop_amount"" FROM ""Spending"" AS ""s"" GROUP BY ""spend_date"",""user_id""), ""header"" AS (SELECT DISTINCT (""spend_date""),'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'both' AS ""platform"" FROM ""Spending"") SELECT ""h"".""spend_date"",""h"".""platform"",COALESCE(SUM(""amount""), 0) AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM ""header"" AS ""h"" LEFT JOIN (SELECT ""spend_date"",""user_id"",CASE WHEN ""mobile_amount"">0 THEN CASE WHEN ""desktop_amount"">0 THEN 'both' ELSE 'mobile' END ELSE 'desktop' END AS ""platform"",(""mobile_amount""+""desktop_amount"") AS ""amount"" FROM ""cnt"") AS ""a"" ON ""h"".""spend_date""=""a"".""spend_date"" AND ""h"".""platform""=""a"".""platform"" GROUP BY ""h"".""spend_date"",""h"".""platform"""
30,"WITH ""cte"" AS (SELECT ""user_id"",""spend_date"",SUM(""amount"") AS ""amount"",CASE WHEN SUM(""platform""='desktop')=0 THEN 1 ELSE 0 END AS ""mobile"",CASE WHEN SUM(""platform""='mobile')=0 THEN 1 ELSE 0 END AS ""desktop"",CASE WHEN SUM(""platform""='desktop')=0 OR SUM(""platform""='mobile')=0 THEN 0 ELSE 1 END AS ""both"" FROM ""Spending"" GROUP BY 1,2) SELECT ""spend_date"",'mobile' AS ""platform"",SUM(""amount""*""mobile"") AS ""total_amount"",SUM(""mobile"") AS ""total_users"" FROM ""cte"" GROUP BY 1 UNION ALL SELECT ""spend_date"",'desktop' AS ""platform"",SUM(""amount""*""desktop"") AS ""total_amount"",SUM(""desktop"") AS ""total_users"" FROM ""cte"" GROUP BY 1 UNION ALL SELECT ""spend_date"",'both' AS ""platform"",SUM(""amount""*""both"") AS ""total_amount"",SUM(""both"") AS ""total_users"" FROM ""cte"" GROUP BY 1"
31,"WITH ""temp"" AS (SELECT *,COUNT(""user_id"") OVER (PARTITION BY ""spend_date"", ""user_id"") AS ""type"" FROM ""spending"") SELECT ""spend_date"",'both' AS ""platform"",SUM(CASE WHEN ""type""=2 THEN ""amount"" ELSE 0 END) AS ""total_amount"",COUNT(DISTINCT CASE WHEN ""type""=2 THEN ""user_id"" ELSE NULL END) AS ""total_users"" FROM ""temp"" GROUP BY ""spend_date"" UNION (SELECT ""spend_date"",'desktop' AS ""platform"",SUM(CASE WHEN ""type""=1 AND ""platform""='desktop' THEN ""amount"" ELSE 0 END) AS ""total_amount"",COUNT(DISTINCT CASE WHEN ""type""=1 AND ""platform""='desktop' THEN ""user_id"" ELSE NULL END) AS ""total_users"" FROM ""temp"" GROUP BY ""spend_date"") UNION (SELECT ""spend_date"",'mobile' AS ""platform"",SUM(CASE WHEN ""type""=1 AND ""platform""='mobile' THEN ""amount"" ELSE 0 END) AS ""total_amount"",COUNT(DISTINCT CASE WHEN ""type""=1 AND ""platform""='mobile' THEN ""user_id"" ELSE NULL END) AS ""total_users"" FROM ""temp"" GROUP BY ""spend_date"")"
32,"WITH ""mobile_only"" AS (SELECT ""spend_date"",SUM(""amount"") AS ""total_amount"",COUNT(1) AS ""total_users"" FROM (SELECT ""user_id"",""spend_date"",SUM(""amount"") AS ""amount"" FROM ""Spending"" GROUP BY ""user_id"",""spend_date"" HAVING SUM(CASE WHEN ""platform""='mobile' THEN 1 ELSE 0 END)>0 AND SUM(CASE WHEN ""platform""='desktop' THEN 1 ELSE 0 END)=0) AS ""X1"" GROUP BY ""spend_date""), ""desktop_only"" AS (SELECT ""spend_date"",SUM(""amount"") AS ""total_amount"",COUNT(1) AS ""total_users"" FROM (SELECT ""user_id"",""spend_date"",SUM(""amount"") AS ""amount"" FROM ""Spending"" GROUP BY ""user_id"",""spend_date"" HAVING SUM(CASE WHEN ""platform""='mobile' THEN 1 ELSE 0 END)=0 AND SUM(CASE WHEN ""platform""='desktop' THEN 1 ELSE 0 END)>0) AS ""X2"" GROUP BY ""spend_date""), ""both_des_mo"" AS (SELECT ""spend_date"",SUM(""amount"") AS ""total_amount"",COUNT(1) AS ""total_users"" FROM (SELECT ""user_id"",""spend_date"",SUM(""amount"") AS ""amount"" FROM ""Spending"" GROUP BY ""user_id"",""spend_date"" HAVING SUM(CASE WHEN ""platform""='mobile' THEN 1 ELSE 0 END)>0 AND SUM(CASE WHEN ""platform""='desktop' THEN 1 ELSE 0 END)>0) AS ""X3"" GROUP BY ""spend_date"") (SELECT ""f1"".""spend_date"",""f1"".""platform"",COALESCE(""total_amount"", 0) AS ""total_amount"",COALESCE(""total_users"", 0) AS ""total_users"" FROM ""mobile_only"" AS ""d"" RIGHT JOIN (SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""Spending"") AS ""f1"" ON ""d"".""spend_date""=""f1"".""spend_date"") UNION (SELECT ""f2"".""spend_date"",""f2"".""platform"",COALESCE(""total_amount"", 0) AS ""total_amount"",COALESCE(""total_users"", 0) AS ""total_users"" FROM ""desktop_only"" AS ""d"" RIGHT JOIN (SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""Spending"") AS ""f2"" ON ""d"".""spend_date""=""f2"".""spend_date"") UNION (SELECT ""f3"".""spend_date"",""f3"".""platform"",COALESCE(""total_amount"", 0) AS ""total_amount"",COALESCE(""total_users"", 0) AS ""total_users"" FROM ""both_des_mo"" AS ""d"" RIGHT JOIN (SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""Spending"") AS ""f3"" ON ""d"".""spend_date""=""f3"".""spend_date"")"
33,"WITH ""t"" AS (SELECT DISTINCT (""spend_date""),'desktop' AS ""platform"" FROM ""spending"" UNION SELECT DISTINCT (""spend_date""),'mobile' AS ""platform"" FROM ""spending"" UNION SELECT DISTINCT (""spend_date""),'both' AS ""platform"" FROM ""spending"") SELECT ""t"".""spend_date"",""t"".""platform"",COALESCE(SUM(""total_amount""), 0) AS ""total_amount"",COALESCE(COUNT(DISTINCT ""user_id""), 0) AS ""total_users"" FROM ""t"" LEFT JOIN (SELECT ""user_id"",""spend_date"",CASE WHEN ""mobile"">0 THEN CASE WHEN ""desktop"">0 THEN 'both' ELSE 'mobile' END ELSE 'desktop' END AS ""platform"",(""mobile""+""desktop"") AS ""total_amount"" FROM (SELECT ""user_id"",""spend_date"",SUM(CASE WHEN ""platform""='mobile' THEN ""amount"" ELSE 0 END) AS ""mobile"",SUM(CASE WHEN ""platform""='desktop' THEN ""amount"" ELSE 0 END) AS ""desktop"" FROM ""spending"" GROUP BY 1,2) AS ""t1"") AS ""t3"" ON ""t"".""platform""=""t3"".""platform"" AND ""t"".""spend_date""=""t3"".""spend_date"" GROUP BY ""t"".""spend_date"",""t"".""platform"""
34,"WITH ""cte"" AS (SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""Spending"" UNION ALL SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""Spending"" UNION ALL SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""Spending""), ""cte2"" AS (SELECT ""a"".""spend_date"",CASE WHEN ""b"".""platform"" IS NOT NULL THEN 'both' ELSE ""a"".""platform"" END AS ""platform"",SUM(""a"".""amount"") AS ""total_amount"",COUNT(DISTINCT ""a"".""user_id"") AS ""total_users"" FROM ""Spending"" AS ""a"" LEFT JOIN ""Spending"" AS ""b"" ON ""a"".""user_id""=""b"".""user_id"" AND ""a"".""spend_date""=""b"".""spend_date"" AND ""a"".""platform""!=""b"".""platform"" GROUP BY ""a"".""spend_date"",""platform"") SELECT ""cte"".""spend_date"",""cte"".""platform"",COALESCE(""cte2"".""total_amount"", 0) AS ""total_amount"",COALESCE(""cte2"".""total_users"", 0) AS ""total_users"" FROM ""cte2"" RIGHT JOIN ""cte"" ON ""cte2"".""spend_date""=""cte"".""spend_date"" AND ""cte2"".""platform""=""cte"".""platform"""
35,"WITH ""a"" AS (SELECT ""user_id"",""spend_date"",(CASE WHEN COUNT(""platform"")=2 THEN 'both' ELSE ""platform"" END) AS ""platform"",SUM(""amount"") AS ""amount"",1 AS ""isboth"" FROM ""spending"" GROUP BY ""user_id"",""spend_date""), ""aa"" AS (SELECT * FROM ""a"" UNION ALL SELECT ""user_id"",""spend_date"",'desktop' AS ""platform"",0 AS ""amount"",0 AS ""isboth"" FROM ""a"" UNION ALL SELECT ""user_id"",""spend_date"",'mobile' AS ""platform"",0 AS ""amount"",0 AS ""isboth"" FROM ""a"" UNION ALL SELECT ""user_id"",""spend_date"",'both' AS ""platform"",0 AS ""amount"",0 AS ""isboth"" FROM ""a"") SELECT ""spend_date"",""platform"",SUM(""amount"") AS ""total_amount"",SUM(""isboth"") AS ""total_users"" FROM ""aa"" GROUP BY ""spend_date"",""platform"" ORDER BY FIELD(""platform"", 'desktop', 'mobile', 'both'),""spend_date"""
36,"WITH ""cte"" AS (SELECT ""user_id"",""spend_date"",SUM(""amount"") AS ""amount"",CASE WHEN SUM(""platform""='desktop')=0 THEN 1 ELSE 0 END AS ""mobile"",CASE WHEN SUM(""platform""='mobile')=0 THEN 1 ELSE 0 END AS ""desktop"",CASE WHEN SUM(""platform""='desktop')=0 OR SUM(""platform""='mobile')=0 THEN 0 ELSE 1 END AS ""both"" FROM ""Spending"" GROUP BY 1,2) SELECT ""spend_date"",'mobile' AS ""platform"",SUM(""amount""*""mobile"") AS ""total_amount"",SUM(""mobile"") AS ""total_users"" FROM ""cte"" GROUP BY 1 UNION ALL SELECT ""spend_date"",'desktop' AS ""platform"",SUM(""amount""*""desktop"") AS ""total_amount"",SUM(""desktop"") AS ""total_users"" FROM ""cte"" GROUP BY 1 UNION ALL SELECT ""spend_date"",'both' AS ""platform"",SUM(""amount""*""both"") AS ""total_amount"",SUM(""both"") AS ""total_users"" FROM ""cte"" GROUP BY 1"
37,"WITH ""cte"" AS (SELECT ""user_id"",""spend_date"",SUM(""amount"") AS ""amount"",CASE WHEN SUM(""platform""='desktop')=0 THEN 1 ELSE 0 END AS ""mobile"",CASE WHEN SUM(""platform""='mobile')=0 THEN 1 ELSE 0 END AS ""desktop"",CASE WHEN SUM(""platform""='desktop')=0 OR SUM(""platform""='mobile')=0 THEN 0 ELSE 1 END AS ""both"" FROM ""Spending"" GROUP BY 1,2) SELECT ""spend_date"",'mobile' AS ""platform"",SUM(""amount""*""mobile"") AS ""total_amount"",SUM(""mobile"") AS ""total_users"" FROM ""cte"" GROUP BY 1 UNION ALL SELECT ""spend_date"",'desktop' AS ""platform"",SUM(""amount""*""desktop"") AS ""total_amount"",SUM(""desktop"") AS ""total_users"" FROM ""cte"" GROUP BY 1 UNION ALL SELECT ""spend_date"",'both' AS ""platform"",SUM(""amount""*""both"") AS ""total_amount"",SUM(""both"") AS ""total_users"" FROM ""cte"" GROUP BY 1"
38,"SELECT ""p"".""spend_date"",""p"".""platform"",COALESCE(SUM(""amount""), 0) AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM (SELECT DISTINCT (""spend_date""),'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'both' AS ""platform"" FROM ""Spending"") AS ""p"" LEFT JOIN (SELECT ""spend_date"",""user_id"",CASE WHEN ""mobile_amount"">0 THEN CASE WHEN ""desktop_amount"">0 THEN 'both' ELSE 'mobile' END ELSE 'desktop' END AS ""platform"",(""mobile_amount""+""desktop_amount"") AS ""amount"" FROM (SELECT ""spend_date"",""user_id"",SUM(CASE ""platform"" WHEN 'mobile' THEN ""amount"" ELSE 0 END) AS ""mobile_amount"",SUM(CASE ""platform"" WHEN 'desktop' THEN ""amount"" ELSE 0 END) AS ""desktop_amount"" FROM ""Spending"" GROUP BY ""spend_date"",""user_id"") AS ""o"") AS ""t"" ON ""p"".""platform""=""t"".""platform"" AND ""p"".""spend_date""=""t"".""spend_date"" GROUP BY ""spend_date"",""platform"""
39,"WITH ""table1"" AS (SELECT ""user_id"",""spend_date"",SUM(CASE WHEN ""platform""='mobile' THEN 1 ELSE 0 END) AS ""m_user"",SUM(CASE WHEN ""platform""='desktop' THEN 1 ELSE 0 END) AS ""d_user"",SUM(CASE WHEN ""platform""='mobile' THEN ""amount"" ELSE 0 END) AS ""m_amount"",SUM(CASE WHEN ""platform""='desktop' THEN ""amount"" ELSE 0 END) AS ""d_amount"" FROM ""Spending"" GROUP BY ""user_id"",""spend_date""), ""table2"" AS (SELECT ""user_id"",""spend_date"",CASE WHEN ""m_user"">0 AND ""d_user"">0 THEN 'both' WHEN ""m_user"">0 AND ""d_user""=0 THEN 'mobile' WHEN ""m_user""=0 AND ""d_user"">0 THEN 'desktop' ELSE NULL END AS ""platform"",COALESCE(""m_amount"", 0)+COALESCE(""d_amount"", 0) AS ""amount"" FROM ""table1"" GROUP BY ""user_id"",""spend_date""), ""table3"" AS (SELECT ""spend_date"",""platform"",SUM(""amount"") AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM ""table2"" GROUP BY ""spend_date"",""platform"" ORDER BY ""spend_date""), ""all_platform"" (""platform"") AS (VALUES ROW('mobile'), ROW('desktop'), ROW('both')), ""table4"" AS (SELECT DISTINCT ""a"".""spend_date"",""b"".""platform"" FROM (""table2"" AS ""a"") CROSS JOIN ""all_platform"" AS ""b"" ORDER BY ""spend_date"") SELECT DISTINCT ""t4"".""spend_date"",""t4"".""platform"",COALESCE(""t3"".""total_amount"", 0) AS ""total_amount"",COALESCE(""t3"".""total_users"", 0) AS ""total_users"" FROM ""table4"" AS ""t4"" LEFT JOIN ""table3"" AS ""t3"" USING (""spend_date"",""platform"")"
40,"WITH ""cte"" AS (SELECT ""spend_date"",""user_id"",SUM(CASE WHEN ""platform""='mobile' THEN ""amount"" END) AS ""Mobile"",SUM(CASE WHEN ""platform""='desktop' THEN ""amount"" END) AS ""Desktop"" FROM ""Spending"" GROUP BY ""spend_date"",""user_id""), ""cte2"" AS ((SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""spending"") UNION (SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""spending"") UNION (SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""spending"")) SELECT ""C1"".""spend_date"",""C1"".""platform"",COALESCE(""total_amount"", 0) AS ""total_amount"",COALESCE(""total_users"", 0) AS ""total_users"" FROM ""cte2"" AS ""C1"" LEFT JOIN (SELECT ""spend_date"",(CASE WHEN ""Mobile"" IS NULL THEN 'desktop' WHEN ""Desktop"" IS NULL THEN 'mobile' ELSE 'both' END) AS ""platform"",SUM(COALESCE(""Mobile"", 0)+COALESCE(""Desktop"", 0)) AS ""total_amount"",COUNT(DISTINCT ""user_id"") AS ""total_users"" FROM ""cte"" AS ""C"" GROUP BY ""spend_date"",""platform"") AS ""t1"" ON ""C1"".""spend_date""=""t1"".""spend_date"" AND ""C1"".""platform""=""t1"".""platform"""
41,"WITH ""cte"" AS (SELECT ""spend_date"",""user_id"",CASE WHEN COUNT(DISTINCT ""platform"")=2 THEN 'both' ELSE ""platform"" END AS ""platform"",CASE WHEN COUNT(DISTINCT ""platform"")=2 THEN SUM(""amount"") ELSE ""amount"" END AS ""amount"" FROM ""spending"" GROUP BY ""spend_date"",""user_id""), ""bo"" AS (SELECT DISTINCT (""spend_date""),'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'both' AS ""platform"" FROM ""Spending"") SELECT ""spend_date"",""platform"",COALESCE(SUM(""amount""), 0) AS ""total_amount"",COUNT(DISTINCT ""user_id"") AS ""total_users"" FROM ""bo"" LEFT JOIN ""cte"" USING (""spend_date"",""platform"") GROUP BY ""spend_date"",""platform"""
42,"WITH ""t1"" AS (SELECT ""user_id"",""spend_date"",(CASE WHEN COUNT(DISTINCT ""platform"")>1 THEN 'both' ELSE ""platform"" END) AS ""platform"",SUM(""amount"") AS ""total_amount_user"" FROM ""spending"" GROUP BY 1,2), ""t3"" AS (SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""Spending"" UNION ALL SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""Spending"" UNION ALL SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""Spending"") SELECT ""t3"".""spend_date"",""t3"".""platform"",COALESCE(SUM(""total_amount_user""), 0) AS ""total_amount"",COUNT(DISTINCT ""user_id"") AS ""total_users"" FROM ""t1"" RIGHT JOIN ""t3"" ON ""t1"".""spend_date""=""t3"".""spend_date"" AND ""t1"".""platform""=""t3"".""platform"" GROUP BY 1,2 ORDER BY 2"
43,"WITH RECURSIVE ""CET"" AS (SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""spending"" UNION ALL SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""spending"" UNION ALL SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""spending""), ""CET2"" AS ((SELECT ""user_id"",""spend_date"",""platform"",SUM(""amount"") AS ""amount"" FROM ""Spending"" GROUP BY ""user_id"",""spend_date"" HAVING COUNT(DISTINCT ""platform"")=1) UNION ALL (SELECT ""user_id"",""spend_date"",'both' AS ""platform"",SUM(""amount"") AS ""amount"" FROM ""Spending"" GROUP BY ""user_id"",""spend_date"" HAVING COUNT(DISTINCT ""platform"")=2)) SELECT ""CET"".""spend_date"",""CET"".""platform"",SUM(COALESCE(""total_amount"", 0)) AS ""total_amount"",SUM(COALESCE(""total_users"", 0)) AS ""total_users"" FROM (SELECT ""spend_date"",""platform"",SUM(""amount"") AS ""total_amount"",COUNT(DISTINCT ""user_id"") AS ""total_users"" FROM ""CET2"" GROUP BY ""spend_date"",""platform"") AS ""p1"" RIGHT JOIN ""CET"" ON ""CET"".""spend_date""=""p1"".""spend_date"" AND ""CET"".""platform""=""p1"".""platform"" GROUP BY ""CET"".""spend_date"",""CET"".""platform"" ORDER BY ""spend_date"",""platform"""
44,"WITH ""cte1"" AS (SELECT ""user_id"",""spend_date"",'both' AS ""platform"",""total_price"" FROM (SELECT ""user_id"",""spend_date"",COUNT(""platform"") AS ""cnt"",SUM(""amount"") AS ""total_price"" FROM ""Spending"" GROUP BY ""user_id"",""spend_date"") AS ""a"" WHERE ""cnt"">1), ""cte2"" AS (SELECT ""user_id"",""spend_date"",""platform"",""amount"" AS ""total_price"" FROM ""Spending"" WHERE CONCAT(CAST(""user_id"" AS CHAR(20)), CAST(""spend_date"" AS CHAR(20))) NOT IN (SELECT CONCAT(CAST(""user_id"" AS CHAR(20)), CAST(""spend_date"" AS CHAR(20))) FROM ""cte1"")), ""cte3"" AS (SELECT ""spend_date"",'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT ""spend_date"",'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT ""spend_Date"",'both' AS ""platform"" FROM ""Spending"") SELECT ""c"".""spend_date"",""c"".""platform"",COALESCE(""total_amount"", 0) AS ""total_amount"",COALESCE(""total_users"", 0) AS ""total_users"" FROM ""cte3"" AS ""c"" LEFT JOIN (SELECT ""spend_date"",""platform"",SUM(""total_price"") AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM ((SELECT * FROM ""cte1"" AS ""a"") UNION (SELECT * FROM ""cte2"" AS ""b"")) AS ""t"" GROUP BY ""spend_date"",""platform"" ORDER BY ""spend_date"") AS ""v"" ON ""c"".""spend_date""=""v"".""spend_date"" AND ""c"".""platform""=""v"".""platform"""
45,"WITH ""t"" AS (SELECT ""user_id"",""spend_date"",SUM(CASE WHEN ""platform""='mobile' THEN ""amount"" ELSE 0 END) AS ""mobile"",SUM(CASE WHEN ""platform""='desktop' THEN ""amount"" ELSE 0 END) AS ""desktop"" FROM ""Spending"" GROUP BY ""user_id"",""spend_date""), ""sp"" AS (SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""spending"" UNION ALL SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""spending"" UNION ALL SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""spending""), ""t2"" AS (SELECT ""user_id"",""spend_date"",CASE WHEN ""mobile"">0 THEN CASE WHEN ""desktop"">0 THEN 'both' ELSE 'mobile' END ELSE 'desktop' END AS ""platform"",""mobile""+""desktop"" AS ""amount"" FROM ""t"") SELECT ""sp"".""spend_date"",""sp"".""platform"",COALESCE(SUM(""amount""), 0) AS ""total_amount"",COUNT(DISTINCT ""user_id"") AS ""total_users"" FROM ""sp"" LEFT JOIN ""t2"" ON ""sp"".""spend_date""=""t2"".""spend_date"" AND ""sp"".""platform""=""t2"".""platform"" GROUP BY ""sp"".""spend_date"",""sp"".""platform"""
46,"WITH ""platformsTable"" AS (SELECT DISTINCT ""platform"" AS ""platform"" FROM ""Spending"" UNION SELECT 'both' AS ""platform""), ""datesTable"" AS (SELECT DISTINCT ""spend_date"" FROM ""Spending""), ""formattedTable"" AS (SELECT * FROM (""datesTable"") CROSS JOIN ""platformsTable""), ""summaryTable"" AS (SELECT ""s1"".""user_id"",""s1"".""spend_date"",""s1"".""platform"",COUNT(1) AS ""counts"",SUM(""s1"".""amount"") AS ""amount"" FROM (""Spending"" AS ""s1"") CROSS JOIN ""Spending"" AS ""s2"" WHERE ""s1"".""user_id""=""s2"".""user_id"" AND ""s1"".""spend_date""=""s2"".""spend_date"" GROUP BY 1,2), ""summaryTable2"" AS (SELECT ""spend_date"",CASE WHEN ""counts""=1 THEN ""platform"" ELSE 'both' END AS ""platform2"",CASE WHEN ""counts""=1 THEN ""amount"" ELSE ""amount""/2 END AS ""amount2"" FROM ""summaryTable"") SELECT ""f1"".""spend_date"",""f1"".""platform"",SUM(COALESCE(""amount2"", 0)) AS ""total_amount"",COUNT(""s1"".""spend_date"") AS ""total_users"" FROM ""formattedTable"" AS ""f1"" LEFT JOIN ""summaryTable2"" AS ""s1"" ON ""f1"".""spend_date""=""s1"".""spend_date"" AND ""f1"".""platform""=""s1"".""platform2"" GROUP BY 1,2"
47,"WITH ""CTE1"" AS (SELECT 'desktop' AS ""platform"" UNION SELECT 'mobile' UNION SELECT 'both'), ""CTE2"" AS (SELECT ""spend_date"",""platform"" FROM (SELECT DISTINCT ""spend_date"" FROM ""Spending"") AS ""d1"" CROSS JOIN ""CTE1"" AS ""d2"" ORDER BY 1,2), ""CTE3"" AS (SELECT ""spend_date"",""user_id"",CASE WHEN COUNT(1)=1 THEN ""platform"" ELSE 'both' END AS ""platform"",SUM(""amount"") AS ""total_amount"" FROM ""Spending"" GROUP BY ""spend_date"",""user_id"") SELECT DISTINCT ""d1"".""spend_date"",""d1"".""platform"",SUM(COALESCE(""d2"".""total_amount"", 0)) AS ""total_amount"",COUNT(DISTINCT ""d2"".""user_id"") AS ""total_users"" FROM ""CTE2"" AS ""d1"" LEFT JOIN ""CTE3"" AS ""d2"" ON ""d1"".""spend_date""=""d2"".""spend_date"" AND ""d1"".""platform""=""d2"".""platform"" GROUP BY 1,2"
48,"WITH ""tbAll"" AS (SELECT ""user_id"",""spend_date"",SUM(""amount"") AS ""amount"",CASE WHEN SUM(""platform""='mobile')=0 THEN 1 ELSE 0 END AS ""desktop"",CASE WHEN SUM(""platform""='desktop')=0 THEN 1 ELSE 0 END AS ""mobile"",CASE WHEN SUM(""platform""='mobile')=0 OR SUM(""platform""='desktop')=0 THEN 0 ELSE 1 END AS ""both"" FROM ""spending"" GROUP BY ""user_id"",""spend_date"") SELECT ""spend_date"",'mobile' AS ""platform"",SUM(""amount""*""mobile"") AS ""total_amount"",SUM(""mobile"") AS ""total_users"" FROM ""tbAll"" GROUP BY 1 UNION ALL SELECT ""spend_date"",'desktop' AS ""platform"",SUM(""amount""*""desktop"") AS ""total_amount"",SUM(""desktop"") AS ""total_users"" FROM ""tbAll"" GROUP BY 1 UNION ALL SELECT ""spend_date"",'both' AS ""platform"",SUM(""amount""*""both"") AS ""total_amount"",SUM(""both"") AS ""total_users"" FROM ""tbAll"" GROUP BY 1"
49,"WITH ""t1"" AS (SELECT ""spend_date"",""platform"",SUM(""amount"") AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM ""Spending"" WHERE ROW(""user_id"",""spend_date"") IN (SELECT ""user_id"",""spend_date"" FROM ""Spending"" GROUP BY ""user_id"",""spend_date"" HAVING COUNT(""platform"")=1) GROUP BY ""spend_date"",""platform""), ""t2"" AS (SELECT ""t"".""spend_date"",""t"".""platform"",COALESCE(""t1"".""total_amount"", 0) AS ""total_amount"",COALESCE(""t1"".""total_users"", 0) AS ""total_users"" FROM (SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""Spending"" UNION ALL SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""Spending"") AS ""t"" LEFT JOIN ""t1"" ON ""t"".""spend_date""=""t1"".""spend_date"" AND ""t"".""platform""=""t1"".""platform""), ""t3"" AS (SELECT ""spend_date"",'both' AS ""platform"",SUM(""amount"") AS ""total_amount"",COUNT(DISTINCT ""user_id"") AS ""total_users"" FROM ""Spending"" WHERE ROW(""user_id"",""spend_date"") IN (SELECT ""user_id"",""spend_date"" FROM ""Spending"" GROUP BY ""user_id"",""spend_date"" HAVING COUNT(""platform"")=2) GROUP BY ""spend_date""), ""t4"" AS (SELECT ""t"".""spend_date"",COALESCE(""t3"".""platform"", 'both') AS ""platform"",COALESCE(""t3"".""total_amount"", 0) AS ""total_amount"",COALESCE(""t3"".""total_users"", 0) AS ""total_users"" FROM (SELECT DISTINCT ""spend_date"" FROM ""Spending"") AS ""t"" LEFT JOIN ""t3"" ON ""t"".""spend_date""=""t3"".""spend_date"") SELECT * FROM ""t2"" UNION ALL SELECT * FROM ""t4"""
50,"WITH ""cte"" AS (SELECT ""user_id"",""spend_date"",SUM(""amount"") AS ""amount"",CASE WHEN SUM(""platform""='desktop')=0 THEN 1 ELSE 0 END AS ""mobile"",CASE WHEN SUM(""platform""='mobile')=0 THEN 1 ELSE 0 END AS ""desktop"",CASE WHEN SUM(""platform""='desktop')=0 OR SUM(""platform""='mobile')=0 THEN 0 ELSE 1 END AS ""both"" FROM ""Spending"" GROUP BY 1,2) SELECT ""spend_date"",'mobile' AS ""platform"",SUM(""amount""*""mobile"") AS ""total_amount"",SUM(""mobile"") AS ""total_users"" FROM ""cte"" GROUP BY 1 UNION ALL SELECT ""spend_date"",'desktop' AS ""platform"",SUM(""amount""*""desktop"") AS ""total_amount"",SUM(""desktop"") AS ""total_users"" FROM ""cte"" GROUP BY 1 UNION ALL SELECT ""spend_date"",'both' AS ""platform"",SUM(""amount""*""both"") AS ""total_amount"",SUM(""both"") AS ""total_users"" FROM ""cte"" GROUP BY 1"
51,"SELECT ""p"".""spend_date"",""p"".""platform"",COALESCE(SUM(""amount""), 0) AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM (SELECT DISTINCT (""spend_date""),'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'both' AS ""platform"" FROM ""Spending"") AS ""p"" LEFT JOIN (SELECT ""spend_date"",""user_id"",CASE WHEN ""mobile_amount"">0 THEN CASE WHEN ""desktop_amount"">0 THEN 'both' ELSE 'mobile' END ELSE 'desktop' END AS ""platform"",(""mobile_amount""+""desktop_amount"") AS ""amount"" FROM (SELECT ""spend_date"",""user_id"",SUM(CASE ""platform"" WHEN 'mobile' THEN ""amount"" ELSE 0 END) AS ""mobile_amount"",SUM(CASE ""platform"" WHEN 'desktop' THEN ""amount"" ELSE 0 END) AS ""desktop_amount"" FROM ""Spending"" GROUP BY ""spend_date"",""user_id"") AS ""o"") AS ""t"" ON ""p"".""platform""=""t"".""platform"" AND ""p"".""spend_date""=""t"".""spend_date"" GROUP BY ""spend_date"",""platform"""
52,"SELECT ""a"".""spend_date"",""a"".""platform"",COALESCE(SUM(""amount""), 0) AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM (SELECT DISTINCT (""spend_date""),'mobile' AS ""platform"" FROM ""Spending"" UNION ALL SELECT DISTINCT (""spend_date""),'desktop' AS ""platform"" FROM ""Spending"" UNION ALL SELECT DISTINCT (""spend_date""),'both' AS ""platform"" FROM ""Spending"") AS ""a"" LEFT JOIN (SELECT ""user_id"",""spend_date"",CASE WHEN COUNT(1)=1 THEN ""platform"" ELSE 'both' END AS ""platform"",SUM(""amount"") AS ""amount"" FROM ""Spending"" GROUP BY ""user_id"",""spend_date"") AS ""b"" ON ""a"".""spend_date""=""b"".""spend_date"" AND ""a"".""platform""=""b"".""platform"" GROUP BY ""a"".""spend_date"",""a"".""platform"""
53,"WITH ""cte"" AS (SELECT DISTINCT ""spend_date"" AS ""spend_date"",""f"".""platform"" AS ""platform"" FROM ""Spending"" CROSS JOIN (SELECT DISTINCT ""platform"" FROM ""Spending"") AS ""f"" UNION SELECT DISTINCT ""spend_date"",'both' FROM ""Spending""), ""cte2"" AS (SELECT ""user_id"",""spend_date"",CASE WHEN COUNT(1)=2 THEN 'both' ELSE ""platform"" END AS ""medium_"",SUM(""amount"") AS ""total"" FROM ""Spending"" GROUP BY ""user_id"",""spend_date"") SELECT ""c"".""spend_date"",""c"".""platform"",COALESCE(""total_amount"", 0) AS ""total_amount"",COALESCE(""total_users"", 0) AS ""total_users"" FROM (SELECT ""spend_date"",""medium_"" AS ""platform"",SUM(""total"") AS ""total_amount"",COUNT(DISTINCT ""user_id"") AS ""total_users"" FROM ""cte2"" GROUP BY ""spend_date"",""medium_"") AS ""g"" RIGHT JOIN ""cte"" AS ""c"" ON ""g"".""spend_date""=""c"".""spend_date"" AND ""g"".""platform""=""c"".""platform"""
54,"WITH ""cte"" AS (SELECT ""user_id"",""spend_date"",SUM(""amount"") AS ""amount"",CASE WHEN SUM(""platform""='desktop')=0 THEN 1 ELSE 0 END AS ""mobile"",CASE WHEN SUM(""platform""='mobile')=0 THEN 1 ELSE 0 END AS ""desktop"",CASE WHEN SUM(""platform""='desktop')=0 OR SUM(""platform""='mobile')=0 THEN 0 ELSE 1 END AS ""both"" FROM ""Spending"" GROUP BY 1,2) SELECT ""spend_date"",'mobile' AS ""platform"",SUM(""amount""*""mobile"") AS ""total_amount"",SUM(""mobile"") AS ""total_users"" FROM ""cte"" GROUP BY 1 UNION ALL SELECT ""spend_date"",'desktop' AS ""platform"",SUM(""amount""*""desktop"") AS ""total_amount"",SUM(""desktop"") AS ""total_users"" FROM ""cte"" GROUP BY 1 UNION ALL SELECT ""spend_date"",'both' AS ""platform"",SUM(""amount""*""both"") AS ""total_amount"",SUM(""both"") AS ""total_users"" FROM ""cte"" GROUP BY 1"
55,"WITH ""cte"" AS (SELECT ""user_id"",""spend_date"",SUM(""amount"") AS ""amount"",CASE WHEN SUM(""platform""='desktop')=0 THEN 1 ELSE 0 END AS ""mobile"",CASE WHEN SUM(""platform""='mobile')=0 THEN 1 ELSE 0 END AS ""desktop"",CASE WHEN SUM(""platform""='desktop')=0 OR SUM(""platform""='mobile')=0 THEN 0 ELSE 1 END AS ""both"" FROM ""Spending"" GROUP BY 1,2) SELECT ""spend_date"",'mobile' AS ""platform"",SUM(""amount""*""mobile"") AS ""total_amount"",SUM(""mobile"") AS ""total_users"" FROM ""cte"" GROUP BY 1 UNION ALL SELECT ""spend_date"",'desktop' AS ""platform"",SUM(""amount""*""desktop"") AS ""total_amount"",SUM(""desktop"") AS ""total_users"" FROM ""cte"" GROUP BY 1 UNION ALL SELECT ""spend_date"",'both' AS ""platform"",SUM(""amount""*""both"") AS ""total_amount"",SUM(""both"") AS ""total_users"" FROM ""cte"" GROUP BY 1"
56,"WITH ""cte"" AS (SELECT ""user_id"",""spend_date"",SUM(""amount"") AS ""amount"",CASE WHEN SUM(""platform""='desktop')=0 THEN 1 ELSE 0 END AS ""mobile"",CASE WHEN SUM(""platform""='mobile')=0 THEN 1 ELSE 0 END AS ""desktop"",CASE WHEN SUM(""platform""='desktop')=0 OR SUM(""platform""='mobile')=0 THEN 0 ELSE 1 END AS ""both"" FROM ""Spending"" GROUP BY 1,2) SELECT ""spend_date"",'mobile' AS ""platform"",SUM(""amount""*""mobile"") AS ""total_amount"",SUM(""mobile"") AS ""total_users"" FROM ""cte"" GROUP BY 1 UNION ALL SELECT ""spend_date"",'desktop' AS ""platform"",SUM(""amount""*""desktop"") AS ""total_amount"",SUM(""desktop"") AS ""total_users"" FROM ""cte"" GROUP BY 1 UNION ALL SELECT ""spend_date"",'both' AS ""platform"",SUM(""amount""*""both"") AS ""total_amount"",SUM(""both"") AS ""total_users"" FROM ""cte"" GROUP BY 1"
57,"WITH ""dates"" AS (SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""spending"" UNION ALL SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""spending"" UNION ALL SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""spending""), ""users"" AS (SELECT ""user_id"",""spend_date"",MIN(""platform"") AS ""platform"",SUM(""amount"") AS ""total_amount"" FROM ""spending"" GROUP BY ""user_id"",""spend_date"" HAVING COUNT(DISTINCT ""platform"")=1 UNION ALL SELECT ""user_id"",""spend_date"",'both' AS ""platform"",SUM(""amount"") AS ""total_amount"" FROM ""spending"" GROUP BY ""user_id"",""spend_date"" HAVING COUNT(DISTINCT ""platform"")=2) SELECT ""a"".""spend_date"",""a"".""platform"",COALESCE(SUM(""b"".""total_amount""), 0) AS ""total_amount"",COUNT(DISTINCT ""b"".""user_id"") AS ""total_users"" FROM ""dates"" AS ""a"" LEFT JOIN ""users"" AS ""b"" ON ""a"".""spend_date""=""b"".""spend_date"" AND ""a"".""platform""=""b"".""platform"" GROUP BY ""a"".""spend_date"",""a"".""platform"" ORDER BY ""spend_date"""
58,"WITH ""cte"" AS (SELECT ""spend_date"",""user_id"",MAX(""platform"") AS ""platform"",COUNT(DISTINCT ""platform"") AS ""cnt"",SUM(""amount"") AS ""amount"" FROM ""Spending"" GROUP BY ""spend_date"",""user_id"" ORDER BY 1,2) SELECT ""d"".""spend_date"",""p"".""platform"",COALESCE(SUM(""cte2"".""amount""), 0) AS ""total_amount"",COALESCE(COUNT(DISTINCT ""cte2"".""user_id""), 0) AS ""total_users"" FROM ((SELECT DISTINCT ""spend_date"" FROM ""Spending"") AS ""d"" JOIN (SELECT 'desktop' AS ""platform"" UNION ALL SELECT 'mobile' UNION ALL SELECT 'both') AS ""p"" ON 1=1) LEFT JOIN (SELECT ""spend_date"",""user_id"",""amount"",CASE WHEN ""cnt"">1 THEN 'both' ELSE ""platform"" END AS ""platform"" FROM ""cte"") AS ""cte2"" ON ""d"".""spend_date""=""cte2"".""spend_date"" AND ""cte2"".""platform""=""p"".""platform"" GROUP BY ""d"".""spend_date"",""p"".""platform"" ORDER BY 1"
59,"WITH ""t1"" AS (SELECT ""spend_date"",""user_id"",CASE WHEN COUNT(""platform"")=2 THEN 'both' ELSE ""platform"" END AS ""platform"",SUM(""amount"") AS ""amount"" FROM ""Spending"" GROUP BY 1,2), ""t2"" AS (SELECT DISTINCT (""spend_date""),'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'both' AS ""platform"" FROM ""Spending"") SELECT ""t2"".*,COALESCE(SUM(""amount""), 0) AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM ""t2"" LEFT JOIN ""t1"" ON ""t2"".""spend_date""=""t1"".""spend_date"" AND ""t2"".""platform""=""t1"".""platform"" GROUP BY 1,2"
60,"WITH ""cte"" AS (SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""spending"" UNION SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""spending"" UNION SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""spending"") SELECT ""c"".""spend_date"",""c"".""platform"",SUM(CASE WHEN ""a"".""platform"" IS NULL THEN 0 ELSE ""amount"" END) AS ""total_amount"",SUM(CASE WHEN ""a"".""platform"" IS NULL THEN 0 ELSE 1 END) AS ""total_users"" FROM ""cte"" AS ""c"" LEFT JOIN (SELECT ""user_id"",""spend_date"",SUM(""amount"") AS ""amount"",COUNT(DISTINCT ""platform"") AS ""cnt"",CASE WHEN COUNT(DISTINCT ""platform"")=2 THEN 'both' ELSE ""platform"" END AS ""platform"" FROM ""spending"" GROUP BY 1,2) AS ""a"" ON ""a"".""spend_date""=""c"".""spend_date"" AND ""a"".""platform""=""c"".""platform"" GROUP BY 1,2"
61,"WITH ""CTE"" AS (SELECT ""spend_date"",""user_id"",SUM(CASE ""platform"" WHEN 'mobile' THEN ""amount"" ELSE 0 END) AS ""mobile_amount"",SUM(CASE ""platform"" WHEN 'desktop' THEN ""amount"" ELSE 0 END) AS ""desktop_amount"" FROM ""Spending"" GROUP BY ""spend_date"",""user_id""), ""CTE1"" AS (SELECT ""spend_date"",""user_id"",CASE WHEN ""mobile_amount"">0 THEN CASE WHEN ""desktop_amount"">0 THEN 'both' ELSE 'mobile' END ELSE 'desktop' END AS ""platform"",(""mobile_amount""+""desktop_amount"") AS ""amount"" FROM ""CTE"" ORDER BY ""spend_date""), ""CTE2"" AS (SELECT DISTINCT (""spend_date""),'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'both' AS ""platform"" FROM ""Spending"" ORDER BY ""spend_date"") SELECT ""a"".""spend_date"",""a"".""platform"",COALESCE(SUM(""b"".""amount""), 0) AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM ""CTE2"" AS ""a"" LEFT JOIN ""CTE1"" AS ""b"" ON ""a"".""platform""=""b"".""platform"" AND ""a"".""spend_date""=""b"".""spend_date"" GROUP BY ""spend_date"",""platform"""
62,"SELECT ""p"".""spend_date"",""p"".""platform"",COALESCE(SUM(""amount""), 0) AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM (SELECT DISTINCT (""spend_date"") AS ""spend_date"",'both' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'mobile' AS ""platform"" FROM ""Spending"") AS ""p"" LEFT JOIN (SELECT ""spend_date"",""user_id"",CASE WHEN ""mobile_amount"">0 THEN CASE WHEN ""desktop_amount"">0 THEN 'both' ELSE 'mobile' END ELSE 'desktop' END AS ""platform"",(""desktop_amount""+""mobile_amount"") AS ""amount"" FROM (SELECT ""spend_date"",""user_id"",SUM(CASE WHEN ""platform""='desktop' THEN ""amount"" ELSE 0 END) AS ""desktop_amount"",SUM(CASE WHEN ""platform""='mobile' THEN ""amount"" ELSE 0 END) AS ""mobile_amount"" FROM ""Spending"" GROUP BY 1,2) AS ""o"") AS ""t"" ON ""t"".""spend_date""=""p"".""spend_date"" AND ""t"".""platform""=""p"".""platform"" GROUP BY 1,2"
63,"WITH ""CTE"" AS (SELECT ""user_id"",""spend_date"",SUM(CASE ""platform"" WHEN 'mobile' THEN ""amount"" ELSE 0 END) AS ""ma"",SUM(CASE ""platform"" WHEN 'desktop' THEN ""amount"" ELSE 0 END) AS ""da"" FROM ""Spending"" GROUP BY ""user_id"",""spend_date"") SELECT ""spend_date"",'desktop' AS ""platform"",SUM(CASE WHEN ""da"">0 AND ""ma""=0 THEN ""da"" ELSE 0 END) AS ""total_amount"",SUM(CASE WHEN ""da"">0 AND ""ma""=0 THEN 1 ELSE 0 END) AS ""total_users"" FROM ""CTE"" GROUP BY ""spend_date"" UNION ALL SELECT ""spend_date"",'mobile' AS ""platform"",SUM(CASE WHEN ""ma"">0 AND ""da""=0 THEN ""ma"" ELSE 0 END) AS ""total_amount"",SUM(CASE WHEN ""ma"">0 AND ""da""=0 THEN 1 ELSE 0 END) AS ""total_users"" FROM ""CTE"" GROUP BY ""spend_date"" UNION ALL SELECT ""spend_date"",'both' AS ""platform"",SUM(CASE WHEN ""da"">0 AND ""ma"">0 THEN ""ma""+""da"" ELSE 0 END) AS ""total_amount"",SUM(CASE WHEN ""da"">0 AND ""ma"">0 THEN 1 ELSE 0 END) AS ""total_users"" FROM ""CTE"" GROUP BY ""spend_date"""
64,"WITH ""joined"" AS (SELECT ""t1"".""user_id"",""t1"".""spend_date"",CASE WHEN ""t2"".""platform"" IS NOT NULL THEN 'both' ELSE ""t1"".""platform"" END AS ""plat_form"",""t1"".""amount"" FROM ""Spending"" AS ""t1"" LEFT JOIN ""Spending"" AS ""t2"" ON ""t1"".""user_id""=""t2"".""user_id"" AND ""t1"".""spend_date""=""t2"".""spend_date"" AND ""t1"".""platform""!=""t2"".""platform""), ""date_plat"" AS (SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""Spending"" UNION ALL SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""Spending"" UNION ALL SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""Spending"") SELECT ""t2"".""spend_date"",""t2"".""platform"" AS ""platform"",COALESCE(SUM(""amount""), 0) AS ""total_amount"",COALESCE(COUNT(DISTINCT ""user_id""), 0) AS ""total_users"" FROM ""joined"" AS ""T1"" RIGHT JOIN ""date_plat"" AS ""t2"" ON ""t1"".""spend_date""=""t2"".""spend_date"" AND ""t1"".""plat_form""=""t2"".""platform"" GROUP BY 1,2"
65,"WITH ""cte"" AS (SELECT DISTINCT ""spend_date"",""user_id"",COUNT(""platform"") OVER (PARTITION BY ""user_id"", ""spend_date"") AS ""n_platform"",""platform"",""amount"" FROM ""Spending""), ""cte2"" AS (SELECT ""spend_date"",'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT ""spend_date"",'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT ""spend_date"",'both' AS ""platform"" FROM ""Spending""), ""cte3"" AS (SELECT ""spend_date"",'both' AS ""platform"",SUM(""amount"") AS ""total_amount"",COUNT(DISTINCT ""user_id"") AS ""total_users"" FROM ""cte"" WHERE ""n_platform""=2 GROUP BY ""spend_date"" UNION ALL SELECT ""spend_date"",'mobile' AS ""platform"",SUM(""amount"") AS ""total_amount"",COUNT(DISTINCT ""user_id"") AS ""total_users"" FROM ""cte"" WHERE ""n_platform""=1 AND ""platform""='mobile' GROUP BY ""spend_date"" UNION ALL SELECT ""spend_date"",'desktop' AS ""platform"",SUM(""amount"") AS ""total_amount"",COUNT(DISTINCT ""user_id"") AS ""total_users"" FROM ""cte"" WHERE ""n_platform""=1 AND ""platform""='desktop' GROUP BY ""spend_date"") SELECT ""cte2"".""spend_date"",""cte2"".""platform"",COALESCE(""total_amount"", 0) AS ""total_amount"",COALESCE(""total_users"", 0) AS ""total_users"" FROM ""cte2"" LEFT JOIN ""cte3"" ON ""cte2"".""spend_date""=""cte3"".""spend_date"" AND ""cte2"".""platform""=""cte3"".""platform"""
66,"WITH ""cte"" AS (SELECT * FROM (SELECT 'desktop' AS ""platform"" UNION ALL SELECT 'mobile' AS ""platform"" UNION ALL SELECT 'both' AS ""platform"") AS ""t"" CROSS JOIN (SELECT DISTINCT ""spend_date"" FROM ""Spending"") AS ""t1""), ""cte1"" AS (SELECT ""user_id"",""spend_date"",CASE WHEN ""desktop"">0 AND ""mobile""=0 THEN 'desktop' WHEN ""desktop""=0 AND ""mobile"">0 THEN 'mobile' ELSE 'both' END AS ""platform"",""desktop""+""mobile"" AS ""amount"" FROM (SELECT ""user_id"",""spend_date"",SUM(""desktop"") AS ""desktop"",SUM(""mobile"") AS ""mobile"" FROM (SELECT ""user_id"",""spend_date"",CASE WHEN ""platform""='desktop' THEN ""amount"" ELSE 0 END AS ""desktop"",CASE WHEN ""platform""='mobile' THEN ""amount"" ELSE 0 END AS ""mobile"" FROM ""Spending"") AS ""t2"" GROUP BY ""user_id"",""spend_date"") AS ""t3"") SELECT ""cte"".""spend_date"",""cte"".""platform"",COALESCE(SUM(""cte1"".""amount""), 0) AS ""total_amount"",COALESCE(COUNT(""cte1"".""user_id""), 0) AS ""total_users"" FROM ""cte"" LEFT JOIN ""cte1"" ON ""cte"".""spend_date""=""cte1"".""spend_date"" AND ""cte"".""platform""=""cte1"".""platform"" GROUP BY ""cte"".""spend_date"",""cte"".""platform"""
67,"SELECT ""d"".""spend_date"",""d"".""platform"",(CASE WHEN SUM(""st"".""total_amount"") IS NULL THEN 0 ELSE SUM(""st"".""total_amount"") END) AS ""total_amount"",(CASE WHEN COUNT(""st"".""user_id"") IS NULL THEN 0 ELSE COUNT(""st"".""user_id"") END) AS ""total_users"" FROM (SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""Spending"") AS ""d"" LEFT JOIN (SELECT ""user_id"",""spend_date"",(CASE WHEN COUNT(DISTINCT ""platform"")=1 THEN MIN(""platform"") ELSE 'both' END) AS ""platform"",SUM(""amount"") AS ""total_amount"" FROM ""Spending"" GROUP BY ""user_id"",""spend_date"") AS ""st"" ON ""d"".""spend_date""=""st"".""spend_date"" AND ""d"".""platform""=""st"".""platform"" GROUP BY ""d"".""spend_date"",""d"".""platform"""
68,"WITH RECURSIVE ""platforms"" AS (SELECT 'desktop' AS ""p"" UNION ALL SELECT 'mobile' UNION ALL SELECT 'both'), ""report_template"" AS (SELECT DISTINCT ""s"".""spend_date"",""pl"".""p"" AS ""platform"" FROM (""Spending"" AS ""s"") CROSS JOIN ""platforms"" AS ""pl""), ""adhoc_spending"" AS (SELECT ""spend_date"",""user_id"",""amount"",CASE WHEN DENSE_RANK() OVER (PARTITION BY ""spend_date"", ""user_id"" ORDER BY ""platform"")+DENSE_RANK() OVER (PARTITION BY ""spend_date"", ""user_id"" ORDER BY ""platform"" DESC)-1=2 THEN 'both' ELSE ""platform"" END AS ""platform"" FROM ""Spending"") SELECT ""rt"".""spend_date"",""rt"".""platform"",COALESCE(SUM(""s"".""amount""), 0) AS ""total_amount"",COUNT(DISTINCT ""s"".""user_id"") AS ""total_users"" FROM ""report_template"" AS ""rt"" LEFT JOIN ""adhoc_spending"" AS ""s"" ON ""rt"".""spend_date""=""s"".""spend_date"" AND ""rt"".""platform""=""s"".""platform"" GROUP BY ""rt"".""spend_date"",""rt"".""platform"""
69,"WITH ""cte"" AS (SELECT ""user_id"",""spend_date"",SUM(""amount"") AS ""amount"",CASE WHEN SUM(""platform""='desktop')=0 THEN 1 ELSE 0 END AS ""mobile"",CASE WHEN SUM(""platform""='mobile')=0 THEN 1 ELSE 0 END AS ""desktop"",CASE WHEN SUM(""platform""='desktop')=0 OR SUM(""platform""='mobile')=0 THEN 0 ELSE 1 END AS ""both"" FROM ""Spending"" GROUP BY 1,2) SELECT ""spend_date"",'mobile' AS ""platform"",SUM(""amount""*""mobile"") AS ""total_amount"",SUM(""mobile"") AS ""total_users"" FROM ""cte"" GROUP BY 1 UNION ALL SELECT ""spend_date"",'desktop' AS ""platform"",SUM(""amount""*""desktop"") AS ""total_amount"",SUM(""desktop"") AS ""total_users"" FROM ""cte"" GROUP BY 1 UNION ALL SELECT ""spend_date"",'both' AS ""platform"",SUM(""amount""*""both"") AS ""total_amount"",SUM(""both"") AS ""total_users"" FROM ""cte"" GROUP BY 1"
70,"WITH ""cte"" AS (SELECT ""user_id"",""spend_date"",SUM(""amount"") AS ""amount"",CASE WHEN SUM(""platform""='desktop')=0 THEN 1 ELSE 0 END AS ""mobile"",CASE WHEN SUM(""platform""='mobile')=0 THEN 1 ELSE 0 END AS ""desktop"",CASE WHEN SUM(""platform""='desktop')=0 OR SUM(""platform""='mobile')=0 THEN 0 ELSE 1 END AS ""both"" FROM ""Spending"" GROUP BY 1,2) SELECT ""spend_date"",'mobile' AS ""platform"",SUM(""amount""*""mobile"") AS ""total_amount"",SUM(""mobile"") AS ""total_users"" FROM ""cte"" GROUP BY 1 UNION ALL SELECT ""spend_date"",'desktop' AS ""platform"",SUM(""amount""*""desktop"") AS ""total_amount"",SUM(""desktop"") AS ""total_users"" FROM ""cte"" GROUP BY 1 UNION ALL SELECT ""spend_date"",'both' AS ""platform"",SUM(""amount""*""both"") AS ""total_amount"",SUM(""both"") AS ""total_users"" FROM ""cte"" GROUP BY 1"
71,"SELECT ""p"".""spend_date"",""p"".""platform"",COALESCE(SUM(""amount""), 0) AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM (SELECT DISTINCT (""spend_date""),'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'both' AS ""platform"" FROM ""Spending"") AS ""p"" LEFT JOIN (SELECT ""spend_date"",""user_id"",CASE WHEN ""mobile_amount"">0 THEN CASE WHEN ""desktop_amount"">0 THEN 'both' ELSE 'mobile' END ELSE 'desktop' END AS ""platform"",(""mobile_amount""+""desktop_amount"") AS ""amount"" FROM (SELECT ""spend_date"",""user_id"",SUM(CASE ""platform"" WHEN 'mobile' THEN ""amount"" ELSE 0 END) AS ""mobile_amount"",SUM(CASE ""platform"" WHEN 'desktop' THEN ""amount"" ELSE 0 END) AS ""desktop_amount"" FROM ""Spending"" GROUP BY ""spend_date"",""user_id"") AS ""o"") AS ""t"" ON ""p"".""platform""=""t"".""platform"" AND ""p"".""spend_date""=""t"".""spend_date"" GROUP BY ""spend_date"",""platform"""
72,"WITH ""t1"" AS (SELECT ""user_id"",""spend_date"",SUM(CASE WHEN ""platform""='desktop' THEN ""amount"" ELSE 0 END) AS ""desktop"",SUM(CASE WHEN ""platform""='mobile' THEN ""amount"" ELSE 0 END) AS ""mobile"" FROM ""Spending"" GROUP BY ""user_id"",""spend_date""), ""t2"" AS (SELECT ""spend_date"",""user_id"",CASE WHEN ""mobile"">0 THEN CASE WHEN ""desktop"">0 THEN 'both' ELSE 'mobile' END ELSE 'desktop' END AS ""platform"",SUM(""mobile""+""desktop"") AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM ""t1"" GROUP BY ""spend_date"",""platform""), ""t3"" AS (SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""Spending"") SELECT ""t3"".""spend_date"",""t3"".""platform"",COALESCE(""t2"".""total_amount"", 0) AS ""total_amount"",COALESCE(""total_users"", 0) AS ""total_users"" FROM ""t3"" LEFT JOIN ""t2"" ON ""t3"".""spend_date""=""t2"".""spend_date"" AND ""t3"".""platform""=""t2"".""platform"""
73,"ERROR: mysql parse error: line 1 column 236 near ""as s1 right join spending as s2 on s1.spend_date=s2.spend_date and s1.user_id=s2.user_id)) select t2.spend_date , t2.platform , if(t1.total_amount is null, 0, t1.total_amount) as total_amount , if(t1.total_users is null, 0, t1.total_users) as total_users from ( select spend_date , platform , sum(amount) as total_amount , count(distinct user_id) as total_users from temp group by spend_date, platform order by platform, spend_date) as t1 right join ( select distinct(spend_date), 'desktop' platform from Spending union select distinct(spend_date), 'mobile' platform from Spending union select distinct(spend_date), 'both' platform from Spending) as t2 on t1.spend_date = t2.spend_date and t1.platform = t2.platform "" "
74,"WITH ""t"" AS (SELECT *,COUNT(""platform"") OVER (PARTITION BY ""spend_date"", ""user_id"") AS ""type"" FROM ""spending"") SELECT ""spend_date"",'both' AS ""platform"",SUM(CASE WHEN ""type""=2 THEN ""amount"" ELSE 0 END) AS ""total_amount"",COUNT(DISTINCT (CASE WHEN ""type""=2 THEN ""user_id"" ELSE NULL END)) AS ""total_users"" FROM ""t"" GROUP BY ""spend_date"" UNION SELECT ""spend_date"",'mobile' AS ""platform"",SUM(CASE WHEN ""type""=1 AND ""platform""='mobile' THEN ""amount"" ELSE 0 END) AS ""total_amount"",COUNT(CASE WHEN ""type""=1 AND ""platform""='mobile' THEN ""user_id"" ELSE NULL END) AS ""total_users"" FROM ""t"" GROUP BY ""spend_date"" UNION SELECT ""spend_date"",'desktop' AS ""platform"",SUM(CASE WHEN ""type""=1 AND ""platform""='desktop' THEN ""amount"" ELSE 0 END) AS ""total_amount"",COUNT(CASE WHEN ""type""=1 AND ""platform""='desktop' THEN ""user_id"" ELSE NULL END) AS ""total_users"" FROM ""t"" GROUP BY ""spend_date"""
75,"WITH ""agg"" AS (SELECT ""spend_date"",""user_id"",CASE WHEN COUNT(DISTINCT ""platform"")>1 THEN 'both' ELSE MAX(""platform"") END AS ""platform"",SUM(""amount"") AS ""amt"" FROM ""spending"" GROUP BY 1,2), ""agg2"" AS (SELECT ""spend_date"",""platform"",SUM(""amt"") AS ""total_amount"",COUNT(DISTINCT ""user_id"") AS ""total_users"" FROM ""agg"" GROUP BY 1,2 ORDER BY 1,4), ""rec"" AS (SELECT DISTINCT ""spend_date"",""p"".""platform"" FROM ""spending"" AS ""s"" CROSS JOIN (SELECT 'desktop' AS ""platform"" UNION SELECT 'mobile' UNION SELECT 'both') AS ""p"") SELECT ""r"".""spend_date"",""r"".""platform"",COALESCE(""a"".""total_amount"", 0) AS ""total_amount"",COALESCE(""a"".""total_users"", 0) AS ""total_users"" FROM ""rec"" AS ""r"" LEFT JOIN ""agg2"" AS ""a"" ON ""r"".""spend_date""=""a"".""spend_date"" AND ""r"".""platform""=""a"".""platform"""
76,"WITH ""cte1"" AS (SELECT ""user_id"",""spend_date"",'both' AS ""platform"",""total_price"" FROM (SELECT ""user_id"",""spend_date"",COUNT(""platform"") AS ""cnt"",SUM(""amount"") AS ""total_price"" FROM ""Spending"" GROUP BY ""user_id"",""spend_date"") AS ""a"" WHERE ""cnt"">1), ""cte2"" AS (SELECT ""user_id"",""spend_date"",""platform"",""amount"" AS ""total_price"" FROM ""Spending"" WHERE CONCAT(CAST(""user_id"" AS CHAR(20)), '-', CAST(""spend_date"" AS CHAR(20))) NOT IN (SELECT CONCAT(CAST(""user_id"" AS CHAR(20)), '-', CAST(""spend_date"" AS CHAR(20))) FROM ""cte1"")), ""cte3"" AS (SELECT ""spend_date"",'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT ""spend_date"",'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT ""spend_Date"",'both' AS ""platform"" FROM ""Spending"") SELECT ""c"".""spend_date"",""c"".""platform"",COALESCE(""total_amount"", 0) AS ""total_amount"",COALESCE(""total_users"", 0) AS ""total_users"" FROM ""cte3"" AS ""c"" LEFT JOIN (SELECT ""spend_date"",""platform"",SUM(""total_price"") AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM ((SELECT * FROM ""cte1"" AS ""a"") UNION (SELECT * FROM ""cte2"" AS ""b"")) AS ""t"" GROUP BY ""spend_date"",""platform"") AS ""v"" ON ""c"".""spend_date""=""v"".""spend_date"" AND ""c"".""platform""=""v"".""platform"""
77,"WITH ""user_behavior"" AS (SELECT ""user_id"",""spend_date"",(CASE WHEN COUNT(1)>1 THEN 'Both' ELSE ""platform"" END) AS ""platform"",SUM(""amount"") AS ""amount"" FROM ""Spending"" GROUP BY ""user_id"",""spend_date""), ""spend_date"" AS (SELECT DISTINCT ""spend_date"" FROM ""Spending""), ""platform"" AS ((SELECT 'both' AS ""platform"") UNION (SELECT 'mobile' AS ""platform"") UNION (SELECT 'desktop' AS ""platform"")) SELECT ""a"".""spend_date"",""b"".""platform"",COALESCE(SUM(""c"".""amount""), 0) AS ""total_amount"",COUNT(DISTINCT ""c"".""user_id"") AS ""total_users"" FROM (""spend_date"" AS ""a"" JOIN ""platform"" AS ""b"" ON 1=1) LEFT JOIN ""user_behavior"" AS ""c"" ON ""a"".""spend_date""=""c"".""spend_date"" AND ""b"".""platform""=""c"".""platform"" GROUP BY ""a"".""spend_date"",""b"".""platform"""
78,"WITH ""counting"" AS (SELECT ""user_id"",""spend_date"",COUNT(1) AS ""ct"",""platform"",SUM(""amount"") AS ""amount"" FROM ""Spending"" GROUP BY 1,2), ""structure"" AS (SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""spending"" UNION SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""spending"" UNION SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""spending""), ""sorting"" AS (SELECT ""user_id"",""spend_date"",CASE WHEN ""ct""=2 THEN 'both' ELSE ""platform"" END AS ""platform"",""amount"" FROM ""counting"") SELECT ""s"".""spend_date"",""s"".""platform"",COALESCE(SUM(""amount""), 0) AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM ""structure"" AS ""s"" LEFT JOIN ""sorting"" AS ""st"" ON ""st"".""spend_date""=""s"".""spend_date"" AND ""st"".""platform""=""s"".""platform"" GROUP BY 1,2"
79,"SELECT ""spend_date"",""platform"",COALESCE(SUM(""sa""), 0) AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM (SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""Spending"") AS ""a"" LEFT JOIN (SELECT ""spend_date"",""user_id"",(CASE WHEN COUNT(""platform"")!=2 THEN ""platform"" ELSE 'both' END) AS ""platform"",SUM(""amount"") AS ""sa"" FROM ""Spending"" GROUP BY ""spend_date"",""user_id"") AS ""b"" USING (""spend_date"",""platform"") GROUP BY ""spend_date"",""platform"""
80,"SELECT ""c"".""spend_date"",""c"".""platform"",SUM(COALESCE(""amount"", 0)) AS ""total_amount"",SUM(CASE WHEN ""amount"" IS NULL THEN 0 ELSE 1 END) AS ""total_users"" FROM (SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""spending"" UNION ALL SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""spending"" UNION ALL SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""spending"") AS ""c"" LEFT JOIN (SELECT ""user_id"",""spend_date"",CASE WHEN COUNT(1)=1 THEN ""platform"" ELSE 'both' END AS ""platform"",SUM(""amount"") AS ""amount"" FROM ""spending"" GROUP BY ""user_id"",""spend_date"") AS ""v"" ON ""c"".""spend_date""=""v"".""spend_date"" AND ""c"".""platform""=""v"".""platform"" GROUP BY ""spend_date"",""platform"""
81,"WITH ""header"" AS (SELECT DISTINCT (""spend_date""),'desktop' AS ""platform"" FROM ""Spending"" UNION ALL SELECT DISTINCT (""spend_date""),'mobile' AS ""platform"" FROM ""Spending"" UNION ALL SELECT DISTINCT (""spend_date""),'both' AS ""platform"" FROM ""Spending"") SELECT ""h"".""spend_date"",""h"".""platform"",COALESCE(SUM(""amount""), 0) AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM ""header"" AS ""h"" LEFT JOIN (SELECT ""spend_date"",""user_id"",CASE WHEN COUNT(1)=1 THEN ""platform"" ELSE 'both' END AS ""platform"",SUM(""amount"") AS ""amount"" FROM ""Spending"" AS ""s"" GROUP BY ""spend_date"",""user_id"") AS ""a"" ON ""h"".""spend_date""=""a"".""spend_date"" AND ""h"".""platform""=""a"".""platform"" GROUP BY ""h"".""spend_date"",""h"".""platform"""
82,"SELECT ""p"".""spend_date"",""p"".""platform"",COALESCE(SUM(""amount""), 0) AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM (SELECT DISTINCT (""spend_date""),'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'both' AS ""platform"" FROM ""Spending"") AS ""p"" LEFT JOIN (SELECT ""spend_date"",""user_id"",CASE WHEN ""mobile_amount"">0 THEN CASE WHEN ""desktop_amount"">0 THEN 'both' ELSE 'mobile' END ELSE 'desktop' END AS ""platform"",(""mobile_amount""+""desktop_amount"") AS ""amount"" FROM (SELECT ""spend_date"",""user_id"",SUM(CASE ""platform"" WHEN 'mobile' THEN ""amount"" ELSE 0 END) AS ""mobile_amount"",SUM(CASE ""platform"" WHEN 'desktop' THEN ""amount"" ELSE 0 END) AS ""desktop_amount"" FROM ""Spending"" GROUP BY ""spend_date"",""user_id"") AS ""o"") AS ""t"" ON ""p"".""platform""=""t"".""platform"" AND ""p"".""spend_date""=""t"".""spend_date"" GROUP BY ""spend_date"",""platform"""
83,"SELECT ""p"".""spend_date"",""p"".""platform"",COALESCE(SUM(""amount""), 0) AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM (SELECT DISTINCT (""spend_date""),'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'both' AS ""platform"" FROM ""Spending"") AS ""p"" LEFT JOIN (SELECT ""spend_date"",""user_id"",CASE WHEN ""mobile_amount"">0 THEN CASE WHEN ""desktop_amount"">0 THEN 'both' ELSE 'mobile' END ELSE 'desktop' END AS ""platform"",(""mobile_amount""+""desktop_amount"") AS ""amount"" FROM (SELECT ""spend_date"",""user_id"",SUM(CASE ""platform"" WHEN 'mobile' THEN ""amount"" ELSE 0 END) AS ""mobile_amount"",SUM(CASE ""platform"" WHEN 'desktop' THEN ""amount"" ELSE 0 END) AS ""desktop_amount"" FROM ""Spending"" GROUP BY ""spend_date"",""user_id"") AS ""o"") AS ""t"" ON ""p"".""platform""=""t"".""platform"" AND ""p"".""spend_date""=""t"".""spend_date"" GROUP BY ""spend_date"",""platform"""
84,"SELECT ""c"".""spend_date"",""c"".""platform"",SUM(COALESCE(""amount"", 0)) AS ""total_amount"",SUM(CASE WHEN ""amount"" IS NULL THEN 0 ELSE 1 END) AS ""total_users"" FROM (SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""spending"" UNION ALL SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""spending"" UNION ALL SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""spending"") AS ""c"" LEFT JOIN (SELECT ""user_id"",""spend_date"",CASE WHEN COUNT(1)=1 THEN ""platform"" ELSE 'both' END AS ""platform"",SUM(""amount"") AS ""amount"" FROM ""spending"" GROUP BY ""user_id"",""spend_date"") AS ""v"" ON ""c"".""spend_date""=""v"".""spend_date"" AND ""c"".""platform""=""v"".""platform"" GROUP BY ""spend_date"",""platform"""
85,"WITH ""cnt"" AS (SELECT ""spend_date"",""user_id"",SUM(CASE WHEN ""platform""='mobile' THEN ""amount"" ELSE 0 END) AS ""mobile_amount"",SUM(CASE WHEN ""platform""='desktop' THEN ""amount"" ELSE 0 END) AS ""desktop_amount"" FROM ""Spending"" AS ""s"" GROUP BY ""spend_date"",""user_id""), ""header"" AS (SELECT DISTINCT (""spend_date""),'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'both' AS ""platform"" FROM ""Spending"") SELECT ""h"".""spend_date"",""h"".""platform"",COALESCE(SUM(""amount""), 0) AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM ""header"" AS ""h"" LEFT JOIN (SELECT ""spend_date"",""user_id"",CASE WHEN ""mobile_amount"">0 THEN CASE WHEN ""desktop_amount"">0 THEN 'both' ELSE 'mobile' END ELSE 'desktop' END AS ""platform"",(""mobile_amount""+""desktop_amount"") AS ""amount"" FROM ""cnt"") AS ""a"" ON ""h"".""spend_date""=""a"".""spend_date"" AND ""h"".""platform""=""a"".""platform"" GROUP BY ""h"".""spend_date"",""h"".""platform"""
86,"WITH ""cte"" AS ((SELECT ""user_id"",""spend_date"",""platform"",SUM(""amount"") AS ""amount"" FROM ""Spending"" GROUP BY 1,2 HAVING COUNT(DISTINCT ""platform"")=1) UNION ALL (SELECT ""user_id"",""spend_date"",'both' AS ""platform"",SUM(""amount"") AS ""amount"" FROM ""Spending"" GROUP BY ""user_id"",""spend_date"" HAVING COUNT(DISTINCT ""platform"")=2)), ""cte1"" AS (SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""Spending"" UNION (SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""Spending"") UNION (SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""Spending"")) SELECT ""cte1"".""spend_date"",""cte1"".""platform"",COALESCE(SUM(""cte"".""amount""), 0) AS ""total_amount"",COUNT(DISTINCT ""cte"".""user_id"") AS ""total_users"" FROM ""cte1"" LEFT JOIN ""cte"" ON ""cte1"".""spend_date""=""cte"".""spend_date"" AND ""cte1"".""platform""=""cte"".""platform"" GROUP BY ""cte1"".""spend_date"",""cte1"".""platform"""
87,"SELECT ""h"".""spend_date"",""h"".""platform"",COALESCE(SUM(""amount""), 0) AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM (SELECT DISTINCT (""spend_date""),'desktop' AS ""platform"" FROM ""Spending"" UNION ALL SELECT DISTINCT (""spend_date""),'mobile' AS ""platform"" FROM ""Spending"" UNION ALL SELECT DISTINCT (""spend_date""),'both' AS ""platform"" FROM ""Spending"") AS ""h"" LEFT JOIN (SELECT ""spend_date"",""user_id"",CASE WHEN COUNT(1)=1 THEN ""platform"" ELSE 'both' END AS ""platform"",SUM(""amount"") AS ""amount"" FROM ""Spending"" AS ""s"" GROUP BY ""spend_date"",""user_id"") AS ""a"" ON ""h"".""spend_date""=""a"".""spend_date"" AND ""h"".""platform""=""a"".""platform"" GROUP BY ""h"".""spend_date"",""h"".""platform"""
88,"WITH ""cnt"" AS (SELECT ""spend_date"",""user_id"",SUM(CASE WHEN ""platform""='mobile' THEN ""amount"" ELSE 0 END) AS ""mobile_amount"",SUM(CASE WHEN ""platform""='desktop' THEN ""amount"" ELSE 0 END) AS ""desktop_amount"" FROM ""Spending"" AS ""s"" GROUP BY ""spend_date"",""user_id""), ""header"" AS (SELECT DISTINCT (""spend_date""),'desktop' AS ""platform"" FROM ""Spending"" UNION ALL SELECT DISTINCT (""spend_date""),'mobile' AS ""platform"" FROM ""Spending"" UNION ALL SELECT DISTINCT (""spend_date""),'both' AS ""platform"" FROM ""Spending"") SELECT ""h"".""spend_date"",""h"".""platform"",COALESCE(SUM(""amount""), 0) AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM ""header"" AS ""h"" LEFT JOIN (SELECT ""spend_date"",""user_id"",CASE WHEN ""mobile_amount"">0 THEN CASE WHEN ""desktop_amount"">0 THEN 'both' ELSE 'mobile' END ELSE 'desktop' END AS ""platform"",(""mobile_amount""+""desktop_amount"") AS ""amount"" FROM ""cnt"") AS ""a"" ON ""h"".""spend_date""=""a"".""spend_date"" AND ""h"".""platform""=""a"".""platform"" GROUP BY ""h"".""spend_date"",""h"".""platform"""
89,"WITH ""counting"" AS (SELECT ""user_id"",""spend_date"",COUNT(1) AS ""ct"",""platform"",SUM(""amount"") AS ""amount"" FROM ""Spending"" GROUP BY 1,2), ""structure"" AS (SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""spending"" UNION SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""spending"" UNION SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""spending""), ""sorting"" AS (SELECT ""user_id"",""spend_date"",CASE WHEN ""ct""=2 THEN 'both' ELSE ""platform"" END AS ""platform"",""amount"" FROM ""counting"") SELECT ""s"".""spend_date"",""s"".""platform"",COALESCE(SUM(""amount""), 0) AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM ""structure"" AS ""s"" LEFT JOIN ""sorting"" AS ""st"" ON ""st"".""spend_date""=""s"".""spend_date"" AND ""st"".""platform""=""s"".""platform"" GROUP BY 1,2"
90,"SELECT ""p"".""spend_date"",""p"".""platform"",COALESCE(SUM(""amount""), 0) AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM (SELECT DISTINCT (""spend_date""),'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'both' AS ""platform"" FROM ""Spending"") AS ""p"" LEFT JOIN (SELECT ""spend_date"",""user_id"",CASE WHEN ""mobile_amount"">0 THEN CASE WHEN ""desktop_amount"">0 THEN 'both' ELSE 'mobile' END ELSE 'desktop' END AS ""platform"",(""mobile_amount""+""desktop_amount"") AS ""amount"" FROM (SELECT ""spend_date"",""user_id"",SUM(CASE ""platform"" WHEN 'mobile' THEN ""amount"" ELSE 0 END) AS ""mobile_amount"",SUM(CASE ""platform"" WHEN 'desktop' THEN ""amount"" ELSE 0 END) AS ""desktop_amount"" FROM ""Spending"" GROUP BY ""spend_date"",""user_id"") AS ""o"") AS ""t"" ON ""p"".""platform""=""t"".""platform"" AND ""p"".""spend_date""=""t"".""spend_date"" GROUP BY ""spend_date"",""platform"""
91,"WITH ""ct"" AS (SELECT ""user_id"",""spend_date"",COUNT(1) AS ""ct"",""platform"",SUM(""amount"") AS ""amount"" FROM ""Spending"" GROUP BY 1,2), ""structure"" AS (SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""spending"" UNION SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""spending"" UNION SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""spending""), ""sorting"" AS (SELECT ""user_id"",""spend_date"",CASE WHEN ""ct""=2 THEN 'both' ELSE ""platform"" END AS ""platform"",""amount"" FROM ""ct"") SELECT ""s"".""spend_date"",""s"".""platform"",COALESCE(SUM(""amount""), 0) AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM ""structure"" AS ""s"" LEFT JOIN ""sorting"" AS ""st"" ON ""st"".""spend_date""=""s"".""spend_date"" AND ""st"".""platform""=""s"".""platform"" GROUP BY 1,2"
92,"WITH ""BothPlatforms"" AS (SELECT ""spend_date"",'both' AS ""platform"",COUNT(""platform"") AS ""plt_cnt"",SUM(""amount"") AS ""amount"",""user_id"" FROM ""Spending"" GROUP BY ""spend_date"",""user_id"" HAVING ""plt_cnt""=2) SELECT ""spend_date"",""platform"",COALESCE(SUM(""amount""), 0) AS ""total_amount"",COALESCE(COUNT(DISTINCT ""user_id""), 0) AS ""total_users"" FROM (SELECT ""spend_date"",""platform"",""amount"",""user_id"" FROM ""BothPlatforms"" UNION SELECT ""spend_date"",""platform"",""amount"",""user_id"" FROM ""Spending"" WHERE ROW(""user_id"",""spend_date"") NOT IN (SELECT ""user_id"",""spend_date"" FROM ""BothPlatforms"") UNION ALL SELECT ""spend_date"",'mobile' AS ""platform"",0 AS ""amount"",NULL AS ""user_id"" FROM ""Spending"" UNION ALL SELECT ""spend_date"",'desktop' AS ""platform"",0 AS ""amount"",NULL AS ""user_id"" FROM ""Spending"" UNION ALL SELECT ""spend_date"",'both' AS ""platform"",0 AS ""amount"",NULL AS ""user_id"" FROM ""Spending"") AS ""tbl"" GROUP BY ""spend_date"",""platform"" ORDER BY ""spend_date"""
93,"SELECT ""p"".""spend_date"",""p"".""platform"",COALESCE(SUM(""amount""), 0) AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM (SELECT DISTINCT (""spend_date""),'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'both' AS ""platform"" FROM ""Spending"") AS ""p"" LEFT JOIN (SELECT ""spend_date"",""user_id"",CASE WHEN ""mobile_amount"">0 THEN CASE WHEN ""desktop_amount"">0 THEN 'both' ELSE 'mobile' END ELSE 'desktop' END AS ""platform"",(""mobile_amount""+""desktop_amount"") AS ""amount"" FROM (SELECT ""spend_date"",""user_id"",SUM(CASE ""platform"" WHEN 'mobile' THEN ""amount"" ELSE 0 END) AS ""mobile_amount"",SUM(CASE ""platform"" WHEN 'desktop' THEN ""amount"" ELSE 0 END) AS ""desktop_amount"" FROM ""Spending"" GROUP BY ""spend_date"",""user_id"") AS ""o"") AS ""t"" ON ""p"".""platform""=""t"".""platform"" AND ""p"".""spend_date""=""t"".""spend_date"" GROUP BY ""spend_date"",""platform"""
94,"WITH ""cte"" AS (SELECT ""user_id"",""spend_date"",SUM(""amount"") AS ""amount"",CASE WHEN SUM(""platform""='desktop')=0 THEN 1 ELSE 0 END AS ""mobile"",CASE WHEN SUM(""platform""='mobile')=0 THEN 1 ELSE 0 END AS ""desktop"",CASE WHEN SUM(""platform""='desktop')=0 OR SUM(""platform""='mobile')=0 THEN 0 ELSE 1 END AS ""both"" FROM ""Spending"" GROUP BY 1,2) SELECT ""spend_date"",'mobile' AS ""platform"",SUM(""amount""*""mobile"") AS ""total_amount"",SUM(""mobile"") AS ""total_users"" FROM ""cte"" GROUP BY 1 UNION ALL SELECT ""spend_date"",'desktop' AS ""platform"",SUM(""amount""*""desktop"") AS ""total_amount"",SUM(""desktop"") AS ""total_users"" FROM ""cte"" GROUP BY 1 UNION ALL SELECT ""spend_date"",'both' AS ""platform"",SUM(""amount""*""both"") AS ""total_amount"",SUM(""both"") AS ""total_users"" FROM ""cte"" GROUP BY 1"
95,"SELECT ""d"".""spend_date"",""d"".""platform"",COALESCE(SUM(""m"".""amount""), 0) AS ""total_amount"",COALESCE(COUNT(DISTINCT ""m"".""user_id""), 0) AS ""total_users"" FROM (SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""spending"" UNION ALL SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""spending"" UNION ALL SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""spending"") AS ""d"" LEFT JOIN (SELECT ""spend_date"",COALESCE(SUM(""amount""), 0) AS ""amount"",""user_id"",CASE WHEN COUNT(DISTINCT ""platform"")=1 THEN ""platform"" ELSE 'both' END AS ""platform"" FROM ""Spending"" GROUP BY ""spend_date"",""user_id"") AS ""m"" ON ""d"".""spend_date""=""m"".""spend_date"" AND ""d"".""platform""=""m"".""platform"" GROUP BY ""d"".""spend_date"",""d"".""platform"""
96,"SELECT ""sub"".""spend_date"",'desktop' AS ""platform"",SUM(CASE WHEN ""sub"".""pboth""=0 AND ""sub"".""platform""='desktop' THEN ""sub"".""amounts"" ELSE 0 END) AS ""total_amount"",SUM(CASE WHEN ""sub"".""platform""='desktop' AND ""sub"".""pboth""=0 THEN 1 ELSE 0 END) AS ""total_users"" FROM (SELECT ""S1"".""user_id"",""S1"".""spend_date"",""S1"".""platform"",""S2"".""platform"" AS ""plat"",CASE WHEN ""S2"".""platform"" IS NULL THEN 0 ELSE 1 END AS ""pboth"",CASE WHEN ""S2"".""platform"" IS NOT NULL THEN ""S1"".""amount""+""S2"".""amount"" ELSE ""S1"".""amount"" END AS ""amounts"" FROM ""Spending"" AS ""S1"" LEFT JOIN ""Spending"" AS ""S2"" ON ""S1"".""user_id""=""S2"".""user_id"" AND ""S1"".""spend_date""=""S2"".""spend_date"" AND ""S1"".""platform""!=""S2"".""platform"" WHERE (""S2"".""platform"" IS NULL) OR (""S1"".""platform""='mobile' AND ""S2"".""platform""='desktop')) AS ""sub"" GROUP BY ""spend_date"" UNION ALL SELECT ""sub"".""spend_date"",'mobile' AS ""platform"",SUM(CASE WHEN ""sub"".""pboth""=0 AND ""sub"".""platform""='mobile' THEN ""sub"".""amounts"" ELSE 0 END) AS ""total_amount"",SUM(CASE WHEN ""sub"".""platform""='mobile' AND ""sub"".""pboth""=0 THEN 1 ELSE 0 END) AS ""total_users"" FROM (SELECT ""S1"".""user_id"",""S1"".""spend_date"",""S1"".""platform"",""S2"".""platform"" AS ""plat"",CASE WHEN ""S2"".""platform"" IS NULL THEN 0 ELSE 1 END AS ""pboth"",CASE WHEN ""S2"".""platform"" IS NOT NULL THEN ""S1"".""amount""+""S2"".""amount"" ELSE ""S1"".""amount"" END AS ""amounts"" FROM ""Spending"" AS ""S1"" LEFT JOIN ""Spending"" AS ""S2"" ON ""S1"".""user_id""=""S2"".""user_id"" AND ""S1"".""spend_date""=""S2"".""spend_date"" AND ""S1"".""platform""!=""S2"".""platform"" WHERE (""S2"".""platform"" IS NULL) OR (""S1"".""platform""='mobile' AND ""S2"".""platform""='desktop')) AS ""sub"" GROUP BY ""spend_date"" UNION ALL SELECT ""sub"".""spend_date"",'both' AS ""platform"",SUM(CASE WHEN ""sub"".""pboth"">0 THEN ""sub"".""amounts"" ELSE 0 END) AS ""total_amount"",SUM(""sub"".""pboth"") AS ""total_users"" FROM (SELECT ""S1"".""user_id"",""S1"".""spend_date"",""S1"".""platform"",""S2"".""platform"" AS ""plat"",CASE WHEN ""S2"".""platform"" IS NULL THEN 0 ELSE 1 END AS ""pboth"",CASE WHEN ""S2"".""platform"" IS NOT NULL THEN ""S1"".""amount""+""S2"".""amount"" ELSE ""S1"".""amount"" END AS ""amounts"" FROM ""Spending"" AS ""S1"" LEFT JOIN ""Spending"" AS ""S2"" ON ""S1"".""user_id""=""S2"".""user_id"" AND ""S1"".""spend_date""=""S2"".""spend_date"" AND ""S1"".""platform""!=""S2"".""platform"" WHERE (""S2"".""platform"" IS NULL) OR (""S1"".""platform""='mobile' AND ""S2"".""platform""='desktop')) AS ""sub"" GROUP BY ""spend_date"""
97,"WITH ""cte"" AS (SELECT ""user_id"",""spend_date"",SUM(""amount"") AS ""amount"",CASE WHEN SUM(""platform""='desktop')=0 THEN 1 ELSE 0 END AS ""mobile"",CASE WHEN SUM(""platform""='mobile')=0 THEN 1 ELSE 0 END AS ""desktop"",CASE WHEN SUM(""platform""='desktop')=0 OR SUM(""platform""='mobile')=0 THEN 0 ELSE 1 END AS ""both"" FROM ""Spending"" GROUP BY 1,2) SELECT ""spend_date"",'mobile' AS ""platform"",SUM(""amount""*""mobile"") AS ""total_amount"",SUM(""mobile"") AS ""total_users"" FROM ""cte"" GROUP BY 1 UNION ALL SELECT ""spend_date"",'desktop' AS ""platform"",SUM(""amount""*""desktop"") AS ""total_amount"",SUM(""desktop"") AS ""total_users"" FROM ""cte"" GROUP BY 1 UNION ALL SELECT ""spend_date"",'both' AS ""platform"",SUM(""amount""*""both"") AS ""total_amount"",SUM(""both"") AS ""total_users"" FROM ""cte"" GROUP BY 1"
98,"WITH ""tab1"" AS (SELECT ""user_id"",""spend_date"",'both' AS ""platform"",SUM(""amount"") AS ""amount"" FROM ""spending"" GROUP BY 1,2 HAVING COUNT(1)>1 UNION SELECT ""user_id"",""spend_date"",""platform"",SUM(""amount"") AS ""amount"" FROM ""spending"" GROUP BY 1,2 HAVING COUNT(1)=1), ""table_date"" AS (SELECT DISTINCT (""spend_date""),'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'both' AS ""platform"" FROM ""Spending""), ""table_usedate"" AS (SELECT ""spend_date"",""platform"",SUM(""amount"") AS ""total_amount"",COUNT(1) AS ""total_users"" FROM ""tab1"" GROUP BY 1,2) SELECT ""t"".""spend_date"",""t"".""platform"",COALESCE(""tu"".""total_amount"", 0) AS ""total_amount"",COALESCE(""tu"".""total_users"", 0) AS ""total_users"" FROM ""table_date"" AS ""t"" LEFT JOIN ""table_usedate"" AS ""tu"" ON ""t"".""spend_date""=""tu"".""spend_date"" AND ""t"".""platform""=""tu"".""platform"" ORDER BY ""spend_date"""
99,"WITH ""cte1"" AS (SELECT ""user_id"",""spend_date"" FROM ""Spending"" GROUP BY ""spend_date"",""user_id"" HAVING COUNT(DISTINCT ""platform"")=2), ""cte2"" AS (SELECT ""user_id"",""spend_date"",'both' AS ""platform"",""amount"" FROM ""Spending"" WHERE ROW(""user_id"",""spend_date"") IN (SELECT * FROM ""cte1"") UNION ALL SELECT * FROM ""Spending"" WHERE ROW(""user_id"",""spend_date"") NOT IN (SELECT * FROM ""cte1"")), ""cte3"" AS (SELECT DISTINCT ""spend_date"" FROM ""Spending""), ""cte4"" AS (SELECT 'desktop' AS ""platform"" UNION ALL SELECT 'mobile' AS ""platform"" UNION ALL SELECT 'both' AS ""platform"") SELECT ""spend_date"",""platform"",COALESCE(SUM(""amount""), 0) AS ""total_amount"",COALESCE(COUNT(DISTINCT ""user_id""), 0) AS ""total_users"" FROM (""cte3"" CROSS JOIN ""cte4"") LEFT JOIN ""cte2"" USING (""spend_date"",""platform"") GROUP BY ""spend_date"",""platform"""
100,"WITH ""res"" AS (SELECT ""user_id"",""spend_date"",CASE WHEN COUNT(""platform"")>1 THEN 'both' ELSE ""platform"" END AS ""platform"",SUM(""amount"") AS ""amount"" FROM ""Spending"" GROUP BY ""user_id"",""spend_date""), ""comb"" AS (SELECT DISTINCT (""spend_date""),'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'both' AS ""platform"" FROM ""Spending"") SELECT ""comb"".""spend_date"",""comb"".""platform"",COALESCE(SUM(""amount""), 0) AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM ""comb"" LEFT JOIN ""res"" ON ""comb"".""spend_date""=""res"".""spend_date"" AND ""comb"".""platform""=""res"".""platform"" GROUP BY 1,2"
101,"WITH ""agg"" AS (SELECT ""spend_date"",""user_id"",CASE WHEN COUNT(DISTINCT ""platform"")>1 THEN 'both' ELSE MAX(""platform"") END AS ""platform"",SUM(""amount"") AS ""amt"" FROM ""spending"" GROUP BY 1,2), ""agg2"" AS (SELECT ""spend_date"",""platform"",SUM(""amt"") AS ""total_amount"",COUNT(DISTINCT ""user_id"") AS ""total_users"" FROM ""agg"" GROUP BY 1,2 ORDER BY 1,4), ""rec"" AS (SELECT DISTINCT ""spend_date"",""p"".""platform"" FROM ""spending"" AS ""s"" CROSS JOIN (SELECT 'desktop' AS ""platform"" UNION SELECT 'mobile' UNION SELECT 'both') AS ""p"") SELECT ""r"".""spend_date"",""r"".""platform"",COALESCE(""a"".""total_amount"", 0) AS ""total_amount"",COALESCE(""a"".""total_users"", 0) AS ""total_users"" FROM ""rec"" AS ""r"" LEFT JOIN ""agg2"" AS ""a"" ON ""r"".""spend_date""=""a"".""spend_date"" AND ""r"".""platform""=""a"".""platform"""
102,"SELECT ""temp"".""spend_date"",""temp"".""platform"",CASE WHEN ""result"".""total_amount"" IS NULL THEN 0 ELSE ""total_amount"" END AS ""total_amount"",CASE WHEN ""result"".""total_users"" IS NULL THEN 0 ELSE ""total_users"" END AS ""total_users"" FROM (SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""spending"" UNION ALL SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""spending"" UNION ALL SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""spending"") AS ""temp"" LEFT JOIN (SELECT ""spend_date"",CASE WHEN ""num""=1 THEN ""platform"" WHEN ""num""=2 THEN 'both' END AS ""platform"",SUM(""amount"") AS ""total_amount"",COUNT(DISTINCT ""user_id"") AS ""total_users"" FROM (SELECT *,COUNT(""platform"") OVER (PARTITION BY ""user_id"", ""spend_date"") AS ""num"" FROM ""spending"") AS ""A"" GROUP BY ""spend_date"",CASE WHEN ""num""=1 THEN ""platform"" WHEN ""num""=2 THEN 'both' END) AS ""result"" ON ""temp"".""spend_date""=""result"".""spend_date"" AND ""temp"".""platform""=""result"".""platform"""
103,"WITH ""cte"" AS (SELECT ""user_id"",""spend_date"",SUM(DISTINCT CASE WHEN ""platform""='desktop' THEN 1 ELSE 2 END) AS ""type"",SUM(""amount"") AS ""amount"" FROM ""Spending"" GROUP BY ""spend_date"",""user_id"") SELECT ""sub1"".""spend_date"",""sub1"".""platform"",COALESCE(""sub2"".""total_amount"", 0) AS ""total_amount"",COALESCE(""sub2"".""total_users"", 0) AS ""total_users"" FROM (SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""spending"" UNION SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""spending"" UNION SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""spending"") AS ""sub1"" LEFT JOIN (SELECT ""spend_date"",CASE WHEN ""type""=1 THEN 'desktop' WHEN ""type""=2 THEN 'mobile' ELSE 'both' END AS ""platform"",SUM(""amount"") AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM ""cte"" GROUP BY ""spend_date"",""type"") AS ""sub2"" ON ""sub1"".""spend_date""=""sub2"".""spend_date"" AND ""sub1"".""platform""=""sub2"".""platform"""
104,"WITH ""cte"" AS (SELECT ""user_id"",""spend_date"",SUM(""amount"") AS ""amount"",CASE WHEN SUM(""platform""='desktop')=0 THEN 1 ELSE 0 END AS ""mobile"",CASE WHEN SUM(""platform""='mobile')=0 THEN 1 ELSE 0 END AS ""desktop"",CASE WHEN SUM(""platform""='desktop')=0 OR SUM(""platform""='mobile')=0 THEN 0 ELSE 1 END AS ""both"" FROM ""Spending"" GROUP BY 1,2) SELECT ""spend_date"",'mobile' AS ""platform"",SUM(""amount""*""mobile"") AS ""total_amount"",SUM(""mobile"") AS ""total_users"" FROM ""cte"" GROUP BY 1 UNION ALL SELECT ""spend_date"",'desktop' AS ""platform"",SUM(""amount""*""desktop"") AS ""total_amount"",SUM(""desktop"") AS ""total_users"" FROM ""cte"" GROUP BY 1 UNION ALL SELECT ""spend_date"",'both' AS ""platform"",SUM(""amount""*""both"") AS ""total_amount"",SUM(""both"") AS ""total_users"" FROM ""cte"" GROUP BY 1"
105,"WITH ""t"" AS (SELECT *,COUNT(""platform"") OVER (PARTITION BY ""spend_date"", ""user_id"") AS ""type"" FROM ""Spending"") SELECT ""spend_date"",'both' AS ""platform"",SUM(CASE WHEN ""type""=2 THEN ""amount"" ELSE 0 END) AS ""total_amount"",COUNT(DISTINCT (CASE WHEN ""type""=2 THEN ""user_id"" ELSE NULL END)) AS ""total_users"" FROM ""t"" GROUP BY ""spend_date"" UNION SELECT ""spend_date"",'mobile' AS ""platform"",SUM(CASE WHEN ""type""=1 AND ""platform""='mobile' THEN ""amount"" ELSE 0 END) AS ""total_amount"",COUNT(DISTINCT (CASE WHEN ""type""=1 AND ""platform""='mobile' THEN ""user_id"" ELSE NULL END)) AS ""total_users"" FROM ""t"" GROUP BY ""spend_date"" UNION SELECT ""spend_date"",'desktop' AS ""platform"",SUM(CASE WHEN ""type""=1 AND ""platform""='desktop' THEN ""amount"" ELSE 0 END) AS ""total_amount"",COUNT(DISTINCT (CASE WHEN ""type""=1 AND ""platform""='desktop' THEN ""user_id"" ELSE NULL END)) AS ""total_users"" FROM ""t"" GROUP BY ""spend_date"""
106,"WITH ""full_tb"" AS (SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""Spending"" UNION ALL SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""Spending"" UNION ALL SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""Spending""), ""full_tb2"" AS (SELECT ""spend_date"",""user_id"",(CASE WHEN COUNT(DISTINCT ""platform"")>1 THEN 'both' ELSE ""platform"" END) AS ""platform"",SUM(""amount"") AS ""total_amount_user"" FROM ""Spending"" GROUP BY ""spend_date"",""user_id"") SELECT ""b"".""spend_date"",""b"".""platform"",COALESCE(SUM(""total_amount_user""), 0) AS ""total_amount"",COUNT(DISTINCT ""user_id"") AS ""total_users"" FROM ""full_tb2"" AS ""a"" RIGHT JOIN ""full_tb"" AS ""b"" ON ""a"".""spend_date""=""b"".""spend_date"" AND ""a"".""platform""=""b"".""platform"" GROUP BY ""spend_date"",""platform"" ORDER BY ""spend_date"""
107,"WITH ""pf"" AS (SELECT 'desktop' AS ""platform"" UNION ALL SELECT 'mobile' UNION ALL SELECT 'both'), ""datedim"" AS (SELECT ""d"".""spend_date"",""pf"".""platform"" FROM (SELECT DISTINCT ""spend_date"" FROM ""spending"") AS ""d"" CROSS JOIN ""pf""), ""prep"" AS (SELECT ""user_id"",""spend_date"",""platform"",""amount"",COUNT(""platform"") OVER (PARTITION BY ""user_id"", ""spend_date"") AS ""num"" FROM ""spending""), ""uniplatform"" AS (SELECT ""spend_date"",""platform"",SUM(""amount"") AS ""total_amount"",COUNT(DISTINCT ""user_id"") AS ""total_users"" FROM ""prep"" WHERE ""num""=1 GROUP BY ""spend_date"",""platform""), ""dualplatform"" AS (SELECT ""spend_date"",'both' AS ""platform"",SUM(""amount"") AS ""total_amount"",COUNT(DISTINCT ""user_id"") AS ""total_users"" FROM ""prep"" WHERE ""num"">1 GROUP BY ""spend_date"") SELECT ""datedim"".""spend_date"",""datedim"".""platform"",COALESCE(""u"".""total_amount"", 0) AS ""total_amount"",COALESCE(""u"".""total_users"", 0) AS ""total_users"" FROM ""datedim"" LEFT JOIN (SELECT ""spend_date"",""platform"",""total_amount"",""total_users"" FROM ""uniplatform"" UNION ALL SELECT ""spend_date"",""platform"",""total_amount"",""total_users"" FROM ""dualplatform"") AS ""u"" ON ""u"".""spend_date""=""datedim"".""spend_date"" AND ""u"".""platform""=""datedim"".""platform"" ORDER BY 2,1"
108,"WITH ""both_plat"" AS (SELECT ""user_id"",""spend_date"",'both' AS ""platform"",SUM(""amount"") AS ""amount"" FROM ""Spending"" GROUP BY 1,2 HAVING COUNT(1)=2), ""single_plat"" AS (SELECT ""s1"".""user_id"",""s1"".""spend_date"",""s1"".""platform"",""s1"".""amount"" FROM ""Spending"" AS ""s1"" WHERE ""s1"".""spend_date"" NOT IN (SELECT ""s2"".""spend_date"" FROM ""both_plat"" AS ""s2"" WHERE ""s2"".""user_id""=""s1"".""user_id"")), ""template"" AS (SELECT ""spend_date"",'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT ""spend_date"",'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT ""spend_Date"",'both' AS ""platform"" FROM ""Spending"") SELECT ""t"".""spend_date"",""t"".""platform"",COALESCE(""ss"".""total_amount"", 0) AS ""total_amount"",COALESCE(""ss"".""total_users"", 0) AS ""total_users"" FROM ""template"" AS ""t"" LEFT JOIN (SELECT ""spend_date"",""platform"",SUM(""amount"") AS ""total_amount"",COUNT(DISTINCT ""user_id"") AS ""total_users"" FROM (SELECT * FROM ""both_plat"" UNION ALL SELECT * FROM ""single_plat"") AS ""sub"" GROUP BY 1,2) AS ""ss"" ON ""t"".""spend_date""=""ss"".""spend_date"" AND ""t"".""platform""=""ss"".""platform"""
109,"WITH ""cte"" AS (SELECT ""user_id"",""spend_date"",CASE WHEN COUNT(1)=1 THEN ""platform"" ELSE 'both' END AS ""platform"",SUM(""amount"") AS ""total_amount"" FROM ""spending"" GROUP BY ""user_id"",""spend_date""), ""date_plat"" AS (SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""spending"" UNION ALL SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""spending"" UNION ALL SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""spending"") SELECT ""d"".""spend_date"",""d"".""platform"",SUM(COALESCE(""total_amount"", 0)) AS ""total_amount"",SUM(CASE WHEN ""total_amount"" IS NULL THEN 0 ELSE 1 END) AS ""total_users"" FROM ""date_plat"" AS ""d"" LEFT JOIN ""cte"" AS ""c"" ON ""d"".""spend_date""=""c"".""spend_date"" AND ""d"".""platform""=""c"".""platform"" GROUP BY 1,2"
110,"WITH ""CET"" AS (SELECT ""user_id"",""spend_date"",CASE WHEN COUNT(DISTINCT ""platform"")=1 THEN ""platform"" ELSE 'both' END AS ""platform"",SUM(""amount"") AS ""amount"",COUNT(1) AS ""users"" FROM ""Spending"" GROUP BY ""user_id"",""spend_date"") SELECT ""T2"".""spend_date"",""T2"".""platform"",COALESCE(SUM(""amount""), 0) AS ""total_amount"",COALESCE(COUNT(""users""), 0) AS ""total_users"" FROM (SELECT DISTINCT (""spend_date""),'desktop' AS ""platform"" FROM ""Spending"" UNION ALL SELECT DISTINCT (""spend_date""),'mobile' AS ""platform"" FROM ""Spending"" UNION ALL SELECT DISTINCT (""spend_date""),'both' AS ""platform"" FROM ""Spending"") AS ""T2"" LEFT JOIN ""CET"" ON ""T2"".""platform""=""CET"".""platform"" AND ""T2"".""spend_date""=""CET"".""spend_date"" GROUP BY ""spend_date"",""T2"".""platform"""
111,"WITH ""x"" AS (SELECT ""user_id"",""spend_date"",SUM(CASE WHEN ""platform""='mobile' THEN ""amount"" ELSE 0 END) AS ""mobile_amount"",SUM(CASE WHEN ""platform""='desktop' THEN ""amount"" ELSE 0 END) AS ""desktop_amount"" FROM ""spending"" GROUP BY ""user_id"",""spend_date"") SELECT * FROM (SELECT ""spend_date"",'mobile' AS ""platform"",SUM(CASE WHEN ""mobile_amount"">0 AND ""desktop_amount""=0 THEN ""mobile_amount"" ELSE 0 END) AS ""total_amount"",SUM(CASE WHEN ""mobile_amount"">0 AND ""desktop_amount""=0 THEN 1 ELSE 0 END) AS ""total_users"" FROM ""x"" GROUP BY ""spend_date"" UNION SELECT ""spend_date"",'desktop' AS ""platform"",SUM(CASE WHEN ""mobile_amount""=0 AND ""desktop_amount"">0 THEN ""desktop_amount"" ELSE 0 END) AS ""total_amount"",SUM(CASE WHEN ""mobile_amount""=0 AND ""desktop_amount"">0 THEN 1 ELSE 0 END) AS ""total_users"" FROM ""x"" GROUP BY ""spend_date"" UNION SELECT ""spend_date"",'both' AS ""platform"",SUM(CASE WHEN ""mobile_amount"">0 AND ""desktop_amount"">0 THEN ""mobile_amount""+""desktop_amount"" ELSE 0 END) AS ""total_amount"",SUM(CASE WHEN ""mobile_amount"">0 AND ""desktop_amount"">0 THEN 1 ELSE 0 END) AS ""total_users"" FROM ""x"" GROUP BY ""spend_date"") AS ""a"""
112,"WITH ""temp_table"" AS (SELECT ""spend_date"" FROM ""Spending"" GROUP BY ""spend_date"") SELECT ""t3"".""spend_date"",""t3"".""platform"",COALESCE(""total_amount"", 0) AS ""total_amount"",COALESCE(""total_users"", 0) AS ""total_users"" FROM (SELECT ""spend_date"",'mobile' AS ""platform"" FROM ""temp_table"" UNION SELECT ""spend_date"",'desktop' AS ""platform"" FROM ""temp_table"" UNION SELECT ""spend_date"",'both' AS ""platform"" FROM ""temp_table"") AS ""t3"" LEFT JOIN (SELECT ""spend_date"",CASE WHEN ""use_mobile""=1 AND ""use_desktop""=1 THEN 'both' WHEN ""use_mobile""=1 THEN 'mobile' ELSE 'desktop' END AS ""platform"",SUM(""amount"") AS ""total_amount"",COUNT(DISTINCT ""USER_id"") AS ""total_users"" FROM (SELECT ""spend_date"",""USER_id"",SUM(CASE WHEN ""platform""='mobile' THEN 1 ELSE 0 END) AS ""use_mobile"",SUM(CASE WHEN ""platform""='desktop' THEN 1 ELSE 0 END) AS ""use_desktop"",SUM(""amount"") AS ""amount"" FROM ""Spending"" GROUP BY ""spend_date"",""USER_id"") AS ""t1"" GROUP BY ""spend_date"",CASE WHEN ""use_mobile""=1 AND ""use_desktop""=1 THEN 'both' WHEN ""use_mobile""=1 THEN 'mobile' ELSE 'desktop' END) AS ""t2"" ON ""t3"".""spend_date""=""t2"".""spend_date"" AND ""t3"".""platform""=""t2"".""platform"" ORDER BY ""total_amount"",""platform"""
113,"WITH ""platform_table"" AS (SELECT ""a"".""user_id"",""a"".""spend_date"",CASE WHEN ""b"".""platform"" IS NOT NULL THEN 'both' ELSE ""a"".""platform"" END AS ""platform"",""a"".""amount"" FROM ""Spending"" AS ""a"" LEFT JOIN ""Spending"" AS ""b"" ON ""a"".""user_id""=""b"".""user_id"" AND ""a"".""spend_date""=""b"".""spend_date"" AND ""a"".""platform""!=""b"".""platform""), ""date_platform"" AS (SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""Spending"") SELECT ""a"".""spend_date"",""a"".""platform"",COALESCE(SUM(""b"".""amount""), 0) AS ""total_amount"",COUNT(DISTINCT ""b"".""user_id"") AS ""total_users"" FROM ""date_platform"" AS ""a"" LEFT JOIN ""platform_table"" AS ""b"" ON ""a"".""spend_date""=""b"".""spend_date"" AND ""a"".""platform""=""b"".""platform"" GROUP BY 1,2"
114,"WITH ""cte"" AS (SELECT ""spend_date"",""user_id"",CASE WHEN ""mobile_amt"">0 THEN CASE WHEN ""desktop_amt"">0 THEN 'both' ELSE 'mobile' END ELSE 'desktop' END AS ""platform"",""mobile_amt""+""desktop_amt"" AS ""amount"" FROM (SELECT ""spend_date"",""user_id"",SUM(CASE ""platform"" WHEN 'mobile' THEN ""amount"" ELSE 0 END) AS ""mobile_amt"",SUM(CASE ""platform"" WHEN 'desktop' THEN ""amount"" ELSE 0 END) AS ""desktop_amt"" FROM ""spending"" GROUP BY 1,2) AS ""tmp""), ""cart_prod"" AS (SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""spending"" UNION SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""spending"" UNION SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""spending"") SELECT ""cart_prod"".""spend_date"",""cart_prod"".""platform"",SUM(COALESCE(""amount"", 0)) AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM ""cart_prod"" LEFT JOIN ""cte"" ON ""cte"".""spend_date""=""cart_prod"".""spend_date"" AND ""cte"".""platform""=""cart_prod"".""platform"" GROUP BY 1,2"
115,"WITH ""dates_platform"" AS (SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""Spending"" UNION ALL SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""Spending"" UNION ALL SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""Spending""), ""spending_count"" AS (SELECT ""user_id"",""spend_date"",CASE WHEN ""cnt""=2 THEN 'both' ELSE ""platform"" END AS ""platform"",SUM(""amount"") AS ""total_amount"" FROM (SELECT ""user_id"",""spend_date"",""platform"",""amount"",COUNT(1) OVER (PARTITION BY ""user_id"", ""spend_date"") AS ""cnt"" FROM ""Spending"") AS ""t"" GROUP BY ""user_id"",""spend_date"",CASE WHEN ""cnt""=2 THEN 'both' ELSE ""platform"" END) SELECT ""t1"".""spend_date"",""t1"".""platform"",SUM(COALESCE(""total_amount"", 0)) AS ""total_amount"",COUNT(DISTINCT ""user_id"") AS ""total_users"" FROM ""dates_platform"" AS ""t1"" LEFT JOIN ""spending_count"" AS ""t2"" ON ""t1"".""spend_date""=""t2"".""spend_date"" AND ""t1"".""platform""=""t2"".""platform"" GROUP BY ""t1"".""spend_date"",""t1"".""platform"""
116,"SELECT ""spend_date"",""platform"",COALESCE(SUM(""sa""), 0) AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM (SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""Spending"") AS ""a"" LEFT JOIN (SELECT ""spend_date"",""user_id"",(CASE WHEN COUNT(""platform"")!=2 THEN ""platform"" ELSE 'both' END) AS ""platform"",SUM(""amount"") AS ""sa"" FROM ""Spending"" GROUP BY ""spend_date"",""user_id"") AS ""b"" USING (""spend_date"",""platform"") GROUP BY ""spend_date"",""platform"""
117,"SELECT ""c"".""spend_date"",""c"".""platform"",SUM(COALESCE(""amount"", 0)) AS ""total_amount"",SUM(CASE WHEN ""amount"" IS NULL THEN 0 ELSE 1 END) AS ""total_users"" FROM (SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""spending"" UNION ALL SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""spending"" UNION ALL SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""spending"") AS ""c"" LEFT JOIN (SELECT ""user_id"",""spend_date"",CASE WHEN COUNT(1)=1 THEN ""platform"" ELSE 'both' END AS ""platform"",SUM(""amount"") AS ""amount"" FROM ""spending"" GROUP BY ""user_id"",""spend_date"") AS ""v"" ON ""c"".""spend_date""=""v"".""spend_date"" AND ""c"".""platform""=""v"".""platform"" GROUP BY ""spend_date"",""platform"""
118,"WITH ""cte"" AS (SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""Spending""), ""tmp"" AS (SELECT ""spend_date"",""user_id"",SUM(CASE WHEN ""platform""='mobile' THEN ""amount"" ELSE 0 END) AS ""mobile_amount"",SUM(CASE WHEN ""platform""='desktop' THEN ""amount"" ELSE 0 END) AS ""desktop_amount"" FROM ""Spending"" GROUP BY 1,2), ""tmp2"" AS (SELECT ""spend_date"",""user_id"",CASE WHEN ""mobile_amount"">0 THEN CASE WHEN ""desktop_amount"">0 THEN 'both' ELSE 'mobile' END ELSE 'desktop' END AS ""platform"",(""mobile_amount""+""desktop_amount"") AS ""amount"" FROM ""tmp"") SELECT ""cte"".""spend_date"",""cte"".""platform"",COALESCE(SUM(""amount""), 0) AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM ""cte"" LEFT JOIN ""tmp2"" ON ""cte"".""spend_date""=""tmp2"".""spend_date"" AND ""cte"".""platform""=""tmp2"".""platform"" GROUP BY 1,2"
119,"WITH ""cte"" AS (SELECT ""user_id"",""spend_date"",SUM(""amount"") AS ""amount"",CASE WHEN SUM(""platform""='desktop')=0 THEN 1 ELSE 0 END AS ""mobile"",CASE WHEN SUM(""platform""='mobile')=0 THEN 1 ELSE 0 END AS ""desktop"",CASE WHEN SUM(""platform""='desktop')=0 OR SUM(""platform""='mobile')=0 THEN 0 ELSE 1 END AS ""both"" FROM ""Spending"" GROUP BY 1,2) SELECT ""spend_date"",'mobile' AS ""platform"",SUM(""amount""*""mobile"") AS ""total_amount"",SUM(""mobile"") AS ""total_users"" FROM ""cte"" GROUP BY 1 UNION ALL SELECT ""spend_date"",'desktop' AS ""platform"",SUM(""amount""*""desktop"") AS ""total_amount"",SUM(""desktop"") AS ""total_users"" FROM ""cte"" GROUP BY 1 UNION ALL SELECT ""spend_date"",'both' AS ""platform"",SUM(""amount""*""both"") AS ""total_amount"",SUM(""both"") AS ""total_users"" FROM ""cte"" GROUP BY 1"
120,"WITH ""c"" AS (SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""Spending""), ""t"" AS (SELECT ""spend_date"",""user_id"",CASE WHEN COUNT(1)>1 THEN 'both' ELSE MAX(""platform"") END AS ""platform"",SUM(""amount"") AS ""amount"" FROM ""Spending"" GROUP BY ""spend_date"",""user_id"") SELECT ""c"".""spend_date"",""c"".""platform"",COALESCE(SUM(""amount""), 0) AS ""total_amount"",COALESCE(COUNT(DISTINCT ""user_id""), 0) AS ""total_users"" FROM ""c"" LEFT JOIN ""t"" ON ""c"".""spend_date""=""t"".""spend_date"" AND ""c"".""platform""=""t"".""platform"" GROUP BY ""c"".""spend_date"",""c"".""platform"""
121,"SELECT ""p"".""spend_date"",""p"".""platform"",COALESCE(SUM(""amount""), 0) AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM (SELECT DISTINCT (""spend_date""),'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'both' AS ""platform"" FROM ""Spending"") AS ""p"" LEFT JOIN (SELECT ""spend_date"",""user_id"",CASE WHEN ""mobile_amount"">0 THEN CASE WHEN ""desktop_amount"">0 THEN 'both' ELSE 'mobile' END ELSE 'desktop' END AS ""platform"",(""mobile_amount""+""desktop_amount"") AS ""amount"" FROM (SELECT ""spend_date"",""user_id"",SUM(CASE ""platform"" WHEN 'mobile' THEN ""amount"" ELSE 0 END) AS ""mobile_amount"",SUM(CASE ""platform"" WHEN 'desktop' THEN ""amount"" ELSE 0 END) AS ""desktop_amount"" FROM ""Spending"" GROUP BY ""spend_date"",""user_id"") AS ""o"") AS ""t"" ON ""p"".""platform""=""t"".""platform"" AND ""p"".""spend_date""=""t"".""spend_date"" GROUP BY ""spend_date"",""platform"""
122,"WITH ""cte"" AS (SELECT ""s1"".""user_id"",""s1"".""spend_date"",""s1"".""amount"",CASE WHEN ""s2"".""platform"" IS NOT NULL THEN 'both' ELSE ""s1"".""platform"" END AS ""platform"" FROM ""spending"" AS ""s1"" LEFT JOIN ""spending"" AS ""s2"" ON ""s1"".""user_id""=""s2"".""user_id"" AND ""s1"".""spend_date""=""s2"".""spend_date"" AND ""s1"".""platform""!=""s2"".""platform""), ""cte2"" AS (SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""spending"" UNION ALL SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""spending"" UNION ALL SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""spending"") SELECT ""cte2"".""spend_date"",""cte2"".""platform"",COALESCE(SUM(""amount""), 0) AS ""total_amount"",COALESCE(COUNT(DISTINCT ""user_id""), 0) AS ""total_users"" FROM ""cte2"" LEFT JOIN ""cte"" ON ""cte2"".""spend_date""=""cte"".""spend_date"" AND ""cte2"".""platform""=""cte"".""platform"" GROUP BY 1,2 ORDER BY ""cte2"".""platform"""
123,"WITH ""t1"" AS (SELECT ""spend_date"",""user_id"",CASE WHEN COUNT(DISTINCT ""platform"")=2 THEN 'both' ELSE ""platform"" END AS ""platform"",SUM(""amount"") AS ""amount"" FROM ""Spending"" GROUP BY ""spend_date"",""user_id""), ""t2"" AS (SELECT DISTINCT (""spend_date""),'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'both' AS ""platform"" FROM ""Spending"") SELECT ""t2"".*,COALESCE(SUM(""amount""), 0) AS ""total_amount"",COUNT(DISTINCT ""user_id"") AS ""total_users"" FROM ""t2"" LEFT JOIN ""t1"" ON ""t2"".""spend_date""=""t1"".""spend_date"" AND ""t2"".""platform""=""t1"".""platform"" GROUP BY 1,2"
124,"WITH ""info_lookup"" AS (SELECT ""spend_date"",'desktop' AS ""platform"" FROM ""spending"" GROUP BY 1,2 UNION ALL SELECT ""spend_date"",'mobile' AS ""platform"" FROM ""spending"" GROUP BY 1,2 UNION ALL SELECT ""spend_date"",'both' AS ""platform"" FROM ""spending"" GROUP BY 1,2), ""sales_summary"" AS (SELECT ""spend_date"",""user_id"",CASE WHEN COUNT(DISTINCT ""platform"")>1 THEN 'both' ELSE MAX(""platform"") END AS ""platform"",SUM(""amount"") AS ""amount"" FROM ""spending"" GROUP BY 1,2) SELECT ""i"".""spend_date"",""i"".""platform"",COALESCE(SUM(""s"".""amount""), 0) AS ""total_amount"",COALESCE(COUNT(""s"".""user_id""), 0) AS ""total_users"" FROM ""info_lookup"" AS ""i"" LEFT JOIN ""sales_summary"" AS ""s"" ON ""i"".""platform""=""s"".""platform"" AND ""i"".""spend_date""=""s"".""spend_date"" GROUP BY 1,2"
125,"WITH ""cte"" AS (SELECT DISTINCT ""spend_Date"",'both' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT ""spend_Date"",'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT ""spend_Date"",'mobile' AS ""platform"" FROM ""Spending"") SELECT ""c"".""spend_date"",""c"".""platform"",SUM(CASE WHEN ""a"".""platform"" IS NULL THEN 0 ELSE ""amount"" END) AS ""total_amount"",SUM(CASE WHEN ""a"".""platform"" IS NULL THEN 0 ELSE 1 END) AS ""total_users"" FROM ""cte"" AS ""c"" LEFT JOIN (SELECT ""user_id"",""spend_Date"",SUM(""amount"") AS ""amount"",COUNT(DISTINCT ""platform"") AS ""cnt"",CASE WHEN COUNT(DISTINCT ""platform"")=2 THEN 'both' ELSE ""platform"" END AS ""platform"" FROM ""Spending"" AS ""s"" GROUP BY ""user_id"",""spend_date"") AS ""a"" ON ""c"".""spend_date""=""a"".""spend_date"" AND ""c"".""platform""=""a"".""platform"" GROUP BY ""c"".""spend_date"",""c"".""platform"""
126,"WITH ""CTE"" AS (SELECT ""user_id"",""spend_date"",SUM(CASE ""platform"" WHEN 'mobile' THEN ""amount"" ELSE 0 END) AS ""ma"",SUM(CASE ""platform"" WHEN 'desktop' THEN ""amount"" ELSE 0 END) AS ""da"" FROM ""Spending"" GROUP BY ""user_id"",""spend_date"") SELECT ""spend_date"",'desktop' AS ""platform"",SUM(CASE WHEN ""da"">0 AND ""ma""=0 THEN ""da"" ELSE 0 END) AS ""total_amount"",SUM(CASE WHEN ""da"">0 AND ""ma""=0 THEN 1 ELSE 0 END) AS ""total_users"" FROM ""CTE"" GROUP BY ""spend_date"" UNION ALL SELECT ""spend_date"",'mobile' AS ""platform"",SUM(CASE WHEN ""ma"">0 AND ""da""=0 THEN ""ma"" ELSE 0 END) AS ""total_amount"",SUM(CASE WHEN ""ma"">0 AND ""da""=0 THEN 1 ELSE 0 END) AS ""total_users"" FROM ""CTE"" GROUP BY ""spend_date"" UNION ALL SELECT ""spend_date"",'both' AS ""platform"",SUM(CASE WHEN ""da"">0 AND ""ma"">0 THEN ""ma""+""da"" ELSE 0 END) AS ""total_amount"",SUM(CASE WHEN ""da"">0 AND ""ma"">0 THEN 1 ELSE 0 END) AS ""total_users"" FROM ""CTE"" GROUP BY ""spend_date"""
127,"WITH ""tbAll"" AS (SELECT ""user_id"",""spend_date"",SUM(""amount"") AS ""amount"",CASE WHEN SUM(""platform""='mobile')=0 THEN 1 ELSE 0 END AS ""desktop"",CASE WHEN SUM(""platform""='desktop')=0 THEN 1 ELSE 0 END AS ""mobile"",CASE WHEN SUM(""platform""='mobile')=0 OR SUM(""platform""='desktop')=0 THEN 0 ELSE 1 END AS ""both"" FROM ""spending"" GROUP BY ""user_id"",""spend_date"") SELECT ""spend_date"",'mobile' AS ""platform"",SUM(""amount""*""mobile"") AS ""total_amount"",SUM(""mobile"") AS ""total_users"" FROM ""tbAll"" GROUP BY 1 UNION ALL SELECT ""spend_date"",'desktop' AS ""platform"",SUM(""amount""*""desktop"") AS ""total_amount"",SUM(""desktop"") AS ""total_users"" FROM ""tbAll"" GROUP BY 1 UNION ALL SELECT ""spend_date"",'both' AS ""platform"",SUM(""amount""*""both"") AS ""total_amount"",SUM(""both"") AS ""total_users"" FROM ""tbAll"" GROUP BY 1"
128,"WITH ""tmp"" AS (SELECT ""user_id"",""spend_date"",SUM(""amount"") AS ""amount"" FROM ""spending"" GROUP BY ""user_id"",""spend_date"" HAVING COUNT(1)>1), ""tmp2"" AS (SELECT ""spend_date"",""platform"",SUM(""amount"") AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM ""spending"" WHERE ROW(""user_id"",""spend_date"") NOT IN (SELECT ""user_id"",""spend_date"" FROM ""tmp"") GROUP BY ""spend_date"",""platform"" UNION SELECT ""spend_date"",'both' AS ""platform"",SUM(""amount"") AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM ""tmp"" GROUP BY ""spend_date""), ""tmp3"" AS (SELECT * FROM (SELECT DISTINCT ""spend_date"" FROM ""spending"") AS ""a"" CROSS, (SELECT DISTINCT ""platform"" FROM ""spending"" UNION SELECT 'both' AS ""platform"") AS ""b"") SELECT ""spend_date"",""platform"",COALESCE(""total_amount"", 0) AS ""total_amount"",COALESCE(""total_users"", 0) AS ""total_users"" FROM ""tmp3"" NATURAL LEFT CROSS JOIN ""tmp2"""
129,"WITH ""cte"" AS (SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""spending"" UNION ALL SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""spending"" UNION ALL SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""spending""), ""cte1"" AS (SELECT ""user_id"",""spend_Date"",CASE WHEN COUNT(DISTINCT ""platform"")=1 THEN MIN(""platform"") ELSE 'both' END AS ""platform"",SUM(""amount"") AS ""amount"" FROM ""spending"" GROUP BY 1,2) SELECT DISTINCT ""c"".""spend_date"",""c"".""platform"",COALESCE(SUM(""amount""), 0) AS ""total_amount"",SUM(CASE WHEN ""amount"" IS NULL THEN 0 ELSE 1 END) AS ""total_users"" FROM ""cte"" AS ""c"" LEFT JOIN ""cte1"" AS ""c1"" ON ""c"".""spend_date""=""c1"".""spend_Date"" AND ""c"".""platform""=""c1"".""platform"" GROUP BY 1,2 ORDER BY 1"
130,"WITH ""cte1"" AS (SELECT ""spend_date"",""user_id"",""amount"",'mobile' AS ""platform"" FROM ""Spending"" AS ""s"" WHERE EXISTS (SELECT ""spend_date"",""user_id"",""platform"" FROM ""Spending"" WHERE ""platform""='mobile' AND ""s"".""user_id""=""user_id"" AND ""s"".""spend_date""=""spend_date"") AND NOT EXISTS (SELECT ""spend_date"",""user_id"",""platform"" FROM ""Spending"" WHERE ""platform""='desktop' AND ""s"".""user_id""=""user_id"" AND ""s"".""spend_date""=""spend_date"")), ""cte2"" AS (SELECT ""spend_date"",""user_id"",""amount"",'desktop' AS ""platform"" FROM ""Spending"" AS ""s"" WHERE NOT EXISTS (SELECT ""spend_date"",""user_id"",""platform"" FROM ""Spending"" WHERE ""platform""='mobile' AND ""s"".""user_id""=""user_id"" AND ""s"".""spend_date""=""spend_date"") AND EXISTS (SELECT ""spend_date"",""user_id"",""platform"" FROM ""Spending"" WHERE ""platform""='desktop' AND ""s"".""user_id""=""user_id"" AND ""s"".""spend_date""=""spend_date"")), ""cte3"" AS (SELECT ""spend_date"",""user_id"",""amount"",'both' AS ""platform"" FROM ""Spending"" AS ""s"" WHERE EXISTS (SELECT ""spend_date"",""user_id"",""platform"" FROM ""Spending"" WHERE ""platform""='mobile' AND ""s"".""user_id""=""user_id"" AND ""s"".""spend_date""=""spend_date"") AND EXISTS (SELECT ""spend_date"",""user_id"",""platform"" FROM ""Spending"" WHERE ""platform""='desktop' AND ""s"".""user_id""=""user_id"" AND ""s"".""spend_date""=""spend_date"")) SELECT ""spend_date"",""platform"",SUM(""amount"") AS ""total_amount"",COUNT(DISTINCT ""user_id"") AS ""total_users"" FROM (SELECT * FROM ""cte1"" UNION ALL SELECT * FROM ""cte2"" UNION ALL SELECT * FROM ""cte3"" UNION ALL SELECT ""spend_date"",NULL,0,'mobile' FROM ""Spending"" UNION ALL SELECT ""spend_date"",NULL,0,'desktop' FROM ""Spending"" UNION ALL SELECT ""spend_date"",NULL,0,'both' FROM ""Spending"") AS ""temp"" GROUP BY 1,2 ORDER BY ""platform"",""spend_date"""
131,"SELECT ""p"".""spend_date"",""p"".""platform"",COALESCE(SUM(""amount""), 0) AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM (SELECT DISTINCT (""spend_date""),'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'both' AS ""platform"" FROM ""Spending"") AS ""p"" LEFT JOIN (SELECT ""spend_date"",""user_id"",CASE WHEN ""mobile_amount"">0 THEN CASE WHEN ""desktop_amount"">0 THEN 'both' ELSE 'mobile' END ELSE 'desktop' END AS ""platform"",(""mobile_amount""+""desktop_amount"") AS ""amount"" FROM (SELECT ""spend_date"",""user_id"",SUM(CASE ""platform"" WHEN 'mobile' THEN ""amount"" ELSE 0 END) AS ""mobile_amount"",SUM(CASE ""platform"" WHEN 'desktop' THEN ""amount"" ELSE 0 END) AS ""desktop_amount"" FROM ""Spending"" GROUP BY ""spend_date"",""user_id"") AS ""o"") AS ""t"" ON ""p"".""platform""=""t"".""platform"" AND ""p"".""spend_date""=""t"".""spend_date"" GROUP BY ""spend_date"",""platform"""
132,"WITH ""tmp"" AS (SELECT ""spend_date"",""platform"" FROM (SELECT DISTINCT ""spend_date"" FROM ""Spending"") AS ""t1"" CROSS JOIN (SELECT DISTINCT ""platform"" FROM ""Spending"" UNION ALL SELECT 'both' AS ""platform"") AS ""t2"") SELECT ""tmp"".""spend_date"",""tmp"".""platform"",SUM(COALESCE(""amount"", 0)) AS ""total_amount"",COALESCE(COUNT(DISTINCT ""user_id""), 0) AS ""total_users"" FROM (SELECT ""spend_date"",""user_id"",CASE WHEN COUNT(""platform"")=1 THEN ""platform"" WHEN COUNT(""platform"")=2 THEN 'both' END AS ""platform"",SUM(""amount"") AS ""amount"" FROM ""Spending"" GROUP BY ""spend_date"",""user_id"") AS ""t"" RIGHT JOIN ""tmp"" ON ""tmp"".""spend_date""=""t"".""spend_date"" AND ""tmp"".""platform""=""t"".""platform"" GROUP BY ""spend_date"",""platform"""
133,"WITH ""date_platform"" AS (SELECT ""s"".""spend_date"",""p"".""platform"" FROM (SELECT DISTINCT ""spend_date"" FROM ""Spending"") AS ""s"" CROSS, (SELECT DISTINCT ""platform"" FROM ""Spending"" UNION SELECT 'both' AS ""platform"") AS ""p""), ""tmp1"" AS (SELECT DISTINCT ""t1"".""user_id"",""t1"".""spend_date"",CASE WHEN ""t1"".""n_platform""=1 THEN ""s"".""platform"" ELSE 'both' END AS ""platform"",""t1"".""total_a"" FROM (SELECT ""user_id"",""spend_date"",COUNT(DISTINCT ""platform"") AS ""n_platform"",SUM(""amount"") AS ""total_a"" FROM ""Spending"" GROUP BY ""user_id"",""spend_date"") AS ""t1"" LEFT JOIN ""Spending"" AS ""s"" ON ""s"".""user_id""=""t1"".""user_id"" AND ""s"".""spend_date""=""t1"".""spend_date""), ""tmp2"" AS (SELECT ""spend_date"",""platform"",COUNT(""user_id"") AS ""total_users"",SUM(""total_a"") AS ""total_amount"" FROM ""tmp1"" GROUP BY ""spend_date"",""platform"") SELECT ""dp"".""spend_date"",""dp"".""platform"",COALESCE(""tmp2"".""total_amount"", 0) AS ""total_amount"",COALESCE(""tmp2"".""total_users"", 0) AS ""total_users"" FROM ""date_platform"" AS ""dp"" LEFT JOIN ""tmp2"" ON ""tmp2"".""spend_date""=""dp"".""spend_date"" AND ""tmp2"".""platform""=""dp"".""platform"""
134,"SELECT ""p"".""spend_date"",""p"".""platform"",COALESCE(""y"".""total_amount"", 0) AS ""total_amount"",COALESCE(""y"".""total_users"", 0) AS ""total_users"" FROM (SELECT DISTINCT (""spend_date""),'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'both' AS ""platform"" FROM ""Spending"") AS ""p"" LEFT JOIN (SELECT ""spend_date"",""platform"",SUM(""amount"") AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM (SELECT ""spend_date"",""user_id"",""platform"",""amount"" FROM ""Spending"" GROUP BY 1,2 HAVING COUNT(1)=1) AS ""t"" GROUP BY 1,2 UNION SELECT ""a"".""spend_date"",'both' AS ""platform"",COALESCE(SUM(""a"".""amount""+""b"".""amount""), 0) AS ""total_users"",COALESCE(COUNT(""b"".""user_id""), 0) AS ""total_users"" FROM ""Spending"" AS ""a"" LEFT JOIN ""Spending"" AS ""b"" ON ""a"".""user_id""=""b"".""user_id"" AND ""a"".""spend_date""=""b"".""spend_date"" AND ""a"".""platform""<""b"".""platform"" GROUP BY 1) AS ""y"" ON ""p"".""platform""=""y"".""platform"" AND ""p"".""spend_date""=""y"".""spend_date"""
135,"WITH ""T3"" AS (SELECT ""spend_date"",""platform"",SUM(""total_amount"") AS ""total_amount"",COUNT(1) AS ""total_users"" FROM (SELECT ""spend_date"",""user_id"",CASE WHEN ""mobile_uses"">0 AND ""desktop_uses"">0 THEN 'both' WHEN ""mobile_uses"">0 THEN 'mobile' WHEN ""desktop_uses"">0 THEN 'desktop' ELSE 'UNK' END AS ""platform"",""total_amount"" FROM (SELECT ""spend_date"",""user_id"",SUM(CASE WHEN ""platform""='mobile' THEN 1 ELSE 0 END) AS ""mobile_uses"",SUM(CASE WHEN ""platform""='desktop' THEN 1 ELSE 0 END) AS ""desktop_uses"",SUM(""amount"") AS ""total_amount"" FROM ""Spending"" GROUP BY ""spend_date"",""user_id"") AS ""T4"") AS ""T5"" GROUP BY ""spend_date"",""platform""), ""T1"" AS (SELECT ""spend_date"" FROM ""T3"" GROUP BY ""spend_date""), ""T2"" AS (SELECT ""spend_date"",'desktop' AS ""platform"" FROM ""T1"" UNION SELECT ""spend_date"",'mobile' AS ""platform"" FROM ""T1"" UNION SELECT ""spend_date"",'both' AS ""platform"" FROM ""T1"") SELECT ""T2"".""spend_date"",""T2"".""platform"",COALESCE(""T3"".""total_amount"", 0) AS ""total_amount"",COALESCE(""T3"".""total_users"", 0) AS ""total_users"" FROM ""T2"" LEFT JOIN ""T3"" ON ""T2"".""spend_date""=""T3"".""spend_date"" AND ""T2"".""platform""=""T3"".""platform"""
136,"WITH ""cte"" AS (SELECT DISTINCT ""spend_Date"",'both' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT ""spend_Date"",'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT ""spend_Date"",'mobile' AS ""platform"" FROM ""Spending"") SELECT ""c"".""spend_date"",""c"".""platform"",SUM(CASE WHEN ""a"".""platform"" IS NULL THEN 0 ELSE ""amount"" END) AS ""total_amount"",SUM(CASE WHEN ""a"".""platform"" IS NULL THEN 0 ELSE 1 END) AS ""total_users"" FROM ""cte"" AS ""c"" LEFT JOIN (SELECT ""user_id"",""spend_Date"",SUM(""amount"") AS ""amount"",COUNT(DISTINCT ""platform"") AS ""cnt"",CASE WHEN COUNT(DISTINCT ""platform"")=2 THEN 'both' ELSE ""platform"" END AS ""platform"" FROM ""Spending"" AS ""s"" GROUP BY ""user_id"",""spend_date"") AS ""a"" ON ""c"".""spend_date""=""a"".""spend_date"" AND ""c"".""platform""=""a"".""platform"" GROUP BY ""c"".""spend_date"",""c"".""platform"""
137,"WITH ""cte"" AS (SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""spending"" UNION ALL SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""spending"" UNION ALL SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""spending"") SELECT ""c"".""spend_date"",""c"".""platform"",SUM(CASE WHEN ""a"".""platform"" IS NULL THEN 0 ELSE ""amount"" END) AS ""total_amount"",SUM(CASE WHEN ""a"".""platform"" IS NULL THEN 0 ELSE 1 END) AS ""total_users"" FROM ""cte"" AS ""c"" LEFT JOIN (SELECT ""user_id"",""spend_date"",SUM(""amount"") AS ""amount"",COUNT(DISTINCT ""platform"") AS ""cnt"",CASE WHEN COUNT(DISTINCT ""platform"")=2 THEN 'both' ELSE ""platform"" END AS ""platform"" FROM ""spending"" GROUP BY 1,2) AS ""a"" ON ""a"".""spend_date""=""c"".""spend_date"" AND ""a"".""platform""=""c"".""platform"" GROUP BY 1,2"
138,"WITH ""cte"" AS (SELECT ""user_id"",""spend_date"",SUM(CASE WHEN ""platform""='mobile' THEN ""amount"" ELSE 0 END) AS ""mobile_amount"",SUM(CASE WHEN ""platform""='desktop' THEN ""amount"" ELSE 0 END) AS ""desktop_amount"" FROM ""Spending"" GROUP BY ""user_id"",""spend_date""), ""dte"" AS (SELECT ""user_id"",""spend_date"",CASE WHEN ((""mobile_amount""!=0) AND (""desktop_amount""!=0)) THEN 'both' WHEN ""mobile_amount"">0 THEN 'mobile' ELSE 'desktop' END AS ""Platform"",(""mobile_amount""+""desktop_amount"") AS ""amount"" FROM ""cte""), ""ete"" AS (SELECT ""spend_date"",""platform"",SUM(""amount"") AS ""total_amount"",COUNT(DISTINCT ""user_id"") AS ""total_users"" FROM ""dte"" GROUP BY 1,2), ""fte"" AS (SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""Spending"") SELECT ""fte"".""spend_date"",""fte"".""platform"",COALESCE(""total_amount"", 0) AS ""total_amount"",COALESCE(""total_users"", 0) AS ""total_users"" FROM ""fte"" LEFT JOIN ""ete"" ON ""fte"".""spend_date""=""ete"".""spend_date"" AND ""fte"".""platform""=""ete"".""platform"""
139,"WITH ""cte"" AS (SELECT ""spending"".""user_id"",""spending"".""spend_Date"",""amount"",""cnt"",""platform"" FROM ""spending"" LEFT JOIN (SELECT ""user_id"",""spend_date"",COUNT(DISTINCT ""platform"") AS ""cnt"" FROM ""spending"" GROUP BY ""user_id"",""spend_Date"") AS ""t"" ON ""spending"".""user_id""=""t"".""user_id"" AND ""spending"".""spend_date""=""t"".""spend_date"") SELECT ""spend_date"",'desktop' AS ""platform"",SUM(CASE WHEN ""platform""='desktop' AND ""cnt""=1 THEN ""amount"" ELSE 0 END) AS ""total_amount"",COUNT(DISTINCT CASE WHEN ""platform""='desktop' AND ""cnt""=1 THEN ""user_id"" ELSE NULL END) AS ""total_users"" FROM ""cte"" GROUP BY ""spend_date"" UNION SELECT ""spend_date"",'mobile' AS ""platform"",SUM(CASE WHEN ""platform""='mobile' AND ""cnt""=1 THEN ""amount"" ELSE 0 END) AS ""total_amount"",COUNT(DISTINCT CASE WHEN ""platform""='mobile' AND ""cnt""=1 THEN ""user_id"" ELSE NULL END) AS ""total_users"" FROM ""cte"" GROUP BY ""spend_date"" UNION SELECT ""spend_date"",'both' AS ""platform"",SUM(CASE WHEN ""cnt""=2 THEN ""amount"" ELSE 0 END) AS ""total_amount"",COUNT(DISTINCT CASE WHEN ""cnt""=2 THEN ""user_id"" ELSE NULL END) AS ""total_users"" FROM ""cte"" GROUP BY ""spend_date"""
140,"WITH ""t1"" AS (SELECT ""user_id"",""spend_date"",(CASE WHEN COUNT(DISTINCT ""platform"")>1 THEN 'both' ELSE ""platform"" END) AS ""platform"",SUM(""amount"") AS ""total_amount"" FROM ""spending"" GROUP BY 1,2), ""t2"" AS (SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""spending"" UNION ALL SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""spending"" UNION ALL SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""spending"") SELECT ""t2"".*,SUM(COALESCE(""total_amount"", 0)) AS ""total_amount"",COUNT(DISTINCT ""user_id"") AS ""total_users"" FROM ""t2"" LEFT JOIN ""t1"" ON ""t2"".""spend_date""=""t1"".""spend_date"" AND ""t1"".""platform""=""t2"".""platform"" GROUP BY 1,2 ORDER BY 1,2"
141,"WITH ""both_platforms"" AS (SELECT ""user_id"",""spend_date"",CASE WHEN COUNT(DISTINCT ""platform"")=2 THEN 'both' ELSE ""platform"" END AS ""platform"",SUM(""amount"") AS ""total_amount"" FROM ""spending"" GROUP BY 1,2), ""base_table"" AS (SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""spending"" UNION SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""spending"" UNION SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""spending"") SELECT ""ba"".""spend_date"",""ba"".""platform"",COALESCE(SUM(""bo"".""total_amount""), 0) AS ""total_amount"",COALESCE(COUNT(DISTINCT ""bo"".""user_id""), 0) AS ""total_users"" FROM ""base_table"" AS ""ba"" LEFT JOIN ""both_platforms"" AS ""bo"" ON ""ba"".""platform""=""bo"".""platform"" AND ""ba"".""spend_date""=""bo"".""spend_date"" GROUP BY 1,2 ORDER BY 1"
142,"SELECT ""t1"".""spend_date"",""t1"".""platform"",SUM(COALESCE(""t2"".""total_amount"", 0)) AS ""total_amount"",SUM(COALESCE(""t2"".""total_users"", 0)) AS ""total_users"" FROM (SELECT DISTINCT (""spend_date""),'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'both' AS ""platform"" FROM ""Spending"" ORDER BY ""spend_date"") AS ""t1"" LEFT JOIN (SELECT ""spend_date"",CASE WHEN COUNT(""platform"")=1 THEN ""platform"" ELSE 'both' END AS ""platform"",SUM(""amount"") AS ""total_amount"",COUNT(DISTINCT ""user_id"") AS ""total_users"" FROM ""spending"" GROUP BY ""spend_date"",""user_id"") AS ""t2"" ON ""t1"".""spend_date""=""t2"".""spend_date"" AND ""t1"".""platform""=""t2"".""platform"" GROUP BY ""spend_date"",""platform"""
143,"WITH ""platformsTable"" AS (SELECT DISTINCT ""platform"" AS ""platform"" FROM ""Spending"" UNION SELECT 'both' AS ""platform""), ""datesTable"" AS (SELECT DISTINCT ""spend_date"" FROM ""Spending""), ""formattedTable"" AS (SELECT * FROM (""datesTable"") CROSS JOIN ""platformsTable""), ""summaryTable"" AS (SELECT ""s1"".""user_id"",""s1"".""spend_date"",""s1"".""platform"",COUNT(1) AS ""counts"",SUM(""s1"".""amount"") AS ""amount"" FROM (""Spending"" AS ""s1"") CROSS JOIN ""Spending"" AS ""s2"" WHERE ""s1"".""user_id""=""s2"".""user_id"" AND ""s1"".""spend_date""=""s2"".""spend_date"" GROUP BY 1,2), ""summaryTable2"" AS (SELECT ""spend_date"",CASE WHEN ""counts""=1 THEN ""platform"" ELSE 'both' END AS ""platform2"",CASE WHEN ""counts""=1 THEN ""amount"" ELSE ""amount""/2 END AS ""amount2"" FROM ""summaryTable"") SELECT ""f1"".""spend_date"",""f1"".""platform"",SUM(COALESCE(""amount2"", 0)) AS ""total_amount"",COUNT(""s1"".""spend_date"") AS ""total_users"" FROM ""formattedTable"" AS ""f1"" LEFT JOIN ""summaryTable2"" AS ""s1"" ON ""f1"".""spend_date""=""s1"".""spend_date"" AND ""f1"".""platform""=""s1"".""platform2"" GROUP BY 1,2"
144,"WITH ""temp_table"" AS (SELECT ""user_id"",""spend_date"",SUM(CASE ""platform"" WHEN 'mobile' THEN ""amount"" ELSE 0 END) AS ""ma"",SUM(CASE ""platform"" WHEN 'desktop' THEN ""amount"" ELSE 0 END) AS ""da"" FROM ""Spending"" GROUP BY ""user_id"",""spend_date"") SELECT ""spend_date"",'desktop' AS ""platform"",SUM(CASE WHEN ""da"">0 AND ""ma""=0 THEN ""da"" ELSE 0 END) AS ""total_amount"",SUM(CASE WHEN ""da"">0 AND ""ma""=0 THEN 1 ELSE 0 END) AS ""total_users"" FROM ""temp_table"" GROUP BY ""spend_date"" UNION ALL SELECT ""spend_date"",'mobile' AS ""platform"",SUM(CASE WHEN ""ma"">0 AND ""da""=0 THEN ""ma"" ELSE 0 END) AS ""total_amount"",SUM(CASE WHEN ""ma"">0 AND ""da""=0 THEN 1 ELSE 0 END) AS ""total_users"" FROM ""temp_table"" GROUP BY ""spend_date"" UNION ALL SELECT ""spend_date"",'both' AS ""platform"",SUM(CASE WHEN ""da"">0 AND ""ma"">0 THEN ""ma""+""da"" ELSE 0 END) AS ""total_amount"",SUM(CASE WHEN ""da"">0 AND ""ma"">0 THEN 1 ELSE 0 END) AS ""total_users"" FROM ""temp_table"" GROUP BY ""spend_date"""
145,"SELECT ""p"".""spend_date"",""p"".""platform"",COALESCE(SUM(""amount""), 0) AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM (SELECT DISTINCT (""spend_date""),'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'both' AS ""platform"" FROM ""Spending"") AS ""p"" LEFT JOIN (SELECT ""spend_date"",""user_id"",CASE WHEN ""mobile_amount"">0 THEN CASE WHEN ""desktop_amount"">0 THEN 'both' ELSE 'mobile' END ELSE 'desktop' END AS ""platform"",(""mobile_amount""+""desktop_amount"") AS ""amount"" FROM (SELECT ""spend_date"",""user_id"",SUM(CASE ""platform"" WHEN 'mobile' THEN ""amount"" ELSE 0 END) AS ""mobile_amount"",SUM(CASE ""platform"" WHEN 'desktop' THEN ""amount"" ELSE 0 END) AS ""desktop_amount"" FROM ""Spending"" GROUP BY ""spend_date"",""user_id"") AS ""o"") AS ""t"" ON ""p"".""platform""=""t"".""platform"" AND ""p"".""spend_date""=""t"".""spend_date"" GROUP BY ""spend_date"",""platform"""
146,"WITH ""dates"" AS (SELECT DISTINCT ""spend_date"" FROM ""spending""), ""platforms"" AS (SELECT 'mobile' AS ""platform"" UNION SELECT 'desktop' AS ""platform"" UNION SELECT 'both' AS ""platform""), ""date_platform"" AS (SELECT ""spend_date"",""platform"" FROM ""dates"" JOIN ""platforms"" ON 1=1), ""user_daily"" AS (SELECT ""spend_date"",""user_id"",SUM(CASE WHEN ""platform""='mobile' THEN ""amount"" ELSE 0 END) AS ""mobile_spend"",SUM(CASE WHEN ""platform""='desktop' THEN ""amount"" ELSE 0 END) AS ""desktop_spend"" FROM ""spending"" GROUP BY 1,2), ""daily_data"" AS (SELECT ""spend_date"",""user_id"",""mobile_spend""+""desktop_spend"" AS ""amount"",CASE WHEN ""mobile_spend"">0 AND ""desktop_spend"">0 THEN 'both' WHEN ""mobile_spend"">0 AND ""desktop_spend""=0 THEN 'mobile' WHEN ""mobile_spend""=0 AND ""desktop_spend"">0 THEN 'desktop' END AS ""platform"" FROM ""user_daily"") SELECT ""dp"".""spend_date"",""dp"".""platform"",SUM(COALESCE(""amount"", 0)) AS ""total_amount"",COUNT(DISTINCT ""user_id"") AS ""total_users"" FROM ""date_platform"" AS ""dp"" LEFT JOIN ""daily_data"" AS ""dd"" ON ""dp"".""spend_date""=""dd"".""spend_date"" AND ""dp"".""platform""=""dd"".""platform"" GROUP BY 1,2 ORDER BY 1"
147,"WITH ""cte"" AS (SELECT ""spend_date"",""user_id"",(CASE WHEN COUNT(""platform"")=2 THEN 'both' WHEN MAX(""platform"")='mobile' THEN 'mobile' ELSE 'desktop' END) AS ""platform"",SUM(""amount"") AS ""total_amount"" FROM ""spending"" GROUP BY ""spend_date"",""user_id"" ORDER BY ""spend_date"") SELECT ""t2"".""spend_date"",""t2"".""platform"",SUM(COALESCE(""total_amount"", 0)) AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM (SELECT DISTINCT ""spend_date"",""t"".""platform"" FROM ""cte"" CROSS JOIN (SELECT 'desktop' AS ""platform"" UNION SELECT 'mobile' UNION SELECT 'both') AS ""t"") AS ""t2"" LEFT JOIN ""cte"" ON ""t2"".""spend_date""=""cte"".""spend_date"" AND ""t2"".""platform""=""cte"".""platform"" GROUP BY ""t2"".""spend_date"",""t2"".""platform"""
148,"SELECT ""spend_date"",""platform"",COALESCE(SUM(""sa""), 0) AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM (SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""Spending"") AS ""a"" LEFT JOIN (SELECT ""spend_date"",""user_id"",(CASE WHEN COUNT(""platform"")!=2 THEN ""platform"" ELSE 'both' END) AS ""platform"",SUM(""amount"") AS ""sa"" FROM ""Spending"" GROUP BY ""spend_date"",""user_id"") AS ""b"" USING (""spend_date"",""platform"") GROUP BY ""spend_date"",""platform"""
149,"WITH ""CET"" AS (SELECT ""user_id"",""spend_date"",""platform"",SUM(""amount"") AS ""amount"",COUNT(1) AS ""users"" FROM ""Spending"" GROUP BY ""user_id"",""spend_date"" HAVING COUNT(DISTINCT ""platform"")=1 UNION ALL (SELECT ""user_id"",""spend_date"",'both' AS ""platform"",SUM(""amount""),COUNT(1) AS ""users"" FROM ""Spending"" GROUP BY ""user_id"",""spend_date"" HAVING COUNT(DISTINCT ""platform"")=2)) SELECT ""T2"".""spend_date"",""T2"".""platform"",COALESCE(SUM(""amount""), 0) AS ""total_amount"",COALESCE(COUNT(""users""), 0) AS ""total_users"" FROM (SELECT DISTINCT (""spend_date""),'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'both' AS ""platform"" FROM ""Spending"") AS ""T2"" LEFT JOIN ""CET"" ON ""T2"".""platform""=""CET"".""platform"" AND ""T2"".""spend_date""=""CET"".""spend_date"" GROUP BY ""spend_date"",""T2"".""platform"""
150,"WITH ""cte"" AS (SELECT ""spend_date"",""user_id"",COUNT(DISTINCT ""platform"") AS ""num_of_platform"" FROM ""Spending"" GROUP BY 1,2), ""cte2"" AS (SELECT ""c"".""spend_date"",""c"".""user_id"",CASE WHEN ""num_of_platform""=1 THEN ""s"".""platform"" ELSE 'both' END AS ""platform"",SUM(""amount"") AS ""total_amount"" FROM ""cte"" AS ""c"" JOIN ""Spending"" AS ""s"" ON ""c"".""user_id""=""s"".""user_id"" AND ""c"".""spend_date""=""s"".""spend_date"" GROUP BY 1,2,3), ""date_platform"" AS (SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""cte"" UNION ALL SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""cte"" UNION ALL SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""cte"") SELECT ""p"".""spend_date"",""p"".""platform"",COALESCE(SUM(""c2"".""total_amount""), 0) AS ""total_amount"",COALESCE(COUNT(DISTINCT ""c2"".""user_id""), 0) AS ""total_users"" FROM ""date_platform"" AS ""p"" LEFT JOIN ""cte2"" AS ""c2"" ON ""p"".""spend_date""=""c2"".""spend_date"" AND ""p"".""platform""=""c2"".""platform"" GROUP BY 1,2 ORDER BY 1,2"
151,"WITH ""cte"" AS (SELECT ""s1"".""user_id"",""s1"".""spend_date"",""s1"".""amount"",CASE WHEN ""s2"".""platform"" IS NULL THEN ""s1"".""platform"" ELSE 'both' END AS ""platform"" FROM ""spending"" AS ""s1"" LEFT JOIN ""spending"" AS ""s2"" ON ""s1"".""user_id""=""s2"".""user_id"" AND ""s1"".""spend_date""=""s2"".""spend_date"" AND ""s1"".""platform""!=""s2"".""platform""), ""cte2"" AS (SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""spending"" UNION SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""spending"" UNION SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""spending"") SELECT ""cte2"".""spend_date"",""cte2"".""platform"",SUM(COALESCE(""amount"", 0)) AS ""total_amount"",COUNT(DISTINCT ""user_id"") AS ""total_users"" FROM ""cte2"" LEFT JOIN ""cte"" ON ""cte2"".""spend_date""=""cte"".""spend_date"" AND ""cte2"".""platform""=""cte"".""platform"" GROUP BY ""cte2"".""spend_date"",""cte2"".""platform"""
152,"WITH ""CET"" AS (SELECT ""user_id"",""spend_date"",CASE WHEN COUNT(DISTINCT ""platform"")=1 THEN ""platform"" ELSE 'both' END AS ""platform"",SUM(""amount"") AS ""amount"",COUNT(1) AS ""users"" FROM ""Spending"" GROUP BY ""user_id"",""spend_date"") SELECT ""T2"".""spend_date"",""T2"".""platform"",COALESCE(SUM(""amount""), 0) AS ""total_amount"",COALESCE(COUNT(""users""), 0) AS ""total_users"" FROM (SELECT DISTINCT (""spend_date""),'desktop' AS ""platform"" FROM ""Spending"" UNION ALL SELECT DISTINCT (""spend_date""),'mobile' AS ""platform"" FROM ""Spending"" UNION ALL SELECT DISTINCT (""spend_date""),'both' AS ""platform"" FROM ""Spending"") AS ""T2"" LEFT JOIN ""CET"" ON ""T2"".""platform""=""CET"".""platform"" AND ""T2"".""spend_date""=""CET"".""spend_date"" GROUP BY ""spend_date"",""T2"".""platform"""
153,"WITH ""mobile"" AS (SELECT * FROM ""Spending"" WHERE ""platform""='mobile'), ""desktop"" AS (SELECT * FROM ""Spending"" WHERE ""platform""='desktop'), ""p"" AS (SELECT DISTINCT (""spend_date""),'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'both' AS ""platform"" FROM ""Spending""), ""totals"" AS (SELECT CASE WHEN ""t"".""m_spend_date"" IS NULL THEN ""t"".""d_spend_date"" ELSE ""t"".""m_spend_date"" END AS ""spend_date"",CASE WHEN ""t"".""d_platform"" IS NOT NULL AND ""t"".""m_platform"" IS NULL THEN ""t"".""d_platform"" WHEN ""t"".""d_platform"" IS NULL AND ""t"".""m_platform"" IS NOT NULL THEN ""t"".""m_platform"" ELSE 'both' END AS ""platform"",SUM(COALESCE(""d_amount"", 0)+COALESCE(""m_amount"", 0)) AS ""total_amount"",SUM(CASE WHEN ""t"".""m_user_id"" IS NOT NULL AND ""t"".""d_user_id"" IS NOT NULL THEN 1 WHEN ""t"".""m_user_id"" IS NOT NULL AND ""t"".""d_user_id"" IS NULL THEN 1 WHEN ""t"".""m_user_id"" IS NULL AND ""t"".""d_user_id"" IS NOT NULL THEN 1 END) AS ""total_users"" FROM (SELECT ""m"".""user_id"" AS ""m_user_id"",""m"".""spend_date"" AS ""m_spend_date"",""m"".""platform"" AS ""m_platform"",""m"".""amount"" AS ""m_amount"",""d"".""user_id"" AS ""d_user_id"",""d"".""spend_date"" AS ""d_spend_date"",""d"".""platform"" AS ""d_platform"",""d"".""amount"" AS ""d_amount"" FROM ""mobile"" AS ""m"" LEFT JOIN ""desktop"" AS ""d"" ON ""m"".""user_id""=""d"".""user_id"" AND ""m"".""spend_date""=""d"".""spend_date"" UNION SELECT ""m"".""user_id"" AS ""m_user_id"",""m"".""spend_date"" AS ""m_spend_date"",""m"".""platform"" AS ""m_platform"",""m"".""amount"" AS ""m_amount"",""d"".""user_id"" AS ""d_user_id"",""d"".""spend_date"" AS ""d_spend_date"",""d"".""platform"" AS ""d_platform"",""d"".""amount"" AS ""d_amount"" FROM ""mobile"" AS ""m"" RIGHT JOIN ""desktop"" AS ""d"" ON ""m"".""user_id""=""d"".""user_id"" AND ""m"".""spend_date""=""d"".""spend_date"") AS ""t"" GROUP BY 1,2 ORDER BY 1) SELECT ""p"".*,COALESCE(""totals"".""total_amount"", 0) AS ""total_amount"",COALESCE(""totals"".""total_users"", 0) AS ""total_users"" FROM ""p"" LEFT JOIN ""totals"" ON ""p"".""spend_date""=""totals"".""spend_date"" AND ""p"".""platform""=""totals"".""platform"""
154,"WITH ""t1"" AS (SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""Spending""), ""t2"" AS (SELECT ""user_id"",""spend_date"",CASE WHEN COUNT(DISTINCT ""platform"")=2 THEN 'both' ELSE ""platform"" END AS ""platform"",SUM(""amount"") AS ""amount"" FROM ""Spending"" GROUP BY ""spend_date"",""user_id"") SELECT ""t1"".*,COALESCE(SUM(""amount""), 0) AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM ""t1"" LEFT JOIN ""t2"" USING (""spend_date"",""platform"") GROUP BY 1,2"
155,"WITH ""temp"" AS (SELECT ""spend_date"",""user_id"",SUM(""amount"") AS ""amount"",CASE WHEN SUM(CASE WHEN ""platform""='mobile' THEN 1 ELSE 0 END)=0 THEN 1 ELSE 0 END AS ""desktop"",CASE WHEN SUM(CASE WHEN ""platform""='desktop' THEN 1 ELSE 0 END)=0 THEN 1 ELSE 0 END AS ""mobile"",CASE WHEN SUM(""platform""='desktop')+SUM(""platform""='mobile')=2 THEN 1 ELSE 0 END AS ""b"" FROM ""Spending"" GROUP BY ""spend_date"",""user_id"") SELECT ""spend_date"",'desktop' AS ""platform"",SUM(""desktop""*""amount"") AS ""total_amount"",SUM(""desktop"") AS ""total_users"" FROM ""temp"" GROUP BY ""spend_date"" UNION ALL SELECT ""spend_date"",'mobile' AS ""platform"",SUM(""mobile""*""amount"") AS ""total_amount"",SUM(""mobile"") AS ""total_users"" FROM ""temp"" GROUP BY ""spend_date"" UNION ALL SELECT ""spend_date"",'both' AS ""platform"",SUM(""b""*""amount"") AS ""total_amount"",SUM(""b"") AS ""total_users"" FROM ""temp"" GROUP BY ""spend_date"""
156,"WITH ""platform"" AS (SELECT DISTINCT (""spend_date"") AS ""spend_date"",'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date"") AS ""spend_date"",'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date"") AS ""spend_date"",'both' AS ""platform"" FROM ""Spending"") SELECT ""P1"".""spend_date"",""P1"".""platform"",COALESCE(SUM(""total_amount""), 0) AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM ""platform"" AS ""P1"" LEFT JOIN (SELECT ""user_id"",""spend_date"",SUM(""amount"") AS ""total_amount"",(CASE WHEN SUM(""platform""='mobile')+SUM(""platform""='desktop')=2 THEN 'BOTH' WHEN SUM(""platform""='mobile')+SUM(""platform""='desktop')=1 THEN ""platform"" END) AS ""platform"" FROM ""Spending"" GROUP BY ""user_id"",""spend_date"") AS ""T1"" ON ""P1"".""spend_date""=""T1"".""spend_date"" AND ""P1"".""platform""=""T1"".""platform"" GROUP BY ""P1"".""spend_date"",""P1"".""platform"""
157,"WITH ""cte"" AS (SELECT ""spend_date"",(CASE WHEN ""plat_cnt""=1 AND ""platform""='mobile' THEN ""amount"" ELSE 0 END) AS ""mobile_amount"",(CASE WHEN ""plat_cnt""=1 AND ""platform""='desktop' THEN ""amount"" ELSE 0 END) AS ""desktop_amount"",(CASE WHEN ""plat_cnt"">1 THEN ""amount"" ELSE 0 END) AS ""both_amount"",(CASE WHEN ""plat_cnt""=1 AND ""platform""='mobile' THEN ""user_id"" ELSE NULL END) AS ""mobile_user"",(CASE WHEN ""plat_cnt""=1 AND ""platform""='desktop' THEN ""user_id"" ELSE NULL END) AS ""desktop_user"",(CASE WHEN ""plat_cnt"">1 THEN ""user_id"" ELSE NULL END) AS ""both_user"" FROM (SELECT ""user_id"",""spend_date"",""platform"",""amount"",COUNT(""platform"") OVER (PARTITION BY ""spend_date"", ""user_id"") AS ""plat_cnt"" FROM ""spending"") AS ""t"") SELECT ""spend_date"",'desktop' AS ""platform"",SUM(""desktop_amount"") AS ""total_amount"",COUNT(DISTINCT ""desktop_user"") AS ""total_users"" FROM ""cte"" GROUP BY ""spend_date"" UNION ALL SELECT ""spend_date"",'mobile' AS ""platform"",SUM(""mobile_amount""),COUNT(DISTINCT ""mobile_user"") FROM ""cte"" GROUP BY ""spend_date"" UNION ALL SELECT ""spend_date"",'both' AS ""platform"",SUM(""both_amount""),COUNT(DISTINCT ""both_user"") FROM ""cte"" GROUP BY ""spend_date"""
158,"WITH ""tmp"" AS (SELECT ""user_id"",""spend_date"",""amount"",SUM(CASE WHEN ""platform""='mobile' THEN 1 ELSE 0 END) OVER (PARTITION BY ""user_id"", ""spend_date"") AS ""mobile"",SUM(CASE WHEN ""platform""='desktop' THEN 1 ELSE 0 END) OVER (PARTITION BY ""user_id"", ""spend_date"") AS ""desktop"" FROM ""spending""), ""tmp2"" AS (SELECT *,CASE WHEN ""mobile""=1 AND ""desktop""=1 THEN 'both' WHEN ""mobile""=1 AND ""desktop""=0 THEN 'mobile' ELSE 'desktop' END AS ""platform"" FROM ""tmp""), ""spine"" AS (SELECT DISTINCT ""tmp2"".""spend_date"",""tmp3"".""platform"" FROM (""tmp2"") CROSS JOIN (SELECT 'desktop' AS ""platform"" UNION SELECT 'mobile' UNION SELECT 'both') AS ""tmp3"") SELECT ""spine"".""spend_date"",""spine"".""platform"",COALESCE(SUM(""amount""), 0) AS ""total_amount"",COUNT(DISTINCT ""user_id"") AS ""total_users"" FROM ""spine"" LEFT JOIN ""tmp2"" ON ""spine"".""spend_date""=""tmp2"".""spend_date"" AND ""spine"".""platform""=""tmp2"".""platform"" GROUP BY ""spine"".""spend_date"",""spine"".""platform"""
159,"SELECT DISTINCT ""t1"".""spend_date"",""t1"".""platform"",COALESCE(""total_amount"", 0) AS ""total_amount"",COALESCE(""total_users"", 0) AS ""total_users"" FROM (SELECT ""spend_date"",'desktop' AS ""platform"" FROM ""spending"" UNION SELECT ""spend_date"",'mobile' AS ""platform"" FROM ""spending"" UNION SELECT ""spend_date"",'both' AS ""platform"" FROM ""spending"") AS ""t1"" LEFT JOIN (SELECT ""spend_date"",CASE WHEN ""cnt""=2 THEN 'both' ELSE ""platform"" END AS ""platform"",COUNT(DISTINCT ""user_id"") AS ""total_users"",SUM(""amount"") AS ""total_amount"" FROM (SELECT ""user_id"",""spend_date"",""platform"",SUM(""amount"") AS ""amount"",COUNT(""platform"") AS ""cnt"" FROM ""spending"" GROUP BY ""user_id"",""spend_date"") AS ""t"" GROUP BY 1,2) AS ""t2"" ON ""t1"".""spend_date""=""t2"".""spend_date"" AND ""t1"".""platform""=""t2"".""platform"""
160,"WITH ""cte"" AS (SELECT ""user_id"",""spend_date"",CASE WHEN ""platform""!='mobile' AND ""platform""!='desktop' THEN 'both' ELSE ""platform"" END AS ""platform"",""amount"" FROM (SELECT ""user_id"",""spend_date"",STRING_AGG(""platform"", ',') AS ""platform"",SUM(""amount"") AS ""amount"" FROM ""spending"" GROUP BY 1,2) AS ""f""), ""cte1"" AS (SELECT DISTINCT (""spend_date""),'mobile' AS ""platform"" FROM ""spending"" UNION SELECT DISTINCT (""spend_date""),'desktop' AS ""platform"" FROM ""spending"" UNION SELECT DISTINCT (""spend_date""),'both' AS ""platform"" FROM ""spending""), ""cte2"" AS (SELECT ""spend_date"",""platform"",SUM(""amount"") AS ""amount"",COUNT(DISTINCT ""user_id"") AS ""total_users"" FROM ""cte"" GROUP BY 1,2) SELECT ""cte1"".""spend_date"",""cte1"".""platform"",COALESCE(""cte2"".""amount"", 0) AS ""total_amount"",COALESCE(""cte2"".""total_users"", 0) AS ""total_users"" FROM ""cte1"" LEFT JOIN ""cte2"" ON ""cte1"".""spend_date""=""cte2"".""spend_date"" AND ""cte1"".""platform""=""cte2"".""platform"""
161,"SELECT ""a"".""spend_date"",""a"".""platform"",COALESCE(SUM(""total_amount""), 0) AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM (SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""spending"" UNION SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""spending"" UNION SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""spending"") AS ""a"" LEFT JOIN (SELECT ""spend_date"",""user_id"",(""mobile_amount""+""desktop_amount"") AS ""total_amount"",CASE WHEN ""mobile_amount"">0 THEN CASE WHEN ""desktop_amount"">0 THEN 'both' ELSE 'mobile' END ELSE 'desktop' END AS ""platform"" FROM (SELECT ""user_id"",""spend_date"",SUM(CASE ""platform"" WHEN 'mobile' THEN ""amount"" ELSE 0 END) AS ""mobile_amount"",SUM(CASE ""platform"" WHEN 'desktop' THEN ""amount"" ELSE 0 END) AS ""desktop_amount"" FROM ""spending"" GROUP BY ""spend_date"",""user_id"") AS ""b"") AS ""c"" ON ""a"".""spend_date""=""c"".""spend_date"" AND ""a"".""platform""=""c"".""platform"" GROUP BY ""a"".""spend_date"",""a"".""platform"""
162,"SELECT ""p"".""spend_date"",""p"".""platform"",COALESCE(SUM(""amount""), 0) AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM (SELECT DISTINCT (""spend_date""),'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'both' AS ""platform"" FROM ""Spending"") AS ""p"" LEFT JOIN (SELECT ""spend_date"",""user_id"",CASE WHEN ""mobile_amount"">0 THEN CASE WHEN ""desktop_amount"">0 THEN 'both' ELSE 'mobile' END ELSE 'desktop' END AS ""platform"",(""mobile_amount""+""desktop_amount"") AS ""amount"" FROM (SELECT ""spend_date"",""user_id"",SUM(CASE ""platform"" WHEN 'mobile' THEN ""amount"" ELSE 0 END) AS ""mobile_amount"",SUM(CASE ""platform"" WHEN 'desktop' THEN ""amount"" ELSE 0 END) AS ""desktop_amount"" FROM ""Spending"" GROUP BY ""spend_date"",""user_id"") AS ""o"") AS ""t"" ON ""p"".""platform""=""t"".""platform"" AND ""p"".""spend_date""=""t"".""spend_date"" GROUP BY ""spend_date"",""platform"""
163,"WITH ""cte"" AS (SELECT ""user_id"",""spend_date"",SUM(CASE WHEN ""platform""='mobile' THEN ""amount"" ELSE 0 END) AS ""ma"",SUM(CASE WHEN ""platform""='desktop' THEN ""amount"" ELSE 0 END) AS ""da"" FROM ""Spending"" GROUP BY 1,2) SELECT ""spend_date"",'desktop' AS ""platform"",SUM(CASE WHEN ""da"">0 AND ""ma""=0 THEN ""da"" ELSE 0 END) AS ""total_amount"",SUM(CASE WHEN ""da"">0 AND ""ma""=0 THEN 1 ELSE 0 END) AS ""total_users"" FROM ""cte"" GROUP BY 1,2 UNION ALL SELECT ""spend_date"",'mobile' AS ""platform"",SUM(CASE WHEN ""da""=0 AND ""ma"">0 THEN ""ma"" ELSE 0 END) AS ""total_amount"",SUM(CASE WHEN ""da""=0 AND ""ma"">0 THEN 1 ELSE 0 END) AS ""total_users"" FROM ""cte"" GROUP BY 1,2 UNION ALL SELECT ""spend_date"",'both' AS ""platform"",SUM(CASE WHEN ""da"">0 AND ""ma"">0 THEN ""ma""+""da"" ELSE 0 END) AS ""total_amount"",SUM(CASE WHEN ""da"">0 AND ""ma"">0 THEN 1 ELSE 0 END) AS ""total_users"" FROM ""cte"" GROUP BY 1,2 ORDER BY 1"
164,"WITH ""t1"" AS (SELECT NULL AS ""user_id"",""spend_date"",""platform"",0 AS ""amount"" FROM (SELECT DISTINCT ""spend_date"" FROM ""Spending"") AS ""t1"" CROSS JOIN (SELECT * FROM (SELECT 'mobile' AS ""platform"" UNION SELECT 'desktop' AS ""platform"" UNION SELECT 'both' AS ""platform"") AS ""t2"") AS ""t3""), ""t2"" AS (SELECT *,COUNT(""platform"") OVER (PARTITION BY ""spend_date"", ""user_id"") AS ""cnt"" FROM ""Spending""), ""t3"" AS (SELECT ""user_id"",""spend_date"",""platform"",""amount"" FROM ""t2"" WHERE ""cnt""=1 AND ""platform""='mobile' UNION SELECT ""user_id"",""spend_date"",""platform"",""amount"" FROM ""t2"" WHERE ""cnt""=1 AND ""platform""='desktop' UNION SELECT ""user_id"",""spend_date"",'both' AS ""platform"",SUM(""amount"") FROM ""t2"" WHERE ""cnt""=2 GROUP BY ""user_id"",""spend_date"" UNION SELECT * FROM ""t1"") SELECT ""spend_date"",""platform"",SUM(""amount"") AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM ""t3"" GROUP BY ""spend_date"",""platform"""
165,"WITH ""temp"" AS (SELECT ""spend_date"",""user_id"",SUM(""amount"") AS ""amount"",CASE WHEN SUM(CASE WHEN ""platform""='mobile' THEN 1 ELSE 0 END)=0 THEN 1 ELSE 0 END AS ""desktop"",CASE WHEN SUM(CASE WHEN ""platform""='desktop' THEN 1 ELSE 0 END)=0 THEN 1 ELSE 0 END AS ""mobile"",CASE WHEN SUM(CASE WHEN ""platform""='desktop' THEN 1 ELSE 0 END)+SUM(CASE WHEN ""platform""='mobile' THEN 1 ELSE 0 END)=2 THEN 1 ELSE 0 END AS ""b"" FROM ""Spending"" GROUP BY ""spend_date"",""user_id"") SELECT ""spend_date"",'desktop' AS ""platform"",SUM(""desktop""*""amount"") AS ""total_amount"",SUM(""desktop"") AS ""total_users"" FROM ""temp"" GROUP BY ""spend_date"" UNION ALL SELECT ""spend_date"",'mobile' AS ""platform"",SUM(""mobile""*""amount"") AS ""total_amount"",SUM(""mobile"") AS ""total_users"" FROM ""temp"" GROUP BY ""spend_date"" UNION ALL SELECT ""spend_date"",'both' AS ""platform"",SUM(""b""*""amount"") AS ""total_amount"",SUM(""b"") AS ""total_users"" FROM ""temp"" GROUP BY ""spend_date"""
166,"SELECT ""p"".""spend_date"",""p"".""platform"",COALESCE(SUM(""amount""), 0) AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM (SELECT DISTINCT (""spend_date""),'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'both' AS ""platform"" FROM ""Spending"") AS ""p"" LEFT JOIN (SELECT ""spend_date"",""user_id"",CASE WHEN ""mobile_amount"">0 THEN CASE WHEN ""desktop_amount"">0 THEN 'both' ELSE 'mobile' END ELSE 'desktop' END AS ""platform"",(""mobile_amount""+""desktop_amount"") AS ""amount"" FROM (SELECT ""spend_date"",""user_id"",SUM(CASE ""platform"" WHEN 'mobile' THEN ""amount"" ELSE 0 END) AS ""mobile_amount"",SUM(CASE ""platform"" WHEN 'desktop' THEN ""amount"" ELSE 0 END) AS ""desktop_amount"" FROM ""Spending"" GROUP BY ""spend_date"",""user_id"") AS ""o"") AS ""t"" ON ""p"".""platform""=""t"".""platform"" AND ""p"".""spend_date""=""t"".""spend_date"" GROUP BY ""spend_date"",""platform"""
167,"SELECT ""c"".""spend_date"",""c"".""platform"",SUM(COALESCE(""amount"", 0)) AS ""total_amount"",SUM(CASE WHEN ""amount"" IS NULL THEN 0 ELSE 1 END) AS ""total_users"" FROM (SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""spending"" UNION ALL SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""spending"" UNION ALL SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""spending"") AS ""c"" LEFT JOIN (SELECT ""user_id"",""spend_date"",CASE WHEN COUNT(1)=1 THEN ""platform"" ELSE 'both' END AS ""platform"",SUM(""amount"") AS ""amount"" FROM ""spending"" GROUP BY ""user_id"",""spend_date"") AS ""v"" ON ""c"".""spend_date""=""v"".""spend_date"" AND ""c"".""platform""=""v"".""platform"" GROUP BY ""spend_date"",""platform"""
168,"WITH ""c1"" AS (SELECT ""user_id"",""spend_date"",""platform"",SUM(CASE WHEN ""platform""='mobile' THEN ""amount"" ELSE 0 END) AS ""ma"",SUM(CASE WHEN ""platform""='desktop' THEN ""amount"" ELSE 0 END) AS ""da"" FROM ""Spending"" GROUP BY 1,2) SELECT ""spend_date"",'desktop' AS ""platform"",SUM(CASE WHEN ""da"">0 AND ""ma""=0 THEN ""da"" ELSE 0 END) AS ""total_amount"",SUM(CASE WHEN ""da"">0 AND ""ma""=0 THEN 1 ELSE 0 END) AS ""total_users"" FROM ""c1"" GROUP BY 1,2 UNION ALL SELECT ""spend_date"",'mobile' AS ""platform"",SUM(CASE WHEN ""ma"">0 AND ""da""=0 THEN ""ma"" ELSE 0 END) AS ""total_amount"",SUM(CASE WHEN ""ma"">0 AND ""da""=0 THEN 1 ELSE 0 END) AS ""total_users"" FROM ""c1"" GROUP BY 1,2 UNION ALL SELECT ""spend_date"",'both' AS ""platform"",SUM(CASE WHEN ""ma"">0 AND ""da"">0 THEN ""ma""+""da"" ELSE 0 END) AS ""total_amount"",SUM(CASE WHEN ""ma"">0 AND ""da"">0 THEN 1 ELSE 0 END) AS ""total_users"" FROM ""c1"" GROUP BY 1,2"
169,"SELECT ""tmp1"".""spend_date"",""tmp1"".""platform"",COALESCE(SUM(""tmp3"".""amount""), 0) AS ""total_amount"",COUNT(""tmp3"".""user_id"") AS ""total_users"" FROM (SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""Spending"" UNION ALL SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""Spending"" UNION ALL SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""Spending"") AS ""tmp1"" LEFT JOIN (SELECT ""user_id"",""spend_date"",CASE WHEN ""mobile_amount"">0 THEN CASE WHEN ""desktop_amount"">0 THEN 'both' ELSE 'mobile' END ELSE 'desktop' END AS ""platform"",(""mobile_amount""+""desktop_amount"") AS ""amount"" FROM (SELECT ""user_id"",""spend_date"",SUM(CASE WHEN ""platform""='mobile' THEN ""amount"" ELSE 0 END) AS ""mobile_amount"",SUM(CASE WHEN ""platform""='desktop' THEN ""amount"" ELSE 0 END) AS ""desktop_amount"" FROM ""Spending"" GROUP BY ""user_id"",""spend_date"") AS ""tmp2"") AS ""tmp3"" ON ""tmp1"".""spend_date""=""tmp3"".""spend_date"" AND ""tmp1"".""platform""=""tmp3"".""platform"" GROUP BY ""spend_date"",""platform"""
170,"SELECT ""m1"".""spend_date"",""m1"".""platform"",SUM(CASE WHEN ""m2"".""user_id"" IS NOT NULL THEN ""amount"" ELSE 0 END) AS ""total_amount"",SUM(CASE WHEN ""m2"".""user_id"" IS NOT NULL THEN 1 ELSE 0 END) AS ""total_users"" FROM (SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""Spending"" UNION ALL SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""Spending"" UNION ALL SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""spending"") AS ""m1"" LEFT JOIN (SELECT ""spend_date"",""user_id"",CASE WHEN ""desktop_amount"">0 AND ""mobile_amount""=0 THEN 'desktop' WHEN ""desktop_amount""=0 AND ""mobile_amount"">0 THEN 'mobile' WHEN ""desktop_amount"">0 AND ""mobile_amount"">0 THEN 'both' ELSE NULL END AS ""platform"",""desktop_amount""+""mobile_amount"" AS ""amount"" FROM (SELECT ""spend_date"",""user_id"",SUM(CASE WHEN ""platform""='desktop' THEN ""amount"" ELSE 0 END) AS ""desktop_amount"",SUM(CASE WHEN ""platform""='mobile' THEN ""amount"" ELSE 0 END) AS ""mobile_amount"" FROM ""Spending"" GROUP BY ""spend_date"",""user_id"") AS ""t"") AS ""m2"" ON ""m1"".""spend_date""=""m2"".""spend_date"" AND ""m1"".""platform""=""m2"".""platform"" GROUP BY ""m1"".""spend_date"",""m1"".""platform"""
171,"WITH ""cte"" AS (SELECT ""user_id"",""spend_date"",SUM(""amount"") AS ""total_amount"",CASE WHEN COUNT(DISTINCT ""platform"")=2 THEN 'both' ELSE ""platform"" END AS ""platform_all"" FROM ""spending"" GROUP BY ""user_id"",""spend_date""), ""grps"" AS (SELECT ""s1"".""spend_date"",""s2"".""platform"" FROM (SELECT DISTINCT ""spend_date"" FROM ""cte"" ORDER BY 1) AS ""s1"" CROSS JOIN (SELECT 'mobile' AS ""platform"" UNION ALL SELECT 'desktop' AS ""platform"" UNION ALL SELECT 'both' AS ""platform"") AS ""s2""), ""interm"" AS (SELECT ""spend_date"",""platform_all"" AS ""platform"",SUM(""total_amount"") AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM ""cte"" AS ""c"" GROUP BY 1,2) SELECT ""g"".""spend_date"",""g"".""platform"",COALESCE(""total_amount"", 0) AS ""total_amount"",COALESCE(""total_users"", 0) AS ""total_users"" FROM ""grps"" AS ""g"" LEFT JOIN ""interm"" AS ""i"" ON ""g"".""spend_date""=""i"".""spend_date"" AND ""g"".""platform""=""i"".""platform"""
172,"WITH ""tab_user_day_platform"" AS (SELECT ""user_id"",""spend_date"",""platform"" FROM ""spending"" GROUP BY ""user_id"",""spend_date"" HAVING COUNT(DISTINCT ""platform"")=1 UNION SELECT ""user_id"",""spend_date"",'both' FROM ""spending"" GROUP BY ""user_id"",""spend_date"" HAVING COUNT(DISTINCT ""platform"")>1), ""template_tab"" AS (SELECT * FROM (SELECT DISTINCT ""spend_date"" FROM ""spending"") AS ""a"" CROSS JOIN (SELECT 'mobile' AS ""platform"" UNION SELECT 'desktop' AS ""platform"" UNION SELECT 'both' AS ""platform"") AS ""b""), ""tab_prep"" AS (SELECT ""t"".""spend_date"",""t"".""platform"",SUM(""amount"") AS ""total_amount"",COUNT(DISTINCT ""t"".""user_id"") AS ""total_users"" FROM ""tab_user_day_platform"" AS ""t"" JOIN ""spending"" ON ""t"".""user_id""=""spending"".""user_id"" AND ""t"".""spend_date""=""spending"".""spend_date"" GROUP BY ""t"".""spend_date"",""t"".""platform"") SELECT ""template_tab"".""spend_date"",""template_tab"".""platform"",COALESCE(""tab_prep"".""total_amount"", 0) AS ""total_amount"",COALESCE(""tab_prep"".""total_users"", 0) AS ""total_users"" FROM ""template_tab"" LEFT JOIN ""tab_prep"" ON ""template_tab"".""spend_date""=""tab_prep"".""spend_date"" AND ""template_tab"".""platform""=""tab_prep"".""platform"""
173,"WITH ""cte"" AS (SELECT ""spend_date"",""user_id"",MAX(""platform"") AS ""platform"",COUNT(DISTINCT ""platform"") AS ""cnt"",SUM(""amount"") AS ""amount"" FROM ""Spending"" GROUP BY ""spend_date"",""user_id"" ORDER BY 1,2) SELECT ""p"".""spend_date"",""p"".""platform"",COALESCE(SUM(""cte2"".""amount""), 0) AS ""total_amount"",COALESCE(COUNT(DISTINCT ""cte2"".""user_id""), 0) AS ""total_users"" FROM (SELECT DISTINCT (""spend_date""),'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'both' AS ""platform"" FROM ""Spending"") AS ""p"" LEFT JOIN (SELECT ""spend_date"",""user_id"",""amount"",CASE WHEN ""cnt"">1 THEN 'both' ELSE ""platform"" END AS ""platform"" FROM ""cte"") AS ""cte2"" ON ""p"".""spend_date""=""cte2"".""spend_date"" AND ""cte2"".""platform""=""p"".""platform"" GROUP BY ""p"".""spend_date"",""p"".""platform"" ORDER BY 1"
174,"SELECT ""t1"".""spend_date"",""t1"".""platform"",COALESCE(SUM(""amount""), 0) AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM (SELECT DISTINCT (""spend_date""),'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'both' AS ""platform"" FROM ""Spending"") AS ""t1"" LEFT JOIN (SELECT ""spend_date"",""user_id"",CASE WHEN ""mobile_amount"">0 THEN CASE WHEN ""desktop_amount"">0 THEN 'both' ELSE 'mobile' END ELSE 'desktop' END AS ""platform"",(""mobile_amount""+""desktop_amount"") AS ""amount"" FROM (SELECT ""spend_date"",""user_id"",SUM(CASE ""platform"" WHEN 'mobile' THEN ""amount"" ELSE 0 END) AS ""mobile_amount"",SUM(CASE ""platform"" WHEN 'desktop' THEN ""amount"" ELSE 0 END) AS ""desktop_amount"" FROM ""Spending"" GROUP BY ""spend_date"",""user_id"") AS ""t2"") AS ""t3"" ON ""t1"".""platform""=""t3"".""platform"" AND ""t1"".""spend_date""=""t3"".""spend_date"" GROUP BY ""spend_date"",""platform"""
175,"SELECT ""p"".""spend_date"",""p"".""platform"",COALESCE(SUM(""amount""), 0) AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM (SELECT DISTINCT (""spend_date""),'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'both' AS ""platform"" FROM ""Spending"") AS ""p"" LEFT JOIN (SELECT ""spend_date"",""user_id"",CASE WHEN ""mobile_amount"">0 THEN CASE WHEN ""desktop_amount"">0 THEN 'both' ELSE 'mobile' END ELSE 'desktop' END AS ""platform"",(""mobile_amount""+""desktop_amount"") AS ""amount"" FROM (SELECT ""spend_date"",""user_id"",SUM(CASE ""platform"" WHEN 'mobile' THEN ""amount"" ELSE 0 END) AS ""mobile_amount"",SUM(CASE ""platform"" WHEN 'desktop' THEN ""amount"" ELSE 0 END) AS ""desktop_amount"" FROM ""Spending"" GROUP BY ""spend_date"",""user_id"") AS ""o"") AS ""t"" ON ""p"".""platform""=""t"".""platform"" AND ""p"".""spend_date""=""t"".""spend_date"" GROUP BY ""spend_date"",""platform"""
176,"WITH ""agg"" AS (SELECT ""spend_date"",""user_id"",CASE WHEN COUNT(DISTINCT ""platform"")>1 THEN 'both' ELSE MAX(""platform"") END AS ""platform"",SUM(""amount"") AS ""amt"" FROM ""spending"" GROUP BY 1,2), ""agg2"" AS (SELECT ""spend_date"",""platform"",SUM(""amt"") AS ""total_amount"",COUNT(DISTINCT ""user_id"") AS ""total_users"" FROM ""agg"" GROUP BY 1,2 ORDER BY 1,4), ""rec"" AS (SELECT DISTINCT ""spend_date"",""p"".""platform"" FROM ""spending"" AS ""s"" CROSS JOIN (SELECT 'desktop' AS ""platform"" UNION SELECT 'mobile' UNION SELECT 'both') AS ""p"") SELECT ""r"".""spend_date"",""r"".""platform"",COALESCE(""a"".""total_amount"", 0) AS ""total_amount"",COALESCE(""a"".""total_users"", 0) AS ""total_users"" FROM ""rec"" AS ""r"" LEFT JOIN ""agg2"" AS ""a"" ON ""r"".""spend_date""=""a"".""spend_date"" AND ""r"".""platform""=""a"".""platform"""
177,"WITH ""agg"" AS (SELECT ""spend_date"",""user_id"",CASE WHEN COUNT(DISTINCT ""platform"")>1 THEN 'both' ELSE MAX(""platform"") END AS ""platform"",SUM(""amount"") AS ""amt"" FROM ""spending"" GROUP BY 1,2), ""agg2"" AS (SELECT ""spend_date"",""platform"",SUM(""amt"") AS ""total_amount"",COUNT(DISTINCT ""user_id"") AS ""total_users"" FROM ""agg"" GROUP BY 1,2 ORDER BY 1,4), ""rec"" AS (SELECT DISTINCT ""spend_date"",""p"".""platform"" FROM ""spending"" AS ""s"" CROSS JOIN (SELECT 'desktop' AS ""platform"" UNION SELECT 'mobile' UNION SELECT 'both') AS ""p"") SELECT ""r"".""spend_date"",""r"".""platform"",COALESCE(""a"".""total_amount"", 0) AS ""total_amount"",COALESCE(""a"".""total_users"", 0) AS ""total_users"" FROM ""rec"" AS ""r"" LEFT JOIN ""agg2"" AS ""a"" ON ""r"".""spend_date""=""a"".""spend_date"" AND ""r"".""platform""=""a"".""platform"""
178,"WITH ""is_multiple_platforms"" AS (SELECT ""spend_date"",""user_id"",COUNT(DISTINCT ""platform"") AS ""platform_cnt"",SUM(""amount"") AS ""amount"" FROM ""spending"" GROUP BY 1,2), ""summary"" AS (SELECT ""s"".""spend_date"",""s"".""platform"",SUM(""s"".""amount"") AS ""total_amount"",COUNT(DISTINCT ""s"".""user_id"") AS ""total_users"" FROM ""spending"" AS ""s"" JOIN (SELECT * FROM ""is_multiple_platforms"" WHERE ""platform_cnt""=1) AS ""m"" ON ""s"".""user_id""=""m"".""user_id"" AND ""s"".""spend_date""=""m"".""spend_date"" GROUP BY 1,2 UNION ALL SELECT ""s"".""spend_date"",'both' AS ""platform"",SUM(""s"".""amount"") AS ""total_amount"",COUNT(DISTINCT ""s"".""user_id"") AS ""total_users"" FROM ""spending"" AS ""s"" JOIN (SELECT * FROM ""is_multiple_platforms"" WHERE ""platform_cnt"">1) AS ""m"" ON ""s"".""user_id""=""m"".""user_id"" AND ""s"".""spend_date""=""m"".""spend_date"" GROUP BY 1,2), ""platform_lookup"" AS (SELECT ""platform"" FROM ""spending"" GROUP BY 1 UNION ALL SELECT 'both' AS ""platform"" FROM ""spending""), ""date_lookup"" AS (SELECT ""spend_date"" FROM ""spending"" GROUP BY 1), ""lookup"" AS (SELECT * FROM (""date_lookup"") CROSS JOIN ""platform_lookup"" GROUP BY 1,2) SELECT ""l"".""spend_date"",""l"".""platform"",COALESCE(""s"".""total_amount"", 0) AS ""total_amount"",COALESCE(""s"".""total_users"", 0) AS ""total_users"" FROM ""lookup"" AS ""l"" LEFT JOIN ""summary"" AS ""s"" ON ""l"".""spend_date""=""s"".""spend_date"" AND ""l"".""platform""=""s"".""platform"" ORDER BY 1,2"
179,"WITH ""t1"" AS (SELECT ""spend_date"",""platform"",COUNT(DISTINCT ""user_id"") AS ""total_users"",SUM(""amount"") AS ""total_amount"" FROM (SELECT ""user_id"",""spend_date"",SUM(""amount"") AS ""amount"",CASE WHEN COUNT(DISTINCT ""platform"")=1 THEN ""platform"" ELSE 'both' END AS ""platform"" FROM ""Spending"" GROUP BY ""user_id"",""spend_date"") AS ""t0"" GROUP BY ""spend_date"",""platform""), ""t2"" AS (SELECT DISTINCT (""spend_date""),'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'both' AS ""platform"" FROM ""Spending"") SELECT ""t2"".*,COALESCE(""t1"".""total_amount"", 0) AS ""total_amount"",COALESCE(""t1"".""total_users"", 0) AS ""total_users"" FROM ""t2"" LEFT JOIN ""t1"" ON ""t2"".""platform""=""t1"".""platform"" AND ""t2"".""spend_date""=""t1"".""spend_date"""
180,"WITH ""t1"" AS (SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""Spending""), ""t2"" AS (SELECT ""user_id"",""spend_date"",CASE WHEN COUNT(DISTINCT ""platform"")=2 THEN 'both' ELSE ""platform"" END AS ""platform"",SUM(""amount"") AS ""amount"" FROM ""Spending"" GROUP BY ""spend_date"",""user_id"") SELECT ""t1"".*,COALESCE(SUM(""amount""), 0) AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM ""t1"" LEFT JOIN ""t2"" USING (""spend_date"",""platform"") GROUP BY 1,2"
181,"WITH ""wrapper"" AS (SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""spending"" UNION SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""spending"" UNION SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""spending"" ORDER BY 1), ""user_counts"" AS (SELECT DISTINCT *,COUNT(1) OVER (PARTITION BY ""spend_date"", ""user_id"") AS ""n_users"" FROM ""spending""), ""platform_both_"" AS (SELECT ""spend_date"",'both' AS ""platform"",SUM(""amount"") AS ""total_amount"",COUNT(DISTINCT ""user_id"") AS ""total_users"" FROM ""user_counts"" WHERE ""n_users""=2 GROUP BY 1), ""platform_singles"" AS (SELECT ""spend_date"",""platform"",SUM(""amount"") AS ""total_amount"",COUNT(DISTINCT ""user_id"") AS ""total_users"" FROM ""user_counts"" WHERE ""n_users""=1 GROUP BY 1,2) SELECT ""w"".""spend_date"",""w"".""platform"",COALESCE(""u"".""total_amount"", 0) AS ""total_amount"",COALESCE(""u"".""total_users"", 0) AS ""total_users"" FROM ""wrapper"" AS ""w"" LEFT JOIN (SELECT * FROM ""platform_both_"" UNION SELECT * FROM ""platform_singles"") AS ""u"" ON ""w"".""spend_date""=""u"".""spend_date"" AND ""w"".""platform""=""u"".""platform"""
182,"WITH ""cte1"" AS (SELECT ""user_id"",""spend_date"",COUNT(1) AS ""cnt"",""platform"",SUM(""amount"") AS ""amount"" FROM ""Spending"" GROUP BY 1,2), ""cte2"" AS (SELECT ""user_id"",""spend_date"",CASE WHEN ""cnt""=2 THEN 'both' ELSE ""platform"" END AS ""platform"",""amount"" FROM ""cte1""), ""cte"" AS (SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""Spending"") SELECT ""a"".""spend_date"",""a"".""platform"",COALESCE(SUM(""amount""), 0) AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM ""cte"" AS ""a"" LEFT JOIN ""cte2"" AS ""b"" ON ""a"".""spend_date""=""b"".""spend_date"" AND ""a"".""platform""=""b"".""platform"" GROUP BY 1,2"
183,"WITH ""cte"" AS (SELECT ""spend_date"",""user_id"",SUM(CASE WHEN ""platform""='desktop' THEN ""amount"" ELSE 0 END) AS ""desktop_amount"",SUM(CASE WHEN ""platform""='mobile' THEN ""amount"" ELSE 0 END) AS ""mobile_amount"" FROM ""Spending"" GROUP BY ""spend_date"",""user_id"") SELECT ""spend_date"",'desktop' AS ""platform"",SUM(CASE WHEN ""desktop_amount"">0 AND ""mobile_amount""=0 THEN ""desktop_amount"" ELSE 0 END) AS ""total_amount"",SUM(CASE WHEN ""desktop_amount"">0 AND ""mobile_amount""=0 THEN 1 ELSE 0 END) AS ""total_users"" FROM ""cte"" GROUP BY ""spend_date"" UNION ALL SELECT ""spend_date"",'mobile' AS ""platform"",SUM(CASE WHEN ""desktop_amount""=0 AND ""mobile_amount"">0 THEN ""mobile_amount"" ELSE 0 END) AS ""total_amount"",SUM(CASE WHEN ""desktop_amount""=0 AND ""mobile_amount"">0 THEN 1 ELSE 0 END) AS ""total_users"" FROM ""cte"" GROUP BY ""spend_date"" UNION ALL SELECT ""spend_date"",'both' AS ""platform"",SUM(CASE WHEN ""desktop_amount"">0 AND ""mobile_amount"">0 THEN ""desktop_amount""+""mobile_amount"" ELSE 0 END) AS ""total_amount"",SUM(CASE WHEN ""desktop_amount"">0 AND ""mobile_amount"">0 THEN 1 ELSE 0 END) AS ""total_users"" FROM ""cte"" GROUP BY ""spend_date"""
184,"WITH ""t1"" AS (SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""Spending""), ""t2"" AS (SELECT ""user_id"",""spend_date"",CASE WHEN COUNT(DISTINCT ""platform"")=2 THEN 'both' ELSE ""platform"" END AS ""platform"",SUM(""amount"") AS ""amount"" FROM ""Spending"" GROUP BY ""spend_date"",""user_id"") SELECT ""t1"".*,COALESCE(SUM(""t2"".""amount""), 0) AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM ""t1"" LEFT JOIN ""t2"" USING (""spend_date"",""platform"") GROUP BY 1,2"
185,"SELECT ""c"".""spend_date"",""c"".""platform"",SUM(COALESCE(""amount"", 0)) AS ""total_amount"",SUM(CASE WHEN ""amount"" IS NULL THEN 0 ELSE 1 END) AS ""total_users"" FROM (SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""spending"" UNION ALL SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""spending"" UNION ALL SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""spending"") AS ""c"" LEFT JOIN (SELECT ""user_id"",""spend_date"",CASE WHEN COUNT(1)=1 THEN ""platform"" ELSE 'both' END AS ""platform"",SUM(""amount"") AS ""amount"" FROM ""spending"" GROUP BY ""user_id"",""spend_date"") AS ""v"" ON ""c"".""spend_date""=""v"".""spend_date"" AND ""c"".""platform""=""v"".""platform"" GROUP BY ""spend_date"",""platform"""
186,"WITH ""summary"" AS (SELECT ""user_id"",""spend_date"",""platform"",SUM(""amount"") AS ""total_amount"",COUNT(1) AS ""total_users"" FROM ""Spending"" GROUP BY ""user_id"",""spend_date""), ""date_platform"" AS (SELECT DISTINCT ""spend_date"" AS ""spend_date"",'desktop' AS ""platform"" FROM ""Spending"" UNION ALL SELECT DISTINCT ""spend_date"" AS ""spend_date"",'mobile' AS ""platform"" FROM ""Spending"" UNION ALL SELECT DISTINCT ""spend_date"" AS ""spend_date"",'both' AS ""platform"" FROM ""Spending""), ""shaped"" AS (SELECT ""user_id"",""spend_date"",CASE WHEN ""total_users""=2 THEN 'both' ELSE ""platform"" END AS ""platform"",""total_amount"" FROM ""summary"") SELECT ""d"".""spend_date"",""d"".""platform"",COALESCE(SUM(""s"".""total_amount""), 0) AS ""total_amount"",COUNT(""s"".""user_id"") AS ""total_users"" FROM ""date_platform"" AS ""d"" LEFT JOIN ""shaped"" AS ""s"" ON ""d"".""spend_date""=""s"".""spend_date"" AND ""d"".""platform""=""s"".""platform"" GROUP BY ""d"".""spend_date"",""d"".""platform"""
187,"SELECT ""p"".""spend_date"",""p"".""platform"",COALESCE(SUM(""amount""), 0) AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM (SELECT DISTINCT (""spend_date""),'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'both' AS ""platform"" FROM ""Spending"") AS ""p"" LEFT JOIN (SELECT ""spend_date"",""user_id"",CASE WHEN ""mobile_amount"">0 THEN CASE WHEN ""desktop_amount"">0 THEN 'both' ELSE 'mobile' END ELSE 'desktop' END AS ""platform"",(""mobile_amount""+""desktop_amount"") AS ""amount"" FROM (SELECT ""spend_date"",""user_id"",SUM(CASE ""platform"" WHEN 'mobile' THEN ""amount"" ELSE 0 END) AS ""mobile_amount"",SUM(CASE ""platform"" WHEN 'desktop' THEN ""amount"" ELSE 0 END) AS ""desktop_amount"" FROM ""Spending"" GROUP BY ""spend_date"",""user_id"") AS ""o"") AS ""t"" ON ""p"".""platform""=""t"".""platform"" AND ""p"".""spend_date""=""t"".""spend_date"" GROUP BY ""spend_date"",""platform"""
188,"SELECT ""a"".""spend_date"",""a"".""platform"",COALESCE(SUM(""amount""), 0) AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM (SELECT DISTINCT (""spend_date""),'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'both' AS ""platform"" FROM ""Spending"") AS ""a"" LEFT JOIN (SELECT ""spend_date"",""user_id"",CASE WHEN ""mobile_amount"">0 THEN CASE WHEN ""desktop_amount"">0 THEN 'both' ELSE 'mobile' END ELSE 'desktop' END AS ""platform"",(""mobile_amount""+""desktop_amount"") AS ""amount"" FROM (SELECT ""spend_date"",""user_id"",SUM(CASE ""platform"" WHEN 'mobile' THEN ""amount"" ELSE 0 END) AS ""mobile_amount"",SUM(CASE ""platform"" WHEN 'desktop' THEN ""amount"" ELSE 0 END) AS ""desktop_amount"" FROM ""Spending"" GROUP BY ""spend_date"",""user_id"") AS ""temp"") AS ""b"" ON ""a"".""spend_date""=""b"".""spend_date"" AND ""a"".""platform""=""b"".""platform"" GROUP BY ""spend_date"",""platform"""
189,"SELECT ""p"".""spend_date"",""p"".""platform"",COALESCE(SUM(""amount""), 0) AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM (SELECT DISTINCT (""spend_date""),'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'both' AS ""platform"" FROM ""Spending"") AS ""p"" LEFT JOIN (SELECT ""spend_date"",""user_id"",CASE WHEN ""mobile_amount"">0 THEN CASE WHEN ""desktop_amount"">0 THEN 'both' ELSE 'mobile' END ELSE 'desktop' END AS ""platform"",(""mobile_amount""+""desktop_amount"") AS ""amount"" FROM (SELECT ""spend_date"",""user_id"",SUM(CASE ""platform"" WHEN 'mobile' THEN ""amount"" ELSE 0 END) AS ""mobile_amount"",SUM(CASE ""platform"" WHEN 'desktop' THEN ""amount"" ELSE 0 END) AS ""desktop_amount"" FROM ""Spending"" GROUP BY ""spend_date"",""user_id"") AS ""o"") AS ""t"" ON ""p"".""platform""=""t"".""platform"" AND ""p"".""spend_date""=""t"".""spend_date"" GROUP BY ""spend_date"",""platform"""
190,"SELECT ""c"".""spend_date"",""c"".""platform"",SUM(COALESCE(""amount"", 0)) AS ""total_amount"",SUM(CASE WHEN ""amount"" IS NULL THEN 0 ELSE 1 END) AS ""total_users"" FROM (SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""spending"" UNION ALL SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""spending"" UNION ALL SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""spending"") AS ""c"" LEFT JOIN (SELECT ""user_id"",""spend_date"",CASE WHEN COUNT(1)=1 THEN ""platform"" ELSE 'both' END AS ""platform"",SUM(""amount"") AS ""amount"" FROM ""spending"" GROUP BY ""user_id"",""spend_date"") AS ""v"" ON ""c"".""spend_date""=""v"".""spend_date"" AND ""c"".""platform""=""v"".""platform"" GROUP BY ""spend_date"",""platform"""
191,"WITH ""pf"" AS (SELECT 'desktop' AS ""platform"" UNION ALL SELECT 'mobile' UNION ALL SELECT 'both'), ""datedim"" AS (SELECT ""d"".""spend_date"",""pf"".""platform"" FROM (SELECT DISTINCT ""spend_date"" FROM ""spending"") AS ""d"" CROSS JOIN ""pf""), ""prep"" AS (SELECT ""user_id"",""spend_date"",""platform"",""amount"",COUNT(""platform"") OVER (PARTITION BY ""user_id"", ""spend_date"") AS ""num"" FROM ""spending""), ""uniplatform"" AS (SELECT ""spend_date"",""platform"",SUM(""amount"") AS ""total_amount"",COUNT(DISTINCT ""user_id"") AS ""total_users"" FROM ""prep"" WHERE ""num""=1 GROUP BY ""spend_date"",""platform""), ""dualplatform"" AS (SELECT ""spend_date"",'both' AS ""platform"",SUM(""amount"") AS ""total_amount"",COUNT(DISTINCT ""user_id"") AS ""total_users"" FROM ""prep"" WHERE ""num"">1 GROUP BY ""spend_date"") SELECT ""datedim"".""spend_date"",""datedim"".""platform"",COALESCE(""u"".""total_amount"", 0) AS ""total_amount"",COALESCE(""u"".""total_users"", 0) AS ""total_users"" FROM ""datedim"" LEFT JOIN (SELECT ""spend_date"",""platform"",""total_amount"",""total_users"" FROM ""uniplatform"" UNION ALL SELECT ""spend_date"",""platform"",""total_amount"",""total_users"" FROM ""dualplatform"") AS ""u"" ON ""u"".""spend_date""=""datedim"".""spend_date"" AND ""u"".""platform""=""datedim"".""platform"" ORDER BY 2,1"
192,"WITH ""tmp"" AS (SELECT ""spend_date"",""user_id"",MIN(""platform"") AS ""platform"",COUNT(""platform"") AS ""cnt"",SUM(""amount"") AS ""amount"" FROM ""spending"" GROUP BY ""spend_date"",""user_id""), ""dates"" AS (SELECT DISTINCT ""spend_date"" FROM ""spending"") SELECT ""dates"".""spend_date"",'both' AS ""platform"",SUM(COALESCE(""amount"", 0)) AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM ""dates"" LEFT JOIN ""tmp"" ON ""dates"".""spend_date""=""tmp"".""spend_date"" AND ""cnt""=2 GROUP BY ""dates"".""spend_date"" UNION SELECT ""dates"".""spend_date"",'desktop' AS ""platform"",SUM(COALESCE(""amount"", 0)) AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM ""dates"" LEFT JOIN ""tmp"" ON ""dates"".""spend_date""=""tmp"".""spend_date"" AND ""platform""='desktop' AND ""cnt""=1 GROUP BY ""dates"".""spend_date"" UNION SELECT ""dates"".""spend_date"",'mobile' AS ""platform"",SUM(COALESCE(""amount"", 0)) AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM ""dates"" LEFT JOIN ""tmp"" ON ""dates"".""spend_date""=""tmp"".""spend_date"" AND ""platform""='mobile' AND ""cnt""=1 GROUP BY ""dates"".""spend_date"""
193,"SELECT ""c"".""spend_date"",""c"".""platform"",SUM(COALESCE(""amount"", 0)) AS ""total_amount"",SUM(CASE WHEN ""amount"" IS NULL THEN 0 ELSE 1 END) AS ""total_users"" FROM (SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""spending"" UNION ALL SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""spending"" UNION ALL SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""spending"") AS ""c"" LEFT JOIN (SELECT ""user_id"",""spend_date"",CASE WHEN COUNT(1)=1 THEN ""platform"" ELSE 'both' END AS ""platform"",SUM(""amount"") AS ""amount"" FROM ""spending"" GROUP BY ""user_id"",""spend_date"") AS ""v"" ON ""c"".""spend_date""=""v"".""spend_date"" AND ""c"".""platform""=""v"".""platform"" GROUP BY ""spend_date"",""platform"""
194,"WITH ""dates"" AS (SELECT ""spend_date"",'mobile' AS ""platform"" FROM ""spending"" UNION SELECT ""spend_date"",'desktop' AS ""platform"" FROM ""spending"" UNION SELECT ""spend_date"",'both' AS ""platform"" FROM ""spending"") SELECT ""dates"".""spend_date"",""dates"".""platform"",COALESCE(SUM(""amount""), 0) AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM ""dates"" LEFT JOIN (SELECT ""user_id"",""spend_date"",CASE WHEN ""mobile"">0 THEN CASE WHEN ""desktop"">0 THEN 'both' ELSE 'mobile' END ELSE 'desktop' END AS ""platform"",(""mobile""+""desktop"") AS ""amount"" FROM (SELECT ""user_id"",""spend_date"",SUM(CASE WHEN ""platform""='mobile' THEN ""amount"" ELSE 0 END) AS ""mobile"",SUM(CASE WHEN ""platform""='desktop' THEN ""amount"" ELSE 0 END) AS ""desktop"" FROM ""Spending"" GROUP BY ""spend_date"",""user_id"") AS ""a"") AS ""b"" ON ""dates"".""spend_date""=""b"".""spend_date"" AND ""dates"".""platform""=""b"".""platform"" GROUP BY ""spend_date"",""platform"""
195,"SELECT ""p"".""spend_date"",""p"".""platform"",COALESCE(SUM(""amount""), 0) AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM (SELECT DISTINCT (""spend_date""),'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'both' AS ""platform"" FROM ""Spending"") AS ""p"" LEFT JOIN (SELECT ""spend_date"",""user_id"",CASE WHEN ""mobile_amount"">0 THEN CASE WHEN ""desktop_amount"">0 THEN 'both' ELSE 'mobile' END ELSE 'desktop' END AS ""platform"",(""mobile_amount""+""desktop_amount"") AS ""amount"" FROM (SELECT ""spend_date"",""user_id"",SUM(CASE ""platform"" WHEN 'mobile' THEN ""amount"" ELSE 0 END) AS ""mobile_amount"",SUM(CASE ""platform"" WHEN 'desktop' THEN ""amount"" ELSE 0 END) AS ""desktop_amount"" FROM ""Spending"" GROUP BY ""spend_date"",""user_id"") AS ""o"") AS ""t"" ON ""p"".""platform""=""t"".""platform"" AND ""p"".""spend_date""=""t"".""spend_date"" GROUP BY ""spend_date"",""platform"""
196,"WITH ""cte"" AS (SELECT ""user_id"",""spend_date"",SUM(DISTINCT CASE WHEN ""platform""='desktop' THEN 1 ELSE 2 END) AS ""type"",SUM(""amount"") AS ""amount"" FROM ""Spending"" GROUP BY ""spend_date"",""user_id"") SELECT ""sub1"".""spend_date"",""sub1"".""platform"",COALESCE(""sub2"".""total_amount"", 0) AS ""total_amount"",COALESCE(""sub2"".""total_users"", 0) AS ""total_users"" FROM (SELECT DISTINCT ""cte"".""spend_date"",""p"".""platform"" FROM ""cte"" CROSS JOIN (SELECT 'desktop' AS ""platform"" UNION SELECT 'mobile' UNION SELECT 'both') AS ""p"") AS ""sub1"" LEFT JOIN (SELECT ""spend_date"",CASE WHEN ""type""=1 THEN 'desktop' WHEN ""type""=2 THEN 'mobile' ELSE 'both' END AS ""platform"",SUM(""amount"") AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM ""cte"" GROUP BY ""spend_date"",""type"") AS ""sub2"" ON ""sub1"".""spend_date""=""sub2"".""spend_date"" AND ""sub1"".""platform""=""sub2"".""platform"""
197,"WITH ""cte"" AS (SELECT ""user_id"",""spend_date"",SUM(""amount"") AS ""amount"",CASE WHEN SUM(""platform""='desktop')=0 THEN 1 ELSE 0 END AS ""mobile"",CASE WHEN SUM(""platform""='mobile')=0 THEN 1 ELSE 0 END AS ""desktop"",CASE WHEN SUM(""platform""='desktop')=0 OR SUM(""platform""='mobile')=0 THEN 0 ELSE 1 END AS ""both"" FROM ""Spending"" GROUP BY 1,2) SELECT ""spend_date"",'mobile' AS ""platform"",SUM(""amount""*""mobile"") AS ""total_amount"",SUM(""mobile"") AS ""total_users"" FROM ""cte"" GROUP BY 1 UNION ALL SELECT ""spend_date"",'desktop' AS ""platform"",SUM(""amount""*""desktop"") AS ""total_amount"",SUM(""desktop"") AS ""total_users"" FROM ""cte"" GROUP BY 1 UNION ALL SELECT ""spend_date"",'both' AS ""platform"",SUM(""amount""*""both"") AS ""total_amount"",SUM(""both"") AS ""total_users"" FROM ""cte"" GROUP BY 1"
198,"WITH ""counting"" AS (SELECT ""user_id"",""spend_date"",COUNT(1) AS ""ct"",""platform"",SUM(""amount"") AS ""amount"" FROM ""Spending"" GROUP BY 1,2), ""structure"" AS (SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""spending"" UNION SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""spending"" UNION SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""spending""), ""sorting"" AS (SELECT ""user_id"",""spend_date"",CASE WHEN ""ct""=2 THEN 'both' ELSE ""platform"" END AS ""platform"",""amount"" FROM ""counting"") SELECT ""s"".""spend_date"",""s"".""platform"",COALESCE(SUM(""amount""), 0) AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM ""structure"" AS ""s"" LEFT JOIN ""sorting"" AS ""st"" ON ""st"".""spend_date""=""s"".""spend_date"" AND ""st"".""platform""=""s"".""platform"" GROUP BY 1,2"
199,"WITH ""platform_count"" AS (SELECT ""spend_date"",""user_id"",COUNT(DISTINCT ""platform"") AS ""plat_cnt"",SUM(""amount"") AS ""total_amount"" FROM ""Spending"" GROUP BY 1,2), ""platform_summ"" AS (SELECT DISTINCT ""a"".""user_id"",""a"".""total_amount"",""a"".""spend_date"",CASE WHEN ""a"".""plat_cnt""=2 THEN 'both' ELSE ""b"".""platform"" END AS ""platform_summ"" FROM ""platform_count"" AS ""a"" LEFT JOIN ""Spending"" AS ""b"" ON ""a"".""spend_date""=""b"".""spend_date"" AND ""a"".""user_id""=""b"".""user_id""), ""platform_summ_2"" AS (SELECT ""spend_date"",""platform_summ"" AS ""platform"",SUM(""total_amount"") AS ""total_amount"",COUNT(DISTINCT ""user_id"") AS ""total_users"" FROM ""platform_summ"" GROUP BY 1,2) SELECT ""a"".""spend_date"",""a"".""platform"",COALESCE(""total_amount"", 0) AS ""total_amount"",COALESCE(""total_users"", 0) AS ""total_users"" FROM (SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""Spending"" UNION ALL SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""Spending"" UNION ALL SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""Spending"") AS ""a"" LEFT JOIN ""platform_summ_2"" AS ""b"" ON ""a"".""spend_date""=""b"".""spend_date"" AND ""a"".""platform""=""b"".""platform"""
200,"SELECT ""t1"".""spend_date"",""t1"".""platform"",COALESCE(SUM(""amount""), 0) AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM (SELECT DISTINCT (""spend_date""),'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'both' AS ""platform"" FROM ""Spending"") AS ""t1"" LEFT JOIN (SELECT ""spend_date"",""user_id"",CASE WHEN ""mobile_amount"">0 THEN CASE WHEN ""desktop_amount"">0 THEN 'both' ELSE 'mobile' END ELSE 'desktop' END AS ""platform"",(""mobile_amount""+""desktop_amount"") AS ""amount"" FROM (SELECT ""spend_date"",""user_id"",SUM(CASE ""platform"" WHEN 'mobile' THEN ""amount"" ELSE 0 END) AS ""mobile_amount"",SUM(CASE ""platform"" WHEN 'desktop' THEN ""amount"" ELSE 0 END) AS ""desktop_amount"" FROM ""Spending"" GROUP BY ""spend_date"",""user_id"") AS ""t2"") AS ""t3"" ON ""t1"".""platform""=""t3"".""platform"" AND ""t1"".""spend_date""=""t3"".""spend_date"" GROUP BY ""spend_date"",""platform"""
201,"WITH ""cte"" AS (SELECT ""user_id"",""spend_date"",SUM(CASE WHEN ""platform""='mobile' THEN ""amount"" ELSE 0 END) AS ""ma"",SUM(CASE WHEN ""platform""='desktop' THEN ""amount"" ELSE 0 END) AS ""da"" FROM ""spending"" GROUP BY ""user_id"",""spend_date"") SELECT ""spend_date"",'desktop' AS ""platform"",SUM(CASE WHEN ""cte"".""da"">0 AND ""cte"".""ma""=0 THEN ""da"" ELSE 0 END) AS ""total_amount"",SUM(CASE WHEN ""cte"".""da"">0 AND ""cte"".""ma""=0 THEN 1 ELSE 0 END) AS ""total_users"" FROM ""cte"" GROUP BY ""spend_date"" UNION ALL SELECT ""spend_date"",'mobile' AS ""platform"",SUM(CASE WHEN ""cte"".""da""=0 AND ""cte"".""ma"">0 THEN ""ma"" ELSE 0 END) AS ""total_amount"",SUM(CASE WHEN ""cte"".""da""=0 AND ""cte"".""ma"">0 THEN 1 ELSE 0 END) AS ""total_users"" FROM ""cte"" GROUP BY ""spend_date"" UNION ALL SELECT ""spend_date"",'both' AS ""platform"",SUM(CASE WHEN ""cte"".""da"">0 AND ""cte"".""ma"">0 THEN ""da""+""ma"" ELSE 0 END) AS ""total_amount"",SUM(CASE WHEN ""cte"".""da"">0 AND ""cte"".""ma"">0 THEN 1 ELSE 0 END) AS ""total_users"" FROM ""cte"" GROUP BY ""spend_date"""
202,"WITH ""cte1"" AS (SELECT ""user_id"",""spend_date"",COUNT(1) AS ""cnt"",""platform"",SUM(""amount"") AS ""amount"" FROM ""Spending"" GROUP BY 1,2), ""cte2"" AS (SELECT ""user_id"",""spend_date"",CASE WHEN ""cnt""=2 THEN 'both' ELSE ""platform"" END AS ""platform"",""amount"" FROM ""cte1""), ""cte"" AS (SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""Spending"") SELECT ""a"".""spend_date"",""a"".""platform"",COALESCE(SUM(""amount""), 0) AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM ""cte"" AS ""a"" LEFT JOIN ""cte2"" AS ""b"" ON ""a"".""spend_date""=""b"".""spend_date"" AND ""a"".""platform""=""b"".""platform"" GROUP BY 1,2"
203,"WITH ""T3"" AS (SELECT ""spend_date"",""platform"",SUM(""total_amount"") AS ""total_amount"",COUNT(1) AS ""total_users"" FROM (SELECT ""spend_date"",""user_id"",CASE WHEN ""mobile_uses"">0 AND ""desktop_uses"">0 THEN 'both' WHEN ""mobile_uses"">0 THEN 'mobile' WHEN ""desktop_uses"">0 THEN 'desktop' ELSE 'UNK' END AS ""platform"",""total_amount"" FROM (SELECT ""spend_date"",""user_id"",SUM(CASE WHEN ""platform""='mobile' THEN 1 ELSE 0 END) AS ""mobile_uses"",SUM(CASE WHEN ""platform""='desktop' THEN 1 ELSE 0 END) AS ""desktop_uses"",SUM(""amount"") AS ""total_amount"" FROM ""Spending"" GROUP BY ""spend_date"",""user_id"") AS ""T4"") AS ""T5"" GROUP BY ""spend_date"",""platform""), ""T1"" AS (SELECT ""spend_date"" FROM ""T3"" GROUP BY ""spend_date""), ""T2"" AS (SELECT ""spend_date"",'desktop' AS ""platform"" FROM ""T1"" UNION SELECT ""spend_date"",'mobile' AS ""platform"" FROM ""T1"" UNION SELECT ""spend_date"",'both' AS ""platform"" FROM ""T1"") SELECT ""T2"".""spend_date"",""T2"".""platform"",COALESCE(""T3"".""total_amount"", 0) AS ""total_amount"",COALESCE(""T3"".""total_users"", 0) AS ""total_users"" FROM ""T2"" LEFT JOIN ""T3"" ON ""T2"".""spend_date""=""T3"".""spend_date"" AND ""T2"".""platform""=""T3"".""platform"""
204,"WITH ""SpendBehavior"" AS (SELECT ""spend_date"",""user_id"",CASE WHEN COUNT(DISTINCT ""platform"")=2 THEN 'both' ELSE MAX(""platform"") END AS ""user_group"" FROM ""Spending"" GROUP BY ""spend_date"",""user_id""), ""SpendGroup"" AS (SELECT 'desktop' AS ""platform"" UNION SELECT 'mobile' UNION SELECT 'both'), ""SpendDates"" AS (SELECT DISTINCT ""spend_date"" FROM ""Spending""), ""ResultsFramework"" AS (SELECT ""SpendDates"".""spend_date"",""SpendGroup"".""platform"" FROM ""SpendDates"" CROSS JOIN ""SpendGroup"") SELECT ""ResultsFramework"".""spend_date"",""ResultsFramework"".""platform"",SUM(COALESCE(""Spending"".""amount"", 0)) AS ""total_amount"",COUNT(DISTINCT ""Spending"".""user_id"") AS ""total_users"" FROM (""ResultsFramework"" LEFT JOIN ""SpendBehavior"" ON ""SpendBehavior"".""user_group""=""ResultsFramework"".""platform"" AND ""SpendBehavior"".""spend_date""=""ResultsFramework"".""spend_date"") LEFT JOIN ""Spending"" ON ""Spending"".""spend_date""=""SpendBehavior"".""spend_date"" AND ""Spending"".""user_id""=""SpendBehavior"".""user_id"" GROUP BY ""ResultsFramework"".""spend_date"",""ResultsFramework"".""platform"""
205,"WITH ""tem"" AS (SELECT ""user_id"",""spend_date"",SUM(CASE WHEN ""platform""='desktop' THEN ""amount"" ELSE 0 END) AS ""da"",SUM(CASE WHEN ""platform""='mobile' THEN ""amount"" ELSE 0 END) AS ""ma"" FROM ""spending"" GROUP BY ""user_id"",""spend_date"") SELECT ""spend_date"",'desktop' AS ""platform"",SUM(CASE WHEN ""da"">0 AND ""ma""=0 THEN ""da"" ELSE 0 END) AS ""total_amount"",SUM(CASE WHEN ""da"">0 AND ""ma""=0 THEN 1 ELSE 0 END) AS ""total_users"" FROM ""tem"" GROUP BY ""spend_date"" UNION ALL SELECT ""spend_date"",'mobile' AS ""platform"",SUM(CASE WHEN ""ma"">0 AND ""da""=0 THEN ""ma"" ELSE 0 END) AS ""total_amount"",SUM(CASE WHEN ""ma"">0 AND ""da""=0 THEN 1 ELSE 0 END) AS ""total_users"" FROM ""tem"" GROUP BY ""spend_date"" UNION ALL SELECT ""spend_date"",'both' AS ""platform"",SUM(CASE WHEN ""ma"">0 AND ""da"">0 THEN ""ma""+""da"" ELSE 0 END) AS ""total_amount"",SUM(CASE WHEN ""ma"">0 AND ""da"">0 THEN 1 ELSE 0 END) AS ""total_users"" FROM ""tem"" GROUP BY ""spend_date"""
206,"WITH ""T1"" AS (SELECT ""user_id"",""spend_date"",""platform"",""amount"",COUNT(""platform"") OVER (PARTITION BY ""spend_date"", ""user_id"") AS ""num"" FROM ""Spending""), ""T2"" AS (SELECT ""user_id"",""spend_date"",CASE WHEN ""num""=1 THEN ""platform"" ELSE 'both' END AS ""platform"",""amount"" FROM ""T1"") SELECT ""A"".""spend_date"",""A"".""platform"",SUM(COALESCE(""T2"".""amount"", 0)) AS ""total_amount"",COUNT(DISTINCT ""T2"".""user_id"") AS ""total_users"" FROM (SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""Spending"" UNION ALL SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""Spending"" UNION ALL SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""Spending"") AS ""A"" LEFT JOIN ""T2"" ON ""A"".""spend_date""=""T2"".""spend_date"" AND ""A"".""platform""=""T2"".""platform"" GROUP BY 1,2"
207,"WITH ""cte"" AS (SELECT ""spend_date"",""user_id"",MAX(""platform"") AS ""platform"",COUNT(DISTINCT ""platform"") AS ""cnt"",SUM(""amount"") AS ""amount"" FROM ""Spending"" GROUP BY ""spend_date"",""user_id"" ORDER BY 1,2), ""d"" AS (SELECT * FROM (SELECT DISTINCT ""spend_date"" FROM ""Spending"") AS ""a"" CROSS, (SELECT 'desktop' AS ""platform"" UNION ALL SELECT 'mobile' UNION ALL SELECT 'both') AS ""p"") SELECT ""d"".""spend_date"",""d"".""platform"",COALESCE(SUM(""cte2"".""amount""), 0) AS ""total_amount"",COALESCE(COUNT(DISTINCT ""cte2"".""user_id""), 0) AS ""total_users"" FROM ""d"" LEFT JOIN (SELECT ""spend_date"",""user_id"",""amount"",CASE WHEN ""cnt"">1 THEN 'both' ELSE ""platform"" END AS ""platform"" FROM ""cte"") AS ""cte2"" ON ""d"".""spend_date""=""cte2"".""spend_date"" AND ""cte2"".""platform""=""d"".""platform"" GROUP BY ""d"".""spend_date"",""d"".""platform"" ORDER BY 1"
208,"WITH ""cte"" AS (SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""Spending"" UNION ALL SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""Spending"" UNION ALL SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""Spending""), ""cte2"" AS (SELECT ""a"".""spend_date"",CASE WHEN ""b"".""platform"" IS NOT NULL THEN 'both' ELSE ""a"".""platform"" END AS ""platform"",SUM(""a"".""amount"") AS ""total_amount"",COUNT(DISTINCT ""a"".""user_id"") AS ""total_users"" FROM ""Spending"" AS ""a"" LEFT JOIN ""Spending"" AS ""b"" ON ""a"".""user_id""=""b"".""user_id"" AND ""a"".""spend_date""=""b"".""spend_date"" AND ""a"".""platform""!=""b"".""platform"" GROUP BY ""a"".""spend_date"",""platform"") SELECT ""cte"".""spend_date"",""cte"".""platform"",COALESCE(""cte2"".""total_amount"", 0) AS ""total_amount"",COALESCE(""cte2"".""total_users"", 0) AS ""total_users"" FROM ""cte2"" RIGHT JOIN ""cte"" ON ""cte2"".""spend_date""=""cte"".""spend_date"" AND ""cte2"".""platform""=""cte"".""platform"""
209,"SELECT ""p"".""spend_date"",""p"".""platform"",COALESCE(""y"".""total_amount"", 0) AS ""total_amount"",COALESCE(""y"".""total_users"", 0) AS ""total_users"" FROM (SELECT DISTINCT (""spend_date""),'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'both' AS ""platform"" FROM ""Spending"") AS ""p"" LEFT JOIN (SELECT ""spend_date"",""platform"",SUM(""amount"") AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM (SELECT ""spend_date"",""user_id"",""platform"",""amount"" FROM ""Spending"" GROUP BY 1,2 HAVING COUNT(1)=1) AS ""t"" GROUP BY 1,2 UNION SELECT ""a"".""spend_date"",'both' AS ""platform"",SUM(""a"".""amount""+""b"".""amount"") AS ""total_users"",COUNT(""a"".""user_id"") AS ""total_users"" FROM ""Spending"" AS ""a"" JOIN ""Spending"" AS ""b"" ON ""a"".""user_id""=""b"".""user_id"" AND ""a"".""spend_date""=""b"".""spend_date"" AND ""a"".""platform""<""b"".""platform"" GROUP BY 1) AS ""y"" ON ""p"".""platform""=""y"".""platform"" AND ""p"".""spend_date""=""y"".""spend_date"""
210,"WITH ""x"" AS (SELECT ""user_id"",""spend_date"",SUM(CASE WHEN ""platform""='mobile' THEN ""amount"" ELSE 0 END) AS ""mobile_amount"",SUM(CASE WHEN ""platform""='desktop' THEN ""amount"" ELSE 0 END) AS ""desktop_amount"" FROM ""spending"" GROUP BY ""user_id"",""spend_date"") SELECT * FROM (SELECT ""spend_date"",'mobile' AS ""platform"",SUM(CASE WHEN ""mobile_amount"">0 AND ""desktop_amount""=0 THEN ""mobile_amount"" ELSE 0 END) AS ""total_amount"",SUM(CASE WHEN ""mobile_amount"">0 AND ""desktop_amount""=0 THEN 1 ELSE 0 END) AS ""total_users"" FROM ""x"" GROUP BY ""spend_date"" UNION SELECT ""spend_date"",'desktop' AS ""platform"",SUM(CASE WHEN ""mobile_amount""=0 AND ""desktop_amount"">0 THEN ""desktop_amount"" ELSE 0 END) AS ""total_amount"",SUM(CASE WHEN ""mobile_amount""=0 AND ""desktop_amount"">0 THEN 1 ELSE 0 END) AS ""total_users"" FROM ""x"" GROUP BY ""spend_date"" UNION SELECT ""spend_date"",'both' AS ""platform"",SUM(CASE WHEN ""mobile_amount"">0 AND ""desktop_amount"">0 THEN ""mobile_amount""+""desktop_amount"" ELSE 0 END) AS ""total_amount"",SUM(CASE WHEN ""mobile_amount"">0 AND ""desktop_amount"">0 THEN 1 ELSE 0 END) AS ""total_users"" FROM ""x"" GROUP BY ""spend_date"") AS ""a"" ORDER BY ""spend_date"",CASE WHEN ""platform""='desktop' THEN 1 WHEN ""platform""='mobile' THEN 2 ELSE 3 END"
211,"WITH ""temp1"" AS (SELECT ""user_id"",""spend_date"",""platform"",SUM(""amount"") AS ""amount"" FROM ""spending"" GROUP BY 1,2,3), ""a"" AS (SELECT ""spend_date"",COUNT(DISTINCT ""user_id"") AS ""total_users"",SUM(""amount"") AS ""total_amount"" FROM (SELECT ""spend_date"",""user_id"",SUM(""amount"") AS ""amount"" FROM ""temp1"" GROUP BY 1,2 HAVING COUNT(""platform"")>=2) AS ""temp1"" GROUP BY ""spend_date""), ""b"" AS (SELECT DISTINCT ""spend_date"" FROM ""spending"" ORDER BY ""spend_date""), ""sale_both"" AS (SELECT ""b"".""spend_date"",'both' AS ""platform"",COALESCE(""a"".""total_amount"", 0) AS ""total_amount"",COALESCE(""a"".""total_users"", 0) AS ""total_users"" FROM ""b"" LEFT JOIN ""a"" ON ""b"".""spend_date""=""a"".""spend_date""), ""temp2"" AS (SELECT ""spend_date"",""platform"",SUM(""amount"") AS ""total_amount"",COUNT(DISTINCT ""user_id"") AS ""total_users"" FROM (SELECT ""user_id"",""spend_date"",""platform"",SUM(""amount"") AS ""amount"" FROM ""temp1"" GROUP BY 1,2 HAVING COUNT(""platform"")=1) AS ""temp2"" WHERE ""platform""='mobile' GROUP BY 1,2), ""sale_mobile"" AS (SELECT ""b"".""spend_date"",'mobile' AS ""platform"",COALESCE(""temp2"".""total_amount"", 0) AS ""total_amount"",COALESCE(""temp2"".""total_users"", 0) AS ""total_users"" FROM ""b"" LEFT JOIN ""temp2"" ON ""b"".""spend_date""=""temp2"".""spend_date""), ""temp3"" AS (SELECT ""spend_date"",""platform"",SUM(""amount"") AS ""total_amount"",COUNT(DISTINCT ""user_id"") AS ""total_users"" FROM (SELECT ""user_id"",""spend_date"",""platform"",SUM(""amount"") AS ""amount"" FROM ""temp1"" GROUP BY 1,2 HAVING COUNT(""platform"")=1) AS ""temp2"" WHERE ""platform""='desktop' GROUP BY 1,2), ""sale_desktop"" AS (SELECT ""b"".""spend_date"",'desktop' AS ""platform"",COALESCE(""temp3"".""total_amount"", 0) AS ""total_amount"",COALESCE(""temp3"".""total_users"", 0) AS ""total_users"" FROM ""b"" LEFT JOIN ""temp3"" ON ""b"".""spend_date""=""temp3"".""spend_date"") SELECT * FROM ""sale_both"" UNION ALL SELECT * FROM ""sale_mobile"" UNION ALL SELECT * FROM ""sale_desktop"" ORDER BY 1"
212,"WITH ""t1"" AS (SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""Spending""), ""t2"" AS (SELECT ""user_id"",""spend_date"",CASE WHEN COUNT(DISTINCT ""platform"")=2 THEN 'both' ELSE ""platform"" END AS ""platform"",SUM(""amount"") AS ""amount"" FROM ""Spending"" GROUP BY ""spend_date"",""user_id"") SELECT ""t1"".*,COALESCE(SUM(""t2"".""amount""), 0) AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM ""t1"" LEFT JOIN ""t2"" USING (""spend_date"",""platform"") GROUP BY 1,2 ORDER BY ""spend_date"""
213,"SELECT ""C"".""spend_date"",""C"".""platform"",COALESCE(""D"".""total_amount"", 0) AS ""total_amount"",COALESCE(""D"".""total_users"", 0) AS ""total_users"" FROM (SELECT ""spend_date"",""platform"" FROM (SELECT DISTINCT ""spend_date"" FROM ""Spending"") AS ""A"" CROSS JOIN (SELECT 'desktop' AS ""platform"" UNION ALL SELECT 'mobile' AS ""platform"" UNION ALL SELECT 'both' AS ""platform"") AS ""B"") AS ""C"" LEFT JOIN (SELECT ""spend_date"",""platform"",SUM(""amount_1"") AS ""total_amount"",COUNT(DISTINCT ""user_id"") AS ""total_users"" FROM (SELECT *,CASE WHEN ""platform_1""='mobile' AND ""platform_2""='desktop' THEN 'both' WHEN ""platform_2""='mobile' AND ""platform_1""='desktop' THEN 'both' WHEN ""platform_1""='mobile' AND ""platform_2"" IS NULL THEN 'mobile' ELSE 'desktop' END AS ""platform"" FROM (SELECT ""a"".""user_id"",""a"".""spend_date"",""a"".""platform"" AS ""platform_1"",""a"".""amount"" AS ""amount_1"",""b"".""platform"" AS ""platform_2"",""b"".""amount"" AS ""amount_2"" FROM ""Spending"" AS ""a"" LEFT JOIN ""Spending"" AS ""b"" ON ""a"".""user_id""=""b"".""user_id"" AND ""a"".""spend_date""=""b"".""spend_date"" AND ""a"".""platform""!=""b"".""platform"") AS ""c"") AS ""d"" GROUP BY ""spend_date"",""platform"") AS ""D"" ON ""C"".""spend_date""=""D"".""spend_date"" AND ""C"".""platform""=""D"".""platform"""
214,"WITH ""Spend_platforms"" AS (SELECT ""user_id"",""spend_date"",(CASE WHEN COUNT(CASE WHEN ""platform""='mobile' THEN 1 ELSE NULL END)=0 THEN 1 ELSE 0 END) AS ""desktop"",(CASE WHEN COUNT(CASE WHEN ""platform""='desktop' THEN 1 ELSE NULL END)=0 THEN 1 ELSE 0 END) AS ""mobile"",(CASE WHEN COUNT(CASE WHEN ""platform""='mobile' THEN 1 ELSE NULL END)=0 OR COUNT(CASE WHEN ""platform""='desktop' THEN 1 ELSE NULL END)=0 THEN 0 ELSE 1 END) AS ""boths"",SUM(""amount"") AS ""amount"" FROM ""Spending"" GROUP BY 1,2) SELECT ""spend_date"",'desktop' AS ""platform"",SUM(CASE WHEN ""desktop""=1 THEN ""amount"" ELSE 0 END) AS ""total_amount"",COUNT(CASE WHEN ""desktop""=1 THEN 1 ELSE NULL END) AS ""total_users"" FROM ""Spend_platforms"" GROUP BY 1 UNION ALL SELECT ""spend_date"",'mobile' AS ""platform"",SUM(CASE WHEN ""mobile""=1 THEN ""amount"" ELSE 0 END) AS ""total_amount"",COUNT(CASE WHEN ""mobile""=1 THEN 1 ELSE NULL END) AS ""total_users"" FROM ""Spend_platforms"" GROUP BY 1 UNION ALL SELECT ""spend_date"",'both' AS ""platform"",SUM(CASE WHEN ""boths""=1 THEN ""amount"" ELSE 0 END) AS ""total_amount"",COUNT(CASE WHEN ""boths""=1 THEN 1 ELSE NULL END) AS ""total_users"" FROM ""Spend_platforms"" GROUP BY 1"
215,"SELECT ""spend_date"",""platform"",COALESCE(SUM(""sa""), 0) AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM (SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""Spending"") AS ""a"" LEFT JOIN (SELECT ""spend_date"",""user_id"",(CASE WHEN COUNT(""platform"")=1 THEN ""platform"" ELSE 'both' END) AS ""platform"",SUM(""amount"") AS ""sa"" FROM ""Spending"" GROUP BY ""spend_date"",""user_id"") AS ""b"" USING (""spend_date"",""platform"") GROUP BY ""spend_date"",""platform"""
216,"WITH ""cte1"" AS (SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""Spending"" UNION ALL SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""Spending"" UNION ALL SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""Spending""), ""cte2"" AS (SELECT ""spend_date"",""user_id"",CASE WHEN COUNT(DISTINCT ""platform"")=1 THEN ""platform"" ELSE 'both' END AS ""platform"",SUM(""amount"") AS ""total_amount"" FROM ""Spending"" GROUP BY ""spend_date"",""user_id""), ""cte3"" AS (SELECT ""spend_date"",""platform"",SUM(""total_amount"") AS ""total_amount"",COUNT(DISTINCT ""user_id"") AS ""user_cnt"" FROM ""cte2"" GROUP BY ""spend_date"",""platform"") SELECT ""a"".""spend_date"",""a"".""platform"",COALESCE(""total_amount"", 0) AS ""total_amount"",COALESCE(""user_cnt"", 0) AS ""total_users"" FROM ""cte1"" AS ""a"" LEFT JOIN ""cte3"" AS ""b"" ON ""a"".""spend_date""=""b"".""spend_date"" AND ""a"".""platform""=""b"".""platform"""
217,"SELECT ""c"".""spend_date"",""c"".""platform"",SUM(COALESCE(""amount"", 0)) AS ""total_amount"",SUM(CASE WHEN ""amount"" IS NULL THEN 0 ELSE 1 END) AS ""total_users"" FROM (SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""spending"" UNION ALL SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""spending"" UNION ALL SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""spending"") AS ""c"" LEFT JOIN (SELECT ""user_id"",""spend_date"",CASE WHEN COUNT(1)=1 THEN ""platform"" ELSE 'both' END AS ""platform"",SUM(""amount"") AS ""amount"" FROM ""spending"" GROUP BY ""user_id"",""spend_date"") AS ""v"" ON ""c"".""spend_date""=""v"".""spend_date"" AND ""c"".""platform""=""v"".""platform"" GROUP BY ""spend_date"",""platform"""
218,"WITH ""c"" AS (SELECT DISTINCT ""s"".""spend_date"",""p"".""platform"" FROM (""Spending"" AS ""s"") CROSS JOIN (SELECT 'desktop' AS ""platform"" UNION ALL SELECT 'mobile' UNION ALL SELECT 'both') AS ""p"") SELECT ""c"".""spend_date"",""c"".""platform"",COALESCE(""t2"".""total_amount"", 0) AS ""total_amount"",COALESCE(""t2"".""total_users"", 0) AS ""total_users"" FROM ""c"" LEFT JOIN (SELECT ""spend_date"",""platform"",SUM(""amount"") AS ""total_amount"",COUNT(DISTINCT ""user_id"") AS ""total_users"" FROM (SELECT ""s"".""user_id"",""s"".""amount"",""s"".""spend_date"",CASE WHEN ""t"".""cnt""=2 THEN 'both' ELSE ""s"".""platform"" END AS ""platform"" FROM ""Spending"" AS ""s"" JOIN (SELECT ""user_id"",""spend_date"",COUNT(DISTINCT ""platform"") AS ""cnt"" FROM ""Spending"" GROUP BY 1,2) AS ""t"" ON ""s"".""user_id""=""t"".""user_id"" AND ""s"".""spend_date""=""t"".""spend_date"") AS ""t1"" GROUP BY 1,2) AS ""t2"" ON ""c"".""spend_date""=""t2"".""spend_date"" AND ""c"".""platform""=""t2"".""platform"""
219,"WITH ""platforms"" (""platform"") AS (SELECT * FROM (VALUES ROW('desktop'), ROW('mobile'), ROW('both')) AS ""p""), ""platform_count"" AS (SELECT ""user_id"",""spend_date"",COUNT(DISTINCT ""platform"") AS ""count"" FROM ""Spending"" GROUP BY ""spend_date"",""user_id""), ""entries"" (""spend_date"", ""platform"") AS (SELECT DISTINCT ""spend_date"",""platforms"".""platform"" FROM ""Spending"" CROSS JOIN ""platforms""), ""results"" AS (SELECT ""spend_date"",""platform"",SUM(""amount"") AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM ""platform_count"" NATURAL CROSS JOIN ""Spending"" WHERE ""count""=1 GROUP BY ""spend_date"",""platform"" UNION ALL SELECT ""spend_date"",'both' AS ""platform"",SUM(""amount"") AS ""total_amount"",COUNT(DISTINCT ""user_id"") AS ""total_users"" FROM ""platform_count"" NATURAL CROSS JOIN ""Spending"" WHERE ""count""=2 GROUP BY ""spend_date"") SELECT ""spend_date"",""platform"",COALESCE(""total_amount"", 0) AS ""total_amount"",COALESCE(""total_users"", 0) AS ""total_users"" FROM ""entries"" NATURAL LEFT CROSS JOIN ""results"" ORDER BY ""spend_date"""
220,"WITH ""t"" AS (SELECT ""user_id"",""spend_date"",""amount"",CASE WHEN ""platform""='mobile' THEN 1 ELSE 0 END AS ""mobile"",CASE WHEN ""platform""='desktop' THEN 1 ELSE 0 END AS ""desktop"" FROM ""spending""), ""t1"" AS (SELECT ""user_id"",""spend_date"",SUM(""amount"") AS ""amount"",CASE WHEN SUM(""mobile"")>=1 AND SUM(""desktop"")>=1 THEN 'both' WHEN SUM(""mobile"")>=1 AND SUM(""desktop"")<1 THEN 'mobile' WHEN SUM(""mobile"")<1 AND SUM(""desktop"")>=1 THEN 'desktop' END AS ""platform"" FROM ""t"" GROUP BY 1,2), ""p"" AS (SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""t1"" UNION ALL SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""t1"" UNION ALL SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""t1"") SELECT ""sds"".""spend_date"",""sds"".""platform"",COALESCE(SUM(""amount""), 0) AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM ""t1"" RIGHT JOIN ""p"" AS ""sds"" ON ""t1"".""spend_date""=""sds"".""spend_date"" AND ""sds"".""platform""=""t1"".""platform"" GROUP BY 1,2 ORDER BY 1,2"
221,"SELECT ""t"".""spend_date"",""t"".""platform"",COALESCE(SUM(""t2"".""amount""), 0) AS ""total_amount"",COUNT(""t2"".""user_id"") AS ""total_users"" FROM (SELECT DISTINCT ""spend_date"",'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT ""spend_date"",'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT ""spend_date"",'both' AS ""platform"" FROM ""Spending"") AS ""t"" LEFT JOIN (SELECT ""spend_date"",""user_id"",CASE WHEN ""mobile_amount"">0 THEN CASE WHEN ""desktop_amount"">0 THEN 'both' ELSE 'mobile' END ELSE 'desktop' END AS ""platform"",""mobile_amount""+""desktop_amount"" AS ""amount"" FROM (SELECT ""user_id"",""spend_date"",SUM(CASE WHEN ""platform""='mobile' THEN ""amount"" ELSE 0 END) AS ""mobile_amount"",SUM(CASE WHEN ""platform""='desktop' THEN ""amount"" ELSE 0 END) AS ""desktop_amount"" FROM ""Spending"" GROUP BY ""spend_date"",""user_id"") AS ""t1"") AS ""t2"" ON ""t"".""spend_date""=""t2"".""spend_date"" AND ""t"".""platform""=""t2"".""platform"" GROUP BY ""t"".""spend_date"",""t"".""platform"""
222,"WITH ""o"" AS (SELECT ""spend_date"",""user_id"",SUM(CASE ""platform"" WHEN 'mobile' THEN ""amount"" ELSE 0 END) AS ""mobile_amount"",SUM(CASE ""platform"" WHEN 'desktop' THEN ""amount"" ELSE 0 END) AS ""desktop_amount"" FROM ""Spending"" GROUP BY ""spend_date"",""user_id""), ""p"" AS (SELECT DISTINCT (""spend_date""),'desktop' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'mobile' AS ""platform"" FROM ""Spending"" UNION SELECT DISTINCT (""spend_date""),'both' AS ""platform"" FROM ""Spending"") SELECT ""p"".""spend_date"",""p"".""platform"",COALESCE(SUM(""amount""), 0) AS ""total_amount"",COUNT(""user_id"") AS ""total_users"" FROM ""p"" LEFT JOIN (SELECT ""spend_date"",""user_id"",CASE WHEN ""mobile_amount"">0 THEN CASE WHEN ""desktop_amount"">0 THEN 'both' ELSE 'mobile' END ELSE 'desktop' END AS ""platform"",(""mobile_amount""+""desktop_amount"") AS ""amount"" FROM ""o"") AS ""t"" ON ""p"".""platform""=""t"".""platform"" AND ""p"".""spend_date""=""t"".""spend_date"" GROUP BY ""spend_date"",""platform"""
