id,original query
1,"WITH ""cte"" AS (SELECT ""transactions"".""account_id"",EXTRACT(YEAR FROM ""day"") AS ""year"",EXTRACT(MONTH FROM ""day"") AS ""month"",SUM(""amount"") AS ""total_income"",""max_income"" FROM ""transactions"" JOIN ""accounts"" ON ""transactions"".""account_id""=""accounts"".""account_id"" WHERE ""type""='Creditor' GROUP BY ""account_id"",EXTRACT(YEAR FROM ""day""),EXTRACT(MONTH FROM ""day"") ORDER BY ""account_id"",EXTRACT(YEAR FROM ""day""),EXTRACT(MONTH FROM ""day"")) SELECT DISTINCT ""t1"".""account_id"" FROM ""cte"" AS ""t1"" JOIN ""cte"" AS ""t2"" ON ""t1"".""account_id""=""t2"".""account_id"" AND ""t1"".""year""=""t2"".""year"" WHERE ""t1"".""month""=""t2"".""month""+1 AND ""t1"".""total_income"">""t1"".""max_income"" AND ""t2"".""total_income"">""t1"".""max_income"""
2,"WITH ""etc"" AS (SELECT ""account_id"",""month"",CASE WHEN ""total_income"">""max_income"" THEN 1 ELSE 0 END AS ""suspicious"" FROM (SELECT ""tr"".""account_id"",EXTRACT(MONTH FROM ""tr"".""day"") AS ""month"",SUM(""tr"".""amount"") AS ""total_income"",""ac"".""max_income"" FROM ""Transactions"" AS ""tr"" JOIN ""Accounts"" AS ""ac"" ON ""ac"".""account_id""=""tr"".""account_id"" WHERE ""tr"".""type""='Creditor' GROUP BY ""tr"".""account_id"",""month"") AS ""t1"" HAVING ""suspicious""=1 ORDER BY ""account_id"",""month""), ""t2"" AS (SELECT *,LAG(""month"", 1) OVER (PARTITION BY ""account_id"" ORDER BY ""month"") AS ""lag_month_1"" FROM ""etc"") SELECT DISTINCT ""account_id"" FROM ""t2"" WHERE ""month""-""lag_month_1""=1"
3,"WITH ""cte"" AS (SELECT ""account_id"",CONCAT(LEFT(""day"", 7), '-01') AS ""mth"",SUM(""amount"") AS ""total_amount"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY 1,2), ""sus"" AS (SELECT ""cte"".* FROM ""cte"" JOIN ""accounts"" AS ""t"" ON ""t"".""account_id""=""cte"".""account_id"" WHERE ""t"".""max_income""<""cte"".""total_amount""), ""cte_rank"" AS (SELECT ""account_id"",TIMESTAMPDIFF(MONTH, '2021-1-01', ""mth"") AS ""m"",ROW_NUMBER() OVER (PARTITION BY ""account_id"" ORDER BY ""mth"") AS ""drk"",TIMESTAMPDIFF(MONTH, '2021-1-01', ""mth"")*1.0-ROW_NUMBER() OVER (PARTITION BY ""account_id"" ORDER BY ""mth"") AS ""grp"" FROM ""sus"") SELECT DISTINCT ""account_id"" FROM ""cte_rank"" GROUP BY 1,""grp"" HAVING COUNT(1)>1 ORDER BY 1"
4,"WITH ""cte"" AS (SELECT ""T"".""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month"",EXTRACT(YEAR FROM ""day"") AS ""year"",""max_income"" FROM ""Transactions"" AS ""T"" JOIN ""Accounts"" AS ""A"" ON ""T"".""account_id""=""A"".""account_id"" WHERE ""type""='Creditor' GROUP BY ""account_id"",EXTRACT(MONTH FROM ""day"") HAVING SUM(""amount"")>""A"".""max_income"") SELECT DISTINCT ""t1"".""account_id"" FROM (""cte"" AS ""t1"") CROSS JOIN ""cte"" AS ""t2"" WHERE ""t1"".""account_id""=""t2"".""account_id"" AND (""t1"".""month""-""t2"".""month""=1 AND ""t1"".""year""=""t2"".""year"" OR ""t1"".""month""=12 AND ""t2"".""month""=1 AND ""t1"".""year""-""t2"".""year""=-1 OR ""t1"".""month""=12 AND ""t2"".""month""=1 AND ""t1"".""year""-""t2"".""year""=1)"
5,"WITH ""monthly_income"" AS (SELECT ""b"".""account_id"",TO_CHAR(""b"".""day"", '%y%m') AS ""month"",""a"".""max_income"" FROM ""Accounts"" AS ""a"" JOIN ""Transactions"" AS ""b"" ON ""a"".""account_id""=""b"".""account_id"" GROUP BY ""b"".""account_id"",""month"" HAVING SUM((""type""='Creditor')*""amount"")>""a"".""max_income"") SELECT DISTINCT ""a"".""account_id"" FROM ""monthly_income"" AS ""a"" JOIN ""monthly_income"" AS ""b"" ON ""a"".""account_id""=""b"".""account_id"" AND PERIOD_DIFF(""a"".""month"", ""b"".""month"")=1 ORDER BY ""account_id"""
6,"WITH ""cte"" AS (SELECT ""t"".""account_id"",EXTRACT(MONTH FROM ""t"".""day"") AS ""month"",SUM(""t"".""amount"") AS ""amount"",""a"".""max_income"" FROM ""transactions"" AS ""t"" LEFT JOIN ""accounts"" AS ""a"" USING (""account_id"") WHERE ""t"".""type""='creditor' GROUP BY 1,2 HAVING SUM(""t"".""amount"")>""a"".""max_income"" ORDER BY 1) SELECT ""t1"".""account_id"" FROM (""cte"" AS ""t1"") CROSS JOIN ""cte"" AS ""t2"" WHERE ""t1"".""account_id""=""t2"".""account_id"" AND PERIOD_DIFF(""t1"".""month"", ""t2"".""month"")=1 GROUP BY 1 ORDER BY 1"
7,"WITH ""temp"" AS (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""months"",SUM(""amount"") AS ""total"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",""months"") SELECT DISTINCT ""a"".""account_id"" FROM (""Accounts"" AS ""a"" JOIN ""temp"" AS ""t1"" ON ""t1"".""account_id""=""a"".""account_id"" AND ""t1"".""total"">""a"".""max_income"") JOIN ""temp"" AS ""t2"" ON ""t2"".""account_id""=""a"".""account_id"" AND ""t1"".""months""=""t2"".""months""-1 AND ""t2"".""total"">""a"".""max_income"" ORDER BY ""a"".""account_id"""
8,"WITH ""t1"" AS (SELECT ""account_id"",SUM(""amount"") AS ""total"",EXTRACT(MONTH FROM ""day"") AS ""month"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY 1,3), ""t2"" AS (SELECT ""t1"".""account_id"",""total"",""month"",LAG(""month"", 1) OVER (PARTITION BY ""account_id"" ORDER BY ""month"") AS ""num"" FROM ""t1"" JOIN ""Accounts"" AS ""a"" ON ""t1"".""account_id""=""a"".""account_id"" WHERE ""total"">""max_income"") SELECT DISTINCT ""t2"".""account_id"" FROM ""t2"" WHERE ""month""-""num""=1"
9,"WITH ""cte"" AS (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month"",SUM(""amount"") AS ""total"" FROM ""Transactions"" WHERE LOWER(TRIM(""type""))='creditor' GROUP BY 1,2), ""cte2"" AS (SELECT ""cte"".""account_id"",""month"",LAG(""month"", 1) OVER (PARTITION BY ""cte"".""account_id"" ORDER BY ""month"") AS ""prev_month"" FROM ""cte"" JOIN ""Accounts"" AS ""a"" ON ""cte"".""account_id""=""a"".""account_id"" WHERE ""total"">""max_income"") SELECT DISTINCT ""account_id"" FROM ""cte2"" WHERE ""month""-""prev_month""=1"
10,"WITH ""cte"" AS (SELECT ""a"".""account_id"",""a"".""yymm"" FROM (SELECT ""account_id"",TO_CHAR(""day"" - INTERVAL 'DAYOFMONTH(""day"")-1 DAY', 'YYYY-%m-%d') AS ""yymm"",SUM(""amount"") AS ""amount"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",TO_CHAR(""day"" - INTERVAL 'DAYOFMONTH(""day"")-1 DAY', 'YYYY-%m-%d')) AS ""a"" CROSS JOIN ""accounts"" AS ""b"" WHERE ""a"".""account_id""=""b"".""account_id"" AND ""a"".""amount"">""b"".""max_income"") SELECT DISTINCT ""c1"".""account_id"" FROM ""cte"" AS ""c1"" JOIN ""cte"" AS ""c2"" ON ""c1"".""account_id""=""c2"".""account_id"" AND ""c1"".""yymm"" + INTERVAL '1 MONTH'=""c2"".""yymm"""
11,"WITH ""cte"" AS (SELECT ""A"".""account_id"",EXTRACT(MONTH FROM ""t"".""day"") AS ""month"",SUM(""t"".""amount""),""A"".""max_income"" FROM ""Transactions"" AS ""t"" JOIN ""Accounts"" AS ""A"" ON ""A"".""account_id""=""t"".""account_id"" WHERE ""type"" LIKE 'Creditor' GROUP BY 1,2 HAVING SUM(""t"".""amount"")>""A"".""max_income"") SELECT DISTINCT ""account_id"" FROM (SELECT ""account_id"",""month"",LEAD(""month"") OVER (PARTITION BY ""account_id"" ORDER BY ""month"") AS ""next"" FROM ""cte"") AS ""temp"" WHERE ""month""+1=""next"""
12,"WITH ""cte"" AS (SELECT ""account_id"",SUM(""amount"") AS ""total_income"",EXTRACT(MONTH FROM ""day"") AS ""mon"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",EXTRACT(MONTH FROM ""day"")), ""cte1"" AS (SELECT ""Accounts"".""account_id"",""mon"" FROM ""cte"" JOIN ""Accounts"" USING (""account_id"") WHERE ""total_income"">""max_income"") SELECT DISTINCT ""cte1"".""account_id"" FROM ""cte1"" JOIN ""cte1"" AS ""tmp"" USING (""account_id"") WHERE ABS(""cte1"".""mon""-""tmp"".""mon"")=1"
13,"WITH ""cte1"" AS (SELECT DISTINCT ""z"".""transaction_id"",""z"".""account_id"",""m"",SUM(""amount"") OVER (PARTITION BY ""account_id"", ""m"") AS ""income"" FROM (SELECT ""transaction_id"",""account_id"",""amount"",EXTRACT(MONTH FROM ""day"") AS ""m"" FROM ""Transactions"" WHERE ""type""='Creditor') AS ""z"" ORDER BY ""account_id"",""m"") SELECT DISTINCT ""account_id"" FROM (SELECT ""transaction_id"",""account_id"",""m"",ABS(""m""-LEAD(""m"") OVER (PARTITION BY ""account_id"" ORDER BY ""m"")) AS ""diff"" FROM (SELECT ""transaction_id"",""c"".""account_id"",""m"",""income"",""max_income"" FROM ""cte1"" AS ""c"" JOIN ""Accounts"" AS ""A"" ON ""c"".""account_id""=""A"".""account_id"" WHERE ""income"">""max_income"") AS ""b"") AS ""v"" WHERE ""diff""=1 ORDER BY ""transaction_id"""
14,"WITH ""temp"" AS (SELECT ""a"".""account_id"",TO_CHAR(""a"".""day"", 'YYYY-%m') AS ""month"" FROM ""Transactions"" AS ""a"" JOIN ""Accounts"" AS ""b"" ON ""a"".""account_id""=""b"".""account_id"" GROUP BY ""a"".""account_id"",TO_CHAR(""a"".""day"", 'YYYY-%m') HAVING SUM(CASE WHEN ""a"".""type""='Creditor' THEN ""a"".""amount"" ELSE 0 END)>MAX(""b"".""max_income"")) SELECT DISTINCT ""account_id"" FROM ""temp"" WHERE ROW(""account_id"",TO_CHAR(DATE(CONCAT(""month"", '-01')) - INTERVAL '1 DAY', 'YYYY-%m')) IN (SELECT ""account_id"",""month"" FROM ""temp"")"
15,"WITH ""cte"" AS (SELECT ""t"".""account_id"",EXTRACT(YEAR FROM ""day"")*100+EXTRACT(MONTH FROM ""day"") AS ""yearmon"",SUM(CASE WHEN ""type""='Creditor' THEN ""amount"" END) AS ""total_income"",MAX(""a"".""max_income"") AS ""max_income"" FROM (""transactions"" AS ""t"") CROSS JOIN ""accounts"" AS ""a"" WHERE ""t"".""account_id""=""a"".""account_id"" GROUP BY 1,2 HAVING ""total_income"">""max_income"" ORDER BY ""a"".""account_id"") SELECT DISTINCT ""t1"".""account_id"" FROM (""cte"" AS ""t1"") CROSS JOIN ""cte"" AS ""t2"" WHERE ""t1"".""account_id""=""t2"".""account_id"" AND ""t1"".""yearmon""=""t2"".""yearmon""-1 ORDER BY ""t1"".""account_id"""
16,"WITH ""cte"" AS (SELECT ""t"".""account_id"",EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day"") AS ""month"",(CASE WHEN SUM(""amount"")>""a"".""max_income"" THEN 1 ELSE 0 END) AS ""exceed"" FROM ""transactions"" AS ""t"" JOIN ""accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""type""='Creditor' GROUP BY EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day""),""t"".""account_id"") SELECT DISTINCT ""c1"".""account_id"" FROM (""cte"" AS ""c1"") CROSS JOIN ""cte"" AS ""c2"" WHERE ""c1"".""account_id""=""c2"".""account_id"" AND ""c2"".""month""-""c1"".""month""=1 AND ""c1"".""exceed""=1 AND ""c2"".""exceed""=1"
17,"WITH ""t"" AS (WITH ""t"" AS (SELECT SUM(""amount"") AS ""tot"",EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day"") AS ""d"",""account_id"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day"") ORDER BY ""account_id"",""d"") SELECT ""t"".""account_id"",""t"".""d"" FROM ""t"" JOIN ""accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" AND ""t"".""tot"">""a"".""max_income"") SELECT DISTINCT ""a"".""account_id"" AS ""account_id"" FROM ""t"" AS ""a"" JOIN ""t"" AS ""b"" ON ""a"".""account_id""=""b"".""account_id"" AND ""b"".""d""=""a"".""d""+1"
18,"WITH ""cte"" AS (SELECT ""a"".""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month"",SUM(""amount"") AS ""monthly"",""a"".""max_income"" FROM ""accounts"" AS ""a"" JOIN ""transactions"" AS ""t"" ON ""a"".""account_id""=""t"".""account_id"" WHERE ""type""='Creditor' GROUP BY 1,2 HAVING ""monthly"">""a"".""max_income"" ORDER BY 1,2) SELECT DISTINCT ""c1"".""account_id"" FROM ""cte"" AS ""c1"" JOIN ""cte"" AS ""c2"" ON ""c1"".""account_id""=""c2"".""account_id"" AND ""c1"".""month""=""c2"".""month""+1"
19,"WITH ""temp"" AS (SELECT ""t"".""account_id"",TO_CHAR(""day"", 'YYYY%m') AS ""date"",SUM(""amount"") AS ""income"",""Accounts"".""max_income"" FROM ""Transactions"" AS ""t"" LEFT JOIN ""Accounts"" ON ""Accounts"".""account_id""=""t"".""account_id"" WHERE ""t"".""type""='Creditor' GROUP BY ""t"".""account_id"",TO_CHAR(""day"", 'YYYY%m') HAVING SUM(""amount"")>""Accounts"".""max_income"") SELECT ""t1"".""account_id"" FROM (""temp"" AS ""t1"") CROSS JOIN ""temp"" AS ""t2"" WHERE ""t1"".""account_id""=""t2"".""account_id"" AND PERIOD_DIFF(""t1"".""date"", ""t2"".""date"")=1 GROUP BY ""t1"".""account_id"" ORDER BY ""t1"".""account_id"""
20,"WITH ""temp"" AS (SELECT ""a"".""account_id"",TO_CHAR(""a"".""day"", 'YYYY%m') AS ""date"",SUM(""a"".""amount"") AS ""total_amount"",""b"".""max_income"" FROM ""transactions"" AS ""a"" JOIN ""accounts"" AS ""b"" ON ""a"".""account_id""=""b"".""account_id"" WHERE ""a"".""type""='Creditor' GROUP BY 1,2 HAVING SUM(""a"".""amount"")>""b"".""max_income"") SELECT ""t1"".""account_id"" FROM (""temp"" AS ""t1"") CROSS JOIN ""temp"" AS ""t2"" WHERE ""t1"".""account_id""=""t2"".""account_id"" AND PERIOD_DIFF(""t1"".""date"", ""t2"".""date"")=1 GROUP BY ""t1"".""account_id"" ORDER BY ""t1"".""account_id"""
21,"WITH ""suspicious_month"" AS (SELECT ""t"".""account_id"",LEFT(""t"".""day"", 7) AS ""month"",EXTRACT(MONTH FROM CONCAT(LEFT(""t"".""day"", 7), '-01'))-ROW_NUMBER() OVER (PARTITION BY ""t"".""account_id"" ORDER BY LEFT(""t"".""day"", 7)) AS ""number"" FROM ""transactions"" AS ""t"" JOIN ""accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""t"".""type""='Creditor' GROUP BY ""t"".""account_id"",LEFT(""t"".""day"", 7),""a"".""max_income"" HAVING SUM(""t"".""amount"")>""a"".""max_income"" ORDER BY ""t"".""account_id"",""month"") SELECT DISTINCT ""account_id"" FROM ""suspicious_month"" GROUP BY ""account_id"",""number"" HAVING COUNT(1)>1"
22,"WITH ""A"" AS (SELECT ""account_id"",TO_CHAR(""day"", 'YYYY%m') AS ""month"",SUM(""amount"") AS ""income"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY 1,2), ""B"" AS (SELECT ""a"".""account_id"",""month"",""income"",""max_income"" FROM ""A"" AS ""a"" JOIN ""Accounts"" AS ""b"" USING (""account_id"") WHERE ""max_income""<""income"") SELECT DISTINCT ""a"".""account_id"" FROM ""B"" AS ""a"" JOIN ""B"" AS ""b"" ON ""a"".""account_id""=""b"".""account_id"" AND PERIOD_DIFF(""b"".""month"", ""a"".""month"")=1 ORDER BY 1"
23,"WITH ""t1"" AS (SELECT ""account_id"",SUM(""amount"") AS ""total"",EXTRACT(MONTH FROM ""day"") AS ""month"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY 1,3), ""t2"" AS (SELECT ""t1"".""account_id"",""total"",""month"",LAG(""month"", 1) OVER (PARTITION BY ""account_id"" ORDER BY ""month"") AS ""num"" FROM ""t1"" JOIN ""Accounts"" AS ""a"" ON ""t1"".""account_id""=""a"".""account_id"" WHERE ""total"">""max_income"") SELECT DISTINCT ""t2"".""account_id"" FROM ""t2"" WHERE ""month""-""num""=1"
24,"WITH ""temp"" AS (SELECT ""t"".""account_id"",TO_CHAR(""day"", 'YYYY%m') AS ""date"",SUM(""amount"") AS ""income"",""accounts"".""max_income"" FROM ""transactions"" AS ""t"" LEFT JOIN ""accounts"" ON ""accounts"".""account_id""=""t"".""account_id"" WHERE ""t"".""type""='Creditor' GROUP BY ""t"".""account_id"",TO_CHAR(""day"", 'YYYY%m') HAVING SUM(""amount"")>""accounts"".""max_income"") SELECT ""t1"".""account_id"" FROM (""temp"" AS ""t1"") CROSS JOIN ""temp"" AS ""t2"" WHERE ""t1"".""account_id""=""t2"".""account_id"" AND PERIOD_DIFF(""t1"".""date"", ""t2"".""date"")=1 GROUP BY ""t1"".""account_id"" ORDER BY ""t1"".""account_id"""
25,"WITH ""t1"" AS (SELECT DISTINCT ""t"".""account_id"",""t"".""acct_month"" FROM (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""acct_month"",SUM(""amount"") AS ""monthly_income"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",""acct_month"") AS ""t"" JOIN ""accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""t"".""monthly_income"">""a"".""max_income""), ""t2"" AS (SELECT ""account_id"",""acct_month"",LAG(""acct_month"") OVER (PARTITION BY ""account_id"" ORDER BY ""acct_month"") AS ""prev_month"" FROM ""t1"") SELECT DISTINCT ""account_id"" FROM ""t2"" WHERE ""acct_month""-""prev_month""=1 ORDER BY ""account_id"""
26,"WITH ""cte"" AS (SELECT EXTRACT(MONTH FROM ""day"") AS ""mon"",""account_id"",SUM(""amount"") AS ""tot_income"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY EXTRACT(MONTH FROM ""day""),""account_id""), ""cte2"" AS (SELECT ""a"".""account_id"",""mon"",""tot_income"",""max_income"",""mon""-ROW_NUMBER() OVER (PARTITION BY ""a"".""account_id"" ORDER BY ""mon"") AS ""grp"" FROM ""cte"" AS ""c"" JOIN ""Accounts"" AS ""a"" ON ""c"".""account_id""=""a"".""account_id"" WHERE ""tot_income"">""max_income"") SELECT DISTINCT ""account_id"" FROM ""cte2"" GROUP BY ""grp"",""account_id"" HAVING COUNT(1)>1"
27,"WITH ""x"" AS (SELECT ""t"".""account_id"",EXTRACT(YEAR FROM ""t"".""day"")*12+EXTRACT(MONTH FROM ""t"".""day"") AS ""month"",SUM(""t"".""amount"")-""a"".""max_income"" AS ""exceed_income"" FROM ""transactions"" AS ""t"" JOIN ""accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""t"".""type""='Creditor' GROUP BY ""t"".""account_id"",EXTRACT(YEAR FROM ""t"".""day"")*12+EXTRACT(MONTH FROM ""t"".""day"")) SELECT DISTINCT ""x1"".""account_id"" FROM ""x"" AS ""x1"" LEFT JOIN ""x"" AS ""x2"" ON ""x1"".""account_id""=""x2"".""account_id"" AND ""x1"".""month""=""x2"".""month""-1 WHERE ""x1"".""exceed_income"">0 AND ""x2"".""exceed_income"">0"
28,"WITH ""trns"" AS (SELECT ""account_id"",SUM(""amount"") AS ""amt"",EXTRACT(YEAR_MONTH FROM ""day"") AS ""yearmonth"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",EXTRACT(YEAR_MONTH FROM ""day"")), ""trns2"" AS (SELECT ""t"".""account_id"",""amt"",""yearmonth"",(""yearmonth""-DENSE_RANK() OVER (PARTITION BY ""t"".""account_id"" ORDER BY ""yearmonth"")) AS ""rn"" FROM (""trns"" AS ""t"") CROSS JOIN ""accounts"" AS ""a"" WHERE ""t"".""account_id""=""a"".""account_id"" AND ""amt"">""max_income""), ""trns3"" AS (SELECT ""t"".""account_id"" AS ""account_id"" FROM ""trns2"" AS ""t"" GROUP BY ""account_id"",""rn"" HAVING COUNT(1)>1) SELECT DISTINCT ""account_id"" FROM ""trns3"""
29,"WITH ""income"" AS (SELECT ""account_id"",CONCAT(LEFT(""day"", 7), '-01') AS ""month"",SUM(CASE WHEN ""type""='Creditor' THEN ""amount"" ELSE 0 END) AS ""total_income"",""max_income"" FROM ""transactions"" JOIN ""accounts"" USING (""account_id"") GROUP BY 1,LEFT(""day"", 7) ORDER BY 1,2) SELECT DISTINCT ""i1"".""account_id"" FROM ""income"" AS ""i1"" JOIN ""income"" AS ""i2"" ON ""i1"".""account_id""=""i2"".""account_id"" AND TIMESTAMPDIFF(MONTH, ""i1"".""month"", ""i2"".""month"")=1 WHERE ""i1"".""total_income"">""i1"".""max_income"" AND ""i2"".""total_income"">""i2"".""max_income"""
30,"WITH ""cte"" AS (SELECT ""account_id"",SUM(""amount"") AS ""total"",""month"" FROM (SELECT ""account_id"",""amount"",EXTRACT(MONTH FROM ""day"") AS ""month"" FROM ""Transactions"" WHERE ""type""='Creditor') AS ""a"" GROUP BY ""account_id"",""month""), ""cte1"" AS (SELECT ""c"".""account_id"",""c"".""total"",""c"".""month"" FROM ""cte"" AS ""c"" JOIN ""Accounts"" AS ""a"" ON ""c"".""account_id""=""a"".""account_id"" WHERE ""c"".""total"">""a"".""max_income"") SELECT ""cc1"".""account_id"" FROM ""cte1"" AS ""cc1"" JOIN ""cte1"" AS ""cc2"" ON ""cc1"".""account_id""=""cc2"".""account_id"" AND ""cc2"".""month""-""cc1"".""month""=1 GROUP BY ""cc1"".""account_id"" HAVING COUNT(""cc1"".""month"")>=1"
31,"WITH ""CTE"" AS (SELECT ""t"".""account_id"",EXTRACT(MONTH FROM ""day"") AS ""day"",""max_income"" FROM ""Transactions"" AS ""t"" JOIN ""Accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""type""='Creditor' GROUP BY ""t"".""account_id"",EXTRACT(MONTH FROM ""day"") HAVING SUM(""t"".""amount"")>""a"".""max_income"") SELECT DISTINCT ""account_id"" FROM ""CTE"" WHERE ROW(""account_id"",""DAY""-1) IN (SELECT ""account_id"",""DAY"" FROM ""CTE"") OR ROW(""account_id"",""DAY""+1) IN (SELECT ""account_id"",""DAY"" FROM ""CTE"")"
32,"WITH ""cte"" AS (SELECT ""t"".""account_id"",SUM(""amount"") AS ""total_income"",TO_CHAR(""day"", '%m') AS ""month"",""a"".""max_income"" FROM ""transactions"" AS ""t"" LEFT JOIN ""accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""type""='creditor' GROUP BY ""month"",""t"".""account_id"" HAVING ""total_income"">""max_income"" ORDER BY 1,3) SELECT DISTINCT ""C1"".""account_id"" FROM ""CTE"" AS ""C1"" JOIN ""CTE"" AS ""C2"" ON ""C1"".""account_id""=""C2"".""account_id"" AND PERIOD_DIFF(""C1"".""month"", ""C2"".""month"")=1 ORDER BY 1"
33,"WITH ""temp"" AS (SELECT ""t"".""account_id"",EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day"") AS ""month"",(CASE WHEN SUM(""amount"")>""max_income"" THEN 1 ELSE 0 END) AS ""exceed"" FROM ""Transactions"" AS ""t"" JOIN ""Accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""type""='Creditor' GROUP BY 1,2) SELECT DISTINCT ""a"".""account_id"" FROM ""temp"" AS ""a"" JOIN ""temp"" AS ""b"" ON ""a"".""account_id""=""b"".""account_id"" AND ""a"".""exceed""=1 AND ""b"".""exceed""=1 AND ""b"".""month""-""a"".""month""=1"
34,"WITH ""CTE"" AS (SELECT ""T"".""account_id"",EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day"") AS ""month"",(CASE WHEN SUM(""amount"")>""A"".""max_income"" THEN 1 ELSE 0 END) AS ""exceed"" FROM ""transactions"" AS ""T"" JOIN ""accounts"" AS ""A"" ON ""T"".""account_id""=""A"".""account_id"" WHERE ""type""='Creditor' GROUP BY EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day""),""T"".""account_id"") SELECT DISTINCT ""C1"".""account_id"" FROM (""CTE"" AS ""C1"") CROSS JOIN ""CTE"" AS ""C2"" WHERE ""C1"".""account_id""=""C2"".""account_id"" AND ""C2"".""month""-""C1"".""month""=1 AND ""C1"".""exceed""=1 AND ""C2"".""exceed""=1"
35,"WITH ""cte"" AS (SELECT ""t"".""account_id"",TO_CHAR(""day"", '%m %y') AS ""month"",SUM(CASE WHEN ""type""='Creditor' THEN ""amount"" END) AS ""total_income"",""max_income"" FROM ""transactions"" AS ""t"" LEFT JOIN ""accounts"" AS ""a"" ON ""a"".""account_id""=""t"".""account_id"" GROUP BY ""t"".""account_id"",TO_CHAR(""day"", '%m %y')) SELECT DISTINCT ""cte1"".""account_id"" FROM ""cte"" AS ""cte1"" JOIN ""cte"" AS ""cte2"" ON ""cte1"".""account_id""=""cte2"".""account_id"" AND ""cte1"".""month""=""cte2"".""month""-1 WHERE ""cte1"".""total_income"">""cte1"".""max_income"" AND ""cte2"".""total_income"">""cte1"".""max_income"""
36,"WITH ""cte"" AS (SELECT ""account_id"",SUBSTRING(""day"", 1, 7) AS ""month"",SUM(CASE WHEN ""type""='Creditor' THEN ""amount"" END) AS ""totalincome"" FROM ""Transactions"" GROUP BY 1,2) SELECT DISTINCT ""c1"".""account_id"" FROM (""cte"" AS ""c1"" JOIN ""Accounts"" ON ""c1"".""account_id""=""Accounts"".""account_id"") JOIN ""cte"" AS ""c2"" ON ""c2"".""account_id""=""Accounts"".""account_id"" WHERE ""c1"".""totalincome"">""max_income"" AND ""c2"".""totalincome"">""max_income"" AND ABS(SUBSTRING(""c1"".""month"", 5, 7)-SUBSTRING(""c2"".""month"", 5, 7))=1"
37,"SELECT DISTINCT ""account_id"" FROM (SELECT ""t"".""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month"",SUM(""amount"") AS ""amt"",""max_income"",LAG(EXTRACT(MONTH FROM ""day"")) OVER (PARTITION BY ""t"".""account_id"" ORDER BY EXTRACT(MONTH FROM ""day"")) AS ""lg"" FROM ""transactions"" AS ""t"" LEFT JOIN ""accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""t"".""type""='Creditor' GROUP BY ""t"".""account_id"",EXTRACT(MONTH FROM ""day"") HAVING SUM(""amount"")>""max_income"") AS ""tmp"" WHERE ABS(""month""-""lg"")=1"
38,"WITH ""cte"" AS (SELECT ""t"".""account_id"",""t"".""month"" FROM (SELECT ""account_id"",TO_CHAR(""day"", 'YYYY%m') AS ""month"",SUM(""amount"") AS ""total"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY 1,2) AS ""t"" JOIN ""accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" AND ""t"".""total"">""a"".""max_income"") SELECT DISTINCT ""t1"".""account_id"" FROM ""cte"" AS ""t1"" JOIN ""cte"" AS ""t2"" ON ""t1"".""account_id""=""t2"".""account_id"" AND ""t1"".""month""=""t2"".""month""-1"
39,"WITH ""t"" AS (SELECT ""account_id"",""transaction_id"",SUM(""amount"") AS ""month_income"",EXTRACT(MONTH FROM ""day"") AS ""month"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY 1,4) SELECT DISTINCT ""ac"".""account_id"" FROM (""accounts"" AS ""ac"" LEFT JOIN ""t"" AS ""t1"" ON ""ac"".""account_id""=""t1"".""account_id"") LEFT JOIN ""t"" AS ""t2"" ON ""t1"".""account_id""=""t2"".""account_id"" AND ""t1"".""month""+1=""t2"".""month"" WHERE ""t1"".""month_income"">""ac"".""max_income"" AND ""t2"".""month_income"">""ac"".""max_income"" ORDER BY ""t1"".""transaction_id"""
40,"WITH ""agg"" AS (SELECT ""t"".""account_id"",TO_CHAR(""day"", 'YYYY%m') AS ""month"",CASE WHEN SUM(""t"".""amount"")>MAX(""max_income"") THEN 'yes' ELSE 'no' END AS ""sus"" FROM ""transactions"" AS ""t"" JOIN ""accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" AND ""t"".""type""='Creditor' GROUP BY 1,2) SELECT DISTINCT ""l"".""account_id"" FROM ""agg"" AS ""l"" JOIN ""agg"" AS ""r"" ON ""l"".""account_id""=""r"".""account_id"" AND ""l"".""sus""='yes' AND ""r"".""sus""='yes' AND PERIOD_DIFF(""l"".""month"", ""r"".""month"")=1"
41,"WITH ""summary"" AS (SELECT ""t"".""account_id"",SUM(""t"".""amount"") AS ""total_income"",EXTRACT(YEAR FROM ""day"") AS ""Y"",EXTRACT(MONTH FROM ""day"") AS ""M"",""a"".""max_income"" FROM (""Transactions"" AS ""t"") CROSS JOIN ""Accounts"" AS ""a"" WHERE ""a"".""account_id""=""t"".""account_id"" AND ""type""='Creditor' GROUP BY ""t"".""account_id"",EXTRACT(YEAR FROM ""day""),EXTRACT(MONTH FROM ""day"") HAVING SUM(""t"".""amount"")>""a"".""max_income"" ORDER BY ""t"".""transaction_id"") SELECT DISTINCT ""s1"".""account_id"" FROM ""summary"" AS ""s1"" JOIN ""summary"" AS ""s2"" ON ""s1"".""account_id""=""s2"".""account_id"" WHERE (""s1"".""M""+1=""s2"".""M"" AND ""s1"".""Y""=""s2"".""Y"") OR (""s1"".""M""=12 AND ""s2"".""M""=1 AND ""s1"".""Y""+1=""s2"".""Y"")"
42,"WITH ""cte"" AS (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""cur_month"",SUM(""amount"") AS ""total_income"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",EXTRACT(MONTH FROM ""day"")), ""cte2"" AS (SELECT ""c"".""account_id"",""cur_month"",""total_income"",LEAD(""cur_month"") OVER (PARTITION BY ""account_id"" ORDER BY ""cur_month"") AS ""next_month"",""max_income"" FROM ""cte"" AS ""c"" JOIN ""Accounts"" AS ""a"" ON ""c"".""account_id""=""a"".""account_id"" WHERE ""total_income"">""max_income"") SELECT DISTINCT ""account_id"" FROM ""cte2"" WHERE ""cur_month""+1=""next_month"""
43,"SELECT DISTINCT ""account_id"" FROM (SELECT ""account_id"",""mon""-ROW_NUMBER() OVER (PARTITION BY ""account_id"") AS ""grp"" FROM (SELECT ""a"".""account_id"",EXTRACT(MONTH FROM ""t"".""day"") AS ""mon"",SUM(CASE WHEN ""t"".""type""='Creditor' THEN ""t"".""amount"" ELSE 0 END) AS ""mon_ttl_income"" FROM ""transactions"" AS ""t"" JOIN ""accounts"" AS ""a"" ON ""a"".""account_id""=""t"".""account_id"" GROUP BY 1,2 HAVING ""mon_ttl_income"">MAX(""a"".""max_income"") ORDER BY 1,2) AS ""tmp"") AS ""tmp2"" GROUP BY ""account_id"",""grp"" HAVING COUNT(1)>=2"
44,"SELECT DISTINCT ""c"".""account_id"" FROM (SELECT ""a"".""account_id"",""a"".""month"",LAG(""month"") OVER (PARTITION BY ""account_id"" ORDER BY ""month"") AS ""lg"" FROM (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month"",SUM(""amount"") AS ""tot"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY 1,2) AS ""a"" JOIN ""Accounts"" AS ""b"" ON ""a"".""account_id""=""b"".""account_id"" WHERE ""a"".""tot"">""b"".""max_income"") AS ""c"" WHERE ABS(""c"".""month""-""c"".""lg"")=1"
45,"WITH ""A"" AS (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month"",SUM(""amount"") AS ""income"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY 1,2), ""B"" AS (SELECT ""a"".""account_id"",""month"",""income"",""max_income"" FROM ""A"" AS ""a"" JOIN ""Accounts"" AS ""b"" USING (""account_id"") WHERE ""max_income""<""income"") SELECT DISTINCT ""a"".""account_id"" FROM ""B"" AS ""a"" JOIN ""B"" AS ""b"" ON ""a"".""account_id""=""b"".""account_id"" AND ""a"".""month""=""b"".""month""-1 ORDER BY 1"
46,"WITH ""tmp"" AS (SELECT ""transactions"".""account_id"",SUM(""amount"") AS ""total"",CONCAT(LEFT(""day"", 7), '-01') AS ""month"",""accounts"".""max_income"" FROM ""transactions"" JOIN ""accounts"" ON ""transactions"".""account_id""=""accounts"".""account_id"" WHERE ""type""='Creditor' GROUP BY ""transactions"".""account_id"",LEFT(""day"", 7)) SELECT DISTINCT ""i1"".""account_id"" FROM ""tmp"" AS ""i1"" JOIN ""tmp"" AS ""i2"" ON ""i1"".""account_id""=""i2"".""account_id"" AND TIMESTAMPDIFF(MONTH, ""i1"".""month"", ""i2"".""month"")=1 WHERE ""i1"".""total"">""i1"".""max_income"" AND ""i2"".""total"">""i2"".""max_income"""
47,"WITH ""CET"" AS (SELECT ""T"".""account_id"",EXTRACT(MONTH FROM ""day"") AS ""mos"",""max_income"" FROM ""Transactions"" AS ""T"" JOIN ""Accounts"" AS ""A"" ON ""T"".""account_id""=""A"".""account_id"" WHERE ""type""='Creditor' GROUP BY ""account_id"",EXTRACT(MONTH FROM ""day"") HAVING SUM(""amount"")>""A"".""max_income"") SELECT DISTINCT ""account_id"" FROM ""CET"" WHERE ROW(""account_id"",""mos""-1) IN (SELECT ""account_id"",""mos"" FROM ""CET"") OR ROW(""account_id"",""mos""+1) IN (SELECT ""account_id"",""mos"" FROM ""CET"")"
48,"SELECT DISTINCT ""tb"".""account_id"" AS ""account_id"" FROM (((SELECT DISTINCT ""account_id"",EXTRACT(YEAR_MONTH FROM ""day"") AS ""year_m"",SUM(""amount"") AS ""income"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY 1,2) AS ""tb"" LEFT JOIN (SELECT DISTINCT ""account_id"",EXTRACT(YEAR_MONTH FROM ""day"") AS ""year_m"",SUM(""amount"") AS ""income"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY 1,2) AS ""tb1"" ON ""tb1"".""year_m""-1=""tb"".""year_m"" AND ""tb1"".""account_id""=""tb"".""account_id"") LEFT JOIN (SELECT DISTINCT ""account_id"",EXTRACT(YEAR_MONTH FROM ""day"") AS ""year_m"",SUM(""amount"") AS ""income"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY 1,2) AS ""tb2"" ON ""tb1"".""year_m""+1=""tb"".""year_m"" AND ""tb1"".""account_id""=""tb"".""account_id"") JOIN ""accounts"" AS ""a"" ON ""tb"".""account_id""=""a"".""account_id"" WHERE ""tb"".""income"">""a"".""max_income"" AND (""tb1"".""income"">""a"".""max_income"" OR ""tb2"".""income"">""a"".""max_income"") ORDER BY 1"
49,"WITH ""cte"" AS (SELECT ""Transactions"".""account_id"",""type"",""day"",SUM(""amount"") AS ""totalincome"",""max_income"" FROM ""Transactions"" JOIN ""Accounts"" ON ""Transactions"".""account_id""=""Accounts"".""account_id"" WHERE ""type""='Creditor' GROUP BY ""account_id"",EXTRACT(MONTH FROM ""day"")) SELECT DISTINCT ""c1"".""account_id"" FROM ""cte"" AS ""c1"" LEFT JOIN ""cte"" AS ""c2"" ON ""c1"".""account_id""=""c2"".""account_id"" AND EXTRACT(MONTH FROM ""c1"".""day"")=EXTRACT(MONTH FROM ""c2"".""day"")-1 WHERE ""c1"".""totalincome"">""c1"".""max_income"" AND ""c2"".""totalincome"">""c2"".""max_income"""
50,"WITH ""cte"" AS (SELECT ""t"".""account_id"",TO_CHAR(""day"", '%m %y') AS ""month"",SUM(CASE WHEN ""type""='Creditor' THEN ""amount"" END) AS ""total_income"",""max_income"" FROM ""transactions"" AS ""t"" LEFT JOIN ""accounts"" AS ""a"" ON ""a"".""account_id""=""t"".""account_id"" GROUP BY ""t"".""account_id"",TO_CHAR(""day"", '%m %y')) SELECT DISTINCT ""cte1"".""account_id"" FROM ""cte"" AS ""cte1"" JOIN ""cte"" AS ""cte2"" ON ""cte1"".""account_id""=""cte2"".""account_id"" AND ""cte1"".""month""=""cte2"".""month""-1 WHERE ""cte1"".""total_income"">""cte1"".""max_income"" AND ""cte2"".""total_income"">""cte1"".""max_income"""
51,"WITH ""cte1"" AS (SELECT ""account_id"",EXTRACT(YEAR_MONTH FROM ""day"") AS ""month"",SUM(""amount"") AS ""total"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",EXTRACT(YEAR_MONTH FROM ""day"")), ""cte2"" AS (SELECT ""c1"".""account_id"",""c1"".""total"",""c2"".""total"" AS ""next_total"" FROM ""cte1"" AS ""c1"" JOIN ""cte1"" AS ""c2"" ON ""c1"".""account_id""=""c2"".""account_id"" AND PERIOD_DIFF(""c2"".""month"", ""c1"".""month"")=1) SELECT DISTINCT ""account_id"" FROM ""accounts"" NATURAL CROSS JOIN ""cte2"" WHERE ""total"">""max_income"" AND ""next_total"">""max_income"" ORDER BY 1"
52,"WITH ""base"" AS (SELECT EXTRACT(MONTH FROM ""day"") AS ""month"",""account_id"",SUM(""amount"") AS ""monthly_income"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY 1,2) SELECT DISTINCT ""b1"".""account_id"" FROM (""base"" AS ""b1"" JOIN ""base"" AS ""b2"" ON ""b1"".""month""=""b2"".""month""+1 AND ""b1"".""account_id""=""b2"".""account_id"") JOIN ""accounts"" AS ""a"" ON ""b1"".""account_id""=""a"".""account_id"" WHERE ""b1"".""monthly_income"">""a"".""max_income"" AND ""b2"".""monthly_income"">""a"".""max_income"" ORDER BY 1"
53,"WITH ""cte"" AS (SELECT ""account_id"",""month_day"",SUM(""amount"") AS ""tot_amt"" FROM (SELECT ""account_id"",""day"",EXTRACT(MONTH FROM ""day"") AS ""month_day"",""amount"" FROM ""transactions"" WHERE ""type""='Creditor') AS ""x"" GROUP BY ""account_id"",""month_day""), ""cte2"" AS (SELECT ""account_id"",""max_income"",""tot_amt"",""month_day"",CASE WHEN ""tot_amt"">""max_income"" THEN 1 ELSE 0 END AS ""exce_in"" FROM (SELECT ""t1"".""account_id"",""month_day"",""tot_amt"",""t2"".""max_income"" FROM ""cte"" AS ""t1"" JOIN ""accounts"" AS ""t2"" ON ""t1"".""account_id""=""t2"".""account_id"") AS ""x"") SELECT DISTINCT ""account_id"" FROM (SELECT ""account_id"",""exce_in"",""month_day""-""rnk"" AS ""consec"" FROM (SELECT ""account_id"",""month_day"",RANK() OVER (PARTITION BY ""account_id"" ORDER BY ""month_day"") AS ""rnk"",""exce_in"" FROM ""cte2"" WHERE ""exce_in""=1) AS ""x"") AS ""y"" GROUP BY ""account_id"",""consec"" HAVING SUM(""exce_in"")>=2"
54,"WITH ""cte"" AS (SELECT ""a"".""account_id"",EXTRACT(YEAR FROM ""day"") AS ""year"",EXTRACT(MONTH FROM ""day"") AS ""month"",SUM(""t"".""amount"") AS ""income"",""a"".""max_income"" FROM ""Accounts"" AS ""a"" JOIN ""Transactions"" AS ""t"" ON ""a"".""account_id""=""t"".""account_id"" WHERE ""t"".""type""='Creditor' GROUP BY ""a"".""account_id"",""year"",""month"") SELECT DISTINCT ""account_id"" FROM (SELECT ""c1"".*,""c2"".""income"" AS ""next_income"" FROM ""cte"" AS ""c1"" JOIN ""cte"" AS ""c2"" ON ""c1"".""account_id""=""c2"".""account_id"" AND ""c1"".""year""=""c2"".""year"" AND ""c2"".""month""-""c1"".""month""=1) AS ""t"" WHERE ""t"".""income"">""t"".""max_income"" AND ""t"".""next_income"">""t"".""max_income"" ORDER BY ""account_id"""
55,"WITH ""totalincome"" AS (SELECT ""t"".""account_id"",TO_CHAR(""day"", 'YYYY%m') AS ""ym"" FROM ""transactions"" AS ""t"" JOIN ""accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" GROUP BY 1,2 HAVING SUM(CASE WHEN ""type""='Creditor' THEN ""amount"" ELSE 0 END)>MAX(""max_income"")) SELECT DISTINCT ""t1"".""account_id"" FROM (""totalincome"" AS ""t1"") CROSS JOIN ""totalincome"" AS ""t2"" WHERE ""t2"".""ym""-""t1"".""ym""=1 AND ""t1"".""account_id""=""t2"".""account_id"" GROUP BY ""t1"".""account_id"" HAVING COUNT(""t1"".""account_id"")>=1 ORDER BY ""t1"".""account_id"""
56,"WITH ""cte"" AS (SELECT ""t1"".""account_id"",""t1"".""transaction_year"",""t1"".""transaction_month"",CASE WHEN ""t1"".""total_income"">""t2"".""max_income"" THEN 'Yes' ELSE 'No' END AS ""is_suspicious"" FROM (SELECT ""account_id"",EXTRACT(YEAR FROM ""day"") AS ""transaction_year"",EXTRACT(MONTH FROM ""day"") AS ""transaction_month"",SUM(CASE WHEN ""type""='Creditor' THEN ""amount"" ELSE 0 END) AS ""total_income"" FROM ""Transactions"" GROUP BY ""account_id"",EXTRACT(YEAR FROM ""day""),EXTRACT(MONTH FROM ""day"")) AS ""t1"" JOIN ""Accounts"" AS ""t2"" ON ""t1"".""account_id""=""t2"".""account_id"") SELECT DISTINCT ""c1"".""account_id"" FROM (""cte"" AS ""c1"") CROSS JOIN ""cte"" AS ""c2"" WHERE ""c1"".""account_id""=""c2"".""account_id"" AND ((""c1"".""transaction_year""=""c2"".""transaction_year"" AND ""c1"".""transaction_month""=""c2"".""transaction_month""-1) OR (""c1"".""transaction_year""=""c2"".""transaction_year""-1 AND ""c1"".""transaction_month""=12 AND ""c2"".""transaction_month""=1)) AND ""c1"".""is_suspicious""='Yes' AND ""c2"".""is_suspicious""='Yes'"
57,"WITH ""credits"" AS (SELECT ""account_id"",TO_CHAR(""day"", 'YYYY-%m') AS ""month"",SUM(""amount"") AS ""amount"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",TO_CHAR(""day"", 'YYYY-%m')), ""next_month_credits"" AS (SELECT ""account_id"",""month"" AS ""current_month"",""amount"" AS ""current_amount"",LEAD(""month"") OVER (PARTITION BY ""account_id"" ORDER BY ""month"") AS ""next_month"",LEAD(""amount"") OVER (PARTITION BY ""account_id"" ORDER BY ""month"") AS ""next_amount"" FROM ""credits"") SELECT DISTINCT (""account_id"") FROM ""next_month_credits"" LEFT JOIN ""Accounts"" USING (""account_id"") WHERE ""current_amount"">""max_income"" AND ""next_amount"">""max_income"" AND TIMESTAMPDIFF(MONTH, CONCAT(""current_month"", '-01'), CONCAT(""next_month"", '-01'))=1"
58,"WITH ""cte"" AS (SELECT ""t"".""account_id"",EXTRACT(YEAR FROM ""day"")*100+EXTRACT(MONTH FROM ""day"") AS ""yearmon"",SUM(CASE WHEN ""type""='Creditor' THEN ""amount"" END) AS ""total_income"",MAX(""a"".""max_income"") AS ""max_income"" FROM (""transactions"" AS ""t"") CROSS JOIN ""accounts"" AS ""a"" WHERE ""t"".""account_id""=""a"".""account_id"" GROUP BY 1,2 HAVING ""total_income"">""max_income"" ORDER BY ""a"".""account_id"") SELECT DISTINCT ""t1"".""account_id"" FROM (""cte"" AS ""t1"") CROSS JOIN ""cte"" AS ""t2"" WHERE ""t1"".""account_id""=""t2"".""account_id"" AND ""t1"".""yearmon""=""t2"".""yearmon""-1 ORDER BY ""t1"".""account_id"""
59,"SELECT ""t1"".""account_id"" FROM (SELECT ""t"".""account_id"",TO_CHAR(""day"", 'YYYY%m') AS ""date"",SUM(""amount"") AS ""income"",""Accounts"".""max_income"" FROM ""Transactions"" AS ""t"" LEFT JOIN ""Accounts"" ON ""Accounts"".""account_id""=""t"".""account_id"" WHERE ""t"".""type""='Creditor' GROUP BY ""t"".""account_id"",TO_CHAR(""day"", 'YYYY%m') HAVING SUM(""amount"")>""Accounts"".""max_income"") AS ""t1"" CROSS, (SELECT ""t"".""account_id"",TO_CHAR(""day"", 'YYYY%m') AS ""date"",SUM(""amount"") AS ""income"",""Accounts"".""max_income"" FROM ""Transactions"" AS ""t"" LEFT JOIN ""Accounts"" ON ""Accounts"".""account_id""=""t"".""account_id"" WHERE ""t"".""type""='Creditor' GROUP BY ""t"".""account_id"",TO_CHAR(""day"", 'YYYY%m') HAVING SUM(""amount"")>""Accounts"".""max_income"") AS ""t2"" WHERE ""t1"".""account_id""=""t2"".""account_id"" AND PERIOD_DIFF(""t1"".""date"", ""t2"".""date"")=1 GROUP BY ""t1"".""account_id"" ORDER BY ""t1"".""account_id"""
60,"WITH ""CTE1"" AS (SELECT ""account_id"",SUM(""amount"") AS ""total"",SUBSTR(""day"", 1, 7) AS ""month"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",SUBSTR(""day"", 1, 7)), ""CTE2"" AS (SELECT ""CTE1"".""account_id"",CONCAT(""month"", '-01') AS ""month"",""total"",""max_income"" FROM ""CTE1"" JOIN ""Accounts"" ON ""CTE1"".""account_id""=""Accounts"".""account_id"" HAVING ""total"">""max_income"") SELECT DISTINCT ""a"".""account_id"" FROM (""CTE2"" AS ""A"") CROSS JOIN ""CTE2"" AS ""B"" WHERE ""a"".""account_id""=""b"".""account_id"" AND ""a"".""month""=""b"".""month"" + INTERVAL '1 MONTH' ORDER BY ""account_id"""
61,"WITH ""temp"" AS (SELECT ""t"".""account_id"",TO_CHAR(""day"", 'YYYY-%m') AS ""y_m"",EXTRACT(MONTH FROM ""day"") AS ""m"",SUM(""amount"") AS ""tot_cred"",""max_income"" FROM ""transactions"" AS ""t"" JOIN ""accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""type""='Creditor' GROUP BY 1,2) SELECT DISTINCT ""t1"".""account_id"" FROM ""temp"" AS ""t1"" JOIN ""temp"" AS ""t2"" ON ""t1"".""account_id""=""t2"".""account_id"" AND ""t1"".""m""=""t2"".""m""+1 WHERE ""t1"".""tot_cred"">""t1"".""max_income"" AND ""t2"".""tot_cred"">""t2"".""max_income"""
62,"WITH ""cte"" AS (SELECT ""t"".""account_id"",SUM(""amount"") AS ""income"",EXTRACT(MONTH FROM ""day"") AS ""d"",""max_income"" FROM ""transactions"" AS ""t"" JOIN ""accounts"" AS ""a"" USING (""account_id"") WHERE ""type""='creditor' GROUP BY 1,3 HAVING ""income"">""max_income"") SELECT ""a"".""account_id"" FROM ""cte"" AS ""a"" JOIN ""cte"" AS ""b"" USING (""account_id"") WHERE ""a"".""d""=""b"".""d""+1 OR ""a"".""d""=""b"".""d""-1 GROUP BY 1 ORDER BY 1"
63,"WITH ""tb"" AS (SELECT ""account_id"",""amount"",EXTRACT(MONTH FROM ""day"") AS ""dt"" FROM ""transactions"" WHERE ""type""='Creditor'), ""tb2"" AS (SELECT ""account_id"",SUM(""amount"") AS ""sm"",""dt"" FROM ""tb"" GROUP BY ""account_id"",""dt"") SELECT DISTINCT ""a"".""account_id"" FROM ((""tb2"" AS ""a"") CROSS JOIN ""tb2"" AS ""b"") CROSS JOIN ""accounts"" AS ""c"" WHERE ""a"".""dt""-""b"".""dt""=1 AND ""a"".""account_id""=""b"".""account_id"" AND ""a"".""account_id""=""c"".""account_id"" AND ""b"".""account_id""=""c"".""account_id"" AND ""a"".""sm"">""c"".""max_income"" AND ""b"".""sm"">""c"".""max_income"""
64,"WITH ""cte"" AS (SELECT ""t"".""account_id"",EXTRACT(YEAR FROM ""day"")*100+EXTRACT(MONTH FROM ""day"") AS ""yearmon"",SUM(CASE WHEN ""type""='Creditor' THEN ""amount"" END) AS ""total_income"",MAX(""a"".""max_income"") AS ""max_income"" FROM (""transactions"" AS ""t"") CROSS JOIN ""accounts"" AS ""a"" WHERE ""t"".""account_id""=""a"".""account_id"" GROUP BY 1,2 HAVING ""total_income"">""max_income"" ORDER BY ""a"".""account_id"") SELECT DISTINCT ""t1"".""account_id"" FROM (""cte"" AS ""t1"") CROSS JOIN ""cte"" AS ""t2"" WHERE ""t1"".""account_id""=""t2"".""account_id"" AND ""t1"".""yearmon""=""t2"".""yearmon""-1 ORDER BY ""t1"".""account_id"""
65,"WITH ""cte"" AS (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""mon"",SUM(""amount"") AS ""tot"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",EXTRACT(MONTH FROM ""day"")), ""cte1"" AS (SELECT ""a"".""account_id"",""tot"",""mon"",LAG(""mon"", 1) OVER (PARTITION BY ""a"".""account_id"" ORDER BY ""mon"") AS ""prev_mon"" FROM ""cte"" AS ""a"" JOIN ""Accounts"" AS ""b"" ON ""a"".""account_id""=""b"".""account_id"" WHERE ""tot"">""max_income"") SELECT DISTINCT ""account_id"" FROM ""cte1"" WHERE ""mon""-""prev_mon""=1"
66,"WITH ""cte"" AS (SELECT ""t"".""account_id"",CASE WHEN EXTRACT(MONTH FROM ""t"".""day"")<10 THEN CONCAT(EXTRACT(YEAR FROM ""t"".""day""), '-0', EXTRACT(MONTH FROM ""t"".""day""), '-01') ELSE CONCAT(EXTRACT(YEAR FROM ""t"".""day""), '-', EXTRACT(MONTH FROM ""t"".""day""), '-01') END AS ""month"",SUM(""t"".""amount"") AS ""amount"",CONCAT(EXTRACT(YEAR FROM ""t"".""day""), '-', EXTRACT(MONTH FROM ""t"".""day""), '-01') - INTERVAL '1 MONTH' AS ""prevmonth"" FROM ""Transactions"" AS ""t"" WHERE ""t"".""type""='Creditor' GROUP BY 1,2), ""cte2"" AS (SELECT ""c"".""account_id"",""c"".""month"",""c"".""amount"",""c"".""prevmonth"",COALESCE(""c2"".""amount"", 0) AS ""prevmonthamnt"",CASE WHEN ""c"".""amount"">""a"".""max_income"" AND COALESCE(""c2"".""amount"", 0)>""a"".""max_income"" THEN 1 ELSE 0 END AS ""suspicious"" FROM (""cte"" AS ""c"" LEFT JOIN ""cte"" AS ""c2"" ON ""c"".""account_id""=""c2"".""account_id"" AND ""c"".""prevmonth""=""c2"".""month"") LEFT JOIN ""Accounts"" AS ""a"" ON ""c"".""account_id""=""a"".""account_id"") SELECT ""account_id"" FROM ""cte2"" GROUP BY 1 HAVING SUM(""suspicious"")>0"
67,"WITH ""cte"" AS (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month"",SUM(""amount"") AS ""total_amount"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY 1,2), ""sus"" AS (SELECT ""cte"".* FROM ""cte"" JOIN ""accounts"" AS ""t"" ON ""t"".""account_id""=""cte"".""account_id"" WHERE ""t"".""max_income""<""cte"".""total_amount""), ""cte_rank"" AS (SELECT ""account_id"",""month"",ROW_NUMBER() OVER (PARTITION BY ""account_id"" ORDER BY ""month"") AS ""drk"",""month""-ROW_NUMBER() OVER (PARTITION BY ""account_id"" ORDER BY ""month"") AS ""grp"" FROM ""sus"") SELECT DISTINCT ""account_id"" FROM ""cte_rank"" GROUP BY 1,""grp"" HAVING COUNT(1)>1 ORDER BY 1"
68,"WITH ""income"" AS (SELECT ""account_id"",CONCAT(LEFT(""day"", 7), '-01') AS ""month"",SUM(CASE WHEN ""type""='Creditor' THEN ""amount"" ELSE 0 END) AS ""total_income"",""max_income"" FROM ""transactions"" JOIN ""accounts"" USING (""account_id"") GROUP BY 1,LEFT(""day"", 7) ORDER BY 1,2) SELECT DISTINCT ""i1"".""account_id"" FROM ""income"" AS ""i1"" JOIN ""income"" AS ""i2"" ON ""i1"".""account_id""=""i2"".""account_id"" AND TIMESTAMPDIFF(MONTH, ""i1"".""month"", ""i2"".""month"")=1 WHERE ""i1"".""total_income"">""i1"".""max_income"" AND ""i2"".""total_income"">""i2"".""max_income"""
69,"WITH ""CTE"" AS (SELECT ""account_id"",""day"",SUM(""amount"") AS ""amount"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",TO_CHAR(""day"", 'YYYY-%m') ORDER BY ""account_id"") SELECT DISTINCT ""tab"".""account_id"" FROM (SELECT ""t1"".""account_id"",TO_CHAR(""t1"".""day"", 'YYYY-%m') AS ""t1Date"",""t1"".""amount"" AS ""t1amount"",TO_CHAR(""t2"".""day"", 'YYYY-%m') AS ""t2Date"",""t2"".""amount"" AS ""t2amount"" FROM ""CTE"" AS ""t1"" JOIN ""CTE"" AS ""t2"" ON (""t1"".""account_id""=""t2"".""account_id"") AND (TO_CHAR(""t2"".""day"", 'YYYY-%m')=TO_CHAR(""t1"".""day"" + INTERVAL '1 MONTH', 'YYYY-%m'))) AS ""tab"" JOIN ""accounts"" ON ""accounts"".""account_id""=""tab"".""account_id"" WHERE (""tab"".""t1amount"">""accounts"".""max_income"") AND (""tab"".""t2amount"">""accounts"".""max_income"")"
70,"SELECT DISTINCT ""acct_id"" AS ""account_id"" FROM (SELECT CASE WHEN (""month""+1)=LEAD(""month"") OVER (PARTITION BY ""account_id"" ORDER BY ""account_id"",""month"") AND ""frd1""='Yes' AND ""month"" AND ""frd1""=LEAD(""frd1"") OVER (PARTITION BY ""account_id"" ORDER BY ""account_id"",""month"") THEN ""account_id"" END AS ""acct_id"" FROM (SELECT ""t"".""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month"",CASE WHEN COALESCE(SUM(CASE WHEN ""type""='Creditor' THEN ""amount"" END), 0)>""max_income"" THEN 'Yes' ELSE 'No' END AS ""frd1"" FROM ""transactions"" AS ""t"" JOIN ""accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" GROUP BY 1,2 ORDER BY 1,2) AS ""a"") AS ""b"" WHERE ""acct_id"" IS NOT NULL"
71,"WITH ""M"" AS (SELECT ""account_id"",SUM(""amount"") AS ""income"",TO_CHAR(""day"", '%m,%y') AS ""month"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",LEFT(""day"", 7)) SELECT DISTINCT ""A"".""account_id"" FROM (""M"" AS ""M1"" JOIN ""M"" AS ""M2"" ON ""M1"".""month""=""M2"".""month""+1 AND ""M1"".""account_id""=""M2"".""account_id"") JOIN ""Accounts"" AS ""A"" ON ""A"".""account_id""=""M1"".""account_id"" AND ""M1"".""income"">""A"".""max_income"" AND ""M2"".""income"">""A"".""max_income"""
72,"WITH ""cte"" AS (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""Month1"",EXTRACT(YEAR FROM ""day"") AS ""Year1"",SUM(""amount"") AS ""total_income"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",""Year1"",""Month1""), ""cte2"" AS (SELECT ""cte"".""account_id"",""cte"".""Month1"",""cte"".""Year1"",""cte"".""total_income"",""max_income"",(CASE WHEN ""total_income"">""max_income"" THEN 1 ELSE 0 END) AS ""Flag"" FROM ""cte"" JOIN ""Accounts"" AS ""a"" ON ""cte"".""account_id""=""a"".""account_id"" ORDER BY ""account_id"",""Year1"",""Month1"") SELECT DISTINCT ""c1"".""account_id"" FROM ""cte2"" AS ""c1"" JOIN ""cte2"" AS ""c2"" ON ""c1"".""account_id""=""c2"".""account_id"" AND ((""c1"".""Month1""=""c2"".""Month1""-1 AND ""c1"".""Year1""=""c2"".""Year1"") OR (""c1"".""Month1""=12 AND ""c2"".""Month1""=1 AND ""c1"".""Year1""=""c2"".""Year1""-1)) WHERE ""c1"".""Flag""=1 AND ""c2"".""Flag""=1 ORDER BY ""account_id"""
73,"WITH ""temp"" AS (SELECT ""t"".""account_id"",TO_CHAR(""day"", 'YYYY%m') AS ""date"",SUM(""amount"") AS ""income"",""Accounts"".""max_income"" FROM ""Transactions"" AS ""t"" LEFT JOIN ""Accounts"" ON ""Accounts"".""account_id""=""t"".""account_id"" WHERE ""t"".""type""='Creditor' GROUP BY ""t"".""account_id"",TO_CHAR(""day"", 'YYYY%m') HAVING SUM(""amount"")>""Accounts"".""max_income"") SELECT ""t1"".""account_id"" FROM (""temp"" AS ""t1"") CROSS JOIN ""temp"" AS ""t2"" WHERE ""t1"".""account_id""=""t2"".""account_id"" AND PERIOD_DIFF(""t1"".""date"", ""t2"".""date"")=1 GROUP BY ""t1"".""account_id"" ORDER BY ""t1"".""account_id"""
74,"SELECT ""c"".""account_id"" FROM (SELECT ""a"".""account_id"",""a"".""yymm"" AS ""current_month"",""a"".""total_income"",LEAD(""a"".""yymm"") OVER (PARTITION BY ""a"".""account_id"" ORDER BY ""a"".""yymm"") AS ""nex_month"",LEAD(""a"".""total_income"") OVER (PARTITION BY ""a"".""account_id"" ORDER BY ""yymm"") AS ""nex_month_income"",""b"".""max_income"" FROM (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""yymm"",SUM(""amount"") AS ""total_income"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY 1,2) AS ""a"" LEFT JOIN ""accounts"" AS ""b"" ON ""a"".""account_id""=""b"".""account_id"") AS ""c"" WHERE ""c"".""total_income"">""c"".""max_income"" AND ""c"".""nex_month_income"">""c"".""max_income"" AND ""c"".""nex_month""-""c"".""current_month""=1 GROUP BY 1"
75,"WITH ""base"" AS (SELECT ""t"".""account_id"",CONVERT(CONCAT(SUBSTR(""t"".""day"", 1, 7), '-01'), DATE) AS ""month"",CASE WHEN SUM(""t"".""amount"")>""a"".""max_income"" THEN 1 ELSE 0 END AS ""flag"" FROM ""transactions"" AS ""t"" JOIN ""accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""t"".""type""='Creditor' GROUP BY 1,2 ORDER BY 1,2) SELECT DISTINCT ""b1"".""account_id"" FROM ""base"" AS ""b1"" LEFT JOIN ""base"" AS ""b2"" ON ""b1"".""account_id""=""b2"".""account_id"" AND ""b1"".""month"" + INTERVAL '1 MONTH'=""b2"".""month"" WHERE ""b2"".""account_id"" IS NOT NULL AND ""b1"".""flag""=1 AND ""b2"".""flag""=1 ORDER BY ""b1"".""account_id"""
76,"WITH ""m"" AS (SELECT ""account_id"",TO_CHAR(""day"", 'YYYY%m') AS ""month"",SUM(CASE WHEN ""type""='Creditor' THEN ""amount"" END) AS ""amt_m"" FROM ""Transactions"" GROUP BY ""account_id"",TO_CHAR(""day"", 'YYYY%m')), ""s"" AS (SELECT ""m"".""account_id"",""m"".""month"" FROM ""m"" JOIN ""Accounts"" AS ""a"" ON ""m"".""account_id""=""a"".""account_id"" WHERE ""amt_m"">""max_income"") SELECT DISTINCT ""s1"".""account_id"" FROM ""s"" AS ""s1"" JOIN ""s"" AS ""s2"" ON ""s1"".""account_id""=""s2"".""account_id"" AND PERIOD_DIFF(""s1"".""month"", ""s2"".""month"")=1"
77,"WITH ""CTE"" AS (SELECT ""account_id"",SUM(""amount"") AS ""total_income"",EXTRACT(MONTH FROM ""day"") AS ""mon"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",""mon""), ""CTE1"" AS (SELECT ""accounts"".""account_id"",""mon"" FROM ""CTE"" JOIN ""accounts"" USING (""account_id"") WHERE ""total_income"">""max_income"") SELECT DISTINCT ""cte1"".""account_id"" AS ""account_id"" FROM ""CTE1"" JOIN ""CTE1"" AS ""CTE2"" USING (""account_id"") WHERE ABS(""cte1"".""mon""-""cte2"".""mon"")=1"
78,"WITH ""cte"" AS (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month"",SUM(""amount"") AS ""total_amount"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY 1,2), ""sus"" AS (SELECT ""cte"".* FROM ""cte"" JOIN ""accounts"" AS ""t"" ON ""t"".""account_id""=""cte"".""account_id"" WHERE ""t"".""max_income""<""cte"".""total_amount""), ""cte_rank"" AS (SELECT *,DENSE_RANK() OVER (PARTITION BY ""account_id"" ORDER BY ""month"") AS ""drk"" FROM ""sus""), ""cte_grp"" AS (SELECT ""account_id"",""total_amount"",""month""-""drk"" AS ""grp"" FROM ""cte_rank"") SELECT DISTINCT ""account_id"" FROM ""cte_grp"" GROUP BY ""grp"",""account_id"" HAVING COUNT(""account_id"")>=2"
79,"WITH ""x"" AS (SELECT ""a"".* FROM (SELECT ""account_id"",TO_CHAR(""day"", '%m') AS ""month"",SUM(""amount"") AS ""total_income"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY 1,2) AS ""a"" JOIN ""accounts"" AS ""b"" USING (""account_id"") WHERE ""a"".""total_income"">""b"".""max_income"") SELECT DISTINCT ""account_id"" FROM (SELECT ""a"".* FROM ""x"" AS ""a"" JOIN ""x"" AS ""b"" ON ""a"".""account_id""=""b"".""account_id"" AND CAST(""a"".""month"" AS INTEGER)=CAST(""b"".""month"" AS INTEGER)-1) AS ""c"" ORDER BY ""account_id"""
80,"WITH ""CTE"" AS (SELECT ""account_id"",""day"",SUM(""amount"") AS ""amount"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",TO_CHAR(""day"", 'YYYY-%m') ORDER BY ""account_id"") SELECT DISTINCT ""tab"".""account_id"" FROM (SELECT ""t1"".""account_id"",""t1"".""amount"" AS ""t1amount"",""t2"".""amount"" AS ""t2amount"" FROM ""CTE"" AS ""t1"" JOIN ""CTE"" AS ""t2"" ON (""t1"".""account_id""=""t2"".""account_id"") AND (TO_CHAR(""t2"".""day"", 'YYYY-%m')=TO_CHAR(""t1"".""day"" + INTERVAL '1 MONTH', 'YYYY-%m'))) AS ""tab"" JOIN ""accounts"" ON ""accounts"".""account_id""=""tab"".""account_id"" WHERE (""tab"".""t1amount"">""accounts"".""max_income"") AND (""tab"".""t2amount"">""accounts"".""max_income"")"
81,"WITH ""cte"" AS (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""Month1"",EXTRACT(YEAR FROM ""day"") AS ""Year1"",SUM(""amount"") AS ""total_income"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",""Year1"",""Month1""), ""cte2"" AS (SELECT ""cte"".""account_id"",""cte"".""Month1"",""cte"".""Year1"",""cte"".""total_income"",""max_income"",(CASE WHEN ""total_income"">""max_income"" THEN 1 ELSE 0 END) AS ""Flag"" FROM ""cte"" JOIN ""Accounts"" AS ""a"" ON ""cte"".""account_id""=""a"".""account_id"" ORDER BY ""account_id"",""Year1"",""Month1"") SELECT DISTINCT ""c1"".""account_id"" FROM ""cte2"" AS ""c1"" JOIN ""cte2"" AS ""c2"" ON ""c1"".""account_id""=""c2"".""account_id"" AND (""c1"".""Month1""=""c2"".""Month1""-1 AND ""c1"".""Year1""=""c2"".""Year1"") WHERE ""c1"".""Flag""=1 AND ""c2"".""Flag""=1 ORDER BY ""account_id"""
82,"WITH ""cte"" AS (SELECT ""a"".""account_id"",EXTRACT(YEAR FROM ""t"".""day"")*12+EXTRACT(MONTH FROM ""t"".""day"") AS ""month"" FROM ""Accounts"" AS ""a"" JOIN ""Transactions"" AS ""t"" USING (""account_id"") WHERE ""type""='Creditor' GROUP BY ""a"".""account_id"",EXTRACT(YEAR FROM ""t"".""day"")*12+EXTRACT(MONTH FROM ""t"".""day"") HAVING SUM(""amount"")>MAX(""max_income"")) SELECT DISTINCT ""t1"".""account_id"" FROM ""cte"" AS ""t1"" JOIN ""cte"" AS ""t2"" ON ""t1"".""account_id""=""t2"".""account_id"" AND ""t2"".""month""-""t1"".""month""=1 ORDER BY ""t1"".""account_id"""
83,"WITH ""cte_acct_month"" AS (SELECT ""m"".""account_id"",""m"".""month"" FROM (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month"",SUM(""amount"") AS ""monthly_income"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",EXTRACT(MONTH FROM ""day"")) AS ""m"" JOIN ""Accounts"" AS ""a"" ON ""m"".""account_id""=""a"".""account_id"" WHERE ""m"".""monthly_income"">""a"".""max_income"") SELECT DISTINCT ""account_id"" FROM (SELECT ""account_id"",""month"",LEAD(""month"", 1) OVER (PARTITION BY ""account_id"" ORDER BY ""month"") AS ""next_month"" FROM ""cte_acct_month"") AS ""l"" WHERE ""next_month""-""month""=1"
84,"WITH ""cte"" AS (SELECT ""t"".""account_id"",EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day"") AS ""month"",(CASE WHEN SUM(""amount"")>""a"".""max_income"" THEN 1 ELSE 0 END) AS ""exceed"" FROM ""transactions"" AS ""t"" JOIN ""accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""type""='Creditor' GROUP BY EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day""),""t"".""account_id"") SELECT DISTINCT ""c1"".""account_id"" FROM (""cte"" AS ""c1"") CROSS JOIN ""cte"" AS ""c2"" WHERE ""c1"".""account_id""=""c2"".""account_id"" AND ""c2"".""month""-""c1"".""month""=1 AND ""c1"".""exceed""=1 AND ""c2"".""exceed""=1"
85,"WITH ""cte"" AS (SELECT ""t"".""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month"",""day"",SUM(""amount"") AS ""sme"",""max_income"" FROM ""Transactions"" AS ""t"" LEFT JOIN ""Accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""type""='Creditor' GROUP BY ""t"".""account_id"",SUBSTRING(""day"", 1, 8) HAVING SUM(""amount"")>""a"".""max_income"") SELECT DISTINCT ""account_id"" FROM ""cte"" WHERE ROW(""account_id"",""month""-1) IN (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") FROM ""cte"") OR ROW(""account_id"",""month""+1) IN (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") FROM ""cte"")"
86,"WITH ""cte"" AS (SELECT ""account_id"",SUM(""amount"") AS ""total_income"",EXTRACT(MONTH FROM ""day"") AS ""mon"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",EXTRACT(MONTH FROM ""day"")), ""cte1"" AS (SELECT ""Accounts"".""account_id"",""mon"" FROM ""cte"" JOIN ""Accounts"" USING (""account_id"") WHERE ""total_income"">""max_income"") SELECT DISTINCT ""cte1"".""account_id"" AS ""account_id"" FROM ""cte1"" JOIN ""cte1"" AS ""cte2"" USING (""account_id"") WHERE ABS(""cte1"".""mon""-""cte2"".""mon"")=1"
87,"WITH ""temp"" AS (SELECT ""account_id"",TO_CHAR(""day"", '%m') AS ""month"",SUM(""amount"") AS ""income"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",""month"") SELECT DISTINCT ""t"".""account_id"" FROM (""temp"" AS ""t"" LEFT JOIN ""accounts"" AS ""a"" USING (""account_id"")) LEFT JOIN ""temp"" AS ""t2"" ON ""t"".""account_id""=""t2"".""account_id"" AND ""t"".""month""=""t2"".""month""-1 WHERE ""t"".""income"">""a"".""max_income"" AND ""t2"".""income"">""a"".""max_income"""
88,"WITH ""main"" AS (SELECT ""account_id"",EXTRACT(YEAR FROM ""day"") AS ""year"",EXTRACT(MONTH FROM ""day"") AS ""month"",(SUM(""amount"")>MAX(""max_income"")) AS ""suspicious"" FROM ""Accounts"" JOIN ""Transactions"" USING (""account_id"") WHERE ""type""='Creditor' GROUP BY ""account_id"",""year"",""month"") SELECT DISTINCT ""M1"".""account_id"" AS ""account_id"" FROM ""main"" AS ""M1"" JOIN ""main"" AS ""M2"" ON ""M1"".""account_id""=""M2"".""account_id"" AND ""M1"".""suspicious""=1 AND ""M2"".""suspicious""=1 AND (""M1"".""year""=""M2"".""year"" AND ""M1"".""month""=""M2"".""month""-1) OR (""M1"".""month""=12 AND ""M2"".""month""=1 AND ""M1"".""year""=""M2"".""year""-1) ORDER BY ""account_id"""
89,"SELECT DISTINCT ""t1"".""account_id"" FROM ((SELECT ""account_id"",CAST(CONCAT(LEFT(""day"", 7), '-01') AS DATE) AS ""dt"",SUM(CASE WHEN ""type""='Creditor' THEN ""amount"" ELSE 0 END) AS ""total_income"" FROM ""Transactions"" GROUP BY ""account_id"",CAST(CONCAT(LEFT(""day"", 7), '-01') AS DATE)) AS ""t1"" LEFT JOIN (SELECT ""account_id"",CAST(CONCAT(LEFT(""day"", 7), '-01') AS DATE) AS ""dt"",SUM(CASE WHEN ""type""='Creditor' THEN ""amount"" ELSE 0 END) AS ""total_income"" FROM ""Transactions"" GROUP BY ""account_id"",CAST(CONCAT(LEFT(""day"", 7), '-01') AS DATE)) AS ""t2"" ON ""t1"".""dt"" + INTERVAL '1 MONTH'=""t2"".""dt"" AND ""t1"".""account_id""=""t2"".""account_id"") LEFT JOIN ""Accounts"" AS ""a"" ON ""t1"".""account_id""=""a"".""account_id"" GROUP BY LEFT(""t1"".""dt"", 7),""t1"".""account_id"" HAVING COALESCE(SUM(""t1"".""total_income""), 0)>MIN(""max_income"") AND COALESCE(SUM(""t2"".""total_income""), 0)>MIN(""max_income"")"
90,"WITH ""dt"" AS (SELECT ""a"".""account_id"",""amount"",""max_income"",""month"" FROM (SELECT ""account_id"",TO_CHAR(""day"", 'YYYY%m') AS ""month"",SUM(""amount"") AS ""amount"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",LEFT(""day"", 7)) AS ""a"" LEFT JOIN ""Accounts"" ON ""a"".""account_id""=""Accounts"".""account_id"" WHERE ""amount"">""max_income"") SELECT DISTINCT ""d1"".""account_id"" FROM ""dt"" AS ""d1"" JOIN ""dt"" AS ""d2"" ON ""d1"".""account_id""=""d2"".""account_id"" AND ""d1"".""month""=""d2"".""month""-1"
91,"WITH ""cte"" AS (SELECT ""t"".""account_id"",EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day"") AS ""month"",(CASE WHEN SUM(""amount"")>""a"".""max_income"" THEN 1 ELSE 0 END) AS ""exceed"" FROM ""Transactions"" AS ""t"" JOIN ""Accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""type""='Creditor' GROUP BY EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day""),""t"".""account_id"") SELECT DISTINCT ""c1"".""account_id"" FROM (""cte"" AS ""c1"") CROSS JOIN ""cte"" AS ""c2"" WHERE ""c1"".""account_id""=""c2"".""account_id"" AND ""c1"".""month""-""c2"".""month""=1 AND ""c1"".""exceed""=1 AND ""c2"".""exceed""=1"
92,"WITH ""cte"" AS (SELECT ""account_id"",SUM(""amount"") AS ""total_income"",EXTRACT(MONTH FROM ""day"") AS ""month"" FROM ""transactions"" WHERE ""type""='creditor' GROUP BY ""account_id"",""month"" ORDER BY ""account_id""), ""cte2"" AS (SELECT ""c"".""account_id"",""month"" FROM ""cte"" AS ""c"" JOIN ""accounts"" AS ""a"" ON ""c"".""account_id""=""a"".""account_id"" WHERE ""total_income"">""max_income"") SELECT DISTINCT ""account_id"" FROM (SELECT ""account_id"",(""month""-DENSE_RANK() OVER (PARTITION BY ""account_id"" ORDER BY ""month"")) AS ""diff"" FROM ""cte2"") AS ""sub"" GROUP BY ""diff"",""account_id"" HAVING COUNT(""account_id"")>1"
93,"WITH ""cte1"" AS (SELECT ""t"".""account_id"",SUM(""amount"") AS ""month_amount"",(EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day"")) AS ""month"",""max_income"" FROM ""Transactions"" AS ""t"" JOIN ""Accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""type""='Creditor' GROUP BY ""t"".""account_id"",LEFT(""day"", 7) HAVING SUM(""amount"")>""max_income"" ORDER BY ""t"".""account_id"",LEFT(""day"", 7)), ""cte2"" AS (SELECT ""c11"".""account_id"",(CASE WHEN ""c11"".""month"" IS NULL THEN 0 ELSE 1 END) AS ""month"" FROM ""cte1"" AS ""c11"" JOIN ""cte1"" AS ""c12"" ON ""c11"".""account_id""=""c12"".""account_id"" WHERE ""c12"".""month""-""c11"".""month""=1), ""cte3"" AS (SELECT DISTINCT ""account_id"" FROM ""cte2"" WHERE ""month""!=0) SELECT * FROM ""cte3"""
94,"WITH ""cte"" AS (SELECT ""t"".""account_id"",EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day"") AS ""month"",(CASE WHEN SUM(""amount"")>""a"".""max_income"" THEN 1 ELSE 0 END) AS ""exceed"" FROM ""transactions"" AS ""t"" JOIN ""accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""type""='Creditor' GROUP BY EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day""),""t"".""account_id"") SELECT DISTINCT ""c1"".""account_id"" FROM (""cte"" AS ""c1"") CROSS JOIN ""cte"" AS ""c2"" WHERE ""c1"".""account_id""=""c2"".""account_id"" AND ""c2"".""month""-""c1"".""month""=1 AND ""c1"".""exceed""=1 AND ""c2"".""exceed""=1"
95,"WITH ""cte"" AS (SELECT ""a"".""account_id"",""yy"",""mm"" FROM (SELECT ""account_id"",TO_CHAR(""day"", 'YYYY') AS ""yy"",TO_CHAR(""day"", '%m') AS ""mm"",SUM(""amount"") AS ""amount"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",TO_CHAR(""day"", 'YYYY'),TO_CHAR(""day"", '%m')) AS ""a"" JOIN ""accounts"" AS ""b"" ON ""a"".""account_id""=""b"".""account_id"" WHERE ""a"".""amount"">""b"".""max_income"") SELECT DISTINCT ""c1"".""account_id"" FROM ""cte"" AS ""c1"" JOIN ""cte"" AS ""c2"" ON ""c1"".""account_id""=""c2"".""account_id"" AND (((""c1"".""yy""=""c2"".""yy"") AND (""c1"".""mm""+1=""c2"".""mm"")) OR ((""c1"".""yy""+1=""c2"".""yy"") AND (""c1"".""mm""-11=""c2"".""mm"")))"
96,"WITH ""CTE"" AS (SELECT ""account_id"",""day"",SUM(""amount"") AS ""amount"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",TO_CHAR(""day"", 'YYYY-%m') ORDER BY ""account_id"") SELECT DISTINCT ""tab"".""account_id"" FROM (SELECT ""t1"".""account_id"",TO_CHAR(""t1"".""day"", 'YYYY-%m') AS ""t1Date"",""t1"".""amount"" AS ""t1amount"",TO_CHAR(""t2"".""day"", 'YYYY-%m') AS ""t2Date"",""t2"".""amount"" AS ""t2amount"" FROM ""CTE"" AS ""t1"" JOIN ""CTE"" AS ""t2"" ON (""t1"".""account_id""=""t2"".""account_id"") AND (TO_CHAR(""t2"".""day"", 'YYYY-%m')=TO_CHAR(""t1"".""day"" + INTERVAL '1 MONTH', 'YYYY-%m'))) AS ""tab"" JOIN ""accounts"" ON ""accounts"".""account_id""=""tab"".""account_id"" WHERE (""tab"".""t1amount"">""accounts"".""max_income"") AND (""tab"".""t2amount"">""accounts"".""max_income"")"
97,"WITH ""cte"" AS (SELECT ""t"".""account_id"",EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day"") AS ""month"",CASE WHEN SUM(""amount"")>""a"".""max_income"" THEN 1 ELSE 0 END AS ""exceed"" FROM ""Transactions"" AS ""t"" LEFT JOIN ""Accounts"" AS ""a"" ON ""a"".""account_id""=""t"".""account_id"" WHERE ""type""='Creditor' GROUP BY ""t"".""account_id"",""month"" HAVING ""exceed""=1) SELECT DISTINCT ""t1"".""account_id"" FROM (""cte"" AS ""t1"") CROSS JOIN ""cte"" AS ""t2"" WHERE ""t1"".""account_id""=""t2"".""account_id"" AND ""t1"".""month""-""t2"".""month""=1"
98,"WITH ""cte"" AS (SELECT ""T"".""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month"",EXTRACT(YEAR FROM ""day"") AS ""year"",""max_income"" FROM ""Transactions"" AS ""T"" JOIN ""Accounts"" AS ""A"" ON ""T"".""account_id""=""A"".""account_id"" WHERE ""type""='Creditor' GROUP BY ""account_id"",EXTRACT(MONTH FROM ""day"") HAVING SUM(""amount"")>""A"".""max_income"") SELECT DISTINCT ""t1"".""account_id"" FROM (""cte"" AS ""t1"") CROSS JOIN ""cte"" AS ""t2"" WHERE ""t1"".""account_id""=""t2"".""account_id"" AND (""t1"".""month""-""t2"".""month""=1 AND ""t1"".""year""=""t2"".""year"" OR ""t1"".""month""=12 AND ""t2"".""month""=1 AND ""t1"".""year""-""t2"".""year""=-1 OR ""t1"".""month""=12 AND ""t2"".""month""=1 AND ""t1"".""year""-""t2"".""year""=1)"
99,"WITH ""cte"" AS (SELECT ""t"".""account_id"",EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day"") AS ""month"",(CASE WHEN SUM(""amount"")>""a"".""max_income"" THEN 1 ELSE 0 END) AS ""exceed"" FROM ""transactions"" AS ""t"" JOIN ""accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""type""='Creditor' GROUP BY EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day""),""t"".""account_id"") SELECT DISTINCT ""c1"".""account_id"" FROM (""cte"" AS ""c1"") CROSS JOIN ""cte"" AS ""c2"" WHERE ""c1"".""account_id""=""c2"".""account_id"" AND ""c2"".""month""-""c1"".""month""=1 AND ""c1"".""exceed""=1 AND ""c2"".""exceed""=1"
100,"WITH ""t"" AS (SELECT ""account_id"",MIN(""day"") AS ""day"" FROM ""Transactions"" JOIN ""Accounts"" USING (""account_id"") WHERE ""type""='Creditor' GROUP BY ""account_id"",TO_CHAR(""day"", 'YYYY-%m') HAVING SUM(""amount"")>MAX(""max_income"")) SELECT DISTINCT ""t1"".""account_id"" FROM ""t"" AS ""t1"" JOIN ""t"" AS ""t2"" ON ""t1"".""account_id""=""t2"".""account_id"" AND TO_CHAR(""t1"".""day"" + INTERVAL '1 MONTH', 'YYYY-%m')=TO_CHAR(""t2"".""day"", 'YYYY-%m') ORDER BY ""t1"".""account_id"""
101,"WITH ""t"" AS (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month"",SUM(""amount"") AS ""income"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY 1,2) SELECT DISTINCT ""t1"".""account_id"" FROM (""t"" AS ""t1"" JOIN ""t"" AS ""t2"" ON ""t1"".""account_id""=""t2"".""account_id"" AND PERIOD_DIFF(""t2"".""month"", ""t1"".""month"")=1) LEFT JOIN ""Accounts"" AS ""a"" ON ""t1"".""account_id""=""a"".""account_id"" WHERE ""t1"".""income"">""a"".""max_income"" AND ""t2"".""income"">""a"".""max_income"""
102,"WITH ""ti"" AS (SELECT EXTRACT(MONTH FROM ""day"") AS ""month"",""t"".""account_id"",""a"".""max_income"",SUM(""amount"") AS ""total_income"" FROM ""Transactions"" AS ""t"" JOIN ""Accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""type""='Creditor' AND EXTRACT(YEAR FROM ""day"")=2021 GROUP BY 1,2,3 HAVING SUM(""amount"")>""max_income"") SELECT DISTINCT ""a"".""account_id"" FROM ""ti"" AS ""a"" JOIN ""ti"" AS ""b"" ON ""a"".""account_id""=""b"".""account_id"" AND ""b"".""month""=""a"".""month""+1"
103,"WITH ""CTE"" AS (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month"",SUM(""amount"") AS ""total_income"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",""month"" ORDER BY 1,2) SELECT DISTINCT ""a"".""account_id"" FROM (""Accounts"" AS ""a"" JOIN ""CTE"" AS ""c1"" ON ""a"".""account_id""=""c1"".""account_id"" AND ""a"".""max_income""<""c1"".""total_income"") JOIN ""CTE"" AS ""c2"" ON ""a"".""account_id""=""c2"".""account_id"" AND ""c1"".""month""=""c2"".""month""-1 AND ""a"".""max_income""<""c2"".""total_income"" ORDER BY 1"
104,"WITH ""t"" AS (SELECT ""t"".""account_id"",EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day"") AS ""month"",""max_income"",SUM(""amount"") AS ""amount"" FROM ""transactions"" AS ""t"" JOIN ""accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""type""='Creditor' GROUP BY 1,2,3 HAVING ""max_income""<SUM(""amount"")) SELECT DISTINCT ""a"".""account_id"" FROM ""t"" AS ""a"" JOIN ""t"" AS ""b"" ON ""a"".""account_id""=""b"".""account_id"" AND ABS(""a"".""month""-""b"".""month"")=1"
105,"WITH ""cte"" AS (SELECT ""account_id"",SUM(""amount"") AS ""total_income"",EXTRACT(MONTH FROM ""day"") AS ""mon"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",EXTRACT(MONTH FROM ""day"")), ""cte1"" AS (SELECT ""Accounts"".""account_id"",""mon"" FROM ""cte"" JOIN ""Accounts"" USING (""account_id"") WHERE ""total_income"">""max_income"") SELECT DISTINCT ""cte1"".""account_id"" AS ""account_id"" FROM ""cte1"" JOIN ""cte1"" AS ""cte2"" USING (""account_id"") WHERE ABS(""cte1"".""mon""-""cte2"".""mon"")=1"
106,"SELECT ""c"".""account_id"" FROM (SELECT ""a"".""account_id"",""a"".""yymm"" AS ""current_month"",""a"".""total_income"",LEAD(""a"".""yymm"") OVER (PARTITION BY ""a"".""account_id"" ORDER BY ""a"".""yymm"") AS ""nex_month"",LEAD(""a"".""total_income"") OVER (PARTITION BY ""a"".""account_id"" ORDER BY ""yymm"") AS ""nex_month_income"",""b"".""max_income"" FROM (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""yymm"",SUM(""amount"") AS ""total_income"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY 1,2) AS ""a"" LEFT JOIN ""accounts"" AS ""b"" ON ""a"".""account_id""=""b"".""account_id"") AS ""c"" WHERE ""c"".""total_income"">""c"".""max_income"" AND ""c"".""nex_month_income"">""c"".""max_income"" AND ""c"".""nex_month""-""c"".""current_month""=1 GROUP BY 1"
107,"WITH ""t"" AS (WITH ""t"" AS (SELECT SUM(""amount"") AS ""tot"",EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day"") AS ""d"",""account_id"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",SUBSTRING(""day"", 1, 7) ORDER BY ""account_id"",""d"") SELECT ""t"".""account_id"",""t"".""d"" FROM ""t"" JOIN ""accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" AND ""t"".""tot"">""a"".""max_income"") SELECT DISTINCT ""a"".""account_id"" AS ""account_id"" FROM ""t"" AS ""a"" JOIN ""t"" AS ""b"" ON ""a"".""account_id""=""b"".""account_id"" AND ""b"".""d""=""a"".""d""+1"
108,"WITH ""exceeds"" AS (SELECT ""a"".""account_id"",EXTRACT(YEAR FROM ""t"".""day"")*12+EXTRACT(MONTH FROM ""t"".""day"") AS ""m"" FROM ""Accounts"" AS ""a"" JOIN ""Transactions"" AS ""t"" ON ""a"".""account_id""=""t"".""account_id"" AND ""t"".""type""='Creditor' GROUP BY ""a"".""account_id"",""a"".""max_income"",EXTRACT(YEAR FROM ""t"".""day"")*12+EXTRACT(MONTH FROM ""t"".""day"") HAVING SUM(""t"".""amount"")>""a"".""max_income"") SELECT DISTINCT ""e1"".""account_id"" FROM ""exceeds"" AS ""e1"" JOIN ""exceeds"" AS ""e2"" ON ""e1"".""account_id""=""e2"".""account_id"" AND ""e1"".""m""=""e2"".""m""+1"
109,"WITH ""CET"" AS (SELECT ""T"".""account_id"",EXTRACT(MONTH FROM ""day"") AS ""DAY"",""max_income"" FROM ""Transactions"" AS ""T"" JOIN ""Accounts"" AS ""A"" ON ""T"".""account_id""=""A"".""account_id"" WHERE ""type""='Creditor' GROUP BY ""account_id"",EXTRACT(MONTH FROM ""day"") HAVING SUM(""amount"")>""A"".""max_income"") SELECT DISTINCT ""account_id"" FROM ""CET"" WHERE ROW(""account_id"",""DAY""-1) IN (SELECT ""account_id"",""DAY"" FROM ""CET"") OR ROW(""account_id"",""DAY""+1) IN (SELECT ""account_id"",""DAY"" FROM ""CET"")"
110,"WITH ""ta"" AS (SELECT ""t"".""account_id"",""t"".""yr"",""t"".""mo"" FROM (SELECT ""account_id"",EXTRACT(YEAR FROM ""day"") AS ""yr"",EXTRACT(MONTH FROM ""day"") AS ""mo"",SUM(""amount"") AS ""amount"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY 1,2,3) AS ""t"" CROSS, ""Accounts"" AS ""a"" WHERE ""t"".""account_id""=""a"".""account_id"" AND ""t"".""amount"">""a"".""max_income"" ORDER BY 1,2,3) SELECT DISTINCT ""ta1"".""account_id"" FROM ""ta"" AS ""ta1"" LEFT JOIN ""ta"" AS ""ta2"" ON ""ta1"".""account_id""=""ta2"".""account_id"" AND ""ta1"".""yr""*12+""ta1"".""mo""+1=""ta2"".""yr""*12+""ta2"".""mo"" WHERE ""ta2"".""account_id"" IS NOT NULL"
111,"WITH ""main_tab"" AS (SELECT ""t2"".""account_id"",""month"",""tot_amount"" FROM (SELECT ""account_id"",""month"",SUM(""amount"") AS ""tot_amount"" FROM (SELECT *,TO_CHAR(""day"", 'YYYY-%m') AS ""month"" FROM ""Transactions"") AS ""t1"" WHERE ""type""='Creditor' GROUP BY 1,2) AS ""t2"" JOIN ""Accounts"" USING (""account_id"") WHERE ""tot_amount"">""max_income""), ""main_tab2"" AS (SELECT ""t2"".""account_id"",TO_CHAR(CAST(CONCAT(""month"", '-01') AS DATE) + INTERVAL '1 MONTH', 'YYYY-%m') AS ""month"",""tot_amount"" FROM (SELECT ""account_id"",""month"",SUM(""amount"") AS ""tot_amount"" FROM (SELECT *,TO_CHAR(""day"", 'YYYY-%m') AS ""month"" FROM ""Transactions"") AS ""t1"" WHERE ""type""='Creditor' GROUP BY 1,2) AS ""t2"" JOIN ""Accounts"" USING (""account_id"") WHERE ""tot_amount"">""max_income"") SELECT DISTINCT (""account_id"") FROM ""main_tab"" JOIN ""main_tab2"" USING (""account_id"",""month"")"
112,"WITH ""cte"" AS (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month"",SUM(""amount"") AS ""net_amount"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",""month""), ""demo"" AS (SELECT ""cte"".""account_id"",""cte"".""month"",ROW_NUMBER() OVER (PARTITION BY ""account_id"" ORDER BY ""month"") AS ""rnk"" FROM ""cte"" JOIN ""accounts"" AS ""a"" ON ""cte"".""account_id""=""a"".""account_id"" AND ""cte"".""net_amount"">""a"".""max_income"" ORDER BY ""account_id"",""month""), ""sub"" AS (SELECT ""account_id"",""month""-""rnk"" AS ""diff"" FROM ""demo"") SELECT DISTINCT ""account_id"" FROM ""sub"" GROUP BY ""account_id"",""diff"" HAVING COUNT(1)>1"
113,"WITH ""cte"" AS (SELECT ""t"".""account_id"",EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day"") AS ""month"",(CASE WHEN SUM(""amount"")>""a"".""max_income"" THEN 1 ELSE 0 END) AS ""exceed"" FROM ""transactions"" AS ""t"" JOIN ""accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""type""='Creditor' GROUP BY EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day""),""t"".""account_id"") SELECT DISTINCT ""c1"".""account_id"" FROM (""cte"" AS ""c1"") CROSS JOIN ""cte"" AS ""c2"" WHERE ""c1"".""account_id""=""c2"".""account_id"" AND ""c2"".""month""-""c1"".""month""=1 AND ""c1"".""exceed""=1 AND ""c2"".""exceed""=1"
114,"WITH ""a"" AS (SELECT ""account_id"",""transaction_id"",SUM(CASE WHEN ""type""='creditor' THEN ""amount"" ELSE 0 END) AS ""total_income"",""max_income"",EXTRACT(MONTH FROM ""day"") AS ""month"" FROM ""Transactions"" JOIN ""Accounts"" USING (""account_id"") GROUP BY ""account_id"",""month"" HAVING ""total_income"">""max_income"" ORDER BY ""account_id"",""month"") SELECT ""a1"".""account_id"" FROM (""a"" AS ""a1"") CROSS JOIN ""a"" AS ""a2"" WHERE ""a1"".""account_id""=""a2"".""account_id"" AND PERIOD_DIFF(""a1"".""month"", ""a2"".""month"")=1 GROUP BY ""a1"".""account_id"" ORDER BY ""a1"".""transaction_id"""
115,"WITH ""cte"" AS (SELECT ""t"".""account_id"",EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day"") AS ""month"",(CASE WHEN SUM(""amount"")>""a"".""max_income"" THEN 1 ELSE 0 END) AS ""exceed"" FROM ""transactions"" AS ""t"" JOIN ""accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""type""='Creditor' GROUP BY EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day""),""t"".""account_id"") SELECT DISTINCT ""c1"".""account_id"" FROM (""cte"" AS ""c1"") CROSS JOIN ""cte"" AS ""c2"" WHERE ""c1"".""account_id""=""c2"".""account_id"" AND ""c2"".""month""-""c1"".""month""=1 AND ""c1"".""exceed""=1 AND ""c2"".""exceed""=1"
116,"WITH ""cte"" AS (SELECT ""t"".""account_id"",EXTRACT(YEAR FROM ""day"")*100+EXTRACT(MONTH FROM ""day"") AS ""yearmon"",SUM(CASE WHEN ""type""='Creditor' THEN ""amount"" END) AS ""total_income"",MAX(""a"".""max_income"") AS ""max_income"" FROM (""transactions"" AS ""t"") CROSS JOIN ""accounts"" AS ""a"" WHERE ""t"".""account_id""=""a"".""account_id"" GROUP BY 1,2 HAVING ""total_income"">""max_income"" ORDER BY ""a"".""account_id"") SELECT DISTINCT ""t1"".""account_id"" FROM (""cte"" AS ""t1"") CROSS JOIN ""cte"" AS ""t2"" WHERE ""t1"".""account_id""=""t2"".""account_id"" AND ""t1"".""yearmon""=""t2"".""yearmon""-1 ORDER BY ""t1"".""account_id"""
117,"WITH ""t"" AS (SELECT ""account_id"",EXTRACT(YEAR_MONTH FROM ""day"") AS ""month"",SUM(""amount"") AS ""total_income"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",""month"") SELECT DISTINCT ""t1"".""account_id"" FROM ((""t"" AS ""t1"") CROSS JOIN ""t"" AS ""t2"") CROSS JOIN ""accounts"" AS ""a"" WHERE ""t1"".""account_id""=""t2"".""account_id"" AND ""t1"".""account_id""=""a"".""account_id"" AND (""t1"".""month""-""t2"".""month"")=1 AND ""t1"".""total_income"">""max_income"" AND ""t2"".""total_income"">""max_income"" GROUP BY ""t1"".""account_id"" ORDER BY ""t1"".""account_id"""
118,"WITH ""cte"" AS (SELECT ""T"".""account_id"",EXTRACT(YEAR FROM ""day"") AS ""year"",EXTRACT(MONTH FROM ""day"") AS ""month"",SUM(CASE WHEN ""type""='Creditor' THEN ""amount"" ELSE 0 END) AS ""total_income"",AVG(""max_income"") AS ""max_income"" FROM ""Transactions"" AS ""T"" JOIN ""Accounts"" AS ""A"" ON ""T"".""account_id""=""A"".""account_id"" GROUP BY 1,2,3 HAVING SUM(CASE WHEN ""type""='Creditor' THEN ""amount"" ELSE 0 END)>AVG(""max_income"") ORDER BY 1,2,3) SELECT DISTINCT ""c1"".""account_id"" FROM (""cte"" AS ""c1"") CROSS JOIN ""cte"" AS ""c2"" WHERE ""c1"".""account_id""=""c2"".""account_id"" AND (""c1"".""year""=""c2"".""year"" AND ""c1"".""month""=""c2"".""month""-1) OR (""c1"".""year""=""c2"".""year""-1 AND ""c1"".""month""=12 AND ""c2"".""month""=1) ORDER BY 1"
119,"ERROR: mysql parse error: line 1 column 177 near ""t join (select account_id, extract(year_month from day) as m_y2, sum(amount) as m2_amount from Transactions where type = 'Creditor' group by 1, 2) t1 on t1.account_id = t.account_id and t1.m_y2 - t.m_y1 = 1 join Accounts a on a.account_id = t.account_id and t.m1_amount > a.max_income and t1.m2_amount > a.max_income)"" "
120,"WITH ""t"" AS (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month"",CASE WHEN SUM(""amount"")>""max_income"" THEN 'Y' ELSE 'N' END AS ""suspicious"" FROM ""transactions"" JOIN ""accounts"" USING (""account_id"") WHERE ""type""='Creditor' GROUP BY 1,2) SELECT DISTINCT ""t1"".""account_id"" FROM (""t"" AS ""t1"") CROSS JOIN ""t"" AS ""t2"" WHERE ""t1"".""account_id""=""t2"".""account_id"" AND ""t2"".""month""-""t1"".""month""=1 AND ""t1"".""suspicious""='Y' AND ""t2"".""suspicious""='Y'"
121,"WITH ""CTE"" AS (SELECT ""t"".""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month"",""a"".""max_income"" FROM ""Transactions"" AS ""t"" JOIN ""Accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""type""='Creditor' GROUP BY ""t"".""account_id"",EXTRACT(MONTH FROM ""day"") HAVING SUM(""t"".""amount"")>""a"".""max_income"") SELECT DISTINCT ""c"".""account_id"" FROM ""CTE"" AS ""c"" WHERE ROW(""c"".""account_id"",""c"".""month""-1) IN (SELECT ""account_id"",""month"" FROM ""CTE"") OR ROW(""c"".""account_id"",""c"".""month""+1) IN (SELECT ""account_id"",""month"" FROM ""CTE"")"
122,"WITH ""tbSum"" AS (SELECT ""account_id"",EXTRACT(YEAR FROM ""day"") AS ""year_"",EXTRACT(MONTH FROM ""day"") AS ""month_"",SUM(""amount"") AS ""total_income"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",EXTRACT(YEAR FROM ""day""),EXTRACT(MONTH FROM ""day"")), ""tbExceed"" AS (SELECT ""tbSum"".""account_id"",""tbSum"".""year_"",""tbSum"".""month_"" FROM ""tbSum"" JOIN ""accounts"" AS ""a"" ON ""tbSum"".""account_id""=""a"".""account_id"" WHERE ""tbSum"".""total_income"">""a"".""max_income"") SELECT DISTINCT ""tbE1"".""account_id"" FROM ""tbExceed"" AS ""tbE1"" JOIN ""tbExceed"" AS ""tbE2"" ON ""tbE1"".""account_id""=""tbE2"".""account_id"" WHERE (""tbE1"".""year_""=""tbE2"".""year_"" AND ""tbE1"".""month_""=""tbE2"".""month_""+1) OR (""tbE1"".""year_""=""tbE2"".""year_""-1 AND ""tbE1"".""month_""=12 AND ""tbE2"".""month_""=12)"
123,"WITH ""t1"" AS (SELECT ""account_id"",SUM(""amount"") AS ""total"",EXTRACT(MONTH FROM ""day"") AS ""month"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY 1,3), ""t2"" AS (SELECT ""t1"".""account_id"",""total"",""month"",LAG(""month"", 1) OVER (PARTITION BY ""account_id"" ORDER BY ""month"") AS ""num"" FROM ""t1"" JOIN ""Accounts"" AS ""a"" ON ""t1"".""account_id""=""a"".""account_id"" WHERE ""total"">""max_income"") SELECT DISTINCT ""t2"".""account_id"" FROM ""t2"" WHERE ""month""-""num""=1"
124,"WITH ""CTE"" AS (SELECT ""Transactions"".""account_id"",TO_CHAR(""day"", '%m/YYYY') AS ""Date"",SUM(""amount"") AS ""INCOME"" FROM ""Transactions"" JOIN ""Accounts"" AS ""A"" ON ""Transactions"".""account_id""=""A"".""account_id"" WHERE ""type""='Creditor' GROUP BY ""Transactions"".""account_id"",TO_CHAR(""day"", '%m/YYYY'),""max_income"" HAVING SUM(""amount"")>""max_income"") SELECT DISTINCT ""C1"".""account_id"" FROM ""CTE"" AS ""C1"" JOIN ""CTE"" AS ""C2"" ON ""C1"".""account_id""=""C2"".""account_id"" AND PERIOD_DIFF(""C1"".""date"", ""C2"".""date"")=1 ORDER BY 1"
125,"WITH ""CET"" AS (SELECT ""T"".""account_id"",EXTRACT(MONTH FROM ""day"") AS ""DAY"",""max_income"" FROM ""Transactions"" AS ""T"" JOIN ""Accounts"" AS ""A"" ON ""T"".""account_id""=""A"".""account_id"" WHERE ""type""='Creditor' GROUP BY ""account_id"",EXTRACT(MONTH FROM ""day"") HAVING SUM(""amount"")>""A"".""max_income"") SELECT DISTINCT ""account_id"" FROM ""CET"" WHERE ROW(""account_id"",""DAY""-1) IN (SELECT ""account_id"",""DAY"" FROM ""CET"") OR ROW(""account_id"",""DAY""+1) IN (SELECT ""account_id"",""DAY"" FROM ""CET"")"
126,"WITH ""incometable"" AS (SELECT ""t"".""account_id"",EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day"") AS ""month"",SUM(CASE WHEN ""type""='Creditor' THEN ""amount"" END) AS ""income"",""max_income"" FROM ""accounts"" AS ""a"" JOIN ""transactions"" AS ""t"" ON ""a"".""account_id""=""t"".""account_id"" GROUP BY ""t"".""account_id"",TO_CHAR(""day"", 'YYYY-%M') ORDER BY ""t"".""account_id"",""month"") SELECT DISTINCT ""i1"".""account_id"" FROM ""incometable"" AS ""i1"" JOIN ""incometable"" AS ""i2"" ON ""i1"".""account_id""=""i2"".""account_id"" AND ""i2"".""month""-""i1"".""month"" BETWEEN 0 AND 1 WHERE ""i1"".""income"">""i1"".""max_income"" AND ""i2"".""income"">""i2"".""max_income"" GROUP BY ""i1"".""account_id"",""i1"".""month"" HAVING COUNT(""i2"".""month"")>=2 ORDER BY ""i1"".""account_id"""
127,"SELECT DISTINCT ""account_id"" FROM (SELECT ""tmp"".""account_id"",""mon""-ROW_NUMBER() OVER (PARTITION BY ""account_id"" ORDER BY ""mon"") AS ""grp"" FROM (SELECT ""t"".""account_id"",EXTRACT(MONTH FROM ""t"".""day"") AS ""mon"",SUM(CASE WHEN ""t"".""type""='Creditor' THEN ""t"".""amount"" ELSE 0 END) AS ""mon_ttl_income"" FROM ""transactions"" AS ""t"" GROUP BY 1,2) AS ""tmp"" JOIN ""accounts"" AS ""a"" ON ""a"".""account_id""=""tmp"".""account_id"" WHERE ""tmp"".""mon_ttl_income"">""a"".""max_income"") AS ""tmp2"" GROUP BY ""account_id"",""grp"" HAVING COUNT(1)>=2"
128,"WITH ""tt0"" AS (SELECT ""t"".""account_id"",EXTRACT(YEAR FROM ""t"".""day"") AS ""year"",EXTRACT(MONTH FROM ""t"".""day"") AS ""month"",SUM(CASE WHEN ""t"".""type""='Creditor' THEN ""t"".""amount"" END) AS ""total_income"",""a"".""max_income"" FROM ""Transactions"" AS ""t"" LEFT JOIN ""Accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" GROUP BY ""account_id"",""year"",""month""), ""tt"" AS (SELECT ""account_id"",""year"",""month"",""total_income"",""max_income"" FROM ""tt0"" WHERE ""total_income"">""max_income"") SELECT DISTINCT (""t1"".""account_id"") FROM ""tt"" AS ""t1"" JOIN ""tt"" AS ""t2"" ON ""t1"".""account_id""=""t2"".""account_id"" AND ((""t1"".""year""=""t2"".""year"" AND ""t1"".""month""+1=""t2"".""month"") OR (""t1"".""year""+1=""t2"".""year"" AND ""t1"".""month""=12 AND ""t2"".""month""=1)) ORDER BY ""t1"".""account_id"""
129,"WITH ""temp"" AS (SELECT ""t"".""account_id"",EXTRACT(YEAR_MONTH FROM ""day"") AS ""date"",SUM(""t"".""amount"") AS ""income"" FROM ""Transactions"" AS ""t"" JOIN ""Accounts"" AS ""a"" ON ""a"".""account_id""=""t"".""account_id"" WHERE ""t"".""type""='Creditor' GROUP BY ""t"".""account_id"",EXTRACT(YEAR_MONTH FROM ""day""),""a"".""max_income"" HAVING SUM(""amount"")>""a"".""max_income"") SELECT ""t1"".""account_id"" FROM ""temp"" AS ""t1"" JOIN ""temp"" AS ""t2"" ON ""t1"".""account_id""=""t2"".""account_id"" AND (""t1"".""date""-""t2"".""date"")=1 GROUP BY ""t1"".""account_id"" ORDER BY ""t1"".""account_id"""
130,"WITH ""cte1"" AS (SELECT ""t"".""account_id"",SUM(""amount"") AS ""amount"",EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day"") AS ""month"" FROM ""Transactions"" AS ""t"" WHERE ""type""='Creditor' GROUP BY ""account_id"",EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day"")), ""cte2"" AS (SELECT ""cte1"".""account_id"",""cte1"".""month"" FROM ""cte1"" JOIN ""Accounts"" AS ""a"" ON ""cte1"".""account_id""=""a"".""account_id"" AND ""cte1"".""amount"">""a"".""max_income"") SELECT DISTINCT ""c1"".""account_id"" FROM ""cte2"" AS ""c1"" JOIN ""cte2"" AS ""c2"" ON ""c1"".""account_id""=""c2"".""account_id"" AND ""c1"".""month""-""c2"".""month""=1"
131,"WITH ""temp"" AS (SELECT ""t"".""account_id"",TO_CHAR(""day"", 'YYYY%m') AS ""date"",SUM(""amount"") AS ""income"",""Accounts"".""max_income"" FROM ""Transactions"" AS ""t"" LEFT JOIN ""Accounts"" ON ""Accounts"".""account_id""=""t"".""account_id"" WHERE ""t"".""type""='Creditor' GROUP BY ""t"".""account_id"",TO_CHAR(""day"", 'YYYY%m') HAVING SUM(""amount"")>""Accounts"".""max_income"") SELECT ""t1"".""account_id"" FROM (""temp"" AS ""t1"") CROSS JOIN ""temp"" AS ""t2"" WHERE ""t1"".""account_id""=""t2"".""account_id"" AND PERIOD_DIFF(""t1"".""date"", ""t2"".""date"")=1 GROUP BY ""t1"".""account_id"""
132,"WITH ""a"" AS (SELECT ""t"".""account_id"",EXTRACT(MONTH FROM ""day"") AS ""months"",""max_income"" FROM ""transactions"" AS ""t"" JOIN ""accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""type""='Creditor' GROUP BY ""t"".""account_id"",EXTRACT(MONTH FROM ""day"") HAVING SUM(""amount"")>""a"".""max_income"") SELECT DISTINCT ""a1"".""account_id"" FROM ""a"" AS ""a1"" JOIN ""a"" AS ""a2"" ON ""a1"".""account_id""=""a2"".""account_id"" WHERE ""a1"".""months""-""a2"".""months""=1"
133,"WITH ""base"" AS (SELECT ""t"".""account_id"",CONVERT(CONCAT(SUBSTR(""t"".""day"", 1, 7), '-01'), DATE) AS ""month"",SUM(""t"".""amount"") AS ""income"" FROM ""transactions"" AS ""t"" WHERE ""t"".""type""='Creditor' GROUP BY 1,2 ORDER BY 1,2), ""filtered"" AS (SELECT ""b"".* FROM ""base"" AS ""b"" JOIN ""accounts"" AS ""a"" ON ""b"".""account_id""=""a"".""account_id"" WHERE ""b"".""income"">""a"".""max_income"") SELECT DISTINCT ""b1"".""account_id"" FROM ""filtered"" AS ""b1"" LEFT JOIN ""filtered"" AS ""b2"" ON ""b1"".""account_id""=""b2"".""account_id"" AND ""b1"".""month"" + INTERVAL '1 MONTH'=""b2"".""month"" WHERE ""b2"".""account_id"" IS NOT NULL ORDER BY ""b1"".""account_id"""
134,"SELECT DISTINCT ""c"".""account_id"" FROM (SELECT ""a"".""account_id"",""a"".""month"",""a"".""sum_amount"" AS ""amount1"",""b"".""sum_amount"" AS ""amount2"" FROM (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month"",SUM(""amount"") AS ""sum_amount"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",EXTRACT(MONTH FROM ""day"") ORDER BY ""account_id"",EXTRACT(MONTH FROM ""day"")) AS ""a"" LEFT JOIN (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month"",SUM(""amount"") AS ""sum_amount"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",EXTRACT(MONTH FROM ""day"") ORDER BY ""account_id"",EXTRACT(MONTH FROM ""day"")) AS ""b"" ON ""a"".""account_id""=""b"".""account_id"" AND ""a"".""month""=""b"".""month""-1 WHERE ""b"".""sum_amount"" IS NOT NULL) AS ""c"" LEFT JOIN ""Accounts"" AS ""d"" ON ""c"".""account_id""=""d"".""account_id"" WHERE ""d"".""max_income""<""c"".""amount1"" AND ""d"".""max_income""<""c"".""amount2"""
135,"WITH ""t1"" AS (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month"",SUM(""amount"") AS ""total"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",EXTRACT(MONTH FROM ""day"")), ""t2"" AS (SELECT ""t1"".""account_id"",""total"",""month"",LAG(""month"", 1) OVER (PARTITION BY ""account_id"" ORDER BY ""month"") AS ""num"" FROM ""t1"" JOIN ""Accounts"" AS ""a"" ON ""t1"".""account_id""=""a"".""account_id"" WHERE ""total"">""max_income"") SELECT DISTINCT ""t2"".""account_id"" FROM ""t2"" WHERE ""month""-""num""=1"
136,"WITH ""tot_income"" AS (SELECT ""account_id"",TO_CHAR(""day"", 'YYYY%m') AS ""date_month"",SUM(""amount"") AS ""amt1"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",TO_CHAR(""day"", 'YYYY%m')) SELECT DISTINCT ""t1"".""account_id"" FROM (""tot_income"" AS ""t1"" JOIN ""tot_income"" AS ""t2"" ON ""t1"".""account_id""=""t1"".""account_id"" AND ""t1"".""date_month""+1=""t2"".""date_month"") LEFT JOIN ""accounts"" AS ""a"" ON ""t1"".""account_id""=""a"".""account_id"" AND ""t2"".""account_id""=""a"".""account_id"" WHERE ""t1"".""amt1"">""a"".""max_income"" AND ""t2"".""amt1"">""a"".""max_income"""
137,"WITH ""CTE"" AS (SELECT ""a"".""account_id"",""trans_month"" FROM (SELECT SUM(""T"".""amount"") AS ""max_income"",""T"".""account_id"",EXTRACT(MONTH FROM ""T"".""day"") AS ""trans_month"" FROM ""Transactions"" AS ""T"" WHERE ""T"".""type""='Creditor' GROUP BY ""T"".""account_id"",""trans_month"") AS ""C"" JOIN ""Accounts"" AS ""a"" ON ""a"".""account_id""=""C"".""account_id"" AND ""C"".""max_income"">""a"".""max_income"") SELECT DISTINCT ""C"".""account_id"" FROM (""CTE"" AS ""C"") CROSS JOIN ""CTE"" AS ""C1"" WHERE ""C"".""account_id""=""C1"".""account_id"" AND ""C"".""trans_month""=""C1"".""trans_month""+1"
138,"WITH ""cte"" AS (SELECT ""a"".""account_id"",EXTRACT(MONTH FROM ""a"".""day"") AS ""month"" FROM ""Transactions"" AS ""a"" LEFT JOIN ""Accounts"" AS ""b"" USING (""account_id"") GROUP BY ""a"".""account_id"",EXTRACT(MONTH FROM ""a"".""day"") HAVING SUM(CASE WHEN ""a"".""type""='creditor' THEN ""a"".""amount"" ELSE 0 END)>MAX(""b"".""max_income"")) SELECT DISTINCT ""x"".""account_id"" FROM ""cte"" AS ""x"" JOIN ""cte"" AS ""y"" ON ""x"".""account_id""=""y"".""account_id"" AND ""x"".""month""=""y"".""month""-1 ORDER BY ""x"".""account_id"""
139,"WITH ""CTE"" AS (SELECT ""t"".""account_id"",EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day"") AS ""month"",(CASE WHEN SUM(""amount"")>""a"".""max_income"" THEN 1 ELSE 0 END) AS ""exceed"" FROM ""Accounts"" AS ""a"" JOIN ""Transactions"" AS ""t"" USING (""account_id"") WHERE ""type""='Creditor' GROUP BY ""account_id"",""month"") SELECT DISTINCT ""c1"".""account_id"" FROM (""cte"" AS ""c1"") CROSS JOIN ""cte"" AS ""c2"" WHERE ""c1"".""account_id""=""c2"".""account_id"" AND ""c2"".""month""-""c1"".""month""=1 AND ""c1"".""exceed""=1 AND ""c2"".""exceed""=1"
140,"WITH ""tbl"" AS (SELECT ""t"".""account_id"",EXTRACT(YEAR_MONTH FROM ""day"") AS ""month"" FROM ""transactions"" AS ""t"" JOIN ""accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""t"".""type""='Creditor' GROUP BY 1,2 HAVING SUM(""t"".""amount"")>AVG(""a"".""max_income"")) SELECT DISTINCT ""t1"".""account_id"" FROM ""tbl"" AS ""t1"" JOIN ""tbl"" AS ""t2"" ON ""t1"".""month""-""t2"".""month""=1 AND ""t1"".""account_id""=""t2"".""account_id"""
141,"WITH ""cte"" AS (SELECT * FROM ""Accounts"" JOIN (SELECT ""account_id"",""day"",SUM(""amount"") AS ""tot"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",LEFT(""day"", 7)) AS ""t"" USING (""account_id"") HAVING ""tot"">""max_income"") SELECT DISTINCT ""a"".""account_id"" FROM (""cte"" AS ""a"") CROSS JOIN ""cte"" AS ""b"" WHERE ""a"".""account_id""=""b"".""account_id"" AND EXTRACT(YEAR FROM ""a"".""day"")=EXTRACT(YEAR FROM ""b"".""day"") AND EXTRACT(MONTH FROM ""a"".""day"")-EXTRACT(MONTH FROM ""b"".""day"")=1"
142,"WITH ""CET"" AS (SELECT ""T"".""account_id"",EXTRACT(MONTH FROM ""day"") AS ""DAY"",""max_income"" FROM ""Transactions"" AS ""T"" JOIN ""Accounts"" AS ""A"" ON ""T"".""account_id""=""A"".""account_id"" WHERE ""type""='Creditor' GROUP BY ""account_id"",EXTRACT(MONTH FROM ""day"") HAVING SUM(""amount"")>""A"".""max_income"") SELECT DISTINCT ""account_id"" FROM ""CET"" WHERE ROW(""account_id"",""DAY""-1) IN (SELECT ""account_id"",""DAY"" FROM ""CET"") OR ROW(""account_id"",""DAY""+1) IN (SELECT ""account_id"",""DAY"" FROM ""CET"")"
143,"WITH ""cte"" AS (SELECT ""a"".""account_id"" AS ""account_id"",""sub1"".""month"" AS ""month"",CASE WHEN ""sub1"".""total_income"">""a"".""max_income"" THEN 'y' ELSE 'n' END AS ""exceed"" FROM (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month"",SUM(""amount"") AS ""total_income"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY 1,2 ORDER BY 1,2) AS ""sub1"" LEFT JOIN ""Accounts"" AS ""a"" ON ""a"".""account_id""=""sub1"".""account_id""), ""exceed_table"" AS (SELECT ""account_id"",""month"",""exceed"",(""month""-RANK() OVER (PARTITION BY ""account_id"" ORDER BY ""month"")) AS ""rank_diff"" FROM ""cte"" WHERE ""exceed""='y') SELECT DISTINCT (""account_id"") FROM ""exceed_table"" GROUP BY ""account_id"",""rank_diff"" HAVING COUNT(1)>1"
144,"WITH ""temp"" AS (SELECT ""t"".""account_id"",TO_CHAR(""day"", 'YYYY%m') AS ""date"",SUM(""amount"") AS ""income"",""Accounts"".""max_income"" FROM ""Transactions"" AS ""t"" LEFT JOIN ""Accounts"" ON ""Accounts"".""account_id""=""t"".""account_id"" WHERE ""t"".""type""='Creditor' GROUP BY ""t"".""account_id"",TO_CHAR(""day"", 'YYYY%m') HAVING SUM(""amount"")>""Accounts"".""max_income"") SELECT ""t1"".""account_id"" FROM (""temp"" AS ""t1"") CROSS JOIN ""temp"" AS ""t2"" WHERE ""t1"".""account_id""=""t2"".""account_id"" AND PERIOD_DIFF(""t1"".""date"", ""t2"".""date"")=1 GROUP BY ""t1"".""account_id"" ORDER BY ""t1"".""account_id"""
145,"WITH ""t"" AS (SELECT ""account_id"",SUM(""amount"") AS ""income"",TO_CHAR(""day"", 'YYYY%m') AS ""date_month"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",""date_month"") SELECT DISTINCT ""t1"".""account_id"" FROM (""t"" AS ""t1"" JOIN ""t"" AS ""t2"" ON ""t1"".""account_id""=""t2"".""account_id"" AND PERIOD_DIFF(""t2"".""date_month"", ""t1"".""date_month"")=1) JOIN ""Accounts"" AS ""a"" ON ""t1"".""account_id""=""a"".""account_id"" WHERE ""t1"".""income"">""a"".""max_income"" AND ""t2"".""income"">""a"".""max_income"""
146,"SELECT DISTINCT ""account_id"" FROM (SELECT ""a"".""account_id"",""mth"",LAG(""mth"") OVER (PARTITION BY ""a"".""account_id"" ORDER BY ""t"".""mth"") AS ""lg"",LEAD(""mth"") OVER (PARTITION BY ""a"".""account_id"" ORDER BY ""t"".""mth"") AS ""ld"" FROM ""accounts"" AS ""a"" JOIN (SELECT ""account_id"",TO_CHAR(""day"", 'YYYY-%m-01') AS ""mth"",SUM(""amount"") AS ""amount"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",TO_CHAR(""day"", 'YYYY-%m-01')) AS ""t"" ON ""t"".""account_id""=""a"".""account_id"" AND ""t"".""amount"">""a"".""max_income"") AS ""a"" WHERE TIMESTAMPDIFF(MONTH, ""lg"", ""mth"")=1 OR TIMESTAMPDIFF(MONTH, ""mth"", ""ld"")=1"
147,"WITH ""cte"" AS (SELECT ""t"".""account_id"",TO_CHAR(""day"", '%m %y') AS ""month"",SUM(CASE WHEN ""type""='Creditor' THEN ""amount"" END) AS ""total_income"",""max_income"" FROM ""transactions"" AS ""t"" LEFT JOIN ""accounts"" AS ""a"" ON ""a"".""account_id""=""t"".""account_id"" GROUP BY ""t"".""account_id"",TO_CHAR(""day"", '%m %y')) SELECT DISTINCT ""cte1"".""account_id"" FROM ""cte"" AS ""cte1"" JOIN ""cte"" AS ""cte2"" ON ""cte1"".""account_id""=""cte2"".""account_id"" AND ""cte1"".""month""=""cte2"".""month""-1 WHERE ""cte1"".""total_income"">""cte1"".""max_income"" AND ""cte2"".""total_income"">""cte1"".""max_income"""
148,"WITH ""t"" AS (SELECT ""account_id"",MIN(""day"") AS ""day"" FROM ""Transactions"" JOIN ""Accounts"" USING (""account_id"") WHERE ""type""='Creditor' GROUP BY ""account_id"",TO_CHAR(""day"", 'YYYY-%m') HAVING SUM(""amount"")>MAX(""max_income"")) SELECT DISTINCT ""t1"".""account_id"" FROM ""t"" AS ""t1"" JOIN ""t"" AS ""t2"" ON ""t1"".""account_id""=""t2"".""account_id"" AND TO_CHAR(""t1"".""day"" + INTERVAL '1 MONTH', 'YYYY-%m')=TO_CHAR(""t2"".""day"", 'YYYY-%m')"
149,"WITH ""t"" AS (SELECT ""account_id"",SUM(""amount"") AS ""income"",TO_CHAR(""day"", 'YYYY%m') AS ""date_month"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",""date_month"") SELECT DISTINCT ""t1"".""account_id"" FROM (""t"" AS ""t1"" JOIN ""t"" AS ""t2"" ON ""t1"".""account_id""=""t2"".""account_id"" AND PERIOD_DIFF(""t2"".""date_month"", ""t1"".""date_month"")=1) LEFT JOIN ""Accounts"" AS ""a"" ON ""t1"".""account_id""=""a"".""account_id"" WHERE ""t1"".""income"">""a"".""max_income"" AND ""t2"".""income"">""a"".""max_income"""
150,"WITH ""cte"" AS (SELECT ""t"".""account_id"",EXTRACT(MONTH FROM ""day"") AS ""monthly"",SUM(""amount"") AS ""sum_income"",""max_income"" FROM ""Transactions"" AS ""t"" JOIN ""Accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""type""='Creditor' GROUP BY ""t"".""account_id"",EXTRACT(MONTH FROM ""day"") ORDER BY ""t"".""account_id"",EXTRACT(MONTH FROM ""day"")) SELECT DISTINCT ""c1"".""account_id"" FROM ""cte"" AS ""c1"" JOIN ""cte"" AS ""c2"" ON ""c1"".""account_id""=""c2"".""account_id"" AND ""c2"".""monthly""-""c1"".""monthly""=1 WHERE ""c1"".""sum_income"">""c1"".""max_income"" AND ""c2"".""sum_income"">""c2"".""max_income"""
151,"WITH ""cte"" AS (SELECT CONCAT(LEFT(""day"", 7), '-01') AS ""month"",""transaction_id"",""t"".""account_id"",SUM(CASE WHEN ""type""='Creditor' THEN ""amount"" ELSE 0 END) AS ""month_sum"",""max_income"" FROM ""transactions"" AS ""t"" JOIN ""accounts"" AS ""a"" ON ""a"".""account_id""=""t"".""account_id"" GROUP BY LEFT(""day"", 7),""t"".""account_id"" ORDER BY ""transaction_id"") SELECT DISTINCT ""t1"".""account_id"" FROM ""cte"" AS ""t1"" JOIN ""cte"" AS ""t2"" ON TIMESTAMPDIFF(MONTH, ""t1"".""month"", ""t2"".""month"")=1 AND ""t1"".""account_id""=""t2"".""account_id"" WHERE ""t1"".""month_sum"">""t1"".""max_income"" AND ""t2"".""month_sum"">""t2"".""max_income"""
152,"WITH ""accounts_and_transactions"" AS (SELECT ""a"".""account_id"" AS ""account_id"",""a"".""max_income"" AS ""max_income"",""t"".""amount"" AS ""amount"",TO_CHAR(""t"".""day"", 'YYYY-%m') AS ""month"" FROM ""Accounts"" AS ""a"" JOIN ""Transactions"" AS ""t"" ON ""a"".""account_id""=""t"".""account_id"" WHERE ""type""='Creditor') SELECT DISTINCT (""temp3"".""account_id"") AS ""account_id"" FROM (SELECT ""temp2"".""account_id"",CAST(""temp2"".""month"" AS INTEGER)-""rownumber"" AS ""grouping_variable"" FROM (SELECT ""temp"".""account_id"" AS ""account_id"",SUBSTR(""temp"".""month"", 6, 7) AS ""month"",ROW_NUMBER() OVER (PARTITION BY ""account_id"" ORDER BY ""month"") AS ""rownumber"" FROM (SELECT ""account_id"",""month"",""max_income"",SUM(""amount"") AS ""total_deposits"" FROM ""accounts_and_transactions"" GROUP BY 1,2,3 HAVING SUM(""amount"")>""max_income"") AS ""temp"") AS ""temp2"") AS ""temp3"" GROUP BY ""temp3"".""account_id"",""temp3"".""grouping_variable"" HAVING COUNT(1)>=2"
153,"WITH ""temp"" AS (SELECT ""t"".""account_id"",TO_CHAR(""day"", 'YYYY%m') AS ""date"",SUM(""amount"") AS ""income"",""Accounts"".""max_income"" FROM ""Transactions"" AS ""t"" LEFT JOIN ""Accounts"" ON ""Accounts"".""account_id""=""t"".""account_id"" WHERE ""t"".""type""='Creditor' GROUP BY ""t"".""account_id"",TO_CHAR(""day"", 'YYYY%m') HAVING SUM(""amount"")>""Accounts"".""max_income"") SELECT ""t1"".""account_id"" FROM (""temp"" AS ""t1"") CROSS JOIN ""temp"" AS ""t2"" WHERE ""t1"".""account_id""=""t2"".""account_id"" AND PERIOD_DIFF(""t1"".""date"", ""t2"".""date"")=1 GROUP BY ""t1"".""account_id"" ORDER BY ""t1"".""account_id"""
154,"WITH ""cte"" AS (SELECT ""account_id"",CONCAT(LEFT(""day"", 7), '-01') AS ""mth"",SUM(""amount"") AS ""total_amount"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY 1,2), ""sus"" AS (SELECT ""cte"".* FROM ""cte"" JOIN ""accounts"" AS ""t"" ON ""t"".""account_id""=""cte"".""account_id"" WHERE ""t"".""max_income""<""cte"".""total_amount""), ""cte_rank"" AS (SELECT ""account_id"",TIMESTAMPDIFF(MONTH, '2021-01-01', ""mth"") AS ""m"",ROW_NUMBER() OVER (PARTITION BY ""account_id"" ORDER BY ""mth"") AS ""drk"",TIMESTAMPDIFF(MONTH, '2021-01-01', ""mth"")*1.0-ROW_NUMBER() OVER (PARTITION BY ""account_id"" ORDER BY ""mth"") AS ""grp"" FROM ""sus"") SELECT DISTINCT ""account_id"" FROM ""cte_rank"" GROUP BY 1,""grp"" HAVING COUNT(1)>1 ORDER BY 1"
155,"WITH ""t1"" AS (SELECT ""account_id"",SUM(""amount"") AS ""total"",EXTRACT(MONTH FROM ""day"") AS ""month"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY 1,3), ""t2"" AS (SELECT ""t1"".""account_id"",""total"",""month"",LAG(""month"", 1) OVER (PARTITION BY ""account_id"" ORDER BY ""month"") AS ""num"" FROM ""t1"" JOIN ""Accounts"" AS ""a"" ON ""t1"".""account_id""=""a"".""account_id"" WHERE ""total"">""max_income"") SELECT DISTINCT ""t2"".""account_id"" FROM ""t2"" WHERE ""month""-""num""=1"
156,"SELECT DISTINCT ""t2"".""account_id"" FROM (SELECT ""t1"".""account_id"",""t1"".""total_amount"",""t1"".""tran_Month"",LAG(""t1"".""tran_Month"") OVER (PARTITION BY ""account_id"" ORDER BY ""t1"".""Tran_Month"") AS ""lag_tran_Month"" FROM (SELECT ""ACCOUNT_ID"",SUM(""AMOUNT"") AS ""total_amount"",EXTRACT(MONTH FROM ""day"") AS ""tran_Month"" FROM ""TRANSACTIONS"" WHERE ""TYPE""='Creditor' GROUP BY ""account_id"",""Tran_Month"") AS ""t1"" JOIN ""accounts"" AS ""a"" ON ""t1"".""account_id""=""a"".""account_id"" WHERE ""a"".""max_income""<""t1"".""total_amount"") AS ""t2"" WHERE ""t2"".""tran_Month""-""t2"".""lag_tran_Month""=1"
157,"SELECT DISTINCT ""account_id"" FROM (SELECT ""a"".""account_id"",""tot_income"".""month"",LEAD(""tot_income"".""month"", 1) OVER (PARTITION BY ""a"".""account_id"" ORDER BY ""tot_income"".""month"") AS ""next_month"" FROM (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month"",SUM(""amount"") AS ""total_income"" FROM ""transactions"" AS ""t"" WHERE ""type""='Creditor' GROUP BY ""account_id"",EXTRACT(MONTH FROM ""day"")) AS ""tot_income"" JOIN ""accounts"" AS ""a"" ON ""tot_income"".""account_id""=""a"".""account_id"" AND ""tot_income"".""total_income"">""a"".""max_income"") AS ""check_consecutive"" WHERE ABS(""next_month""-""month"")=1"
158,"WITH ""cte"" AS (SELECT ""a"".""account_id"" AS ""account_id"",""sub1"".""month"" AS ""month"",CASE WHEN ""sub1"".""total_income"">""a"".""max_income"" THEN 'y' ELSE 'n' END AS ""exceed"" FROM (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month"",SUM(""amount"") AS ""total_income"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY 1,2 ORDER BY 1,2) AS ""sub1"" LEFT JOIN ""Accounts"" AS ""a"" ON ""a"".""account_id""=""sub1"".""account_id""), ""exceed_table"" AS (SELECT ""account_id"",""month"",""exceed"",(""month""-RANK() OVER (PARTITION BY ""account_id"" ORDER BY ""month"")) AS ""rank_diff"" FROM ""cte"" WHERE ""exceed""='y') SELECT DISTINCT (""account_id"") FROM ""exceed_table"" GROUP BY ""account_id"",""rank_diff"" HAVING COUNT(1)>1"
159,"SELECT DISTINCT ""account_id"" FROM (SELECT ""d"".""account_id"",""d"".""month_year"" FROM (SELECT * FROM (SELECT ""b"".""account_id"",""b"".""month_year"",""b"".""deposit"",""a"".""max_income"" FROM (SELECT ""account_id"",""month_year"",SUM(CASE WHEN ""type""='Creditor' THEN ""amount"" ELSE 0 END) AS ""deposit"" FROM (SELECT *,CAST(CONCAT(LEFT(""day"", 7), '-01') AS DATE) AS ""month_year"" FROM ""Transactions"") AS ""a"" GROUP BY ""account_id"",""month_year"") AS ""b"" LEFT JOIN ""Accounts"" AS ""a"" ON ""a"".""account_id""=""b"".""account_id"") AS ""c"" WHERE ""deposit"">""max_income"") AS ""d"" CROSS, (SELECT * FROM (SELECT ""b"".""account_id"",""b"".""month_year"",""b"".""deposit"",""a"".""max_income"" FROM (SELECT ""account_id"",""month_year"",SUM(CASE WHEN ""type""='Creditor' THEN ""amount"" ELSE 0 END) AS ""deposit"" FROM (SELECT *,CAST(CONCAT(LEFT(""day"", 7), '-01') AS DATE) AS ""month_year"" FROM ""Transactions"") AS ""a"" GROUP BY ""account_id"",""month_year"") AS ""b"" LEFT JOIN ""Accounts"" AS ""a"" ON ""a"".""account_id""=""b"".""account_id"") AS ""c"" WHERE ""deposit"">""max_income"") AS ""d1"" WHERE ""d"".""account_id""=""d1"".""account_id"" AND ""d1"".""month_year"" + INTERVAL '1 MONTH'=""d"".""month_year"") AS ""c"" WHERE ""month_year"" IS NOT NULL"
160,"WITH ""incometable"" AS (SELECT ""a"".""account_id"",""a"".""max_income"",EXTRACT(YEAR FROM ""t"".""day"")*12+EXTRACT(MONTH FROM ""t"".""day"") AS ""month"",SUM(""amount"") AS ""totalincome"" FROM ""Accounts"" AS ""a"" LEFT JOIN ""Transactions"" AS ""t"" USING (""account_id"") WHERE ""type""='Creditor' GROUP BY ""a"".""account_id"",TO_CHAR(""t"".""day"", 'YYYY-%m')) SELECT DISTINCT ""t1"".""account_id"" FROM ""incometable"" AS ""t1"" JOIN ""incometable"" AS ""t2"" ON ""t1"".""account_id""=""t2"".""account_id"" AND ""t2"".""month""-""t1"".""month"" BETWEEN 0 AND 1 WHERE ""t1"".""max_income""<""t1"".""totalincome"" AND ""t2"".""max_income""<""t2"".""totalincome"" GROUP BY ""t1"".""account_id"",""t1"".""month"" HAVING COUNT(""t2"".""month"")>=2 ORDER BY ""t1"".""account_id"""
161,"WITH ""cte1"" AS (SELECT ""a"".""account_id"",(CASE WHEN SUM(""amount"")>""a"".""max_income"" THEN 1 ELSE 0 END) AS ""flag_val"",EXTRACT(MONTH FROM ""day"") AS ""created_month"" FROM ""Transactions"" AS ""t"" JOIN ""Accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""type""='Creditor' GROUP BY ""account_id"",EXTRACT(MONTH FROM ""day"") ORDER BY ""account_id"") SELECT DISTINCT ""c1"".""account_id"" FROM (""cte1"" AS ""c1"") CROSS JOIN ""cte1"" AS ""c2"" WHERE ""c1"".""account_id""=""c2"".""account_id"" AND ""c2"".""created_month""-""c1"".""created_month""=1 AND ""c1"".""flag_val""=1 AND ""c2"".""flag_val""=1"
162,"WITH ""CTE"" AS (SELECT ""account_id"",""day"",SUM(""amount"") AS ""amount"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",TO_CHAR(""day"", 'YYYY-%m') ORDER BY ""account_id"") SELECT DISTINCT ""tab"".""account_id"" FROM (SELECT ""t1"".""account_id"",TO_CHAR(""t1"".""day"", 'YYYY-%m') AS ""t1Date"",""t1"".""amount"" AS ""t1amount"",TO_CHAR(""t2"".""day"", 'YYYY-%m') AS ""t2Date"",""t2"".""amount"" AS ""t2amount"" FROM ""CTE"" AS ""t1"" JOIN ""CTE"" AS ""t2"" ON (""t1"".""account_id""=""t2"".""account_id"") AND (TO_CHAR(""t2"".""day"", 'YYYY-%m')=TO_CHAR(""t1"".""day"" + INTERVAL '1 MONTH', 'YYYY-%m'))) AS ""tab"" JOIN ""accounts"" ON ""accounts"".""account_id""=""tab"".""account_id"" WHERE (""tab"".""t1amount"">""accounts"".""max_income"") AND (""tab"".""t2amount"">""accounts"".""max_income"")"
163,"WITH ""CTE"" AS (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month"",SUM(""amount"") AS ""total_income"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",""month"" ORDER BY 1,2) SELECT DISTINCT ""a"".""account_id"" FROM (""Accounts"" AS ""a"" JOIN ""CTE"" AS ""c1"" ON ""a"".""account_id""=""c1"".""account_id"" AND ""a"".""max_income""<""c1"".""total_income"") JOIN ""CTE"" AS ""c2"" ON ""a"".""account_id""=""c2"".""account_id"" AND ""c1"".""month""=""c2"".""month""-1 AND ""a"".""max_income""<""c2"".""total_income"" ORDER BY 1"
164,"WITH ""temp"" AS (SELECT ""t"".""account_id"",TO_CHAR(""day"", 'YYYY%m') AS ""date"",SUM(""amount"") AS ""income"",""Accounts"".""max_income"" FROM ""Transactions"" AS ""t"" LEFT JOIN ""Accounts"" ON ""Accounts"".""account_id""=""t"".""account_id"" WHERE ""t"".""type""='Creditor' GROUP BY ""t"".""account_id"",TO_CHAR(""day"", 'YYYY%m') HAVING SUM(""amount"")>""Accounts"".""max_income"") SELECT ""t1"".""account_id"" FROM (""temp"" AS ""t1"") CROSS JOIN ""temp"" AS ""t2"" WHERE ""t1"".""account_id""=""t2"".""account_id"" AND PERIOD_DIFF(""t1"".""date"", ""t2"".""date"")=1 GROUP BY ""t1"".""account_id"" ORDER BY ""t1"".""account_id"""
165,"WITH ""trans1"" AS (SELECT ""account_id"",CONCAT(LEFT(""day"", 7), '-01') AS ""month"",SUM(""amount"") AS ""total"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY 1,2) SELECT DISTINCT ""a"".""account_id"" FROM (""trans1"" AS ""a"" JOIN ""trans1"" AS ""b"" ON ""a"".""account_id""=""b"".""account_id"" AND TIMESTAMPDIFF(MONTH, ""a"".""month"", ""b"".""month"")=1) JOIN ""accounts"" AS ""c"" ON ""a"".""account_id""=""c"".""account_id"" WHERE ""a"".""total"">""c"".""max_income"" AND ""b"".""total"">""c"".""max_income"""
166,"WITH ""cte"" AS (SELECT ""t"".""account_id"",EXTRACT(MONTH FROM ""t"".""day"") AS ""month"",CASE WHEN SUM(""t"".""amount"")>""a"".""max_income"" THEN 1 ELSE 0 END AS ""if_exceeds"" FROM ""Transactions"" AS ""t"" JOIN ""Accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""t"".""type""='Creditor' GROUP BY 1,2) SELECT DISTINCT ""c1"".""account_id"" FROM (""cte"" AS ""c1"") CROSS JOIN ""cte"" AS ""c2"" WHERE ""c1"".""account_id""=""c2"".""account_id"" AND ""c1"".""month""-""c2"".""month""=1 AND ""c1"".""if_exceeds""=1 AND ""c2"".""if_exceeds""=1"
167,"WITH ""t1"" AS (SELECT ""account_id"",SUM(""amount"") AS ""total"",EXTRACT(MONTH FROM ""day"") AS ""month"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY 1,3), ""t2"" AS (SELECT ""t1"".""account_id"",""total"",""month"",LAG(""month"", 1) OVER (PARTITION BY ""account_id"" ORDER BY ""month"") AS ""num"" FROM ""t1"" JOIN ""Accounts"" AS ""a"" ON ""t1"".""account_id""=""a"".""account_id"" WHERE ""total"">""max_income"") SELECT DISTINCT ""t2"".""account_id"" FROM ""t2"" WHERE ""month""-""num""=1"
168,"WITH ""CTE"" AS (SELECT ""account_id"",""day"",SUM(""amount"") AS ""amount"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",TO_CHAR(""day"", 'YYYY-%m') ORDER BY ""account_id"") SELECT DISTINCT ""tab"".""account_id"" FROM (SELECT ""t1"".""account_id"",""t1"".""amount"" AS ""t1amount"",""t2"".""amount"" AS ""t2amount"" FROM ""CTE"" AS ""t1"" JOIN ""CTE"" AS ""t2"" ON (""t1"".""account_id""=""t2"".""account_id"") AND (TO_CHAR(""t2"".""day"", 'YYYY-%m')=TO_CHAR(""t1"".""day"" + INTERVAL '1 MONTH', 'YYYY-%m'))) AS ""tab"" JOIN ""accounts"" ON ""accounts"".""account_id""=""tab"".""account_id"" WHERE (""tab"".""t1amount"">""accounts"".""max_income"") AND (""tab"".""t2amount"">""accounts"".""max_income"")"
169,"WITH ""total_income"" AS (SELECT ""account_id"",SUM(""amount"") AS ""t_income"",EXTRACT(MONTH FROM ""day"") AS ""t_date"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",LEFT(""day"", 7) ORDER BY ""account_id"",LEFT(""day"", 7)) SELECT DISTINCT ""t"".""account_id"" FROM (SELECT ""ti"".""account_id"",""ti"".""t_date"",""ti"".""t_date""-ROW_NUMBER() OVER (PARTITION BY ""ti"".""account_id"" ORDER BY ""ti"".""t_date"") AS ""rnk"" FROM ""total_income"" AS ""ti"" LEFT JOIN ""Accounts"" AS ""a"" ON ""ti"".""account_id""=""a"".""account_id"" WHERE ""ti"".""t_income"">""max_income"") AS ""t"" GROUP BY ""t"".""account_id"",""t"".""rnk"" HAVING COUNT(""t"".""account_id"")>=2"
170,"WITH ""A"" AS (SELECT ""account_id"",TO_CHAR(""day"", 'YYYY%m') AS ""month"",SUM(""amount"") AS ""income"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY 1,2), ""B"" AS (SELECT ""a"".""account_id"",""month"",""income"",""max_income"" FROM ""A"" AS ""a"" JOIN ""Accounts"" AS ""b"" USING (""account_id"") WHERE ""max_income""<""income"") SELECT DISTINCT ""a"".""account_id"" FROM ""B"" AS ""a"" JOIN ""B"" AS ""b"" ON ""a"".""account_id""=""b"".""account_id"" AND ABS(PERIOD_DIFF(""b"".""month"", ""a"".""month""))=1 ORDER BY 1"
171,"WITH ""tmp"" AS (SELECT ""account_id"",LEFT(""day"", 4) AS ""year"",EXTRACT(MONTH FROM ""day"") AS ""day"",SUM(""amount"") AS ""amount"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY 1,2,3 ORDER BY 1) SELECT DISTINCT ""a"".""account_id"" FROM (""tmp"" AS ""a"" JOIN ""Accounts"" AS ""c"" ON ""a"".""account_id""=""c"".""account_id"" AND ""a"".""amount"">""c"".""max_income"") JOIN ""tmp"" AS ""b"" ON ""b"".""account_id""=""c"".""account_id"" AND ""b"".""amount"">""c"".""max_income"" AND ""b"".""day""=""a"".""day""+1"
172,"WITH ""A"" AS (SELECT ""account_id"",EXTRACT(YEAR FROM ""day"") AS ""dt_year"",EXTRACT(MONTH FROM ""day"") AS ""dt_month"",SUM(""amount"") AS ""amt"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",EXTRACT(YEAR FROM ""day""),EXTRACT(MONTH FROM ""day"")), ""B"" AS (SELECT ""A"".""account_id"",""A"".""dt_year"",""A"".""dt_month"",""A"".""amt"">""T"".""max_income"" AS ""red_flag"" FROM ""A"" JOIN ""Accounts"" AS ""T"" ON ""A"".""account_id""=""T"".""account_id""), ""C"" AS (SELECT ""account_id"",""dt_year"",""dt_month"",""red_flag"",LAG(""dt_month"") OVER (PARTITION BY ""account_id"" ORDER BY ""dt_year"",""dt_month"") AS ""prev_dt_month"",LAG(""red_flag"") OVER (PARTITION BY ""account_id"" ORDER BY ""dt_year"",""dt_month"") AS ""prev_red_flag"" FROM ""B"") SELECT DISTINCT ""C"".""account_id"" FROM ""C"" WHERE ""C"".""red_flag""=1 AND ""C"".""prev_red_flag"" IS NOT NULL AND ""C"".""prev_red_flag""=1 AND ""C"".""prev_dt_month"" IS NOT NULL AND ""C"".""dt_month""-""C"".""prev_dt_month""=1"
173,"WITH ""cte"" AS (SELECT ""t"".""account_id"",EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day"") AS ""month"",(CASE WHEN SUM(""amount"")>""a"".""max_income"" THEN 1 ELSE 0 END) AS ""exceed"" FROM ""transactions"" AS ""t"" JOIN ""accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""type""='Creditor' GROUP BY EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day""),""t"".""account_id"") SELECT DISTINCT ""c1"".""account_id"" FROM (""cte"" AS ""c1"") CROSS JOIN ""cte"" AS ""c2"" WHERE ""c1"".""account_id""=""c2"".""account_id"" AND ""c2"".""month""-""c1"".""month""=1 AND ""c1"".""exceed""=1 AND ""c2"".""exceed""=1"
174,"WITH ""CTE"" AS (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month"",SUM(""amount"") AS ""total_income"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",""month"" ORDER BY 1,2) SELECT DISTINCT ""a"".""account_id"" FROM (""Accounts"" AS ""a"" JOIN ""CTE"" AS ""c1"" ON ""a"".""account_id""=""c1"".""account_id"" AND ""a"".""max_income""<""c1"".""total_income"") JOIN ""CTE"" AS ""c2"" ON ""a"".""account_id""=""c2"".""account_id"" AND ""c1"".""month""=""c2"".""month""-1 AND ""a"".""max_income""<""c2"".""total_income"" ORDER BY 1"
175,"WITH ""CTE"" AS (SELECT ""T"".""account_id"",EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day"") AS ""month"",CASE WHEN SUM(""amount"")>""A"".""max_income"" THEN 1 ELSE 0 END AS ""exceed"" FROM ""transactions"" AS ""T"" JOIN ""accounts"" AS ""A"" ON ""T"".""account_id""=""A"".""account_id"" WHERE ""type""='Creditor' GROUP BY EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day""),""T"".""account_id"") SELECT DISTINCT ""C1"".""account_id"" FROM (""CTE"" AS ""C1"") CROSS JOIN ""CTE"" AS ""C2"" WHERE ""C1"".""account_id""=""C2"".""account_id"" AND ""C2"".""month""-""C1"".""month""=1 AND ""C1"".""exceed""=1 AND ""C2"".""exceed""=1"
176,"WITH ""cte"" AS (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month"",SUM(""amount"") AS ""total"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",EXTRACT(MONTH FROM ""day"")), ""c2"" AS (SELECT ""cte"".""account_id"",""max_income"",""total"",LEAD(""total"", 1) OVER (PARTITION BY ""cte"".""account_id"" ORDER BY ""month"") AS ""nxt"",""month"",LEAD(""month"", 1) OVER (PARTITION BY ""cte"".""account_id"" ORDER BY ""month"") AS ""nxtmonth"" FROM ""cte"" LEFT JOIN ""accounts"" AS ""a"" ON ""a"".""account_id""=""cte"".""account_id"") SELECT DISTINCT ""account_id"" FROM ""c2"" WHERE ""total"">""max_income"" AND ""nxt"">""max_income"" AND ""nxtmonth""-""month""=1"
177,"WITH ""A"" AS (SELECT ""account_id"",LEFT(""day"", 7) AS ""month"",SUM(""amount"") AS ""income"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY 1,2), ""B"" AS (SELECT ""a"".""account_id"",""month"",""income"",""max_income"" FROM ""A"" AS ""a"" JOIN ""Accounts"" AS ""b"" USING (""account_id"") WHERE ""max_income""<""income"") SELECT DISTINCT ""a"".""account_id"" FROM ""B"" AS ""a"" JOIN ""B"" AS ""b"" ON ""a"".""account_id""=""b"".""account_id"" AND LEFT(""a"".""month"", 4)=LEFT(""b"".""month"", 4) AND SUBSTRING(""a"".""month"", 6, 2)=SUBSTRING(""b"".""month"", 6, 2)-1 ORDER BY 1"
178,"WITH ""CTE"" AS (SELECT ""account_id"",""day"",SUM(""amount"") AS ""amount"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",TO_CHAR(""day"", 'YYYY-%m') ORDER BY ""account_id"") SELECT DISTINCT ""tab"".""account_id"" FROM (SELECT ""t1"".""account_id"",TO_CHAR(""t1"".""day"", 'YYYY-%m') AS ""t1Date"",""t1"".""amount"" AS ""t1amount"",TO_CHAR(""t2"".""day"", 'YYYY-%m') AS ""t2Date"",""t2"".""amount"" AS ""t2amount"" FROM ""CTE"" AS ""t1"" JOIN ""CTE"" AS ""t2"" ON (""t1"".""account_id""=""t2"".""account_id"") AND (TO_CHAR(""t2"".""day"", 'YYYY-%m')=TO_CHAR(""t1"".""day"" + INTERVAL '1 MONTH', 'YYYY-%m'))) AS ""tab"" JOIN ""accounts"" ON ""accounts"".""account_id""=""tab"".""account_id"" WHERE (""tab"".""t1amount"">""accounts"".""max_income"") AND (""tab"".""t2amount"">""accounts"".""max_income"")"
179,"WITH ""t"" AS (SELECT ""account_id"",CONCAT(LEFT(""day"", 7), '-01') AS ""month"",SUM(""amount"") AS ""sum_amt"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",""month"") SELECT DISTINCT ""account_id"" FROM (SELECT ""t"".""account_id"",""t"".""month"" AS ""curr_m"",""t"".""sum_amt"" AS ""curr_amt"",""t1"".""month"" AS ""next_m"",""t1"".""sum_amt"" AS ""next_amt"" FROM ""t"" LEFT JOIN ""t"" AS ""t1"" ON ""t"".""account_id""=""t1"".""account_id"" AND ""t"".""month"" + INTERVAL '1 MONTH'=""t1"".""month"") AS ""t"" WHERE ""curr_amt"">(SELECT ""max_income"" FROM ""Accounts"" WHERE ""account_id""=""t"".""account_id"") AND ""next_amt"">(SELECT ""max_income"" FROM ""Accounts"" WHERE ""account_id""=""t"".""account_id"")"
180,"SELECT DISTINCT ""a"".""account_id"" FROM ((SELECT LEFT(""day"", 4)*100+RIGHT(LEFT(""day"", 7), 2) AS ""month"",""account_id"",SUM(CASE WHEN ""type""='Creditor' THEN ""amount"" ELSE 0 END) AS ""total_income"" FROM ""transactions"" GROUP BY ""month"",""account_id"") AS ""a"" CROSS, (SELECT LEFT(""day"", 4)*100+RIGHT(LEFT(""day"", 7), 2) AS ""month"",""account_id"",SUM(CASE WHEN ""type""='Creditor' THEN ""amount"" ELSE 0 END) AS ""total_income"" FROM ""transactions"" GROUP BY ""month"",""account_id"") AS ""b"") CROSS JOIN ""accounts"" AS ""c"" WHERE ""b"".""month""-""a"".""month""=1 AND ""b"".""total_income"">""c"".""max_income"" AND ""a"".""account_id""=""c"".""account_id"" AND ""a"".""account_id""=""b"".""account_id"" AND ""a"".""total_income"">""c"".""max_income"" GROUP BY ""a"".""account_id"",""a"".""month"" HAVING COUNT(""b"".""account_id"")=1"
181,"WITH ""t"" AS (SELECT ""account_id"",MIN(""day"") AS ""day"" FROM ""Transactions"" JOIN ""Accounts"" USING (""account_id"") WHERE ""type""='Creditor' GROUP BY ""account_id"",TO_CHAR(""day"", 'YYYY-%m') HAVING SUM(""amount"")>MAX(""max_income"")) SELECT DISTINCT ""t1"".""account_id"" FROM ""t"" AS ""t1"" JOIN ""t"" AS ""t2"" ON ""t1"".""account_id""=""t2"".""account_id"" AND CASE WHEN EXTRACT(MONTH FROM ""t1"".""day"")!=12 THEN EXTRACT(MONTH FROM ""t1"".""day"" + INTERVAL '1 MONTH')=EXTRACT(MONTH FROM ""t2"".""day"") AND EXTRACT(YEAR FROM ""t1"".""day"")=EXTRACT(YEAR FROM ""t2"".""day"") ELSE EXTRACT(MONTH FROM ""t1"".""day"" + INTERVAL '1 MONTH')=EXTRACT(MONTH FROM ""t2"".""day"") AND EXTRACT(YEAR FROM ""t1"".""day"")+1=EXTRACT(YEAR FROM ""t2"".""day"") END"
182,"WITH ""income"" AS (SELECT ""a"".""account_id"",(EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day"")) AS ""yearmonth"",SUM(CASE WHEN ""type""='Creditor' THEN ""amount"" ELSE 0 END) AS ""total_income"",""max_income"" FROM ""Accounts"" AS ""a"" JOIN ""Transactions"" AS ""t"" USING (""account_id"") GROUP BY 1,2 ORDER BY 1,2) SELECT DISTINCT ""p1"".""account_id"" FROM ""income"" AS ""p1"" JOIN ""income"" AS ""p2"" ON ""p1"".""yearmonth""=""p2"".""yearmonth""-1 AND ""p1"".""account_id""=""p2"".""account_id"" WHERE ""p1"".""total_income"">""p1"".""max_income"" AND ""p2"".""total_income"">""p2"".""max_income"""
183,"WITH ""temp"" AS (SELECT ""t"".""account_id"",TO_CHAR(""day"", 'YYYY-%m') AS ""y_m"",EXTRACT(MONTH FROM ""day"") AS ""m"",EXTRACT(YEAR FROM ""day"") AS ""y"",SUM(""amount"") AS ""tot_cred"",""max_income"" FROM ""transactions"" AS ""t"" JOIN ""accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""type""='Creditor' GROUP BY 1,2) SELECT DISTINCT ""t1"".""account_id"" FROM ""temp"" AS ""t1"" JOIN ""temp"" AS ""t2"" ON ""t1"".""account_id""=""t2"".""account_id"" AND ""t1"".""m""=""t2"".""m""+1 AND ""t1"".""y""=""t2"".""y"" WHERE ""t1"".""tot_cred"">""t1"".""max_income"" AND ""t2"".""tot_cred"">""t2"".""max_income"""
184,"WITH ""cte"" AS (SELECT ""account_id"",""amount"",EXTRACT(MONTH FROM ""day"") AS ""month"" FROM ""transactions"" WHERE ""type""='Creditor'), ""cte1"" AS (SELECT ""account_id"",SUM(""amount"") AS ""tot_amount"",""month"" FROM ""cte"" GROUP BY ""account_id"",""month""), ""cte2"" AS (SELECT ""cte1"".""account_id"",""month"" FROM ""cte1"" JOIN ""accounts"" AS ""a"" ON ""cte1"".""account_id""=""a"".""account_id"" WHERE ""tot_amount"">""max_income"" ORDER BY ""cte1"".""account_id"",""month"") SELECT DISTINCT ""account_id"" FROM (SELECT ""account_id"",""month""-ROW_NUMBER() OVER (PARTITION BY ""account_id"" ORDER BY ""month"") AS ""diff"" FROM ""cte2"") AS ""sub1"" GROUP BY ""account_id"",""diff"" HAVING COUNT(1)>=2 ORDER BY ""account_id"""
185,"WITH ""monthly"" AS (SELECT ""account_id"",TO_CHAR(""day"", '%m-YYYY') AS ""Month"",SUM(CASE WHEN ""type""='Creditor' THEN ""amount"" ELSE 0 END) AS ""deposits"" FROM ""Transactions"" GROUP BY 1,2), ""flagged_months"" AS (SELECT ""a"".""account_id"",""Month"",CASE WHEN ""deposits"">""max_income"" THEN 1 ELSE 0 END AS ""flagged"" FROM ""Accounts"" AS ""a"" JOIN ""monthly"" AS ""m"" ON ""a"".""account_id""=""m"".""account_id"" WHERE ""deposits""!=0), ""cons_flagged"" AS (SELECT ""account_id"",""Month"",SUBSTRING(""Month"", 1, 2) AS ""mm"",""flagged"",LEAD(""flagged"") OVER (PARTITION BY ""account_id"" ORDER BY ""Month"") AS ""next_flagged"",LEAD(""Month"") OVER (PARTITION BY ""account_id"" ORDER BY ""Month"") AS ""next_month"" FROM ""flagged_months"") SELECT DISTINCT ""account_id"" FROM ""cons_flagged"" WHERE ""flagged""=1 AND ""next_flagged""=1 AND ABS(""Month""-""next_month"")=1 ORDER BY 1"
186,"WITH ""CTE"" AS (SELECT ""account_id"",""day"",SUM(""amount"") AS ""amount"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",TO_CHAR(""day"", 'YYYY-%m') ORDER BY ""account_id"") SELECT DISTINCT ""tab"".""account_id"" FROM (SELECT ""t1"".""account_id"",TO_CHAR(""t1"".""day"", 'YYYY-%m') AS ""t1Date"",""t1"".""amount"" AS ""t1amount"",TO_CHAR(""t2"".""day"", 'YYYY-%m') AS ""t2Date"",""t2"".""amount"" AS ""t2amount"" FROM ""CTE"" AS ""t1"" JOIN ""CTE"" AS ""t2"" ON (""t1"".""account_id""=""t2"".""account_id"") AND (TO_CHAR(""t2"".""day"", 'YYYY-%m')=TO_CHAR(""t1"".""day"" + INTERVAL '1 MONTH', 'YYYY-%m'))) AS ""tab"" JOIN ""accounts"" ON ""accounts"".""account_id""=""tab"".""account_id"" WHERE (""tab"".""t1amount"">""accounts"".""max_income"") AND (""tab"".""t2amount"">""accounts"".""max_income"")"
187,"WITH ""t"" AS (SELECT ""account_id"",TO_CHAR(""day"", '%m') AS ""month"",SUM(""amount"") AS ""total"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY 1,2) SELECT DISTINCT ""t1"".""account_id"" FROM ((""Accounts"" AS ""a"") CROSS JOIN ""t"" AS ""t1"") CROSS JOIN ""t"" AS ""t2"" WHERE ""a"".""account_id""=""t1"".""account_id"" AND ""a"".""account_id""=""t2"".""account_id"" AND ""t1"".""month""+1=""t2"".""month"" AND ""t1"".""total"">""max_income"" AND ""t2"".""total"">""max_income"""
188,"WITH ""incometable"" AS (SELECT ""t"".""account_id"",EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day"") AS ""month"",SUM(CASE WHEN ""type""='Creditor' THEN ""amount"" END) AS ""income"",""max_income"" FROM ""accounts"" AS ""a"" JOIN ""transactions"" AS ""t"" ON ""a"".""account_id""=""t"".""account_id"" GROUP BY ""t"".""account_id"",TO_CHAR(""day"", 'YYYY-%M') ORDER BY ""t"".""account_id"",""month"") SELECT DISTINCT ""i1"".""account_id"" FROM ""incometable"" AS ""i1"" JOIN ""incometable"" AS ""i2"" ON ""i1"".""account_id""=""i2"".""account_id"" AND (""i2"".""month""-""i1"".""month""=1 OR ""i2"".""month""-""i1"".""month""=-1) WHERE ""i1"".""income"">""i1"".""max_income"" AND ""i2"".""income"">""i2"".""max_income"""
189,"WITH ""CTE"" AS (SELECT ""account_id"",""day"",SUM(""amount"") AS ""amount"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",TO_CHAR(""day"", 'YYYY-%m') ORDER BY ""account_id"") SELECT DISTINCT ""tab"".""account_id"" FROM (SELECT ""t1"".""account_id"",TO_CHAR(""t1"".""day"", 'YYYY-%m') AS ""t1Date"",""t1"".""amount"" AS ""t1amount"",TO_CHAR(""t2"".""day"", 'YYYY-%m') AS ""t2Date"",""t2"".""amount"" AS ""t2amount"" FROM ""CTE"" AS ""t1"" JOIN ""CTE"" AS ""t2"" ON (""t1"".""account_id""=""t2"".""account_id"") AND (TO_CHAR(""t2"".""day"", 'YYYY-%m')=TO_CHAR(""t1"".""day"" + INTERVAL '1 MONTH', 'YYYY-%m'))) AS ""tab"" JOIN ""accounts"" ON ""accounts"".""account_id""=""tab"".""account_id"" WHERE (""tab"".""t1amount"">""accounts"".""max_income"") AND (""tab"".""t2amount"">""accounts"".""max_income"")"
190,"WITH ""T1"" AS (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month"",SUM(CASE WHEN ""type""='Creditor' THEN ""amount"" ELSE 0 END) AS ""total_income"" FROM ""Transactions"" GROUP BY ""account_id"",EXTRACT(MONTH FROM ""day"")), ""T2"" AS (SELECT ""T1"".""account_id"",""month"",""total_income"",""max_income"" FROM ""T1"" LEFT JOIN ""Accounts"" ON ""Accounts"".""account_id""=""T1"".""account_id"" WHERE ""total_income"">""max_income"") SELECT DISTINCT ""account_id"" FROM (SELECT ""account_id"",""month"",LEAD(""month"") OVER (PARTITION BY ""account_id"" ORDER BY ""month"" DESC) AS ""month2"" FROM ""T2"") AS ""T3"" WHERE ""month""-""month2""=1"
191,"WITH ""temp"" AS (SELECT ""account_id"",LEFT(""day"", 7) AS ""month"",SUM(""amount"") AS ""s"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",LEFT(""day"", 7)) SELECT DISTINCT ""t1"".""account_id"" FROM (""temp"" AS ""t1"" JOIN ""temp"" AS ""t2"" ON ""t1"".""account_id""=""t2"".""account_id"" AND (RIGHT(""t1"".""month"", 2)+1=RIGHT(""t2"".""month"", 2) OR (RIGHT(""t1"".""month"", 2)=12 AND RIGHT(""t2"".""month"", 2)='01' AND LEFT(""t1"".""month"", 4)+1=LEFT(""t2"".""month"", 4)))) JOIN ""accounts"" AS ""a"" ON ""a"".""account_id""=""t1"".""account_id"" WHERE ""t1"".""s"">""max_income"" AND ""t2"".""s"">""max_income"""
192,"WITH ""table1"" AS (SELECT ""account_id"",SUM(""amount"") AS ""total_amount"",EXTRACT(MONTH FROM ""day"") AS ""month"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",""month""), ""table2"" AS (SELECT ""account_id"",""total_amount"",""max_income"",""month"",COALESCE(LEAD(""month"") OVER (PARTITION BY ""account_id"" ORDER BY ""month""), 0) AS ""lead_month"" FROM ""table1"" JOIN ""Accounts"" USING (""account_id"") WHERE ""total_amount"">""max_income"") SELECT DISTINCT ""account_id"" FROM ""table2"" WHERE ""lead_month""-""month""=1"
193,"WITH ""A"" AS (SELECT ""account_id"",EXTRACT(YEAR FROM ""day"") AS ""year_col"",EXTRACT(MONTH FROM ""day"") AS ""mon_col"",SUM(""amount"") AS ""total_income"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",""year_col"",""mon_col""), ""B"" AS (SELECT ""A"".""account_id"",""A"".""year_col"",""A"".""mon_col"",""A"".""total_income"" FROM ""A"" JOIN ""Accounts"" ON ""A"".""account_id""=""Accounts"".""account_id"" AND ""A"".""total_income"">""Accounts"".""max_income"") SELECT DISTINCT ""B1"".""account_id"" FROM ""B"" AS ""B1"" LEFT JOIN ""B"" AS ""B2"" ON ""B1"".""account_id""=""B2"".""account_id"" WHERE 12*(""B1"".""year_col""-""B2"".""year_col"")+""B1"".""mon_col""-""B2"".""mon_col""=1 ORDER BY ""B1"".""account_id"""
194,"WITH ""T1"" AS (SELECT ""account_id"",TO_CHAR(""day"", 'YYYY-%m') AS ""dt"",SUM(""amount"") AS ""amt"",MAX(""transaction_id"") AS ""tid"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY 1,2) SELECT DISTINCT ""account_id"" FROM (SELECT ""T1"".""account_id"",""T1"".""dt"",""T1"".""tid"",LAG(""T1"".""dt"", 1) OVER (PARTITION BY ""T1"".""account_id"" ORDER BY ""T1"".""dt"") AS ""dt2"" FROM ""Accounts"" AS ""A"" JOIN ""T1"" ON ""A"".""account_id""=""T1"".""account_id"" WHERE ""T1"".""amt"">""A"".""max_income"") AS ""T2"" WHERE RIGHT(""T2"".""dt"", 2)-RIGHT(""T2"".""dt2"", 2)=1 AND LEFT(""T2"".""dt2"", 4)=LEFT(""T2"".""dt"", 4) ORDER BY ""T2"".""tid"""
195,"WITH ""final"" AS (WITH ""consolidated"" AS (WITH ""cte"" AS (SELECT ""a"".""max_income"",""t"".""transaction_id"",""t"".""account_id"",""t"".""type"",""t"".""amount"",LEFT(""t"".""day"", 10) AS ""day"" FROM ""Accounts"" AS ""a"" JOIN ""Transactions"" AS ""t"" ON ""a"".""account_id""=""t"".""account_id"" WHERE ""type""='Creditor') SELECT ""max_income"",""account_id"",SUM(""amount"") AS ""total_credited"",""day"" FROM ""cte"" GROUP BY ""account_id"",LEFT(""day"", 7) ORDER BY ""account_id"",""day"") SELECT ""account_id"",""day"" FROM ""consolidated"" WHERE ""max_income""<""total_credited"") SELECT ""f1"".""account_id"" FROM ""final"" AS ""f1"" JOIN ""final"" AS ""f2"" ON ""f1"".""account_id""=""f2"".""account_id"" AND EXTRACT(MONTH FROM ""f2"".""day"")-EXTRACT(MONTH FROM ""f1"".""day"")=1 GROUP BY ""f1"".""account_id"" HAVING COUNT(""f1"".""account_id"")>=1"
196,"WITH ""cte"" AS (SELECT ""t"".""account_id"",TO_CHAR(""t"".""day"", 'YYYY-%m') AS ""month"",SUM(CASE WHEN ""t"".""type""='Creditor' THEN ""t"".""amount"" ELSE 0 END) AS ""income"",""a"".""max_income"",""t"".""transaction_id"",EXTRACT(MONTH FROM ""t"".""day"") AS ""m"" FROM ""Transactions"" AS ""t"" JOIN ""Accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" GROUP BY ""t"".""account_id"",""month"" HAVING ""income"">""a"".""max_income"") SELECT DISTINCT ""a"".""account_id"" FROM ""cte"" AS ""a"" JOIN ""cte"" AS ""b"" ON ""a"".""account_id""=""b"".""account_id"" AND ""a"".""m""=""b"".""m""+1 ORDER BY ""a"".""transaction_id"""
197,"SELECT ""c"".""account_id"" FROM (SELECT ""a"".""account_id"",""a"".""yymm"" AS ""current_month"",""a"".""total_income"",LEAD(""a"".""yymm"") OVER (PARTITION BY ""a"".""account_id"" ORDER BY ""a"".""yymm"") AS ""nex_month"",LEAD(""a"".""total_income"") OVER (PARTITION BY ""a"".""account_id"" ORDER BY ""yymm"") AS ""nex_month_income"",""b"".""max_income"" FROM (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""yymm"",SUM(""amount"") AS ""total_income"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY 1,2) AS ""a"" LEFT JOIN ""accounts"" AS ""b"" ON ""a"".""account_id""=""b"".""account_id"" WHERE ""a"".""total_income"">""b"".""max_income"") AS ""c"" WHERE ""c"".""nex_month""-""c"".""current_month""=1 GROUP BY 1"
198,"WITH ""cte1"" AS (SELECT ""account_id"",EXTRACT(YEAR_MONTH FROM ""day"") AS ""month"",SUM(""amount"") AS ""total"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",EXTRACT(YEAR_MONTH FROM ""day"")), ""cte2"" AS (SELECT ""c1"".""account_id"",""c1"".""total"",""c2"".""total"" AS ""next_total"" FROM ""cte1"" AS ""c1"" JOIN ""cte1"" AS ""c2"" ON ""c1"".""account_id""=""c2"".""account_id"" AND PERIOD_DIFF(""c2"".""month"", ""c1"".""month"")=1) SELECT DISTINCT ""account_id"" FROM ""accounts"" NATURAL CROSS JOIN ""cte2"" WHERE ""total"">""max_income"" AND ""next_total"">""max_income"" ORDER BY 1"
199,"WITH ""temp"" AS (SELECT ""t"".""account_id"",EXTRACT(YEAR_MONTH FROM ""day"") AS ""date"",SUM(""t"".""amount"") AS ""income"",""a"".""max_income"" FROM ""Transactions"" AS ""t"" JOIN ""Accounts"" AS ""a"" ON ""a"".""account_id""=""t"".""account_id"" WHERE ""t"".""type""='Creditor' GROUP BY ""t"".""account_id"",EXTRACT(YEAR_MONTH FROM ""day"") HAVING SUM(""amount"")>""a"".""max_income"") SELECT ""t1"".""account_id"" FROM ""temp"" AS ""t1"" JOIN ""temp"" AS ""t2"" ON ""t1"".""account_id""=""t2"".""account_id"" AND (""t1"".""date""-""t2"".""date"")=1 GROUP BY ""t1"".""account_id"" ORDER BY ""t1"".""account_id"""
200,"SELECT DISTINCT ""account_id"" FROM (SELECT ""group1"",""account_id"",COUNT(""month_last_day"") FROM (SELECT ""account_id"",LAST_DAY(""month_last_day"" + INTERVAL '-""rnk"" MONTH') AS ""group1"",""month_last_day"" FROM (SELECT ""month_last_day"",""TBL"".""account_id"",DENSE_RANK() OVER (PARTITION BY ""TBL"".""account_id"" ORDER BY ""month_last_day"") AS ""rnk"" FROM (SELECT LAST_DAY(""day"") AS ""month_last_day"",""account_id"",SUM(""amount"") AS ""total_income"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY 1,2) AS ""TBL"" JOIN ""Accounts"" AS ""A"" ON ""TBL"".""account_id""=""A"".""account_id"" AND ""TBL"".""total_income"">""A"".""max_income"") AS ""TBL2"") AS ""TBL3"" GROUP BY 1,2 HAVING COUNT(""month_last_day"")>=2) AS ""TBL4"""
201,"WITH ""cte"" AS (SELECT ""account_id"",SUM(""amount"") AS ""amt"",EXTRACT(MONTH FROM ""day"") AS ""month"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY 1,3), ""cte1"" AS (SELECT ""accounts"".""account_id"",""month"",LAG(""month"", 1) OVER (PARTITION BY ""account_id"" ORDER BY ""month"") AS ""num"" FROM ""cte"" JOIN ""accounts"" USING (""account_id"") WHERE ""amt"">""max_income"") SELECT DISTINCT ""account_id"" FROM ""cte1"" WHERE ""month""-""num""=1 ORDER BY 1"
202,"WITH ""t"" AS (SELECT ""account_id"",SUM(""amount"") AS ""income"",TO_CHAR(""day"", 'YYYY%m') AS ""date_month"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",""date_month"") SELECT DISTINCT ""t1"".""account_id"" FROM (""t"" AS ""t1"" JOIN ""t"" AS ""t2"" ON ""t1"".""account_id""=""t2"".""account_id"" AND PERIOD_DIFF(""t2"".""date_month"", ""t1"".""date_month"")=1) LEFT JOIN ""Accounts"" AS ""a"" ON ""t1"".""account_id""=""a"".""account_id"" WHERE ""t1"".""income"">""a"".""max_income"" AND ""t2"".""income"">""a"".""max_income"""
203,"WITH ""cte"" AS (SELECT ""account_id"",SUM(""amount"") AS ""mon_amount"",EXTRACT(MONTH FROM ""day"") AS ""mon"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",""mon""), ""cte2"" AS (SELECT ""c1"".""account_id"",""c1"".""mon"" AS ""first"",""c2"".""mon"" AS ""second"",""c1"".""mon_amount"" AS ""firstmon"",""c2"".""mon_amount"" AS ""secondmon"" FROM ""cte"" AS ""c1"" JOIN ""cte"" AS ""c2"" ON ""c1"".""account_id""=""c2"".""account_id"" AND ""c1"".""mon""=""c2"".""mon""-1) SELECT DISTINCT ""c"".""account_id"" FROM ""cte2"" AS ""c"" JOIN ""Accounts"" AS ""a"" ON ""a"".""account_id""=""c"".""account_id"" WHERE ""c"".""firstmon"">""max_income"" AND ""c"".""secondmon"">""max_income"""
204,"SELECT DISTINCT ""account_id"" FROM (SELECT ""a"".""account_id"",""total_income"",""mth"",LEAD(""total_income"", 1) OVER (PARTITION BY ""account_id"" ORDER BY ""mth"") AS ""lead_"",LEAD(""mth"", 1) OVER (PARTITION BY ""account_id"" ORDER BY ""mth"") AS ""mth_"",""max_income"" FROM ""Accounts"" AS ""a"" LEFT JOIN (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""mth"",SUM(""amount"") AS ""total_income"" FROM ""Transactions"" WHERE LOWER(""type"")='creditor' GROUP BY ""account_id"",EXTRACT(MONTH FROM ""day"")) AS ""c"" ON ""c"".""account_id""=""a"".""account_id"") AS ""l"" WHERE (""total_income"">""max_income"" AND ""lead_"">""max_income"") AND ""mth_""-""mth""=1 ORDER BY 1"
205,"WITH ""creditbymonth"" AS (SELECT TO_CHAR(""day"", 'YYYY-%m') AS ""month"",""account_id"",SUM(""amount"") AS ""totalcredit"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY TO_CHAR(""day"", 'YYYY-%m'),""account_id"") SELECT DISTINCT ""account_id"" FROM (SELECT ""account_id"",""month"",LEAD(""month"", 1) OVER (PARTITION BY ""account_id"" ORDER BY ""month"") AS ""next_month"" FROM (SELECT ""month"",""a"".""account_id"",""totalcredit"",""max_income"" FROM (""creditbymonth"" AS ""a"") CROSS JOIN ""Accounts"" AS ""b"" WHERE ""a"".""account_id""=""b"".""account_id"" AND ""totalcredit"">""max_income"") AS ""a"") AS ""b"" WHERE ""next_month"" IS NOT NULL AND PERIOD_DIFF(TO_CHAR(STR_TO_DATE(""next_month"", '%Y-%m'), 'YYYY%m'), TO_CHAR(STR_TO_DATE(""month"", '%Y-%m'), 'YYYY%m'))=1"
206,"WITH ""MonthlyAccountCredited"" AS (SELECT ""account_id"",CONVERT(""day"" + INTERVAL '1-EXTRACT(DAY FROM ""day"") DAY', DATE) AS ""Month"",SUM(""amount"") AS ""TotalCredit"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",""Month""), ""MonthlyAccountSuspicious"" AS (SELECT ""M"".""account_id"",""M"".""Month"" FROM ""MonthlyAccountCredited"" AS ""M"" JOIN ""Accounts"" AS ""A"" ON ""M"".""account_id""=""A"".""account_id"" WHERE ""TotalCredit"">""max_income""), ""SuspiciousAccounts"" AS (SELECT DISTINCT ""M1"".""account_id"" FROM ""MonthlyAccountSuspicious"" AS ""M1"" JOIN ""MonthlyAccountSuspicious"" AS ""M2"" ON ""M1"".""account_id""=""M2"".""account_id"" AND ""M1"".""Month"" + INTERVAL '1 MONTH'=""M2"".""Month"" ORDER BY ""M1"".""account_id"") SELECT * FROM ""SuspiciousAccounts"""
207,"WITH ""monthly_income"" AS (SELECT ""account_id"",TO_CHAR(""day"", 'YYYY%m') AS ""month"",SUM(""amount"") AS ""income"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",""month"") SELECT DISTINCT ""a"".""account_id"" FROM ""accounts"" AS ""a"" JOIN (SELECT ""m1"".""account_id"",""m1"".""income"" AS ""income_1"",""m2"".""income"" AS ""income_2"" FROM ""monthly_income"" AS ""m1"" JOIN ""monthly_income"" AS ""m2"" ON ""m1"".""account_id""=""m2"".""account_id"" AND PERIOD_DIFF(""m1"".""month"", ""m2"".""month"")=1) AS ""t"" ON ""a"".""account_id""=""t"".""account_id"" AND ""a"".""max_income""<""t"".""income_1"" AND ""a"".""max_income""<""t"".""income_2"""
208,"WITH ""cteI"" AS (SELECT ""account_id"",""amount"",TO_CHAR(""day"", 'YYYY-%m') AS ""d"",TO_CHAR(""day"" + INTERVAL '1 MONTH', 'YYYY-%m') AS ""dnext"" FROM ""Transactions"" WHERE ""type""='Creditor'), ""cteMI"" AS (SELECT ""cteI"".""account_id"",SUM(""amount"")-""max_income"" AS ""overage"",""d"",""dnext"" FROM (""cteI"") CROSS JOIN ""Accounts"" WHERE ""cteI"".""account_id""=""Accounts"".""account_id"" GROUP BY ""account_id"",""d""), ""cteMI2"" AS (SELECT ""a"".*,COALESCE(""b"".""d"", '0') AS ""dd"" FROM ""cteMI"" AS ""a"" LEFT JOIN ""cteMI"" AS ""b"" ON ""a"".""dnext""=""b"".""d"" AND ""a"".""account_id""=""b"".""account_id"" WHERE ""a"".""overage"">0 AND ""b"".""overage"">0) SELECT DISTINCT ""account_id"" FROM ""cteMI2"" ORDER BY ""account_id"""
209,"WITH ""t"" AS (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month"",EXTRACT(YEAR FROM ""day"") AS ""year"",SUM(CASE WHEN ""type""='Creditor' THEN ""amount"" ELSE 0 END) AS ""income"" FROM ""Transactions"" GROUP BY ""account_id"",EXTRACT(MONTH FROM ""day""),EXTRACT(YEAR FROM ""day"")) SELECT DISTINCT ""a"".""account_id"" FROM (""Accounts"" AS ""a"" JOIN ""t"" AS ""b"" ON (""a"".""account_id""=""b"".""account_id"") AND (""b"".""income"">""a"".""max_income"")) JOIN ""t"" AS ""c"" ON (""a"".""account_id""=""c"".""account_id"") AND (""c"".""income"">""a"".""max_income"") AND (((""b"".""year""=""c"".""year"") AND (""b"".""month""+1=""c"".""month"")) OR ((""b"".""year""+1=""c"".""year"") AND (""b"".""month""=12) AND (""c"".""month""=1))) ORDER BY ""account_id"""
210,"WITH ""cte"" AS (SELECT EXTRACT(MONTH FROM ""day"") AS ""mon"",""account_id"",SUM(""amount"") AS ""tot_income"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY EXTRACT(MONTH FROM ""day""),""account_id""), ""cte2"" AS (SELECT ""a"".""account_id"",""mon"",""tot_income"",""max_income"",""mon""-ROW_NUMBER() OVER (PARTITION BY ""a"".""account_id"" ORDER BY ""mon"") AS ""grp"" FROM ""cte"" AS ""c"" JOIN ""Accounts"" AS ""a"" ON ""c"".""account_id""=""a"".""account_id"" WHERE ""tot_income"">""max_income"") SELECT DISTINCT ""account_id"" FROM ""cte2"" GROUP BY ""grp"",""account_id"" HAVING COUNT(1)>1"
211,"WITH ""temp"" AS (SELECT ""t"".""account_id"",TO_CHAR(""day"", 'YYYY%m') AS ""date"",SUM(""amount"") AS ""income"",""Accounts"".""max_income"" FROM ""Transactions"" AS ""t"" LEFT JOIN ""Accounts"" ON ""Accounts"".""account_id""=""t"".""account_id"" WHERE ""t"".""type""='Creditor' GROUP BY ""t"".""account_id"",TO_CHAR(""day"", 'YYYY%m') HAVING SUM(""amount"")>""Accounts"".""max_income"") SELECT ""t1"".""account_id"" FROM (""temp"" AS ""t1"") CROSS JOIN ""temp"" AS ""t2"" WHERE ""t1"".""account_id""=""t2"".""account_id"" AND PERIOD_DIFF(""t1"".""date"", ""t2"".""date"")=1 GROUP BY ""t1"".""account_id"" ORDER BY ""t1"".""account_id"""
212,"WITH ""cte"" AS (SELECT ""t"".""account_id"",EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day"") AS ""month"",(CASE WHEN SUM(""amount"")>""a"".""max_income"" THEN 1 ELSE 0 END) AS ""exceed"" FROM ""transactions"" AS ""t"" JOIN ""accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""type""='Creditor' GROUP BY EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day""),""t"".""account_id"") SELECT DISTINCT ""c1"".""account_id"" FROM (""cte"" AS ""c1"") CROSS JOIN ""cte"" AS ""c2"" WHERE ""c1"".""account_id""=""c2"".""account_id"" AND ""c2"".""month""-""c1"".""month""=1 AND ""c1"".""exceed""=1 AND ""c2"".""exceed""=1"
213,"WITH ""cte1"" AS (SELECT ""account_id"",EXTRACT(YEAR_MONTH FROM ""day"") AS ""y_m"",SUM(""amount"") AS ""total_credit"",LEAD(SUM(""amount"")) OVER (PARTITION BY ""account_id"" ORDER BY EXTRACT(YEAR_MONTH FROM ""day"")) AS ""next_credit"",LEAD(EXTRACT(YEAR_MONTH FROM ""day"")) OVER (PARTITION BY ""account_id"") AS ""next_y_m"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",EXTRACT(YEAR_MONTH FROM ""day"")) SELECT DISTINCT ""account_id"" FROM ""cte1"" JOIN ""accounts"" USING (""account_id"") WHERE ""total_credit"">""max_income"" AND ""next_credit"">""max_income"" AND ""next_y_m""-""y_m""=1"
214,"WITH ""monthly_income"" AS (SELECT ""b"".""account_id"",TO_CHAR(""b"".""day"", '%y%m') AS ""month"",""a"".""max_income"" FROM ""Accounts"" AS ""a"" JOIN ""Transactions"" AS ""b"" ON ""a"".""account_id""=""b"".""account_id"" WHERE ""type""='Creditor' GROUP BY ""b"".""account_id"",""month"" HAVING SUM(""amount"")>""a"".""max_income"") SELECT DISTINCT ""a"".""account_id"" FROM ""monthly_income"" AS ""a"" JOIN ""monthly_income"" AS ""b"" ON ""a"".""account_id""=""b"".""account_id"" AND PERIOD_DIFF(""a"".""month"", ""b"".""month"")=1 ORDER BY ""account_id"""
215,"WITH ""temp"" AS (SELECT ""t"".""account_id"",TO_CHAR(""day"", 'YYYY%m') AS ""date"",SUM(""amount"") AS ""income"",""Accounts"".""max_income"" FROM ""Transactions"" AS ""t"" LEFT JOIN ""Accounts"" ON ""Accounts"".""account_id""=""t"".""account_id"" WHERE ""t"".""type""='Creditor' GROUP BY ""t"".""account_id"",TO_CHAR(""day"", 'YYYY%m') HAVING SUM(""amount"")>""Accounts"".""max_income"") SELECT DISTINCT ""t1"".""account_id"" FROM (""temp"" AS ""t1"") CROSS JOIN ""temp"" AS ""t2"" WHERE ""t1"".""account_id""=""t2"".""account_id"" AND PERIOD_DIFF(""t1"".""date"", ""t2"".""date"")=1 ORDER BY ""t1"".""account_id"""
216,"WITH ""cte"" AS (SELECT ""t"".""account_id"",EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day"") AS ""month"",(CASE WHEN SUM(""amount"")>""a"".""max_income"" THEN 1 ELSE 0 END) AS ""exceed"" FROM ""transactions"" AS ""t"" JOIN ""accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""type""='Creditor' GROUP BY EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day""),""t"".""account_id"") SELECT DISTINCT ""c1"".""account_id"" FROM (""cte"" AS ""c1"") CROSS JOIN ""cte"" AS ""c2"" WHERE ""c1"".""account_id""=""c2"".""account_id"" AND ""c2"".""month""-""c1"".""month""=1 AND ""c1"".""exceed""=1 AND ""c2"".""exceed""=1"
217,"WITH ""cte"" AS (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month"",SUM(""amount"") AS ""total_income"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",""month"" ORDER BY 1,2) SELECT DISTINCT ""a"".""account_id"" FROM (""accounts"" AS ""a"" JOIN ""cte"" AS ""c1"" ON ""a"".""account_id""=""c1"".""account_id"" AND ""a"".""max_income""<""c1"".""total_income"") JOIN ""cte"" AS ""c2"" ON ""a"".""account_id""=""c2"".""account_id"" AND ""c1"".""month""=""c2"".""month""-1 AND ""a"".""max_income""<""c2"".""total_income"" ORDER BY 1"
218,"SELECT DISTINCT ""account_id"" FROM (SELECT ""tmp"".""account_id"",""mon""-ROW_NUMBER() OVER (PARTITION BY ""account_id"" ORDER BY ""mon"") AS ""grp"" FROM (SELECT ""t"".""account_id"",EXTRACT(MONTH FROM ""t"".""day"") AS ""mon"",SUM(CASE WHEN ""t"".""type""='Creditor' THEN ""t"".""amount"" ELSE 0 END) AS ""mon_ttl_income"" FROM ""transactions"" AS ""t"" GROUP BY 1,2) AS ""tmp"" JOIN ""accounts"" AS ""a"" ON ""a"".""account_id""=""tmp"".""account_id"" WHERE ""tmp"".""mon_ttl_income"">""a"".""max_income"") AS ""tmp2"" GROUP BY ""account_id"",""grp"" HAVING COUNT(1)>=2"
219,"WITH ""temp"" AS (SELECT ""tr"".""account_id"",TO_CHAR(""tr"".""day"", 'YYYY%m') AS ""month"",CASE WHEN SUM(""tr"".""amount"")>""ac"".""max_income"" THEN 1 ELSE 0 END AS ""flag"" FROM ""transactions"" AS ""tr"" JOIN ""accounts"" AS ""ac"" ON ""tr"".""account_id""=""ac"".""account_id"" WHERE ""tr"".""type""='Creditor' GROUP BY 1,2) SELECT DISTINCT ""t1"".""account_id"" FROM ""temp"" AS ""t1"" JOIN ""temp"" AS ""t2"" ON ""t1"".""account_id""=""t2"".""account_id"" AND ""t1"".""month""-""t2"".""month""=1 WHERE ""t1"".""flag""=1 AND ""t2"".""flag""=1"
220,"WITH ""cte"" AS (SELECT EXTRACT(MONTH FROM ""day"") AS ""mon"",""account_id"",SUM(""amount"") AS ""tot_income"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY EXTRACT(MONTH FROM ""day""),""account_id""), ""cte2"" AS (SELECT ""a"".""account_id"",""mon"",""tot_income"",""max_income"",""mon""-ROW_NUMBER() OVER (PARTITION BY ""a"".""account_id"" ORDER BY ""mon"") AS ""grp"" FROM ""cte"" AS ""c"" LEFT JOIN ""Accounts"" AS ""a"" ON ""c"".""account_id""=""a"".""account_id"" WHERE ""tot_income"">""max_income"") SELECT DISTINCT ""account_id"" FROM ""cte2"" GROUP BY ""grp"",""account_id"" HAVING COUNT(1)>1"
221,"WITH ""cte"" AS (SELECT ""T"".""account_id"",EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day"") AS ""Month"",(CASE WHEN SUM(""amount"")>""max_income"" THEN 1 ELSE 0 END) AS ""exceed"" FROM ""Transactions"" AS ""T"" JOIN ""Accounts"" AS ""A"" ON ""T"".""account_id""=""A"".""account_id"" WHERE ""type""='Creditor' GROUP BY ""T"".""account_id"",EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day"")) SELECT DISTINCT (""cte1"".""account_id"") FROM ""cte"" AS ""cte1"" JOIN ""cte"" AS ""cte2"" ON ""cte1"".""account_id""=""cte2"".""account_id"" WHERE ""cte1"".""month""-""cte2"".""month""=1 AND ""cte1"".""exceed""=1 AND ""cte2"".""exceed""=1"
222,"WITH ""cte"" AS (SELECT ""t"".""account_id"",CASE WHEN EXTRACT(MONTH FROM ""t"".""day"")<10 THEN CONCAT(EXTRACT(YEAR FROM ""t"".""day""), '-0', EXTRACT(MONTH FROM ""t"".""day""), '-01') ELSE CONCAT(EXTRACT(YEAR FROM ""t"".""day""), '-', EXTRACT(MONTH FROM ""t"".""day""), '-01') END AS ""month"",SUM(""t"".""amount"") AS ""amount"",CONCAT(EXTRACT(YEAR FROM ""t"".""day""), '-', EXTRACT(MONTH FROM ""t"".""day""), '-01') - INTERVAL '1 MONTH' AS ""prevmonth"" FROM ""Transactions"" AS ""t"" WHERE ""t"".""type""='Creditor' GROUP BY 1,2), ""cte2"" AS (SELECT ""c"".""account_id"",""c"".""month"",""c"".""amount"",""c"".""prevmonth"",COALESCE(""c2"".""amount"", 0) AS ""prevmonthamnt"",CASE WHEN ""c"".""amount"">""a"".""max_income"" AND COALESCE(""c2"".""amount"", 0)>""a"".""max_income"" THEN 1 ELSE 0 END AS ""suspicious"" FROM (""cte"" AS ""c"" LEFT JOIN ""cte"" AS ""c2"" ON ""c"".""account_id""=""c2"".""account_id"" AND ""c"".""prevmonth""=""c2"".""month"") LEFT JOIN ""Accounts"" AS ""a"" ON ""c"".""account_id""=""a"".""account_id"") SELECT ""account_id"" FROM ""cte2"" GROUP BY 1 HAVING SUM(""suspicious"")>0"
223,"WITH ""cte"" AS (SELECT ""account_id"",SUM(""amount"") AS ""total"",CONCAT(LEFT(""day"", 7), '-01') AS ""last_day_of_month"",""max_income"" FROM ""transactions"" AS ""t"" JOIN ""accounts"" AS ""a"" USING (""account_id"") WHERE ""type""='creditor' GROUP BY ""account_id"",LEFT(""day"", 7) HAVING SUM(""amount"")>""max_income"") SELECT DISTINCT ""account_id"" FROM ""cte"" WHERE ROW(""account_id"",""last_day_of_month"" + INTERVAL '1 MONTH') IN (SELECT ""account_id"",""last_day_of_month"" FROM ""cte"")"
224,"WITH ""transaction_cte"" AS (SELECT ""t"".""account_id"",TO_CHAR(""DAY"", 'YYYY%m') AS ""month"",SUM(""amount"") AS ""total_income"",""Accounts"".""max_income"" FROM ""Transactions"" AS ""t"" LEFT JOIN ""Accounts"" ON ""Accounts"".""account_id""=""t"".""account_id"" WHERE ""t"".""type""='Creditor' GROUP BY 1,2 HAVING ""total_income"">""Accounts"".""max_income""), ""consecutive_cte"" AS (SELECT ""account_id"",LEAD(""month"", 1) OVER (PARTITION BY ""account_id"" ORDER BY ""month"")-""month"" AS ""month_diff"" FROM ""transaction_cte"") SELECT DISTINCT ""account_id"" FROM ""consecutive_cte"" WHERE ""month_diff""=1"
225,"SELECT DISTINCT ""a"".""account_id"" FROM (SELECT DISTINCT ""a"".""month"",""a"".""account_id"" FROM (SELECT DISTINCT EXTRACT(MONTH FROM ""day"") AS ""month"",""account_id"",SUM(""amount"") AS ""total_income"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY ""month"",""account_id"") AS ""a"" JOIN (SELECT DISTINCT ""a"".""account_id"",""a"".""max_income"" FROM ""accounts"" AS ""a"") AS ""b"" ON ""a"".""total_income"">""b"".""max_income"" AND ""a"".""account_id""=""b"".""account_id"") AS ""a"" JOIN (SELECT DISTINCT ""a"".""month"",""a"".""account_id"" FROM (SELECT DISTINCT EXTRACT(MONTH FROM ""day"") AS ""month"",""account_id"",SUM(""amount"") AS ""total_income"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY ""month"",""account_id"") AS ""a"" JOIN (SELECT DISTINCT ""a"".""account_id"",""a"".""max_income"" FROM ""accounts"" AS ""a"") AS ""b"" ON ""a"".""total_income"">""b"".""max_income"" AND ""a"".""account_id""=""b"".""account_id"") AS ""b"" ON ""a"".""account_id""=""b"".""account_id"" AND ""a"".""month""+1=""b"".""month"""
226,"WITH ""CET"" AS (SELECT ""T"".""account_id"",EXTRACT(MONTH FROM ""day"") AS ""DAY"",""max_income"" FROM ""Transactions"" AS ""T"" JOIN ""Accounts"" AS ""A"" ON ""T"".""account_id""=""A"".""account_id"" WHERE ""type""='Creditor' GROUP BY ""account_id"",EXTRACT(MONTH FROM ""day"") HAVING SUM(""amount"")>""A"".""max_income"") SELECT DISTINCT ""account_id"" FROM ""CET"" WHERE ROW(""account_id"",""DAY""-1) IN (SELECT ""account_id"",""DAY"" FROM ""CET"") OR ROW(""account_id"",""DAY""+1) IN (SELECT ""account_id"",""DAY"" FROM ""CET"")"
227,"SELECT DISTINCT ""account_id"" FROM (SELECT ""a"".""account_id"",""tot_income"".""month"",LEAD(""tot_income"".""month"", 1) OVER (PARTITION BY ""a"".""account_id"" ORDER BY ""tot_income"".""month"") AS ""next_month"" FROM (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month"",SUM(""amount"") AS ""total_income"" FROM ""transactions"" AS ""t"" WHERE ""type""='Creditor' GROUP BY ""account_id"",EXTRACT(MONTH FROM ""day"")) AS ""tot_income"" JOIN ""accounts"" AS ""a"" ON ""tot_income"".""account_id""=""a"".""account_id"" AND ""tot_income"".""total_income"">""a"".""max_income"") AS ""check_consecutive"" WHERE ABS(""next_month""-""month"")=1"
228,"WITH ""CTE1"" AS (SELECT ""ACCOUNT_ID"",EXTRACT(MONTH FROM ""DAY"") AS ""TRANSACTION_MONTH"",SUM(""AMOUNT"") AS ""TOTAL_INCOME"" FROM ""TRANSACTIONS"" WHERE ""TYPE""='Creditor' GROUP BY 1,2 ORDER BY 1,2) SELECT ""c"".""account_id"" FROM (""cte1"" AS ""c"" JOIN ""accounts"" AS ""a"" ON (""c"".""account_id""=""a"".""account_id"")) JOIN ""cte1"" AS ""c1"" ON (""c"".""account_id""=""c1"".""account_id"" AND ""c1"".""TRANSACTION_MONTH""=""c"".""TRANSACTION_MONTH""+1) WHERE ""c"".""total_income"">""a"".""max_income"" AND ""c1"".""total_income"">""a"".""max_income"" GROUP BY 1"
229,"WITH ""total_income"" AS (SELECT ""t"".""account_id"",TO_CHAR(""t"".""day"", 'YYYY%m') AS ""day"",SUM(""t"".""amount"") AS ""income"",""a"".""max_income"" FROM ""Transactions"" AS ""t"" JOIN ""Accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""t"".""type""='Creditor' GROUP BY ""t"".""account_id"",TO_CHAR(""t"".""day"", 'YYYY%m') HAVING SUM(""t"".""amount"")>""a"".""max_income"" ORDER BY 1,2), ""suspicious"" AS (SELECT ""t1"".""account_id"",PERIOD_DIFF(""t1"".""day"", ""t2"".""day"") AS ""diff"" FROM ""total_income"" AS ""t1"" JOIN ""total_income"" AS ""t2"" ON ""t1"".""account_id""=""t2"".""account_id"" AND ""t1"".""day""!=""t2"".""day"") SELECT DISTINCT ""account_id"" FROM ""suspicious"" WHERE ""diff""=1 OR ""diff""=-1 ORDER BY 1"
230,"SELECT DISTINCT ""c"".""account_id"" FROM (SELECT ""a"".""account_id"",""a"".""month"",LAG(""month"") OVER (PARTITION BY ""account_id"" ORDER BY ""month"") AS ""lg"" FROM (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month"",SUM(""amount"") AS ""tot"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY 1,2) AS ""a"" JOIN ""Accounts"" AS ""b"" ON ""a"".""account_id""=""b"".""account_id"" WHERE ""a"".""tot"">""b"".""max_income"") AS ""c"" WHERE ABS(""c"".""month""-""c"".""lg"")=1"
231,"WITH ""CET"" AS (SELECT ""T"".""account_id"",EXTRACT(MONTH FROM ""day"") AS ""DAY"",""max_income"" FROM ""Transactions"" AS ""T"" JOIN ""Accounts"" AS ""A"" ON ""T"".""account_id""=""A"".""account_id"" WHERE ""type""='Creditor' GROUP BY ""account_id"",EXTRACT(MONTH FROM ""day"") HAVING SUM(""amount"")>""A"".""max_income"") SELECT DISTINCT ""account_id"" FROM ""CET"" WHERE ROW(""account_id"",""DAY""-1) IN (SELECT ""account_id"",""DAY"" FROM ""CET"") OR ROW(""account_id"",""DAY""+1) IN (SELECT ""account_id"",""DAY"" FROM ""CET"")"
232,"WITH ""cte"" AS (SELECT ""T"".""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month"",EXTRACT(YEAR FROM ""day"") AS ""year"",""max_income"" FROM ""Transactions"" AS ""T"" JOIN ""Accounts"" AS ""A"" ON ""T"".""account_id""=""A"".""account_id"" WHERE ""type""='Creditor' GROUP BY ""account_id"",EXTRACT(MONTH FROM ""day"") HAVING SUM(""amount"")>""A"".""max_income"") SELECT DISTINCT ""t1"".""account_id"" FROM (""cte"" AS ""t1"") CROSS JOIN ""cte"" AS ""t2"" WHERE ""t1"".""account_id""=""t2"".""account_id"" AND ""t1"".""month""-""t2"".""month""=1 AND ""t1"".""year""=""t2"".""year"""
233,"WITH ""t1"" AS (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month"",SUM(""amount"") AS ""total"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY 1,2), ""t2"" AS (SELECT ""account_id"",""month"",""total"",""max_income"",LEAD(""total"") OVER (PARTITION BY ""account_id"" ORDER BY ""month"") AS ""lead_total"",LEAD(""month"") OVER (PARTITION BY ""account_id"" ORDER BY ""month"") AS ""lead_month"" FROM ""t1"" JOIN ""Accounts"" USING (""account_id"")) SELECT DISTINCT ""account_id"" FROM ""t2"" WHERE ""lead_month""-""month""=1 AND ""lead_total"">""max_income"" AND ""total"">""max_income"""
234,"WITH ""cte"" AS (SELECT ""t"".""account_id"",EXTRACT(YEAR FROM ""day"")*100+EXTRACT(MONTH FROM ""day"") AS ""yearmon"",SUM(CASE WHEN ""type""='Creditor' THEN ""amount"" END) AS ""total_income"",MAX(""a"".""max_income"") AS ""max_income"" FROM (""transactions"" AS ""t"") CROSS JOIN ""accounts"" AS ""a"" WHERE ""t"".""account_id""=""a"".""account_id"" GROUP BY 1,2 HAVING ""total_income"">""max_income"" ORDER BY ""a"".""account_id"") SELECT DISTINCT ""t1"".""account_id"" FROM (""cte"" AS ""t1"") CROSS JOIN ""cte"" AS ""t2"" WHERE ""t1"".""account_id""=""t2"".""account_id"" AND ""t1"".""yearmon""=""t2"".""yearmon""-1 ORDER BY ""t1"".""account_id"""
235,"WITH ""cte"" AS (SELECT ""account_id"",TO_CHAR(""day"", 'YYYY%m') AS ""months"",SUM(""amount"") AS ""total"",""max_income"" FROM ""transactions"" AS ""t"" JOIN ""accounts"" AS ""a"" USING (""account_id"") WHERE ""type""='Creditor' GROUP BY 1,2 HAVING ""total"">""max_income"") SELECT DISTINCT ""a"".""account_id"" FROM (""cte"" AS ""a"") CROSS JOIN ""cte"" AS ""b"" WHERE ""a"".""account_id""=""b"".""account_id"" AND PERIOD_DIFF(""b"".""months"", ""a"".""months"")=1 GROUP BY 1"
236,"WITH ""cte"" AS (SELECT ""t"".""account_id"",SUM(""amount"") AS ""amount"",TO_CHAR(""day"", 'YYYY%m') AS ""month"",""max_income"" FROM ""Transactions"" AS ""t"" LEFT JOIN ""Accounts"" USING (""account_id"") WHERE ""type""='Creditor' GROUP BY ""account_id"",TO_CHAR(""day"", 'YYYY%m') HAVING SUM(""amount"")>""Accounts"".""max_income"") SELECT ""t1"".""account_id"" FROM (""cte"" AS ""t1"") CROSS JOIN ""cte"" AS ""t2"" WHERE ""t1"".""account_id""=""t2"".""account_id"" AND PERIOD_DIFF(""t1"".""month"", ""t2"".""month"")=1 GROUP BY ""t1"".""account_id"" ORDER BY ""t1"".""account_id"""
237,"WITH ""temp"" AS (SELECT ""t"".""account_id"",LEFT(""day"", 7) AS ""month"",SUM(CASE WHEN ""type""='creditor' THEN ""amount"" ELSE 0 END)-""max_income"" AS ""monthly"" FROM ""transactions"" AS ""t"" JOIN ""accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" GROUP BY 1,2) SELECT DISTINCT ""t1"".""account_id"" FROM (""temp"" AS ""t1"") CROSS JOIN ""temp"" AS ""t2"" WHERE ""t1"".""account_id""=""t2"".""account_id"" AND ""t1"".""monthly"">0 AND ""t2"".""monthly"">0 AND RIGHT(""t1"".""month"", 2)=RIGHT(""t2"".""month"", 2)+1"
238,"SELECT DISTINCT ""account_id"" FROM (SELECT ""A"".""account_id"",""year_num"",""month_num"",LEAD(""month_num"") OVER (PARTITION BY ""account_id"" ORDER BY ""year_num"",""month_num"") AS ""post_month"",""amount_value"",""ac"".""max_income"" FROM (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month_num"",EXTRACT(YEAR FROM ""day"") AS ""year_num"",SUM(CASE WHEN ""type""='creditor' THEN ""amount"" ELSE 0 END) AS ""amount_value"" FROM ""Transactions"" GROUP BY ""account_id"",""month_num"",""year_num"" ORDER BY ""account_id"",""year_num"",""month_num"") AS ""A"" LEFT JOIN ""accounts"" AS ""ac"" ON ""a"".""account_id""=""ac"".""account_id"" WHERE ""amount_value"">""ac"".""max_income"") AS ""B"" WHERE ""post_month""-""month_num"" IN (1,-11) ORDER BY ""account_id"""
239,"WITH ""t"" AS (SELECT ""account_id"",SUM(CASE WHEN ""type""='Creditor' THEN ""amount"" ELSE 0 END) AS ""income"",EXTRACT(MONTH FROM ""day"") AS ""month"" FROM ""transactions"" GROUP BY ""account_id"",EXTRACT(MONTH FROM ""day"")) SELECT DISTINCT ""account_id"" FROM (SELECT ""t"".""account_id"",""income"",LAG(""income"") OVER (PARTITION BY ""t"".""account_id"" ORDER BY ""month"") AS ""l1income"",""max_income"",""month"",LAG(""month"") OVER (PARTITION BY ""t"".""account_id"" ORDER BY ""month"") AS ""lmonth"" FROM ""t"" JOIN ""accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"") AS ""m"" WHERE ""l1income"">""max_income"" AND ""income"">""max_income"" AND ABS(""month""-""lmonth"")=1"
240,"WITH ""incometotal"" AS (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month"",SUM(""amount"") AS ""income_total"",""type"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY 1,2 ORDER BY 1,2), ""compared"" AS (SELECT ""max_income"",""i"".* FROM ""Accounts"" AS ""a"" LEFT JOIN ""incometotal"" AS ""i"" ON ""a"".""account_id""=""i"".""account_id"" WHERE ""income_total"">""max_income"") SELECT DISTINCT ""c1"".""account_id"" FROM ""compared"" AS ""c1"" JOIN ""compared"" AS ""c2"" ON ""c1"".""account_id""=""c2"".""account_id"" AND ""c1"".""month""=""c2"".""month""-1 ORDER BY 1"
241,"WITH ""t"" AS (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month"",EXTRACT(YEAR FROM ""day"") AS ""year"",SUM(CASE WHEN ""type""='Creditor' THEN ""amount"" ELSE 0 END) AS ""income"" FROM ""Transactions"" GROUP BY ""account_id"",EXTRACT(MONTH FROM ""day""),EXTRACT(YEAR FROM ""day"")) SELECT DISTINCT ""a"".""account_id"" FROM (""Accounts"" AS ""a"" JOIN ""t"" AS ""b"" ON (""a"".""account_id""=""b"".""account_id"") AND (""b"".""income"">""a"".""max_income"")) JOIN ""t"" AS ""c"" ON (""a"".""account_id""=""c"".""account_id"") AND (""c"".""income"">""a"".""max_income"") AND (((""b"".""year""=""c"".""year"") AND (""b"".""month""+1=""c"".""month"")) OR ((""b"".""year""+1=""c"".""year"") AND (""b"".""month""=12) AND (""c"".""month""=1))) ORDER BY ""account_id"""
242,"WITH ""a"" AS (SELECT ""account_id"",EXTRACT(YEAR_MONTH FROM ""day"") AS ""trunc_month"",SUM(""amount"") AS ""total"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY 1,2), ""b"" AS (SELECT ""a"".""account_id"",""max_income""-LAG(""total"") OVER (PARTITION BY ""account_id"" ORDER BY ""trunc_month"") AS ""trigger1"",""max_income""-""total"" AS ""trigger2"",""trunc_month"",LAG(""trunc_month"") OVER (PARTITION BY ""account_id"" ORDER BY ""trunc_month"") AS ""pior_month"" FROM ""a"" JOIN ""accounts"" AS ""a2"" ON ""a"".""account_id""=""a2"".""account_id"") SELECT DISTINCT ""account_id"" FROM ""b"" WHERE ""trigger1""<0 AND ""trigger2""<0 AND ""pior_month""+1=""trunc_month"""
243,"WITH ""x"" AS (SELECT ""t"".""account_id"",EXTRACT(MONTH FROM ""t"".""day"") AS ""month"" FROM ""Transactions"" AS ""t"" WHERE ""t"".""type""='Creditor' GROUP BY ""t"".""account_id"",""month"" HAVING SUM(""t"".""amount"")>(SELECT ""max_income"" FROM ""accounts"" WHERE ""account_id""=""t"".""account_id"") ORDER BY ""t"".""transaction_id"") SELECT DISTINCT ""x1"".""account_id"" FROM ""x"" AS ""x1"" JOIN ""x"" AS ""x2"" ON ""x1"".""account_id""=""x2"".""account_id"" AND ""x1"".""month""=""x2"".""month""-1"
244,"WITH ""cte"" AS (SELECT ""t"".""account_id"",SUM(""amount"") AS ""amt"",MAX(""max_income"") AS ""mx"",EXTRACT(YEAR FROM ""day"") AS ""yr"",EXTRACT(MONTH FROM ""day"") AS ""mnt"" FROM ""transactions"" AS ""t"" LEFT JOIN ""accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""type""='Creditor' GROUP BY ""t"".""account_id"",EXTRACT(YEAR FROM ""day""),EXTRACT(MONTH FROM ""day"") HAVING SUM(""amount"")>MAX(""max_income"")), ""cte2"" AS (SELECT ""account_id"",""yr"",""mnt"",LEAD(""mnt"") OVER (PARTITION BY ""account_id"" ORDER BY ""yr"",""mnt"") AS ""nxt_mnt"" FROM ""cte"") SELECT DISTINCT ""account_id"" FROM ""cte2"" WHERE ""nxt_mnt""-""mnt""=1"
245,"WITH ""t1"" AS (SELECT ""account_id"",""m"",""amount_sum"",LEAD(""m"", 1) OVER (PARTITION BY ""account_id"" ORDER BY ""m"") AS ""next_m"" FROM (SELECT ""t"".""account_id"",EXTRACT(MONTH FROM ""day"") AS ""m"",SUM(""amount"") AS ""amount_sum"",""max_income"" FROM ""Transactions"" AS ""t"" LEFT JOIN ""Accounts"" AS ""a"" ON ""a"".""account_id""=""t"".""account_id"" WHERE ""type""='Creditor' GROUP BY 1,2) AS ""tmp"" WHERE ""max_income""<""amount_sum"") SELECT DISTINCT ""account_id"" FROM ""t1"" WHERE ""next_m""-""m""=1"
246,"WITH ""CTE"" AS (SELECT ""account_id"",""day"",SUM(""amount"") AS ""amount"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",TO_CHAR(""day"", 'YYYY-%m') ORDER BY ""account_id"") SELECT DISTINCT ""tab"".""account_id"" FROM (SELECT ""t1"".""account_id"",TO_CHAR(""t1"".""day"", 'YYYY-%m') AS ""t1Date"",""t1"".""amount"" AS ""t1amount"",TO_CHAR(""t2"".""day"", 'YYYY-%m') AS ""t2Date"",""t2"".""amount"" AS ""t2amount"" FROM ""CTE"" AS ""t1"" JOIN ""CTE"" AS ""t2"" ON (""t1"".""account_id""=""t2"".""account_id"") AND (TO_CHAR(""t2"".""day"", 'YYYY-%m')=TO_CHAR(""t1"".""day"" + INTERVAL '1 MONTH', 'YYYY-%m'))) AS ""tab"" JOIN ""accounts"" ON ""accounts"".""account_id""=""tab"".""account_id"" WHERE (""tab"".""t1amount"">""accounts"".""max_income"") AND (""tab"".""t2amount"">""accounts"".""max_income"")"
247,"WITH ""CTE"" AS (SELECT ""account_id"",""day"",SUM(""amount"") AS ""amount"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",TO_CHAR(""day"", 'YYYY-%m') ORDER BY ""account_id"") SELECT DISTINCT ""tab"".""account_id"" FROM (SELECT ""t1"".""account_id"",TO_CHAR(""t1"".""day"", 'YYYY-%m') AS ""t1Date"",""t1"".""amount"" AS ""t1amount"",TO_CHAR(""t2"".""day"", 'YYYY-%m') AS ""t2Date"",""t2"".""amount"" AS ""t2amount"" FROM ""CTE"" AS ""t1"" JOIN ""CTE"" AS ""t2"" ON (""t1"".""account_id""=""t2"".""account_id"") AND (TO_CHAR(""t2"".""day"", 'YYYY-%m')=TO_CHAR(""t1"".""day"" + INTERVAL '1 MONTH', 'YYYY-%m'))) AS ""tab"" JOIN ""accounts"" ON ""accounts"".""account_id""=""tab"".""account_id"" WHERE (""tab"".""t1amount"">""accounts"".""max_income"") AND (""tab"".""t2amount"">""accounts"".""max_income"")"
248,"WITH ""cte"" AS (SELECT ""t"".""account_id"",""t"".""mnth"",""t"".""credited_amt"",""a"".""max_income"" FROM (SELECT ""account_id"",TO_CHAR(""day"", '%m') AS ""mnth"",SUM(""amount"") AS ""credited_amt"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",""mnth"" ORDER BY ""account_id"",""mnth"") AS ""t"" LEFT JOIN ""accounts"" AS ""a"" ON ""a"".""account_id""=""t"".""account_id"") SELECT DISTINCT ""x"".""account_id"" FROM (SELECT ""account_id"",(""mnth""*1) AS ""mnth"",""credited_amt"",""max_income"",LAG(""credited_amt"") OVER (PARTITION BY ""account_id"") AS ""prev_credit"",(LAG(""mnth"") OVER (PARTITION BY ""account_id"")*1) AS ""prev_mnth"" FROM ""cte"") AS ""x"" WHERE ""x"".""max_income""<""x"".""credited_amt"" AND ""x"".""max_income""<""x"".""prev_credit"" AND (""mnth""-""prev_mnth"")=1.0"
249,"WITH ""cte"" AS (SELECT ""a"".""account_id"",EXTRACT(MONTH FROM ""t"".""day"") AS ""month"" FROM ""Accounts"" AS ""a"" JOIN ""Transactions"" AS ""t"" ON ""a"".""account_id""=""t"".""account_id"" GROUP BY ""a"".""account_id"",""month"" HAVING SUM(CASE WHEN ""t"".""type""='Creditor' THEN ""t"".""amount"" ELSE 0 END)>MAX(""a"".""max_income"")) SELECT DISTINCT ""a"".""account_id"" FROM ""cte"" AS ""a"" JOIN ""cte"" AS ""b"" ON ""a"".""account_id""=""b"".""account_id"" AND ""a"".""month""=""b"".""month""-1 ORDER BY ""a"".""account_id"""
250,"WITH ""cte"" AS (SELECT ""account_id"",CONCAT(LEFT(""day"", 7), '-01') AS ""mth"",SUM(""amount"") AS ""total_amount"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY 1,2), ""sus"" AS (SELECT ""cte"".* FROM ""cte"" JOIN ""accounts"" AS ""t"" ON ""t"".""account_id""=""cte"".""account_id"" WHERE ""t"".""max_income""<""cte"".""total_amount""), ""cte_rank"" AS (SELECT ""account_id"",TIMESTAMPDIFF(MONTH, '2021-12-01', ""mth"") AS ""m"",ROW_NUMBER() OVER (PARTITION BY ""account_id"" ORDER BY ""mth"") AS ""drk"",TIMESTAMPDIFF(MONTH, '2021-12-01', ""mth"")*1.0-ROW_NUMBER() OVER (PARTITION BY ""account_id"" ORDER BY ""mth"") AS ""grp"" FROM ""sus"") SELECT DISTINCT ""account_id"" FROM ""cte_rank"" GROUP BY 1,""grp"" HAVING COUNT(1)>1 ORDER BY 1"
251,"WITH ""income"" AS (SELECT ""account_id"",CONCAT(LEFT(""day"", 7), '-01') AS ""month"",SUM(CASE WHEN ""type""='Creditor' THEN ""amount"" ELSE 0 END) AS ""total_income"",""max_income"" FROM ""transactions"" JOIN ""accounts"" USING (""account_id"") GROUP BY 1,LEFT(""day"", 7) ORDER BY 1,2) SELECT DISTINCT ""i1"".""account_id"" FROM ""income"" AS ""i1"" JOIN ""income"" AS ""i2"" ON ""i1"".""account_id""=""i2"".""account_id"" AND TIMESTAMPDIFF(MONTH, ""i1"".""month"", ""i2"".""month"")=1 WHERE ""i1"".""total_income"">""i1"".""max_income"" AND ""i2"".""total_income"">""i2"".""max_income"""
252,"WITH ""MonthlyStatements"" AS (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month"",SUM(CASE WHEN ""type""='Creditor' THEN ""amount"" ELSE 0 END) AS ""balance"" FROM ""Transactions"" GROUP BY ""account_id"",EXTRACT(MONTH FROM ""day"")) SELECT DISTINCT ""m1"".""account_id"" FROM (""MonthlyStatements"" AS ""m1"" LEFT JOIN ""MonthlyStatements"" AS ""m2"" ON ""m1"".""month""+1=""m2"".""month"" AND ""m1"".""account_id""=""m2"".""account_id"") LEFT JOIN ""Accounts"" AS ""a"" ON ""a"".""account_id""=""m1"".""account_id"" WHERE ""m1"".""balance"">""a"".""max_income"" AND ""m2"".""balance"">""a"".""max_income"""
253,"WITH ""cte"" AS (SELECT ""t"".""account_id"",TO_CHAR(""day"", '%m %y') AS ""month"",SUM(CASE WHEN ""type""='Creditor' THEN ""amount"" END) AS ""total_income"",""max_income"" FROM ""transactions"" AS ""t"" LEFT JOIN ""accounts"" AS ""a"" ON ""a"".""account_id""=""t"".""account_id"" GROUP BY ""t"".""account_id"",TO_CHAR(""day"", '%m %y')) SELECT DISTINCT ""cte1"".""account_id"" FROM ""cte"" AS ""cte1"" JOIN ""cte"" AS ""cte2"" ON ""cte1"".""account_id""=""cte2"".""account_id"" AND ""cte1"".""month""=""cte2"".""month""-1 WHERE ""cte1"".""total_income"">""cte1"".""max_income"" AND ""cte2"".""total_income"">""cte1"".""max_income"""
254,"WITH ""t"" AS (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""mon"",SUM(""amount"") AS ""total"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",EXTRACT(MONTH FROM ""day"")), ""t1"" AS (SELECT ""t"".""account_id"",""mon"",""total"",""a"".""max_income"",LAG(""total"") OVER (PARTITION BY ""account_id"" ORDER BY ""mon"") AS ""row_above"",LAG(""mon"") OVER (PARTITION BY ""account_id"" ORDER BY ""mon"") AS ""mon_above"" FROM ""t"" JOIN ""Accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"") SELECT DISTINCT ""account_id"" FROM ""t1"" WHERE ""total"">""max_income"" AND ""row_above"">""max_income"" AND ""mon""-""mon_above""=1"
255,"WITH ""cte"" AS (SELECT ""a"".""account_id"" AS ""account_id"",""sub1"".""month"" AS ""month"",CASE WHEN ""sub1"".""total_income"">""a"".""max_income"" THEN 'y' ELSE 'n' END AS ""exceed"" FROM (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month"",SUM(""amount"") AS ""total_income"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY 1,2 ORDER BY 1,2) AS ""sub1"" LEFT JOIN ""Accounts"" AS ""a"" ON ""a"".""account_id""=""sub1"".""account_id""), ""exceed_table"" AS (SELECT ""account_id"",""month"",""exceed"",(""month""-RANK() OVER (PARTITION BY ""account_id"" ORDER BY ""month"")) AS ""rank_diff"" FROM ""cte"" WHERE ""exceed""='y') SELECT DISTINCT (""account_id"") FROM ""exceed_table"" GROUP BY ""account_id"",""rank_diff"" HAVING COUNT(1)>1"
256,"WITH ""total_income"" AS (SELECT ""account_id"",EXTRACT(YEAR FROM ""day"") AS ""year1"",EXTRACT(MONTH FROM ""day"") AS ""month1"",SUM(""amount"") AS ""total_income"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",""year1"",""month1""), ""cte"" AS (SELECT DISTINCT ""a"".""account_id"",""t"".""year1"",""t"".""month1"",LAG(""year1"", 1) OVER (PARTITION BY ""account_id"" ORDER BY ""year1"",""month1"") AS ""prev_row_year"",LAG(""month1"", 1) OVER (PARTITION BY ""account_id"" ORDER BY ""year1"",""month1"") AS ""prev_row_month"" FROM ""Accounts"" AS ""a"" JOIN ""total_income"" AS ""t"" ON ""a"".""account_id""=""t"".""account_id"" WHERE ""t"".""total_income"">""a"".""max_income"" ORDER BY 1,2,3) SELECT DISTINCT ""account_id"" FROM ""cte"" WHERE ""year1""=""prev_row_year"" AND ""month1""-""prev_row_month""=1"
257,"WITH ""t1"" AS (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""mm"",SUM(""amount"") AS ""total"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY 1,2), ""t2"" AS (SELECT ""t1"".""account_id"",""t1"".""mm"",""t1"".""total"",LEAD(""mm"") OVER (PARTITION BY ""t1"".""account_id"" ORDER BY ""t1"".""mm"") AS ""next_mm"",LEAD(""total"") OVER (PARTITION BY ""t1"".""account_id"" ORDER BY ""t1"".""mm"") AS ""next_total"",""b"".""max_income"" FROM ""t1"" JOIN ""accounts"" AS ""b"" ON ""t1"".""account_id""=""b"".""account_id"") SELECT ""account_id"" FROM ""t2"" WHERE ""total"">""max_income"" AND ""next_total"">""max_income"" AND ""next_mm""-""mm""=1 GROUP BY 1"
258,"SELECT DISTINCT ""account_id"" FROM (SELECT ""account_id"",""m"",LAG(""m"", 1) OVER (PARTITION BY ""account_id"" ORDER BY ""m"") AS ""previous_m"" FROM (SELECT ""cte1"".""account_id"",""m"",""income"",""max_income"" FROM (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""m"",SUM(""amount"") AS ""income"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY 1,2) AS ""cte1"" LEFT JOIN ""Accounts"" AS ""a"" ON ""cte1"".""account_id""=""a"".""account_id"" WHERE ""income"">""max_income"" ORDER BY ""m"") AS ""cte2"" ORDER BY 1) AS ""cte3"" WHERE ""previous_m""-""m""=-1 ORDER BY 1"
259,"WITH ""cte"" AS (SELECT ""t"".*,""a"".""max_income"" FROM (SELECT ""account_id"",EXTRACT(YEAR FROM ""day"") AS ""year"",EXTRACT(MONTH FROM ""day"") AS ""month"",SUM(""amount"") AS ""amount"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",""month"") AS ""t"" JOIN ""accounts"" AS ""a"" ON ""a"".""account_id""=""t"".""account_id"" AND ""t"".""amount"">""a"".""max_income"") SELECT DISTINCT ""a"".""account_id"" FROM (""cte"" AS ""a"") CROSS JOIN ""cte"" AS ""b"" WHERE ""a"".""account_id""=""b"".""account_id"" AND ""a"".""month""-""b"".""month""=1 GROUP BY ""a"".""account_id"",""a"".""month"""
260,"WITH ""temp"" AS (SELECT ""account_id"",TO_CHAR(""day"", '%m') AS ""month"",SUM(""amount"") AS ""income"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",""month"") SELECT DISTINCT ""t"".""account_id"" FROM (""temp"" AS ""t"" LEFT JOIN ""accounts"" AS ""a"" USING (""account_id"")) LEFT JOIN ""temp"" AS ""t2"" ON ""t"".""account_id""=""t2"".""account_id"" AND ""t"".""month""=""t2"".""month""-1 WHERE ""t"".""income"">""a"".""max_income"" AND ""t2"".""income"">""a"".""max_income"""
261,"WITH ""t"" AS (SELECT ""account_id"",TO_CHAR(""day"", 'YYYY%m') AS ""date"",CASE WHEN SUM(""amount"")>""max_income"" THEN 'Y' ELSE 'N' END AS ""suspicious"" FROM ""transactions"" JOIN ""accounts"" USING (""account_id"") WHERE ""type""='Creditor' GROUP BY ""account_id"",""date"") SELECT DISTINCT ""t1"".""account_id"" FROM (""t"" AS ""t1"") CROSS JOIN ""t"" AS ""t2"" WHERE ""t1"".""account_id""=""t2"".""account_id"" AND PERIOD_DIFF(""t1"".""date"", ""t2"".""date"")=1 AND ""t1"".""suspicious""='Y' AND ""t2"".""suspicious""='Y'"
262,"WITH ""t"" AS (SELECT ""t"".""account_id"",EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day"") AS ""month"",""max_income"" FROM ""transactions"" AS ""t"" JOIN ""accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""type""='Creditor' GROUP BY 1,2,3 HAVING ""max_income""<SUM(""amount"")) SELECT DISTINCT ""a"".""account_id"" FROM ""t"" AS ""a"" JOIN ""t"" AS ""b"" ON ""a"".""account_id""=""b"".""account_id"" AND ABS(""a"".""month""-""b"".""month"")=1"
263,"SELECT DISTINCT ""account_id"" FROM (SELECT ""T1"".""account_id"",(""mon""-ROW_NUMBER() OVER (PARTITION BY ""T1"".""account_id"" ORDER BY ""mon"")) AS ""cntr"" FROM (""Accounts"" AS ""T1"") CROSS JOIN (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""mon"",SUM(""amount"") AS ""total_income"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY 1,2) AS ""T2"" WHERE ""T1"".""account_id""=""T2"".""account_id"" AND ""max_income""<""total_income"") AS ""T"" GROUP BY ""account_id"",""cntr"" HAVING COUNT(1)>=2"
264,"WITH ""cte"" AS (SELECT ""t"".""account_id"",EXTRACT(YEAR FROM ""day"")*100+EXTRACT(MONTH FROM ""day"") AS ""yearmon"",SUM(CASE WHEN ""type""='Creditor' THEN ""amount"" END) AS ""total_income"",MAX(""a"".""max_income"") AS ""max_income"" FROM (""transactions"" AS ""t"") CROSS JOIN ""accounts"" AS ""a"" WHERE ""t"".""account_id""=""a"".""account_id"" GROUP BY 1,2 HAVING ""total_income"">""max_income"" ORDER BY ""a"".""account_id"") SELECT DISTINCT ""t1"".""account_id"" FROM (""cte"" AS ""t1"") CROSS JOIN ""cte"" AS ""t2"" WHERE ""t1"".""account_id""=""t2"".""account_id"" AND ""t1"".""yearmon""=""t2"".""yearmon""-1 ORDER BY ""t1"".""account_id"""
265,"WITH ""cte"" AS (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""mth"",SUM(""amount"") AS ""total"",""max_income"" FROM ""transactions"" JOIN ""accounts"" AS ""a"" USING (""account_id"") WHERE ""type""='creditor' GROUP BY 1,2 ORDER BY 1,2) SELECT DISTINCT ""c1"".""account_id"" FROM (""cte"" AS ""c1"") CROSS JOIN ""cte"" AS ""c2"" WHERE ""c1"".""account_id""=""c2"".""account_id"" AND ""c1"".""mth""-""c2"".""mth""=1 AND ""c1"".""total"">""c1"".""max_income"" AND ""c2"".""total"">""c2"".""max_income"""
266,"WITH ""suspicious"" AS (SELECT ""t"".""transaction_id"",""t"".""account_id"",""t"".""type"",EXTRACT(MONTH FROM ""t"".""day"") AS ""month"",SUM(""t"".""amount"") AS ""total_income"",""a"".""max_income"" FROM ""Transactions"" AS ""t"" JOIN ""Accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""t"".""type""='Creditor' GROUP BY ""t"".""account_id"",EXTRACT(MONTH FROM ""t"".""day"") HAVING SUM(""t"".""amount"")>""a"".""max_income"") SELECT DISTINCT ""s1"".""account_id"" FROM ""suspicious"" AS ""s1"" JOIN ""suspicious"" AS ""s2"" ON ""s1"".""account_id""=""s2"".""account_id"" WHERE ""s1"".""month""-""s2"".""month""=1 ORDER BY ""s1"".""transaction_id"""
267,"WITH ""CET"" AS (SELECT ""T"".""account_id"",EXTRACT(MONTH FROM ""day"") AS ""DAY"",""max_income"" FROM ""Transactions"" AS ""T"" JOIN ""Accounts"" AS ""A"" ON ""T"".""account_id""=""A"".""account_id"" WHERE ""type""='Creditor' GROUP BY ""account_id"",EXTRACT(MONTH FROM ""day"") HAVING SUM(""amount"")>""A"".""max_income"") SELECT DISTINCT ""account_id"" FROM ""CET"" WHERE ROW(""account_id"",""DAY""-1) IN (SELECT ""account_id"",""DAY"" FROM ""CET"") OR ROW(""account_id"",""DAY""+1) IN (SELECT ""account_id"",""DAY"" FROM ""CET"")"
268,"WITH ""suspicious"" AS (SELECT ""t"".""account_id"",TO_CHAR(""t"".""day"", 'YYYY%m') AS ""day"",""a"".""max_income"" FROM ""Transactions"" AS ""t"" JOIN ""Accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""t"".""type""='Creditor' GROUP BY 1,2 HAVING SUM(""t"".""amount"")>""a"".""max_income"" ORDER BY 1,2) SELECT DISTINCT ""t1"".""account_id"" FROM ""suspicious"" AS ""t1"" JOIN ""suspicious"" AS ""t2"" ON ""t1"".""account_id""=""t2"".""account_id"" AND ""t1"".""day""!=""t2"".""day"" WHERE PERIOD_DIFF(""t1"".""day"", ""t2"".""day"")=1 ORDER BY 1"
269,"WITH ""total_income"" AS (SELECT ""t"".""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month"" FROM ""Transactions"" AS ""t"" LEFT JOIN ""Accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" GROUP BY ""t"".""account_id"",TO_CHAR(""day"", 'YYYY-%m') HAVING SUM(CASE ""type"" WHEN 'Creditor' THEN ""amount"" ELSE 0 END)>AVG(""a"".""max_income"")) SELECT DISTINCT ""account_id"" FROM (SELECT LAG(""month"", 1) OVER (PARTITION BY ""account_id"" ORDER BY ""month"") AS ""prior_month"",""month"",""account_id"" FROM ""total_income"") AS ""t"" WHERE ""month""-""prior_month""=1"
270,"SELECT DISTINCT ""temp2"".""account_id"" FROM (SELECT ""Temp1"".""account_id"",""total_income"",""max_income"",""month"",RANK() OVER (ORDER BY ""month"") AS ""rk"" FROM (SELECT SUM(CASE WHEN ""type""='Creditor' THEN ""amount"" ELSE 0 END) AS ""total_income"",""Transactions"".""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month"" FROM ""Transactions"" GROUP BY ""account_id"",""month"") AS ""temp1"" JOIN ""Accounts"" ON ""temp1"".""account_id""=""Accounts"".""account_id"" WHERE ""max_income""<""total_income"") AS ""temp2"" CROSS, (SELECT ""Temp1"".""account_id"",""total_income"",""max_income"",""month"",RANK() OVER (ORDER BY ""month"") AS ""rk"" FROM (SELECT SUM(CASE WHEN ""type""='Creditor' THEN ""amount"" ELSE 0 END) AS ""total_income"",""Transactions"".""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month"" FROM ""Transactions"" GROUP BY ""account_id"",""month"") AS ""temp1"" JOIN ""Accounts"" ON ""temp1"".""account_id""=""Accounts"".""account_id"" WHERE ""max_income""<""total_income"") AS ""temp3"" WHERE ""temp2"".""account_id""=""temp3"".""account_id"" AND ""temp2"".""month""-""temp3"".""month""=(1 AND 2)"
271,"WITH ""tb1"" AS (SELECT ""t"".""account_id"",""a"".""max_income"",CONCAT(LEFT(""t"".""day"", 7), '-01') AS ""month"",""t"".""type"",""t"".""amount"" FROM ""Transactions"" AS ""t"" JOIN ""Accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id""), ""tb2"" AS (SELECT ""account_id"",""month"",SUM(""amount"") AS ""total_income"",MAX(""max_income"") AS ""max_income"" FROM ""tb1"" WHERE ""type""='Creditor' GROUP BY ""account_id"",""month""), ""tb3"" AS (SELECT ""a"".""account_id"",""a"".""month"",""a"".""total_income"",""b"".""total_income"" AS ""total_income_lag"",""a"".""max_income"" FROM ""tb2"" AS ""a"" LEFT JOIN ""tb2"" AS ""b"" ON ""a"".""month"" - INTERVAL '1 MONTH'=""b"".""month"" AND ""a"".""account_id""=""b"".""account_id"") SELECT DISTINCT ""account_id"" FROM ""tb3"" WHERE ""total_income"">""max_income"" AND ""total_income_lag"">""max_income"" ORDER BY ""account_id"""
272,"WITH ""cte"" AS (SELECT ""t"".""account_id"",EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day"") AS ""month"",(CASE WHEN SUM(""amount"")>""a"".""max_income"" THEN 1 ELSE 0 END) AS ""exceed"" FROM ""transactions"" AS ""t"" JOIN ""accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""type""='Creditor' GROUP BY EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day""),""t"".""account_id"") SELECT DISTINCT ""c1"".""account_id"" FROM (""cte"" AS ""c1"") CROSS JOIN ""cte"" AS ""c2"" WHERE ""c1"".""account_id""=""c2"".""account_id"" AND ""c2"".""month""-""c1"".""month""=1 AND ""c1"".""exceed""=1 AND ""c2"".""exceed""=1"
273,"WITH ""search"" AS (SELECT ""accounts"".""account_id"",EXTRACT(MONTH FROM ""DAY"") AS ""MM"",CASE WHEN (""max_income""<SUM(""amount"")) THEN 'true' ELSE 'false' END AS ""fraud"" FROM (""transactions"") CROSS JOIN ""accounts"" WHERE ""transactions"".""account_id""=""accounts"".""account_id"" AND ""type""='Creditor' GROUP BY 1,2) SELECT DISTINCT ""s1"".""account_id"" FROM (""search"" AS ""s1"") CROSS JOIN ""search"" AS ""s2"" WHERE ""s1"".""account_id""=""s2"".""account_id"" AND ""s1"".""MM""+1=""s2"".""MM"" AND ""s1"".""fraud""='true' AND ""s2"".""fraud""='true'"
274,"WITH ""temp"" AS (SELECT ""account_id"",TO_CHAR(""day"", 'YYYY-%m-01') AS ""month"",SUM(""amount"") AS ""deposit"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY 1,2) SELECT DISTINCT ""eligible_account"" AS ""account_id"" FROM (SELECT CASE WHEN ""t1"".""deposit"">""accounts"".""max_income"" AND ""t2"".""deposit"">""accounts"".""max_income"" THEN ""t1"".""account_id"" ELSE NULL END AS ""eligible_account"" FROM (""temp"" AS ""t1"" JOIN ""temp"" AS ""t2"" ON ""t1"".""account_id""=""t2"".""account_id"" AND TIMESTAMPDIFF(MONTH, ""t1"".""month"", ""t2"".""month"")=1) JOIN ""accounts"" ON ""t1"".""account_id""=""accounts"".""account_id"") AS ""p"" WHERE ""eligible_account"" IS NOT NULL"
275,"WITH ""cte"" AS (SELECT ""a"".""account_id"",EXTRACT(MONTH FROM ""a"".""day"") AS ""month"" FROM ""Transactions"" AS ""a"" LEFT JOIN ""Accounts"" AS ""b"" USING (""account_id"") GROUP BY ""a"".""account_id"",EXTRACT(MONTH FROM ""a"".""day"") HAVING SUM(CASE WHEN ""a"".""type""='creditor' THEN ""a"".""amount"" ELSE 0 END)>MAX(""b"".""max_income"")) SELECT DISTINCT ""x"".""account_id"" FROM ""cte"" AS ""x"" JOIN ""cte"" AS ""y"" ON ""x"".""account_id""=""y"".""account_id"" AND ""x"".""month""=""y"".""month""-1 ORDER BY ""x"".""account_id"""
276,"WITH ""monthly_total"" AS (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month"",SUM(""amount"") AS ""total"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",EXTRACT(MONTH FROM ""day"") ORDER BY ""account_id"",EXTRACT(MONTH FROM ""day"")), ""check_flag"" AS (SELECT ""a"".*,CASE WHEN ""a"".""total"">""b"".""max_income"" THEN 1 ELSE 0 END AS ""check_flag"" FROM ""monthly_total"" AS ""a"" LEFT JOIN ""Accounts"" AS ""b"" ON ""a"".""account_id""=""b"".""account_id"") SELECT DISTINCT (""account_id"") FROM (SELECT *,LEAD(""check_flag"", 1) OVER (PARTITION BY ""account_id"" ORDER BY ""month"") AS ""next_flag"",LEAD(""month"", 1) OVER (PARTITION BY ""account_id"" ORDER BY ""month"") AS ""next_month"" FROM ""check_flag"") AS ""a"" WHERE ""check_flag""=1 AND ""next_flag""=1 AND ""next_month""-""month""=1"
277,"WITH ""incometable"" AS (SELECT ""account_id"",EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day"")-1 AS ""monthid"",SUM(""amount"") AS ""income"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",""monthid""), ""badincome"" AS (SELECT ""Accounts"".""account_id"" AS ""account_id"",""monthid"" FROM ""Accounts"" JOIN ""incometable"" ON ""Accounts"".""account_id""=""incometable"".""account_id"" WHERE ""incometable"".""income"">""Accounts"".""max_income"") SELECT DISTINCT ""a"".""account_id"" FROM ""badincome"" AS ""a"" JOIN ""badincome"" AS ""b"" ON ""a"".""account_id""=""b"".""account_id"" AND ""a"".""monthid""+1=""b"".""monthid"""
278,"WITH ""monthly_transactions"" AS (SELECT ""account_id"",DATE(""day"") + INTERVAL '1-EXTRACT(DAY FROM DATE(""day"")) DAY' AS ""MONTH_BEGINING_DATE"",SUM(""amount"") AS ""TOTAL_DEPOSITS"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",DATE(""day"") + INTERVAL '1-EXTRACT(DAY FROM DATE(""day"")) DAY'), ""suspcious_transactions"" AS (SELECT ""m"".""account_id"" AS ""account_id"",""MONTH_BEGINING_DATE"" FROM ""monthly_transactions"" AS ""m"" JOIN ""accounts"" AS ""a"" ON ""m"".""account_id""=""a"".""account_id"" AND ""m"".""TOTAL_DEPOSITS"">""a"".""max_income"") SELECT DISTINCT ""s1"".""ACCOUNT_ID"" AS ""ACCOUNT_ID"" FROM ""suspcious_transactions"" AS ""s1"" JOIN ""suspcious_transactions"" AS ""s2"" ON ""s1"".""account_id""=""s2"".""account_id"" AND ""s1"".""MONTH_BEGINING_DATE"" + INTERVAL ''1' MONTH'=""s2"".""MONTH_BEGINING_DATE"""
279,"WITH ""cte"" AS (SELECT ""account_id"",SUM(""amount"") AS ""total_income"",EXTRACT(MONTH FROM ""day"") AS ""mon"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",EXTRACT(MONTH FROM ""day"")), ""cte1"" AS (SELECT ""Accounts"".""account_id"",""mon"" FROM ""cte"" JOIN ""Accounts"" USING (""account_id"") WHERE ""total_income"">""max_income"") SELECT DISTINCT ""cte1"".""account_id"" AS ""account_id"" FROM ""cte1"" JOIN ""cte1"" AS ""cte2"" USING (""account_id"") WHERE ABS(""cte1"".""mon""-""cte2"".""mon"")=1"
280,"WITH ""CTE"" AS (SELECT ""t"".""account_id"",EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day"") AS ""m"",SUM(CASE WHEN ""type""='Creditor' THEN ""amount"" ELSE 0 END) AS ""total_income"",""max_income"" FROM ""Transactions"" AS ""t"" JOIN ""Accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" GROUP BY ""t"".""account_id"",EXTRACT(YEAR FROM ""day""),EXTRACT(MONTH FROM ""day"")) SELECT DISTINCT ""c1"".""account_id"" FROM ""CTE"" AS ""c1"" JOIN ""CTE"" AS ""c2"" ON ""c1"".""account_id""=""c2"".""account_id"" AND ""c1"".""m""+1=""c2"".""m"" WHERE ""c1"".""total_income"">""c1"".""max_income"" AND ""c2"".""total_income"">""c2"".""max_income"""
281,"WITH ""income"" AS (SELECT ""account_id"",CONCAT(LEFT(""day"", 7), '-01') AS ""month"",SUM(CASE WHEN ""type""='Creditor' THEN ""amount"" ELSE 0 END) AS ""total_income"",""max_income"" FROM ""transactions"" JOIN ""accounts"" USING (""account_id"") GROUP BY 1,LEFT(""day"", 7) ORDER BY 1,2) SELECT DISTINCT ""i1"".""account_id"" FROM ""income"" AS ""i1"" JOIN ""income"" AS ""i2"" ON ""i1"".""account_id""=""i2"".""account_id"" AND TIMESTAMPDIFF(MONTH, ""i1"".""month"", ""i2"".""month"")=1 WHERE ""i1"".""total_income"">""i1"".""max_income"" AND ""i2"".""total_income"">""i2"".""max_income"""
282,"WITH ""CTETable"" AS (SELECT ""t"".""account_id"",EXTRACT(YEAR FROM ""t"".""day"")*12+EXTRACT(MONTH FROM ""t"".""day"") AS ""month"",CASE WHEN SUM(""t"".""amount"")>""a"".""max_income"" THEN 1 ELSE 0 END AS ""isExceeded"" FROM ""Transactions"" AS ""t"" LEFT JOIN ""Accounts"" AS ""a"" ON ""a"".""account_id""=""t"".""account_id"" WHERE ""t"".""type""='Creditor' GROUP BY ""t"".""account_id"",""month"") SELECT DISTINCT (""c1"".""account_id"") FROM (""CTETable"" AS ""c1"") CROSS JOIN ""CTETable"" AS ""c2"" WHERE ""c1"".""account_id""=""c2"".""account_id"" AND ""c2"".""month""-""c1"".""month""=1 AND ""c1"".""isExceeded""=1 AND ""c2"".""isExceeded""=1"
283,"SELECT DISTINCT ""c"".""account_id"" FROM (SELECT ""a"".""account_id"",""a"".""month"",LAG(""month"") OVER (PARTITION BY ""account_id"" ORDER BY ""month"") AS ""lg"" FROM (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month"",SUM(""amount"") AS ""tot"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY 1,2) AS ""a"" JOIN ""Accounts"" AS ""b"" ON ""a"".""account_id""=""b"".""account_id"" WHERE ""a"".""tot"">""b"".""max_income"") AS ""c"" WHERE ABS(""c"".""month""-""c"".""lg"")=1"
284,"WITH ""cte"" AS (SELECT ""t"".""account_id"",TO_CHAR(""day"", 'YYYY%m') AS ""month"",(CASE WHEN SUM(""amount"")>""a"".""max_income"" THEN 1 ELSE 0 END) AS ""exceed"" FROM ""Transactions"" AS ""t"" JOIN ""Accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""type""='Creditor' GROUP BY TO_CHAR(""day"", 'YYYY%m'),""t"".""account_id"") SELECT DISTINCT ""c1"".""account_id"" FROM (""cte"" AS ""c1"") CROSS JOIN ""cte"" AS ""c2"" WHERE ""c1"".""account_id""=""c2"".""account_id"" AND ""c2"".""month""-""c1"".""month""=1 AND ""c1"".""exceed""=1 AND ""c2"".""exceed""=1"
285,"WITH ""incometable"" AS (SELECT ""a"".""account_id"",""a"".""max_income"",TO_CHAR(""t"".""day"", 'YYYY%m') AS ""month"",SUM(CASE WHEN ""type""='Creditor' THEN ""amount"" ELSE 0 END) AS ""totalincome"" FROM ""Accounts"" AS ""a"" LEFT JOIN ""Transactions"" AS ""t"" USING (""account_id"") GROUP BY ""a"".""account_id"",TO_CHAR(""t"".""day"", 'YYYY-%m')) SELECT DISTINCT ""t1"".""account_id"" FROM ""incometable"" AS ""t1"" JOIN ""incometable"" AS ""t2"" USING (""account_id"") WHERE PERIOD_DIFF(""t1"".""month"", ""t2"".""month"")=1 AND ""t1"".""max_income""<""t1"".""totalincome"" AND ""t2"".""max_income""<""t2"".""totalincome"" ORDER BY ""t1"".""account_id"""
286,"SELECT DISTINCT ""c"".""account_id"" FROM (SELECT ""b"".""account_id"",LEAD(""b"".""month"") OVER (PARTITION BY ""b"".""account_id"" ORDER BY ""b"".""month"") AS ""next_month"",""b"".""month"" FROM (SELECT ""t"".""account_id"",SUM(""t"".""amount"") AS ""income"",EXTRACT(YEAR_MONTH FROM ""t"".""day"") AS ""month"",CASE WHEN ""a"".""max_income""<SUM(""t"".""amount"") THEN 'IS Suspicious' ELSE 'NOT Suspicious' END AS ""status"" FROM ""Transactions"" AS ""t"" JOIN ""Accounts"" AS ""a"" ON ""t"".""type""='Creditor' AND ""a"".""account_id""=""t"".""account_id"" GROUP BY ""t"".""account_id"",EXTRACT(YEAR_MONTH FROM ""t"".""day"")) AS ""b"" WHERE ""b"".""status""='IS Suspicious') AS ""c"" WHERE PERIOD_DIFF(""c"".""next_month"", ""c"".""month"")=1"
287,"WITH ""cte"" AS (SELECT ""t"".""account_id"",TO_CHAR(""day"", '%m/YYYY') AS ""Date"",SUM(CASE WHEN ""type""='Creditor' THEN ""amount"" ELSE 0 END) AS ""income"" FROM ""Transactions"" AS ""t"" JOIN ""Accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" GROUP BY 1,2) SELECT DISTINCT ""cte"".""account_id"" FROM (""cte"" JOIN ""cte"" AS ""cte2"" ON ""cte"".""account_id""=""cte2"".""account_id"" AND PERIOD_DIFF(""cte"".""date"", ""cte2"".""date"")=1) JOIN ""accounts"" AS ""a"" ON ""a"".""account_id""=""cte"".""account_id"" WHERE ""a"".""max_income""<""cte"".""income"" AND ""a"".""max_income""<""cte2"".""income"""
288,"WITH ""agg"" AS (SELECT ""t"".""account_id"",SUM(""amount"") AS ""total"",EXTRACT(YEAR FROM ""day"") AS ""y"",EXTRACT(MONTH FROM ""day"") AS ""m"",CASE WHEN SUM(""amount"")>""a"".""max_income"" THEN 1 ELSE 0 END AS ""ind"" FROM (""transactions"" AS ""t"") CROSS JOIN ""accounts"" AS ""a"" WHERE ""t"".""account_id""=""a"".""account_id"" AND ""type""='Creditor' GROUP BY 1,3,4 ORDER BY 1,3,4) SELECT DISTINCT ""a1"".""account_id"" FROM (""agg"" AS ""a1"") CROSS JOIN ""agg"" AS ""a2"" WHERE ""a1"".""account_id""=""a2"".""account_id"" AND ""a1"".""y""=""a2"".""y"" AND ""a2"".""m""-""a1"".""m""=1 AND ""a1"".""ind""=1 AND ""a2"".""ind""=1"
289,"WITH ""t"" AS (SELECT ""account_id"",SUM(""amount"") AS ""income"",TO_CHAR(""day"", 'YYYY%m') AS ""date_month"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY 1,3) SELECT DISTINCT ""t1"".""account_id"" FROM (""t"" AS ""t1"" JOIN ""t"" AS ""t2"" ON ""t1"".""account_id""=""t2"".""account_id"" AND PERIOD_DIFF(""t2"".""date_month"", ""t1"".""date_month"")=1) LEFT JOIN ""Accounts"" AS ""a"" ON ""t1"".""account_id""=""a"".""account_id"" WHERE ""t1"".""income"">""a"".""max_income"" AND ""t2"".""income"">""a"".""max_income"""
290,"WITH ""base"" AS (SELECT ""a"".""account_id"",""a"".""max_income"",LEFT(""day"", 7) AS ""month"",CASE WHEN ""type""='Creditor' THEN ""amount"" ELSE 0 END AS ""income"" FROM ""accounts"" AS ""a"" LEFT JOIN ""transactions"" AS ""t"" ON ""a"".""account_id""=""t"".""account_id""), ""suspicious"" AS (SELECT ""account_id"",""max_income"",""month"",SUM(""income"") FROM ""base"" GROUP BY 1,2,3 HAVING SUM(""income"")>""max_income"") SELECT DISTINCT ""s2"".""account_id"" FROM ""suspicious"" AS ""s1"" LEFT JOIN ""suspicious"" AS ""s2"" ON ""s1"".""account_id""=""s2"".""account_id"" AND CONVERT(RIGHT(""s1"".""month"", 2), INTEGER)+1=CONVERT(RIGHT(""s2"".""month"", 2), INTEGER) WHERE ""s2"".""account_id"" IS NOT NULL"
291,"WITH ""groups_"" AS (SELECT ""t"".""account_id"",""t"".""month"",""t"".""income"",""a"".""max_income"",CASE WHEN ""t"".""income"">""a"".""max_income"" THEN 'Y' ELSE 'N' END AS ""is_max"" FROM (SELECT ""account_id"",SUBSTRING(""day"", 1, 7) AS ""month"",SUM(CASE WHEN ""type""='Creditor' THEN ""amount"" ELSE 0 END) AS ""income"" FROM ""transactions"" AS ""t"" GROUP BY 1,2) AS ""t"" JOIN ""accounts"" AS ""a"" ON (""t"".""account_id""=""a"".""account_id"")) SELECT DISTINCT ""account_id"" FROM (SELECT *,CAST(SUBSTRING(""month"", 6, 2) AS INTEGER)-ROW_NUMBER() OVER (PARTITION BY ""account_id"" ORDER BY SUBSTRING(""month"", 6, 2)) AS ""grp"" FROM ""groups_"" WHERE ""is_max""='Y') AS ""a"" GROUP BY ""account_id"",""grp"" HAVING COUNT(1)>1 ORDER BY 1"
292,"WITH ""trans"" AS (SELECT ""account_id"",EXTRACT(YEAR_MONTH FROM ""day"") AS ""month"",SUM(""amount"") AS ""amt"" FROM ""transactions"" WHERE ""type""='creditor' GROUP BY 1,2) SELECT DISTINCT ""a"".""account_id"" FROM (""accounts"" AS ""a"" JOIN ""trans"" AS ""t1"" ON ""a"".""account_id""=""t1"".""account_id"") JOIN ""trans"" AS ""t2"" ON ""t2"".""account_id""=""t1"".""account_id"" AND ""t1"".""month""=""t2"".""month""+1 WHERE ""t1"".""amt"">""a"".""max_income"" AND ""t2"".""amt"">""a"".""max_income"""
293,"WITH ""temp"" AS (SELECT ""account_id"",TO_CHAR(""day"", 'YYYY-%m-01') AS ""month"",SUM(""amount"") AS ""total"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",""month""), ""temp2"" AS (SELECT ""t"".""account_id"",""t"".""month"" FROM ""temp"" AS ""t"" JOIN ""Accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" AND ""t"".""total"">""a"".""max_income""), ""temp3"" AS (SELECT ""account_id"",""month"",""month"" - INTERVAL 'ROW_NUMBER() OVER (PARTITION BY ""account_id"" ORDER BY ""month"") MONTH' AS ""grp"" FROM ""temp2"") SELECT DISTINCT ""account_id"" FROM ""temp3"" GROUP BY ""account_id"",""grp"" HAVING COUNT(1)>=2"
294,"WITH ""incomes"" AS (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month"",SUM(CASE WHEN ""type""='Creditor' THEN ""amount"" ELSE 0 END) AS ""income"" FROM ""transactions"" GROUP BY ""account_id"",EXTRACT(MONTH FROM ""day"")) SELECT DISTINCT ""i1"".""account_id"" FROM ((""incomes"" AS ""i1"") CROSS JOIN ""incomes"" AS ""i2"") CROSS JOIN ""accounts"" AS ""a"" WHERE ""i1"".""account_id""=""i2"".""account_id"" AND ""a"".""account_id""=""i1"".""account_id"" AND ""i1"".""month""+1=""i2"".""month"" AND ""i1"".""income"">""a"".""max_income"" AND ""i2"".""income"">""a"".""max_income"" ORDER BY ""i1"".""account_id"""
295,"WITH ""tmp"" AS (SELECT ""account_id"",SUM(""amount"") AS ""income"",EXTRACT(MONTH FROM ""day"") AS ""time1"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",EXTRACT(MONTH FROM ""day"")), ""tmp2"" AS (SELECT ""tmp"".""account_id"",""time1"",LEAD(""time1"", 1) OVER (PARTITION BY ""tmp"".""account_id"" ORDER BY ""time1"") AS ""time2"" FROM ""tmp"" JOIN ""accounts"" ON ""tmp"".""account_id""=""accounts"".""account_id"" WHERE ""max_income""<""income"") SELECT DISTINCT ""account_id"" FROM ""tmp2"" WHERE (""time1"")+1=(""time2"")"
296,"WITH ""income"" AS (SELECT ""account_id"",""amount"",EXTRACT(MONTH FROM ""day"") AS ""m"" FROM ""Transactions"" WHERE ""type""='Creditor'), ""monthly"" AS (SELECT ""account_id"",SUM(""amount"") AS ""ma"",""m"" FROM ""income"" GROUP BY ""account_id"",""m""), ""overm"" AS (SELECT ""monthly"".* FROM ""monthly"" LEFT JOIN ""Accounts"" ON ""monthly"".""account_id""=""Accounts"".""account_id"" WHERE ""ma"">""max_income""), ""consec"" AS (SELECT ""om1"".* FROM (""overm"" AS ""om1"") CROSS JOIN ""overm"" AS ""om2"" WHERE ""om1"".""account_id""=""om2"".""account_id"" AND ""om1"".""m""=""om2"".""m""+1) SELECT DISTINCT ""account_id"" FROM ""consec"""
297,"WITH ""t"" AS (SELECT ""account_id"",DATE(""day"") AS ""date_new"",SUM(CASE WHEN ""type""='Creditor' THEN ""amount"" ELSE 0 END) AS ""total"" FROM ""transactions"" GROUP BY ""account_id"",EXTRACT(MONTH FROM ""date_new"") ORDER BY 1,2), ""c"" AS (SELECT ""t1"".""account_id"",""t1"".""date_new"" AS ""date_1"",""t2"".""date_new"" AS ""date_2"",""t1"".""total"" AS ""total_1"",""t2"".""total"" AS ""total_2"" FROM ""t"" AS ""t1"" JOIN ""t"" AS ""t2"" ON ""t1"".""account_id""=""t2"".""account_id"" AND TO_CHAR(""t1"".""date_new"" + INTERVAL '1 MONTH', 'YYYY-%m')=TO_CHAR(""t2"".""date_new"", 'YYYY-%m')), ""c1"" AS (SELECT ""c"".""account_id"" FROM ""c"" LEFT JOIN ""accounts"" AS ""a"" ON ""c"".""account_id""=""a"".""account_id"" WHERE ""total_1"">""max_income"" AND ""total_2"">""max_income"") SELECT DISTINCT ""account_id"" FROM ""c1"""
298,"WITH ""cte"" AS (SELECT ""account_id"",TO_CHAR(""day"", '%m %y') AS ""mth_end"",SUM(""amount"") AS ""amt"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY 1,2), ""cte2"" AS (SELECT ""tab1"".""account_id"",""tab1"".""mth_end"",CASE WHEN ""tab1"".""amt"">""tab2"".""max_income"" THEN 1 ELSE 0 END AS ""indicator"" FROM ""cte"" AS ""tab1"" LEFT JOIN ""Accounts"" AS ""tab2"" ON ""tab1"".""account_id""=""tab2"".""account_id"") SELECT DISTINCT ""tab2"".""account_id"" FROM ""cte2"" AS ""tab1"" JOIN ""cte2"" AS ""tab2"" ON ""tab1"".""account_id""=""tab2"".""account_id"" AND ""tab2"".""mth_end""=(""tab1"".""mth_end""+1) WHERE ""tab1"".""indicator""=1 AND ""tab2"".""indicator""=1"
299,"WITH ""cte"" AS (SELECT ""account_id"",""month_day"",SUM(""amount"") AS ""tot_amt"" FROM (SELECT ""account_id"",""day"",EXTRACT(MONTH FROM ""day"") AS ""month_day"",""amount"" FROM ""transactions"" WHERE ""type""='Creditor') AS ""x"" GROUP BY ""account_id"",""month_day""), ""cte2"" AS (SELECT ""account_id"",""max_income"",""tot_amt"",""month_day"",CASE WHEN ""tot_amt"">""max_income"" THEN 1 ELSE 0 END AS ""exce_in"" FROM (SELECT ""t1"".""account_id"",""month_day"",""tot_amt"",""t2"".""max_income"" FROM ""cte"" AS ""t1"" JOIN ""accounts"" AS ""t2"" ON ""t1"".""account_id""=""t2"".""account_id"") AS ""x"") SELECT DISTINCT ""account_id"" FROM (SELECT ""account_id"",""exce_in"",""month_day""-""rnk"" AS ""consec"" FROM (SELECT ""account_id"",""month_day"",RANK() OVER (PARTITION BY ""account_id"" ORDER BY ""month_day"") AS ""rnk"",""exce_in"" FROM ""cte2"" WHERE ""exce_in""=1) AS ""x"") AS ""y"" GROUP BY ""account_id"",""consec"" HAVING SUM(""exce_in"")>=2"
300,"WITH ""cte"" AS (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month"",SUM(""amount"") AS ""total_amount"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY 1,2), ""sus"" AS (SELECT ""cte"".* FROM ""cte"" JOIN ""accounts"" AS ""t"" ON ""t"".""account_id""=""cte"".""account_id"" WHERE ""t"".""max_income""<""cte"".""total_amount""), ""cte_rank"" AS (SELECT ""account_id"",""total_amount"",""month"",DENSE_RANK() OVER (PARTITION BY ""account_id"" ORDER BY ""month"") AS ""drk"",""month""-DENSE_RANK() OVER (PARTITION BY ""account_id"" ORDER BY ""month"") AS ""grp"" FROM ""sus"") SELECT DISTINCT ""account_id"" FROM ""cte_rank"" GROUP BY ""grp"",""account_id"" HAVING COUNT(""account_id"")>=2"
301,"WITH ""cteI"" AS (SELECT ""account_id"",""amount"",TO_CHAR(""day"", 'YYYY-%m') AS ""d"",TO_CHAR(""day"" + INTERVAL '1 MONTH', 'YYYY-%m') AS ""dnext"" FROM ""Transactions"" WHERE ""type""='Creditor'), ""cteMI"" AS (SELECT ""cteI"".""account_id"",SUM(""amount"")-""max_income"" AS ""overage"",""d"",""dnext"" FROM (""cteI"") CROSS JOIN ""Accounts"" WHERE ""cteI"".""account_id""=""Accounts"".""account_id"" GROUP BY ""account_id"",""d""), ""cteMI2"" AS (SELECT ""a"".*,COALESCE(""b"".""d"", '0') AS ""dd"" FROM ""cteMI"" AS ""a"" LEFT JOIN ""cteMI"" AS ""b"" ON ""a"".""dnext""=""b"".""d"" AND ""a"".""account_id""=""b"".""account_id"" WHERE ""a"".""overage"">0 AND ""b"".""overage"">0) SELECT DISTINCT ""account_id"" FROM ""cteMI2"" ORDER BY ""account_id"""
302,"WITH ""t"" AS (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month"",SUM(""amount"") AS ""total"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY 1,2) SELECT DISTINCT ""a"".""account_id"" FROM (""t"" AS ""a"" JOIN ""t"" AS ""b"" ON ""a"".""month""+1=""b"".""month"") JOIN ""accounts"" AS ""c"" ON ""a"".""account_id""=""c"".""account_id"" AND ""b"".""account_id""=""c"".""account_id"" WHERE ""a"".""total"">""max_income"" AND ""b"".""total"">""max_income"""
303,"WITH ""cte"" AS (SELECT TO_CHAR(""day"", 'YYYY%m') AS ""month"",""t"".""account_id"",""a"".""max_income"",SUM(""amount"") AS ""income"" FROM ""transactions"" AS ""t"" LEFT JOIN ""accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""type""='Creditor' GROUP BY 1,2 HAVING SUM(""amount"")>""a"".""max_income"") SELECT DISTINCT ""c1"".""account_id"" FROM ""cte"" AS ""c1"" LEFT JOIN ""cte"" AS ""c2"" ON ""c1"".""account_id""=""c2"".""account_id"" WHERE PERIOD_DIFF(""c1"".""month"", ""c2"".""month"")=1"
304,"SELECT DISTINCT ""account_id"" FROM (SELECT ""f"".""account_id"",""month"",LAG(""month"") OVER (PARTITION BY ""account_id"" ORDER BY ""month"") AS ""prev"" FROM (SELECT ""account_id"",TO_CHAR(""day"", 'YYYY-%m-01') AS ""month"",SUM(CASE WHEN ""type""='Creditor' THEN ""amount"" ELSE 0 END) AS ""amount"" FROM ""transactions"" GROUP BY 1,2) AS ""f"" JOIN ""accounts"" AS ""a"" ON ""a"".""account_id""=""f"".""account_id"" WHERE ""amount"">""max_income"") AS ""f"" WHERE ""month"" + INTERVAL '-1 MONTH'=""prev"""
305,"WITH ""cte"" AS (SELECT ""sub"".* FROM (SELECT ""account_id"",EXTRACT(MONTH FROM ""DAY"") AS ""MNTH"",SUM(""AMOUNT"") AS ""AMOUNT"" FROM ""TRANSACTIONS"" WHERE ""TYPE""='Creditor' GROUP BY ""account_id"",EXTRACT(MONTH FROM ""DAY"")) AS ""sub"" JOIN ""Accounts"" AS ""A"" ON ""sub"".""account_id""=""A"".""account_id"" AND ""sub"".""amount"">""A"".""max_income"") SELECT DISTINCT (""c1"".""account_id"") FROM ""cte"" AS ""c1"" JOIN ""cte"" AS ""c2"" ON ""c1"".""account_id""=""c2"".""account_id"" WHERE (""c1"".""mnth""+1=""c2"".""mnth"")"
306,"WITH ""cte"" AS (SELECT ""account_id"",""month"" FROM (SELECT EXTRACT(MONTH FROM ""day"") AS ""month"",""Transactions"".""account_id"",SUM(""amount"") AS ""totalincome"",""max_income"" FROM ""Transactions"" JOIN ""Accounts"" ON ""Transactions"".""account_id""=""Accounts"".""account_id"" WHERE ""type""='Creditor' GROUP BY ""month"",""account_id"") AS ""tb"" WHERE ""totalincome"">""max_income"") SELECT DISTINCT ""c1"".""account_id"" FROM ""cte"" AS ""c1"" JOIN ""cte"" AS ""c2"" ON ""c1"".""account_id""=""c2"".""account_id"" AND ""c1"".""month""+1=""c2"".""month"""
307,"WITH ""CTE"" AS (SELECT ""account_id"",""day"",SUM(""amount"") AS ""amount"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",TO_CHAR(""day"", 'YYYY-%m') ORDER BY ""account_id"") SELECT DISTINCT ""tab"".""account_id"" FROM (SELECT ""t1"".""account_id"",TO_CHAR(""t1"".""day"", 'YYYY-%m') AS ""t1Date"",""t1"".""amount"" AS ""t1amount"",TO_CHAR(""t2"".""day"", 'YYYY-%m') AS ""t2Date"",""t2"".""amount"" AS ""t2amount"" FROM ""CTE"" AS ""t1"" JOIN ""CTE"" AS ""t2"" ON (""t1"".""account_id""=""t2"".""account_id"") AND (TO_CHAR(""t2"".""day"", 'YYYY-%m')=TO_CHAR(""t1"".""day"" + INTERVAL '1 MONTH', 'YYYY-%m'))) AS ""tab"" JOIN ""accounts"" ON ""accounts"".""account_id""=""tab"".""account_id"" WHERE (""tab"".""t1amount"">""accounts"".""max_income"") AND (""tab"".""t2amount"">""accounts"".""max_income"")"
308,"WITH ""cte"" AS (SELECT ""t"".""account_id"",EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day"") AS ""month"",(CASE WHEN SUM(""amount"")>""a"".""max_income"" THEN 1 ELSE 0 END) AS ""exceed"" FROM ""transactions"" AS ""t"" JOIN ""accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""type""='Creditor' GROUP BY EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day""),""t"".""account_id"") SELECT DISTINCT ""c1"".""account_id"" FROM (""cte"" AS ""c1"") CROSS JOIN ""cte"" AS ""c2"" WHERE ""c1"".""account_id""=""c2"".""account_id"" AND ""c2"".""month""-""c1"".""month""=1 AND ""c1"".""exceed""=1 AND ""c2"".""exceed""=1"
309,"WITH ""cte"" AS (SELECT ""t"".""account_id"",EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day"") AS ""month"",(CASE WHEN SUM(""amount"")>""a"".""max_income"" THEN 1 ELSE 0 END) AS ""exceed"" FROM (""transactions"" AS ""t"") CROSS JOIN ""accounts"" AS ""a"" WHERE ""t"".""account_id""=""a"".""account_id"" AND ""type""='Creditor' GROUP BY EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day""),""t"".""account_id"") SELECT DISTINCT ""c1"".""account_id"" FROM (""cte"" AS ""c1"") CROSS JOIN ""cte"" AS ""c2"" WHERE ""c1"".""account_id""=""c2"".""account_id"" AND ""c2"".""month""-""c1"".""month""=1 AND ""c1"".""exceed""=1 AND ""c2"".""exceed""=1"
310,"SELECT DISTINCT ""account_id"" FROM (SELECT ""account_id"",""month"",""total_income"",LEAD(""month"", 1) OVER (PARTITION BY ""account_id"" ORDER BY ""month"") AS ""next_month"",LEAD(""total_income"", 1) OVER (PARTITION BY ""account_id"" ORDER BY ""month"") AS ""total_income_next_month"",""max_income"" FROM (SELECT ""a"".""account_id"",DATE(""day"" - INTERVAL 'DAYOFMONTH(""day"")-1 DAY') AS ""month"",""a"".""max_income"",SUM(CASE WHEN ""type""='Creditor' THEN ""amount"" ELSE 0 END) AS ""total_income"" FROM ""Transactions"" AS ""t"" JOIN ""Accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" GROUP BY 1,2,3) AS ""t1"") AS ""t2"" WHERE ""total_income"">""max_income"" AND ""total_income_next_month"">""max_income"" AND TO_CHAR(""month"" + INTERVAL '1 MONTH', 'YYYY-%m-01')=""next_month"" ORDER BY 1"
311,"WITH ""cte"" AS (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month"",SUM(""amount"") AS ""amt"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",EXTRACT(MONTH FROM ""day"")) SELECT DISTINCT ""c1"".""account_id"" FROM (""cte"" AS ""c1"" JOIN ""cte"" AS ""c2"" ON ""c1"".""account_id""=""c2"".""account_id"" AND ""c1"".""month""=""c2"".""month""-1) JOIN ""Accounts"" AS ""a"" ON ""c1"".""account_id""=""a"".""account_id"" WHERE ""c1"".""amt"">""max_income"" AND ""c2"".""amt"">""max_income"""
312,"WITH ""cte"" AS (SELECT ""t"".""account_id"",EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day"") AS ""month"",(CASE WHEN SUM(""amount"")>""a"".""max_income"" THEN 1 ELSE 0 END) AS ""exceed"" FROM ""transactions"" AS ""t"" JOIN ""accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""type""='Creditor' GROUP BY EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day""),""t"".""account_id"") SELECT DISTINCT ""c1"".""account_id"" FROM (""cte"" AS ""c1"") CROSS JOIN ""cte"" AS ""c2"" WHERE ""c1"".""account_id""=""c2"".""account_id"" AND ""c2"".""month""-""c1"".""month""=1 AND ""c1"".""exceed""=1 AND ""c2"".""exceed""=1"
313,"WITH ""tot_income"" AS (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""Mon_yr"",SUM(""amount"") AS ""total_Income"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY 1,2 ORDER BY ""transaction_id""), ""Sus_Bank_account"" AS (SELECT ""A"".""account_id"",""t"".""Mon_yr"",LAG(""Mon_yr"", 1) OVER (PARTITION BY ""t"".""account_id"" ORDER BY ""t"".""Mon_yr"") AS ""Prev_mon"" FROM ""Accounts"" AS ""A"" JOIN ""tot_income"" AS ""t"" ON ""A"".""account_id""=""t"".""account_id"" WHERE ""t"".""total_Income"">""A"".""max_income"") SELECT DISTINCT ""S"".""account_id"" FROM ""Sus_Bank_account"" AS ""S"" WHERE ""S"".""Mon_yr""-""S"".""Prev_mon""=1"
314,"SELECT DISTINCT ""account_id"" FROM (SELECT ROW_NUMBER() OVER (PARTITION BY ""account_id"", ""sus"" ORDER BY ""month_year""),""month_year"",""mon"",""yr"",""account_id"",""total"",""max_income"",""sus"",""mon""-ROW_NUMBER() OVER (PARTITION BY ""account_id"", ""sus"" ORDER BY ""month_year"") AS ""gid"" FROM (SELECT TO_CHAR(""t"".""day"", 'YYYY-%m') AS ""month_year"",EXTRACT(MONTH FROM ""t"".""day"") AS ""mon"",EXTRACT(YEAR FROM ""t"".""day"") AS ""yr"",""t"".""account_id"",SUM(""t"".""amount"") AS ""total"",""a"".""max_income"",CASE WHEN SUM(""t"".""amount"")>""a"".""max_income"" THEN 1 ELSE 0 END AS ""sus"" FROM (""Transactions"" AS ""t"") CROSS JOIN ""Accounts"" AS ""a"" WHERE ""t"".""type""='Creditor' AND ""t"".""account_id""=""a"".""account_id"" GROUP BY 1,4) AS ""a"" WHERE ""sus""=1) AS ""b"" GROUP BY ""account_id"",""gid"" HAVING COUNT(1)>1"
315,"WITH ""cte"" AS (SELECT ""a"".""account_id"" AS ""account_id"",""sub1"".""month"" AS ""month"",CASE WHEN ""sub1"".""total_income"">""a"".""max_income"" THEN 'y' ELSE 'n' END AS ""exceed"" FROM (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month"",SUM(""amount"") AS ""total_income"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY 1,2 ORDER BY 1,2) AS ""sub1"" LEFT JOIN ""Accounts"" AS ""a"" ON ""a"".""account_id""=""sub1"".""account_id""), ""exceed_table"" AS (SELECT ""account_id"",""month"",""exceed"",(""month""-RANK() OVER (PARTITION BY ""account_id"" ORDER BY ""month"")) AS ""rank_diff"" FROM ""cte"" WHERE ""exceed""='y') SELECT DISTINCT (""account_id"") FROM ""exceed_table"" GROUP BY ""account_id"",""rank_diff"" HAVING COUNT(1)>1"
316,"WITH ""CTE"" AS (SELECT ""account_id"",""day"",SUM(""amount"") AS ""amount"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",TO_CHAR(""day"", 'YYYY-%m') ORDER BY ""account_id"") SELECT DISTINCT ""tab"".""account_id"" FROM (SELECT ""t1"".""account_id"",TO_CHAR(""t1"".""day"", 'YYYY-%m') AS ""t1Date"",""t1"".""amount"" AS ""t1amount"",TO_CHAR(""t2"".""day"", 'YYYY-%m') AS ""t2Date"",""t2"".""amount"" AS ""t2amount"" FROM ""CTE"" AS ""t1"" JOIN ""CTE"" AS ""t2"" ON (""t1"".""account_id""=""t2"".""account_id"") AND (TO_CHAR(""t2"".""day"", 'YYYY-%m')=TO_CHAR(""t1"".""day"" + INTERVAL '1 MONTH', 'YYYY-%m'))) AS ""tab"" JOIN ""accounts"" ON ""accounts"".""account_id""=""tab"".""account_id"" WHERE (""tab"".""t1amount"">""accounts"".""max_income"") AND (""tab"".""t2amount"">""accounts"".""max_income"")"
317,"WITH ""cte"" AS (SELECT ""account_id"",""month"" FROM (SELECT ""T"".""account_id"",""max_income"",TO_CHAR(""day"", 'YYYY-%m') AS ""month"",SUM(""amount"") AS ""total_income"" FROM ""Transactions"" AS ""T"" JOIN ""Accounts"" AS ""A"" ON ""T"".""account_id""=""A"".""account_id"" AND ""type""='Creditor' GROUP BY ""account_id"",""month"",""max_income"") AS ""t1"" WHERE ""total_income"">""max_income"") SELECT DISTINCT ""account_id"" FROM (SELECT ""account_id"",""month"",LAG(""month"") OVER (PARTITION BY ""account_id"" ORDER BY ""month"") AS ""prev_month"" FROM ""cte"") AS ""t2"" WHERE ""prev_month"" IS NOT NULL AND CONCAT(""month"", '-01') - INTERVAL '1 MONTH'=CONCAT(""prev_month"", '-01')"
318,"WITH ""temp"" AS (SELECT ""t"".""account_id"",CONCAT(LEFT(""day"", 7), '-01') AS ""first_date"",""a"".""max_income"",SUM(""amount"") AS ""total_amount"" FROM ""Transactions"" AS ""t"" LEFT JOIN ""Accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""type""='Creditor' GROUP BY ""t"".""account_id"",LEFT(""day"", 7)) SELECT DISTINCT ""t1"".""account_id"" FROM ""temp"" AS ""t1"" JOIN ""temp"" AS ""t2"" ON ""t1"".""account_id""=""t2"".""account_id"" AND TIMESTAMPDIFF(MONTH, ""t1"".""first_date"", ""t2"".""first_date"")=1 WHERE ""t1"".""total_amount"">""t1"".""max_income"" AND ""t2"".""total_amount"">""t2"".""max_income"""
319,"WITH ""cte"" AS (SELECT ""t"".""account_id"",""month"" FROM (SELECT ""account_id"",SUM(""amount"") AS ""total_income"",EXTRACT(MONTH FROM ""day"") AS ""month"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",""month"") AS ""t"" CROSS, ""Accounts"" AS ""a"" WHERE ""t"".""account_id""=""a"".""account_id"" AND ""total_income"">""max_income"") SELECT ""c1"".""account_id"" FROM (""cte"" AS ""c1"") CROSS JOIN ""cte"" AS ""c2"" WHERE ""c1"".""account_id""=""c2"".""account_id"" AND ""c1"".""month""-""c2"".""month""=1 GROUP BY ""c1"".""account_id"" ORDER BY ""c1"".""account_id"""
320,"WITH ""CTE"" AS (SELECT ""Transactions"".""account_id"",TO_CHAR(""day"", '%m/YYYY') AS ""Date"",SUM(""amount"") AS ""INCOME"" FROM ""Transactions"" JOIN ""Accounts"" AS ""A"" ON ""Transactions"".""account_id""=""A"".""account_id"" WHERE ""type""='Creditor' GROUP BY ""Transactions"".""account_id"",TO_CHAR(""day"", '%m/YYYY'),""max_income"" HAVING SUM(""amount"")>""A"".""max_income"") SELECT DISTINCT ""C1"".""account_id"" FROM ""CTE"" AS ""C1"" JOIN ""CTE"" AS ""C2"" ON ""C1"".""account_id""=""C2"".""account_id"" AND PERIOD_DIFF(""C2"".""date"", ""C1"".""date"")=1 ORDER BY 1"
321,"WITH ""raw_data"" AS (SELECT DATE(TO_CHAR(""day"", 'YYYY-%m-01')) AS ""month"",""t"".""account_id"",SUM(""t"".""amount"") AS ""amount_credited"" FROM ""transactions"" AS ""t"" WHERE ""type""='Creditor' GROUP BY 1,2), ""raw_data_2"" AS (SELECT ""rd"".""month"" AS ""m"",""rd"".""account_id"",""rd"".""amount_credited"" FROM ""raw_data"" AS ""rd"" JOIN ""accounts"" AS ""a"" ON ""rd"".""account_id""=""a"".""account_id"" WHERE ""rd"".""amount_credited"">""a"".""max_income""), ""raw_data_3"" AS (SELECT ""account_id"",""m"",LAG(""m"", 1) OVER (PARTITION BY ""account_id"" ORDER BY ""m"") AS ""prev_month"" FROM ""raw_data_2"") SELECT DISTINCT ""account_id"" FROM ""raw_data_3"" WHERE ""prev_month"" IS NOT NULL AND ""prev_month"" + INTERVAL '1 MONTH'=""m"""
322,"WITH ""CTE"" AS (SELECT TO_CHAR(""day"", 'YYYY%m') AS ""date"",""Accounts"".""account_id"",SUM(""amount"") AS ""income"",""max_income"" FROM ""Transactions"" JOIN ""Accounts"" ON ""Accounts"".""account_id""=""Transactions"".""account_id"" WHERE ""type""='Creditor' GROUP BY 1,2 HAVING SUM(""amount"")>""max_income"") SELECT DISTINCT ""a"".""account_id"" FROM (""CTE"" AS ""a"") CROSS JOIN ""CTE"" AS ""b"" WHERE ""a"".""account_id""=""b"".""account_id"" AND PERIOD_DIFF(""a"".""date"", ""b"".""date"")=1"
323,"WITH ""cte"" AS (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month"",SUM(""amount"") AS ""total_income"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY 1,2 ORDER BY 1,2), ""sus_account"" AS (SELECT ""a"".""account_id"",""month"" FROM ""cte"" AS ""a"" LEFT JOIN ""Accounts"" AS ""b"" ON ""a"".""account_id""=""b"".""account_id"" WHERE ""total_income"">""max_income"") SELECT DISTINCT ""account_id"" FROM ""sus_account"" WHERE ROW(""account_id"",""month""+1) IN (SELECT ""account_id"",""month"" FROM ""sus_account"") OR ROW(""account_id"",""month""-1) IN (SELECT ""account_id"",""month"" FROM ""sus_account"")"
324,"WITH ""base"" AS (SELECT ""account_id"",TO_CHAR(""day"", 'YYYY-%m-01') AS ""month"",SUM(""amount"") AS ""total"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY 1,2), ""final"" AS (SELECT ""b"".""account_id"",""b"".""month"",CASE WHEN ""b"".""total"">""a"".""max_income"" THEN 'Y' ELSE 'N' END AS ""flag"" FROM ""base"" AS ""b"" JOIN ""accounts"" AS ""a"" ON ""b"".""account_id""=""a"".""account_id"") SELECT ""f"".""account_id"" FROM ""final"" AS ""f"" JOIN ""final"" AS ""fi"" ON ""f"".""account_id""=""fi"".""account_id"" AND ""f"".""month""=""fi"".""month"" + INTERVAL '1 MONTH' AND ""f"".""flag""='Y' AND ""fi"".""flag""='Y' GROUP BY ""f"".""account_id"""
325,"WITH ""cte"" AS (SELECT ""t"".""account_id"",EXTRACT(YEAR_MONTH FROM ""t"".""day"") AS ""tran_year_month"",SUM(CASE WHEN ""t"".""type""='Creditor' THEN ""t"".""amount"" END) AS ""total_income"",CASE WHEN SUM(CASE WHEN ""t"".""type""='Creditor' THEN ""t"".""amount"" END)>""a"".""max_income"" THEN 1 ELSE 0 END AS ""suspecious"" FROM ""Transactions"" AS ""t"" JOIN ""Accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" GROUP BY 1,2) SELECT DISTINCT ""c1"".""account_id"" FROM ""cte"" AS ""c1"" JOIN ""cte"" AS ""c2"" ON ""c1"".""account_id""=""c2"".""account_id"" AND ""c1"".""tran_year_month""=""c2"".""tran_year_month""-1 WHERE ""c1"".""suspecious""=1 AND ""c2"".""suspecious""=1 ORDER BY 1"
326,"WITH ""transaction_cte"" AS (SELECT ""t"".""account_id"",TO_CHAR(""DAY"", 'YYYY%m') AS ""month"",SUM(""amount"") AS ""total_income"",""a"".""max_income"" FROM ""Transactions"" AS ""t"" LEFT JOIN ""Accounts"" AS ""a"" ON ""a"".""account_id""=""t"".""account_id"" WHERE ""t"".""type""='Creditor' GROUP BY 1,2 HAVING ""total_income"">""a"".""max_income""), ""consecutive_cte"" AS (SELECT ""account_id"",LEAD(""month"", 1) OVER (PARTITION BY ""account_id"" ORDER BY ""month"")-""month"" AS ""month_diff"" FROM ""transaction_cte"") SELECT DISTINCT ""account_id"" FROM ""consecutive_cte"" WHERE ""month_diff""=1"
327,"SELECT DISTINCT ""a"".""account_id"" AS ""account_id"" FROM (""Accounts"" AS ""a"" JOIN (SELECT ""account_id"",SUM(""amount"") AS ""amount"",TO_CHAR(""day"", 'YYYY%m') AS ""month"",TO_CHAR(""day"" + INTERVAL '1 MONTH', 'YYYY%m') AS ""next_month"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",TO_CHAR(""day"", 'YYYY%m')) AS ""t1"" ON (""a"".""account_id""=""t1"".""account_id"")) JOIN (SELECT ""account_id"",SUM(""amount"") AS ""amount"",TO_CHAR(""day"", 'YYYY%m') AS ""month"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",TO_CHAR(""day"", 'YYYY%m')) AS ""t2"" ON (""a"".""account_id""=""t2"".""account_id"" AND ""t1"".""next_month""=""t2"".""month"") WHERE ""t1"".""amount"">""a"".""max_income"" AND ""t2"".""amount"">""a"".""max_income"" ORDER BY 1"
328,"WITH ""tmp"" AS (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month"",SUM(""amount"") AS ""tot"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY 1,2) SELECT DISTINCT ""account_id"" FROM (SELECT ""a"".""account_id"",""a"".""month"",LAG(""a"".""month"") OVER (PARTITION BY ""a"".""account_id"" ORDER BY ""a"".""month"") AS ""lg"" FROM ""tmp"" AS ""a"" JOIN ""Accounts"" AS ""b"" ON ""a"".""account_id""=""b"".""account_id"" AND ""a"".""tot"">""b"".""max_income"") AS ""T"" WHERE ""month""-""lg""=1"
329,"WITH ""exe"" AS (SELECT ""a"".""account_id"",EXTRACT(YEAR FROM ""a"".""day"") AS ""yy"",EXTRACT(MONTH FROM ""a"".""day"") AS ""mm"" FROM ""transactions"" AS ""a"" WHERE ""a"".""type""='Creditor' GROUP BY ""a"".""account_id"",EXTRACT(YEAR FROM ""a"".""day""),EXTRACT(MONTH FROM ""a"".""day"") HAVING SUM(""a"".""amount"")>(SELECT ""max_income"" FROM ""accounts"" WHERE ""account_id""=""a"".""account_id"")) SELECT DISTINCT ""a"".""account_id"" FROM (""exe"" AS ""a"") CROSS JOIN ""exe"" AS ""b"" WHERE ""a"".""account_id""=""b"".""account_id"" AND ((""a"".""yy""=""b"".""yy"" AND ""b"".""mm""-""a"".""mm""=1) OR (""a"".""mm""=12 AND ""b"".""mm""=1 AND ""a"".""yy""=""b"".""yy""-1)) ORDER BY ""a"".""account_id"""
330,"WITH ""cte"" AS (SELECT ""transaction_id"",""t"".""account_id"",EXTRACT(MONTH FROM ""t"".""day"") AS ""month"",""a"".""max_income"" FROM ""Accounts"" AS ""a"" JOIN ""Transactions"" AS ""t"" USING (""account_id"") GROUP BY ""t"".""account_id"",""month"" HAVING SUM(CASE WHEN ""type""='Creditor' THEN ""amount"" ELSE 0 END)>""a"".""max_income"") SELECT DISTINCT ""c1"".""account_id"" FROM (""cte"" AS ""c1"") CROSS JOIN ""cte"" AS ""c2"" WHERE ""c1"".""account_id""=""c2"".""account_id"" AND PERIOD_DIFF(""c1"".""month"", ""c2"".""month"")=1 ORDER BY ""c1"".""transaction_id"""
331,"WITH ""temp"" AS (SELECT ""t"".""account_id"",TO_CHAR(""day"", 'YYYY%m') AS ""date"",SUM(""amount"") AS ""income"",""a"".""max_income"" FROM ""transactions"" AS ""t"" LEFT JOIN ""accounts"" AS ""a"" USING (""account_id"") WHERE ""t"".""type""='Creditor' GROUP BY ""t"".""account_id"",TO_CHAR(""t"".""day"", 'YYYY%m') HAVING SUM(""t"".""amount"")>""a"".""max_income"") SELECT ""t1"".""account_id"" FROM (""temp"" AS ""t1"") CROSS JOIN ""temp"" AS ""t2"" WHERE ""t1"".""account_id""=""t2"".""account_id"" AND PERIOD_DIFF(""t1"".""date"", ""t2"".""date"")=1 GROUP BY ""t1"".""account_id"""
332,"SELECT DISTINCT ""account_id"" FROM (SELECT ""account_id"",""total_income"",""second_month"",LEAD(""month"", 1) OVER (PARTITION BY ""account_id"") AS ""next_month"" FROM (SELECT ""t"".""account_id"",""a"".""max_income"",TO_CHAR(""t"".""day"", 'YYYY-%m') AS ""month"",TO_CHAR(""t"".""day"" + INTERVAL '1 MONTH', 'YYYY-%m') AS ""second_month"",SUM(CASE WHEN ""t"".""type""='Creditor' THEN ""t"".""amount"" ELSE 0 END) AS ""total_income"" FROM ""Transactions"" AS ""t"" JOIN ""Accounts"" AS ""a"" ON ""a"".""account_id""=""t"".""account_id"" GROUP BY 1,2,3,4 ORDER BY 1,3) AS ""sub"" WHERE ""total_income"">""max_income"") AS ""sub"" WHERE ""second_month""=""next_month"""
333,"WITH ""t1"" AS (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month"",SUM(CASE WHEN ""type""='Creditor' THEN ""amount"" ELSE 0 END) AS ""total_income"",""max_income"" FROM ""transactions"" JOIN ""accounts"" USING (""account_id"") GROUP BY 1,2 ORDER BY 1,2) SELECT DISTINCT ""a"".""account_id"" FROM ""t1"" AS ""a"" JOIN ""t1"" AS ""b"" ON ""a"".""account_id""=""b"".""account_id"" AND ""a"".""month""+1=""b"".""month"" WHERE ""a"".""total_income"">""a"".""max_income"" AND ""b"".""total_income"">""b"".""max_income"""
334,"WITH ""tmp"" AS (SELECT ""account_id"",SUM(CASE WHEN ""type""='Creditor' THEN ""amount"" ELSE 0 END) AS ""amount"",EXTRACT(MONTH FROM ""day"") AS ""month"" FROM ""transactions"" GROUP BY ""account_id"",""month"") SELECT DISTINCT ""a"".""account_id"" FROM (""tmp"" AS ""a"" JOIN ""tmp"" AS ""b"" ON ""b"".""month""-""a"".""month""=1 AND ""a"".""account_id""=""b"".""account_id"") JOIN ""accounts"" AS ""c"" ON ""a"".""account_id""=""c"".""account_id"" WHERE ""a"".""amount"">""max_income"" AND ""b"".""amount"">""max_income"" ORDER BY ""account_id"""
335,"WITH ""CET"" AS (SELECT ""T"".""account_id"",EXTRACT(MONTH FROM ""day"") AS ""DAY"",""max_income"" FROM ""Transactions"" AS ""T"" JOIN ""Accounts"" AS ""A"" ON ""T"".""account_id""=""A"".""account_id"" WHERE ""type""='Creditor' GROUP BY ""account_id"",EXTRACT(MONTH FROM ""day"") HAVING SUM(""amount"")>""A"".""max_income"") SELECT DISTINCT ""account_id"" FROM ""CET"" WHERE ROW(""account_id"",""DAY""-1) IN (SELECT ""account_id"",""DAY"" FROM ""CET"") OR ROW(""account_id"",""DAY""+1) IN (SELECT ""account_id"",""DAY"" FROM ""CET"")"
336,"WITH ""cte"" AS (SELECT ""account_id"",""day"",CASE WHEN ""amount"">""max_income"" THEN 1 ELSE 0 END AS ""indics"" FROM (SELECT ""a"".""account_id"",EXTRACT(MONTH FROM ""day"") AS ""day"",SUM(CASE WHEN ""type""='creditor' THEN ""amount"" ELSE 0 END) AS ""amount"",""max_income"" FROM ""transactions"" AS ""a"" JOIN ""accounts"" AS ""b"" ON ""a"".""account_id""=""b"".""account_id"" GROUP BY 1,2) AS ""c"") SELECT DISTINCT ""a"".""account_id"" FROM ""cte"" AS ""a"" LEFT JOIN ""cte"" AS ""b"" ON ""a"".""indics""=""b"".""indics"" AND ""a"".""account_id""=""b"".""account_id"" WHERE ""a"".""indics""=1 AND ""a"".""day""-""b"".""day""=1 ORDER BY 1"
337,"WITH ""cte"" AS (SELECT ""t"".""account_id"",SUM(""amount"") AS ""amt"",MAX(""max_income"") AS ""mx"",EXTRACT(YEAR FROM ""day"") AS ""yr"",EXTRACT(MONTH FROM ""day"") AS ""mnt"" FROM ""transactions"" AS ""t"" LEFT JOIN ""accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""type""='Creditor' GROUP BY ""t"".""account_id"",EXTRACT(YEAR FROM ""day""),EXTRACT(MONTH FROM ""day"") HAVING SUM(""amount"")>MAX(""max_income"")), ""cte2"" AS (SELECT ""account_id"",""yr"",""mnt"",LEAD(""mnt"") OVER (PARTITION BY ""account_id"" ORDER BY ""yr"",""mnt"") AS ""nxt_mnt"" FROM ""cte"") SELECT DISTINCT ""account_id"" FROM ""cte2"" WHERE ""nxt_mnt""-""mnt""=1"
338,"WITH RECURSIVE ""cte_months"" AS (SELECT LAST_DAY(DATE(MIN(""day""))) AS ""eom"" FROM ""Transactions"" UNION ALL SELECT ""eom"" + INTERVAL '1 MONTH' AS ""eom"" FROM ""cte_months"" WHERE ""eom""<(SELECT DATE(MAX(""day"")) FROM ""Transactions"")), ""cte_agg"" AS (SELECT ""a"".""account_id"",""m"".""eom"",SUM(CASE WHEN ""t"".""type""='Creditor' THEN ""t"".""amount"" ELSE 0 END)>AVG(""a"".""max_income"") AS ""is_sus_acct_mth"" FROM (""Accounts"" AS ""a"" CROSS JOIN ""cte_months"" AS ""m"") LEFT JOIN ""Transactions"" AS ""t"" ON ""a"".""account_id""=""t"".""account_id"" AND EXTRACT(MONTH FROM ""t"".""day"")=EXTRACT(MONTH FROM ""m"".""eom"") AND EXTRACT(YEAR FROM ""t"".""day"")=EXTRACT(YEAR FROM ""m"".""eom"") GROUP BY 1,2), ""cte_window"" AS (SELECT ""account_id"",""is_sus_acct_mth""+COALESCE(LEAD(""is_sus_acct_mth"", 1) OVER (PARTITION BY ""account_id"" ORDER BY ""eom""), 0)=2 AS ""is_sus_account"" FROM ""cte_agg""), ""cte_final"" AS (SELECT DISTINCT ""account_id"" FROM ""cte_window"" WHERE ""is_sus_account""=1 ORDER BY 1) SELECT * FROM ""cte_final"""
339,"SELECT ""c"".""account_id"" FROM (SELECT ""a"".""account_id"",""a"".""yymm"" AS ""current_month"",""a"".""total_income"",LEAD(""a"".""yymm"") OVER (PARTITION BY ""a"".""account_id"" ORDER BY ""a"".""yymm"") AS ""nex_month"",LEAD(""a"".""total_income"") OVER (PARTITION BY ""a"".""account_id"" ORDER BY ""yymm"") AS ""nex_month_income"",""b"".""max_income"" FROM (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""yymm"",SUM(""amount"") AS ""total_income"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY 1,2) AS ""a"" LEFT JOIN ""accounts"" AS ""b"" ON ""a"".""account_id""=""b"".""account_id"") AS ""c"" WHERE ""c"".""total_income"">""c"".""max_income"" AND ""c"".""nex_month_income"">""c"".""max_income"" AND ""c"".""nex_month""-""c"".""current_month""=1 GROUP BY 1"
340,"WITH ""credits"" AS (SELECT ""account_id"",TO_CHAR(""day"", 'YYYY-%m') AS ""month"",SUM(""amount"") AS ""amount"",""transaction_id"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",TO_CHAR(""day"", 'YYYY-%m')), ""next_month_credits"" AS (SELECT ""account_id"",""month"" AS ""current_month"",""amount"" AS ""current_amount"",LEAD(""month"") OVER (PARTITION BY ""account_id"" ORDER BY ""month"") AS ""next_month"",LEAD(""amount"") OVER (PARTITION BY ""account_id"" ORDER BY ""month"") AS ""next_amount"" FROM ""credits"") SELECT DISTINCT (""account_id"") FROM ""next_month_credits"" LEFT JOIN ""Accounts"" USING (""account_id"") WHERE ""current_amount"">""max_income"" AND ""next_amount"">""max_income"" AND TIMESTAMPDIFF(MONTH, CONCAT(""current_month"", '-01'), CONCAT(""next_month"", '-01'))=1"
341,"WITH ""base"" AS (SELECT ""account_id"",LAST_DAY(CAST(""day"" AS DATE)) AS ""month_year"",SUM(""amount"") AS ""total_income"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",LAST_DAY(CAST(""day"" AS DATE))), ""result"" AS (SELECT ""a"".""account_id"",""b"".""month_year"",CASE WHEN ""b"".""total_income"">""a"".""max_income"" THEN 1 ELSE 0 END AS ""flags"" FROM ""accounts"" AS ""a"" LEFT JOIN ""base"" AS ""b"" ON ""a"".""account_id""=""b"".""account_id"" ORDER BY ""a"".""account_id"",""b"".""month_year"") SELECT DISTINCT ""a1"".""account_id"" FROM ""result"" AS ""a1"" JOIN ""result"" AS ""a2"" ON ""a1"".""account_id""=""a2"".""account_id"" AND ""a2"".""month_year""=LAST_DAY(""a1"".""month_year"" + INTERVAL '1 MONTH') WHERE ""a1"".""flags""+""a2"".""flags""=2"
342,"SELECT ""c"".""account_id"" FROM (SELECT ""a"".""account_id"",""a"".""yymm"" AS ""current_month"",""a"".""total_income"",LEAD(""a"".""yymm"") OVER (PARTITION BY ""a"".""account_id"" ORDER BY ""a"".""yymm"") AS ""nex_month"",LEAD(""a"".""total_income"") OVER (PARTITION BY ""a"".""account_id"" ORDER BY ""yymm"") AS ""nex_month_income"",""b"".""max_income"" FROM (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""yymm"",SUM(""amount"") AS ""total_income"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY 1,2) AS ""a"" LEFT JOIN ""accounts"" AS ""b"" ON ""a"".""account_id""=""b"".""account_id"") AS ""c"" WHERE ""c"".""total_income"">""c"".""max_income"" AND ""c"".""nex_month_income"">""c"".""max_income"" AND ""c"".""nex_month""-""c"".""current_month""=1 GROUP BY 1"
343,"WITH ""cte"" AS (SELECT ""t"".""account_id"",CASE WHEN EXTRACT(MONTH FROM ""t"".""day"")<10 THEN CONCAT(EXTRACT(YEAR FROM ""t"".""day""), '-0', EXTRACT(MONTH FROM ""t"".""day""), '-01') ELSE CONCAT(EXTRACT(YEAR FROM ""t"".""day""), '-', EXTRACT(MONTH FROM ""t"".""day""), '-01') END AS ""month"",SUM(""t"".""amount"") AS ""amount"",CONCAT(EXTRACT(YEAR FROM ""t"".""day""), '-', EXTRACT(MONTH FROM ""t"".""day""), '-01') - INTERVAL '1 MONTH' AS ""prevmonth"" FROM ""Transactions"" AS ""t"" WHERE ""t"".""type""='Creditor' GROUP BY 1,2), ""cte2"" AS (SELECT ""c"".""account_id"",""c"".""month"",""c"".""amount"",""c"".""prevmonth"",COALESCE(""c2"".""amount"", 0) AS ""prevmonthamnt"",CASE WHEN ""c"".""amount"">""a"".""max_income"" AND COALESCE(""c2"".""amount"", 0)>""a"".""max_income"" THEN 1 ELSE 0 END AS ""suspicious"" FROM (""cte"" AS ""c"" LEFT JOIN ""cte"" AS ""c2"" ON ""c"".""account_id""=""c2"".""account_id"" AND ""c"".""prevmonth""=""c2"".""month"") LEFT JOIN ""Accounts"" AS ""a"" ON ""c"".""account_id""=""a"".""account_id"") SELECT ""account_id"" FROM ""cte2"" GROUP BY 1 HAVING SUM(""suspicious"")>0"
344,"WITH ""base"" AS (SELECT ""account_id"",SUBSTR(""day"", 1, 7) AS ""mo"",SUM(CASE WHEN ""type""='Creditor' THEN ""amount"" ELSE 0 END) AS ""income"" FROM ""Transactions"" GROUP BY 1,2), ""ls"" AS (SELECT ""b"".""account_id"",""b"".""mo"",""b"".""income"",""a"".""max_income"",CONCAT(""b"".""mo"", '-01') AS ""begin_mo"",CASE WHEN ""income"">""max_income"" THEN 1 ELSE 0 END AS ""sus"" FROM ""base"" AS ""b"" JOIN ""accounts"" AS ""a"" ON ""b"".""account_id""=""a"".""account_id""), ""ls2"" AS (SELECT ""account_id"",""mo"",""sus"",""begin_mo"",LEAD(""sus"") OVER (PARTITION BY ""account_id"" ORDER BY ""mo"") AS ""sus_next"",LEAD(""begin_mo"") OVER (PARTITION BY ""account_id"" ORDER BY ""mo"") AS ""mon_next"" FROM ""ls"") SELECT DISTINCT ""account_id"" FROM ""ls2"" WHERE ""sus""=1 AND ""sus_next""=1 AND TIMESTAMPDIFF(MONTH, ""begin_mo"", ""mon_next"")<=1"
345,"SELECT ""d"".""account_id"" FROM (SELECT ""c1"".""account_id"",COUNT(1) AS ""ct"" FROM (SELECT DISTINCT ""a"".* FROM (SELECT ""account_id"",EXTRACT(YEAR FROM ""day"") AS ""year"",EXTRACT(MONTH FROM ""day"") AS ""month"",SUM(""amount"") AS ""total_amount"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",EXTRACT(YEAR FROM ""day""),EXTRACT(MONTH FROM ""day"")) AS ""a"" JOIN ""Accounts"" AS ""b"" ON ""a"".""account_id""=""b"".""account_id"" AND ""a"".""total_amount"">""b"".""max_income"") AS ""c1"" JOIN (SELECT DISTINCT ""a"".* FROM (SELECT ""account_id"",EXTRACT(YEAR FROM ""day"") AS ""year"",EXTRACT(MONTH FROM ""day"") AS ""month"",SUM(""amount"") AS ""total_amount"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",EXTRACT(YEAR FROM ""day""),EXTRACT(MONTH FROM ""day"")) AS ""a"" JOIN ""Accounts"" AS ""b"" ON ""a"".""account_id""=""b"".""account_id"" AND ""a"".""total_amount"">""b"".""max_income"") AS ""c2"" ON (""c1"".""account_id""=""c2"".""account_id"" AND (""c1"".""year""=""c2"".""year"" AND ""c1"".""month""=""c2"".""month""+1)) OR (""c1"".""account_id""=""c2"".""account_id"" AND (""c1"".""year""+1=""c2"".""year"" AND ""c1"".""month""=12 AND ""c2"".""month""=1)) GROUP BY ""c1"".""account_id"") AS ""d"" WHERE ""d"".""ct"">=1"
346,"WITH ""CTE"" AS (SELECT EXTRACT(MONTH FROM ""day"") AS ""month"",""d1"".""account_id"",SUM(""amount"") AS ""total_amount"",""max_income"",CASE WHEN SUM(""amount"")>""max_income"" THEN 1 ELSE 0 END AS ""flag"" FROM ""Transactions"" AS ""d1"" JOIN ""Accounts"" AS ""d2"" ON ""d1"".""account_id""=""d2"".""account_id"" WHERE ""type""='Creditor' GROUP BY EXTRACT(MONTH FROM ""day""),""d1"".""account_id"") SELECT DISTINCT ""c1"".""account_id"" FROM (""cte"" AS ""c1"") CROSS JOIN ""cte"" AS ""c2"" WHERE ""c1"".""account_id""=""c2"".""account_id"" AND ""c2"".""month""-""c1"".""month""=1 AND ""c1"".""flag""=1 AND ""c2"".""flag""=1"
347,"WITH ""cte"" AS (SELECT ""t"".""account_id"",""t"".""month"" FROM (SELECT ""account_id"",TO_CHAR(""day"", 'YYYY%m') AS ""month"",SUM(""amount"") AS ""total"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY 1,2) AS ""t"" JOIN ""accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" AND ""t"".""total"">""a"".""max_income"") SELECT DISTINCT ""c1"".""account_id"" FROM ""cte"" AS ""c1"" JOIN ""cte"" AS ""c2"" ON ""c1"".""account_id""=""c2"".""account_id"" AND ""c2"".""month""-""c1"".""month""=1"
348,"WITH ""temp"" AS (SELECT ""a"".""account_id"",EXTRACT(YEAR FROM ""day"") AS ""year"",EXTRACT(MONTH FROM ""day"") AS ""month"",SUM(CASE WHEN ""type""='Creditor' THEN ""amount"" ELSE 0 END) AS ""total_income"",""max_income"" FROM ""Accounts"" AS ""a"" JOIN ""Transactions"" AS ""t"" ON ""a"".""account_id""=""t"".""account_id"" GROUP BY ""a"".""account_id"",LEFT(""day"", 7) HAVING ""total_income"">""max_income"") SELECT DISTINCT ""t"".""account_id"" FROM ""temp"" AS ""t"" JOIN ""temp"" AS ""u"" ON ""t"".""account_id""=""u"".""account_id"" WHERE ""t"".""year""=""u"".""year"" AND ""t"".""month""+1=""u"".""month"" ORDER BY ""account_id"""
349,"WITH ""cte1"" AS (SELECT ""t"".""account_id"",EXTRACT(MONTH FROM ""t"".""day"") AS ""month"",CASE WHEN SUM(""t"".""amount"")>""a"".""max_income"" THEN 1 ELSE 0 END AS ""ifst"" FROM ""transactions"" AS ""t"" LEFT JOIN ""accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""t"".""type""='Creditor' GROUP BY ""t"".""account_id"",EXTRACT(MONTH FROM ""t"".""day"") ORDER BY ""t"".""account_id"",""month"") SELECT DISTINCT (""c1"".""account_id"") FROM ""cte1"" AS ""c1"" JOIN ""cte1"" AS ""c2"" ON ""c1"".""account_id""=""c2"".""account_id"" AND ""c1"".""month""=""c2"".""month""+1 AND ""c1"".""ifst""=1 AND ""c2"".""ifst""=1"
350,"WITH ""temp"" AS (SELECT ""t"".""account_id"",TO_CHAR(""day"", 'YYYY%m') AS ""date"",SUM(""amount"") AS ""income"",""Accounts"".""max_income"" FROM ""Transactions"" AS ""t"" LEFT JOIN ""Accounts"" ON ""Accounts"".""account_id""=""t"".""account_id"" WHERE ""t"".""type""='Creditor' GROUP BY ""t"".""account_id"",TO_CHAR(""day"", 'YYYY%m') HAVING SUM(""amount"")>""Accounts"".""max_income"") SELECT ""t1"".""account_id"" FROM (""temp"" AS ""t1"") CROSS JOIN ""temp"" AS ""t2"" WHERE ""t1"".""account_id""=""t2"".""account_id"" AND PERIOD_DIFF(""t1"".""date"", ""t2"".""date"")=1 GROUP BY ""t1"".""account_id"" ORDER BY ""t1"".""account_id"""
351,"SELECT DISTINCT ""v2"".""account_id"" FROM (SELECT ""v1"".""account_id"",""v1"".""salaryMonth"" AS ""suspiciousMonth"" FROM (SELECT ""Transactions"".""account_id"",EXTRACT(MONTH FROM ""day"") AS ""salaryMonth"",SUM(""amount"") AS ""salary"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY ""Transactions"".""account_id"",EXTRACT(MONTH FROM ""day"")) AS ""v1"" JOIN ""Accounts"" ON ""v1"".""account_id""=""Accounts"".""account_id"" WHERE ""v1"".""salary"">""Accounts"".""max_income"") AS ""v2"" JOIN (SELECT ""v1"".""account_id"",""v1"".""salaryMonth"" AS ""suspiciousMonth"" FROM (SELECT ""Transactions"".""account_id"",EXTRACT(MONTH FROM ""day"") AS ""salaryMonth"",SUM(""amount"") AS ""salary"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY ""Transactions"".""account_id"",EXTRACT(MONTH FROM ""day"")) AS ""v1"" JOIN ""Accounts"" ON ""v1"".""account_id""=""Accounts"".""account_id"" WHERE ""v1"".""salary"">""Accounts"".""max_income"") AS ""v3"" ON ""v2"".""account_id""=""v3"".""account_id"" AND ""v2"".""suspiciousMonth""+1=""v3"".""suspiciousMonth"""
352,"WITH ""bankacct"" AS (SELECT ""account_id"",CONCAT(LEFT(""day"", 7), '-01') AS ""month"",SUM(""amount"") AS ""total"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",""month"" ORDER BY ""account_id"",""month"") SELECT DISTINCT ""bankacct1"".""account_id"" FROM (""bankacct"" AS ""bankacct1"" CROSS JOIN ""bankacct"" AS ""bankacct2"") JOIN ""Accounts"" AS ""acct"" ON ""bankacct1"".""account_id""=""bankacct2"".""account_id"" AND ""bankacct1"".""month"" + INTERVAL '1 MONTH'=""bankacct2"".""month"" AND ""bankacct1"".""account_id""=""acct"".""account_id"" WHERE ""bankacct1"".""total"">""acct"".""max_income"" AND ""bankacct2"".""total"">""acct"".""max_income"""
353,"WITH ""cte"" AS (SELECT ""a"".""account_id"",EXTRACT(MONTH FROM ""a"".""day"") AS ""month"" FROM ""Transactions"" AS ""a"" LEFT JOIN ""Accounts"" AS ""b"" USING (""account_id"") GROUP BY ""a"".""account_id"",EXTRACT(MONTH FROM ""a"".""day"") HAVING SUM(CASE WHEN ""a"".""type""='creditor' THEN ""a"".""amount"" ELSE 0 END)>MAX(""b"".""max_income"")) SELECT DISTINCT ""x"".""account_id"" FROM ""cte"" AS ""x"" JOIN ""cte"" AS ""y"" ON ""x"".""account_id""=""y"".""account_id"" AND ""x"".""month""=""y"".""month""-1 ORDER BY ""x"".""account_id"""
354,"WITH ""cte"" AS (SELECT ""t"".""account_id"",TO_CHAR(""day"", 'YYYY%m') AS ""each_month"",SUM(""amount"") AS ""amount_sum"",""a"".""max_income"" FROM ""Transactions"" AS ""t"" LEFT JOIN ""accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""t"".""type""='Creditor' GROUP BY 1,2 HAVING SUM(""amount"")>""a"".""max_income"") SELECT DISTINCT ""t1"".""account_id"" FROM ""cte"" AS ""t1"" JOIN ""cte"" AS ""t2"" ON ""t1"".""account_id""=""t2"".""account_id"" WHERE PERIOD_DIFF(""t1"".""each_month"", ""t2"".""each_month"")=1 GROUP BY 1 ORDER BY 1"
355,"WITH ""t1"" AS (SELECT ""account_id"",TO_CHAR(""day"", '%m') AS ""month"",SUM(""amount"") AS ""total_amount"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY ""month"",""account_id"" ORDER BY ""month""), ""t2"" AS (SELECT ""t1"".""account_id"",""total_amount"",""month"",LAG(""month"", 1) OVER (PARTITION BY ""account_id"" ORDER BY ""month"") AS ""num"" FROM ""t1"" JOIN ""Accounts"" AS ""a"" ON ""t1"".""account_id""=""a"".""account_id"" WHERE ""total_amount"">""max_income"") SELECT DISTINCT ""t2"".""account_id"" FROM ""t2"" WHERE ""month""-""num""=1"
356,"WITH ""cte"" AS (SELECT ""t"".""account_id"",""t"".""month"" FROM (SELECT ""account_id"",TO_CHAR(""day"", 'YYYY%m') AS ""month"",SUM(""amount"") AS ""total"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY 1,2) AS ""t"" JOIN ""accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" AND ""t"".""total"">""a"".""max_income"") SELECT DISTINCT ""c1"".""account_id"" FROM ""cte"" AS ""c1"" JOIN ""cte"" AS ""c2"" ON ""c1"".""account_id""=""c2"".""account_id"" AND ""c2"".""month""-""c1"".""month""=1"
357,"WITH ""cte"" AS (SELECT ""t"".""account_id"",TO_CHAR(""day"", 'YYYY%m') AS ""month"",(CASE WHEN SUM(""amount"")>""a"".""max_income"" THEN 1 ELSE 0 END) AS ""exceed"" FROM ""Transactions"" AS ""t"" JOIN ""Accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""type""='Creditor' GROUP BY TO_CHAR(""day"", 'YYYY%m'),""t"".""account_id"") SELECT DISTINCT ""c1"".""account_id"" FROM (""cte"" AS ""c1"") CROSS JOIN ""cte"" AS ""c2"" WHERE ""c1"".""account_id""=""c2"".""account_id"" AND ""c2"".""month""-""c1"".""month""=1 AND ""c1"".""exceed""=1 AND ""c2"".""exceed""=1"
358,"WITH ""cte"" AS (SELECT ""sub"".* FROM (SELECT ""account_id"",EXTRACT(MONTH FROM ""DAY"") AS ""MNTH"",SUM(""AMOUNT"") AS ""AMOUNT"" FROM ""TRANSACTIONS"" WHERE ""TYPE""='Creditor' GROUP BY ""account_id"",EXTRACT(MONTH FROM ""DAY"")) AS ""sub"" JOIN ""Accounts"" AS ""A"" ON ""sub"".""account_id""=""A"".""account_id"" AND ""sub"".""amount"">""A"".""max_income"") SELECT DISTINCT (""c1"".""account_id"") FROM ""cte"" AS ""c1"" JOIN ""cte"" AS ""c2"" ON ""c1"".""account_id""=""c2"".""account_id"" WHERE (""c1"".""mnth""+1=""c2"".""mnth"" OR ""c1"".""mnth""-1=""c2"".""mnth"")"
359,"WITH ""income"" AS (SELECT ""t"".""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month"",CASE WHEN SUM(""t"".""amount"")>""a"".""max_income"" THEN 1 ELSE 0 END AS ""exceed"" FROM ""transactions"" AS ""t"" JOIN ""accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""type""='Creditor' GROUP BY EXTRACT(MONTH FROM ""day""),""t"".""account_id"") SELECT DISTINCT ""i1"".""account_id"" FROM (""income"" AS ""i1"") CROSS JOIN ""income"" AS ""i2"" WHERE ""i1"".""account_id""=""i2"".""account_id"" AND ""i2"".""month""-""i1"".""month""=1 AND ""i1"".""exceed""=1 AND ""i2"".""exceed""=1 ORDER BY ""i1"".""account_id"""
360,"WITH ""acctincome"" AS (SELECT ""account_id"",LEFT(""day"", 7) AS ""month"",SUM(""amount"") AS ""income"" FROM ""Transactions"" AS ""tran"" WHERE ""type""='Creditor' GROUP BY ""account_id"",""month"" ORDER BY ""account_id"",""month"") SELECT DISTINCT ""acct"".""account_id"" FROM (""acctincome"" AS ""income1"" JOIN ""acctincome"" AS ""income2"" ON ""income1"".""account_id""=""income2"".""account_id"" AND CONCAT(""income1"".""month"", '-01') + INTERVAL '1 MONTH'=CONCAT(""income2"".""month"", '-01')) JOIN ""Accounts"" AS ""acct"" ON ""acct"".""account_id""=""income1"".""account_id"" WHERE ""income1"".""income"">""acct"".""max_income"" AND ""income2"".""income"">""acct"".""max_income"""
361,"WITH ""cte"" AS (SELECT ""a"".""account_id"" AS ""account_id"",""sub1"".""month"" AS ""month"",CASE WHEN ""sub1"".""total_income"">""a"".""max_income"" THEN 'y' ELSE 'n' END AS ""exceed"" FROM (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month"",SUM(""amount"") AS ""total_income"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY 1,2 ORDER BY 1,2) AS ""sub1"" LEFT JOIN ""Accounts"" AS ""a"" ON ""a"".""account_id""=""sub1"".""account_id""), ""exceed_table"" AS (SELECT ""account_id"",""month"",""exceed"",(""month""-RANK() OVER (PARTITION BY ""account_id"" ORDER BY ""month"")) AS ""rank_diff"" FROM ""cte"" WHERE ""exceed""='y') SELECT DISTINCT (""account_id"") FROM ""exceed_table"" GROUP BY ""account_id"",""rank_diff"" HAVING COUNT(1)>1"
362,"WITH ""tmp"" AS (SELECT ""a"".""account_id"",STR_TO_DATE(TO_CHAR(""day"", 'YYYY-%m-01'), '%Y-%m-%d') AS ""mon"",CASE WHEN SUM(""amount"")>""max_income"" THEN 1 ELSE 0 END AS ""flg"" FROM ""Transactions"" AS ""a"" JOIN ""Accounts"" AS ""b"" ON ""a"".""account_id""=""b"".""account_id"" WHERE ""type""='Creditor' GROUP BY ""account_id"",""mon"",""max_income"" ORDER BY 1,2) SELECT DISTINCT ""account_id"" FROM (SELECT *,LAG(""mon"", 1) OVER (PARTITION BY ""account_id"" ORDER BY ""mon"") AS ""lag_mon"",LAG(""flg"", 1) OVER (PARTITION BY ""account_id"" ORDER BY ""mon"") AS ""lag_flg"" FROM ""tmp"") AS ""t"" WHERE ""flg""=1 AND ""lag_flg""=1 AND ""mon"" - INTERVAL '1 MONTH'=""lag_mon"""
363,"WITH ""zte"" AS (SELECT ""temp"".""account_id"",""month"" FROM (SELECT ""account_id"",EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day"") AS ""month"",SUM(""amount"") AS ""totAmount"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY 1,2) AS ""temp"" LEFT JOIN ""Accounts"" ON ""temp"".""account_id""=""Accounts"".""account_id"" WHERE ""max_income""<""totAmount"") SELECT DISTINCT ""A"".""account_id"" FROM ""zte"" AS ""A"" LEFT JOIN ""zte"" AS ""B"" ON ""A"".""account_id""=""B"".""account_id"" WHERE ""A"".""month""=""B"".""month""+1"
364,"WITH ""CTE"" AS (SELECT ""account_id"",EXTRACT(YEAR FROM ""day"") AS ""yr"",EXTRACT(MONTH FROM ""day"") AS ""mnth"",SUM(""amount"") AS ""total"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",EXTRACT(YEAR FROM ""day""),EXTRACT(MONTH FROM ""day"")), ""CTE2"" AS (SELECT ""A"".""account_id"",""A"".""total"" AS ""total_A"",""B"".""total"" AS ""total_B"" FROM (""CTE"" AS ""A"" JOIN ""CTE"" AS ""B"" ON ""A"".""account_id""=""B"".""account_id"" AND ""A"".""yr""=""B"".""yr"" AND ""A"".""mnth""=""B"".""mnth""-1) JOIN ""Accounts"" AS ""C"" ON ""A"".""account_id""=""C"".""account_id"" WHERE ""A"".""total"">""C"".""max_income"" AND ""B"".""total"">""C"".""max_income"") SELECT DISTINCT ""account_id"" FROM ""CTE2"""
365,"WITH ""cte"" AS (SELECT ""t"".""account_id"",TO_CHAR(""day"", 'YYYY%m') AS ""each_month"",SUM(""amount"") AS ""amount_sum"",""a"".""max_income"" FROM ""Transactions"" AS ""t"" LEFT JOIN ""accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""t"".""type""='Creditor' GROUP BY 1,2 HAVING SUM(""amount"")>""a"".""max_income"") SELECT ""t1"".""account_id"" FROM ""cte"" AS ""t1"" JOIN ""cte"" AS ""t2"" ON ""t1"".""account_id""=""t2"".""account_id"" WHERE PERIOD_DIFF(""t1"".""each_month"", ""t2"".""each_month"")=1 GROUP BY 1 ORDER BY 1"
366,"SELECT DISTINCT ""account_id"" FROM (SELECT ""account_id"",""month"",LEAD(""month"", 1) OVER (PARTITION BY ""account_id"" ORDER BY ""month"") AS ""next_month"" FROM (SELECT ""a"".""account_id"",""Month"" FROM (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""Month"",SUM(""amount"") AS ""income"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY 1,2) AS ""a"" LEFT JOIN ""Accounts"" AS ""b"" ON ""a"".""account_id""=""b"".""account_id"" WHERE ""income"">""max_income"") AS ""aa"") AS ""aaa"" WHERE ABS(""month""-""next_month"")=1"
367,"WITH ""base"" AS (SELECT ""t"".""account_id"",CONVERT(CONCAT(SUBSTR(""t"".""day"", 1, 7), '-01'), DATE) AS ""month"",CASE WHEN SUM(""t"".""amount"")>""a"".""max_income"" THEN 1 ELSE 0 END AS ""flag"" FROM ""transactions"" AS ""t"" JOIN ""accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""t"".""type""='Creditor' GROUP BY 1,2 ORDER BY 1,2) SELECT DISTINCT ""b1"".""account_id"" FROM ""base"" AS ""b1"" LEFT JOIN ""base"" AS ""b2"" ON ""b1"".""account_id""=""b2"".""account_id"" AND ""b1"".""month"" + INTERVAL '1 MONTH'=""b2"".""month"" WHERE ""b1"".""flag""=1 AND ""b2"".""flag""=1 ORDER BY ""b1"".""account_id"""
368,"WITH ""tbl"" AS (SELECT ""account_id"",""months"",""max_income"",SUM(""amount"") AS ""monthly_amount"" FROM (SELECT ""a"".""account_id"" AS ""account_id"",""amount"",EXTRACT(MONTH FROM ""day"") AS ""months"",""max_income"" FROM ""Transactions"" AS ""a"" LEFT JOIN ""Accounts"" AS ""b"" ON ""a"".""account_id""=""b"".""account_id"" WHERE ""a"".""type""='Creditor') AS ""base"" GROUP BY ""account_id"",""max_income"",""months"" ORDER BY ""account_id"",""max_income"",""months"") SELECT DISTINCT ""a"".""account_id"" FROM ""tbl"" AS ""a"" JOIN ""tbl"" AS ""b"" ON ""a"".""account_id""=""b"".""account_id"" AND ABS(""a"".""months""-""b"".""months"")=1 WHERE ""a"".""monthly_amount"">""a"".""max_income"" AND ""b"".""monthly_amount"">""a"".""max_income"""
369,"WITH ""CTE"" AS (SELECT ""account_id"",""day"",SUM(""amount"") AS ""amount"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",TO_CHAR(""day"", 'YYYY-%m') ORDER BY ""account_id"") SELECT DISTINCT ""tab"".""account_id"" FROM (SELECT ""t1"".""account_id"",TO_CHAR(""t1"".""day"", 'YYYY-%m') AS ""t1Date"",""t1"".""amount"" AS ""t1amount"",TO_CHAR(""t2"".""day"", 'YYYY-%m') AS ""t2Date"",""t2"".""amount"" AS ""t2amount"" FROM ""CTE"" AS ""t1"" JOIN ""CTE"" AS ""t2"" ON (""t1"".""account_id""=""t2"".""account_id"") AND (TO_CHAR(""t2"".""day"", 'YYYY-%m')=TO_CHAR(""t1"".""day"" + INTERVAL '1 MONTH', 'YYYY-%m'))) AS ""tab"" JOIN ""accounts"" ON ""accounts"".""account_id""=""tab"".""account_id"" WHERE (""tab"".""t1amount"">""accounts"".""max_income"") AND (""tab"".""t2amount"">""accounts"".""max_income"")"
370,"WITH ""temp"" AS (SELECT ""account_id"",TO_CHAR(""day"", 'YYYY-%m-01') AS ""month"",SUM(""amount"") AS ""total"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",""month""), ""temp2"" AS (SELECT ""t"".""account_id"",""t"".""month"" FROM ""temp"" AS ""t"" JOIN ""Accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" AND ""t"".""total"">""a"".""max_income""), ""temp3"" AS (SELECT ""account_id"",""month"",""month"" - INTERVAL 'ROW_NUMBER() OVER (PARTITION BY ""account_id"" ORDER BY ""month"") MONTH' AS ""grp"" FROM ""temp2"") SELECT DISTINCT ""account_id"" FROM ""temp3"" GROUP BY ""account_id"",""grp"" HAVING COUNT(1)>=2"
371,"WITH ""t"" AS (SELECT ""account_id"",MAKEDATE(EXTRACT(YEAR FROM ""day""), EXTRACT(MONTH FROM ""day"")) AS ""date"",MIN(""transaction_id"") AS ""transaction_id"",SUM(""amount"")>""accounts"".""max_income"" AS ""suspicious"",""max_income"" FROM ""transactions"" JOIN ""accounts"" USING (""account_id"") WHERE ""type""='Creditor' GROUP BY 1,2 ORDER BY 1,2), ""s"" AS (SELECT ""account_id"",""transaction_id"",""date"",""date"" - LAG(""date"", 1, 0) OVER ""w"" AS ""diff"" FROM ""t"" WHERE ""t"".""suspicious"" WINDOW ""w"" AS (PARTITION BY ""account_id"" ORDER BY ""date"")), ""r"" AS (SELECT ""account_id"",""transaction_id"",COUNT(COALESCE(""diff"", 1)=1 OR NULL) OVER (PARTITION BY ""account_id"" ORDER BY ""date"") AS ""consecutive_months"" FROM ""s"") SELECT ""account_id"" FROM ""r"" GROUP BY ""account_id"" HAVING MAX(""consecutive_months"")>=2 ORDER BY ""transaction_id"""
372,"WITH ""cte"" AS (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""mon"",SUM(""amount"") AS ""total_income"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",EXTRACT(MONTH FROM ""day"") ORDER BY ""account_id"",EXTRACT(MONTH FROM ""day"")), ""cte1"" AS (SELECT ""a"".""account_id"",(CASE WHEN ""a"".""total_income"">""max_income"" AND ""b"".""total_income"">""max_income"" THEN 'Yes' ELSE 'No' END) AS ""susp_acct"" FROM (""cte"" AS ""a"" JOIN ""cte"" AS ""b"" ON ""a"".""account_id""=""b"".""account_id"" AND ""a"".""mon""=""b"".""mon""+1) JOIN ""accounts"" AS ""c"" ON ""a"".""account_id""=""c"".""account_id"") SELECT DISTINCT ""account_id"" FROM ""cte1"" WHERE ""susp_acct""='Yes' ORDER BY ""account_id"""
373,"WITH ""cte"" AS (SELECT ""t"".""account_id"",TO_CHAR(""day"", '%m %y') AS ""month"",SUM(CASE WHEN ""type""='Creditor' THEN ""amount"" END) AS ""total_income"",""max_income"" FROM ""transactions"" AS ""t"" LEFT JOIN ""accounts"" AS ""a"" ON ""a"".""account_id""=""t"".""account_id"" GROUP BY ""t"".""account_id"",TO_CHAR(""day"", '%m %y')) SELECT DISTINCT ""cte1"".""account_id"" FROM ""cte"" AS ""cte1"" JOIN ""cte"" AS ""cte2"" ON ""cte1"".""account_id""=""cte2"".""account_id"" AND ""cte1"".""month""=""cte2"".""month""-1 WHERE ""cte1"".""total_income"">""cte1"".""max_income"" AND ""cte2"".""total_income"">""cte1"".""max_income"""
374,"WITH ""cte"" AS (SELECT ""transaction_id"",""t"".""account_id"",EXTRACT(MONTH FROM ""t"".""day"") AS ""month"",""a"".""max_income"" FROM ""Accounts"" AS ""a"" JOIN ""Transactions"" AS ""t"" USING (""account_id"") GROUP BY ""t"".""account_id"",""month"" HAVING SUM((""type""='Creditor')*""amount"")>""a"".""max_income"") SELECT DISTINCT ""c1"".""account_id"" FROM (""cte"" AS ""c1"") CROSS JOIN ""cte"" AS ""c2"" WHERE ""c1"".""account_id""=""c2"".""account_id"" AND PERIOD_DIFF(""c1"".""month"", ""c2"".""month"")=1 ORDER BY ""c1"".""transaction_id"""
375,"WITH ""total_amt"" AS (SELECT ""t"".""account_id"" AS ""account_id"",EXTRACT(MONTH FROM ""T"".""DAY"") AS ""mnth"",SUM(""amount"") AS ""total_inc"",""a"".""max_income"" AS ""max_income"" FROM ""Transactions"" AS ""t"" JOIN ""accounts"" AS ""a"" ON (""t"".""account_id""=""a"".""account_id"") WHERE ""type""='Creditor' GROUP BY 1,2) SELECT ""t"".""account_id"" FROM ""total_amt"" AS ""t"" JOIN ""total_amt"" AS ""t1"" ON (""t"".""account_id""=""t1"".""account_id"" AND ""t"".""mnth""=""t1"".""mnth""+1) WHERE ""t"".""total_inc"">""t"".""max_income"" AND ""t1"".""total_inc"">""t1"".""max_income"" GROUP BY 1 ORDER BY 1"
376,"WITH ""cte"" AS (SELECT ""t"".""account_id"",EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day"") AS ""month"",(CASE WHEN SUM(""amount"")>""a"".""max_income"" THEN 1 ELSE 0 END) AS ""exceed"" FROM ""transactions"" AS ""t"" JOIN ""accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""type""='Creditor' GROUP BY EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day""),""t"".""account_id"") SELECT DISTINCT ""c1"".""account_id"" FROM (""cte"" AS ""c1"") CROSS JOIN ""cte"" AS ""c2"" WHERE ""c1"".""account_id""=""c2"".""account_id"" AND ""c2"".""month""-""c1"".""month""=1 AND ""c1"".""exceed""=1 AND ""c2"".""exceed""=1"
377,"WITH ""temp"" AS (SELECT ""a"".""account_id"",TO_CHAR(""a"".""day"", 'YYYY-%m') AS ""month"" FROM ""Transactions"" AS ""a"" JOIN ""Accounts"" AS ""b"" ON ""a"".""account_id""=""b"".""account_id"" GROUP BY ""a"".""account_id"",TO_CHAR(""a"".""day"", 'YYYY-%m') HAVING SUM(CASE WHEN ""a"".""type""='Creditor' THEN ""a"".""amount"" ELSE 0 END)>MAX(""b"".""max_income"")) SELECT DISTINCT ""a"".""account_id"" FROM (""temp"" AS ""a"") CROSS JOIN ""temp"" AS ""b"" WHERE ""a"".""account_id""=""b"".""account_id"" AND ""b"".""month""=TO_CHAR(DATE(CONCAT(""a"".""month"", '-01')) - INTERVAL '1 DAY', 'YYYY-%m')"
378,"WITH ""groups_"" AS (SELECT ""t"".""account_id"",""t"".""month"",""t"".""income"",""a"".""max_income"",CASE WHEN ""t"".""income"">""a"".""max_income"" THEN 'Y' ELSE 'N' END AS ""is_max"" FROM (SELECT ""account_id"",SUBSTRING(""day"", 1, 7) AS ""month"",SUM(CASE WHEN ""TYPE""='Creditor' THEN ""amount"" ELSE 0 END) AS ""income"" FROM ""transactions"" AS ""t"" GROUP BY 1,2) AS ""t"" JOIN ""accounts"" AS ""a"" ON (""t"".""account_id""=""a"".""account_id"")) SELECT DISTINCT ""account_id"" FROM (SELECT *,CAST(SUBSTRING(""month"", 6, 2) AS INTEGER)-ROW_NUMBER() OVER (PARTITION BY ""account_id"" ORDER BY SUBSTRING(""month"", 6, 2)) AS ""grp"" FROM ""groups_"" WHERE ""is_max""='Y') AS ""a"" GROUP BY ""account_id"",""grp"" HAVING COUNT(1)>1 ORDER BY 1"
379,"WITH ""temp"" AS (SELECT ""t"".""account_id"",TO_CHAR(""day"", 'YYYY%m') AS ""month"",SUM(""t"".""amount"") AS ""tot"",""a"".""max_income"" FROM ""transactions"" AS ""t"" LEFT JOIN ""accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""t"".""type""='Creditor' GROUP BY 1,2 HAVING SUM(""t"".""amount"")>""a"".""max_income"" ORDER BY 1) SELECT ""t1"".""account_id"" FROM (""temp"" AS ""t1"") CROSS JOIN ""temp"" AS ""t2"" WHERE ""t1"".""account_id""=""t2"".""account_id"" AND PERIOD_DIFF(""t1"".""month"", ""t2"".""month"")=1 GROUP BY ""t1"".""account_id"" ORDER BY ""t1"".""account_id"""
380,"WITH ""temp"" AS (SELECT ""t"".""account_id"",EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day"") AS ""month"",(CASE WHEN SUM(""amount"")>""max_income"" THEN 1 ELSE 0 END) AS ""exceed"" FROM ""Transactions"" AS ""t"" JOIN ""Accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""type""='Creditor' GROUP BY 1,2) SELECT DISTINCT ""a"".""account_id"" FROM ""temp"" AS ""a"" JOIN ""temp"" AS ""b"" ON ""a"".""account_id""=""b"".""account_id"" AND ""a"".""exceed""=1 AND ""b"".""exceed""=1 AND ""b"".""month""-""a"".""month""=1"
381,"WITH ""groups_"" AS (SELECT ""t"".""account_id"",""t"".""month"",""t"".""income"",""a"".""max_income"",CASE WHEN ""t"".""income"">""a"".""max_income"" THEN 'Y' ELSE 'N' END AS ""is_max"" FROM (SELECT ""account_id"",SUBSTRING(""day"", 1, 7) AS ""month"",SUM(CASE WHEN ""TYPE""='Creditor' THEN ""amount"" ELSE 0 END) AS ""income"" FROM ""transactions"" AS ""t"" GROUP BY 1,2) AS ""t"" JOIN ""accounts"" AS ""a"" ON (""t"".""account_id""=""a"".""account_id"")) SELECT DISTINCT ""account_id"" FROM (SELECT *,CAST(SUBSTRING(""month"", 6, 2) AS INTEGER)-ROW_NUMBER() OVER (PARTITION BY ""account_id"" ORDER BY SUBSTRING(""month"", 6, 2)) AS ""grp"" FROM ""groups_"" WHERE ""is_max""='Y') AS ""a"" GROUP BY ""account_id"",""grp"" HAVING COUNT(1)>1 ORDER BY 1"
382,"WITH ""tmp"" AS (SELECT ""account_id"",""mon"",SUM(""balance"") AS ""mbalance"" FROM (SELECT ""account_id"",CASE WHEN ""type""='Creditor' THEN ""amount"" ELSE 0 END AS ""balance"",TO_CHAR(""day"", 'YYYY%m') AS ""mon"" FROM ""transactions"") AS ""X"" GROUP BY 1,2 ORDER BY 1,2), ""tmp2"" AS (SELECT ""a"".""account_id"",""a"".""mon"" FROM ""TMP"" AS ""A"" JOIN ""ACCOUNTS"" AS ""B"" ON ""A"".""ACCOUNT_ID""=""B"".""ACCOUNT_ID"" WHERE ""mbalance"">""max_income"") SELECT DISTINCT ""A"".""ACCOUNT_ID"" FROM (""TMP2"" AS ""A"") CROSS JOIN ""TMP2"" AS ""B"" WHERE ""a"".""account_id""=""b"".""account_id"" AND PERIOD_DIFF(""a"".""MON"", ""B"".""MON"")=1 GROUP BY 1 ORDER BY 1"
383,"WITH ""groups_"" AS (SELECT ""t"".""account_id"",""t"".""month"",""t"".""income"",""a"".""max_income"",CASE WHEN ""t"".""income"">""a"".""max_income"" THEN 'Y' ELSE 'N' END AS ""is_max"" FROM (SELECT ""account_id"",SUBSTRING(""day"", 1, 7) AS ""month"",SUM(CASE WHEN ""type""='Creditor' THEN ""amount"" ELSE 0 END) AS ""income"" FROM ""transactions"" AS ""t"" GROUP BY 1,2) AS ""t"" JOIN ""accounts"" AS ""a"" ON (""t"".""account_id""=""a"".""account_id"")) SELECT DISTINCT ""account_id"" FROM (SELECT *,CAST(SUBSTRING(""month"", 6, 2) AS INTEGER)-ROW_NUMBER() OVER (PARTITION BY ""account_id"" ORDER BY SUBSTRING(""month"", 6, 2)) AS ""grp"" FROM ""groups_"" WHERE ""is_max""='Y') AS ""a"" GROUP BY ""account_id"",""grp"" HAVING COUNT(1)>1 ORDER BY 1"
384,"WITH ""temp"" AS (SELECT ""t"".""account_id"",TO_CHAR(""day"", 'YYYY%m') AS ""date"",SUM(""amount"") AS ""income"",""Accounts"".""max_income"" FROM ""Transactions"" AS ""t"" LEFT JOIN ""Accounts"" ON ""Accounts"".""account_id""=""t"".""account_id"" WHERE ""t"".""type""='Creditor' GROUP BY ""t"".""account_id"",TO_CHAR(""day"", 'YYYY%m') HAVING SUM(""amount"")>""Accounts"".""max_income"") SELECT ""t1"".""account_id"" FROM (""temp"" AS ""t1"") CROSS JOIN ""temp"" AS ""t2"" WHERE ""t1"".""account_id""=""t2"".""account_id"" AND PERIOD_DIFF(""t1"".""date"", ""t2"".""date"")=1 GROUP BY ""t1"".""account_id"" ORDER BY ""t1"".""account_id"""
385,"WITH ""income"" AS (SELECT ""account_id"",CONCAT(LEFT(""day"", 7), '-01') AS ""month"",SUM(CASE WHEN ""type""='Creditor' THEN ""amount"" ELSE 0 END) AS ""total_income"",""max_income"" FROM ""transactions"" JOIN ""accounts"" USING (""account_id"") GROUP BY 1,LEFT(""day"", 7) ORDER BY 1,2) SELECT DISTINCT ""i1"".""account_id"" FROM ""income"" AS ""i1"" JOIN ""income"" AS ""i2"" ON ""i1"".""account_id""=""i2"".""account_id"" AND TIMESTAMPDIFF(MONTH, ""i1"".""month"", ""i2"".""month"")=1 WHERE ""i1"".""total_income"">""i1"".""max_income"" AND ""i2"".""total_income"">""i2"".""max_income"""
386,"SELECT DISTINCT ""acct_id"" AS ""account_id"" FROM (SELECT ""frd1"",""account_id"",""month"",LEAD(""frd1"") OVER (PARTITION BY ""account_id"" ORDER BY ""account_id"",""month""),LEAD(""account_id"") OVER (PARTITION BY ""account_id"" ORDER BY ""account_id"",""month""),CASE WHEN (""month""+1)=LEAD(""month"") OVER (PARTITION BY ""account_id"" ORDER BY ""account_id"",""month"") AND ""frd1""='Yes' AND ""month"" AND ""frd1""=LEAD(""frd1"") OVER (PARTITION BY ""account_id"" ORDER BY ""account_id"",""month"") THEN ""account_id"" END AS ""acct_id"" FROM (SELECT ""t"".""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month"",COALESCE(SUM(CASE WHEN ""type""='Creditor' THEN ""amount"" END), 0) AS ""rs"",CASE WHEN COALESCE(SUM(CASE WHEN ""type""='Creditor' THEN ""amount"" END), 0)>""max_income"" THEN 'Yes' ELSE 'No' END AS ""frd1"" FROM ""transactions"" AS ""t"" JOIN ""accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" GROUP BY 1,2 ORDER BY 1,2) AS ""a"") AS ""b"" WHERE ""acct_id"" IS NOT NULL"
387,"WITH ""base"" AS (SELECT ""account_id"",LAST_DAY(CAST(""day"" AS DATE)) AS ""month_year"",SUM(""amount"") AS ""total_income"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",LAST_DAY(CAST(""day"" AS DATE))), ""result"" AS (SELECT ""a"".""account_id"",""b"".""month_year"",CASE WHEN ""b"".""total_income"">""a"".""max_income"" THEN 1 ELSE 0 END AS ""flags"" FROM ""accounts"" AS ""a"" LEFT JOIN ""base"" AS ""b"" ON ""a"".""account_id""=""b"".""account_id"" ORDER BY ""a"".""account_id"",""b"".""month_year"") SELECT DISTINCT ""a1"".""account_id"" FROM ""result"" AS ""a1"" JOIN ""result"" AS ""a2"" ON ""a1"".""account_id""=""a2"".""account_id"" AND ""a2"".""month_year""=LAST_DAY(""a1"".""month_year"" + INTERVAL '1 MONTH') WHERE ""a1"".""flags""+""a2"".""flags""=2"
388,"WITH ""temp"" AS (SELECT ""t"".""account_id"",EXTRACT(YEAR_MONTH FROM ""day"") AS ""date"",SUM(""t"".""amount"") AS ""income"" FROM ""Transactions"" AS ""t"" JOIN ""Accounts"" AS ""a"" ON ""a"".""account_id""=""t"".""account_id"" WHERE ""t"".""type""='Creditor' GROUP BY ""t"".""account_id"",EXTRACT(YEAR_MONTH FROM ""day""),""a"".""max_income"" HAVING SUM(""amount"")>""a"".""max_income"") SELECT ""t1"".""account_id"" FROM ""temp"" AS ""t1"" JOIN ""temp"" AS ""t2"" ON ""t1"".""account_id""=""t2"".""account_id"" AND (""t1"".""date""-""t2"".""date"")=1 GROUP BY ""t1"".""account_id"" ORDER BY ""t1"".""account_id"""
389,"WITH ""cte"" AS (SELECT ""t"".""account_id"",LEFT(""t"".""day"", 7) AS ""month"",CASE WHEN SUM(""t"".""amount"")>""a"".""max_income"" THEN 1 ELSE 0 END AS ""exceed"" FROM ""transactions"" AS ""t"" JOIN ""accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""t"".""type""='Creditor' GROUP BY LEFT(""t"".""day"", 7),""t"".""account_id"" HAVING ""exceed""=1 ORDER BY 1,2) SELECT DISTINCT ""c1"".""account_id"" FROM ""cte"" AS ""c1"" JOIN ""cte"" AS ""c2"" ON ""c1"".""account_id""=""c2"".""account_id"" AND SUBSTR(""c1"".""month"", 6, 2)+1=SUBSTR(""c2"".""month"", 6, 2)"
390,"WITH ""cte"" AS (SELECT ""t1"".""account_id"",""transaction_month"",CASE WHEN ""t1"".""total_income"">""t2"".""max_income"" THEN 'Yes' ELSE 'No' END AS ""is_suspicious"" FROM (SELECT ""account_id"",EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day"") AS ""transaction_month"",SUM(CASE WHEN ""type""='Creditor' THEN ""amount"" ELSE 0 END) AS ""total_income"" FROM ""Transactions"" GROUP BY ""account_id"",EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day"")) AS ""t1"" JOIN ""Accounts"" AS ""t2"" ON ""t1"".""account_id""=""t2"".""account_id"") SELECT DISTINCT ""c1"".""account_id"" FROM (""cte"" AS ""c1"") CROSS JOIN ""cte"" AS ""c2"" WHERE ""c1"".""account_id""=""c2"".""account_id"" AND ""c1"".""transaction_month""=""c2"".""transaction_month""-1 AND ""c1"".""is_suspicious""='Yes' AND ""c2"".""is_suspicious""='Yes'"
391,"WITH ""cte"" AS (SELECT ""t"".""account_id"",EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day"") AS ""month"",(CASE WHEN SUM(""amount"")>""a"".""max_income"" THEN 1 ELSE 0 END) AS ""exceed"" FROM ""transactions"" AS ""t"" JOIN ""accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""type""='Creditor' GROUP BY EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day""),""t"".""account_id"") SELECT DISTINCT ""c1"".""account_id"" FROM (""cte"" AS ""c1"") CROSS JOIN ""cte"" AS ""c2"" WHERE ""c1"".""account_id""=""c2"".""account_id"" AND ""c2"".""month""-""c1"".""month""=1 AND ""c1"".""exceed""=1 AND ""c2"".""exceed""=1"
392,"WITH ""S0"" AS (SELECT ""transaction_id"",""account_id"",""type"",""amount"",TO_CHAR(""day"", 'YYYY-%m-01') AS ""day"" FROM ""Transactions""), ""S1"" AS (SELECT ""account_id"",""day"",SUM(""amount"") AS ""amount"" FROM ""S0"" WHERE ""type""='Creditor' GROUP BY ""account_id"",""day""), ""S2"" AS (SELECT ""S1"".""account_id"",""day"",""amount"",""max_income"",""amount"">""max_income"" AS ""exceed"" FROM ""S1"" JOIN ""Accounts"" ON ""S1"".""account_id""=""Accounts"".""account_id""), ""S3"" AS (SELECT ""S1"".""account_id"",""day"",""amount"",""max_income"",""amount"">""max_income"" AS ""exceed"" FROM ""S1"" JOIN ""Accounts"" ON ""S1"".""account_id""=""Accounts"".""account_id"") SELECT DISTINCT (""S2"".""account_id"") FROM ""S2"" CROSS JOIN ""S3"" WHERE ""S2"".""account_id""=""S3"".""account_id"" AND ""S2"".""day"" + INTERVAL '1 MONTH'=""S3"".""day"" AND ""S2"".""exceed"" AND ""S3"".""exceed"""
393,"WITH ""temp"" AS (SELECT ""t"".""account_id"",TO_CHAR(""day"", 'YYYY%m') AS ""date"",SUM(""amount"") AS ""income"",""Accounts"".""max_income"" FROM ""Transactions"" AS ""t"" LEFT JOIN ""Accounts"" ON ""Accounts"".""account_id""=""t"".""account_id"" WHERE ""t"".""type""='Creditor' GROUP BY ""t"".""account_id"",TO_CHAR(""day"", 'YYYY%m') HAVING SUM(""amount"")>""Accounts"".""max_income"") SELECT ""t1"".""account_id"" FROM (""temp"" AS ""t1"") CROSS JOIN ""temp"" AS ""t2"" WHERE ""t1"".""account_id""=""t2"".""account_id"" AND PERIOD_DIFF(""t1"".""date"", ""t2"".""date"")=1 GROUP BY ""t1"".""account_id"" ORDER BY ""t1"".""account_id"""
394,"SELECT DISTINCT ""account_id"" FROM (SELECT ""a"".""account_id"",""tot_income"".""month"",LEAD(""tot_income"".""month"", 1) OVER (PARTITION BY ""a"".""account_id"" ORDER BY ""tot_income"".""month"") AS ""next_month"" FROM (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month"",SUM(""amount"") AS ""total_income"" FROM ""transactions"" AS ""t"" WHERE ""type""='Creditor' GROUP BY ""account_id"",EXTRACT(MONTH FROM ""day"")) AS ""tot_income"" JOIN ""accounts"" AS ""a"" ON ""tot_income"".""account_id""=""a"".""account_id"" AND ""tot_income"".""total_income"">""a"".""max_income"") AS ""check_consecutive"" WHERE ABS(""next_month""-""month"")=1"
395,"WITH ""t"" AS (SELECT ""account_id"",TO_CHAR(""day"", 'YYYY%m') AS ""date"",SUM(""amount"") AS ""total"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY 1,2) SELECT DISTINCT ""t1"".""account_id"" FROM (""t"" AS ""t1"" JOIN ""t"" AS ""t2"" ON ""t1"".""account_id""=""t2"".""account_id"" AND PERIOD_DIFF(""t1"".""date"", ""t2"".""date"")=1) JOIN ""accounts"" AS ""a"" ON ""a"".""account_id""=""t1"".""account_id"" WHERE ""t1"".""total"">""a"".""max_income"" AND ""t2"".""total"">""a"".""max_income"""
396,"WITH ""Temp"" AS (SELECT ""T"".""account_id"",EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day"") AS ""month"",(CASE WHEN SUM(""amount"")>""a"".""max_income"" THEN 1 ELSE 0 END) AS ""exceed"" FROM ""Transactions"" AS ""t"" JOIN ""Accounts"" AS ""A"" ON ""T"".""account_id""=""A"".""account_id"" WHERE ""type""='Creditor' GROUP BY EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day""),""T"".""account_id"") SELECT DISTINCT ""c1"".""account_id"" FROM ""Temp"" AS ""c1"" JOIN ""Temp"" AS ""c2"" ON ""c1"".""account_id""=""c2"".""account_id"" AND ""c2"".""month""-""c1"".""month""=1 AND ""c1"".""exceed""=1 AND ""c2"".""exceed""=1"
397,"WITH ""tmp"" AS (SELECT * FROM (SELECT ""a"".""account_id"",EXTRACT(MONTH FROM ""day"") AS ""mon"",""max_income"",SUM(""amount"") AS ""total_income"" FROM ""transactions"" AS ""a"" JOIN ""accounts"" AS ""b"" USING (""account_id"") WHERE ""type""='Creditor' GROUP BY 1,2,3) AS ""t"" WHERE ""total_income"">""max_income"" ORDER BY 1,2) SELECT DISTINCT ""account_id"" FROM (SELECT *,LAG(""mon"", 1) OVER (PARTITION BY ""account_id"" ORDER BY ""mon"") AS ""mon_lag"" FROM ""tmp"") AS ""t"" WHERE ""mon""-""mon_lag""=1"
398,"WITH ""t"" AS (SELECT ""a"".""account_id"",EXTRACT(YEAR FROM ""day"") AS ""year"",EXTRACT(MONTH FROM ""day"") AS ""month"",SUM(""t"".""amount"") AS ""total_income"",""a"".""max_income"" FROM ""accounts"" AS ""a"" LEFT JOIN ""transactions"" AS ""t"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""t"".""type""='Creditor' GROUP BY ""a"".""account_id"",EXTRACT(YEAR FROM ""day""),EXTRACT(MONTH FROM ""day"") HAVING SUM(""t"".""amount"")>""a"".""max_income"") SELECT DISTINCT ""t1"".""account_id"" FROM ""t"" AS ""t1"" LEFT JOIN ""t"" AS ""t2"" ON ""t1"".""account_id""=""t2"".""account_id"" AND ""t1"".""month""+1=""t2"".""month"" WHERE ""t2"".""month"" IS NOT NULL"
399,"WITH ""incometable"" AS (SELECT ""t"".""account_id"",EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day"") AS ""month"",SUM(CASE WHEN ""type""='Creditor' THEN ""amount"" END) AS ""income"",""max_income"" FROM ""accounts"" AS ""a"" JOIN ""transactions"" AS ""t"" ON ""a"".""account_id""=""t"".""account_id"" GROUP BY ""t"".""account_id"",TO_CHAR(""day"", 'YYYY-%M') ORDER BY ""t"".""account_id"",""month"") SELECT DISTINCT ""i1"".""account_id"" FROM ""incometable"" AS ""i1"" JOIN ""incometable"" AS ""i2"" ON ""i1"".""account_id""=""i2"".""account_id"" AND ""i2"".""month""-""i1"".""month""=1 WHERE ""i1"".""income"">""i1"".""max_income"" AND ""i2"".""income"">""i2"".""max_income"""
400,"SELECT ""c"".""account_id"" FROM (SELECT ""a"".""account_id"",""a"".""mm"" AS ""current_month"",""a"".""total_income"",LEAD(""a"".""mm"") OVER (PARTITION BY ""a"".""account_id"" ORDER BY ""a"".""mm"") AS ""next_month"",LEAD(""a"".""total_income"") OVER (PARTITION BY ""a"".""account_id"" ORDER BY ""a"".""mm"") AS ""next_month_income"",""max_income"" FROM (SELECT ""account_id"",SUM(""amount"") AS ""total_income"",EXTRACT(MONTH FROM ""day"") AS ""mm"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",""mm"") AS ""a"" LEFT JOIN ""accounts"" AS ""b"" ON ""a"".""account_id""=""b"".""account_id"") AS ""c"" WHERE ""c"".""total_income"">""c"".""max_income"" AND ""c"".""next_month_income"">""c"".""max_income"" AND ""c"".""next_month""-""c"".""current_month""=1 GROUP BY 1"
401,"SELECT ""c"".""account_id"" FROM (SELECT ""a"".""account_id"",""a"".""yymm"" AS ""current_month"",""a"".""total_income"",LEAD(""a"".""yymm"") OVER (PARTITION BY ""a"".""account_id"" ORDER BY ""a"".""yymm"") AS ""nex_month"",LEAD(""a"".""total_income"") OVER (PARTITION BY ""a"".""account_id"" ORDER BY ""yymm"") AS ""nex_month_income"",""b"".""max_income"" FROM (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""yymm"",SUM(""amount"") AS ""total_income"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY 1,2) AS ""a"" LEFT JOIN ""accounts"" AS ""b"" ON ""a"".""account_id""=""b"".""account_id"") AS ""c"" WHERE ""c"".""total_income"">""c"".""max_income"" AND ""c"".""nex_month_income"">""c"".""max_income"" AND ""c"".""nex_month""-""c"".""current_month""=1 GROUP BY 1"
402,"WITH ""cte"" AS (SELECT ""t"".""account_id"",EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day"") AS ""month"",(CASE WHEN SUM(""amount"")>""a"".""max_income"" THEN 1 ELSE 0 END) AS ""exceed"" FROM ""transactions"" AS ""t"" JOIN ""accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""type""='Creditor' GROUP BY EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day""),""t"".""account_id"") SELECT DISTINCT ""c1"".""account_id"" FROM (""cte"" AS ""c1"") CROSS JOIN ""cte"" AS ""c2"" WHERE ""c1"".""account_id""=""c2"".""account_id"" AND ""c2"".""month""-""c1"".""month""=1 AND ""c1"".""exceed""=1 AND ""c2"".""exceed""=1"
403,"WITH ""deposits"" AS (SELECT EXTRACT(MONTH FROM ""day"") AS ""month"",""t"".""account_id"",""max_income"",SUM(""amount"") AS ""income"" FROM ""Transactions"" AS ""t"" JOIN ""Accounts"" AS ""a"" ON ""a"".""account_id""=""t"".""account_id"" WHERE ""type""='Creditor' GROUP BY EXTRACT(MONTH FROM ""day""),""t"".""account_id"") SELECT ""d1"".""account_id"" FROM (""deposits"" AS ""d1"") CROSS JOIN ""deposits"" AS ""d2"" WHERE ""d1"".""account_id""=""d2"".""account_id"" AND ""d2"".""month""=""d1"".""month""+1 AND ""d1"".""income"">""d1"".""max_income"" AND ""d2"".""income"">""d2"".""max_income"" GROUP BY ""d1"".""account_id"""
404,"WITH ""cte"" AS (SELECT ""t"".""account_id"",""t"".""month"" FROM (SELECT ""account_id"",TO_CHAR(""day"", 'YYYY%m') AS ""month"",SUM(""amount"") AS ""total"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY 1,2) AS ""t"" JOIN ""accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" AND ""t"".""total"">""a"".""max_income"") SELECT DISTINCT ""c1"".""account_id"" FROM ""cte"" AS ""c1"" JOIN ""cte"" AS ""c2"" ON ""c1"".""account_id""=""c2"".""account_id"" AND ""c2"".""month""-""c1"".""month""=1"
405,"WITH ""t1"" AS (SELECT ""t"".""account_id"",SUM(CASE WHEN ""type""='creditor' THEN ""amount"" ELSE 0 END) AS ""amount"",TO_CHAR(""day"", 'YYYY%m') AS ""day"",""max_income"" FROM ""Transactions"" AS ""t"" LEFT JOIN ""Accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" GROUP BY ""account_id"",TO_CHAR(""day"", 'YYYY-%m')), ""t2"" AS (SELECT ""account_id"",""day"" FROM ""t1"" WHERE ""amount"">""max_income"") SELECT DISTINCT ""t"".""account_id"" FROM ""t2"" AS ""t"" LEFT JOIN ""t2"" AS ""tt"" ON ""t"".""account_id""=""tt"".""account_id"" AND PERIOD_DIFF(""tt"".""day"", ""t"".""day"") BETWEEN 0 AND 1 GROUP BY ""t"".""account_id"",""t"".""day"" HAVING COUNT(""tt"".""account_id"")>=2"
406,"WITH ""accounts_amount"" AS (SELECT ""t"".""account_id"",SUM(""amount"") AS ""month_amounts"",TO_CHAR(""day"", 'YYYY%m') AS ""month"" FROM ""transactions"" AS ""t"" JOIN ""accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""type""='Creditor' GROUP BY ""t"".""account_id"",TO_CHAR(""day"", 'YYYY%m'),""a"".""max_income"" HAVING SUM(""amount"")>""a"".""max_income"") SELECT ""a1"".""account_id"" FROM (""accounts_amount"" AS ""a1"") CROSS JOIN ""accounts_amount"" AS ""a2"" WHERE ""a1"".""account_id""=""a2"".""account_id"" AND PERIOD_DIFF(""a1"".""month"", ""a2"".""month"")=1 GROUP BY ""a1"".""account_id"""
407,"WITH ""tmp"" AS (SELECT ""account_id"",SUM(""amount"") AS ""sum_income"",""mn"",""yr"",""mn_next"",""yr_next"" FROM (SELECT ""transaction_id"",""account_id"",""amount"",EXTRACT(MONTH FROM ""day"") AS ""mn"",EXTRACT(YEAR FROM ""day"") AS ""yr"",EXTRACT(MONTH FROM ""day"" + INTERVAL '1 MONTH') AS ""mn_next"",EXTRACT(YEAR FROM ""day"" + INTERVAL '1 MONTH') AS ""yr_next"" FROM ""Transactions"" WHERE ""type""='Creditor') AS ""p1"" GROUP BY ""account_id"",""mn"",""yr"",""mn_next"",""yr_next"") SELECT DISTINCT ""t1"".""account_id"" FROM (""tmp"" AS ""t1"" JOIN ""tmp"" AS ""t2"" ON ""t1"".""mn""=""t2"".""mn_next"" AND ""t1"".""yr""=""t2"".""yr_next"" AND ""t1"".""account_id""=""t2"".""account_id"") JOIN ""Accounts"" AS ""a"" ON ""t1"".""account_id""=""a"".""account_id"" WHERE ""t1"".""sum_income"">""a"".""max_income"" AND ""t2"".""sum_income"">""a"".""max_income"" ORDER BY ""t1"".""account_id"""
408,"WITH ""monthly_income"" AS (SELECT ""b"".""account_id"",TO_CHAR(""b"".""day"", '%y%m') AS ""month"",""a"".""max_income"" FROM ""Accounts"" AS ""a"" JOIN ""Transactions"" AS ""b"" ON ""a"".""account_id""=""b"".""account_id"" GROUP BY ""b"".""account_id"",""month"" HAVING SUM((""type""='Creditor')*""amount"")>""a"".""max_income"") SELECT DISTINCT ""a"".""account_id"" FROM ""monthly_income"" AS ""a"" JOIN ""monthly_income"" AS ""b"" ON ""a"".""account_id""=""b"".""account_id"" AND PERIOD_DIFF(""a"".""month"", ""b"".""month"")=1 ORDER BY ""account_id"""
409,"WITH ""A"" AS (SELECT ""account_id"",12*EXTRACT(YEAR FROM ""day"")+EXTRACT(MONTH FROM ""day"") AS ""date_col"",SUM(""amount"") AS ""total_income"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",""date_col""), ""B"" AS (SELECT ""A"".""account_id"",""A"".""date_col"" FROM ""A"" JOIN ""Accounts"" ON ""A"".""account_id""=""Accounts"".""account_id"" AND ""A"".""total_income"">""Accounts"".""max_income"") SELECT DISTINCT ""B1"".""account_id"" FROM ""B"" AS ""B1"" JOIN ""B"" AS ""B2"" ON ""B1"".""account_id""=""B2"".""account_id"" AND ""B1"".""date_col""-""B2"".""date_col""=1 ORDER BY ""B1"".""account_id"""
410,"WITH ""temp"" AS (SELECT ""a"".""account_id"",TO_CHAR(""a"".""day"", 'YYYY-%m') AS ""month"" FROM ""Transactions"" AS ""a"" JOIN ""Accounts"" AS ""b"" ON ""a"".""account_id""=""b"".""account_id"" GROUP BY ""a"".""account_id"",TO_CHAR(""a"".""day"", 'YYYY-%m') HAVING SUM(CASE WHEN ""a"".""type""='Creditor' THEN ""a"".""amount"" ELSE 0 END)>MAX(""b"".""max_income"")) SELECT DISTINCT ""a"".""account_id"" FROM (""temp"" AS ""a"") CROSS JOIN ""temp"" AS ""b"" WHERE ""a"".""account_id""=""b"".""account_id"" AND (""b"".""month""=TO_CHAR(DATE(CONCAT(""a"".""month"", '-01')) + INTERVAL '31 DAY', 'YYYY-%m') OR ""b"".""month""=TO_CHAR(DATE(CONCAT(""a"".""month"", '-01')) - INTERVAL '1 DAY', 'YYYY-%m'))"
411,"SELECT DISTINCT ""account_id"" FROM (SELECT ""a"".""account_id"",""tot_income"".""month"",LEAD(""tot_income"".""month"", 1) OVER (PARTITION BY ""a"".""account_id"" ORDER BY ""tot_income"".""month"") AS ""next_month"" FROM (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month"",SUM(""amount"") AS ""total_income"" FROM ""transactions"" AS ""t"" WHERE ""type""='Creditor' GROUP BY ""account_id"",EXTRACT(MONTH FROM ""day"")) AS ""tot_income"" JOIN ""accounts"" AS ""a"" ON ""tot_income"".""account_id""=""a"".""account_id"" AND ""tot_income"".""total_income"">""a"".""max_income"") AS ""check_consecutive"" WHERE ABS(""next_month""-""month"")=1"
412,"WITH ""cte"" AS (SELECT ""account_id"",SUM(""amount"") AS ""amount"",EXTRACT(MONTH FROM ""day"") AS ""months"" FROM ""transactions"" AS ""t"" WHERE ""type""='Creditor' GROUP BY ""account_id"",EXTRACT(MONTH FROM ""day"")), ""cte2"" AS (SELECT ""c"".""account_id"",""months"" FROM ""cte"" AS ""c"" JOIN ""accounts"" AS ""a"" ON ""c"".""account_id""=""a"".""account_id"" WHERE ""amount"">""max_income"") SELECT DISTINCT ""c1"".""account_id"" FROM ""cte2"" AS ""c"" JOIN ""cte2"" AS ""c1"" ON ""c"".""account_id""=""c1"".""account_id"" WHERE ""c1"".""months""-""c"".""months""=1"
413,"WITH ""cte1"" AS (SELECT ""account_id"",EXTRACT(YEAR_MONTH FROM ""day"") AS ""month"",SUM(""amount"") AS ""total_amount"",""max_income"" FROM ""transactions"" AS ""t"" LEFT JOIN ""accounts"" AS ""a"" USING (""account_id"") WHERE ""type""='Creditor' GROUP BY 1,2 HAVING (""total_amount""-""max_income"")>0) SELECT DISTINCT ""t1"".""account_id"" FROM (""cte1"" AS ""t1"") CROSS JOIN ""cte1"" AS ""t2"" WHERE ""t1"".""account_id""=""t2"".""account_id"" AND PERIOD_DIFF(""t1"".""month"", ""t2"".""month"")=1 ORDER BY 1"
414,"WITH ""sum_month"" AS (SELECT ""a"".""account_id"",TO_CHAR(""day"", 'YYYY%m') AS ""date"",SUM(""amount"") AS ""income"",""max_income"" FROM ""Accounts"" AS ""a"" RIGHT JOIN ""Transactions"" AS ""t"" ON ""a"".""account_id""=""t"".""account_id"" WHERE ""t"".""type""='Creditor' GROUP BY ""a"".""account_id"",TO_CHAR(""day"", 'YYYY%m') HAVING ""income"">""max_income"") SELECT DISTINCT (""s1"".""account_id"") FROM ""sum_month"" AS ""s1"" JOIN ""sum_month"" AS ""s2"" ON ""s1"".""account_id""=""s2"".""account_id"" WHERE PERIOD_DIFF(""s1"".""date"", ""s2"".""date"")=1 ORDER BY ""s1"".""account_id"""
415,"WITH ""tmp"" AS (SELECT ""transactions"".""account_id"",SUM(""amount"") AS ""total"",TO_CHAR(""day"", 'YYYY%m') AS ""month"",""accounts"".""max_income"" FROM ""transactions"" JOIN ""accounts"" ON ""transactions"".""account_id""=""accounts"".""account_id"" WHERE ""type""='Creditor' GROUP BY ""transactions"".""account_id"",LEFT(""day"", 7)) SELECT DISTINCT ""i1"".""account_id"" FROM ""tmp"" AS ""i1"" JOIN ""tmp"" AS ""i2"" ON ""i1"".""account_id""=""i2"".""account_id"" AND PERIOD_DIFF(""i1"".""month"", ""i2"".""month"")=1 WHERE ""i1"".""total"">""i1"".""max_income"" AND ""i2"".""total"">""i2"".""max_income"""
416,"WITH ""CTE"" AS (SELECT DISTINCT ""T"".""account_id"",EXTRACT(MONTH FROM ""day"") AS ""MONTH"",""max_income"",SUM(""amount"") OVER (PARTITION BY ""account_id"", EXTRACT(MONTH FROM ""day"")) AS ""monthly_income"" FROM ""Transactions"" AS ""T"" JOIN ""Accounts"" AS ""A"" ON ""T"".""account_id""=""A"".""account_id"" WHERE ""type""='Creditor'), ""CTE2"" AS (SELECT * FROM ""CTE"" WHERE ""monthly_income"">""max_income"") SELECT DISTINCT ""T2"".""account_id"" FROM (""CTE2"" AS ""T1"") CROSS JOIN ""CTE2"" AS ""T2"" WHERE ""T1"".""account_id""=""T2"".""account_id"" AND ""T1"".""MONTH""=""T2"".""MONTH""-1"
417,"WITH ""credits"" AS (SELECT ""account_id"",TO_CHAR(""day"", 'YYYY-%m') AS ""month"",SUM(""amount"") AS ""amount"" FROM ""Transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",TO_CHAR(""day"", 'YYYY-%m')), ""next_month_credits"" AS (SELECT ""account_id"",""month"" AS ""current_month"",""amount"" AS ""current_amount"",LEAD(""month"") OVER (PARTITION BY ""account_id"" ORDER BY ""month"") AS ""next_month"",LEAD(""amount"") OVER (PARTITION BY ""account_id"" ORDER BY ""month"") AS ""next_amount"" FROM ""credits"") SELECT DISTINCT (""account_id"") FROM ""next_month_credits"" LEFT JOIN ""Accounts"" USING (""account_id"") WHERE ""current_amount"">""max_income"" AND ""next_amount"">""max_income"" AND TIMESTAMPDIFF(MONTH, CONCAT(""current_month"", '-01'), CONCAT(""next_month"", '-01'))=1"
418,"WITH ""cte"" AS (SELECT ""t"".""account_id"",EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day"") AS ""month"",(CASE WHEN SUM(""amount"")>""a"".""max_income"" THEN 1 ELSE 0 END) AS ""exceed"" FROM ""transactions"" AS ""t"" JOIN ""accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""type""='Creditor' GROUP BY EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day""),""t"".""account_id"") SELECT DISTINCT ""c1"".""account_id"" FROM (""cte"" AS ""c1"") CROSS JOIN ""cte"" AS ""c2"" WHERE ""c1"".""account_id""=""c2"".""account_id"" AND ""c2"".""month""-""c1"".""month""=1 AND ""c1"".""exceed""=1 AND ""c2"".""exceed""=1"
419,"WITH ""tb1"" AS (SELECT ""t"".""account_id"",""a"".""max_income"",CONCAT(LEFT(""t"".""day"", 7), '-01') AS ""month"",""t"".""type"",""t"".""amount"" FROM ""Transactions"" AS ""t"" JOIN ""Accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id""), ""tb2"" AS (SELECT ""account_id"",""month"",SUM(""amount"") AS ""total_income"",MAX(""max_income"") AS ""max_income"" FROM ""tb1"" WHERE ""type""='Creditor' GROUP BY ""account_id"",""month""), ""tb3"" AS (SELECT ""a"".""account_id"",""a"".""month"",""a"".""total_income"",""b"".""total_income"" AS ""total_income_lag"",""a"".""max_income"" FROM ""tb2"" AS ""a"" LEFT JOIN ""tb2"" AS ""b"" ON ""a"".""month"" - INTERVAL '1 MONTH'=""b"".""month"" AND ""a"".""account_id""=""b"".""account_id"") SELECT DISTINCT ""account_id"" FROM ""tb3"" WHERE ""total_income"">""max_income"" AND ""total_income_lag"">""max_income"" ORDER BY ""account_id"""
420,"WITH ""cte"" AS (SELECT ""t"".""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month"",(CASE WHEN SUM(""amount"")>""a"".""max_income"" THEN 1 ELSE 0 END) AS ""exceed"" FROM ""transactions"" AS ""t"" LEFT JOIN ""accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""type""='Creditor' GROUP BY EXTRACT(MONTH FROM ""day""),""t"".""account_id"") SELECT DISTINCT ""c1"".""account_id"" FROM (""cte"" AS ""c1"") CROSS JOIN ""cte"" AS ""c2"" WHERE ""c1"".""account_id""=""c2"".""account_id"" AND ""c2"".""month""-""c1"".""month""=1 AND ""c1"".""exceed""=1 AND ""c2"".""exceed""=1"
421,"WITH ""cte1"" AS (SELECT ""t"".""account_id"",EXTRACT(MONTH FROM ""day"") AS ""mth"",CASE WHEN SUM(""amount"")-""max_income"">0 THEN 1 ELSE 0 END AS ""sign"" FROM ""transactions"" AS ""t"" JOIN ""accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""type""='Creditor' GROUP BY ""t"".""account_id"",""mth"") SELECT DISTINCT ""a"".""account_id"" FROM (""cte1"" AS ""a"") CROSS JOIN ""cte1"" AS ""b"" WHERE ""a"".""account_id""=""b"".""account_id"" AND ""b"".""mth""=""a"".""mth""+1 AND ""a"".""sign""=1 AND ""b"".""sign""=1"
422,"WITH ""cte"" AS (SELECT ""t"".""account_id"",EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day"") AS ""month"",(CASE WHEN SUM(""amount"")>""a"".""max_income"" THEN 1 ELSE 0 END) AS ""exceed"" FROM ""transactions"" AS ""t"" JOIN ""accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""type""='Creditor' GROUP BY EXTRACT(YEAR FROM ""day"")*12+EXTRACT(MONTH FROM ""day""),""t"".""account_id"") SELECT DISTINCT ""c1"".""account_id"" FROM (""cte"" AS ""c1"") CROSS JOIN ""cte"" AS ""c2"" WHERE ""c1"".""account_id""=""c2"".""account_id"" AND ""c2"".""month""-""c1"".""month""=1 AND ""c1"".""exceed""=1 AND ""c2"".""exceed""=1"
423,"WITH ""cte"" AS (SELECT ""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month"",SUM(""amount"") AS ""tot_month_income"" FROM ""transactions"" WHERE ""type""='Creditor ' GROUP BY ""account_id"",EXTRACT(MONTH FROM ""day"")), ""pre_cook"" AS (SELECT ""a"".""account_id"",""tot_month_income"",""a"".""max_income"",""c"".""month"" FROM ""accounts"" AS ""a"" JOIN ""cte"" AS ""c"" ON ""a"".""account_id""=""c"".""account_id"" GROUP BY ""a"".""account_id"",""tot_month_income"" HAVING ""c"".""tot_month_income"">""a"".""max_income"") SELECT ""p"".""account_id"" FROM ""pre_cook"" AS ""p"" JOIN ""pre_cook"" AS ""pp"" ON ""p"".""account_id""=""pp"".""account_id"" AND PERIOD_DIFF(""p"".""month"", ""pp"".""month"")=1 GROUP BY ""p"".""account_id"" ORDER BY ""p"".""account_id"""
424,"WITH ""CTE"" AS (SELECT ""account_id"",""day"",SUM(""amount"") AS ""amount"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY ""account_id"",TO_CHAR(""day"", 'YYYY-%m') ORDER BY ""account_id"") SELECT DISTINCT ""tab"".""account_id"" FROM (SELECT ""t1"".""account_id"",TO_CHAR(""t1"".""day"", 'YYYY-%m') AS ""t1Date"",""t1"".""amount"" AS ""t1amount"",TO_CHAR(""t2"".""day"", 'YYYY-%m') AS ""t2Date"",""t2"".""amount"" AS ""t2amount"" FROM ""CTE"" AS ""t1"" JOIN ""CTE"" AS ""t2"" ON (""t1"".""account_id""=""t2"".""account_id"") AND (TO_CHAR(""t2"".""day"", 'YYYY-%m')=TO_CHAR(""t1"".""day"" + INTERVAL '1 MONTH', 'YYYY-%m'))) AS ""tab"" JOIN ""accounts"" ON ""accounts"".""account_id""=""tab"".""account_id"" WHERE (""tab"".""t1amount"">""accounts"".""max_income"") AND (""tab"".""t2amount"">""accounts"".""max_income"")"
425,"WITH ""monthly_income"" AS (SELECT ""b"".""account_id"",TO_CHAR(""b"".""day"", '%y%m') AS ""month"",""a"".""max_income"" FROM ""Accounts"" AS ""a"" JOIN ""Transactions"" AS ""b"" ON ""a"".""account_id""=""b"".""account_id"" GROUP BY ""b"".""account_id"",""month"" HAVING SUM((""type""='Creditor')*""amount"")>""a"".""max_income"") SELECT DISTINCT ""a"".""account_id"" FROM ""monthly_income"" AS ""a"" JOIN ""monthly_income"" AS ""b"" ON ""a"".""account_id""=""b"".""account_id"" AND PERIOD_DIFF(""a"".""month"", ""b"".""month"")=1 ORDER BY ""account_id"""
426,"WITH ""t"" AS (SELECT ""account_id"",""transaction_id"",SUM(""amount"") AS ""month_income"",EXTRACT(MONTH FROM ""day"") AS ""month"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY 1,4) SELECT DISTINCT ""ac"".""account_id"" FROM (""accounts"" AS ""ac"" LEFT JOIN ""t"" AS ""t1"" ON ""ac"".""account_id""=""t1"".""account_id"") LEFT JOIN ""t"" AS ""t2"" ON ""t1"".""account_id""=""t2"".""account_id"" AND ""t1"".""month""+1=""t2"".""month"" WHERE ""t1"".""month_income"">""ac"".""max_income"" AND ""t2"".""month_income"">""ac"".""max_income"" ORDER BY ""t1"".""transaction_id"""
427,"WITH ""cte"" AS (SELECT ""account_id"",TO_CHAR(""day"", 'YYYY-%m') AS ""mth"",SUM(""amount"") AS ""month_income"" FROM ""transactions"" WHERE ""type""='Creditor' GROUP BY 1,2), ""temp"" AS (SELECT DISTINCT ""cte"".""account_id"",CONCAT(""mth"", '-01') AS ""mth"" FROM ""cte"" JOIN ""accounts"" AS ""t"" ON ""t"".""account_id""=""cte"".""account_id"" WHERE ""t"".""max_income""<""cte"".""month_income"") SELECT DISTINCT ""t1"".""account_id"" FROM ""temp"" AS ""t1"" JOIN ""temp"" AS ""t2"" ON ""t1"".""account_id""=""t2"".""account_id"" WHERE TIMESTAMPDIFF(MONTH, ""t1"".""mth"", ""t2"".""mth"")=1"
428,"WITH ""ti"" AS (SELECT EXTRACT(MONTH FROM ""day"") AS ""month"",""t"".""account_id"",""a"".""max_income"",SUM(""amount"") AS ""total_income"" FROM ""Transactions"" AS ""t"" JOIN ""Accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""type""='Creditor' GROUP BY 1,2,3 HAVING SUM(""amount"")>""max_income"") SELECT DISTINCT ""a"".""account_id"" FROM ""ti"" AS ""a"" JOIN ""ti"" AS ""b"" ON ""a"".""account_id""=""b"".""account_id"" AND ""b"".""month""=""a"".""month""+1"
429,"WITH ""tmp"" AS (SELECT ""transactions"".""account_id"",SUM(""amount"") AS ""total"",CONCAT(LEFT(""day"", 7), '-01') AS ""month"",""accounts"".""max_income"" FROM ""transactions"" JOIN ""accounts"" ON ""transactions"".""account_id""=""accounts"".""account_id"" WHERE ""type""='Creditor' GROUP BY ""transactions"".""account_id"",TO_CHAR(""day"", 'YYYY-%m')) SELECT DISTINCT ""i1"".""account_id"" FROM ""tmp"" AS ""i1"" JOIN ""tmp"" AS ""i2"" ON ""i1"".""account_id""=""i2"".""account_id"" AND TIMESTAMPDIFF(MONTH, ""i1"".""month"", ""i2"".""month"")=1 WHERE ""i1"".""total"">""i1"".""max_income"" AND ""i2"".""total"">""i2"".""max_income"""
430,"WITH ""CET"" AS (SELECT ""T"".""account_id"",EXTRACT(MONTH FROM ""day"") AS ""DAY"",""max_income"" FROM ""Transactions"" AS ""T"" JOIN ""Accounts"" AS ""A"" ON ""T"".""account_id""=""A"".""account_id"" WHERE ""type""='Creditor' GROUP BY ""account_id"",EXTRACT(MONTH FROM ""day"") HAVING SUM(""amount"")>""A"".""max_income"") SELECT DISTINCT ""account_id"" FROM ""CET"" WHERE ROW(""account_id"",""DAY""-1) IN (SELECT ""account_id"",""DAY"" FROM ""CET"") OR ROW(""account_id"",""DAY""+1) IN (SELECT ""account_id"",""DAY"" FROM ""CET"")"
431,"WITH ""cte1"" AS (SELECT ""t"".""account_id"",EXTRACT(MONTH FROM ""t"".""day"") AS ""month"",CASE WHEN SUM(""t"".""amount"")>""a"".""max_income"" THEN 1 ELSE 0 END AS ""ifst"" FROM ""transactions"" AS ""t"" LEFT JOIN ""accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""t"".""type""='Creditor' GROUP BY ""t"".""account_id"",EXTRACT(MONTH FROM ""t"".""day"") ORDER BY ""t"".""account_id"",""month"") SELECT DISTINCT (""c1"".""account_id"") FROM ""cte1"" AS ""c1"" JOIN ""cte1"" AS ""c2"" ON ""c1"".""account_id""=""c2"".""account_id"" AND ""c1"".""month""=""c2"".""month""+1 AND ""c1"".""ifst""=1 AND ""c2"".""ifst""=1"
432,"WITH ""cte_trans"" AS (SELECT ""a"".""account_id"",SUM(""amount"") AS ""total_amount"",EXTRACT(MONTH FROM ""Day"") AS ""month"" FROM ""Transactions"" AS ""t"" JOIN ""Accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""t"".""type""='Creditor' GROUP BY ""a"".""account_id"",EXTRACT(MONTH FROM ""day""),""a"".""max_income"" HAVING SUM(""amount"")>""a"".""max_income""), ""cte_rank"" AS (SELECT *,DENSE_RANK() OVER (PARTITION BY ""account_id"" ORDER BY ""month"") AS ""drk"" FROM ""cte_trans""), ""cte_grp"" AS (SELECT ""account_id"",""total_amount"",""month""-""drk"" AS ""grp"" FROM ""cte_rank"") SELECT DISTINCT ""account_id"" FROM ""cte_grp"" GROUP BY ""grp"",""account_id"" HAVING COUNT(""account_id"")>=2"
433,"SELECT DISTINCT ""c"".""account_id"" FROM (SELECT ""b"".""account_id"",LEAD(""b"".""month"") OVER (PARTITION BY ""b"".""account_id"" ORDER BY ""b"".""month"") AS ""next_month"",""b"".""month"" FROM (SELECT ""t"".""account_id"",SUM(""t"".""amount"") AS ""income"",EXTRACT(YEAR_MONTH FROM ""t"".""day"") AS ""month"",CASE WHEN ""a"".""max_income""<SUM(""t"".""amount"") THEN 'IS Suspicious' ELSE 'NOT Suspicious' END AS ""status"" FROM ""Transactions"" AS ""t"" JOIN ""Accounts"" AS ""a"" ON ""t"".""type""='Creditor' AND ""a"".""account_id""=""t"".""account_id"" GROUP BY ""t"".""account_id"",EXTRACT(YEAR_MONTH FROM ""t"".""day"")) AS ""b"" WHERE ""b"".""status""='IS Suspicious') AS ""c"" WHERE PERIOD_DIFF(""c"".""next_month"", ""c"".""month"")=1"
434,"WITH ""temp"" AS (SELECT DISTINCT ""a"".""account_id"",""a"".""max_income"",(EXTRACT(YEAR FROM ""b"".""day"")*12+EXTRACT(MONTH FROM ""b"".""day"")) AS ""month"",SUM(""b"".""amount"") AS ""total_income"" FROM ""accounts"" AS ""a"" JOIN ""transactions"" AS ""b"" ON ""a"".""account_id""=""b"".""account_id"" WHERE ""b"".""type""='Creditor' GROUP BY ""a"".""account_id"",""a"".""max_income"",""month"" HAVING ""total_income"">""max_income"") SELECT DISTINCT ""temp1"".""account_id"" FROM ""temp"" AS ""temp1"" JOIN ""temp"" AS ""temp2"" ON ""temp1"".""month""+1=""temp2"".""month"" AND ""temp1"".""account_id""=""temp2"".""account_id"""
435,"WITH ""cte"" AS (SELECT ""account_id"",""day"",CASE WHEN ""amount"">""max_income"" THEN 1 ELSE 0 END AS ""indics"" FROM (SELECT ""a"".""account_id"",EXTRACT(MONTH FROM ""day"") AS ""day"",SUM(CASE WHEN ""type""='creditor' THEN ""amount"" ELSE 0 END) AS ""amount"",""max_income"" FROM ""transactions"" AS ""a"" JOIN ""accounts"" AS ""b"" ON ""a"".""account_id""=""b"".""account_id"" GROUP BY 1,2) AS ""c"") SELECT DISTINCT ""account_id"" FROM (SELECT ""account_id"",""day"",LEAD(""day"", 1, 0) OVER (PARTITION BY ""account_id"" ORDER BY ""day"") AS ""nextm"",""indics"",LEAD(""indics"", 1, 0) OVER (PARTITION BY ""account_id"" ORDER BY ""day"") AS ""indic2"" FROM ""cte"") AS ""c"" WHERE ""nextm""-""day""=1 AND ""indics""=""indic2"" AND ""indics""=1"
436,"WITH ""temp"" AS (SELECT ""account_id"",""amount"",EXTRACT(MONTH FROM ""day"") AS ""months"" FROM ""transactions"" WHERE ""type""='Creditor' ORDER BY 1,3), ""temp1"" AS (SELECT ""account_id"",SUM(""amount"") AS ""sums"",""months"" FROM ""temp"" GROUP BY ""account_id"",""months"" ORDER BY ""account_id""), ""temp2"" AS (SELECT ""t"".*,""a"".""max_income"",CASE WHEN ""sums"">""a"".""max_income"" THEN 1 ELSE 0 END AS ""bin"" FROM ""temp1"" AS ""t"" LEFT JOIN ""accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"") SELECT DISTINCT ""a"".""account_id"" FROM ""temp2"" AS ""a"" LEFT JOIN ""temp2"" AS ""b"" ON ""a"".""account_id""=""b"".""account_id"" WHERE ""a"".""months""=""b"".""months""-1 AND ""a"".""bin""=1 AND ""b"".""bin""=1"
437,"SELECT DISTINCT ""account_id"" FROM (SELECT ""t"".""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month"",SUM(""amount"") AS ""amt"",""max_income"",LAG(EXTRACT(MONTH FROM ""day"")) OVER (PARTITION BY ""t"".""account_id"" ORDER BY EXTRACT(MONTH FROM ""day"")) AS ""lg"" FROM ""transactions"" AS ""t"" LEFT JOIN ""accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""t"".""type""='Creditor' GROUP BY ""t"".""account_id"",EXTRACT(MONTH FROM ""day"") HAVING SUM(""amount"")>""max_income"") AS ""tmp"" WHERE ABS(""month""-""lg"")=1"
438,"WITH ""cte"" AS (SELECT ""t"".""account_id"",EXTRACT(MONTH FROM ""day"") AS ""month"",(CASE WHEN SUM(""amount"")>""a"".""max_income"" THEN 1 ELSE 0 END) AS ""exceed"" FROM ""Transactions"" AS ""t"" JOIN ""Accounts"" AS ""a"" ON ""t"".""account_id""=""a"".""account_id"" WHERE ""type""='Creditor' GROUP BY 1,2) SELECT DISTINCT ""c1"".""account_id"" FROM (""cte"" AS ""c1"") CROSS JOIN ""cte"" AS ""c2"" WHERE ""c1"".""account_id""=""c2"".""account_id"" AND ""c2"".""month""=""c1"".""month""+1 AND ""c1"".""exceed""=1 AND ""c2"".""exceed""=1"
