id,original query
1,"WITH RECURSIVE ""cte"" (""month"") AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""cte"" WHERE ""month""<12), ""driver"" AS (SELECT TO_CHAR(""join_date"", 'YYYY-%m-01') AS ""month"",SUM(COUNT(1)) OVER (ORDER BY TO_CHAR(""join_date"", 'YYYY-%m-01')) AS ""active_drivers"" FROM ""drivers"" WHERE ""join_date""<='2020-12-31' GROUP BY 1), ""driver_2020"" AS (SELECT ""month"",""active_drivers"" FROM ""driver"" WHERE TO_CHAR(""driver"".""month"", 'YYYY')=2020), ""accepted_rides"" AS (SELECT TO_CHAR(""rides"".""requested_at"", 'YYYY-%m-01') AS ""month"",COUNT(DISTINCT ""AcceptedRides"".""driver_id"") AS ""accepted_rides"" FROM ""rides"" JOIN ""AcceptedRides"" USING (""ride_id"") WHERE ""rides"".""requested_at"" BETWEEN '2020-01-01' AND '2020-12-31' GROUP BY 1) SELECT ""cte"".""month"",COALESCE(ROUND(COALESCE(""accepted_rides"".""accepted_rides"", 0)/COALESCE(MAX(""driver_2020"".""active_drivers"") OVER (ORDER BY ""cte"".""month""), 0)*100, 2), 0) AS ""working_percentage"" FROM (""cte"" LEFT JOIN ""driver_2020"" ON ""cte"".""month""=TO_CHAR(""driver_2020"".""month"", '%c')) LEFT JOIN ""accepted_rides"" ON ""cte"".""month""=TO_CHAR(""accepted_rides"".""month"", '%c')"
2,"WITH RECURSIVE ""t1"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""m"",COUNT(DISTINCT ""driver_id"") AS ""c"" FROM ""rides"" AS ""a"" JOIN ""acceptedrides"" AS ""b"" ON ""a"".""ride_id""=""b"".""ride_id"" WHERE ""requested_at"" BETWEEN '2020-01-01' AND '2020-12-31' GROUP BY EXTRACT(MONTH FROM ""requested_at"")), ""t2"" AS (SELECT 1 AS ""m"" UNION ALL SELECT ""m""+1 AS ""m"" FROM ""t2"" WHERE ""m""<12), ""t3"" AS (SELECT ""m"",SUM(CASE WHEN (EXTRACT(YEAR FROM ""join_date"")<=2019) OR (EXTRACT(YEAR FROM ""join_date"")=2020 AND EXTRACT(MONTH FROM ""join_date"")<=""m"") THEN 1 ELSE 0 END) AS ""available_drivers"" FROM ""t2"" AS ""a"" JOIN ""drivers"" AS ""b"" GROUP BY ""a"".""m""), ""t4"" AS (SELECT ""t2"".""m"",COALESCE(""t1"".""c"", 0) AS ""c"" FROM ""t2"" LEFT JOIN ""t1"" ON ""t2"".""m""=""t1"".""m"") SELECT ""t3"".""m"" AS ""month"",CASE WHEN ""t3"".""available_drivers""=0 THEN 0 ELSE ROUND(""t4"".""c""*100/""t3"".""available_drivers"", 2) END AS ""working_percentage"" FROM ""t3"" JOIN ""t4"" ON ""t3"".""m""=""t4"".""m"""
3,"WITH RECURSIVE ""m"" AS (SELECT 1 AS ""month"" UNION SELECT ""month""+1 FROM ""m"" WHERE ""month""<12), ""dr"" AS (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""join_month"",COUNT(""driver_id"") AS ""num_drivers"" FROM (SELECT ""driver_id"",(CASE WHEN ""join_Date""<'2020-01-01' THEN '2020-01-01' ELSE ""join_Date"" END) AS ""join_date"" FROM ""drivers"" WHERE ""join_Date""<'2021-01-01') AS ""sub"" GROUP BY EXTRACT(MONTH FROM ""join_date"")), ""working_dr"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""working_month"",COUNT(DISTINCT ""driver_id"") AS ""working_drivers"" FROM (SELECT ""driver_id"",""requested_at"" FROM ""AcceptedRides"" JOIN ""Rides"" ON ""AcceptedRides"".""ride_id""=""rides"".""ride_id"" WHERE ""requested_at""<'2021-01-01' AND ""requested_at"">='2020-01-01') AS ""ride"" GROUP BY EXTRACT(MONTH FROM ""requested_at"")) SELECT ""month"",ROUND(COALESCE(""working_drivers""/""num_avl_drivers""*100, 0), 2) AS ""working_percentage"" FROM (SELECT ""month"",SUM(""num_drivers"") OVER (ORDER BY ""month"") AS ""num_avl_drivers"",COALESCE(""working_drivers"", 0) AS ""working_drivers"" FROM (""m"" LEFT JOIN ""dr"" ON ""dr"".""join_month""=""m"".""month"") LEFT JOIN ""working_dr"" ON ""working_dr"".""working_month""=""m"".""month"") AS ""all_src"""
4,"WITH RECURSIVE ""T1"" AS (SELECT 1 AS ""join_month"" UNION SELECT ""join_month""+1 FROM ""T1"" WHERE ""join_month""<12), ""T2"" AS (SELECT CASE WHEN EXTRACT(YEAR FROM ""join_date"")<'2020' THEN '1' ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""join_month"",COUNT(""driver_id"") AS ""driver_num"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<='2020' GROUP BY ""join_month""), ""T3"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""join_month"",COUNT(DISTINCT ""ar"".""driver_id"") AS ""ride_num"" FROM ""AcceptedRides"" AS ""ar"" LEFT JOIN ""Rides"" AS ""r"" ON ""ar"".""ride_id""=""r"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")='2020' GROUP BY ""join_month"") SELECT ""T1"".""join_month"" AS ""month"",ROUND(100*COALESCE(""T3"".""ride_num""/SUM(""T2"".""driver_num""), 0), 2) AS ""working_percentage"" FROM (""T1"" LEFT JOIN ""T2"" ON ""T1"".""join_month"">=""T2"".""join_month"") LEFT JOIN ""T3"" ON ""T1"".""join_month""=""T3"".""join_month"" GROUP BY ""T1"".""join_month"" ORDER BY ""T1"".""join_month"""
5,"WITH RECURSIVE ""cte_count"" (""month"") AS (SELECT CAST('2020-01-01' AS DATE) UNION ALL SELECT ""month"" + INTERVAL '1 MONTH' FROM ""cte_count"" WHERE ""month"" + INTERVAL '1 MONTH'<='2020-12-31') SELECT EXTRACT(MONTH FROM ""tmp4"".""month"") AS ""month"",ROUND(COALESCE(COALESCE(""tmp5"".""accepted_drivers"", 0)*100.0/""tmp4"".""active_drivers"", 0), 2) AS ""working_percentage"" FROM (SELECT ""month"",""active_drivers"" FROM (SELECT ""month"",SUM(""active_drivers"") OVER (ORDER BY ""month"") AS ""active_drivers"" FROM (SELECT LAST_DAY(""cte_count"".""month"") AS ""month"",""tmp1"".""active_drivers"" FROM ""cte_count"" LEFT JOIN (SELECT LAST_DAY(""join_date"") AS ""month"",COUNT(""driver_id"") AS ""active_drivers"" FROM ""drivers"" WHERE LAST_DAY(""join_date"") BETWEEN '2020-01-01' AND '2020-12-31' GROUP BY LAST_DAY(""join_date"")) AS ""tmp1"" ON LAST_DAY(""cte_count"".""month"")=""tmp1"".""month"" UNION ALL SELECT CAST('2019-12-31' AS DATE) AS ""month"",COUNT(1) FROM ""Drivers"" WHERE ""join_date""<='2019-12-31') AS ""tmp2"") AS ""tmp3"" WHERE ""month"">='2020-01-01') AS ""tmp4"" LEFT JOIN (SELECT LAST_DAY(""r"".""requested_at"") AS ""month"",COUNT(DISTINCT ""d"".""driver_id"") AS ""accepted_drivers"" FROM (""AcceptedRides"" AS ""a"" JOIN ""drivers"" AS ""d"" ON ""d"".""driver_id""=""a"".""driver_id"") JOIN ""rides"" AS ""r"" ON ""r"".""ride_id""=""a"".""ride_id"" WHERE LAST_DAY(""r"".""requested_at"")<='2020-12-31' GROUP BY LAST_DAY(""r"".""requested_at"")) AS ""tmp5"" ON ""tmp4"".""month""=""tmp5"".""month"""
6,"WITH RECURSIVE ""t1"" AS (SELECT 1 AS ""month"" UNION SELECT ""t1"".""month""+1 FROM ""t1"" WHERE ""t1"".""month""<12), ""t2"" AS (SELECT EXTRACT(MONTH FROM ""rs"".""requested_at"") AS ""month"",COUNT(DISTINCT ""ar"".""driver_id"") AS ""num_workdriver"" FROM ""rides"" AS ""rs"" JOIN ""AcceptedRides"" AS ""ar"" ON ""rs"".""ride_id""=""ar"".""ride_id"" WHERE ""rs"".""requested_at"" BETWEEN '2020-01-01' AND '2020-12-31' GROUP BY EXTRACT(MONTH FROM ""rs"".""requested_at"")), ""t3"" AS (SELECT ""t1"".""month"",SUM(CASE WHEN ""d"".""join_date""<=LAST_DAY(CONCAT('2020-', ""t1"".""month"", '-01')) THEN 1 ELSE 0 END) AS ""num_activedriver"" FROM (""t1"") JOIN ""drivers"" AS ""d"" GROUP BY ""t1"".""month"") SELECT ""t3"".""month"",ROUND(COALESCE(100*""t2"".""num_workdriver""/""t3"".""num_activedriver"", 0), 2) AS ""working_percentage"" FROM ""t3"" LEFT JOIN ""t2"" ON ""t3"".""month""=""t2"".""month"" ORDER BY ""t3"".""month"""
7,"WITH RECURSIVE ""cte"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 AS ""month"" FROM ""cte"" WHERE ""month""<12), ""driversTable"" AS (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(1) AS ""drivers"",ROW_NUMBER() OVER (ORDER BY ""join_date"") AS ""rowNum"" FROM ""Drivers"" AS ""d1"" WHERE ""join_date"" LIKE '2020%' GROUP BY 1), ""driversTable2"" AS (SELECT ""month"",CASE WHEN ""rowNum""=1 THEN ""drivers""+(SELECT COUNT(1) FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<2020) ELSE ""drivers"" END AS ""drivers2"" FROM ""driversTable""), ""acceptedDrivers"" AS (SELECT EXTRACT(MONTH FROM ""r1"".""requested_at"") AS ""month"",COUNT(DISTINCT ""a1"".""driver_id"") AS ""driversDriving"" FROM ""AcceptedRides"" AS ""a1"" LEFT JOIN ""Rides"" AS ""r1"" ON ""a1"".""ride_id""=""r1"".""ride_id"" WHERE ""r1"".""requested_at"" LIKE '2020%' GROUP BY 1), ""monthsTable"" AS (SELECT ""c1"".""month"",""a1"".""driversDriving"" FROM ""cte"" AS ""c1"" LEFT JOIN ""acceptedDrivers"" AS ""a1"" ON ""c1"".""month""=""a1"".""month"") SELECT ""m1"".""month"",COALESCE(ROUND((""m1"".""driversDriving""/SUM(""d1"".""drivers2"") OVER (ORDER BY ""m1"".""month""))*100, 2), 0) AS ""working_percentage"" FROM ""monthsTable"" AS ""m1"" LEFT JOIN ""driversTable2"" AS ""d1"" ON ""m1"".""month""=""d1"".""month"""
8,"WITH RECURSIVE ""cte"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""cte"" WHERE ""month""<12), ""tmp_month_cnt"" AS (SELECT ""month"",COUNT(""driver_id"") AS ""cnt"" FROM (SELECT ""driver_id"",CASE WHEN EXTRACT(YEAR FROM ""join_date"")<2020 THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""month"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<2021) AS ""T"" GROUP BY ""month""), ""acc_month"" AS (SELECT ""month"",SUM(""cnt"") OVER (ORDER BY ""month"") AS ""active_driver"" FROM (SELECT ""a"".""month"",CASE WHEN ""b"".""cnt"" IS NULL THEN 0 ELSE ""b"".""cnt"" END AS ""cnt"" FROM ""cte"" AS ""a"" LEFT JOIN ""tmp_month_cnt"" AS ""b"" ON ""a"".""month""=""b"".""month"") AS ""T""), ""order_driver"" AS (SELECT EXTRACT(MONTH FROM ""a"".""requested_at"") AS ""month"",COUNT(DISTINCT ""b"".""driver_id"") AS ""order_driver"" FROM ""Rides"" AS ""a"" JOIN ""AcceptedRides"" AS ""b"" ON ""a"".""ride_id""=""b"".""ride_id"" WHERE EXTRACT(YEAR FROM ""a"".""requested_at"")=2020 GROUP BY EXTRACT(MONTH FROM ""a"".""requested_at"")) SELECT ""a"".""month"",CASE WHEN ""a"".""active_driver"" IS NULL OR ""a"".""active_driver""=0 THEN 0 WHEN ""b"".""order_driver"" IS NULL THEN 0 ELSE ROUND(""b"".""order_driver""/""a"".""active_driver""*100, 2) END AS ""working_percentage"" FROM ""acc_month"" AS ""a"" LEFT JOIN ""order_driver"" AS ""b"" ON ""a"".""month""=""b"".""month"""
9,"WITH ""accept"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""a"".""driver_id"") AS ""cnt"" FROM ""Rides"" AS ""r"" JOIN ""AcceptedRides"" AS ""a"" USING (""ride_id"") WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY 1), ""allM"" AS (SELECT 1 AS ""month"" UNION ALL SELECT 2 AS ""month"" UNION ALL SELECT 3 AS ""month"" UNION ALL SELECT 4 AS ""month"" UNION ALL SELECT 5 AS ""month"" UNION ALL SELECT 6 AS ""month"" UNION ALL SELECT 7 AS ""month"" UNION ALL SELECT 8 AS ""month"" UNION ALL SELECT 9 AS ""month"" UNION ALL SELECT 10 AS ""month"" UNION ALL SELECT 11 AS ""month"" UNION ALL SELECT 12 AS ""month""), ""driver_num"" AS (SELECT DISTINCT ""month"",COUNT(""driver_id"") OVER (ORDER BY ""month"") AS ""cnt2"" FROM (SELECT ""driver_id"",CASE WHEN ""join_date""<'2020-01-01' THEN EXTRACT(MONTH FROM CAST('2020-01-01' AS DATE)) ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""join_date"" FROM ""Drivers"" WHERE ""join_date""<='2020-12-31') AS ""a"" RIGHT JOIN ""allM"" AS ""m"" ON ""month""=""join_date"") SELECT ""d"".""month"",ROUND(COALESCE(""cnt""/""cnt2""*100, 0), 2) AS ""working_percentage"" FROM ""driver_num"" AS ""d"" LEFT JOIN ""accept"" AS ""a"" USING (""month"") ORDER BY ""d"".""month"""
10,"WITH RECURSIVE ""CTE1"" AS (SELECT 1 AS ""month"" UNION SELECT 1+""month"" FROM ""CTE1"" WHERE ""month""<12), ""CTE2"" AS (SELECT CASE WHEN ""join_date""<='2020-01-31' THEN 1 WHEN ""join_date""<='2020-02-29' THEN 2 WHEN ""join_date""<='2020-03-31' THEN 3 WHEN ""join_date""<='2020-04-30' THEN 4 WHEN ""join_date""<='2020-05-31' THEN 5 WHEN ""join_date""<='2020-06-30' THEN 6 WHEN ""join_date""<='2020-07-31' THEN 7 WHEN ""join_date""<='2020-08-31' THEN 8 WHEN ""join_date""<='2020-09-30' THEN 9 WHEN ""join_date""<='2020-10-31' THEN 10 WHEN ""join_date""<='2020-11-30' THEN 11 WHEN ""join_date""<='2020-12-31' THEN 12 END AS ""month"",COUNT(""driver_id"") AS ""num_of_active_drivers"" FROM ""Drivers"" WHERE ""join_date""<='2020-12-31' GROUP BY CASE WHEN ""join_date""<='2020-01-31' THEN 1 WHEN ""join_date""<='2020-02-29' THEN 2 WHEN ""join_date""<='2020-03-31' THEN 3 WHEN ""join_date""<='2020-04-30' THEN 4 WHEN ""join_date""<='2020-05-31' THEN 5 WHEN ""join_date""<='2020-06-30' THEN 6 WHEN ""join_date""<='2020-07-31' THEN 7 WHEN ""join_date""<='2020-08-31' THEN 8 WHEN ""join_date""<='2020-09-30' THEN 9 WHEN ""join_date""<='2020-10-31' THEN 10 WHEN ""join_date""<='2020-11-30' THEN 11 WHEN ""join_date""<='2020-12-31' THEN 12 END), ""CTE3"" AS (SELECT ""d1"".""month"",COALESCE(""d2"".""num_of_active_drivers"", 0) AS ""num_of_active_drivers"" FROM ""CTE1"" AS ""d1"" LEFT JOIN ""CTE2"" AS ""d2"" ON ""d1"".""month""=""d2"".""month"" ORDER BY 1), ""CTE4"" AS (SELECT ""month"",SUM(""num_of_active_drivers"") OVER (ORDER BY ""month"") AS ""num_of_active_drivers_running_total"" FROM ""CTE3"" ORDER BY 1), ""CTE5"" AS (SELECT ""d2"".""driver_id"",""d1"".""requested_at"" FROM ""Rides"" AS ""d1"" JOIN ""AcceptedRIdes"" AS ""d2"" ON ""d1"".""ride_id""=""d2"".""ride_id"" WHERE ""d1"".""requested_at"" BETWEEN '2020-01-01' AND '2020-12-31' ORDER BY 2), ""CTE6"" AS (SELECT CASE WHEN ""requested_at""<='2020-01-31' THEN 1 WHEN ""requested_at""<='2020-02-29' THEN 2 WHEN ""requested_at""<='2020-03-31' THEN 3 WHEN ""requested_at""<='2020-04-30' THEN 4 WHEN ""requested_at""<='2020-05-31' THEN 5 WHEN ""requested_at""<='2020-06-30' THEN 6 WHEN ""requested_at""<='2020-07-31' THEN 7 WHEN ""requested_at""<='2020-08-31' THEN 8 WHEN ""requested_at""<='2020-09-30' THEN 9 WHEN ""requested_at""<='2020-10-31' THEN 10 WHEN ""requested_at""<='2020-11-30' THEN 11 WHEN ""requested_at""<='2020-12-31' THEN 12 END AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""num_of_driver_accepted_rides"" FROM ""CTE5"" GROUP BY CASE WHEN ""requested_at""<='2020-01-31' THEN 1 WHEN ""requested_at""<='2020-02-29' THEN 2 WHEN ""requested_at""<='2020-03-31' THEN 3 WHEN ""requested_at""<='2020-04-30' THEN 4 WHEN ""requested_at""<='2020-05-31' THEN 5 WHEN ""requested_at""<='2020-06-30' THEN 6 WHEN ""requested_at""<='2020-07-31' THEN 7 WHEN ""requested_at""<='2020-08-31' THEN 8 WHEN ""requested_at""<='2020-09-30' THEN 9 WHEN ""requested_at""<='2020-10-31' THEN 10 WHEN ""requested_at""<='2020-11-30' THEN 11 WHEN ""requested_at""<='2020-12-31' THEN 12 END) SELECT ""d1"".""month"",ROUND(COALESCE(100.00*""d2"".""num_of_driver_accepted_rides""/""d1"".""num_of_active_drivers_running_total"", 0.00), 2) AS ""working_percentage"" FROM ""CTE4"" AS ""d1"" LEFT JOIN ""CTE6"" AS ""d2"" ON ""d1"".""month""=""d2"".""month"" ORDER BY 1"
11,"WITH RECURSIVE ""mons"" AS (SELECT 2020 AS ""year"",1 AS ""mon"" UNION ALL SELECT 2020 AS ""year"",""mon""+1 AS ""mon"" FROM ""mons"" WHERE ""mon""+1<=12), ""active_drivers"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""mon"",COUNT(DISTINCT ""driver_id"") AS ""ct"" FROM ""AcceptedRides"" AS ""a"" JOIN ""rides"" AS ""r"" ON ""a"".""ride_id""=""r"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY 1), ""dpm"" AS (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""mon"",EXTRACT(YEAR FROM ""join_date"") AS ""year"",COUNT(1) AS ""num_drivers"" FROM ""drivers"" GROUP BY 1,2), ""dpm1"" AS (SELECT COALESCE(""m"".""year"", ""d"".""year"") AS ""year"",COALESCE(""m"".""mon"", ""d"".""mon"") AS ""mon"",COALESCE(""num_drivers"", 0) AS ""num_drivers"" FROM ""dpm"" AS ""d"" LEFT JOIN ""mons"" AS ""m"" ON ""m"".""year""=""d"".""year"" AND ""m"".""mon""=""d"".""mon"" UNION SELECT COALESCE(""m"".""year"", ""d"".""year"") AS ""year"",COALESCE(""m"".""mon"", ""d"".""mon"") AS ""mon"",COALESCE(""num_drivers"", 0) AS ""num_drivers"" FROM ""dpm"" AS ""d"" RIGHT JOIN ""mons"" AS ""m"" ON ""m"".""year""=""d"".""year"" AND ""m"".""mon""=""d"".""mon""), ""avail_drivers"" AS (SELECT ""year"",""mon"",SUM(""num_drivers"") OVER (ORDER BY ""year"",""mon"" ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS ""ct"" FROM ""dpm1"") SELECT ""t2"".""mon"" AS ""month"",COALESCE(CAST(COALESCE(""t1"".""ct"", 0)*100.0/""t2"".""ct"" AS DECIMAL(65, 2)), 0) AS ""working_percentage"" FROM ""active_drivers"" AS ""t1"" RIGHT JOIN ""avail_drivers"" AS ""t2"" ON ""t1"".""mon""=""t2"".""mon"" WHERE ""t2"".""year""=2020"
12,"WITH RECURSIVE ""t1"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""t1"" WHERE ""month""<12), ""t2"" AS (SELECT CASE WHEN EXTRACT(YEAR FROM ""join_date"")<2020 THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""month"",COUNT(""driver_id"") AS ""new_drivers"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020 GROUP BY ""month""), ""t3"" AS (SELECT ""t1"".""month"",SUM(COALESCE(""new_drivers"", 0)) OVER (ORDER BY ""t1"".""month"") AS ""all_drivers"" FROM ""t1"" LEFT JOIN ""t2"" ON ""t1"".""month""=""t2"".""month""), ""t4"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""accepted_driver"" FROM ""Rides"" AS ""a"" JOIN ""Acceptedrides"" AS ""b"" ON ""a"".""ride_id""=""b"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY 1), ""t5"" AS (SELECT ""t1"".""month"",COALESCE(""t4"".""accepted_driver"", 0) AS ""accepted_driver"" FROM ""t1"" LEFT JOIN ""t4"" ON ""t1"".""month""=""t4"".""month"") SELECT ""t3"".""month"",COALESCE(ROUND(""accepted_driver""/""all_drivers""*100, 2), 0.00) AS ""working_percentage"" FROM ""t3"" JOIN ""t5"" ON ""t3"".""month""=""t5"".""month"""
13,"WITH RECURSIVE ""cte"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""cte"" WHERE ""month""<12), ""table1"" AS (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(""driver_id"") AS ""cnt_driver"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")=2020 GROUP BY ""month""), ""table2"" AS (SELECT ""cte"".""month"",SUM(COALESCE(""cnt_driver"", 0)) OVER (ORDER BY ""month"")+(SELECT COUNT(DISTINCT ""driver_id"") FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<2020) AS ""avail_driver"" FROM ""cte"" LEFT JOIN ""table1"" USING (""month"")), ""table3"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""a"".""driver_id"") AS ""accepted_driver"" FROM ""AcceptedRides"" AS ""a"" JOIN ""Rides"" AS ""r"" USING (""ride_id"") WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY ""month"") SELECT ""table2"".""month"",ROUND(COALESCE(""accepted_driver""/""avail_driver"", 0)*100, 2) AS ""working_percentage"" FROM ""table2"" LEFT JOIN ""table3"" USING (""month"") ORDER BY ""month"""
14,"WITH ""months"" AS (SELECT EXTRACT(YEAR FROM ""join_date"") AS ""year"",EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(1) AS ""joined_that_month"" FROM ""Drivers"" GROUP BY EXTRACT(YEAR FROM ""join_date""),EXTRACT(MONTH FROM ""join_date"")), ""ride_months"" AS (SELECT 1 AS ""ride_month"" UNION ALL SELECT 2 UNION ALL SELECT 3 UNION ALL SELECT 4 UNION ALL SELECT 5 UNION ALL SELECT 6 UNION ALL SELECT 7 UNION ALL SELECT 8 UNION ALL SELECT 9 UNION ALL SELECT 10 UNION ALL SELECT 11 UNION ALL SELECT 12), ""active_drivers"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""active_count"" FROM ""AcceptedRides"" AS ""ar"" JOIN ""Rides"" AS ""r"" USING (""ride_id"") WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY EXTRACT(MONTH FROM ""requested_at"")) SELECT ""ride_months"".""ride_month"" AS ""month"",COALESCE(ROUND(100*(""active_drivers"".""active_count"")/SUM(""months"".""joined_that_month""), 2), 0) AS ""working_percentage"" FROM (""ride_months"" LEFT JOIN ""months"" ON (""ride_months"".""ride_month"">=""months"".""month"" AND ""months"".""year""=2020) OR ""months"".""year""<2020) LEFT JOIN ""active_drivers"" ON ""ride_months"".""ride_month""=""active_drivers"".""month"" GROUP BY ""ride_months"".""ride_month"""
15,"WITH RECURSIVE ""cte_count"" (""month"") AS (SELECT CAST('2020-01-01' AS DATE) UNION ALL SELECT ""month"" + INTERVAL '1 MONTH' FROM ""cte_count"" WHERE ""month"" + INTERVAL '1 MONTH'<='2020-12-31') SELECT EXTRACT(MONTH FROM ""tmp4"".""month"") AS ""month"",ROUND(COALESCE(COALESCE(""tmp5"".""accepted_drivers"", 0)*100.0/""tmp4"".""active_drivers"", 0), 2) AS ""working_percentage"" FROM (SELECT ""month"",""active_drivers"" FROM (SELECT ""month"",SUM(""active_drivers"") OVER (ORDER BY ""month"") AS ""active_drivers"" FROM (SELECT LAST_DAY(""cte_count"".""month"") AS ""month"",""tmp1"".""active_drivers"" FROM ""cte_count"" LEFT JOIN (SELECT LAST_DAY(""join_date"") AS ""month"",COUNT(""driver_id"") AS ""active_drivers"" FROM ""drivers"" WHERE LAST_DAY(""join_date"") BETWEEN '2020-01-01' AND '2020-12-31' GROUP BY LAST_DAY(""join_date"")) AS ""tmp1"" ON LAST_DAY(""cte_count"".""month"")=""tmp1"".""month"" UNION ALL SELECT CAST('2019-12-31' AS DATE) AS ""month"",COUNT(1) FROM ""Drivers"" WHERE ""join_date""<='2019-12-31') AS ""tmp2"") AS ""tmp3"" WHERE ""month"">='2020-01-01') AS ""tmp4"" LEFT JOIN (SELECT LAST_DAY(""r"".""requested_at"") AS ""month"",COUNT(DISTINCT ""d"".""driver_id"") AS ""accepted_drivers"" FROM (""AcceptedRides"" AS ""a"" JOIN ""drivers"" AS ""d"" ON ""d"".""driver_id""=""a"".""driver_id"") JOIN ""rides"" AS ""r"" ON ""r"".""ride_id""=""a"".""ride_id"" WHERE LAST_DAY(""r"".""requested_at"")<='2020-12-31' GROUP BY LAST_DAY(""r"".""requested_at"")) AS ""tmp5"" ON ""tmp4"".""month""=""tmp5"".""month"""
16,"WITH RECURSIVE ""MONTH"" AS (SELECT 1 AS ""month"" UNION SELECT ""month""+1 FROM ""MONTH"" WHERE ""month""<12), ""T1"" AS (SELECT EXTRACT(MONTH FROM ""R"".""requested_at"") AS ""month"",""A"".""driver_id"",COUNT(""A"".""ride_id"") AS ""accepted_num"" FROM (SELECT * FROM ""Rides"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020) AS ""R"" LEFT JOIN ""AcceptedRides"" AS ""A"" ON ""R"".""ride_id""=""A"".""ride_id"" GROUP BY 1,2 HAVING COUNT(""A"".""ride_id"")>0), ""T2"" AS (SELECT ""M"".""month"",COUNT(DISTINCT ""T1"".""driver_id"") AS ""driver_num"" FROM ""MONTH"" AS ""M"" LEFT JOIN ""T1"" ON ""M"".""month""=""T1"".""month"" GROUP BY 1), ""T3"" AS (SELECT CASE WHEN EXTRACT(YEAR FROM ""join_date"")<2020 THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""month"",COUNT(""driver_id"") AS ""num"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020 GROUP BY 1), ""T4"" AS (SELECT ""M"".""month"",SUM(COALESCE(""T3"".""num"", 0)) OVER (ORDER BY ""M"".""month"") AS ""available_num"" FROM ""MONTH"" AS ""M"" LEFT JOIN ""T3"" ON ""M"".""month""=""T3"".""month"") SELECT ""T2"".""month"",ROUND(COALESCE((""T2"".""driver_num""/""T4"".""available_num""), 0)*100, 2) AS ""working_percentage"" FROM ""T2"" JOIN ""T4"" ON ""T2"".""month""=""T4"".""month"""
17,"WITH RECURSIVE ""all_months0"" AS (SELECT '2020-02-01' AS ""the_month"" UNION ALL SELECT ""the_month"" + INTERVAL '1 MONTH' AS ""the_month"" FROM ""all_months0"" WHERE ""the_month""<'2020-12-31'), ""all_months"" AS (SELECT ""the_month"" - INTERVAL '1 DAY' AS ""the_month"" FROM ""all_months0""), ""drivers_count"" AS (SELECT EXTRACT(MONTH FROM ""a"".""the_month"") AS ""the_month"",COUNT(""driver_id"") AS ""driver_count"" FROM ""all_months"" AS ""a"" LEFT JOIN ""drivers"" AS ""d"" ON ""d"".""join_date""<=""a"".""the_month"" GROUP BY 1), ""accepted_rides"" AS (SELECT EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""the_month"",COUNT(DISTINCT ""a"".""driver_id"") AS ""ride_count"" FROM ""acceptedrides"" AS ""a"" JOIN ""rides"" AS ""r"" ON ""a"".""ride_id""=""r"".""ride_id"" WHERE ""requested_at"" BETWEEN '2020-01-01' AND '2020-12-31' GROUP BY 1) SELECT ""month"",COALESCE(""working_percentage"", 0) AS ""working_percentage"" FROM (SELECT ""d"".""the_month"" AS ""month"",ROUND(100*""a"".""ride_count""/""d"".""driver_count"", 2) AS ""working_percentage"" FROM ""drivers_count"" AS ""d"" LEFT JOIN ""accepted_rides"" AS ""a"" ON ""d"".""the_month""=""a"".""the_month"") AS ""result_table"""
18,"WITH RECURSIVE ""cte"" AS (SELECT '2020-01-01' AS ""datemonth"" UNION ALL SELECT ""datemonth"" + INTERVAL '1 MONTH' AS ""datemonth"" FROM ""cte"" WHERE ""datemonth""<'2020-12-01'), ""cte1"" AS (SELECT ""driver_id"",""requested_at"",EXTRACT(MONTH FROM ""requested_at"") AS ""month"" FROM ""AcceptedRides"" AS ""a"" LEFT JOIN ""Rides"" AS ""r"" ON ""a"".""ride_id""=""r"".""ride_id"" WHERE ""requested_at"" BETWEEN '2020-01-01' AND '2020-12-31'), ""cte2"" AS (SELECT ""driver_id"",EXTRACT(MONTH FROM ""join_date"") AS ""month"" FROM (SELECT ""driver_id"",CASE WHEN ""join_date""<'2020-01-01' THEN '2020-01-01' ELSE ""join_date"" END AS ""join_date"" FROM ""Drivers"" WHERE ""join_date""<='2020-12-31') AS ""t""), ""cte3"" AS (SELECT ""month"",SUM(""num_new_driver"") OVER (ORDER BY ""month"") AS ""num_driver"" FROM (SELECT ""t"".""month"",COALESCE(""t2"".""num_new_driver"", 0) AS ""num_new_driver"" FROM (SELECT EXTRACT(MONTH FROM ""datemonth"") AS ""month"" FROM ""cte"") AS ""t"" LEFT JOIN (SELECT ""month"",COUNT(""driver_id"") AS ""num_new_driver"" FROM ""cte2"" GROUP BY ""month"") AS ""t2"" ON ""t"".""month""=""t2"".""month"") AS ""t3"") SELECT ""c3"".""month"",ROUND(COALESCE(""c1"".""num_active_driver""/""c3"".""num_driver"", 0)*100, 2) AS ""working_percentage"" FROM ""cte3"" AS ""c3"" LEFT JOIN (SELECT ""month"",COUNT(DISTINCT ""driver_id"") AS ""num_active_driver"" FROM ""cte1"" GROUP BY ""month"") AS ""c1"" ON ""c3"".""month""=""c1"".""month"" ORDER BY ""c3"".""month"""
19,"WITH RECURSIVE ""cte"" (""month"") AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""cte"" WHERE ""month""<12), ""driver"" AS (SELECT TO_CHAR(""join_date"", 'YYYY-%m-01') AS ""month"",SUM(COUNT(1)) OVER (ORDER BY TO_CHAR(""join_date"", 'YYYY-%m-01')) AS ""active_drivers"" FROM ""drivers"" WHERE ""join_date""<='2020-12-31' GROUP BY 1), ""driver_2020"" AS (SELECT ""month"",""active_drivers"" FROM ""driver"" WHERE TO_CHAR(""driver"".""month"", 'YYYY')=2020), ""accepted_rides"" AS (SELECT TO_CHAR(""rides"".""requested_at"", 'YYYY-%m-01') AS ""month"",COUNT(DISTINCT ""AcceptedRides"".""driver_id"") AS ""accepted_rides"" FROM ""rides"" JOIN ""AcceptedRides"" USING (""ride_id"") WHERE ""rides"".""requested_at"" BETWEEN '2020-01-01' AND '2020-12-31' GROUP BY 1) SELECT ""cte"".""month"",COALESCE(ROUND(COALESCE(""accepted_rides"".""accepted_rides"", 0)/COALESCE(MAX(""driver_2020"".""active_drivers"") OVER (ORDER BY ""cte"".""month""), 0)*100, 2), 0) AS ""working_percentage"" FROM (""cte"" LEFT JOIN ""driver_2020"" ON ""cte"".""month""=TO_CHAR(""driver_2020"".""month"", '%c')) LEFT JOIN ""accepted_rides"" ON ""cte"".""month""=TO_CHAR(""accepted_rides"".""month"", '%c')"
20,"WITH RECURSIVE ""months"" AS (SELECT 1 AS ""month"" UNION SELECT ""month""+1 FROM ""months"" WHERE ""month""<12), ""available_drivers_each_month"" AS (SELECT CASE WHEN EXTRACT(YEAR FROM ""join_date"")<2020 THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""month"",COUNT(""driver_id"") AS ""drives"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020 GROUP BY ""month""), ""active_drive_each_month"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""ar"".""driver_id"") AS ""ride_num"" FROM ""AcceptedRides"" AS ""ar"" LEFT JOIN ""Rides"" AS ""r"" ON ""ar"".""ride_id""=""r"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")='2020' GROUP BY ""month"") SELECT ""T1"".""month"" AS ""month"",ROUND(100*COALESCE(""T3"".""ride_num""/SUM(""T2"".""drives""), 0), 2) AS ""working_percentage"" FROM (""months"" AS ""T1"" LEFT JOIN ""available_drivers_each_month"" AS ""T2"" ON ""T1"".""month"">=""T2"".""month"") LEFT JOIN ""active_drive_each_month"" AS ""T3"" ON ""T1"".""month""=""T3"".""month"" GROUP BY ""T1"".""month"" ORDER BY ""T1"".""month"""
21,"WITH RECURSIVE ""t1"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""m"",COUNT(DISTINCT ""driver_id"") AS ""c"" FROM ""rides"" AS ""a"" JOIN ""acceptedrides"" AS ""b"" ON ""a"".""ride_id""=""b"".""ride_id"" WHERE ""requested_at"" BETWEEN '2020-01-01' AND '2020-12-31' GROUP BY EXTRACT(MONTH FROM ""requested_at"")), ""t2"" AS (SELECT 1 AS ""m"" UNION ALL SELECT ""m""+1 AS ""m"" FROM ""t2"" WHERE ""m""<12), ""t3"" AS (SELECT ""m"",SUM(CASE WHEN (EXTRACT(YEAR FROM ""join_date"")<=2019) OR (EXTRACT(YEAR FROM ""join_date"")=2020 AND EXTRACT(MONTH FROM ""join_date"")<=""m"") THEN 1 ELSE 0 END) AS ""available_drivers"" FROM ""t2"" AS ""a"" JOIN ""drivers"" AS ""b"" GROUP BY ""a"".""m""), ""t4"" AS (SELECT ""t2"".""m"",COALESCE(""t1"".""c"", 0) AS ""c"" FROM ""t2"" LEFT JOIN ""t1"" ON ""t2"".""m""=""t1"".""m"") SELECT ""t3"".""m"" AS ""month"",CASE WHEN ""t3"".""available_drivers""=0 THEN 0 ELSE ROUND(""t4"".""c""*100/""t3"".""available_drivers"", 2) END AS ""working_percentage"" FROM ""t3"" JOIN ""t4"" ON ""t3"".""m""=""t4"".""m"""
22,"WITH RECURSIVE ""AllMonths"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 AS ""month"" FROM ""AllMonths"" WHERE ""month""<12), ""AvailableDrivers"" AS (SELECT ""driver_id"",CASE WHEN EXTRACT(YEAR FROM ""join_date"")<2020 THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""month"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020), ""AvailableDriversMonthlySummary"" AS (SELECT ""Al"".""month"",COUNT(""AD"".""driver_id"") AS ""drivers"" FROM ""AllMonths"" AS ""Al"" LEFT JOIN ""AvailableDrivers"" AS ""AD"" ON ""Al"".""month""=""AD"".""month"" GROUP BY ""Al"".""month""), ""AvailableDriversMonthlyCumulative"" AS (SELECT ""month"",SUM(""drivers"") OVER (ORDER BY ""month"") AS ""available_drivers"" FROM ""AvailableDriversMonthlySummary""), ""DriversAcceptedRides"" AS (SELECT DISTINCT ""AR"".""driver_id"",EXTRACT(MONTH FROM ""R"".""requested_at"") AS ""month"" FROM ""AcceptedRides"" AS ""AR"" JOIN ""Rides"" AS ""R"" ON ""R"".""ride_id""=""AR"".""ride_id"" WHERE EXTRACT(YEAR FROM ""R"".""requested_at"")=2020), ""DriversSummary"" AS (SELECT ""Al"".""month"",COUNT(""DAR"".""driver_id"") AS ""actice_drivers"" FROM ""AllMonths"" AS ""Al"" LEFT JOIN ""DriversAcceptedRides"" AS ""DAR"" ON ""DAR"".""month""=""Al"".""month"" GROUP BY ""Al"".""month"") SELECT ""DS"".""month"",COALESCE(ROUND(""DS"".""actice_drivers""*100/""ADMC"".""available_drivers"", 2), 0) AS ""working_percentage"" FROM ""DriversSummary"" AS ""DS"" JOIN ""AvailableDriversMonthlyCumulative"" AS ""ADMC"" ON ""ADMC"".""month""=""DS"".""month"" ORDER BY 1"
23,"WITH RECURSIVE ""month_2020"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""month_2020"" WHERE ""month""+1<13), ""accepted_driver"" AS (SELECT ""accepted_driver_cnt"",""b"".""month"" FROM (SELECT COUNT(DISTINCT ""driver_id"") AS ""accepted_driver_cnt"",EXTRACT(MONTH FROM ""requested_at"") AS ""month"" FROM ""acceptedrides"" JOIN ""rides"" ON ""acceptedrides"".""ride_id""=""rides"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY EXTRACT(MONTH FROM ""requested_at"")) AS ""t"" RIGHT JOIN ""month_2020"" AS ""b"" ON ""t"".""month""=""b"".""month""), ""available_driver_month"" AS (SELECT SUM(""available_drivers"") AS ""available_drivers"",""month"" FROM ((SELECT COALESCE(""available_drivers"", 0) AS ""available_drivers"",""b"".""month"" FROM (SELECT COUNT(""driver_id"") AS ""available_drivers"",EXTRACT(MONTH FROM ""join_date"") AS ""join_month"",EXTRACT(YEAR FROM ""join_date"") AS ""join_year"" FROM ""drivers"" GROUP BY EXTRACT(YEAR FROM ""join_date""),EXTRACT(MONTH FROM ""join_date"")) AS ""aa"" RIGHT JOIN ""month_2020"" AS ""b"" ON ""aa"".""join_month""=""b"".""month"" AND ""aa"".""join_year""=2020) UNION ALL (SELECT COUNT(""driver_id"") AS ""available_drivers"",1 AS ""month"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<2020)) AS ""co"" GROUP BY ""month"") SELECT ""a"".""month"",CASE WHEN ""a"".""driver_during_month""=0 THEN 0.00 ELSE ROUND((COALESCE(""b"".""accepted_driver_cnt"", 0)/COALESCE(""a"".""driver_during_month"", 1))*100, 2) END AS ""working_percentage"" FROM (SELECT ""month"",SUM(""available_drivers"") OVER (ORDER BY ""month"" ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS ""driver_during_month"" FROM ""available_driver_month"") AS ""a"" RIGHT JOIN ""accepted_driver"" AS ""b"" ON ""a"".""month""=""b"".""month"""
24,"WITH RECURSIVE ""A1"" AS (SELECT 1 AS ""MONTH"" UNION ALL SELECT ""MONTH""+1 FROM ""A1"" WHERE ""MONTH""<12), ""A2"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""MONTH"",COUNT(DISTINCT ""driver_id"") AS ""NUM"" FROM ""AcceptedRides"" AS ""A"" JOIN ""Rides"" AS ""R"" ON ""A"".""ride_id""=""R"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY EXTRACT(MONTH FROM ""requested_at"")), ""A3"" AS (SELECT ""driver_id"",(CASE WHEN EXTRACT(YEAR FROM ""join_date"")=2019 THEN '1' ELSE EXTRACT(MONTH FROM ""join_date"") END) AS ""MONTH"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<2021) SELECT ""A1"".""MONTH"" AS ""month"",COALESCE(ROUND(COALESCE(""NUM"", 0)/COALESCE(COUNT(""driver_id""), 0)*100, 2), 0) AS ""working_percentage"" FROM (""A1"" LEFT JOIN ""A2"" ON ""A1"".""MONTH""=""A2"".""MONTH"") LEFT JOIN ""A3"" ON ""A1"".""MONTH"">=""A3"".""MONTH"" GROUP BY ""A1"".""MONTH"""
25,"WITH RECURSIVE ""cte"" (""month"") AS (SELECT 1 UNION ALL SELECT ""month""+1 FROM ""cte"" WHERE ""month""<12), ""driver"" AS (SELECT CASE WHEN EXTRACT(YEAR FROM ""join_date"")<2020 THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""month"",COUNT(""driver_id"") AS ""driver_cnt"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020 GROUP BY ""month""), ""ride"" AS (SELECT EXTRACT(MONTH FROM ""x"".""requested_at"") AS ""month"",COUNT(DISTINCT ""y"".""driver_id"") AS ""driver_cnt2"" FROM ""Rides"" AS ""x"" JOIN ""AcceptedRides"" AS ""y"" ON ""x"".""ride_id""=""y"".""ride_id"" WHERE EXTRACT(YEAR FROM ""x"".""requested_at"")=2020 GROUP BY ""month"") SELECT ""a"".""month"",CASE WHEN ""b"".""driver_cnt2""/SUM(""c"".""driver_cnt"")*100 IS NULL THEN 0.00 ELSE ROUND(""b"".""driver_cnt2""/SUM(""c"".""driver_cnt"")*100, 2) END AS ""working_percentage"" FROM (""cte"" AS ""a"" LEFT JOIN ""ride"" AS ""b"" ON ""a"".""month""=""b"".""month"") LEFT JOIN ""driver"" AS ""c"" ON ""c"".""month""<=""a"".""month"" GROUP BY ""a"".""month"" ORDER BY ""a"".""month"""
26,"WITH ""working_drivers_by_month"" AS (SELECT EXTRACT(MONTH FROM ""R"".""requested_at"") AS ""month"",COUNT(DISTINCT ""A"".""driver_id"") AS ""wd"" FROM ""Rides"" AS ""R"" JOIN ""AcceptedRides"" AS ""A"" ON ""R"".""ride_id""=""A"".""ride_id"" WHERE EXTRACT(YEAR FROM ""R"".""requested_at"")=2020 GROUP BY ""month""), ""month"" AS (SELECT 1 AS ""month"" UNION ALL SELECT 2 AS ""month"" UNION ALL SELECT 3 AS ""month"" UNION ALL SELECT 4 AS ""month"" UNION ALL SELECT 5 AS ""month"" UNION ALL SELECT 6 AS ""month"" UNION ALL SELECT 7 AS ""month"" UNION ALL SELECT 8 AS ""month"" UNION ALL SELECT 9 AS ""month"" UNION ALL SELECT 10 AS ""month"" UNION ALL SELECT 11 AS ""month"" UNION ALL SELECT 12 AS ""month""), ""active_drivers_by_month"" AS (SELECT CASE WHEN EXTRACT(YEAR FROM ""join_date"")<2020 THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""month"",COUNT(""driver_id"") AS ""ad"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020 GROUP BY ""month"") SELECT ""M"".""month"",ROUND(COALESCE(COALESCE(""W"".""wd"", 0)/(SUM(COALESCE(""A"".""ad"", 0)) OVER (ORDER BY ""M"".""month""))*100, 0), 2) AS ""working_percentage"" FROM (""Month"" AS ""M"" LEFT JOIN ""working_drivers_by_month"" AS ""W"" ON ""W"".""month""=""M"".""month"") LEFT JOIN ""active_drivers_by_month"" AS ""A"" ON ""A"".""month""=""M"".""month"""
27,"WITH RECURSIVE ""cte"" (""month"") AS (SELECT 1 UNION ALL SELECT ""month""+1 FROM ""cte"" WHERE ""month""<12), ""Drivers_2020"" AS (SELECT ""driver_id"",CASE WHEN EXTRACT(YEAR FROM ""join_date"")<2020 THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""month"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020), ""Working_drivers"" AS (SELECT EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""month"",COUNT(DISTINCT ""ar"".""driver_id"") AS ""working_drivers"" FROM ""Rides"" AS ""r"" JOIN ""AcceptedRides"" AS ""ar"" ON ""r"".""ride_id""=""ar"".""ride_id"" WHERE EXTRACT(YEAR FROM ""r"".""requested_at"")=2020 GROUP BY ""month"") SELECT DISTINCT ""c"".""month"",ROUND(COALESCE(COALESCE(""w"".""working_drivers"", 0)/COUNT(""d"".""driver_id"") OVER (ORDER BY ""c"".""month""), 0)*100, 2) AS ""working_percentage"" FROM (""cte"" AS ""c"" LEFT JOIN ""Drivers_2020"" AS ""d"" ON ""c"".""month""=""d"".""month"") LEFT JOIN ""Working_drivers"" AS ""w"" ON ""c"".""month""=""w"".""month"""
28,"WITH RECURSIVE ""all_months"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""all_months"" WHERE ""month""<12), ""available_drivers"" AS (SELECT ""month"",SUM(""ct"") OVER (ORDER BY ""month"") AS ""ct_available"" FROM (SELECT ""a"".""month"",COUNT(""b"".""driver_id"") AS ""ct"" FROM ""all_months"" AS ""a"" LEFT JOIN (SELECT ""driver_id"",CASE WHEN ""join_date""<'2020-01-01' THEN '2020-01-01' ELSE ""join_date"" END AS ""join_date"" FROM ""drivers"" WHERE ""join_date""<='2020-12-31') AS ""b"" ON ""a"".""month""=TO_CHAR(""b"".""join_date"", '%m') GROUP BY ""a"".""month"") AS ""c""), ""accepted_drivers"" AS (SELECT ""a"".""month"",""b"".""ct"" AS ""drivers_accepted_rides"" FROM ""all_months"" AS ""a"" LEFT JOIN (SELECT TO_CHAR(""r"".""requested_at"", '%m') AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""ct"" FROM ""acceptedrides"" AS ""ar"" JOIN ""rides"" AS ""r"" USING (""ride_id"") WHERE ""requested_at"" BETWEEN '2020-01-01' AND '2020-12-31' GROUP BY TO_CHAR(""r"".""requested_at"", '%m')) AS ""b"" ON ""a"".""month""=""b"".""month"") SELECT ""ac"".""month"",CASE WHEN ""ac"".""drivers_accepted_rides"" IS NULL THEN 0 ELSE ROUND((""ac"".""drivers_accepted_rides""*100)/""av"".""ct_available"", 2) END AS ""working_percentage"" FROM ""accepted_drivers"" AS ""ac"" JOIN ""available_drivers"" AS ""av"" USING (""month"")"
29,"WITH RECURSIVE ""cte"" AS (SELECT 1 AS ""month"",0 AS ""driver_cnt"" UNION ALL SELECT ""month""+1 AS ""month"",0 AS ""driver_cnt"" FROM ""cte"" WHERE ""month""<12), ""cte1"" AS (SELECT ""month"" AS ""driver_month"",SUM(""driver_cnt"") OVER (ORDER BY ""month"") AS ""driver_cnt"" FROM (SELECT ""month"",SUM(""driver_cnt"") AS ""driver_cnt"" FROM (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(""driver_id"") AS ""driver_cnt"" FROM (SELECT CASE WHEN ""join_date""<'2020-01-01' THEN '2020-01-01' ELSE ""join_date"" END AS ""join_date"",""driver_id"" FROM ""Drivers"" WHERE ""join_date""<='2020-12-31') AS ""t0"" GROUP BY EXTRACT(MONTH FROM ""join_date"") UNION ALL SELECT ""month"",""driver_cnt"" FROM ""cte"") AS ""t1"" GROUP BY ""month"") AS ""t2""), ""cte2"" AS (SELECT ""ride_month"",COUNT(DISTINCT ""driver_id"") AS ""ride_driver_cnt"" FROM (SELECT ""driver_id"",EXTRACT(MONTH FROM ""requested_at"") AS ""ride_month"" FROM ""Rides"" AS ""r"" LEFT JOIN ""AcceptedRides"" AS ""a"" ON ""r"".""ride_id""=""a"".""ride_id"" AND EXTRACT(YEAR FROM ""requested_at"")='2020') AS ""t2"" GROUP BY ""ride_month"") SELECT ""driver_month"" AS ""month"",CASE ""driver_cnt"" WHEN 0 THEN 0 ELSE COALESCE(ROUND(100*(""ride_driver_cnt""/""driver_cnt""), 2), 0) END AS ""working_percentage"" FROM ""cte1"" LEFT JOIN ""cte2"" ON ""cte1"".""driver_month""=""cte2"".""ride_month"" ORDER BY ""cte1"".""driver_month"""
30,"WITH RECURSIVE ""t_seq"" (""month"") AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 AS ""month"" FROM ""t_seq"" WHERE ""month""<12), ""available_driver"" AS (SELECT EXTRACT(MONTH FROM ""j_d"") AS ""month"",COUNT(""driver_id"") AS ""available"" FROM (SELECT ""driver_id"",CASE WHEN ""join_date""<DATE('2020-01-01') THEN DATE('2020-01-01') ELSE ""join_date"" END AS ""j_d"" FROM ""drivers"" WHERE ""join_date""<DATE('2021-01-01')) AS ""s"" GROUP BY 1), ""accept"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""working_dris"" FROM ""rides"" AS ""r"" JOIN ""acceptedrides"" AS ""a"" ON ""r"".""ride_id""=""a"".""ride_id"" WHERE ""requested_at"">=DATE('2020-01-01') AND ""requested_at""<=DATE('2020-12-31') GROUP BY 1) SELECT ""month"",ROUND((CASE WHEN ""working_dris"" IS NULL THEN 0 ELSE ""working_dris""/""available_dris""*100 END), 2) AS ""working_percentage"" FROM (SELECT ""t_seq"".""month"",SUM(""available"") OVER (ORDER BY ""t_seq"".""month"") AS ""available_dris"",""working_dris"" FROM (""t_seq"" LEFT JOIN ""available_driver"" AS ""a"" ON ""t_seq"".""month""=""a"".""month"") LEFT JOIN ""accept"" ON ""accept"".""month""=""t_seq"".""month"") AS ""t"""
31,"WITH RECURSIVE ""all_months"" AS (SELECT 1 AS ""mon"" UNION SELECT ""mon""+1 AS ""mon"" FROM ""all_months"" WHERE ""mon""+1<=12), ""available_drivers_monthly"" AS (WITH ""prep"" AS (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""mon"",EXTRACT(YEAR FROM ""join_date"") AS ""year"",COUNT(DISTINCT ""driver_id"") AS ""cnt"" FROM ""Drivers"" GROUP BY EXTRACT(MONTH FROM ""join_date""),EXTRACT(YEAR FROM ""join_date"")) SELECT ""am"".""mon"",COALESCE(SUM(""p"".""cnt""), 0.0) AS ""cnt"" FROM ""all_months"" AS ""am"" LEFT JOIN ""prep"" AS ""p"" ON (""p"".""year""<2020 OR (""p"".""year""=2020 AND ""p"".""mon""<=""am"".""mon"")) GROUP BY ""am"".""mon""), ""working_drivers_monthly"" AS (WITH ""prep"" AS (SELECT EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""mon"",COUNT(DISTINCT ""ar"".""driver_id"") AS ""cnt"" FROM (""AcceptedRides"" AS ""ar"" JOIN ""Rides"" AS ""r"" ON (""ar"".""ride_id""=""r"".""ride_id"")) JOIN ""Drivers"" AS ""d"" ON (""ar"".""driver_id""=""d"".""driver_id"") WHERE ""r"".""requested_at"">='2020-01-01' AND ""r"".""requested_at""<='2020-12-31' GROUP BY EXTRACT(MONTH FROM ""r"".""requested_at"")) SELECT ""am"".""mon"",COALESCE(""p"".""cnt"", 0.00) AS ""cnt"" FROM ""all_months"" AS ""am"" LEFT JOIN ""prep"" AS ""p"" ON (""am"".""mon""=""p"".""mon"")) SELECT ""adm"".""mon"" AS ""month"",COALESCE(ROUND(""wdm"".""cnt""*100.0/""adm"".""cnt"", 2), 0.00000) AS ""working_percentage"" FROM ""available_drivers_monthly"" AS ""adm"" JOIN ""working_drivers_monthly"" AS ""wdm"" ON (""adm"".""mon""=""wdm"".""mon"")"
32,"WITH RECURSIVE ""cte"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""cte"" WHERE ""month""<12) SELECT ""A"".""month"",ROUND(COALESCE(COALESCE(""B"".""num_count"", 0)*100/""A"".""count"", 0), 2) AS ""working_percentage"" FROM (SELECT ""c"".""month"",COUNT(""driver_id"") AS ""count"" FROM ""cte"" AS ""c"" LEFT JOIN ""drivers"" AS ""d"" ON 2020*100+""c"".""month"">=EXTRACT(YEAR FROM ""d"".""join_date"")*100+EXTRACT(MONTH FROM ""d"".""join_date"") GROUP BY ""c"".""month"") AS ""A"" LEFT JOIN (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""num_count"" FROM ""rides"" AS ""r"" LEFT JOIN ""acceptedRides"" AS ""a"" ON ""r"".""ride_id""=""a"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 AND ""a"".""driver_id"" IS NOT NULL GROUP BY EXTRACT(MONTH FROM ""requested_at"")) AS ""B"" ON ""A"".""month""=""B"".""month"""
33,"WITH ""months"" AS (SELECT EXTRACT(YEAR FROM ""join_date"") AS ""year"",EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(1) AS ""joined_that_month"" FROM ""Drivers"" GROUP BY EXTRACT(YEAR FROM ""join_date""),EXTRACT(MONTH FROM ""join_date"")), ""ride_months"" AS (SELECT 1 AS ""ride_month"" UNION ALL SELECT 2 UNION ALL SELECT 3 UNION ALL SELECT 4 UNION ALL SELECT 5 UNION ALL SELECT 6 UNION ALL SELECT 7 UNION ALL SELECT 8 UNION ALL SELECT 9 UNION ALL SELECT 10 UNION ALL SELECT 11 UNION ALL SELECT 12), ""active_drivers"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""active_count"" FROM ""AcceptedRides"" AS ""ar"" JOIN ""Rides"" AS ""r"" USING (""ride_id"") WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY EXTRACT(MONTH FROM ""requested_at"")) SELECT ""ride_months"".""ride_month"" AS ""month"",COALESCE(ROUND(100*(""active_drivers"".""active_count"")/SUM(""months"".""joined_that_month""), 2), 0) AS ""working_percentage"" FROM (""ride_months"" LEFT JOIN ""months"" ON (""ride_months"".""ride_month"">=""months"".""month"" AND ""months"".""year""=2020) OR ""months"".""year""<2020) LEFT JOIN ""active_drivers"" ON ""ride_months"".""ride_month""=""active_drivers"".""month"" GROUP BY ""ride_months"".""ride_month"""
34,"WITH RECURSIVE ""CTE1"" AS (SELECT 1 AS ""month"" UNION ALL SELECT 1+""month"" FROM ""CTE1"" WHERE 1+""month""<=12), ""CTE2"" AS (SELECT ""driver_id"",CASE WHEN EXTRACT(YEAR FROM ""join_date"")<2020 THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""month"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020), ""CTE3"" AS (SELECT ""CTE1"".""month"",COUNT(""CTE2"".""driver_id"") OVER (ORDER BY ""CTE1"".""month"") AS ""active_drivers"" FROM ""CTE1"" LEFT JOIN ""CTE2"" ON ""CTE1"".""month""=""CTE2"".""month""), ""CTE4"" AS (SELECT EXTRACT(MONTH FROM ""R"".""requested_at"") AS ""month"",""A"".""driver_id"" FROM (""Rides"" AS ""R"") JOIN ""AcceptedRIdes"" AS ""A"" WHERE ""R"".""ride_id""=""A"".""ride_id"" AND EXTRACT(YEAR FROM ""R"".""requested_at"")=2020), ""CTE5"" AS (SELECT ""CTE1"".""month"",COUNT(DISTINCT ""CTE4"".""driver_id"") AS ""accepted_rides"" FROM ""CTE1"" LEFT JOIN ""CTE4"" ON ""CTE1"".""month""=""CTE4"".""month"" GROUP BY ""CTE1"".""month"") SELECT DISTINCT ""CTE3"".""month"",ROUND(COALESCE(100*""CTE5"".""accepted_rides""/""CTE3"".""active_drivers"", 0), 2) AS ""working_percentage"" FROM (""CTE5"") JOIN ""CTE3"" WHERE ""CTE5"".""month""=""CTE3"".""month"""
35,"WITH RECURSIVE ""all_month"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""all_month"" WHERE ""month""<12), ""available_drivers"" AS (SELECT ""am"".""month"",SUM(COALESCE(""drivers_avbl"", 0)) OVER (ORDER BY ""am"".""month"") AS ""avbl_drivers"" FROM ""all_month"" AS ""am"" LEFT JOIN (SELECT (CASE WHEN EXTRACT(YEAR FROM ""join_date"")<2020 THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END) AS ""join_month"",COUNT(""join_date"") AS ""drivers_avbl"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020 GROUP BY ""join_month"") AS ""md"" ON ""am"".""month""=""md"".""join_month""), ""monthly_active_drivers"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""active_drivers"" FROM ""AcceptedRides"" AS ""ar"" JOIN ""Rides"" AS ""r"" ON ""ar"".""ride_id""=""r"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY ""month"") SELECT ""ad"".""month"",ROUND(CASE WHEN ""avbl_drivers""=0 THEN 0 ELSE (COALESCE(""active_drivers"", 0)/""avbl_drivers"")*100 END, 2) AS ""working_percentage"" FROM ""available_drivers"" AS ""ad"" LEFT JOIN ""monthly_active_drivers"" AS ""mad"" ON ""ad"".""month""=""mad"".""month"""
36,"WITH RECURSIVE ""t0"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 AS ""month"" FROM ""t0"" WHERE ""month""<12), ""t1"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""a"".""driver_id"") AS ""cnt1"" FROM ""Rides"" AS ""r"" JOIN ""AcceptedRides"" AS ""a"" ON ""r"".""ride_id""=""a"".""ride_id"" WHERE ""requested_at"" BETWEEN DATE('2020-1-1') AND DATE('2020-12-31') GROUP BY EXTRACT(MONTH FROM ""requested_at"") HAVING COUNT(""r"".""ride_id"")>=1), ""t2"" AS (SELECT ""t0"".""month"",SUM(""n"") OVER (ORDER BY ""t0"".""month"")+(SELECT COUNT(1) FROM ""Drivers"" WHERE ""join_date""<DATE('2020-1-1')) AS ""cnt2"" FROM (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(1) AS ""n"" FROM ""Drivers"" WHERE ""join_date"" BETWEEN DATE('2020-1-1') AND DATE('2020-12-31') GROUP BY ""month"") AS ""a"" RIGHT JOIN ""t0"" ON ""a"".""month""=""t0"".""month"") SELECT ""t0"".""month"",ROUND(COALESCE(""cnt1""/""cnt2"", 0)*100, 2) AS ""working_percentage"" FROM (""t0"" LEFT JOIN ""t1"" ON ""t0"".""month""=""t1"".""month"") LEFT JOIN ""t2"" ON ""t0"".""month""=""t2"".""month"" ORDER BY ""t0"".""month"""
37,"WITH RECURSIVE ""rec"" AS (SELECT 1 AS ""month"" UNION SELECT ""month""+1 FROM ""rec"" WHERE ""month""<12), ""available"" AS (SELECT ""driver_id"",0 AS ""join_month"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<2020 UNION SELECT ""driver_id"",EXTRACT(MONTH FROM ""join_date"") AS ""join_month"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")=2020), ""active"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month_req"",COUNT(DISTINCT ""b"".""driver_id"") AS ""counts"" FROM ""Rides"" AS ""a"" JOIN ""AcceptedRides"" AS ""b"" ON ""a"".""ride_id""=""b"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY EXTRACT(MONTH FROM ""requested_at"")), ""temp"" AS (SELECT ""a"".""month"",COUNT(DISTINCT (""driver_id"")) AS ""available_d"",COALESCE(""c"".""counts"", 0) AS ""accepted"" FROM (""rec"" AS ""a"" LEFT JOIN ""available"" AS ""b"" ON ""a"".""month"">=""b"".""join_month"") LEFT JOIN ""active"" AS ""c"" ON ""a"".""month""=""c"".""month_req"" GROUP BY ""a"".""month"" ORDER BY ""a"".""month"") SELECT ""month"",COALESCE(ROUND(""accepted""/""available_d""*100, 2), 0) AS ""working_percentage"" FROM ""temp"" ORDER BY ""month"""
38,"WITH RECURSIVE ""T1"" AS (SELECT 1 AS ""join_month"" UNION SELECT ""join_month""+1 FROM ""T1"" WHERE ""join_month""<12), ""T2"" AS (SELECT CASE WHEN EXTRACT(YEAR FROM ""join_date"")<'2020' THEN '1' ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""join_month"",COUNT(""driver_id"") AS ""driver_num"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<='2020' GROUP BY ""join_month""), ""T3"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""join_month"",COUNT(DISTINCT ""ar"".""driver_id"") AS ""ride_num"" FROM ""AcceptedRides"" AS ""ar"" LEFT JOIN ""Rides"" AS ""r"" ON ""ar"".""ride_id""=""r"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")='2020' GROUP BY ""join_month"") SELECT ""T1"".""join_month"" AS ""month"",ROUND(100*COALESCE(""T3"".""ride_num""/SUM(""T2"".""driver_num""), 0), 2) AS ""working_percentage"" FROM (""T1"" LEFT JOIN ""T2"" ON ""T1"".""join_month"">=""T2"".""join_month"") LEFT JOIN ""T3"" ON ""T1"".""join_month""=""T3"".""join_month"" GROUP BY ""T1"".""join_month"" ORDER BY ""T1"".""join_month"""
39,"WITH RECURSIVE ""cte"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 AS ""month"" FROM ""cte"" WHERE ""month""<12), ""Driver_tmp"" AS (SELECT CAST(SUBSTR(""t2"".""join_month"", 6, 2) AS INTEGER) AS ""month"",SUM(""t1"".""driver_month"") AS ""driver_sum"" FROM (SELECT TO_CHAR(""join_date"", 'YYYY-%m') AS ""join_month"",COUNT(""driver_id"") AS ""driver_month"" FROM ""Drivers"" GROUP BY ""join_month"") AS ""t1"", (SELECT TO_CHAR(""join_date"", 'YYYY-%m') AS ""join_month"",COUNT(""driver_id"") AS ""driver_month"" FROM ""Drivers"" GROUP BY ""join_month"") AS ""t2"" WHERE ""t1"".""join_month""<=""t2"".""join_month"" AND ""t2"".""join_month"" BETWEEN '2020-01' AND '2020-12' GROUP BY ""t2"".""join_month""), ""rides_tmp"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""driver_count"" FROM ""AcceptedRides"" AS ""a"" LEFT JOIN ""Rides"" AS ""r"" ON ""a"".""ride_id""=""r"".""ride_id"" WHERE ""requested_at"" BETWEEN '2020-01-01' AND '2020-12-31' GROUP BY ""month"") SELECT ""l"".""month"",ROUND(100*COALESCE(COALESCE(""r"".""driver_count"", 0)/""l"".""driver_sum"", 0), 2) AS ""working_percentage"" FROM (SELECT ""cte"".""month"",COALESCE(MAX(""driver_sum""), 0) AS ""driver_sum"" FROM ""cte"" LEFT JOIN ""Driver_tmp"" ON ""cte"".""month"">=""driver_tmp"".""month"" GROUP BY ""cte"".""month"") AS ""l"" LEFT JOIN ""rides_tmp"" AS ""r"" ON ""l"".""month""=""r"".""month"" ORDER BY ""l"".""month"""
40,"WITH RECURSIVE ""cte"" AS (SELECT '2020-01-31' AS ""date"" UNION ALL SELECT LAST_DAY(""date"" + INTERVAL '1 MONTH') AS ""date"" FROM ""cte"" WHERE ""date""<'2020-12-31'), ""base"" AS (SELECT EXTRACT(MONTH FROM ""cte"".""date"") AS ""month"",COUNT(1) AS ""available_driver"" FROM ""cte"" LEFT JOIN ""Drivers"" ON ""cte"".""date"">=""Drivers"".""join_date"" GROUP BY 1 ORDER BY 1), ""base1"" AS (SELECT DISTINCT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""a"".""driver_id"") AS ""working_driver"" FROM ""AcceptedRides"" AS ""a"" JOIN ""Rides"" AS ""b"" ON ""a"".""ride_id""=""b"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY 1) SELECT DISTINCT ""base"".""month"",ROUND(COALESCE(""working_driver""/""available_driver""*100, 0), 2) AS ""working_percentage"" FROM ""base"" LEFT JOIN ""base1"" ON ""base"".""month""=""base1"".""month"" ORDER BY 1"
41,"WITH RECURSIVE ""m"" AS (SELECT 1 AS ""month"" UNION SELECT ""month""+1 FROM ""m"" WHERE ""month""<12), ""avil"" AS (SELECT ""month"",COALESCE(SUM(""num_d"") OVER (ORDER BY ""month""), 0) AS ""num_avl_drivers"" FROM ""m"" LEFT JOIN (SELECT EXTRACT(MONTH FROM CASE WHEN ""join_date""<'2020-01-01' THEN '2020-01-01' ELSE ""join_date"" END) AS ""join_month"",COUNT(""driver_id"") AS ""num_d"" FROM ""drivers"" WHERE ""join_date""<'2021-01-01' GROUP BY 1) AS ""t"" ON ""m"".""month""=""t"".""join_month""), ""working"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""working_month"",COUNT(DISTINCT ""driver_id"") AS ""working_drivers"" FROM ""rides"" JOIN ""AcceptedRides"" ON ""rides"".""ride_id""=""AcceptedRides"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")='2020' GROUP BY 1) SELECT ""month"",ROUND(COALESCE(""working_drivers""/""num_avl_drivers"", 0)*100, 2) AS ""working_percentage"" FROM ""avil"" LEFT JOIN ""working"" ON ""avil"".""month""=""working"".""working_month"""
42,"WITH RECURSIVE ""T1"" AS (SELECT 1 AS ""join_month"" UNION SELECT ""join_month""+1 FROM ""T1"" WHERE ""join_month""<12), ""T2"" AS (SELECT CASE WHEN EXTRACT(YEAR FROM ""join_date"")<'2020' THEN '1' ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""join_month"",COUNT(""driver_id"") AS ""driver_num"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<='2020' GROUP BY ""join_month""), ""T3"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""join_month"",COUNT(DISTINCT ""ar"".""driver_id"") AS ""ride_num"" FROM ""AcceptedRides"" AS ""ar"" LEFT JOIN ""Rides"" AS ""r"" ON ""ar"".""ride_id""=""r"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")='2020' GROUP BY ""join_month"") SELECT ""T1"".""join_month"" AS ""month"",ROUND(100*COALESCE(""T3"".""ride_num""/SUM(""T2"".""driver_num""), 0), 2) AS ""working_percentage"" FROM (""T1"" LEFT JOIN ""T2"" ON ""T1"".""join_month"">=""T2"".""join_month"") LEFT JOIN ""T3"" ON ""T1"".""join_month""=""T3"".""join_month"" GROUP BY ""T1"".""join_month"" ORDER BY ""T1"".""join_month"""
43,"WITH RECURSIVE ""tmp"" (""month"") AS (SELECT 0 UNION ALL SELECT ""month""+1 FROM ""tmp"" WHERE ""month""<12), ""tmp1"" AS (SELECT (CASE WHEN ""join_date""<'2020-01-01' THEN 0 WHEN ""join_date"">'2020-12-31' THEN 13 ELSE EXTRACT(MONTH FROM ""join_date"") END) AS ""month"",COUNT(""driver_id"") AS ""cnt"" FROM ""drivers"" GROUP BY ""month""), ""tmp2"" AS (SELECT ""a"".""month"",SUM(COALESCE(""cnt"", 0)) OVER (ORDER BY ""month"") AS ""total"" FROM ""tmp"" AS ""a"" LEFT JOIN ""tmp1"" AS ""b"" ON ""a"".""month""=""b"".""month""), ""tmp3"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""cnt"" FROM ""acceptedrides"" AS ""a"" JOIN ""rides"" AS ""b"" ON ""a"".""ride_id""=""b"".""ride_id"" WHERE ""requested_at"" BETWEEN '2020-01-01' AND '2020-12-31' GROUP BY ""month"") SELECT ""a"".""month"",COALESCE(ROUND(100*""cnt""/""total"", 2), 0) AS ""working_percentage"" FROM ((SELECT ""month"" FROM ""tmp"" WHERE ""month"" BETWEEN 1 AND 12) AS ""a"" LEFT JOIN ""tmp2"" AS ""b"" ON ""a"".""month""=""b"".""month"") LEFT JOIN ""tmp3"" AS ""c"" ON ""a"".""month""=""c"".""month"" ORDER BY ""month"""
44,"WITH RECURSIVE ""months"" AS (SELECT 1 AS ""num"" UNION ALL SELECT ""num""+1 AS ""num"" FROM ""months"" WHERE ""num""<12), ""workdrivers"" AS (SELECT DISTINCT EXTRACT(MONTH FROM ""a"".""requested_at"") AS ""work_month"",""b"".""driver_id"" FROM ""Rides"" AS ""a"" RIGHT JOIN ""AcceptedRides"" AS ""b"" USING (""ride_id"") WHERE EXTRACT(YEAR FROM ""a"".""requested_at"")=2020), ""availdrivers"" AS (SELECT ""x"".""num"" AS ""av_month"",SUM(""m"".""work_drivers"") OVER (ORDER BY ""x"".""num"") AS ""av_drivers"" FROM (SELECT CASE WHEN EXTRACT(YEAR FROM ""join_date"")<2020 THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""av_month"",COUNT(DISTINCT ""driver_id"") AS ""work_drivers"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020 GROUP BY 1) AS ""m"" RIGHT JOIN ""months"" AS ""x"" ON ""x"".""num""=""m"".""av_month"" GROUP BY 1) SELECT ""x"".""num"" AS ""month"",ROUND(COALESCE(COALESCE(""y"".""work_drivers"", 0)/COALESCE(""z"".""av_drivers"", 0)*100, 0), 2) AS ""working_percentage"" FROM (""months"" AS ""x"" LEFT JOIN (SELECT ""work_month"",COUNT(""driver_id"") AS ""work_drivers"" FROM ""workdrivers"" GROUP BY 1) AS ""y"" ON ""x"".""num""=""y"".""work_month"") LEFT JOIN ""availdrivers"" AS ""z"" ON ""x"".""num""=""z"".""av_month"" ORDER BY 1"
45,"WITH RECURSIVE ""seq"" AS (SELECT 0 AS ""cnt"",1 AS ""value"" UNION ALL SELECT 0 AS ""cnt"",""value""+1 FROM ""seq"" WHERE ""value""<12), ""rides_2020"" AS (SELECT ""ride_id"",EXTRACT(MONTH FROM ""requested_at"") AS ""month"" FROM ""rides"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020), ""dam"" AS (SELECT COUNT(DISTINCT ""b"".""driver_id"") AS ""cnt"",""a"".""month"" FROM ""rides_2020"" AS ""a"" JOIN ""acceptedrides"" AS ""b"" ON ""a"".""ride_id""=""b"".""ride_id"" GROUP BY 2), ""damn"" AS (SELECT ""a"".""cnt""+COALESCE(""b"".""cnt"", 0) AS ""cnt"",""a"".""value"" AS ""month"" FROM ""seq"" AS ""a"" LEFT JOIN ""dam"" AS ""b"" ON ""a"".""value""=""b"".""month""), ""avp"" AS (SELECT COUNT(""driver_id"") AS ""d_cnt"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<2020), ""avc"" AS (SELECT COUNT(""driver_id"") AS ""ad_cnt"",EXTRACT(MONTH FROM ""join_date"") AS ""month"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")=2020 GROUP BY 2), ""avs"" AS (SELECT ""a"".""cnt""+COALESCE(""b"".""ad_cnt"", 0) AS ""cnt"",""a"".""value"" AS ""month"" FROM ""seq"" AS ""a"" LEFT JOIN ""avc"" AS ""b"" ON ""a"".""value""=""b"".""month""), ""avl"" AS (SELECT SUM(""cnt"") OVER (ORDER BY ""month"")+""avp"".""d_cnt"" AS ""cnt"",""month"" FROM (""avs"") JOIN ""avp""), ""final"" AS (SELECT ""avl"".""month"" AS ""month"",""damn"".""cnt"" AS ""d_cnt"",""avl"".""cnt"" AS ""a_cnt"" FROM ""avl"" JOIN ""damn"" ON ""damn"".""month""=""avl"".""month"") SELECT ""month"",ROUND(COALESCE(""d_cnt""*100/""a_cnt"", 0), 2) AS ""working_percentage"" FROM ""final"""
46,"WITH ""dates"" AS (SELECT 1 AS ""MONTH"" UNION SELECT 2 AS ""MONTH"" UNION SELECT 3 AS ""MONTH"" UNION SELECT 4 AS ""MONTH"" UNION SELECT 5 AS ""MONTH"" UNION SELECT 6 AS ""MONTH"" UNION SELECT 7 AS ""MONTH"" UNION SELECT 8 AS ""MONTH"" UNION SELECT 9 AS ""MONTH"" UNION SELECT 10 AS ""MONTH"" UNION SELECT 11 AS ""MONTH"" UNION SELECT 12 AS ""MONTH""), ""join_year_dates"" AS (SELECT DISTINCT (""drivers_inner"".""year"") AS ""year"",COALESCE(""dates"".""month"", ""drivers_inner"".""month"") AS ""month"" FROM (SELECT EXTRACT(YEAR FROM ""join_date"") AS ""year"",EXTRACT(MONTH FROM ""join_date"") AS ""month"" FROM ""drivers"") AS ""drivers_inner"" JOIN ""dates"" ON 1=1), ""driver_cnt"" AS (SELECT ""join_year_dates"".""year"" AS ""year"",""join_year_dates"".""month"" AS ""month"",COALESCE(""driver_cnt_inner"".""joined_drivers_per_month"", 0.0) AS ""joined_drivers"" FROM ""join_year_dates"" LEFT JOIN (SELECT EXTRACT(YEAR FROM ""drivers"".""join_date"") AS ""year"",EXTRACT(MONTH FROM ""drivers"".""join_date"") AS ""month"",COUNT(1) AS ""joined_drivers_per_month"" FROM ""drivers"" GROUP BY ""year"",""month"") AS ""driver_cnt_inner"" ON ""join_year_dates"".""year""=""driver_cnt_inner"".""year"" AND ""join_year_dates"".""month""=""driver_cnt_inner"".""month"") SELECT ""total_accepted_rides"".""month"" AS ""month"",ROUND(CASE WHEN ""active_drivers_per_month"".""current_active_drivers""=0 THEN 0.00 ELSE COALESCE((""total_accepted_rides"".""driver_count""*100.0)/""active_drivers_per_month"".""current_active_drivers"", 0.0) END, 2) AS ""working_percentage"" FROM (SELECT ""dates"".""month"",COUNT(""x"".""driver_id"") AS ""driver_count"" FROM ""dates"" LEFT JOIN (SELECT DISTINCT EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""month"",""driver_id"" FROM (SELECT * FROM ""rides"" WHERE EXTRACT(YEAR FROM ""requested_at"")>=2020 AND EXTRACT(YEAR FROM ""requested_at"")<2021) AS ""r"" JOIN ""AcceptedRides"" AS ""ar"" ON ""r"".""ride_id""=""ar"".""ride_id"") AS ""x"" ON ""x"".""month""=""dates"".""month"" GROUP BY ""month"") AS ""total_accepted_rides"" JOIN (SELECT ""dates"".""month"" AS ""month"",COALESCE(""current_active_drivers"", 0.0) AS ""current_active_drivers"" FROM ""dates"" LEFT JOIN (SELECT * FROM (SELECT ""x1"".""year"" AS ""year"",""x1"".""month"" AS ""month"",""x1"".""joined_drivers"" AS ""joined_drivers"",SUM(""x1"".""joined_drivers"") OVER (ORDER BY ""x1"".""year"",""x1"".""month"") AS ""current_active_drivers"" FROM (SELECT * FROM ""driver_cnt"" WHERE ""year""<2021 ORDER BY ""year"",""month"") AS ""x1"") AS ""x"" WHERE ""year"">=2020) AS ""driver_cnt"" ON ""driver_cnt"".""month""=""dates"".""month"") AS ""active_drivers_per_month"" ON ""active_drivers_per_month"".""month""=""total_accepted_rides"".""month"" ORDER BY ""month"""
47,"WITH RECURSIVE ""CTE1"" AS (SELECT 1 AS ""month"" UNION ALL SELECT 1+""month"" FROM ""CTE1"" WHERE 1+""month""<=12), ""CTE2"" AS (SELECT ""driver_id"",CASE WHEN EXTRACT(YEAR FROM ""join_date"")<2020 THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""month"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020), ""CTE3"" AS (SELECT ""CTE1"".""month"",COUNT(""CTE2"".""driver_id"") OVER (ORDER BY ""CTE1"".""month"") AS ""active_drivers"" FROM ""CTE1"" LEFT JOIN ""CTE2"" ON ""CTE1"".""month""=""CTE2"".""month""), ""CTE4"" AS (SELECT EXTRACT(MONTH FROM ""R"".""requested_at"") AS ""month"",""A"".""driver_id"" FROM (""Rides"" AS ""R"") JOIN ""AcceptedRIdes"" AS ""A"" WHERE ""R"".""ride_id""=""A"".""ride_id"" AND EXTRACT(YEAR FROM ""R"".""requested_at"")=2020), ""CTE5"" AS (SELECT ""CTE1"".""month"",COUNT(DISTINCT ""CTE4"".""driver_id"") AS ""accepted_rides"" FROM ""CTE1"" LEFT JOIN ""CTE4"" ON ""CTE1"".""month""=""CTE4"".""month"" GROUP BY ""CTE1"".""month"") SELECT DISTINCT ""CTE3"".""month"",ROUND(COALESCE(100*""CTE5"".""accepted_rides""/""CTE3"".""active_drivers"", 0), 2) AS ""working_percentage"" FROM (""CTE5"") JOIN ""CTE3"" WHERE ""CTE5"".""month""=""CTE3"".""month"""
48,"WITH RECURSIVE ""cte"" AS (SELECT 1 AS ""month"" UNION ALL SELECT 1+""month"" FROM ""cte"" WHERE ""month""<12), ""b"" AS (SELECT COUNT(1) AS ""ct"" FROM ""Drivers"" WHERE ""join_date""<'2020-01-01'), ""c"" AS (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(1) AS ""ct"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")=2020 GROUP BY EXTRACT(MONTH FROM ""join_date"")), ""d"" AS (SELECT ""cte"".""month"",COALESCE(""ct"", 0) AS ""ct"" FROM ""cte"" LEFT JOIN ""c"" ON ""cte"".""month""=""c"".""month""), ""available"" AS (SELECT ""month"",(SELECT * FROM ""b"")+SUM(""ct"") OVER (ORDER BY ""month"") AS ""available"" FROM ""d""), ""e"" AS (SELECT ""AcceptedRides"".""driver_id"",""Rides"".""requested_at"" FROM ""AcceptedRides"" JOIN ""Rides"" ON ""AcceptedRides"".""ride_id""=""Rides"".""ride_id""), ""f"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""accept"" FROM ""e"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY EXTRACT(MONTH FROM ""requested_at"")), ""final"" AS (SELECT ""available"".""month"",""available"".""available"",COALESCE(""f"".""accept"", 0) AS ""accept"" FROM ""available"" LEFT JOIN ""f"" ON ""available"".""month""=""f"".""month"") SELECT ""month"",ROUND(COALESCE(""accept""/""available"", 0)*100, 2) AS ""working_percentage"" FROM ""final"" ORDER BY ""month"""
49,"WITH RECURSIVE ""months"" AS (SELECT '2020-01-01' AS ""month"" UNION ALL SELECT ""month"" + INTERVAL '1 MONTH' FROM ""months"" WHERE ""month"" + INTERVAL '1 MONTH'<'2021-01-01'), ""total_drivers"" AS (SELECT ""month"",COALESCE(COUNT(1), 0) AS ""total_available_drivers"" FROM ""months"" LEFT JOIN ""drivers"" ON LAST_DAY(""months"".""month"")>=""drivers"".""join_date"" GROUP BY ""month""), ""working_drivers"" AS (SELECT LAST_DAY(""requested_at"") + INTERVAL '1 DAY' - INTERVAL '1 MONTH' AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""working_drivers"" FROM ""acceptedrides"" AS ""a"" JOIN ""rides"" ON ""a"".""ride_id""=""rides"".""ride_id"" GROUP BY ""month"") SELECT EXTRACT(MONTH FROM ""total_drivers"".""month"") AS ""month"",ROUND(COALESCE(""working_drivers""/""total_available_drivers""*100.0, 0), 2) AS ""working_percentage"" FROM ""total_drivers"" LEFT JOIN ""working_drivers"" ON ""total_drivers"".""month""=""working_drivers"".""month"" WHERE EXTRACT(YEAR FROM ""total_drivers"".""month"")=2020 ORDER BY ""month"""
50,"WITH RECURSIVE ""calendar_months"" AS (SELECT 1 AS ""month"" UNION SELECT ""month""+1 FROM ""calendar_months"" WHERE ""month""<12) SELECT ""monthly_available_driver"".""month"",ROUND(COALESCE(""drivers_accepted_ride""/SUM(""available_drivers"") OVER (ORDER BY ""monthly_available_driver"".""month""), 0)*100, 2) AS ""working_percentage"" FROM (SELECT ""CM"".""month"",COALESCE(""D1"".""available_drivers"", 0) AS ""available_drivers"" FROM ""calendar_months"" AS ""CM"" LEFT JOIN (SELECT ""month"",CASE WHEN ""month""=1 THEN ""available_drivers""+(SELECT COUNT(DISTINCT ""driver_id"") FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<2020) ELSE ""available_drivers"" END AS ""available_drivers"" FROM (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(""driver_id"") AS ""available_drivers"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")=2020 GROUP BY ""month"") AS ""only_2020"") AS ""D1"" ON ""CM"".""month""=""D1"".""month"") AS ""monthly_available_driver"" LEFT JOIN (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""drivers_accepted_ride"" FROM ""Rides"" AS ""r"" LEFT JOIN ""AcceptedRides"" AS ""ar"" ON ""r"".""ride_id""=""ar"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY ""month"") AS ""monthly_accepted_rides"" ON ""monthly_available_driver"".""month""=""monthly_accepted_rides"".""month"""
51,"WITH RECURSIVE ""t1"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""m"",COUNT(DISTINCT ""driver_id"") AS ""c"" FROM ""rides"" AS ""a"" JOIN ""acceptedrides"" AS ""b"" ON ""a"".""ride_id""=""b"".""ride_id"" WHERE ""requested_at"" BETWEEN '2020-01-01' AND '2020-12-31' GROUP BY EXTRACT(MONTH FROM ""requested_at"")), ""t2"" AS (SELECT 1 AS ""m"" UNION ALL SELECT ""m""+1 AS ""m"" FROM ""t2"" WHERE ""m""<12), ""t3"" AS (SELECT ""m"",SUM(CASE WHEN (EXTRACT(YEAR FROM ""join_date"")<=2019) OR (EXTRACT(YEAR FROM ""join_date"")=2020 AND EXTRACT(MONTH FROM ""join_date"")<=""m"") THEN 1 ELSE 0 END) AS ""available_drivers"" FROM ""t2"" AS ""a"" JOIN ""drivers"" AS ""b"" GROUP BY ""a"".""m""), ""t4"" AS (SELECT ""t2"".""m"",COALESCE(""t1"".""c"", 0) AS ""c"" FROM ""t2"" LEFT JOIN ""t1"" ON ""t2"".""m""=""t1"".""m"") SELECT ""t3"".""m"" AS ""month"",CASE WHEN ""t3"".""available_drivers""=0 THEN 0 ELSE ROUND(""t4"".""c""*100/""t3"".""available_drivers"", 2) END AS ""working_percentage"" FROM ""t3"" JOIN ""t4"" ON ""t3"".""m""=""t4"".""m"""
52,"WITH RECURSIVE ""mon"" AS (SELECT 1 AS ""m"" UNION ALL SELECT ""m""+1 FROM ""mon"" WHERE ""m""<12), ""available_new_driver"" AS (SELECT CASE WHEN ""join_date""<'2020-1-1' THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""mon"",COUNT(1) AS ""nd"" FROM ""Drivers"" WHERE ""join_date""<'2021-1-1' GROUP BY 1), ""accepted_ride"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""mon"",COUNT(DISTINCT ""driver_id"") AS ""driver"" FROM ""Rides"" AS ""r"" JOIN ""AcceptedRides"" AS ""ar"" ON ""r"".""ride_id""=""ar"".""ride_id"" WHERE ""requested_at"" BETWEEN '2020-1-1' AND '2020-12-31' GROUP BY 1) SELECT ""mon"".""m"" AS ""month"",ROUND(100*COALESCE(""driver""/(SUM(""nd"") OVER (ORDER BY ""m"")), 0), 2) AS ""working_percentage"" FROM (""mon"" LEFT JOIN ""accepted_ride"" AS ""ar"" ON ""mon"".""m""=""ar"".""mon"") LEFT JOIN ""available_new_driver"" AS ""ad"" ON ""mon"".""m""=""ad"".""mon"""
53,"WITH RECURSIVE ""t"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""t"" WHERE ""month""<12), ""t2"" AS (SELECT *,CASE WHEN EXTRACT(YEAR FROM ""join_date"")<2020 THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""month"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020), ""t3"" AS (SELECT ""r"".*,EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""month"",""a"".""driver_id"" FROM ""rides"" AS ""r"" JOIN ""acceptedrides"" AS ""a"" ON ""r"".""ride_id""=""a"".""ride_id"" WHERE EXTRACT(YEAR FROM ""r"".""requested_at"")=2020), ""t4"" AS (SELECT ""month"",COUNT(DISTINCT ""driver_id"") AS ""work_cnt"" FROM ""t3"" GROUP BY ""month""), ""t5"" AS (SELECT ""t"".""month"",SUM(COALESCE(COUNT(DISTINCT ""t2"".""driver_id""), 0)) OVER (ORDER BY ""month"") AS ""cnt"" FROM ""t"" LEFT JOIN ""t2"" ON ""t"".""month""=""t2"".""month"" GROUP BY ""month"") SELECT ""t"".""month"",COALESCE(ROUND((COALESCE(""t4"".""work_cnt"", 0))*100/(""t5"".""cnt""), 2), 0.00) AS ""working_percentage"" FROM (""t"" LEFT JOIN ""t4"" ON ""t"".""month""=""t4"".""month"") LEFT JOIN ""t5"" ON ""t"".""month""=""t5"".""month"""
54,"WITH RECURSIVE ""CTE1"" AS (SELECT 1 AS ""month"" UNION SELECT ""month""+1 AS ""month"" FROM ""CTE1"" WHERE ""month""<12), ""CTE2"" AS (SELECT ""driver_id"",CASE WHEN EXTRACT(YEAR FROM ""join_date"")<2020 THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""month"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020), ""CTE3"" AS (SELECT ""CTE1"".""month"",COALESCE(COUNT(""driver_id"") OVER (ORDER BY ""CTE1"".""month""), 0) AS ""active_driver"" FROM ""CTE1"" LEFT JOIN ""CTE2"" ON ""CTE1"".""month""=""CTE2"".""month"") SELECT ""c"".""month"",ROUND(100*COALESCE(COUNT(DISTINCT ""driver_id"")/""active_driver"", 0), 2) AS ""working_percentage"" FROM (""CTE3"" AS ""c"" LEFT JOIN ""Rides"" AS ""r"" ON ""c"".""month""=EXTRACT(MONTH FROM ""r"".""requested_at"") AND EXTRACT(YEAR FROM ""r"".""requested_at"")=2020) LEFT JOIN ""AcceptedRides"" AS ""a"" ON ""r"".""ride_id""=""a"".""ride_id"" GROUP BY ""c"".""month"""
55,"WITH RECURSIVE ""months"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""months"" WHERE ""month""<12), ""available_drivers"" AS (SELECT ""months"".""month"",COALESCE(MAX(""t1"".""active_driver"") OVER (ORDER BY ""month""), 0) AS ""active_driver"" FROM ""months"" LEFT JOIN (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(""driver_id"") OVER (ORDER BY ""join_date"") AS ""active_driver"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020) AS ""t1"" ON ""t1"".""month""=""months"".""month""), ""working_drivers"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""working_driver"" FROM ""Rides"" AS ""R"" JOIN ""AcceptedRides"" AS ""A"" ON ""R"".""ride_id""=""A"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY 1) SELECT ""months"".""month"",COALESCE(ROUND(""working_driver""/""active_driver""*100, 2), 0) AS ""working_percentage"" FROM (""months"" LEFT JOIN ""available_drivers"" ON ""available_drivers"".""month""=""months"".""month"") LEFT JOIN ""working_drivers"" ON ""working_drivers"".""month""=""months"".""month"" GROUP BY 1"
56,"WITH RECURSIVE ""monthCount"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 AS ""month"" FROM ""monthCount"" WHERE ""month""<12), ""driver_month"" AS (SELECT ""ride_month"",COUNT(DISTINCT ""driver_id"") AS ""active_drivers"" FROM (SELECT ""driver_id"",EXTRACT(MONTH FROM ""requested_at"") AS ""ride_month"" FROM ""Rides"" AS ""r"" LEFT JOIN ""AcceptedRides"" AS ""a"" ON ""r"".""ride_id""=""a"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")='2020') AS ""t2"" GROUP BY ""ride_month""), ""available_drivers"" AS (SELECT ""month"",COUNT(DISTINCT ""d"".""driver_id"") AS ""available_drivers"" FROM ""monthcount"" AS ""m"" LEFT JOIN ""drivers"" AS ""d"" ON (""m"".""month"">=EXTRACT(MONTH FROM ""d"".""join_date"") AND EXTRACT(YEAR FROM ""d"".""join_date"")=2020) OR EXTRACT(YEAR FROM ""d"".""join_date"")<2020 GROUP BY ""month""), ""active_drivers"" AS (SELECT EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""active_drivers"" FROM ""rides"" AS ""r"" JOIN ""AcceptedRides"" AS ""a"" ON ""r"".""ride_id""=""a"".""ride_id"" WHERE EXTRACT(YEAR FROM ""r"".""requested_at"")=2020) SELECT ""m"".""month"",CASE WHEN ""available_drivers"".""available_drivers""=0 THEN 0 ELSE COALESCE(ROUND((""driver_month"".""active_drivers""/""available_drivers"".""available_drivers"")*100, 2), 0) END AS ""working_percentage"" FROM (""monthCount"" AS ""m"" LEFT JOIN ""driver_month"" ON ""m"".""month""=""driver_month"".""ride_month"") LEFT JOIN ""available_drivers"" ON ""m"".""month""=""available_drivers"".""month"" ORDER BY 1"
57,"WITH ""cte1"" AS (SELECT DISTINCT EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""requested_month"",""d"".""driver_id"" FROM (""AcceptedRides"" AS ""a"" JOIN ""Rides"" AS ""r"" ON ""a"".""ride_id""=""r"".""ride_id"") JOIN ""Drivers"" AS ""d"" ON ""d"".""driver_id""=""a"".""driver_id"" WHERE EXTRACT(YEAR FROM ""join_date"")<='2020' AND EXTRACT(YEAR FROM ""requested_at"")>'2019' AND EXTRACT(YEAR FROM ""requested_at"")<'2021' ORDER BY 1), ""cte_recur"" AS (WITH RECURSIVE ""tmp"" AS (SELECT 1 AS ""id"" UNION ALL SELECT ""id""+1 AS ""id"" FROM ""tmp"" WHERE ""id""<12) SELECT * FROM ""tmp""), ""cte2"" AS (SELECT ""month"",COUNT(1) AS ""driver_cnt"" FROM (SELECT EXTRACT(MONTH FROM ""new_joindate"") AS ""month"",""driver_id"" FROM (SELECT ""driver_id"",CASE WHEN EXTRACT(YEAR FROM ""join_date"")<'2020' THEN '2020-1-1' ELSE ""join_date"" END AS ""new_joindate"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<='2020') AS ""t"") AS ""t2"" GROUP BY ""month""), ""active_driver_month"" AS (SELECT ""month"",SUM(""driver_cnt"") OVER (ORDER BY ""month"") AS ""active_driver"" FROM (SELECT ""id"" AS ""month"",COALESCE(""driver_cnt"", 0) AS ""driver_cnt"" FROM ""cte2"" RIGHT JOIN ""cte_recur"" ON ""cte2"".""month""=""cte_recur"".""id"") AS ""t""), ""accept_driver_month"" AS (SELECT ""cte_recur"".""id"" AS ""month"",COALESCE(""driver_accept_cnt"", 0) AS ""driver_accept_cnt"" FROM (SELECT ""requested_month"",COUNT(""driver_id"") AS ""driver_accept_cnt"" FROM ""cte1"" GROUP BY ""requested_month"") AS ""r1"" RIGHT JOIN ""cte_recur"" ON ""r1"".""requested_month""=""cte_recur"".""id"") SELECT ""acc"".""month"",ROUND(COALESCE(""driver_accept_cnt""/""active_driver""*100, 0), 2) AS ""working_percentage"" FROM ""accept_driver_month"" AS ""acc"" JOIN ""active_driver_month"" AS ""act"" ON ""acc"".""month""=""act"".""month"" ORDER BY 1"
58,"WITH RECURSIVE ""t"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 AS ""month"" FROM ""t"" WHERE ""month""<12), ""t1"" AS (SELECT ""driver_id"",CASE WHEN EXTRACT(YEAR FROM ""join_date"")<2020 THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""month"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020), ""t2"" AS (SELECT ""t"".""month"",SUM(COALESCE(COUNT(""driver_id""), 0)) OVER (ORDER BY ""t"".""month"") AS ""available_drivers"" FROM ""t"" LEFT JOIN ""t1"" USING (""month"") GROUP BY ""month""), ""t3"" AS (SELECT COUNT(DISTINCT ""a"".""driver_id"") AS ""ride_drivers"",EXTRACT(MONTH FROM ""requested_at"") AS ""month"" FROM ""AcceptedRides"" AS ""a"" JOIN ""Rides"" AS ""r"" USING (""ride_id"") WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY EXTRACT(MONTH FROM ""requested_at"")) SELECT ""t"".""month"",ROUND(COALESCE(CASE WHEN ""available_drivers""=0 THEN 0 ELSE (""ride_drivers""/""available_drivers"")*100 END, 0), 2) AS ""working_percentage"" FROM (""t"" LEFT JOIN ""t2"" USING (""month"")) LEFT JOIN ""t3"" USING (""month"")"
59,"WITH RECURSIVE ""CTE"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""CTE"" WHERE ""month""<12), ""B"" AS (SELECT EXTRACT(YEAR FROM ""join_date"") AS ""yr"",EXTRACT(MONTH FROM ""join_date"") AS ""mth"",COUNT(1) AS ""ct"" FROM ""Drivers"" WHERE ""join_date""<='2020-12-31' GROUP BY EXTRACT(YEAR FROM ""join_date""),EXTRACT(MONTH FROM ""join_date"")), ""C"" AS (SELECT (CASE WHEN ""yr""<2020 THEN 1 ELSE ""mth"" END) AS ""mth"",""ct"" FROM ""B""), ""D"" AS (SELECT ""mth"",SUM(""ct"") AS ""ct"" FROM ""C"" GROUP BY ""mth""), ""E"" AS (SELECT ""CTE"".""month"",COALESCE(""ct"", 0) AS ""ct"" FROM ""CTE"" LEFT JOIN ""D"" ON ""CTE"".""month""=""D"".""mth""), ""TOTALD"" AS (SELECT ""month"",SUM(""ct"") OVER (ORDER BY ""MONTH"") AS ""available"" FROM ""E""), ""F"" AS (SELECT ""Rides"".""requested_at"",""AcceptedRides"".""driver_id"" FROM ""Rides"" JOIN ""AcceptedRides"" ON ""Rides"".""ride_id""=""AcceptedRides"".""ride_id""), ""G"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""ct"" FROM ""F"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY EXTRACT(MONTH FROM ""requested_at"")) SELECT ""TOTALD"".""month"",ROUND(COALESCE(""G"".""ct""/""available"", 0)*100, 2) AS ""working_percentage"" FROM ""TOTALD"" LEFT JOIN ""G"" ON ""TOTALD"".""month""=""G"".""month"" ORDER BY ""month"""
60,"WITH ""cte"" AS (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(""driver_id"") OVER (ORDER BY ""join_date"") AS ""rnk"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020), ""cte2"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""cnt"" FROM ""Rides"" AS ""x"" JOIN ""AcceptedRides"" AS ""y"" ON ""x"".""ride_id""=""y"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY 1), ""cte3"" AS (WITH RECURSIVE ""cte"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 AS ""month"" FROM ""cte"" WHERE ""month""<=11) SELECT * FROM ""cte"") SELECT ""month"",ROUND(COALESCE(""activ""*100/""num_drivers"", 0), 2) AS ""working_percentage"" FROM (SELECT ""x"".""month"",MAX(COALESCE(""y"".""rnk"", 0)) AS ""num_drivers"",MAX(COALESCE(""z"".""cnt"", 0)) AS ""activ"" FROM (""cte3"" AS ""x"" LEFT JOIN ""cte"" AS ""y"" ON ""x"".""month"">=""y"".""month"") LEFT JOIN ""cte2"" AS ""z"" ON ""x"".""month""=""z"".""month"" GROUP BY 1) AS ""a"""
61,"WITH RECURSIVE ""month_list"" (""month"") AS (SELECT 1 UNION SELECT ""month""+1 FROM ""month_list"" WHERE ""month""<12), ""accept_rides"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",""driver_id"",COUNT(""ride_distance"") AS ""accepted_rides"" FROM ""Rides"" LEFT JOIN ""AcceptedRides"" USING (""ride_id"") WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY ""month"",""driver_id"") SELECT ""month_list"".""month"" AS ""month"",COALESCE(ROUND((COUNT(DISTINCT ""accept_rides"".""driver_id"")*100/COUNT(""Drivers"".""driver_id"")), 2), 0) AS ""working_percentage"" FROM (""month_list"" LEFT JOIN ""Drivers"" ON (EXTRACT(YEAR FROM ""join_date"")=2020 AND EXTRACT(MONTH FROM ""join_date"")<=""month_list"".""month"") OR (EXTRACT(YEAR FROM ""join_date"")<2020)) LEFT JOIN ""accept_rides"" ON ""month_list"".""month""=""accept_rides"".""month"" AND ""Drivers"".""driver_id""=""accept_rides"".""driver_id"" GROUP BY ""month_list"".""month"" ORDER BY ""month_list"".""month"""
62,"WITH ""months_table"" AS (SELECT 1 AS ""fy_month"" UNION SELECT 2 AS ""fy_month"" UNION SELECT 3 AS ""fy_month"" UNION SELECT 4 AS ""fy_month"" UNION SELECT 5 AS ""fy_month"" UNION SELECT 6 AS ""fy_month"" UNION SELECT 7 AS ""fy_month"" UNION SELECT 8 AS ""fy_month"" UNION SELECT 9 AS ""fy_month"" UNION SELECT 10 AS ""fy_month"" UNION SELECT 11 AS ""fy_month"" UNION SELECT 12 AS ""fy_month""), ""accepted_drivers"" AS (SELECT EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""fy_month"",COUNT(DISTINCT ""ar"".""driver_id"") AS ""no_accepted_drivers"" FROM ""AcceptedRides"" AS ""AR"" JOIN ""Rides"" AS ""r"" ON ""ar"".""ride_id""=""r"".""ride_id"" AND EXTRACT(YEAR FROM ""r"".""requested_at"")=2020 GROUP BY EXTRACT(MONTH FROM ""r"".""requested_at"")), ""available_drivers"" AS (SELECT ""agg"".""fy_month"",COUNT(DISTINCT ""agg"".""driver_id"") AS ""active_drivers"" FROM (SELECT CASE WHEN EXTRACT(YEAR FROM ""d"".""join_date"")<2020 THEN 1 ELSE EXTRACT(MONTH FROM ""d"".""join_date"") END AS ""fy_month"",""driver_id"" FROM ""drivers"" AS ""d"" WHERE EXTRACT(YEAR FROM ""d"".""join_date"")<=2020) AS ""AGG"" GROUP BY ""agg"".""fy_month"") SELECT ""agg"".""month"",COALESCE(ROUND((""no_accepted_drivers""*100)/""active_drivers"", 2), 0) AS ""working_percentage"" FROM (SELECT ""mt"".""fy_month"" AS ""month"",COALESCE(SUM(""ad"".""active_drivers""), 0) AS ""active_drivers"",COALESCE(""ar"".""no_accepted_drivers"", 0) AS ""no_accepted_drivers"" FROM (""months_table"" AS ""MT"" LEFT JOIN ""available_drivers"" AS ""ad"" ON ""mt"".""fy_month"">=""ad"".""fy_month"") LEFT JOIN ""accepted_drivers"" AS ""ar"" ON ""ar"".""fy_month""=""mt"".""fy_month"" GROUP BY ""mt"".""fy_month"",COALESCE(""ar"".""no_accepted_drivers"", 0)) AS ""AGG"" ORDER BY 'month'"
63,"WITH RECURSIVE ""t"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""t"" WHERE ""month""+1<=12), ""Drivers_t"" AS (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(""driver_id"") OVER (ORDER BY ""join_date"") AS ""cnt"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<='2020'), ""request_t"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""ride_cnt"" FROM ""Rides"" JOIN ""AcceptedRides"" USING (""ride_id"") WHERE EXTRACT(YEAR FROM ""requested_at"")='2020' GROUP BY 1) SELECT ""t2"".""month"",ROUND(COALESCE(""ride_cnt""/""driver_cnt"", 0)*100, 2) AS ""working_percentage"" FROM (SELECT DISTINCT ""month"",COALESCE(MAX(""cnt"") OVER (ORDER BY ""month""), 0) AS ""driver_cnt"" FROM ""t"" LEFT JOIN ""Drivers_t"" USING (""month"")) AS ""t2"" LEFT JOIN ""request_t"" USING (""month"")"
64,"WITH RECURSIVE ""cte"" AS (SELECT '2020-01-01' AS ""month"" UNION SELECT ""month"" + INTERVAL '1 MONTH' AS ""month"" FROM ""cte"" WHERE ""month""<'2020-12-01') SELECT EXTRACT(MONTH FROM ""a"".""month"") AS ""month"",CASE WHEN COALESCE(COUNT(DISTINCT ""b"".""driver_id""), 0)=0 THEN 0 ELSE ROUND(COALESCE(MAX(""accepted_driver"")/COUNT(DISTINCT ""b"".""driver_id"")*100, 0), 2) END AS ""working_percentage"" FROM (""cte"" AS ""a"" LEFT JOIN ""drivers"" AS ""b"" ON LAST_DAY(""a"".""month"")>=""b"".""join_date"") LEFT JOIN (SELECT EXTRACT(MONTH FROM ""a"".""requested_at"") AS ""month"",COALESCE(COUNT(DISTINCT ""b"".""driver_id""), 0) AS ""accepted_driver"" FROM ""rides"" AS ""a"" LEFT JOIN ""acceptedrides"" AS ""b"" ON ""a"".""ride_id""=""b"".""ride_id"" WHERE EXTRACT(YEAR FROM ""a"".""requested_at"")=2020 AND ""b"".""driver_id"" IS NOT NULL GROUP BY 1) AS ""c"" ON EXTRACT(MONTH FROM ""a"".""month"")=""c"".""month"" GROUP BY 1 ORDER BY 1"
65,"WITH RECURSIVE ""months"" AS (SELECT 1 AS ""Month"" UNION ALL SELECT ""Month""+1 FROM ""months"" WHERE ""Month""<12), ""AvailableDrivers"" AS (SELECT ""M1"".""Month"",COUNT(""D1"".""driver_id"") AS ""AvailableDriversCNT"" FROM ""months"" AS ""M1"" LEFT JOIN (SELECT * FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020) AS ""D1"" ON ""M1"".""Month"">=EXTRACT(MONTH FROM ""D1"".""join_date"") OR EXTRACT(YEAR FROM ""D1"".""join_date"")<2020 GROUP BY ""Month""), ""WorkingDrivers"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""Month"",COUNT(DISTINCT ""T1"".""driver_id"") AS ""WorkingDriversCNT"" FROM ""AcceptedRides"" AS ""T1"" JOIN ""Rides"" AS ""T2"" ON ""T1"".""ride_id""=""T2"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY EXTRACT(MONTH FROM ""requested_at"") ORDER BY ""Month"") SELECT ""T1"".""Month"",ROUND(COALESCE(""WorkingDriversCNT""/""AvailableDriversCNT"", 0)*100, 2) AS ""working_percentage"" FROM ""AvailableDrivers"" AS ""T1"" LEFT JOIN ""WorkingDrivers"" AS ""T2"" ON ""T1"".""Month""=""T2"".""Month"" ORDER BY ""T1"".""Month"""
66,"WITH RECURSIVE ""t1"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""m"",COUNT(DISTINCT ""driver_id"") AS ""c"" FROM ""Rides"" AS ""a"" JOIN ""AcceptedRides"" AS ""b"" ON ""a"".""ride_id""=""b"".""ride_id"" WHERE ""requested_at"" BETWEEN '2020-01-01' AND '2020-12-31' GROUP BY EXTRACT(MONTH FROM ""requested_at"")), ""t2"" AS (SELECT 1 AS ""m"" UNION ALL SELECT ""m""+1 AS ""m"" FROM ""t2"" WHERE ""m""<12), ""t3"" AS (SELECT ""m"",SUM(CASE WHEN (EXTRACT(YEAR FROM ""join_date"")<=2019) OR (EXTRACT(YEAR FROM ""join_date"")=2020 AND EXTRACT(MONTH FROM ""join_date"")<=""m"") THEN 1 ELSE 0 END) AS ""available_drivers"" FROM ""t2"" AS ""a"" JOIN ""Drivers"" AS ""b"" GROUP BY ""a"".""m""), ""t4"" AS (SELECT ""t2"".""m"",COALESCE(""t1"".""c"", 0) AS ""c"" FROM ""t2"" LEFT JOIN ""t1"" ON ""t2"".""m""=""t1"".""m"") SELECT ""t3"".""m"" AS ""month"",CASE WHEN ""t3"".""available_drivers""=0 THEN 0 ELSE ROUND(""t4"".""c""*100/""t3"".""available_drivers"", 2) END AS ""working_percentage"" FROM ""t3"" JOIN ""t4"" ON ""t3"".""m""=""t4"".""m"""
67,"WITH RECURSIVE ""months"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""months"" WHERE ""month""<12), ""total_drivers"" AS (SELECT ""m"".""month"",COUNT(""d"".""driver_id"") AS ""active_drivers"" FROM (""months"" AS ""m"") JOIN ""Drivers"" AS ""d"" WHERE LAST_DAY(STR_TO_DATE(CONCAT(2020, ""m"".""month""), '%Y%m'))>=""d"".""join_date"" GROUP BY ""m"".""month""), ""working_drivers"" AS (SELECT EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""month"",COUNT(DISTINCT ""ar"".""driver_id"") AS ""working_drivers"" FROM (""Rides"" AS ""r"") JOIN ""AcceptedRides"" AS ""ar"" WHERE ""r"".""ride_id""=""ar"".""ride_id"" AND EXTRACT(YEAR FROM ""r"".""requested_at"")=2020 GROUP BY EXTRACT(MONTH FROM ""r"".""requested_at"")) SELECT ""m"".""month"",COALESCE(ROUND(COALESCE(""w"".""working_drivers"", 0)/""t"".""active_drivers""*100, 2), 0.00) AS ""working_percentage"" FROM (""months"" AS ""m"" LEFT JOIN ""total_drivers"" AS ""t"" ON ""m"".""month""=""t"".""month"") LEFT JOIN ""working_drivers"" AS ""w"" ON ""m"".""month""=""w"".""month"""
68,"WITH RECURSIVE ""M"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""M"" WHERE ""month""<12), ""Available_Driver"" AS (SELECT ""a"".""month"",SUM(COALESCE(""b"".""available_driver"", 0)) OVER (ORDER BY ""a"".""month"") AS ""available_driver"" FROM ""M"" AS ""a"" LEFT JOIN (SELECT CASE WHEN EXTRACT(YEAR FROM ""join_date"")<2020 THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""month"",COUNT(""driver_id"") AS ""available_driver"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020 GROUP BY 1) AS ""b"" ON ""a"".""month""=""b"".""month""), ""Active_Driver"" AS (SELECT EXTRACT(MONTH FROM ""a"".""requested_at"") AS ""month"",COUNT(DISTINCT ""b"".""driver_id"") AS ""active_driver"" FROM ""Rides"" AS ""a"" JOIN ""AcceptedRides"" AS ""b"" ON ""a"".""ride_id""=""b"".""ride_id"" WHERE EXTRACT(YEAR FROM ""a"".""requested_at"")=2020 GROUP BY 1) SELECT ""a"".""month"",CASE WHEN ""a"".""available_driver""=0 THEN 0.00 ELSE ROUND(COALESCE(""b"".""active_driver"", 0)/""a"".""available_driver""*100, 2) END AS ""working_percentage"" FROM ""Available_Driver"" AS ""a"" LEFT JOIN ""Active_Driver"" AS ""b"" ON ""a"".""month""=""b"".""month"" ORDER BY ""a"".""month"""
69,"WITH RECURSIVE ""cte"" AS (SELECT '2020-01-01' AS ""datemonth"" UNION ALL SELECT ""datemonth"" + INTERVAL '1 MONTH' AS ""datemonth"" FROM ""cte"" WHERE ""datemonth""<'2020-12-01'), ""cte1"" AS (SELECT ""driver_id"",""requested_at"",EXTRACT(MONTH FROM ""requested_at"") AS ""month"" FROM ""AcceptedRides"" AS ""a"" LEFT JOIN ""Rides"" AS ""r"" ON ""a"".""ride_id""=""r"".""ride_id"" WHERE ""requested_at"" BETWEEN '2020-01-01' AND '2020-12-31'), ""cte2"" AS (SELECT ""driver_id"",EXTRACT(MONTH FROM ""join_date"") AS ""month"" FROM (SELECT ""driver_id"",CASE WHEN ""join_date""<'2020-01-01' THEN '2020-01-01' ELSE ""join_date"" END AS ""join_date"" FROM ""Drivers"" WHERE ""join_date""<='2020-12-31') AS ""t""), ""cte3"" AS (SELECT ""month"",SUM(""num_new_driver"") OVER (ORDER BY ""month"") AS ""num_driver"" FROM (SELECT ""t"".""month"",COALESCE(""t2"".""num_new_driver"", 0) AS ""num_new_driver"" FROM (SELECT EXTRACT(MONTH FROM ""datemonth"") AS ""month"" FROM ""cte"") AS ""t"" LEFT JOIN (SELECT ""month"",COUNT(""driver_id"") AS ""num_new_driver"" FROM ""cte2"" GROUP BY ""month"") AS ""t2"" ON ""t"".""month""=""t2"".""month"") AS ""t3"") SELECT ""c3"".""month"",ROUND(COALESCE(""c1"".""num_active_driver""/""c3"".""num_driver"", 0)*100, 2) AS ""working_percentage"" FROM ""cte3"" AS ""c3"" LEFT JOIN (SELECT ""month"",COUNT(DISTINCT ""driver_id"") AS ""num_active_driver"" FROM ""cte1"" GROUP BY ""month"") AS ""c1"" ON ""c3"".""month""=""c1"".""month"" ORDER BY ""c3"".""month"""
70,"WITH RECURSIVE ""months"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""months"" WHERE ""month""<12), ""available_drivers"" AS (SELECT ""months"".""month"",COALESCE(MAX(""t1"".""active_driver"") OVER (ORDER BY ""month""), 0) AS ""active_driver"" FROM ""months"" LEFT JOIN (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(""driver_id"") OVER (ORDER BY ""join_date"" ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS ""active_driver"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020) AS ""t1"" ON ""t1"".""month""=""months"".""month""), ""working_drivers"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""working_driver"" FROM ""Rides"" AS ""R"" JOIN ""AcceptedRides"" AS ""A"" ON ""R"".""ride_id""=""A"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY 1) SELECT ""months"".""month"",COALESCE(ROUND(""working_driver""/""active_driver""*100, 2), 0) AS ""working_percentage"" FROM (""months"" LEFT JOIN ""available_drivers"" ON ""available_drivers"".""month""=""months"".""month"") LEFT JOIN ""working_drivers"" ON ""working_drivers"".""month""=""months"".""month"" GROUP BY 1"
71,"WITH ""dates"" AS (SELECT 1 AS ""MONTH"" UNION SELECT 2 AS ""MONTH"" UNION SELECT 3 AS ""MONTH"" UNION SELECT 4 AS ""MONTH"" UNION SELECT 5 AS ""MONTH"" UNION SELECT 6 AS ""MONTH"" UNION SELECT 7 AS ""MONTH"" UNION SELECT 8 AS ""MONTH"" UNION SELECT 9 AS ""MONTH"" UNION SELECT 10 AS ""MONTH"" UNION SELECT 11 AS ""MONTH"" UNION SELECT 12 AS ""MONTH""), ""join_year_dates"" AS (SELECT DISTINCT (""drivers_inner"".""year"") AS ""year"",COALESCE(""dates"".""month"", ""drivers_inner"".""month"") AS ""month"" FROM (SELECT EXTRACT(YEAR FROM ""join_date"") AS ""year"",EXTRACT(MONTH FROM ""join_date"") AS ""month"" FROM ""drivers"") AS ""drivers_inner"" JOIN ""dates"" ON 1=1), ""driver_cnt"" AS (SELECT ""join_year_dates"".""year"" AS ""year"",""join_year_dates"".""month"" AS ""month"",COALESCE(""driver_cnt_inner"".""joined_drivers_per_month"", 0.0) AS ""joined_drivers"" FROM ""join_year_dates"" LEFT JOIN (SELECT EXTRACT(YEAR FROM ""drivers"".""join_date"") AS ""year"",EXTRACT(MONTH FROM ""drivers"".""join_date"") AS ""month"",COUNT(1) AS ""joined_drivers_per_month"" FROM ""drivers"" GROUP BY ""year"",""month"") AS ""driver_cnt_inner"" ON ""join_year_dates"".""year""=""driver_cnt_inner"".""year"" AND ""join_year_dates"".""month""=""driver_cnt_inner"".""month""), ""cumulative_total_driver_cnt"" AS (SELECT ""x1"".""year"" AS ""year"",""x1"".""month"" AS ""month"",""x1"".""joined_drivers"" AS ""joined_drivers"",SUM(""x1"".""joined_drivers"") OVER (ORDER BY ""x1"".""year"",""x1"".""month"") AS ""current_active_drivers"" FROM ""driver_cnt"" AS ""x1"") SELECT ""total_accepted_rides"".""month"" AS ""month"",ROUND(CASE WHEN ""active_drivers_per_month"".""current_active_drivers""=0 THEN 0.00 ELSE COALESCE((""total_accepted_rides"".""driver_count""*100.0)/""active_drivers_per_month"".""current_active_drivers"", 0.0) END, 2) AS ""working_percentage"" FROM (SELECT ""dates"".""month"",COUNT(""x"".""driver_id"") AS ""driver_count"" FROM ""dates"" LEFT JOIN (SELECT DISTINCT EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""month"",""driver_id"" FROM (SELECT * FROM ""rides"" WHERE EXTRACT(YEAR FROM ""requested_at"")>=2020 AND EXTRACT(YEAR FROM ""requested_at"")<2021) AS ""r"" JOIN ""AcceptedRides"" AS ""ar"" ON ""r"".""ride_id""=""ar"".""ride_id"") AS ""x"" ON ""x"".""month""=""dates"".""month"" GROUP BY ""month"") AS ""total_accepted_rides"" JOIN (SELECT * FROM ""cumulative_total_driver_cnt"" AS ""x"" WHERE ""year"">=2020 AND ""year""<2021) AS ""active_drivers_per_month"" ON ""active_drivers_per_month"".""month""=""total_accepted_rides"".""month"" ORDER BY ""month"""
72,"WITH RECURSIVE ""header"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""header"" WHERE ""month""<12), ""cte"" AS (SELECT ""h"".""month"",COUNT(""d"".""driver_id"") OVER (ORDER BY ""h"".""month"")+(SELECT COUNT(""driver_id"") FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<2020) AS ""driver"" FROM ""header"" AS ""h"" LEFT JOIN (SELECT * FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")=2020) AS ""d"" ON ""h"".""month""=EXTRACT(MONTH FROM ""d"".""join_date"")), ""cte2"" AS (SELECT EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""month"",COUNT(DISTINCT ""a"".""driver_id"") AS ""adriver"" FROM ""acceptedrides"" AS ""a"" LEFT JOIN ""rides"" AS ""r"" USING (""ride_id"") WHERE EXTRACT(YEAR FROM ""r"".""requested_at"")=2020 GROUP BY 1) SELECT DISTINCT ""c1"".""month"",COALESCE(ROUND(COALESCE(""adriver"", 0)/COALESCE(""driver"", 0)*100, 2), 0) AS ""working_percentage"" FROM ""cte"" AS ""c1"" LEFT JOIN ""cte2"" AS ""c2"" USING (""month"")"
73,"WITH RECURSIVE ""mm"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""mm"" WHERE ""month""<12) SELECT ""avadriver"".""month"" AS ""month"",ROUND(CASE WHEN ""avadriver"".""availabledrivers""=0 THEN 0 ELSE COALESCE(""actdriver"".""accptdrivers"", 0)*100/""avadriver"".""availabledrivers"" END, 2) AS ""working_percentage"" FROM (SELECT EXTRACT(MONTH FROM ""ride"".""requested_at"") AS ""month"",COUNT(DISTINCT ""acct"".""driver_id"") AS ""accptdrivers"" FROM ""AcceptedRides"" AS ""acct"" JOIN ""Rides"" AS ""ride"" ON ""acct"".""ride_id""=""ride"".""ride_id"" WHERE ""ride"".""requested_at"" BETWEEN '2020-01-01' AND '2020-12-31' GROUP BY ""month"") AS ""actdriver"" RIGHT JOIN (SELECT ""tmm"".""month"",COUNT(""driver_id"") AS ""availabledrivers"" FROM ""mm"" AS ""tmm"" LEFT JOIN ""Drivers"" AS ""dr"" ON ""dr"".""join_date""<CONCAT('2020-', ""tmm"".""month"", '-01') + INTERVAL '1 MONTH' GROUP BY ""month"") AS ""avadriver"" ON ""avadriver"".""month""=""actdriver"".""month"" ORDER BY ""month"""
74,"WITH RECURSIVE ""yr"" AS (SELECT 2019 AS ""y"" UNION SELECT ""y""+1 FROM ""yr"" WHERE ""y""<EXTRACT(YEAR FROM CURRENT_DATE())), ""mm"" AS (SELECT 1 AS ""m"" UNION SELECT ""m""+1 FROM ""mm"" WHERE ""m""<12), ""yymm"" AS (SELECT ""y"",""m"" FROM ""yr"" JOIN ""mm""), ""active_drivers"" AS (SELECT ""y"",""m"",COUNT(""driver_id"") OVER (ORDER BY ""y"",""m"") AS ""dr_count"" FROM ""Drivers"" RIGHT JOIN ""yymm"" ON EXTRACT(YEAR FROM ""join_date"")=""y"" AND EXTRACT(MONTH FROM ""join_date"")=""m""), ""accepted_rides"" AS (SELECT ""y"",""m"",COUNT(DISTINCT ""driver_id"") AS ""acp_rides"" FROM (""Rides"" JOIN ""AcceptedRides"" USING (""ride_id"")) RIGHT JOIN ""yymm"" ON EXTRACT(YEAR FROM ""requested_at"")=""y"" AND EXTRACT(MONTH FROM ""requested_at"")=""m"" GROUP BY ""y"",""m"") SELECT DISTINCT ""m"" AS ""month"",ROUND(CASE WHEN ""dr_count""=0 THEN 0 ELSE ""acp_rides""/""dr_count""*100 END, 2) AS ""working_percentage"" FROM ""active_drivers"" JOIN ""accepted_rides"" USING (""y"",""m"") WHERE ""y""=2020"
75,"WITH RECURSIVE ""t1"" AS (SELECT 1 AS ""month"" UNION SELECT ""month""+1 AS ""month"" FROM ""t1"" WHERE ""month""<12), ""t2"" AS (SELECT CASE WHEN EXTRACT(YEAR FROM ""join_date"")=2019 THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""active_drivers"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020 GROUP BY ""month""), ""t3"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""AcceptedRides"".""driver_id"") AS ""accepted_rides"" FROM ""Rides"" JOIN ""AcceptedRides"" ON ""Rides"".""ride_id""=""AcceptedRides"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY ""month"") SELECT ""t1"".""month"",ROUND(COALESCE(100*""t3"".""accepted_rides""/SUM(""t2"".""active_drivers""), 0), 2) AS ""working_percentage"" FROM (""t1"" LEFT JOIN ""t2"" ON ""t1"".""month"">=""t2"".""month"") LEFT JOIN ""t3"" ON ""t1"".""month""=""t3"".""month"" GROUP BY 1 ORDER BY 1"
76,"WITH RECURSIVE ""m"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""m"" WHERE ""month""<12), ""ad"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",""driver_id"" FROM ""AcceptedRides"" JOIN ""Rides"" USING (""ride_id"") WHERE EXTRACT(YEAR FROM ""requested_at"")=2020), ""d"" AS (SELECT CASE WHEN EXTRACT(YEAR FROM ""join_date"")<=2019 THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""month"",""driver_id"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020) SELECT ""m"".""month"",ROUND(COALESCE(COALESCE(COUNT(DISTINCT ""ad"".""driver_id""), 0)/SUM(COUNT(DISTINCT ""d"".""driver_id"")) OVER (ORDER BY ""m"".""month"")*100, 0), 2) AS ""working_percentage"" FROM (""m"" LEFT JOIN ""ad"" ON ""m"".""month""=""ad"".""month"") LEFT JOIN ""d"" ON ""m"".""month""=""d"".""month"" GROUP BY 1"
77,"WITH RECURSIVE ""t"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""t"" WHERE ""month""<12), ""t1"" AS (SELECT ""driver_id"",""join_date"",CASE WHEN EXTRACT(YEAR FROM ""join_date"")<2020 THEN '2020-01-01' ELSE ""join_date"" END AS ""new_date"" FROM ""drivers""), ""t2"" AS (SELECT DISTINCT ""t"".""month"",COUNT(DISTINCT ""t1"".""driver_id"") AS ""active_driver"" FROM ""t"" LEFT JOIN ""t1"" ON ""t"".""month""=EXTRACT(MONTH FROM ""t1"".""new_date"") AND EXTRACT(YEAR FROM ""t1"".""new_date"")=2020 GROUP BY 1), ""t3"" AS (SELECT DISTINCT ""t"".""month"",COUNT(DISTINCT ""driver_id"") AS ""accepted_rider"" FROM ""t"" LEFT JOIN (SELECT ""a"".""driver_id"",""r"".""requested_at"" FROM ""acceptedrides"" AS ""a"" LEFT JOIN ""rides"" AS ""r"" ON ""a"".""ride_id""=""r"".""ride_id"" AND EXTRACT(YEAR FROM ""r"".""requested_at"")=2020) AS ""t4"" ON ""t"".""month""=EXTRACT(MONTH FROM ""t4"".""requested_at"") GROUP BY 1) SELECT ""t3"".""month"",ROUND(100*(COALESCE(""t3"".""accepted_rider""/SUM(""t2"".""active_driver"") OVER (ORDER BY ""t2"".""month""), 0)), 2) AS ""working_percentage"" FROM ""t3"" JOIN ""t2"" ON ""t3"".""month""=""t2"".""month"""
78,"WITH RECURSIVE ""cte"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 AS ""month"" FROM ""cte"" WHERE ""month""<12), ""driver_tbl"" AS (SELECT CASE WHEN EXTRACT(YEAR FROM ""join_date"")<2020 THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""month"",COUNT(""driver_id"") AS ""driver_nums"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020 GROUP BY 1), ""ride_tbl"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""a"".""driver_id"") AS ""accepted_nums"" FROM ""Rides"" AS ""r"" JOIN ""AcceptedRides"" AS ""a"" ON ""r"".""ride_id""=""a"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY 1) SELECT ""c"".""month"",ROUND(COALESCE(""accepted_nums""/SUM(""driver_nums"") OVER (ORDER BY ""month""), 0)*100, 2) AS ""working_percentage"" FROM (""cte"" AS ""c"" LEFT JOIN ""driver_tbl"" AS ""d"" ON ""c"".""month""=""d"".""month"") LEFT JOIN ""ride_tbl"" AS ""r"" ON ""c"".""month""=""r"".""month"""
79,"WITH RECURSIVE ""all_months0"" AS (SELECT '2020-02-01' AS ""the_month"" UNION ALL SELECT ""the_month"" + INTERVAL '1 MONTH' AS ""the_month"" FROM ""all_months0"" WHERE ""the_month""<'2020-12-31'), ""all_months"" AS (SELECT ""the_month"" - INTERVAL '1 DAY' AS ""the_month"" FROM ""all_months0""), ""drivers_count"" AS (SELECT EXTRACT(MONTH FROM ""a"".""the_month"") AS ""the_month"",COUNT(""driver_id"") AS ""driver_count"" FROM ""all_months"" AS ""a"" LEFT JOIN ""drivers"" AS ""d"" ON ""d"".""join_date""<=""a"".""the_month"" GROUP BY 1), ""accepted_rides"" AS (SELECT EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""the_month"",COUNT(DISTINCT ""a"".""driver_id"") AS ""ride_count"" FROM ""acceptedrides"" AS ""a"" JOIN ""rides"" AS ""r"" ON ""a"".""ride_id""=""r"".""ride_id"" WHERE ""requested_at"" BETWEEN '2020-01-01' AND '2020-12-31' GROUP BY 1) SELECT ""month"",COALESCE(""working_percentage"", 0) AS ""working_percentage"" FROM (SELECT ""d"".""the_month"" AS ""month"",ROUND(100*""a"".""ride_count""/""d"".""driver_count"", 2) AS ""working_percentage"" FROM ""drivers_count"" AS ""d"" LEFT JOIN ""accepted_rides"" AS ""a"" ON ""d"".""the_month""=""a"".""the_month"") AS ""result_table"""
80,"WITH RECURSIVE ""active_driver"" AS (SELECT ""driver_id"",""join_date"",""join_date"" AS ""dur"" FROM ""drivers"" UNION SELECT ""driver_id"",""join_date"",""dur"" + INTERVAL '1 MONTH' AS ""dur"" FROM ""active_driver"" WHERE ""dur""<LAST_DAY(CURDATE()) + INTERVAL '1 MONTH'), ""datedim"" AS (SELECT 1 AS ""m"" UNION SELECT ""m""+1 FROM ""datedim"" WHERE ""m""<12) SELECT ""m"" AS ""month"",ROUND(COALESCE(""wd"".""working_driver"", 0)*100/COALESCE(""ad"".""monthly_ad"", 1), 2) AS ""working_percentage"" FROM (""datedim"" AS ""dd"" LEFT JOIN (SELECT EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""month"",COUNT(DISTINCT ""ar"".""driver_id"") AS ""working_driver"" FROM ""acceptedrides"" AS ""ar"" JOIN ""rides"" AS ""r"" ON ""r"".""ride_id""=""ar"".""ride_id"" WHERE EXTRACT(YEAR FROM ""r"".""requested_at"")=2020 GROUP BY EXTRACT(MONTH FROM ""r"".""requested_at"")) AS ""wd"" ON ""wd"".""month""=""dd"".""m"") LEFT JOIN (SELECT EXTRACT(MONTH FROM ""dur"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""monthly_ad"" FROM ""active_driver"" WHERE EXTRACT(YEAR FROM ""dur"")=2020 GROUP BY EXTRACT(MONTH FROM ""dur"")) AS ""ad"" ON ""ad"".""month""=""dd"".""m"""
81,"WITH RECURSIVE ""months"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""months"" WHERE ""month""<12), ""available_drivers"" AS (SELECT DISTINCT ""months"".""month"",COALESCE(MAX(""t1"".""active_driver"") OVER (ORDER BY ""month""), 0) AS ""active_driver"" FROM ""months"" LEFT JOIN (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(""driver_id"") OVER (ORDER BY ""join_date"" ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS ""active_driver"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020) AS ""t1"" ON ""t1"".""month""=""months"".""month""), ""working_drivers"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""working_driver"" FROM ""Rides"" AS ""R"" JOIN ""AcceptedRides"" AS ""A"" ON ""R"".""ride_id""=""A"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY EXTRACT(MONTH FROM ""requested_at"")) SELECT ""ad"".""month"",COALESCE(ROUND(""working_driver""/""active_driver""*100, 2), 0) AS ""working_percentage"" FROM ""available_drivers"" AS ""ad"" LEFT JOIN ""working_drivers"" AS ""wd"" ON ""wd"".""month""=""ad"".""month"""
82,"WITH RECURSIVE ""CTE1"" (""MONTH"") AS (SELECT 1 AS ""MONTH"" UNION ALL SELECT ""MONTH""+1 FROM ""CTE1"" WHERE ""MONTH""<12), ""CTE2"" AS (SELECT ""DRIVER_ID"",CASE WHEN EXTRACT(YEAR FROM ""JOIN_DATE"")<2020 THEN 1 ELSE EXTRACT(MONTH FROM ""JOIN_DATE"") END AS ""MONTH"" FROM ""DRIVERS"" WHERE EXTRACT(YEAR FROM ""JOIN_DATE"")<=2020), ""CTE3"" AS (SELECT ""CTE1"".""MONTH"",COUNT(""DRIVER_ID"") OVER (ORDER BY ""CTE1"".""MONTH"") AS ""ACTIVE_DRIVERS"" FROM ""CTE1"" LEFT JOIN ""CTE2"" USING (""MONTH"")), ""CTE4"" AS (SELECT ""DRIVER_ID"",EXTRACT(MONTH FROM ""REQUESTED_AT"") AS ""MONTH"" FROM ""RIDES"" JOIN ""ACCEPTEDRIDES"" USING (""RIDE_ID"") WHERE EXTRACT(YEAR FROM ""REQUESTED_AT"")=2020), ""CTE5"" AS (SELECT ""CTE1"".""MONTH"",COUNT(DISTINCT ""DRIVER_ID"") AS ""NUM_DRIVERS_ACCRIDES"" FROM ""CTE1"" LEFT JOIN ""CTE4"" USING (""MONTH"") GROUP BY ""CTE1"".""MONTH"") SELECT DISTINCT ""CTE5"".""MONTH"",(CASE WHEN ""ACTIVE_DRIVERS""=0 THEN 0 ELSE ROUND(""NUM_DRIVERS_ACCRIDES""/""ACTIVE_DRIVERS""*100, 2) END) AS ""working_percentage"" FROM ""CTE5"" JOIN ""CTE3"" USING (""MONTH"")"
83,"WITH RECURSIVE ""t1"" AS (SELECT 1 AS ""month"" UNION ALL SELECT 1+""month"" AS ""month"" FROM ""t1"" WHERE ""month""<12), ""t2"" AS (SELECT EXTRACT(MONTH FROM ""b"".""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""nbr_drivers"" FROM ""AcceptedRides"" AS ""a"" LEFT JOIN ""rides"" AS ""b"" ON ""a"".""ride_id""=""b"".""ride_id"" WHERE EXTRACT(YEAR FROM ""b"".""requested_at"")=2020 GROUP BY EXTRACT(MONTH FROM ""b"".""requested_at"")), ""t3"" AS (SELECT ""driver_id"",CASE WHEN ""join_date""<='2019-12-31' THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""month"" FROM ""Drivers"" WHERE ""join_date""<='2020-12-31'), ""t4"" AS (SELECT ""month"",SUM(""avail_drivers"") OVER (ORDER BY ""month"") AS ""available_drivers"" FROM (SELECT ""t1"".""month"",COUNT(DISTINCT ""t3"".""driver_id"") AS ""avail_drivers"" FROM ""t1"" LEFT JOIN ""t3"" ON ""t1"".""month""=""t3"".""month"" GROUP BY ""t1"".""month"" ORDER BY ""t1"".""month"") AS ""a"") SELECT ""t1"".""month"",CASE WHEN ""t2"".""nbr_drivers"">0 AND ""t4"".""available_drivers"">0 THEN ROUND(100*""t2"".""nbr_drivers""/""t4"".""available_drivers"", 2) ELSE 0 END AS ""working_percentage"" FROM (""t1"" LEFT JOIN ""t2"" ON ""t1"".""month""=""t2"".""month"") LEFT JOIN ""t4"" ON ""t1"".""month""=""t4"".""month"""
84,"WITH RECURSIVE ""cte"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""cte"" WHERE ""month""<=11), ""cte2"" AS (SELECT ""c"".""month"",COUNT(DISTINCT ""d"".""driver_id"") AS ""ct_avail"" FROM ""cte"" AS ""c"" LEFT JOIN (SELECT ""driver_id"",CASE WHEN ""join_date""<'2020-01-01' THEN '2020-01-01' ELSE ""join_date"" END AS ""join_date"" FROM ""Drivers"") AS ""d"" ON ""c"".""month"">=EXTRACT(MONTH FROM ""d"".""join_date"") AND EXTRACT(YEAR FROM ""d"".""join_date"")<2021 GROUP BY 1), ""cte3"" AS (SELECT ""c"".""month"",COUNT(DISTINCT ""a"".""driver_id"") AS ""ct_request"" FROM (""cte"" AS ""c"" LEFT JOIN ""Rides"" AS ""r"" ON ""c"".""month""=EXTRACT(MONTH FROM ""r"".""requested_at"") AND EXTRACT(YEAR FROM ""r"".""requested_at"")=2020) JOIN ""AcceptedRides"" AS ""a"" ON ""r"".""ride_id""=""a"".""ride_id"" GROUP BY 1) SELECT ""cte2"".""month"",COALESCE(ROUND(""ct_request""*100.00/""ct_avail"", 2), 0.00) AS ""working_percentage"" FROM ""cte2"" LEFT JOIN ""cte3"" ON ""cte2"".""month""=""cte3"".""month"""
85,"WITH RECURSIVE ""months"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""months"" WHERE ""month""<12), ""available_drivers"" AS (SELECT ""months"".""month"",COALESCE(MAX(""t1"".""active_driver"") OVER (ORDER BY ""month""), 0) AS ""active_driver"" FROM ""months"" LEFT JOIN (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(""driver_id"") OVER (ORDER BY ""join_date"" ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS ""active_driver"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020) AS ""t1"" ON ""t1"".""month""=""months"".""month""), ""working_drivers"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""working_driver"" FROM ""Rides"" AS ""R"" JOIN ""AcceptedRides"" AS ""A"" ON ""R"".""ride_id""=""A"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY 1) SELECT ""months"".""month"",COALESCE(ROUND(""working_driver""/""active_driver""*100, 2), 0) AS ""working_percentage"" FROM (""months"" LEFT JOIN ""available_drivers"" ON ""available_drivers"".""month""=""months"".""month"") LEFT JOIN ""working_drivers"" ON ""working_drivers"".""month""=""months"".""month"" GROUP BY 1"
86,"WITH RECURSIVE ""counter"" AS (SELECT 1 AS ""n"" UNION ALL SELECT ""n""+1 FROM ""counter"" WHERE ""n""<12), ""first1"" AS (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""m"",COUNT(""driver_id"") AS ""total1"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")=2020 GROUP BY EXTRACT(MONTH FROM ""join_date"")), ""second1"" AS (SELECT ""c"".""n"" AS ""month"",SUM(""f"".""total1"") OVER (ORDER BY ""c"".""n"")+(SELECT COUNT(""driver_id"") FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<2020) AS ""available"" FROM ""counter"" AS ""c"" LEFT JOIN ""first1"" AS ""f"" ON ""c"".""n""=""f"".""m""), ""third1"" AS (SELECT EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""month"",COUNT(DISTINCT ""a"".""driver_id"") AS ""worked"" FROM ""AcceptedRides"" AS ""a"" LEFT JOIN ""Rides"" AS ""r"" ON ""a"".""ride_id""=""r"".""ride_id"" WHERE EXTRACT(YEAR FROM ""r"".""requested_at"")=2020 GROUP BY EXTRACT(MONTH FROM ""r"".""requested_at"")) SELECT ""s"".""month"",ROUND(COALESCE(""t"".""worked""/""s"".""available"", 0)*100.0, 2) AS ""working_percentage"" FROM ""second1"" AS ""s"" LEFT JOIN ""third1"" AS ""t"" ON ""s"".""month""=""t"".""month"""
87,"WITH RECURSIVE ""tbMonth"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""tbMonth"" WHERE ""month""<12), ""tbWorkingD"" AS (SELECT EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""month"",COUNT(DISTINCT ""ar"".""driver_id"") AS ""cnt_working_drivers"" FROM ""AcceptedRides"" AS ""ar"" JOIN ""rides"" AS ""r"" ON ""ar"".""ride_id""=""r"".""ride_id"" WHERE EXTRACT(YEAR FROM ""r"".""requested_at"")=2020 GROUP BY EXTRACT(MONTH FROM ""r"".""requested_at"")), ""tbAvailableD"" AS (SELECT ""tbMonth"".""month"",COUNT(DISTINCT ""d"".""driver_id"") AS ""cnt_available_drivers"" FROM ""tbMonth"" LEFT JOIN ""drivers"" AS ""d"" ON (EXTRACT(YEAR FROM ""d"".""join_date"")<2020 OR (EXTRACT(YEAR FROM ""d"".""join_date"")=2020 AND ""tbMonth"".""month"">=EXTRACT(MONTH FROM ""d"".""join_date""))) GROUP BY ""tbMonth"".""month"") SELECT ""tbAvailableD"".""month"",ROUND(COALESCE(""tbWorkingD"".""cnt_working_drivers""/""tbAvailableD"".""cnt_available_drivers"", 0)*100, 2) AS ""working_percentage"" FROM ""tbAvailableD"" LEFT JOIN ""tbWorkingD"" ON ""tbWorkingD"".""month""=""tbAvailableD"".""month"""
88,"WITH RECURSIVE ""tmp"" AS (SELECT 1 AS ""month"",'2020-01-01' AS ""day"" UNION ALL SELECT ""month""+1 AS ""month"",""day"" + INTERVAL '1 MONTH' FROM ""tmp"" WHERE ""month""<12) SELECT ""month"",COALESCE(ROUND(100*SUM(CASE WHEN ""ride_cnt"">0 THEN 1 ELSE 0 END)/COUNT(""b"".""driver_id""), 2), 0) AS ""working_percentage"" FROM (""tmp"" AS ""a"" LEFT JOIN ""drivers"" AS ""b"" ON LEFT(""join_date"", 7)<=LEFT(""day"", 7)) LEFT JOIN (SELECT LEFT(""requested_at"", 7) AS ""mon"",""driver_id"",COUNT(""ride_id"") AS ""ride_cnt"" FROM ""rides"" AS ""a"" JOIN ""AcceptedRides"" AS ""b"" USING (""ride_id"") WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY 1,2) AS ""c"" ON ""mon""=LEFT(""day"", 7) AND ""b"".""driver_id""=""c"".""driver_id"" GROUP BY 1 ORDER BY 1"
89,"WITH RECURSIVE ""months"" AS (SELECT 1 AS ""month"" UNION SELECT ""month""+1 AS ""month"" FROM ""months"" WHERE ""month""<12), ""available_drivers"" AS (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",MAX(""drivers"") AS ""drivers"" FROM (SELECT ""join_date"",COUNT(""driver_id"") OVER (ORDER BY ""join_date"") AS ""drivers"" FROM ""Drivers"") AS ""t1"" WHERE EXTRACT(YEAR FROM ""join_date"")=2020 GROUP BY ""month""), ""active_drivers"" AS (SELECT EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""month"",COUNT(DISTINCT ""ar"".""driver_id"") AS ""active_drivers"" FROM ""AcceptedRides"" AS ""ar"" LEFT JOIN ""Rides"" AS ""r"" ON ""ar"".""ride_id""=""r"".""ride_id"" WHERE EXTRACT(YEAR FROM ""r"".""requested_at"")=2020 GROUP BY ""month"") SELECT ""t2"".""month"",ROUND(COALESCE(""ac"".""active_drivers""/""t2"".""drivers""*100, 0), 2) AS ""working_percentage"" FROM (SELECT ""m"".""month"",MAX(""av"".""drivers"") OVER (ORDER BY ""month"") AS ""drivers"" FROM ""months"" AS ""m"" LEFT JOIN ""available_drivers"" AS ""av"" ON ""m"".""month""=""av"".""month"") AS ""t2"" LEFT JOIN ""active_drivers"" AS ""ac"" ON ""t2"".""month""=""ac"".""month"""
90,"WITH RECURSIVE ""fm"" AS (SELECT 1 AS ""m"" UNION ALL SELECT ""m""+1 FROM ""fm"" WHERE ""m""<12), ""d"" AS (SELECT ""fm"".""m"",SUM(COALESCE(COUNT(""driver_id""), 0)) OVER (ORDER BY ""fm"".""m"") AS ""driver_cnt"" FROM ""fm"" LEFT JOIN (SELECT ""driver_id"",CASE WHEN EXTRACT(YEAR FROM ""join_date"")<2020 THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""join_month"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020) AS ""temp"" ON ""fm"".""m""=""temp"".""join_month"" GROUP BY ""fm"".""m""), ""w"" AS (SELECT ""fm"".""m"",COALESCE(COUNT(DISTINCT ""driver_id""), 0) AS ""work_driver_cnt"" FROM (""fm"" LEFT JOIN (SELECT * FROM ""rides"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020) AS ""r"" ON ""fm"".""m""=EXTRACT(MONTH FROM ""r"".""requested_at"")) LEFT JOIN ""acceptedrides"" AS ""ar"" ON ""r"".""ride_id""=""ar"".""ride_id"" GROUP BY ""fm"".""m"") SELECT ""m"" AS ""month"",ROUND(COALESCE(""work_driver_cnt""/""driver_cnt"", 0)*100, 2) AS ""working_percentage"" FROM ""d"" JOIN ""w"" USING (""m"")"
91,"WITH RECURSIVE ""CTE1"" (""month"") AS (SELECT 1 UNION ALL SELECT ""month""+1 AS ""month"" FROM ""CTE1"" WHERE ""month""<12), ""CTE2"" AS (SELECT ""A"".""month"",COUNT(""driver_id"") OVER (ORDER BY ""A"".""month"") AS ""active_drivers"" FROM ""CTE1"" AS ""A"" LEFT JOIN (SELECT ""driver_id"",CASE WHEN EXTRACT(YEAR FROM ""join_date"")<2020 THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""month"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020) AS ""B"" ON ""A"".""month""=""B"".""month""), ""CTE3"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""accepted"" FROM ""AcceptedRides"" AS ""A"" LEFT JOIN ""Rides"" AS ""B"" ON ""A"".""ride_id""=""B"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY EXTRACT(MONTH FROM ""requested_at"")) SELECT DISTINCT ""CTE2"".""month"",ROUND(COALESCE(""accepted""/""active_drivers""*100, 0), 2) AS ""working_percentage"" FROM ""CTE2"" LEFT JOIN ""CTE3"" ON ""CTE2"".""month""=""CTE3"".""month"""
92,"WITH RECURSIVE ""CTE1"" AS (SELECT 1 AS ""month"" UNION ALL SELECT 1+""month"" FROM ""CTE1"" WHERE 1+""month""<=12), ""CTE2"" AS (SELECT ""driver_id"",CASE WHEN EXTRACT(YEAR FROM ""join_date"")<2020 THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""month"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020), ""CTE3"" AS (SELECT ""CTE1"".""month"",COUNT(""CTE2"".""driver_id"") OVER (ORDER BY ""CTE1"".""month"") AS ""active_drivers"" FROM ""CTE1"" LEFT JOIN ""CTE2"" ON ""CTE1"".""month""=""CTE2"".""month""), ""CTE4"" AS (SELECT EXTRACT(MONTH FROM ""R"".""requested_at"") AS ""month"",""A"".""driver_id"" FROM (""Rides"" AS ""R"") JOIN ""AcceptedRIdes"" AS ""A"" WHERE ""R"".""ride_id""=""A"".""ride_id"" AND EXTRACT(YEAR FROM ""R"".""requested_at"")=2020), ""CTE5"" AS (SELECT ""CTE1"".""month"",COUNT(DISTINCT ""CTE4"".""driver_id"") AS ""accepted_rides"" FROM ""CTE1"" LEFT JOIN ""CTE4"" ON ""CTE1"".""month""=""CTE4"".""month"" GROUP BY ""CTE1"".""month"") SELECT DISTINCT ""CTE3"".""month"",ROUND(COALESCE(100*""CTE5"".""accepted_rides""/""CTE3"".""active_drivers"", 0), 2) AS ""working_percentage"" FROM (""CTE5"") JOIN ""CTE3"" WHERE ""CTE5"".""month""=""CTE3"".""month"""
93,"WITH RECURSIVE ""seq"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""seq"" WHERE ""month""<12), ""new_driver"" AS (SELECT CASE WHEN ""join_date""<'2020-01-01' THEN 1 ELSE CONVERT(SUBSTRING(""join_date"", 6, 2), INTEGER) END AS ""join_month"",COUNT(DISTINCT ""driver_id"") AS ""new_driver"" FROM ""drivers"" WHERE ""join_date""<='2020-12-31' GROUP BY 1), ""monthly_driver"" AS (SELECT ""seq"".""month"",SUM(COALESCE(""n"".""new_driver"", 0)) AS ""total_driver"" FROM ""seq"" LEFT JOIN ""new_driver"" AS ""n"" ON ""seq"".""month"">=""n"".""join_month"" GROUP BY 1), ""active_driver"" AS (SELECT CONVERT(SUBSTRING(""r"".""requested_at"", 6, 2), INTEGER) AS ""month"",COALESCE(COUNT(DISTINCT ""a"".""driver_id""), 0) AS ""active_driver"" FROM ""acceptedrides"" AS ""a"" LEFT JOIN ""rides"" AS ""r"" ON ""a"".""ride_id""=""r"".""ride_id"" WHERE ""r"".""requested_at"" BETWEEN '2020-01-01' AND '2020-12-31' GROUP BY 1) SELECT ""m"".""month"",ROUND(COALESCE(""a"".""active_driver""/""m"".""total_driver""*100, 0), 2) AS ""working_percentage"" FROM ""monthly_driver"" AS ""m"" LEFT JOIN ""active_driver"" AS ""a"" ON ""m"".""month""=""a"".""month"" ORDER BY 1"
94,"WITH RECURSIVE ""months"" AS (SELECT 1 AS ""month"",2020 AS ""year"" UNION ALL SELECT ""m"".""month""+1 AS ""month"",""m"".""year"" FROM ""months"" AS ""m"" WHERE ""m"".""month""+1<=12), ""active_drivers"" AS (SELECT ""m1"".""month"",COUNT(""d"".""driver_id"") AS ""active_drives_count"" FROM ""months"" AS ""m1"" LEFT JOIN ""Drivers"" AS ""d"" ON EXTRACT(YEAR FROM ""d"".""join_date"")<""m1"".""year"" OR (EXTRACT(YEAR FROM ""d"".""join_date"")=""m1"".""year"" AND EXTRACT(MONTH FROM ""d"".""join_date"")<=""m1"".""month"") GROUP BY ""m1"".""month""), ""active_accepted_drivers_table"" AS (SELECT ""m1"".""month"",COUNT(DISTINCT ""t"".""driver_id"") AS ""active_accepted_driver"" FROM ""months"" AS ""m1"" LEFT JOIN (SELECT ""a"".""ride_id"",""a"".""driver_id"",""r"".""requested_at"" FROM ""AcceptedRides"" AS ""a"" JOIN ""Rides"" AS ""r"" ON ""a"".""ride_id""=""r"".""ride_id"") AS ""t"" ON EXTRACT(YEAR FROM ""t"".""requested_at"")=""m1"".""year"" AND EXTRACT(MONTH FROM ""t"".""requested_at"")=""m1"".""month"" GROUP BY ""m1"".""month"") SELECT ""a1"".""month"",ROUND(CASE WHEN ""a1"".""active_drives_count""=0 THEN 0 ELSE ""a2"".""active_accepted_driver""/""a1"".""active_drives_count"" END*100, 2) AS ""working_percentage"" FROM ""active_drivers"" AS ""a1"" LEFT JOIN ""active_accepted_drivers_table"" AS ""a2"" ON ""a1"".""month""=""a2"".""month"" ORDER BY ""month"""
95,"WITH ""Month"" AS (SELECT * FROM (SELECT 1 AS ""month"" UNION ALL SELECT 2 AS ""month"" UNION ALL SELECT 3 AS ""month"" UNION ALL SELECT 4 AS ""month"" UNION ALL SELECT 5 AS ""month"" UNION ALL SELECT 6 AS ""month"" UNION ALL SELECT 7 AS ""month"" UNION ALL SELECT 8 AS ""month"" UNION ALL SELECT 9 AS ""month"" UNION ALL SELECT 10 AS ""month"" UNION ALL SELECT 11 AS ""month"" UNION ALL SELECT 12 AS ""month"") AS ""A""), ""T1"" AS (SELECT EXTRACT(MONTH FROM ""R"".""requested_at"") AS ""month"",COUNT(DISTINCT ""A"".""driver_id"") AS ""accepted_num"" FROM ""AcceptedRides"" AS ""A"" JOIN ""Rides"" AS ""R"" ON ""A"".""ride_id""=""R"".""ride_id"" WHERE EXTRACT(YEAR FROM ""R"".""requested_at"")=2020 GROUP BY ""month""), ""T2"" AS (SELECT ""M"".""month"",COALESCE(MAX(""t1"".""active_driver"") OVER (ORDER BY ""M"".""month""), 0) AS ""available_num"" FROM ""Month"" AS ""M"" LEFT JOIN (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(""driver_id"") OVER (ORDER BY ""join_date"" ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS ""active_driver"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020) AS ""t1"" ON ""t1"".""month""=""M"".""month"") SELECT ""M"".""month"",COALESCE(ROUND(AVG((""T1"".""accepted_num""/""T2"".""available_num"")*100), 2), 0) AS ""working_percentage"" FROM (""Month"" AS ""M"" LEFT JOIN ""T1"" ON ""M"".""month""=""T1"".""month"") LEFT JOIN ""T2"" ON ""M"".""month""=""T2"".""month"" GROUP BY ""M"".""month"" ORDER BY ""M"".""month"""
96,"WITH RECURSIVE ""t1"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""t1"" WHERE ""month""<12), ""t2"" AS (SELECT CASE WHEN EXTRACT(YEAR FROM ""join_date"")<2020 THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""month"",COUNT(""driver_id"") AS ""new_drivers"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020 GROUP BY ""month""), ""t3"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""active_drivers"" FROM ""rides"" AS ""a"" JOIN ""acceptedrides"" AS ""b"" ON ""a"".""ride_id""=""b"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY ""month""), ""t4"" AS (SELECT ""t1"".""month"",SUM(COALESCE(""new_drivers"", 0)) OVER (ORDER BY ""t1"".""month"") AS ""all_drivers"" FROM ""t1"" LEFT JOIN ""t2"" ON ""t1"".""month""=""t2"".""month"") SELECT ""t4"".""month"",ROUND(100*COALESCE(""active_drivers""/""all_drivers"", 0), 2) AS ""working_percentage"" FROM ""t4"" LEFT JOIN ""t3"" ON ""t4"".""month""=""t3"".""month"""
97,"WITH RECURSIVE ""months"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""months"" WHERE ""month""<12), ""available_drivers"" AS (SELECT ""months"".""month"",COALESCE(MAX(""t1"".""active_driver"") OVER (ORDER BY ""month""), 0) AS ""active_driver"" FROM ""months"" LEFT JOIN (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(""driver_id"") OVER (ORDER BY ""join_date"") AS ""active_driver"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020) AS ""t1"" ON ""t1"".""month""=""months"".""month""), ""working_drivers"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""working_driver"" FROM ""Rides"" AS ""R"" JOIN ""AcceptedRides"" AS ""A"" ON ""R"".""ride_id""=""A"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY 1) SELECT ""months"".""month"",COALESCE(ROUND(""working_driver""/""active_driver""*100, 2), 0) AS ""working_percentage"" FROM (""months"" LEFT JOIN ""available_drivers"" ON ""available_drivers"".""month""=""months"".""month"") LEFT JOIN ""working_drivers"" ON ""working_drivers"".""month""=""months"".""month"" GROUP BY 1"
98,"WITH RECURSIVE ""months"" (""month"") AS (SELECT 1 UNION ALL SELECT ""month""+1 FROM ""months"" WHERE ""month""<12), ""t1"" AS (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(""driver_id"") OVER (ORDER BY ""join_date"") AS ""driver_count"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020), ""t2"" AS (SELECT EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""month"",COUNT(DISTINCT ""a"".""driver_id"") AS ""active_driver"" FROM ""Rides"" AS ""r"" JOIN ""AcceptedRides"" AS ""a"" ON ""r"".""ride_id""=""a"".""ride_id"" WHERE EXTRACT(YEAR FROM ""r"".""requested_at"")=2020 GROUP BY EXTRACT(MONTH FROM ""r"".""requested_at"")) SELECT ""a"".""month"",ROUND(COALESCE(""a"".""act_cnt""/""a"".""tot_cnt""*100, 0), 2) AS ""working_percentage"" FROM (SELECT DISTINCT ""m"".""month"",COALESCE(MAX(""t1"".""driver_count"") OVER (ORDER BY ""m"".""month""), 0) AS ""tot_cnt"",COALESCE(""t2"".""active_driver"", 0) AS ""act_cnt"" FROM (""months"" AS ""m"" LEFT JOIN ""t1"" ON ""m"".""month""=""t1"".""month"") LEFT JOIN ""t2"" ON ""m"".""month""=""t2"".""month"") AS ""a"""
99,"WITH RECURSIVE ""months"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""months"" WHERE ""month""<12), ""available_drivers"" AS (SELECT ""months"".""month"",COALESCE(MAX(""t1"".""active_driver"") OVER (ORDER BY ""month""), 0) AS ""active_driver"" FROM ""months"" LEFT JOIN (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(""driver_id"") OVER (ORDER BY ""join_date"" ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS ""active_driver"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020) AS ""t1"" ON ""t1"".""month""=""months"".""month""), ""working_drivers"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""working_driver"" FROM ""Rides"" AS ""R"" JOIN ""AcceptedRides"" AS ""A"" ON ""R"".""ride_id""=""A"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY 1) SELECT ""months"".""month"",COALESCE(ROUND(""working_driver""/""active_driver""*100, 2), 0) AS ""working_percentage"" FROM (""months"" LEFT JOIN ""available_drivers"" ON ""available_drivers"".""month""=""months"".""month"") LEFT JOIN ""working_drivers"" ON ""working_drivers"".""month""=""months"".""month"" GROUP BY 1"
100,"WITH RECURSIVE ""datedim"" AS (SELECT STR_TO_DATE('20200101', '%Y%m%d') AS ""datevalue"" UNION ALL SELECT ""datevalue"" + INTERVAL '1 MONTH' FROM ""datedim"" WHERE ""datevalue""<'20201201'), ""active_driver_per_month"" AS (SELECT LAST_DAY(""dd"".""datevalue"") AS ""datevalue"",COUNT(""d"".""join_date"") AS ""active_drivers"" FROM ""datedim"" AS ""dd"" LEFT JOIN ""drivers"" AS ""d"" ON ""d"".""join_date""<=LAST_DAY(""dd"".""datevalue"") GROUP BY ""dd"".""datevalue""), ""accepted_ride_per_month"" AS (SELECT LAST_DAY(""requested_at"") AS ""requestDate"",COUNT(""ar"".""ride_id"") AS ""AcceptedRides"" FROM ""acceptedrides"" AS ""ar"" JOIN ""rides"" AS ""r"" ON ""r"".""ride_id""=""ar"".""ride_id"" WHERE EXTRACT(YEAR FROM ""r"".""requested_at"")=2020 GROUP BY LAST_DAY(""requested_at"")), ""workingdriver"" AS (SELECT LAST_DAY(""requested_at"") AS ""requestDate"",COUNT(DISTINCT ""driver_id"") AS ""workingDriver"" FROM ""acceptedrides"" AS ""ar"" JOIN ""rides"" AS ""r"" ON ""r"".""ride_id""=""ar"".""ride_id"" WHERE EXTRACT(YEAR FROM ""r"".""requested_at"")=2020 GROUP BY LAST_DAY(""requested_at"")) SELECT EXTRACT(MONTH FROM ""ad"".""datevalue"") AS ""month"",COALESCE(ROUND((""wd"".""workingDriver""/""ad"".""active_drivers"")*100, 2), 0) AS ""working_percentage"" FROM ""active_driver_per_month"" AS ""ad"" LEFT JOIN ""workingdriver"" AS ""wd"" ON ""wd"".""requestDate""=""ad"".""datevalue"" ORDER BY 1"
101,"WITH RECURSIVE ""months"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""months"" WHERE ""month""<12), ""available_drivers"" AS (SELECT ""months"".""month"",COALESCE(MAX(""t1"".""active_driver"") OVER (ORDER BY ""month""), 0) AS ""active_driver"" FROM ""months"" LEFT JOIN (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(""driver_id"") OVER (ORDER BY ""join_date"" ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS ""active_driver"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020) AS ""t1"" ON ""t1"".""month""=""months"".""month""), ""working_drivers"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""working_driver"" FROM ""Rides"" AS ""R"" JOIN ""AcceptedRides"" AS ""A"" ON ""R"".""ride_id""=""A"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY 1) SELECT ""months"".""month"",COALESCE(ROUND(""working_driver""/""active_driver""*100, 2), 0) AS ""working_percentage"" FROM (""months"" LEFT JOIN ""available_drivers"" ON ""available_drivers"".""month""=""months"".""month"") LEFT JOIN ""working_drivers"" ON ""working_drivers"".""month""=""months"".""month"" GROUP BY 1"
102,"WITH RECURSIVE ""months"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""months"" WHERE ""month""<12), ""available_drivers"" AS (SELECT ""months"".""month"",COALESCE(MAX(""t1"".""active_driver"") OVER (ORDER BY ""month""), 0) AS ""active_driver"" FROM ""months"" LEFT JOIN (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(""driver_id"") OVER (ORDER BY ""join_date"" ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS ""active_driver"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020) AS ""t1"" ON ""t1"".""month""=""months"".""month""), ""working_drivers"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""working_driver"" FROM ""Rides"" AS ""R"" JOIN ""AcceptedRides"" AS ""A"" ON ""R"".""ride_id""=""A"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY 1) SELECT ""months"".""month"",COALESCE(ROUND(""working_driver""/""active_driver""*100, 2), 0) AS ""working_percentage"" FROM (""months"" LEFT JOIN ""available_drivers"" ON ""available_drivers"".""month""=""months"".""month"") LEFT JOIN ""working_drivers"" ON ""working_drivers"".""month""=""months"".""month"" GROUP BY 1"
103,"WITH ""months_2020"" AS (SELECT '2020-01-31' AS ""dt"" UNION SELECT '2020-02-29' AS ""dt"" UNION SELECT '2020-03-31' AS ""dt"" UNION SELECT '2020-04-30' AS ""dt"" UNION SELECT '2020-05-31' AS ""dt"" UNION SELECT '2020-06-30' AS ""dt"" UNION SELECT '2020-07-31' AS ""dt"" UNION SELECT '2020-08-31' AS ""dt"" UNION SELECT '2020-09-30' AS ""dt"" UNION SELECT '2020-10-31' AS ""dt"" UNION SELECT '2020-11-30' AS ""dt"" UNION SELECT '2020-12-31' AS ""dt""), ""available_drivers"" AS (SELECT EXTRACT(MONTH FROM ""m"".""dt"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""num_drivers"" FROM ""months_2020"" AS ""m"" JOIN ""Drivers"" AS ""d"" ON ""d"".""join_date""<=""m"".""dt"" GROUP BY EXTRACT(MONTH FROM ""m"".""dt"")), ""working_drivers"" AS (SELECT EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""num_drivers"" FROM ""AcceptedRides"" AS ""a"" JOIN ""Rides"" AS ""r"" ON ""a"".""ride_id""=""r"".""ride_id"" WHERE EXTRACT(YEAR FROM ""r"".""requested_at"")=2020 GROUP BY EXTRACT(MONTH FROM ""r"".""requested_at"")) SELECT EXTRACT(MONTH FROM ""m"".""dt"") AS ""month"",COALESCE(CASE WHEN ""ad"".""num_drivers""=0 THEN 0.00 ELSE ROUND(100*""wd"".""num_drivers""/""ad"".""num_drivers"", 2) END, 0) AS ""working_percentage"" FROM (""months_2020"" AS ""m"" LEFT JOIN ""working_drivers"" AS ""wd"" ON EXTRACT(MONTH FROM ""m"".""dt"")=""wd"".""month"") LEFT JOIN ""available_drivers"" AS ""ad"" ON EXTRACT(MONTH FROM ""m"".""dt"")=""ad"".""month"" ORDER BY EXTRACT(MONTH FROM ""m"".""dt"")"
104,"WITH ""end_month"" (""d"") AS (SELECT DATE('2020-01-31') UNION SELECT DATE('2020-02-29') UNION SELECT DATE('2020-03-31') UNION SELECT DATE('2020-04-30') UNION SELECT DATE('2020-05-31') UNION SELECT DATE('2020-06-30') UNION SELECT DATE('2020-07-31') UNION SELECT DATE('2020-08-31') UNION SELECT DATE('2020-09-30') UNION SELECT DATE('2020-10-31') UNION SELECT DATE('2020-11-30') UNION SELECT DATE('2020-12-31')) SELECT ""a"".""month"",COALESCE(ROUND(100*""b"".""ct""/""a"".""ct"", 2), 0) AS ""working_percentage"" FROM (SELECT EXTRACT(MONTH FROM ""d"") AS ""month"",SUM(CASE WHEN ""driver_id"" IS NOT NULL THEN 1 ELSE 0 END) AS ""ct"" FROM ""end_month"" AS ""e"" LEFT JOIN ""Drivers"" AS ""d"" ON ""e"".""d"">=""d"".""join_date"" GROUP BY EXTRACT(MONTH FROM ""d"")) AS ""a"" LEFT JOIN (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""a"".""driver_id"") AS ""ct"" FROM ((""Rides"" AS ""r"") JOIN ""AcceptedRides"" AS ""a"") JOIN ""Drivers"" AS ""d"" WHERE ""d"".""driver_id""=""a"".""driver_id"" AND ""r"".""ride_id""=""a"".""ride_id"" AND ""r"".""requested_at"">=""d"".""join_date"" AND EXTRACT(YEAR FROM ""r"".""requested_at"")=2020 AND EXTRACT(YEAR FROM ""d"".""join_date"")<=2020 GROUP BY EXTRACT(MONTH FROM ""requested_at"")) AS ""b"" ON ""a"".""month""=""b"".""month"" ORDER BY ""a"".""month"""
105,"WITH RECURSIVE ""CTE1"" AS (SELECT 1 AS ""month"" UNION ALL SELECT 1+""month"" FROM ""CTE1"" WHERE 1+""month""<=12), ""CTE2"" AS (SELECT ""driver_id"",CASE WHEN EXTRACT(YEAR FROM ""join_date"")<2020 THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""month"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020), ""CTE3"" AS (SELECT ""CTE1"".""month"",COUNT(""CTE2"".""driver_id"") OVER (ORDER BY ""CTE1"".""month"") AS ""active_drivers"" FROM ""CTE1"" LEFT JOIN ""CTE2"" ON ""CTE1"".""month""=""CTE2"".""month""), ""CTE4"" AS (SELECT EXTRACT(MONTH FROM ""R"".""requested_at"") AS ""month"",""A"".""driver_id"" FROM (""Rides"" AS ""R"") JOIN ""AcceptedRIdes"" AS ""A"" WHERE ""R"".""ride_id""=""A"".""ride_id"" AND EXTRACT(YEAR FROM ""R"".""requested_at"")=2020), ""CTE5"" AS (SELECT ""CTE1"".""month"",COUNT(DISTINCT ""CTE4"".""driver_id"") AS ""accepted_rides"" FROM ""CTE1"" LEFT JOIN ""CTE4"" ON ""CTE1"".""month""=""CTE4"".""month"" GROUP BY ""CTE1"".""month"") SELECT DISTINCT ""CTE3"".""month"",ROUND(COALESCE(100*""CTE5"".""accepted_rides""/""CTE3"".""active_drivers"", 0), 2) AS ""working_percentage"" FROM (""CTE5"") JOIN ""CTE3"" WHERE ""CTE5"".""month""=""CTE3"".""month"""
106,"WITH RECURSIVE ""Date_Ranges"" AS (SELECT '2019-01-01' AS ""Date"" UNION ALL SELECT ""Date"" + INTERVAL '1 MONTH' FROM ""Date_Ranges"" WHERE ""Date""<'2021-01-01'), ""Drivers_Available"" AS (SELECT ""join_date"",COUNT(DISTINCT (""driver_id"")) AS ""joiners"" FROM (SELECT ""driver_id"",TO_CHAR(""join_date"", 'YYYY-%m') AS ""join_date"" FROM ""Drivers"") AS ""q"" GROUP BY ""q"".""join_date""), ""Drivers_Accepted"" AS (SELECT ""ride_date"",COUNT(DISTINCT (""driver_id"")) AS ""driver_count"" FROM (SELECT ""ar"".""ride_id"",""ar"".""driver_id"",TO_CHAR(""r"".""requested_at"", 'YYYY-%m') AS ""ride_date"" FROM ""AcceptedRides"" AS ""ar"" LEFT JOIN ""Rides"" AS ""r"" ON ""r"".""ride_id""=""ar"".""ride_id"") AS ""q"" GROUP BY ""q"".""ride_date"") SELECT RANK() OVER (ORDER BY ""p"".""Date"") AS ""month"",ROUND(COALESCE(100*""p"".""active_drivers""/""p"".""drivers_available"", 0), 2) AS ""working_percentage"" FROM (SELECT ""q"".""Date"",SUM(""q"".""joiners"") OVER (ORDER BY ""Date"") AS ""drivers_available"",COALESCE(""driv_acc"".""driver_count"", 0) AS ""active_drivers"" FROM (SELECT ""dr"".""Date"",COALESCE(""da"".""joiners"", 0) AS ""joiners"" FROM ""Date_Ranges"" AS ""dr"" LEFT JOIN ""Drivers_Available"" AS ""da"" ON TO_CHAR(""dr"".""Date"", 'YYYY-%m')=""da"".""join_date"") AS ""q"" LEFT JOIN ""Drivers_Accepted"" AS ""driv_acc"" ON TO_CHAR(""q"".""Date"", 'YYYY-%m')=""driv_acc"".""ride_date"") AS ""p"" WHERE ""p"".""Date"">='2020-01-01' AND ""p"".""Date""<='2020-12-31'"
107,"WITH RECURSIVE ""months"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""months"" WHERE ""month""<12), ""available_drivers"" AS (SELECT ""months"".""month"",COALESCE(MAX(""t1"".""active_driver"") OVER (ORDER BY ""month""), 0) AS ""active_driver"" FROM ""months"" LEFT JOIN (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(""driver_id"") OVER (ORDER BY ""join_date"" ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS ""active_driver"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020) AS ""t1"" ON ""t1"".""month""=""months"".""month""), ""working_drivers"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""working_driver"" FROM ""Rides"" AS ""R"" JOIN ""AcceptedRides"" AS ""A"" ON ""R"".""ride_id""=""A"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY 1) SELECT ""months"".""month"",COALESCE(ROUND(""working_driver""/""active_driver""*100, 2), 0) AS ""working_percentage"" FROM (""months"" LEFT JOIN ""available_drivers"" ON ""available_drivers"".""month""=""months"".""month"") LEFT JOIN ""working_drivers"" ON ""working_drivers"".""month""=""months"".""month"" GROUP BY 1"
108,"WITH RECURSIVE ""m"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""m"" WHERE ""month""<12), ""ad"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",""driver_id"" FROM ""AcceptedRides"" JOIN ""Rides"" USING (""ride_id"") WHERE EXTRACT(YEAR FROM ""requested_at"")=2020), ""d"" AS (SELECT CASE WHEN EXTRACT(YEAR FROM ""join_date"")<=2019 THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""month"",""driver_id"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020) SELECT ""m"".""month"",ROUND(COALESCE(COUNT(DISTINCT ""ad"".""driver_id"")/SUM(COUNT(DISTINCT ""d"".""driver_id"")) OVER (ORDER BY ""m"".""month"")*100, 0), 2) AS ""working_percentage"" FROM (""m"" LEFT JOIN ""ad"" ON ""m"".""month""=""ad"".""month"") LEFT JOIN ""d"" ON ""m"".""month""=""d"".""month"" GROUP BY 1"
109,"WITH RECURSIVE ""months"" (""month"") AS (SELECT 1 UNION ALL SELECT ""month""+1 FROM ""months"" WHERE ""month""<12), ""t1"" AS (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(""driver_id"") OVER (ORDER BY ""join_date"") AS ""active_drivers"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020), ""t2"" AS (SELECT EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""month"",COUNT(DISTINCT ""ar"".""driver_id"") AS ""drivers_accepted"" FROM ""AcceptedRides"" AS ""ar"" JOIN ""Rides"" AS ""r"" ON ""ar"".""ride_id""=""r"".""ride_id"" WHERE EXTRACT(YEAR FROM ""r"".""requested_at"")=2020 GROUP BY ""month"") SELECT DISTINCT ""m"".""month"",ROUND(COALESCE(""drivers_accepted""/MAX(""t1"".""active_drivers"") OVER (ORDER BY ""m"".""month"")*100, 0), 2) AS ""working_percentage"" FROM (""months"" AS ""m"" LEFT JOIN ""t1"" ON ""m"".""month""=""t1"".""month"") LEFT JOIN ""t2"" ON ""m"".""month""=""t2"".""month"""
110,"WITH RECURSIVE ""months"" AS (SELECT 1 AS ""Month"" UNION ALL SELECT ""Month""+1 FROM ""months"" WHERE ""Month""<12), ""AvailableDrivers"" AS (SELECT ""M1"".""Month"",COUNT(""D1"".""driver_id"") AS ""AvailableDriversCNT"" FROM ""months"" AS ""M1"" LEFT JOIN (SELECT * FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020) AS ""D1"" ON ""M1"".""Month"">=EXTRACT(MONTH FROM ""D1"".""join_date"") OR EXTRACT(YEAR FROM ""D1"".""join_date"")<2020 GROUP BY ""Month""), ""WorkingDrivers"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""Month"",COUNT(DISTINCT ""T1"".""driver_id"") AS ""WorkingDriversCNT"" FROM ""AcceptedRides"" AS ""T1"" JOIN ""Rides"" AS ""T2"" ON ""T1"".""ride_id""=""T2"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY EXTRACT(MONTH FROM ""requested_at"") ORDER BY ""Month"") SELECT ""T1"".""Month"",ROUND(COALESCE(""WorkingDriversCNT""/""AvailableDriversCNT"", 0)*100, 2) AS ""working_percentage"" FROM ""AvailableDrivers"" AS ""T1"" LEFT JOIN ""WorkingDrivers"" AS ""T2"" ON ""T1"".""Month""=""T2"".""Month"" ORDER BY ""T1"".""Month"""
111,"WITH RECURSIVE ""t"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""t"" WHERE ""month""<12), ""t2"" AS (SELECT *,CASE WHEN EXTRACT(YEAR FROM ""join_date"")<2020 THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""month"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020), ""t3"" AS (SELECT ""r"".*,EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""month"",""a"".""driver_id"" FROM ""rides"" AS ""r"" JOIN ""acceptedrides"" AS ""a"" ON ""r"".""ride_id""=""a"".""ride_id"" WHERE EXTRACT(YEAR FROM ""r"".""requested_at"")=2020), ""t4"" AS (SELECT ""month"",COUNT(DISTINCT ""driver_id"") AS ""work_cnt"" FROM ""t3"" GROUP BY ""month""), ""t5"" AS (SELECT ""t"".""month"",SUM(COALESCE(COUNT(DISTINCT ""t2"".""driver_id""), 0)) OVER (ORDER BY ""month"") AS ""cnt"" FROM ""t"" LEFT JOIN ""t2"" ON ""t"".""month""=""t2"".""month"" GROUP BY ""month"") SELECT ""t"".""month"",COALESCE(ROUND((COALESCE(""t4"".""work_cnt"", 0))*100/(""t5"".""cnt""), 2), 0.00) AS ""working_percentage"" FROM (""t"" LEFT JOIN ""t4"" ON ""t"".""month""=""t4"".""month"") LEFT JOIN ""t5"" ON ""t"".""month""=""t5"".""month"""
112,"WITH RECURSIVE ""T1"" AS (SELECT 1 AS ""join_month"" UNION SELECT ""join_month""+1 FROM ""T1"" WHERE ""join_month""<12), ""T2"" AS (SELECT CASE WHEN EXTRACT(YEAR FROM ""join_date"")<'2020' THEN '1' ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""join_month"",COUNT(""driver_id"") AS ""driver_num"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<='2020' GROUP BY ""join_month""), ""T3"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""join_month"",COUNT(DISTINCT ""ar"".""driver_id"") AS ""ride_num"" FROM ""AcceptedRides"" AS ""ar"" LEFT JOIN ""Rides"" AS ""r"" ON ""ar"".""ride_id""=""r"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")='2020' GROUP BY ""join_month"") SELECT ""T1"".""join_month"" AS ""month"",ROUND(100*COALESCE(""T3"".""ride_num""/SUM(""T2"".""driver_num""), 0), 2) AS ""working_percentage"" FROM (""T1"" LEFT JOIN ""T2"" ON ""T1"".""join_month"">=""T2"".""join_month"") LEFT JOIN ""T3"" ON ""T1"".""join_month""=""T3"".""join_month"" GROUP BY ""T1"".""join_month"" ORDER BY ""T1"".""join_month"""
113,"WITH RECURSIVE ""months"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 AS ""month"" FROM ""months"" WHERE ""month""<12), ""drivers_updateMonth"" AS (SELECT ""driver_id"",CASE WHEN EXTRACT(YEAR FROM ""join_date"")<2020 THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""join_month"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<2021), ""drivers_counted"" AS (SELECT ""join_month"",COUNT(1) AS ""active_drivers"" FROM ""drivers_updateMonth"" GROUP BY ""join_month""), ""ride_driver"" AS (SELECT ""a"".""ride_id"",""a"".""driver_id"",EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""month"" FROM ""AcceptedRides"" AS ""a"" LEFT JOIN ""Rides"" AS ""r"" ON ""a"".""ride_id""=""r"".""ride_id"" WHERE EXTRACT(YEAR FROM ""r"".""requested_at"")=2020), ""ride_driver_final"" AS (SELECT ""month"",COUNT(DISTINCT ""driver_id"") AS ""active_driver"" FROM ""ride_driver"" GROUP BY ""month""), ""final_prev"" AS (SELECT ""m"".""month"",COALESCE(""rf"".""active_driver"", 0) AS ""adriver"" FROM ""months"" AS ""m"" LEFT JOIN ""ride_driver_final"" AS ""rf"" ON ""m"".""month""=""rf"".""month""), ""final_prev2"" AS (SELECT ""f"".*,COALESCE(""active_drivers"", 0) AS ""active_drive"" FROM ""final_prev"" AS ""f"" LEFT JOIN ""drivers_counted"" AS ""dc"" ON ""f"".""month""=""dc"".""join_month""), ""final_prev3"" AS (SELECT ""month"",""adriver"",SUM(""active_drive"") OVER (ORDER BY ""month"") AS ""n_active_driver"" FROM ""final_prev2"" AS ""f2"") SELECT ""month"",ROUND(COALESCE((""adriver""/""n_active_driver"")*100, 0), 2) AS ""working_percentage"" FROM ""final_prev3"""
114,"WITH RECURSIVE ""tbMonth"" AS (SELECT 2020*100+1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""tbMonth"" WHERE ""month""<2020*100+12), ""tbWorkingD"" AS (SELECT 2020*100+EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""month"",COUNT(DISTINCT ""ar"".""driver_id"") AS ""cnt_working_drivers"" FROM ""AcceptedRides"" AS ""ar"" JOIN ""rides"" AS ""r"" ON ""ar"".""ride_id""=""r"".""ride_id"" WHERE EXTRACT(YEAR FROM ""r"".""requested_at"")=2020 GROUP BY EXTRACT(MONTH FROM ""r"".""requested_at"")), ""tbAvailableD"" AS (SELECT ""tbMonth"".""month"",COUNT(DISTINCT ""d"".""driver_id"") AS ""cnt_available_drivers"" FROM ""tbMonth"" LEFT JOIN ""drivers"" AS ""d"" ON EXTRACT(YEAR FROM ""d"".""join_date"")*100+EXTRACT(MONTH FROM ""d"".""join_date"")<=""tbMonth"".""month"" GROUP BY ""tbMonth"".""month"") SELECT ""tbAvailableD"".""month""%100 AS ""month"",ROUND(COALESCE(""tbWorkingD"".""cnt_working_drivers""/""tbAvailableD"".""cnt_available_drivers"", 0)*100, 2) AS ""working_percentage"" FROM ""tbAvailableD"" LEFT JOIN ""tbWorkingD"" ON ""tbWorkingD"".""month""=""tbAvailableD"".""month"""
115,"WITH RECURSIVE ""CTE"" AS (SELECT 1 AS ""month"" UNION SELECT ""month""+1 FROM ""CTE"" WHERE ""month""<12), ""Available_Drivers"" AS (SELECT ""month"",SUM(""drivers"") OVER (ORDER BY ""month"") AS ""drivers"" FROM (SELECT ""c"".""month"",COALESCE(""a"".""drivers"", 0) AS ""drivers"" FROM ""CTE"" AS ""c"" LEFT JOIN (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(""driver_id"") AS ""drivers"" FROM ""Drivers"" WHERE ""join_date"" BETWEEN '2020-1-1' AND '2020-12-31' GROUP BY 1) AS ""a"" ON ""c"".""month""=""a"".""month"" UNION SELECT 0 AS ""month"",COUNT(""driver_id"") AS ""drivers"" FROM ""Drivers"" WHERE ""join_date""<'2020-1-1') AS ""accumulated_drivers""), ""Accepted_Drivers"" AS (SELECT ""c"".""month"",COALESCE(""ac"".""acpt_drivers"", 0) AS ""acpt_drivers"" FROM ""CTE"" AS ""c"" LEFT JOIN (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""acpt_drivers"" FROM (SELECT ""A"".""ride_id"",""A"".""driver_id"",""R"".""requested_at"" FROM ""AcceptedRides"" AS ""A"" JOIN ""Rides"" AS ""R"" ON ""A"".""ride_id""=""R"".""ride_id"" WHERE ""R"".""requested_at"" BETWEEN '2020-1-1' AND '2020-12-31') AS ""Accepted"" GROUP BY 1) AS ""ac"" ON ""c"".""month""=""ac"".""month"") SELECT ""avd"".""month"" AS ""month"",ROUND(COALESCE(""acd"".""acpt_drivers""/""avd"".""drivers"", 0)*100, 2) AS ""working_percentage"" FROM ""Available_Drivers"" AS ""avd"" JOIN ""Accepted_Drivers"" AS ""acd"" ON ""avd"".""month""=""acd"".""month"""
116,"WITH ""active_drivers_per_recorded_months"" AS (SELECT ""temp2"".""month"" AS ""month"",""temp2"".""number_of_active_drivers"" AS ""number_of_active_drivers"" FROM (SELECT ""temp"".""month"" AS ""month"",""temp"".""join_year"" AS ""join_year"",SUM(""number_of_drivers_joined_in_month"") OVER (ORDER BY ""join_year"",""month"") AS ""number_of_active_drivers"" FROM (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",EXTRACT(YEAR FROM ""join_date"") AS ""join_year"",COUNT(DISTINCT ""driver_id"") AS ""number_of_drivers_joined_in_month"" FROM ""Drivers"" GROUP BY 1,2) AS ""temp"") AS ""temp2"" WHERE ""temp2"".""join_year""=2020), ""drivers_in_all_months"" AS (SELECT ""temp"".""month"" AS ""month"",COALESCE(""ad"".""number_of_active_drivers"", 0) AS ""number_of_active_drivers"" FROM (SELECT 1 AS ""month"" UNION SELECT 2 AS ""month"" UNION SELECT 3 AS ""month"" UNION SELECT 4 AS ""month"" UNION SELECT 5 AS ""month"" UNION SELECT 6 AS ""month"" UNION SELECT 7 AS ""month"" UNION SELECT 8 AS ""month"" UNION SELECT 9 AS ""month"" UNION SELECT 10 AS ""month"" UNION SELECT 11 AS ""month"" UNION SELECT 12 AS ""month"") AS ""temp"" LEFT JOIN ""active_drivers_per_recorded_months"" AS ""ad"" ON ""temp"".""month""=""ad"".""month"" ORDER BY 1), ""active_drivers_in_all_months"" AS (SELECT ""temp2"".""month"" AS ""month"",MAX(""number_of_active_drivers"") OVER (PARTITION BY ""temp2"".""grouping_variable"") AS ""number_of_active_drivers"" FROM (SELECT *,MAX(""temp"".""relevant_month"") OVER (ORDER BY ""month"" ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS ""grouping_variable"" FROM (SELECT *,CASE WHEN ""number_of_active_drivers""=0 THEN 0 ELSE ""month"" END AS ""relevant_month"" FROM ""drivers_in_all_months"") AS ""temp"") AS ""temp2""), ""rides_accepted_per_month"" AS (SELECT ""temp2"".""month"" AS ""month"",""temp2"".""number_of_rides_accepted"" AS ""number_of_rides_accepted"" FROM (SELECT ""temp"".""month"" AS ""month"",""temp"".""requested_year"" AS ""requested_year"",COUNT(DISTINCT ""temp"".""driver_id"") AS ""number_of_rides_accepted"" FROM (SELECT ""r"".""ride_id"" AS ""ride_id"",EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""month"",EXTRACT(YEAR FROM ""r"".""requested_at"") AS ""requested_year"",""ar"".""driver_id"" AS ""driver_id"" FROM ""Rides"" AS ""r"" LEFT JOIN ""AcceptedRides"" AS ""ar"" ON ""r"".""ride_id""=""ar"".""ride_id"") AS ""temp"" GROUP BY 1,2) AS ""temp2"" WHERE ""temp2"".""requested_year""=2020) SELECT ""temp"".""month"" AS ""month"",CASE WHEN ""temp"".""number_of_active_drivers""=0 THEN 0 ELSE ROUND(""temp"".""number_of_rides_accepted""/""temp"".""number_of_active_drivers""*100, 2) END AS ""working_percentage"" FROM (SELECT ""a"".""month"" AS ""month"",""a"".""number_of_active_drivers"" AS ""number_of_active_drivers"",CASE WHEN ""r"".""number_of_rides_accepted"" IS NULL THEN 0 ELSE ""r"".""number_of_rides_accepted"" END AS ""number_of_rides_accepted"" FROM ""active_drivers_in_all_months"" AS ""a"" LEFT JOIN ""rides_accepted_per_month"" AS ""r"" ON ""a"".""month""=""r"".""month"") AS ""temp"" ORDER BY 1"
117,"WITH RECURSIVE ""month_tbl"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 AS ""month"" FROM ""month_tbl"" WHERE ""month""<12), ""driver_tbl"" AS (SELECT CASE WHEN EXTRACT(YEAR FROM ""join_date"")=2019 THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""month"",COUNT(""driver_id"") AS ""driver_nums"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<2021 GROUP BY 1), ""ride_tbl"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""ride_nums"" FROM ""Rides"" AS ""r"" JOIN ""AcceptedRides"" AS ""a"" ON ""r"".""ride_id""=""a"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY 1) SELECT ""m"".""month"" AS ""month"",ROUND(COALESCE((""ride_nums""/SUM(""driver_nums"") OVER (ORDER BY ""month"")), 0)*100, 2) AS ""working_percentage"" FROM (""month_tbl"" AS ""m"" LEFT JOIN ""driver_tbl"" AS ""d"" ON ""m"".""month""=""d"".""month"") LEFT JOIN ""ride_tbl"" AS ""r"" ON ""m"".""month""=""r"".""month"""
118,"WITH ""month"" AS (SELECT 1 AS ""month"" UNION SELECT 2 AS ""month"" UNION SELECT 3 AS ""month"" UNION SELECT 4 AS ""month"" UNION SELECT 5 AS ""month"" UNION SELECT 6 AS ""month"" UNION SELECT 7 AS ""month"" UNION SELECT 8 AS ""month"" UNION SELECT 9 AS ""month"" UNION SELECT 10 AS ""month"" UNION SELECT 11 AS ""month"" UNION SELECT 12 AS ""month"") SELECT ""d1"".""month"",ROUND(COALESCE(""d3"".""accept_ride""/""d2"".""available_driver"", 0)*100, 2) AS ""working_percentage"" FROM (""month"" AS ""d1"" LEFT JOIN (SELECT ""a"".""month"",COUNT(DISTINCT ""b"".""driver_id"") AS ""available_driver"" FROM ""month"" AS ""a"" JOIN ""Drivers"" AS ""b"" ON ""b"".""join_date""<=LAST_DAY(DATE(CONCAT('2020-', ""a"".""month"", '-1'))) GROUP BY ""a"".""month"") AS ""d2"" ON ""d1"".""month""=""d2"".""month"") LEFT JOIN (SELECT ""a"".""month"",COUNT(DISTINCT ""c"".""driver_id"") AS ""accept_ride"" FROM (""month"" AS ""a"" JOIN ""Rides"" AS ""b"" ON ""b"".""requested_at"" BETWEEN DATE(CONCAT('2020-', ""a"".""month"", '-1')) AND LAST_DAY(DATE(CONCAT('2020-', ""a"".""month"", '-1')))) JOIN ""AcceptedRides"" AS ""c"" ON ""b"".""ride_id""=""c"".""ride_id"" GROUP BY ""a"".""month"") AS ""d3"" ON ""d1"".""month""=""d3"".""month"" ORDER BY ""month"""
119,"WITH RECURSIVE ""cte"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""cte"" WHERE ""month""<12) SELECT ""cte"".""month"",COALESCE(ROUND(100.0*COUNT(DISTINCT ""r"".""driver_id"")/COUNT(DISTINCT ""d"".""driver_id""), 2), 0) AS ""working_percentage"" FROM (""cte"" LEFT JOIN ""drivers"" AS ""d"" ON ""d"".""join_date""<'2021-01-01' AND STR_TO_DATE(CONCAT('2020-', ""cte"".""month"", '-01'), '%Y-%m-%d')>=TO_CHAR(""d"".""join_date"", 'YYYY-%m-01')) LEFT JOIN (SELECT ""a"".""driver_id"",TO_CHAR(""requested_at"", 'YYYY-%m-01') AS ""ride_month"",COUNT(1) AS ""rides"" FROM ""acceptedrides"" AS ""a"" JOIN ""rides"" AS ""r"" ON ""r"".""ride_id""=""a"".""ride_id"" AND EXTRACT(YEAR FROM ""r"".""requested_at"")='2020' GROUP BY 1,2) AS ""r"" ON ""r"".""driver_id""=""d"".""driver_id"" AND STR_TO_DATE(CONCAT('2020-', ""cte"".""month"", '-01'), '%Y-%m-%d')=""ride_month"" GROUP BY ""cte"".""month"""
120,"WITH RECURSIVE ""cal"" AS (SELECT LEAST(MIN(""join_date""), DATE('2020-01-01')) AS ""jdate"",EXTRACT(YEAR FROM LEAST(MIN(""join_date""), DATE('2020-01-01'))) AS ""years"",EXTRACT(MONTH FROM LEAST(MIN(""join_date""), DATE('2020-01-01'))) AS ""months"",DATE('2020-12-01') AS ""maxdate"" FROM ""drivers"" UNION ALL SELECT ""jdate"" + INTERVAL '1 MONTH' AS ""jdate"",EXTRACT(YEAR FROM ""jdate"" + INTERVAL '1 MONTH') AS ""years"",EXTRACT(MONTH FROM ""jdate"" + INTERVAL '1 MONTH') AS ""months"",""maxdate"" FROM ""cal"" WHERE ""jdate""<""maxdate""), ""a"" AS (SELECT EXTRACT(YEAR FROM ""join_date"") AS ""years"",EXTRACT(MONTH FROM ""join_date"") AS ""months"",""driver_id"" FROM ""Drivers"" WHERE ""join_date""<DATE('2021-01-01')), ""b"" AS (SELECT ""months"",""tot_av_drivers"" FROM (SELECT ""years"",""months"",SUM(""mt"") OVER (ORDER BY ""years"",""months"") AS ""tot_av_drivers"" FROM (SELECT ""years"",""months"",COUNT(""driver_id"") AS ""mt"" FROM (SELECT ""c"".""years"",""c"".""months"",""driver_id"" FROM ""cal"" AS ""c"" LEFT JOIN ""a"" USING (""years"",""months"")) AS ""t1"" GROUP BY 1,2) AS ""t2"") AS ""t3"" WHERE ""years"">2019), ""c"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""months"",COUNT(DISTINCT ""AcceptedRides"".""driver_id"") AS ""tot_accept_drivers"" FROM ""AcceptedRides"" JOIN ""Rides"" USING (""ride_id"") WHERE ""requested_at"">DATE('2019-12-31') AND ""requested_at""<=DATE('2020-12-31') GROUP BY 1) SELECT ""b"".""months"" AS ""month"",ROUND(100*ROUND(CASE WHEN ""tot_accept_drivers"" IS NULL THEN 0 ELSE ""tot_accept_drivers"" END/CASE WHEN ""tot_av_drivers""=0 THEN 1 ELSE ""tot_av_drivers"" END, 4), 5) AS ""working_percentage"" FROM ""B"" LEFT JOIN ""c"" USING (""months"")"
121,"WITH RECURSIVE ""months"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""months"" WHERE ""month""<12), ""available_drivers"" AS (SELECT ""months"".""month"",COALESCE(MAX(""t1"".""active_driver"") OVER (ORDER BY ""month""), 0) AS ""active_driver"" FROM ""months"" LEFT JOIN (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(""driver_id"") OVER (ORDER BY ""join_date"" ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS ""active_driver"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020) AS ""t1"" ON ""t1"".""month""=""months"".""month""), ""working_drivers"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""working_driver"" FROM ""Rides"" AS ""R"" JOIN ""AcceptedRides"" AS ""A"" ON ""R"".""ride_id""=""A"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY 1) SELECT ""months"".""month"",COALESCE(ROUND(""working_driver""/""active_driver""*100, 2), 0) AS ""working_percentage"" FROM (""months"" LEFT JOIN ""available_drivers"" ON ""available_drivers"".""month""=""months"".""month"") LEFT JOIN ""working_drivers"" ON ""working_drivers"".""month""=""months"".""month"" GROUP BY 1"
122,"WITH RECURSIVE ""CTE1"" AS (SELECT 1 AS ""month"" UNION SELECT 1+""month"" FROM ""CTE1"" WHERE ""month""<12), ""CTE2"" AS (SELECT ""driver_id"",CASE WHEN ""join_date""<='2020-1-31' THEN 1 WHEN ""join_date""<='2020-2-29' THEN 2 WHEN ""join_date""<='2020-3-31' THEN 3 WHEN ""join_date""<='2020-4-30' THEN 4 WHEN ""join_date""<='2020-5-31' THEN 5 WHEN ""join_date""<='2020-6-30' THEN 6 WHEN ""join_date""<='2020-7-31' THEN 7 WHEN ""join_date""<='2020-8-31' THEN 8 WHEN ""join_date""<='2020-9-30' THEN 9 WHEN ""join_date""<='2020-10-31' THEN 10 WHEN ""join_date""<='2020-11-30' THEN 11 WHEN ""join_date""<='2020-12-31' THEN 12 END AS ""earliest_active_month"" FROM ""Drivers"" WHERE ""join_date""<='2020-12-31'), ""CTE3"" AS (SELECT ""earliest_active_month"",COUNT(DISTINCT ""driver_id"") AS ""new_driver_count"" FROM ""CTE2"" GROUP BY ""earliest_active_month""), ""CTE4"" AS (SELECT ""CTE1"".""month"",COALESCE(""new_driver_count"", 0) AS ""new_driver_count"" FROM ""CTE1"" LEFT JOIN ""CTE3"" ON ""CTE1"".""month""=""CTE3"".""earliest_active_month""), ""CTE5"" AS (SELECT ""month"",COALESCE(SUM(""new_driver_count"") OVER (ORDER BY ""month""), 0) AS ""active_driver_count"" FROM ""CTE4""), ""CTE6"" AS (SELECT EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""month"",COUNT(DISTINCT ""a"".""driver_id"") AS ""accepted_driver_count"" FROM ""AcceptedRides"" AS ""a"" JOIN ""Rides"" AS ""r"" ON ""a"".""ride_id""=""r"".""ride_id"" WHERE ""r"".""requested_at"">='2020-01-01' AND ""r"".""requested_at""<='2020-12-31' GROUP BY EXTRACT(MONTH FROM ""r"".""requested_at"")), ""CTE7"" AS (SELECT ""CTE1"".""month"",COALESCE(""CTE6"".""accepted_driver_count"", 0) AS ""accepted_driver_count"" FROM ""CTE1"" LEFT JOIN ""CTE6"" ON ""CTE1"".""month""=""CTE6"".""month"") SELECT ""CTE7"".""month"",CASE WHEN ""CTE5"".""active_driver_count""=0 THEN 0 ELSE ROUND(100*""CTE7"".""accepted_driver_count""/""CTE5"".""active_driver_count"", 2) END AS ""working_percentage"" FROM ""CTE7"" LEFT JOIN ""CTE5"" ON ""CTE7"".""month""=""CTE5"".""month"" ORDER BY ""CTE7"".""month"""
123,"WITH RECURSIVE ""months"" (""month"") AS (SELECT 1 UNION ALL SELECT ""month""+1 FROM ""months"" WHERE ""month""<12), ""t1"" AS (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(""driver_id"") OVER (ORDER BY ""join_date"") AS ""cnt"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020), ""t2"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""a"".""driver_id"") AS ""cnt"" FROM ""Rides"" AS ""r"" JOIN ""AcceptedRides"" AS ""a"" ON ""r"".""ride_id""=""a"".""ride_id"" WHERE EXTRACT(YEAR FROM ""r"".""requested_at"")=2020 GROUP BY EXTRACT(MONTH FROM ""requested_at"")) SELECT DISTINCT ""m"".""month"",ROUND(CASE WHEN ""t2"".""cnt"" IS NULL THEN 0 ELSE ""t2"".""cnt""/COALESCE(MAX(""t1"".""cnt"") OVER (ORDER BY ""m"".""month""), 0)*100 END, 2) AS ""working_percentage"" FROM (""months"" AS ""m"" LEFT JOIN ""t1"" ON ""m"".""month""=""t1"".""month"") LEFT JOIN ""t2"" ON ""m"".""month""=""t2"".""month"""
124,"WITH RECURSIVE ""months"" AS (SELECT 1 AS ""m"" UNION ALL SELECT ""m""+1 FROM ""months"" WHERE ""m""<12), ""available_drivers"" AS (SELECT ""mo"".""m"",COUNT(""d"".""driver_id"") AS ""cnt"" FROM ""months"" AS ""mo"" LEFT JOIN ""Drivers"" AS ""d"" ON CAST(CONCAT('2020-', ""mo"".""m"", '-01') AS DATE)>=LAST_DAY(""d"".""join_date"") + INTERVAL '1 DAY' + INTERVAL '-1 MONTH' GROUP BY ""mo"".""m"") SELECT ""ad"".""m"" AS ""month"",ROUND(COALESCE(COUNT(DISTINCT ""ar"".""driver_id"")/NULLIF(""ad"".""cnt"", 0), 0)*100.0, 2) AS ""working_percentage"" FROM ""available_drivers"" AS ""ad"" LEFT JOIN (""AcceptedRides"" AS ""ar"" JOIN ""Rides"" AS ""r"" ON ""ar"".""ride_id""=""r"".""ride_id"") ON ""ad"".""m""=EXTRACT(MONTH FROM ""r"".""requested_at"") AND EXTRACT(YEAR FROM ""r"".""requested_at"")=2020 GROUP BY ""ad"".""m"",""ad"".""cnt"""
125,"WITH RECURSIVE ""active_driver"" AS (SELECT ""driver_id"",""join_date"",""join_date"" AS ""dur"" FROM ""drivers"" UNION SELECT ""driver_id"",""join_date"",""dur"" + INTERVAL '1 MONTH' AS ""dur"" FROM ""active_driver"" WHERE ""dur""<LAST_DAY(CURDATE()) + INTERVAL '1 MONTH'), ""datedim"" AS (SELECT 1 AS ""m"" UNION SELECT ""m""+1 FROM ""datedim"" WHERE ""m""<12) SELECT ""m"" AS ""month"",ROUND(COALESCE(""wd"".""working_driver"", 0)*100/COALESCE(""ad"".""monthly_ad"", 1), 2) AS ""working_percentage"" FROM (""datedim"" AS ""dd"" LEFT JOIN (SELECT EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""month"",COUNT(DISTINCT ""ar"".""driver_id"") AS ""working_driver"" FROM ""acceptedrides"" AS ""ar"" JOIN ""rides"" AS ""r"" ON ""r"".""ride_id""=""ar"".""ride_id"" WHERE EXTRACT(YEAR FROM ""r"".""requested_at"")=2020 GROUP BY EXTRACT(MONTH FROM ""r"".""requested_at"")) AS ""wd"" ON ""wd"".""month""=""dd"".""m"") LEFT JOIN (SELECT EXTRACT(MONTH FROM ""dur"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""monthly_ad"" FROM ""active_driver"" WHERE EXTRACT(YEAR FROM ""dur"")=2020 GROUP BY EXTRACT(MONTH FROM ""dur"")) AS ""ad"" ON ""ad"".""month""=""dd"".""m"""
126,"WITH RECURSIVE ""AllMonths"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 AS ""month"" FROM ""AllMonths"" WHERE ""month""<12), ""DriversActiveSince"" AS (SELECT ""driver_id"",CASE WHEN EXTRACT(YEAR FROM ""join_date"")<2020 THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""Month"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020), ""ActiveDriversMonths"" AS (SELECT ""AM"".""Month"",COUNT(""DAS"".""driver_id"") AS ""new_active_drivers"" FROM ""DriversActiveSince"" AS ""DAS"" RIGHT JOIN ""AllMonths"" AS ""AM"" ON ""AM"".""month""=""DAS"".""month"" GROUP BY ""AM"".""Month""), ""CumulativeActiveDrivers"" AS (SELECT ""Month"",SUM(""new_active_drivers"") OVER (ORDER BY ""Month"") AS ""active_drivers"" FROM ""ActiveDriversMonths""), ""WorkingDrivers"" AS (SELECT DISTINCT ""AR"".""driver_id"" AS ""drivers"",EXTRACT(MONTH FROM ""R"".""requested_at"") AS ""month"" FROM ""AcceptedRides"" AS ""AR"" JOIN ""Rides"" AS ""R"" ON ""R"".""ride_id""=""AR"".""ride_id"" WHERE EXTRACT(YEAR FROM ""R"".""requested_at"")=2020), ""WorkingDriversSummary"" AS (SELECT ""month"",COUNT(""drivers"") AS ""drivers"" FROM ""WorkingDrivers"" GROUP BY ""month"") SELECT ""CAD"".""Month"",COALESCE(ROUND(""WDS"".""drivers""*100/""CAD"".""active_drivers"", 2), 0) AS ""working_percentage"" FROM ""CumulativeActiveDrivers"" AS ""CAD"" LEFT JOIN ""WorkingDriversSummary"" AS ""WDS"" ON ""WDS"".""month""=""CAD"".""month"""
127,"WITH RECURSIVE ""T1"" AS (SELECT 1 AS ""join_month"" UNION SELECT ""join_month""+1 FROM ""T1"" WHERE ""join_month""<12), ""T2"" AS (SELECT CASE WHEN EXTRACT(YEAR FROM ""join_date"")<'2020' THEN '1' ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""join_month"",COUNT(""driver_id"") AS ""driver_num"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<='2020' GROUP BY ""join_month""), ""T3"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""join_month"",COUNT(DISTINCT ""ar"".""driver_id"") AS ""ride_num"" FROM ""AcceptedRides"" AS ""ar"" LEFT JOIN ""Rides"" AS ""r"" ON ""ar"".""ride_id""=""r"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")='2020' GROUP BY ""join_month"") SELECT ""T1"".""join_month"" AS ""month"",ROUND(100*COALESCE(""T3"".""ride_num""/SUM(""T2"".""driver_num""), 0), 2) AS ""working_percentage"" FROM (""T1"" LEFT JOIN ""T2"" ON ""T1"".""join_month"">=""T2"".""join_month"") LEFT JOIN ""T3"" ON ""T1"".""join_month""=""T3"".""join_month"" GROUP BY ""T1"".""join_month"" ORDER BY ""T1"".""join_month"""
128,"WITH RECURSIVE ""cte_month"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 AS ""month"" FROM ""cte_month"" WHERE ""month""+1<=12), ""driver"" AS (SELECT ""c"".""month"",COUNT(""d"".""driver_id"") AS ""active_drivers"" FROM ""cte_month"" AS ""c"" LEFT JOIN ""Drivers"" AS ""d"" ON (EXTRACT(YEAR FROM ""join_date"")<2021 AND EXTRACT(MONTH FROM ""d"".""join_date"")<=""c"".""month"") OR EXTRACT(YEAR FROM ""d"".""join_date"")<2020 GROUP BY 1), ""ride"" AS (SELECT EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""month"",COUNT(DISTINCT ""a"".""driver_id"") AS ""num_of_driver"" FROM ""Rides"" AS ""r"" JOIN ""AcceptedRides"" AS ""a"" ON ""r"".""ride_id""=""a"".""ride_id"" WHERE EXTRACT(YEAR FROM ""r"".""requested_at"")=2020 GROUP BY 1) SELECT ""d"".""month"",ROUND(COALESCE(""r"".""num_of_driver""/""d"".""active_drivers"", 0)*100.0, 2) AS ""working_percentage"" FROM ""driver"" AS ""d"" LEFT JOIN ""ride"" AS ""r"" ON ""d"".""month""=""r"".""month"""
129,"WITH ""t"" AS (WITH ""t"" AS (WITH ""t"" AS (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""m"",COUNT(1) AS ""c"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")=2020 GROUP BY EXTRACT(MONTH FROM ""join_date"") UNION ALL SELECT 1,COUNT(1) AS ""c"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<2020 UNION ALL SELECT 1,0 UNION ALL SELECT 2,0 UNION ALL SELECT 3,0 UNION ALL SELECT 4,0 UNION ALL SELECT 5,0 UNION ALL SELECT 6,0 UNION ALL SELECT 7,0 UNION ALL SELECT 8,0 UNION ALL SELECT 9,0 UNION ALL SELECT 10,0 UNION ALL SELECT 11,0 UNION ALL SELECT 12,0) SELECT ""m"",SUM(""c"") AS ""c"" FROM ""t"" GROUP BY ""m"") SELECT ""m"",SUM(""c"") OVER (ORDER BY ""m"") AS ""c"" FROM ""t""), ""k"" AS (SELECT EXTRACT(MONTH FROM ""b"".""requested_at"") AS ""m"",COUNT(DISTINCT ""driver_id"") AS ""c"" FROM ""AcceptedRides"" AS ""a"" JOIN ""rides"" AS ""b"" ON ""a"".""ride_id""=""b"".""ride_id"" WHERE EXTRACT(YEAR FROM ""b"".""requested_at"")=2020 GROUP BY EXTRACT(MONTH FROM ""b"".""requested_at"")) SELECT ""t"".""m"" AS ""month"",ROUND(CASE WHEN ""t"".""c""=0 THEN 0 ELSE 100*COALESCE(""k"".""c"", 0)/""t"".""c"" END, 2) AS ""working_percentage"" FROM ""t"" LEFT JOIN ""k"" ON ""k"".""m""=""t"".""m"" ORDER BY ""t"".""m"""
130,"WITH RECURSIVE ""cte_count"" (""month"") AS (SELECT CAST('2020-01-01' AS DATE) UNION ALL SELECT ""month"" + INTERVAL '1 MONTH' FROM ""cte_count"" WHERE ""month"" + INTERVAL '1 MONTH'<='2020-12-31') SELECT EXTRACT(MONTH FROM ""tmp4"".""month"") AS ""month"",ROUND(COALESCE(COALESCE(""tmp5"".""accepted_drivers"", 0)*100.0/""tmp4"".""active_drivers"", 0), 2) AS ""working_percentage"" FROM (SELECT ""month"",""active_drivers"" FROM (SELECT ""month"",SUM(""active_drivers"") OVER (ORDER BY ""month"") AS ""active_drivers"" FROM (SELECT LAST_DAY(""cte_count"".""month"") AS ""month"",""tmp1"".""active_drivers"" FROM ""cte_count"" LEFT JOIN (SELECT LAST_DAY(""join_date"") AS ""month"",COUNT(""driver_id"") AS ""active_drivers"" FROM ""drivers"" WHERE LAST_DAY(""join_date"") BETWEEN '2020-01-01' AND '2020-12-31' GROUP BY LAST_DAY(""join_date"")) AS ""tmp1"" ON LAST_DAY(""cte_count"".""month"")=""tmp1"".""month"" UNION ALL SELECT CAST('2019-12-31' AS DATE) AS ""month"",COUNT(1) FROM ""Drivers"" WHERE ""join_date""<='2019-12-31') AS ""tmp2"") AS ""tmp3"" WHERE ""month"">='2020-01-01') AS ""tmp4"" LEFT JOIN (SELECT LAST_DAY(""r"".""requested_at"") AS ""month"",COUNT(DISTINCT ""d"".""driver_id"") AS ""accepted_drivers"" FROM (""AcceptedRides"" AS ""a"" JOIN ""drivers"" AS ""d"" ON ""d"".""driver_id""=""a"".""driver_id"") JOIN ""rides"" AS ""r"" ON ""r"".""ride_id""=""a"".""ride_id"" WHERE LAST_DAY(""r"".""requested_at"")<='2020-12-31' GROUP BY LAST_DAY(""r"".""requested_at"")) AS ""tmp5"" ON ""tmp4"".""month""=""tmp5"".""month"""
131,"WITH RECURSIVE ""cte"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""cte"" WHERE ""month""<12), ""temp"" AS (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",MAX(""drivers"") OVER (ORDER BY TO_CHAR(""join_date"", 'YYYY-%m')) AS ""drivers"" FROM (SELECT ""driver_id"",""join_date"",COUNT(""driver_id"") OVER (ORDER BY ""join_date"") AS ""drivers"" FROM ""Drivers"") AS ""t"" WHERE ""join_date"">='2020-01-01' AND ""join_date""<='2020-12-31'), ""temp1"" AS (SELECT ""cte"".""month"",MAX(CASE WHEN ""drivers"" IS NULL THEN 0 ELSE ""drivers"" END) OVER (ORDER BY ""month"") AS ""drivers"" FROM ""cte"" LEFT JOIN ""temp"" ON ""cte"".""month""=""temp"".""month"" GROUP BY ""month""), ""temp2"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""working"" FROM ""Rides"" AS ""r"" JOIN ""AcceptedRides"" AS ""a"" ON ""r"".""ride_id""=""a"".""ride_id"" WHERE ""requested_at"">='2020-01-01' AND ""requested_at""<='2020-12-31' GROUP BY EXTRACT(MONTH FROM ""requested_at"")) SELECT ""temp1"".""month"",CASE WHEN ""drivers"" IS NULL OR ""working"" IS NULL THEN 0.00 ELSE ROUND(""working""/""drivers""*100, 2) END AS ""working_percentage"" FROM ""temp1"" LEFT JOIN ""temp2"" ON ""temp1"".""month""=""temp2"".""month"" ORDER BY ""month"""
132,"WITH RECURSIVE ""cte"" AS (SELECT 1 AS ""month"" UNION SELECT ""month""+1 AS ""month"" FROM ""cte"" WHERE ""month""<12), ""temp1"" AS (SELECT EXTRACT(MONTH FROM CASE WHEN EXTRACT(YEAR FROM ""join_date"")<2020 THEN '2020-1-1' ELSE ""join_date"" END) AS ""month"",COUNT(1) AS ""tot_driver"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<2021 GROUP BY EXTRACT(MONTH FROM CASE WHEN EXTRACT(YEAR FROM ""join_date"")<2020 THEN '2020-1-1' ELSE ""join_date"" END)), ""temp2"" AS (SELECT ""cte"".""month"",SUM(""tot_driver"") OVER (ORDER BY ""cte"".""month"") AS ""tot_driver"" FROM ""cte"" LEFT JOIN ""temp1"" AS ""t1"" ON ""cte"".""month""=""t1"".""month""), ""temp3"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",""d"".""driver_id"" FROM (""Drivers"" AS ""d"" LEFT JOIN ""AcceptedRides"" AS ""a"" ON ""d"".""driver_id""=""a"".""driver_id"") LEFT JOIN ""Rides"" AS ""r"" ON ""r"".""ride_id""=""a"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY EXTRACT(MONTH FROM ""requested_at""),""d"".""driver_id"" HAVING COUNT(""a"".""ride_id"")>0), ""temp4"" AS (SELECT ""cte"".""month"",COALESCE(COUNT(""driver_id""), 0) AS ""act"" FROM ""temp3"" AS ""t3"" RIGHT JOIN ""cte"" ON ""t3"".""month""=""cte"".""month"" GROUP BY ""cte"".""month"") SELECT ""t2"".""month"",ROUND(COALESCE(""act""/""tot_driver"", 0)*100, 2) AS ""working_percentage"" FROM ""temp2"" AS ""t2"" JOIN ""temp4"" AS ""t4"" ON ""t2"".""month""=""t4"".""month"""
133,"WITH RECURSIVE ""t1"" AS (SELECT 1 AS ""month"" UNION SELECT ""month""+1 FROM ""t1"" WHERE ""month""<12), ""t2"" AS (SELECT CASE WHEN EXTRACT(YEAR FROM ""join_date"")<2020 THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""month"",COUNT(""driver_id"") AS ""new_drivers"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<2021 GROUP BY ""month""), ""t3"" AS (SELECT ""t1"".""month"",SUM(COALESCE(""new_drivers"", 0)) OVER (ORDER BY ""t1"".""month"") AS ""all_drivers"" FROM ""t1"" LEFT JOIN ""t2"" ON ""t1"".""month""=""t2"".""month""), ""t4"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""cnt"" FROM ""rides"" AS ""a"" JOIN ""acceptedrides"" AS ""b"" ON ""a"".""ride_id""=""b"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY ""month"") SELECT ""t3"".""month"",ROUND(100*COALESCE(""cnt""/""all_drivers"", 0), 2) AS ""working_percentage"" FROM ""t3"" LEFT JOIN ""t4"" ON ""t3"".""month""=""t4"".""month"""
134,"WITH ""cte1"" AS (SELECT DISTINCT EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""requested_month"",""d"".""driver_id"" FROM (""AcceptedRides"" AS ""a"" JOIN ""Rides"" AS ""r"" ON ""a"".""ride_id""=""r"".""ride_id"") JOIN ""Drivers"" AS ""d"" ON ""d"".""driver_id""=""a"".""driver_id"" WHERE EXTRACT(YEAR FROM ""join_date"")<='2020' AND EXTRACT(YEAR FROM ""requested_at"")>'2019' AND EXTRACT(YEAR FROM ""requested_at"")<'2021' ORDER BY 1), ""cte_recur"" AS (WITH RECURSIVE ""tmp"" AS (SELECT 1 AS ""id"" UNION ALL SELECT ""id""+1 AS ""id"" FROM ""tmp"" WHERE ""id""<12) SELECT * FROM ""tmp""), ""cte2"" AS (SELECT ""month"",COUNT(1) AS ""driver_cnt"" FROM (SELECT EXTRACT(MONTH FROM ""new_joindate"") AS ""month"",""driver_id"" FROM (SELECT ""driver_id"",CASE WHEN EXTRACT(YEAR FROM ""join_date"")<'2020' THEN '2020-1-1' ELSE ""join_date"" END AS ""new_joindate"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<='2020') AS ""t"") AS ""t2"" GROUP BY ""month""), ""active_driver_month"" AS (SELECT ""month"",SUM(""driver_cnt"") OVER (ORDER BY ""month"") AS ""active_driver"" FROM (SELECT ""id"" AS ""month"",COALESCE(""driver_cnt"", 0) AS ""driver_cnt"" FROM ""cte2"" RIGHT JOIN ""cte_recur"" ON ""cte2"".""month""=""cte_recur"".""id"") AS ""t""), ""accept_driver_month"" AS (SELECT ""cte_recur"".""id"" AS ""month"",COALESCE(""driver_accept_cnt"", 0) AS ""driver_accept_cnt"" FROM (SELECT ""requested_month"",COUNT(""driver_id"") AS ""driver_accept_cnt"" FROM ""cte1"" GROUP BY ""requested_month"") AS ""r1"" RIGHT JOIN ""cte_recur"" ON ""r1"".""requested_month""=""cte_recur"".""id"") SELECT ""acc"".""month"",ROUND(COALESCE(""driver_accept_cnt""/""active_driver""*100, 0), 2) AS ""working_percentage"" FROM ""accept_driver_month"" AS ""acc"" JOIN ""active_driver_month"" AS ""act"" ON ""acc"".""month""=""act"".""month"" ORDER BY 1"
135,"WITH RECURSIVE ""month"" AS (SELECT 1 AS ""m"" UNION SELECT ""m""+1 FROM ""month"" WHERE ""m""<12), ""ad"" AS (SELECT ""driver_id"",CASE WHEN ""join_date""<='2020-1-1' THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""join_month"" FROM ""Drivers"" WHERE ""join_date""<'2021-1-1'), ""ar"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""m"",COUNT(DISTINCT ""driver_id"") AS ""accepted_rides"" FROM ""Rides"" AS ""R"" JOIN ""AcceptedRides"" AS ""ar"" ON ""r"".""ride_id""=""ar"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")='2020' GROUP BY 1) SELECT DISTINCT ""month"".""m"" AS ""month"",ROUND(COALESCE(100.0*""accepted_rides""/COUNT(""ad"".""driver_id""), 0), 2) AS ""working_percentage"" FROM (""month"" LEFT JOIN ""ad"" ON ""month"".""m"">=""ad"".""join_month"") LEFT JOIN ""ar"" ON ""month"".""m""=""ar"".""m"" GROUP BY 1 ORDER BY 1"
136,"WITH RECURSIVE ""months"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""months"" WHERE ""month""<12), ""available_drivers"" AS (SELECT ""months"".""month"",COALESCE(MAX(""t1"".""active_driver"") OVER (ORDER BY ""month""), 0) AS ""active_driver"" FROM ""months"" LEFT JOIN (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(""driver_id"") OVER (ORDER BY ""join_date"" ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS ""active_driver"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020) AS ""t1"" ON ""t1"".""month""=""months"".""month""), ""working_drivers"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""working_driver"" FROM ""Rides"" AS ""R"" JOIN ""AcceptedRides"" AS ""A"" ON ""R"".""ride_id""=""A"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY 1) SELECT ""months"".""month"",COALESCE(ROUND(""working_driver""/""active_driver""*100, 2), 0) AS ""working_percentage"" FROM (""months"" LEFT JOIN ""available_drivers"" ON ""available_drivers"".""month""=""months"".""month"") LEFT JOIN ""working_drivers"" ON ""working_drivers"".""month""=""months"".""month"" GROUP BY 1"
137,"WITH RECURSIVE ""T1"" AS (SELECT 1 AS ""join_month"" UNION SELECT ""join_month""+1 FROM ""T1"" WHERE ""join_month""<12), ""T2"" AS (SELECT CASE WHEN EXTRACT(YEAR FROM ""join_date"")<'2020' THEN '1' ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""join_month"",COUNT(""driver_id"") AS ""driver_num"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<='2020' GROUP BY ""join_month""), ""T3"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""join_month"",COUNT(DISTINCT ""ar"".""driver_id"") AS ""ride_num"" FROM ""AcceptedRides"" AS ""ar"" LEFT JOIN ""Rides"" AS ""r"" ON ""ar"".""ride_id""=""r"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")='2020' GROUP BY ""join_month"") SELECT ""T1"".""join_month"" AS ""month"",ROUND(100*COALESCE(""T3"".""ride_num""/SUM(""T2"".""driver_num""), 0), 2) AS ""working_percentage"" FROM (""T1"" LEFT JOIN ""T2"" ON ""T1"".""join_month"">=""T2"".""join_month"") LEFT JOIN ""T3"" ON ""T1"".""join_month""=""T3"".""join_month"" GROUP BY ""T1"".""join_month"" ORDER BY ""T1"".""join_month"""
138,"WITH RECURSIVE ""month"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 AS ""month"" FROM ""month"" WHERE ""month""<12), ""driver_2020"" AS (SELECT ""z"".""month"",COUNT(""driver_id"") AS ""cnt_total"" FROM ""month"" AS ""z"" LEFT JOIN (SELECT ""driver_id"",CASE WHEN ""join_date""<'2020-01-01' THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""month"" FROM ""drivers"" WHERE ""join_date""<'2021-01-01') AS ""y"" ON ""z"".""month""=""y"".""month"" GROUP BY ""month""), ""cul_driver_2020"" AS (SELECT ""u"".""month"",SUM(""v"".""cnt_total"") AS ""cul_cnt"" FROM ""driver_2020"" AS ""u"" LEFT JOIN ""driver_2020"" AS ""v"" ON ""u"".""month"">=""v"".""month"" GROUP BY ""u"".""month""), ""accepted"" AS (SELECT EXTRACT(MONTH FROM ""w"".""requested_at"") AS ""month"",COUNT(DISTINCT ""x"".""driver_id"") AS ""accept_cnt"" FROM ""acceptedrides"" AS ""x"" LEFT JOIN ""rides"" AS ""w"" ON ""x"".""ride_id""=""w"".""ride_id"" WHERE EXTRACT(YEAR FROM ""w"".""requested_at"")=2020 GROUP BY 1) SELECT ""a"".""month"",ROUND(COALESCE((""b"".""accept_cnt""/""a"".""cul_cnt""), 0)*100, 2) AS ""working_percentage"" FROM ""cul_driver_2020"" AS ""a"" LEFT JOIN ""accepted"" AS ""b"" ON ""a"".""month""=""b"".""month"" ORDER BY ""a"".""month"""
139,"WITH RECURSIVE ""Month"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""Month"" WHERE ""month""<12), ""monthly_drivers"" AS (SELECT ""d"".*,""m"".* FROM (""Month"" AS ""m"") JOIN ""Drivers"" AS ""d"" WHERE EXTRACT(YEAR FROM ""d"".""join_date"")<2020 OR (EXTRACT(YEAR FROM ""d"".""join_date"")=2020 AND EXTRACT(MONTH FROM ""d"".""join_date"")<=""m"".""month"")), ""monthly_avail_drivers"" AS (SELECT ""m"".""month"",COALESCE(""t2"".""num_avail_drivers"", 0) AS ""num_avail_drivers"" FROM (SELECT ""month"",COALESCE(COUNT(""driver_id""), 0) AS ""num_avail_drivers"" FROM ""monthly_drivers"" GROUP BY ""month"") AS ""t2"" RIGHT JOIN ""Month"" AS ""m"" ON ""m"".""month""=""t2"".""month""), ""monthly_working_drivers"" AS (SELECT ""Month"".""month"",COALESCE(COUNT(DISTINCT ""t2"".""driver_id""), 0) AS ""num_working_drivers"" FROM ""Month"" LEFT JOIN (SELECT ""a"".""driver_id"",EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""month"" FROM ""AcceptedRides"" AS ""a"" JOIN ""Rides"" AS ""r"" ON ""a"".""ride_id""=""r"".""ride_id"" WHERE EXTRACT(YEAR FROM ""r"".""requested_at"")=2020) AS ""t2"" ON ""t2"".""month""=""Month"".""month"" GROUP BY ""Month"".""month"") SELECT ""m1"".""month"" AS ""month"",COALESCE(ROUND(100*""m2"".""num_working_drivers""/""m1"".""num_avail_drivers"", 2), 0) AS ""working_percentage"" FROM ""monthly_avail_drivers"" AS ""m1"" JOIN ""monthly_working_drivers"" AS ""m2"" ON ""m1"".""month""=""m2"".""month"" ORDER BY ""m1"".""month"""
140,"WITH RECURSIVE ""active_driver"" AS (SELECT ""driver_id"",""join_date"",""join_date"" AS ""dur"" FROM ""drivers"" UNION SELECT ""driver_id"",""join_date"",""dur"" + INTERVAL '1 MONTH' AS ""dur"" FROM ""active_driver"" WHERE ""dur""<LAST_DAY(CURDATE()) + INTERVAL '1 MONTH'), ""datedim"" AS (SELECT 1 AS ""m"" UNION SELECT ""m""+1 FROM ""datedim"" WHERE ""m""<12) SELECT ""m"" AS ""month"",ROUND(COALESCE(""wd"".""working_driver"", 0)*100/COALESCE(""ad"".""monthly_ad"", 1), 2) AS ""working_percentage"" FROM (""datedim"" AS ""dd"" LEFT JOIN (SELECT EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""month"",COUNT(DISTINCT ""ar"".""driver_id"") AS ""working_driver"" FROM ""acceptedrides"" AS ""ar"" JOIN ""rides"" AS ""r"" ON ""r"".""ride_id""=""ar"".""ride_id"" WHERE EXTRACT(YEAR FROM ""r"".""requested_at"")=2020 GROUP BY EXTRACT(MONTH FROM ""r"".""requested_at"")) AS ""wd"" ON ""wd"".""month""=""dd"".""m"") LEFT JOIN (SELECT EXTRACT(MONTH FROM ""dur"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""monthly_ad"" FROM ""active_driver"" WHERE EXTRACT(YEAR FROM ""dur"")=2020 GROUP BY EXTRACT(MONTH FROM ""dur"")) AS ""ad"" ON ""ad"".""month""=""dd"".""m"""
141,"WITH RECURSIVE ""M"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""M"" WHERE ""month""<12), ""Available_Driver"" AS (SELECT ""a"".""month"",SUM(COALESCE(""b"".""available_driver"", 0)) OVER (ORDER BY ""a"".""month"") AS ""available_driver"" FROM ""M"" AS ""a"" LEFT JOIN (SELECT CASE WHEN EXTRACT(YEAR FROM ""join_date"")<2020 THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""month"",COUNT(""driver_id"") AS ""available_driver"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020 GROUP BY 1) AS ""b"" ON ""a"".""month""=""b"".""month""), ""Active_Driver"" AS (SELECT EXTRACT(MONTH FROM ""a"".""requested_at"") AS ""month"",COUNT(DISTINCT ""b"".""driver_id"") AS ""active_driver"" FROM ""Rides"" AS ""a"" JOIN ""AcceptedRides"" AS ""b"" ON ""a"".""ride_id""=""b"".""ride_id"" WHERE EXTRACT(YEAR FROM ""a"".""requested_at"")=2020 GROUP BY 1) SELECT ""a"".""month"",CASE WHEN ""a"".""available_driver""=0 THEN 0.00 ELSE ROUND(COALESCE(""b"".""active_driver"", 0)/""a"".""available_driver""*100, 2) END AS ""working_percentage"" FROM ""Available_Driver"" AS ""a"" LEFT JOIN ""Active_Driver"" AS ""b"" ON ""a"".""month""=""b"".""month"" ORDER BY ""a"".""month"""
142,"WITH RECURSIVE ""months"" (""month"") AS (SELECT 1 UNION ALL SELECT ""month""+1 FROM ""months"" WHERE ""month""<12), ""t1"" AS (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(""driver_id"") OVER (ORDER BY ""join_date"") AS ""driver_count"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020), ""t2"" AS (SELECT EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""month"",COUNT(DISTINCT ""a"".""driver_id"") AS ""active_driver"" FROM ""Rides"" AS ""r"" JOIN ""AcceptedRides"" AS ""a"" ON ""r"".""ride_id""=""a"".""ride_id"" WHERE EXTRACT(YEAR FROM ""r"".""requested_at"")=2020 GROUP BY EXTRACT(MONTH FROM ""r"".""requested_at"")) SELECT ""a"".""month"",ROUND(COALESCE(""a"".""act_cnt""/""a"".""tot_cnt""*100, 0), 2) AS ""working_percentage"" FROM (SELECT DISTINCT ""m"".""month"",COALESCE(MAX(""t1"".""driver_count"") OVER (ORDER BY ""m"".""month""), 0) AS ""tot_cnt"",COALESCE(""t2"".""active_driver"", 0) AS ""act_cnt"" FROM (""months"" AS ""m"" LEFT JOIN ""t1"" ON ""m"".""month""=""t1"".""month"") LEFT JOIN ""t2"" ON ""m"".""month""=""t2"".""month"") AS ""a"""
143,"WITH RECURSIVE ""months"" AS (SELECT CASE WHEN TO_CHAR(MIN(""join_date""), 'YYYY-%m-01')<=TO_CHAR('2020-01-01', 'YYYY-%m-01') THEN TO_CHAR(MIN(""join_date""), 'YYYY-%m-01') ELSE TO_CHAR('2020-01-01', 'YYYY-%m-01') END AS ""d"" FROM ""Drivers"" UNION SELECT ""d"" + INTERVAL '1 MONTH' FROM ""months"" WHERE ""d""<=TO_CHAR('2020-11-01', 'YYYY-%m-d')), ""num_drivers"" AS (SELECT ""m"".""d"",COUNT(""d"".""driver_id"") AS ""num_drivers"" FROM ""months"" AS ""m"" LEFT JOIN ""Drivers"" AS ""d"" ON EXTRACT(YEAR FROM ""d"".""join_date"")=EXTRACT(YEAR FROM ""m"".""d"") AND EXTRACT(MONTH FROM ""d"".""join_date"")=EXTRACT(MONTH FROM ""m"".""d"") GROUP BY 1), ""total_mthly_drivers"" AS (SELECT ""d"",SUM(""num_drivers"") OVER (ORDER BY ""d"" ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS ""total_num_drivers"" FROM ""num_drivers""), ""total_drivers"" AS (SELECT EXTRACT(MONTH FROM ""d"") AS ""month"",""total_num_drivers"" FROM ""total_mthly_drivers"" AS ""t"" WHERE EXTRACT(YEAR FROM ""d"")=2020), ""active_monthly"" AS (SELECT EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""month"",COUNT(DISTINCT ""a"".""driver_id"") AS ""mthly_driver_cnt"" FROM ""AcceptedRides"" AS ""a"" JOIN ""Rides"" AS ""r"" ON ""r"".""ride_id""=""a"".""ride_id"" WHERE EXTRACT(YEAR FROM ""r"".""requested_at"")=2020 GROUP BY 1) SELECT ""t"".""month"",COALESCE(ROUND(COALESCE(""a"".""mthly_driver_cnt"", 0)/""t"".""total_num_drivers""*100, 2), 0) AS ""working_percentage"" FROM ""total_drivers"" AS ""t"" LEFT JOIN ""active_monthly"" AS ""a"" ON ""t"".""month""=""a"".""month"" ORDER BY 1"
144,"WITH RECURSIVE ""CTE"" AS (SELECT 1 AS ""month"" UNION SELECT ""month""+1 FROM ""CTE"" WHERE ""month""<12), ""CTE1"" AS (SELECT CASE WHEN EXTRACT(YEAR FROM ""join_date"")<2020 THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""month"",""driver_id"" FROM ""Drivers"" AS ""d"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020), ""CTE2"" AS (SELECT EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""working_driver"" FROM ""AcceptedRides"" AS ""a"" JOIN ""Rides"" AS ""r"" ON ""a"".""ride_id""=""r"".""ride_id"" WHERE EXTRACT(YEAR FROM ""r"".""requested_at"")=2020 GROUP BY ""month"") SELECT ""t1"".""month"",COALESCE(ROUND(100*""working_driver""/""total_driver"", 2), 0.00) AS ""working_percentage"" FROM (SELECT DISTINCT ""CTE"".""month"",COUNT(""CTE1"".""driver_id"") OVER (ORDER BY ""CTE"".""month"") AS ""total_driver"" FROM ""CTE"" LEFT JOIN ""CTE1"" ON ""CTE"".""month""=""CTE1"".""month"") AS ""t1"" LEFT JOIN ""CTE2"" ON ""t1"".""month""=""CTE2"".""month"" ORDER BY ""t1"".""month"""
145,"WITH RECURSIVE ""t0"" (""m"") AS (SELECT '2020-02-01' AS ""m"" UNION ALL SELECT ""m"" + INTERVAL '1 MONTH' FROM ""t0"" WHERE ""m""<'2021-01-01'), ""t1"" AS (SELECT ""m"" - INTERVAL '1 DAY' AS ""mon"" FROM ""t0""), ""t2"" AS (SELECT ""t1"".""mon"",COUNT(""driver_id"") AS ""active_drivers"" FROM ""t1"" LEFT JOIN ""Drivers"" AS ""d"" ON ""t1"".""mon"">=""d"".""join_date"" GROUP BY 1), ""t3"" AS (SELECT ""t1"".""mon"",""driver_id"" FROM ""t1"" LEFT JOIN (SELECT ""a"".""ride_id"",""a"".""driver_id"",""r"".""requested_at"" FROM ""AcceptedRides"" AS ""a"" LEFT JOIN ""Rides"" AS ""r"" ON ""a"".""ride_id""=""r"".""ride_id"") AS ""tmp"" ON TO_CHAR(""requested_at"", 'YYYY-%m')=TO_CHAR(""t1"".""mon"", 'YYYY-%m') GROUP BY 1,2 HAVING COUNT(""ride_id"")>=1), ""t4"" AS (SELECT ""mon"",COUNT(""driver_id"") AS ""driver_one_ride"" FROM ""t3"" GROUP BY 1) SELECT EXTRACT(MONTH FROM ""t2"".""mon"") AS ""month"",ROUND(COALESCE(""driver_one_ride""/""active_drivers""*100, 0), 2) AS ""working_percentage"" FROM ""t2"" LEFT JOIN ""t4"" ON ""t2"".""mon""=""t4"".""mon"""
146,"WITH RECURSIVE ""t1"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""t1"" WHERE ""month""<12), ""t2"" AS (SELECT CASE WHEN EXTRACT(YEAR FROM ""join_date"")<2020 THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""month"",COUNT(""driver_id"") AS ""new_drivers"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020 GROUP BY ""month""), ""t3"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""active_drivers"" FROM ""rides"" AS ""a"" JOIN ""acceptedrides"" AS ""b"" ON ""a"".""ride_id""=""b"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY ""month""), ""t4"" AS (SELECT ""t1"".""month"",SUM(COALESCE(""new_drivers"", 0)) OVER (ORDER BY ""t1"".""month"") AS ""all_drivers"" FROM ""t1"" LEFT JOIN ""t2"" ON ""t1"".""month""=""t2"".""month"") SELECT ""t4"".""month"",ROUND(100*COALESCE(""active_drivers""/""all_drivers"", 0), 2) AS ""working_percentage"" FROM ""t4"" LEFT JOIN ""t3"" ON ""t4"".""month""=""t3"".""month"""
147,"WITH RECURSIVE ""t"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""t"" WHERE ""month""<12), ""t1"" AS (SELECT ""driver_id"",""join_date"",CASE WHEN EXTRACT(YEAR FROM ""join_date"")<2020 THEN '2020-01-01' ELSE ""join_date"" END AS ""new_date"" FROM ""drivers""), ""t2"" AS (SELECT DISTINCT ""t"".""month"",COUNT(DISTINCT ""t1"".""driver_id"") AS ""active_driver"" FROM ""t"" LEFT JOIN ""t1"" ON ""t"".""month""=EXTRACT(MONTH FROM ""t1"".""new_date"") AND EXTRACT(YEAR FROM ""t1"".""new_date"")=2020 GROUP BY 1), ""t3"" AS (SELECT DISTINCT ""t"".""month"",COUNT(DISTINCT ""driver_id"") AS ""accepted_rider"" FROM ""t"" LEFT JOIN (SELECT ""a"".""driver_id"",""r"".""requested_at"" FROM ""acceptedrides"" AS ""a"" LEFT JOIN ""rides"" AS ""r"" ON ""a"".""ride_id""=""r"".""ride_id"" AND EXTRACT(YEAR FROM ""r"".""requested_at"")=2020) AS ""t4"" ON ""t"".""month""=EXTRACT(MONTH FROM ""t4"".""requested_at"") GROUP BY 1) SELECT ""t3"".""month"",ROUND(100*(COALESCE(""t3"".""accepted_rider""/SUM(""t2"".""active_driver"") OVER (ORDER BY ""t2"".""month""), 0)), 2) AS ""working_percentage"" FROM ""t3"" JOIN ""t2"" ON ""t3"".""month""=""t2"".""month"""
148,"WITH RECURSIVE ""t1"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""m"",COUNT(DISTINCT ""driver_id"") AS ""c"" FROM ""Rides"" AS ""a"" JOIN ""AcceptedRides"" AS ""b"" ON ""a"".""ride_id""=""b"".""ride_id"" WHERE ""requested_at"" BETWEEN '2020-01-01' AND '2020-12-31' GROUP BY EXTRACT(MONTH FROM ""requested_at"")), ""t2"" AS (SELECT 1 AS ""m"" UNION ALL SELECT ""m""+1 AS ""m"" FROM ""t2"" WHERE ""m""<12), ""t3"" AS (SELECT ""m"",SUM(CASE WHEN (EXTRACT(YEAR FROM ""join_date"")<=2019) OR (EXTRACT(YEAR FROM ""join_date"")=2020 AND EXTRACT(MONTH FROM ""join_date"")<=""m"") THEN 1 ELSE 0 END) AS ""available_drivers"" FROM ""t2"" AS ""a"" JOIN ""Drivers"" AS ""b"" GROUP BY ""a"".""m""), ""t4"" AS (SELECT ""t2"".""m"",COALESCE(""t1"".""c"", 0) AS ""c"" FROM ""t2"" LEFT JOIN ""t1"" ON ""t2"".""m""=""t1"".""m"") SELECT ""t3"".""m"" AS ""month"",CASE WHEN ""t3"".""available_drivers""=0 THEN 0 ELSE ROUND(""t4"".""c""*100/""t3"".""available_drivers"", 2) END AS ""working_percentage"" FROM ""t3"" JOIN ""t4"" ON ""t3"".""m""=""t4"".""m"""
149,"WITH ""gen"" AS (SELECT 1 AS ""month"" UNION ALL SELECT 2 AS ""month"" UNION ALL SELECT 3 AS ""month"" UNION ALL SELECT 4 AS ""month"" UNION ALL SELECT 5 AS ""month"" UNION ALL SELECT 6 AS ""month"" UNION ALL SELECT 7 AS ""month"" UNION ALL SELECT 8 AS ""month"" UNION ALL SELECT 9 AS ""month"" UNION ALL SELECT 10 AS ""month"" UNION ALL SELECT 11 AS ""month"" UNION ALL SELECT 12 AS ""month""), ""agg"" AS (SELECT CASE WHEN EXTRACT(YEAR FROM ""join_date"")<2020 THEN 1 WHEN EXTRACT(YEAR FROM ""join_date"")=2020 THEN EXTRACT(MONTH FROM ""join_date"") ELSE NULL END AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""ct"" FROM ""drivers"" GROUP BY 1), ""deno"" AS (SELECT ""g"".""month"",SUM(COALESCE(""a"".""ct"", 0)) OVER (ORDER BY ""g"".""month"") AS ""ct_deno"" FROM ""gen"" AS ""g"" LEFT JOIN ""agg"" AS ""a"" ON ""g"".""month""=""a"".""month""), ""nume"" AS (SELECT EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""month"",COUNT(DISTINCT ""a"".""driver_id"") AS ""ct_nume"" FROM ""acceptedrides"" AS ""a"" JOIN ""rides"" AS ""r"" ON ""a"".""ride_id""=""r"".""ride_id"" AND EXTRACT(YEAR FROM ""r"".""requested_at"")=2020 GROUP BY 1) SELECT ""d"".""month"" AS ""month"",ROUND(COALESCE(""n"".""ct_nume""/""d"".""ct_deno"", 0)*100, 2) AS ""working_percentage"" FROM ""deno"" AS ""d"" LEFT JOIN ""nume"" AS ""n"" ON ""d"".""month""=""n"".""month"" ORDER BY ""d"".""month"""
150,"WITH RECURSIVE ""daymon"" AS (SELECT 1 AS ""mon"",LAST_DAY(CONCAT('2020-', 1, '-01')) AS ""lastday"" UNION ALL SELECT ""mon""+1 AS ""mon"",LAST_DAY(CONCAT('2020-', ""mon""+1, '-01')) AS ""lastday"" FROM ""daymon"" WHERE ""mon""<12), ""availabledrivers"" AS (SELECT ""dm"".""mon"",""drivers"".""driver_id"" FROM ""Drivers"" AS ""drivers"" JOIN ""daymon"" AS ""dm"" ON ""drivers"".""join_date""<=""dm"".""lastday"" WHERE ""drivers"".""join_date""<='2020-12-31') SELECT ""dm"".""mon"" AS ""month"",ROUND(CASE WHEN COALESCE(COUNT(""avrd"".""driver_id""), 0)=0 THEN 0 ELSE COALESCE(""cnt"", 0)*100/COUNT(""avrd"".""driver_id"") END, 2) AS ""working_percentage"" FROM (""daymon"" AS ""dm"" LEFT JOIN ""availabledrivers"" AS ""avrd"" ON ""dm"".""mon""=""avrd"".""mon"") LEFT JOIN (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""mon"",COUNT(DISTINCT ""acctrides"".""driver_id"") AS ""cnt"" FROM ""Rides"" AS ""rides"" JOIN ""AcceptedRides"" AS ""acctrides"" ON ""acctrides"".""ride_id""=""rides"".""ride_id"" AND ""rides"".""requested_at"" BETWEEN '2020-01-01' AND '2020-12-31' GROUP BY EXTRACT(MONTH FROM ""requested_at"")) AS ""aard"" ON ""avrd"".""mon""=""aard"".""mon"" GROUP BY ""dm"".""mon"""
151,"WITH RECURSIVE ""cte"" (""month"") AS (SELECT 1 UNION ALL SELECT ""month""+1 FROM ""cte"" WHERE ""month""<12), ""driver"" AS (SELECT CASE WHEN EXTRACT(YEAR FROM ""join_date"")<2020 THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""month"",COUNT(""driver_id"") AS ""driver_cnt"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020 GROUP BY ""month""), ""ride"" AS (SELECT EXTRACT(MONTH FROM ""x"".""requested_at"") AS ""month"",COUNT(DISTINCT ""y"".""driver_id"") AS ""driver_cnt2"" FROM ""Rides"" AS ""x"" JOIN ""AcceptedRides"" AS ""y"" ON ""x"".""ride_id""=""y"".""ride_id"" WHERE EXTRACT(YEAR FROM ""x"".""requested_at"")=2020 GROUP BY ""month"") SELECT ""a"".""month"",CASE WHEN ""b"".""driver_cnt2""/SUM(""c"".""driver_cnt"")*100 IS NULL THEN 0.00 ELSE ROUND(""b"".""driver_cnt2""/SUM(""c"".""driver_cnt"")*100, 2) END AS ""working_percentage"" FROM (""cte"" AS ""a"" LEFT JOIN ""ride"" AS ""b"" ON ""a"".""month""=""b"".""month"") LEFT JOIN ""driver"" AS ""c"" ON ""c"".""month""<=""a"".""month"" GROUP BY ""a"".""month"" ORDER BY ""a"".""month"""
152,"WITH RECURSIVE ""dates"" (""month"") AS (SELECT 1 UNION ALL SELECT 1+""month"" FROM ""dates"" WHERE ""month""<12), ""cte"" AS (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(""driver_id"") OVER (ORDER BY (""join_date"")) AS ""no_drivers"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020), ""cte2"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""no_drives"" FROM ""rides"" JOIN ""acceptedrides"" ON ""rides"".""ride_id""=""acceptedrides"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY ""month"") SELECT ""month"",MIN(""working_percentage"") AS ""working_percentage"" FROM (SELECT ""dates"".""month"",COALESCE(ROUND(COALESCE(""no_drives"", 0)/MAX(""no_drivers"") OVER (ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)*100, 2), 0) AS ""working_percentage"" FROM (""dates"" LEFT JOIN ""cte"" ON ""dates"".""month""=""cte"".""month"") LEFT JOIN ""cte2"" ON ""dates"".""month""=""cte2"".""month"") AS ""b"" GROUP BY 1"
153,"WITH RECURSIVE ""t1"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""m"",COUNT(DISTINCT ""driver_id"") AS ""c"" FROM ""rides"" AS ""a"" JOIN ""acceptedrides"" AS ""b"" ON ""a"".""ride_id""=""b"".""ride_id"" WHERE ""requested_at"" BETWEEN '2020-01-01' AND '2020-12-31' GROUP BY EXTRACT(MONTH FROM ""requested_at"")), ""t2"" AS (SELECT 1 AS ""m"" UNION ALL SELECT ""m""+1 AS ""m"" FROM ""t2"" WHERE ""m""<12), ""t3"" AS (SELECT ""m"",SUM(CASE WHEN (EXTRACT(YEAR FROM ""join_date"")<=2019) OR (EXTRACT(YEAR FROM ""join_date"")=2020 AND EXTRACT(MONTH FROM ""join_date"")<=""m"") THEN 1 ELSE 0 END) AS ""available_drivers"" FROM ""t2"" AS ""a"" JOIN ""drivers"" AS ""b"" GROUP BY ""a"".""m""), ""t4"" AS (SELECT ""t2"".""m"",COALESCE(""t1"".""c"", 0) AS ""c"" FROM ""t2"" LEFT JOIN ""t1"" ON ""t2"".""m""=""t1"".""m"") SELECT ""t3"".""m"" AS ""month"",CASE WHEN ""t3"".""available_drivers""=0 THEN 0 ELSE ROUND(""t4"".""c""*100/""t3"".""available_drivers"", 2) END AS ""working_percentage"" FROM ""t3"" JOIN ""t4"" ON ""t3"".""m""=""t4"".""m"""
154,"WITH RECURSIVE ""months"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""months"" WHERE ""month""<12), ""available_drivers"" AS (SELECT ""months"".""month"",COALESCE(MAX(""t1"".""active_driver"") OVER (ORDER BY ""month""), 0) AS ""active_driver"" FROM ""months"" LEFT JOIN (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(""driver_id"") OVER (ORDER BY ""join_date"" ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS ""active_driver"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020) AS ""t1"" ON ""t1"".""month""=""months"".""month""), ""working_drivers"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""working_driver"" FROM ""Rides"" AS ""R"" JOIN ""AcceptedRides"" AS ""A"" ON ""R"".""ride_id""=""A"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY 1) SELECT ""months"".""month"",COALESCE(ROUND(""working_driver""/""active_driver""*100, 2), 0) AS ""working_percentage"" FROM (""months"" LEFT JOIN ""available_drivers"" ON ""available_drivers"".""month""=""months"".""month"") LEFT JOIN ""working_drivers"" ON ""working_drivers"".""month""=""months"".""month"" GROUP BY 1"
155,"WITH RECURSIVE ""t1"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""m"",COUNT(DISTINCT ""driver_id"") AS ""c"" FROM ""Rides"" AS ""a"" JOIN ""AcceptedRides"" AS ""b"" ON ""a"".""ride_id""=""b"".""ride_id"" WHERE ""requested_at"" BETWEEN '2020-01-01' AND '2020-12-31' GROUP BY EXTRACT(MONTH FROM ""requested_at"")), ""t2"" AS (SELECT 1 AS ""m"" UNION ALL SELECT ""m""+1 AS ""m"" FROM ""t2"" WHERE ""m""<12), ""t3"" AS (SELECT ""m"",SUM(CASE WHEN (EXTRACT(YEAR FROM ""join_date"")<=2019) OR (EXTRACT(YEAR FROM ""join_date"")=2020 AND EXTRACT(MONTH FROM ""join_date"")<=""m"") THEN 1 ELSE 0 END) AS ""available_drivers"" FROM ""t2"" AS ""a"" JOIN ""Drivers"" AS ""b"" GROUP BY ""a"".""m""), ""t4"" AS (SELECT ""t2"".""m"",COALESCE(""t1"".""c"", 0) AS ""c"" FROM ""t2"" LEFT JOIN ""t1"" ON ""t2"".""m""=""t1"".""m"") SELECT ""t3"".""m"" AS ""month"",CASE WHEN ""t3"".""available_drivers""=0 THEN 0 ELSE ROUND(""t4"".""c""*100/""t3"".""available_drivers"", 2) END AS ""working_percentage"" FROM ""t3"" JOIN ""t4"" ON ""t3"".""m""=""t4"".""m"""
156,"WITH RECURSIVE ""cte1"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""cte1"" WHERE ""month""<=11), ""cte2"" AS (SELECT ""cte1"".""month"",COUNT(""driver_id"") AS ""dcount"" FROM ""cte1"" LEFT JOIN ""Drivers"" ON ""join_date""<=LAST_DAY(CONCAT('2020-', ""cte1"".""month"", '-', '01')) GROUP BY ""cte1"".""month""), ""cte3"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""dc"" FROM (""Rides"" AS ""r"") JOIN ""AcceptedRides"" AS ""a"" WHERE ""r"".""ride_id""=""a"".""ride_id"" AND EXTRACT(YEAR FROM ""requested_at"")='2020' GROUP BY ""month"") SELECT ""cte1"".""month"",CASE WHEN (""cte2"".""dcount"" IS NULL OR ""cte2"".""dcount""=0) THEN 0.00 ELSE ROUND((COALESCE(""cte3"".""dc"", 0)/""cte2"".""dcount"")*100, 2) END AS ""working_percentage"" FROM (""cte1"" LEFT JOIN ""cte2"" ON ""cte1"".""month""=""cte2"".""month"") LEFT JOIN ""cte3"" ON ""cte1"".""month""=""cte3"".""month"" ORDER BY ""cte1"".""month"""
157,"WITH RECURSIVE ""active_driver"" AS (SELECT ""driver_id"",""join_date"",""join_date"" AS ""dur"" FROM ""drivers"" UNION SELECT ""driver_id"",""join_date"",""dur"" + INTERVAL '1 MONTH' AS ""dur"" FROM ""active_driver"" WHERE ""dur""<LAST_DAY(CURDATE()) + INTERVAL '1 MONTH'), ""datedim"" AS (SELECT 1 AS ""m"" UNION SELECT ""m""+1 FROM ""datedim"" WHERE ""m""<12) SELECT ""m"" AS ""month"",ROUND(COALESCE(""wd"".""working_driver"", 0)*100/COALESCE(""ad"".""monthly_ad"", 1), 2) AS ""working_percentage"" FROM (""datedim"" AS ""dd"" LEFT JOIN (SELECT EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""month"",COUNT(DISTINCT ""ar"".""driver_id"") AS ""working_driver"" FROM ""acceptedrides"" AS ""ar"" JOIN ""rides"" AS ""r"" ON ""r"".""ride_id""=""ar"".""ride_id"" WHERE EXTRACT(YEAR FROM ""r"".""requested_at"")=2020 GROUP BY EXTRACT(MONTH FROM ""r"".""requested_at"")) AS ""wd"" ON ""wd"".""month""=""dd"".""m"") LEFT JOIN (SELECT EXTRACT(MONTH FROM ""dur"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""monthly_ad"" FROM ""active_driver"" WHERE EXTRACT(YEAR FROM ""dur"")=2020 GROUP BY EXTRACT(MONTH FROM ""dur"")) AS ""ad"" ON ""ad"".""month""=""dd"".""m"""
158,"SELECT ""t1"".""month"",ROUND(COALESCE(""t2"".""active_drivers""*100/""t1"".""available_drivers"", 0), 2) AS ""working_percentage"" FROM (SELECT ""m"".""month"",COUNT(""d"".""driver_id"") AS ""available_drivers"" FROM ((SELECT 1 AS ""month"") UNION (SELECT 2 AS ""month"") UNION (SELECT 3 AS ""month"") UNION (SELECT 4 AS ""month"") UNION (SELECT 5 AS ""month"") UNION (SELECT 6 AS ""month"") UNION (SELECT 7 AS ""month"") UNION (SELECT 8 AS ""month"") UNION (SELECT 9 AS ""month"") UNION (SELECT 10 AS ""month"") UNION (SELECT 11 AS ""month"") UNION (SELECT 12 AS ""month"")) AS ""m"" LEFT JOIN ""drivers"" AS ""d"" ON ""d"".""join_date""<=LAST_DAY(CONCAT('2020-', ""m"".""month"", '-1')) GROUP BY ""m"".""month"") AS ""t1"" LEFT JOIN (SELECT EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""active_drivers"" FROM ""rides"" AS ""r"" JOIN ""acceptedrides"" AS ""ar"" ON ""r"".""ride_id""=""ar"".""ride_id"" AND EXTRACT(YEAR FROM ""r"".""requested_at"")=2020 GROUP BY EXTRACT(MONTH FROM ""r"".""requested_at"")) AS ""t2"" ON ""t1"".""month""=""t2"".""month"" ORDER BY ""t1"".""month"""
159,"WITH RECURSIVE ""months"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""months"" WHERE ""month""<12), ""available_drivers"" AS (SELECT ""months"".""month"",COALESCE(MAX(""t1"".""active_driver"") OVER (ORDER BY ""month""), 0) AS ""active_driver"" FROM ""months"" LEFT JOIN (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(""driver_id"") OVER (ORDER BY ""join_date"" ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS ""active_driver"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020) AS ""t1"" ON ""t1"".""month""=""months"".""month""), ""working_drivers"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""working_driver"" FROM ""Rides"" AS ""R"" JOIN ""AcceptedRides"" AS ""A"" ON ""R"".""ride_id""=""A"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY 1) SELECT ""months"".""month"",COALESCE(ROUND(""working_driver""/""active_driver""*100, 2), 0) AS ""working_percentage"" FROM (""months"" LEFT JOIN ""available_drivers"" ON ""available_drivers"".""month""=""months"".""month"") LEFT JOIN ""working_drivers"" ON ""working_drivers"".""month""=""months"".""month"" GROUP BY 1"
160,"WITH RECURSIVE ""t1"" AS (SELECT 1 AS ""month"" UNION SELECT ""month""+1 FROM ""t1"" WHERE ""month""<12), ""t2"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""driver_cnt1"" FROM ""rides"" AS ""a"" JOIN ""acceptedrides"" AS ""b"" ON ""a"".""ride_id""=""b"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY 1), ""t3"" AS (SELECT CASE WHEN EXTRACT(YEAR FROM ""join_date"")<2020 THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""month"",COUNT(1) AS ""driver_cnt2"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020 GROUP BY 1), ""t4"" AS (SELECT ""t1"".""month"",COALESCE(""driver_cnt1"", 0) AS ""driver_cnt"",SUM(COALESCE(""driver_cnt2"", 0)) OVER (ORDER BY ""t1"".""month"") AS ""driver_sum"" FROM (""t1"" LEFT JOIN ""t3"" ON ""t1"".""month""=""t3"".""month"") LEFT JOIN ""t2"" ON ""t1"".""month""=""t2"".""month"") SELECT ""month"",ROUND(COALESCE(100*""driver_cnt""/""driver_sum"", 0), 2) AS ""working_percentage"" FROM ""t4"""
161,"WITH RECURSIVE ""months"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""months"" WHERE ""month""<12), ""av_drivers"" AS (SELECT ""month"",SUM(""num_drivers"") OVER (ORDER BY ""month"") AS ""n_driver"" FROM (SELECT ""month"",COALESCE(COUNT(""driver_id""), 0) AS ""num_drivers"" FROM ""months"" LEFT JOIN (SELECT ""driver_id"",(CASE WHEN ""join_Date""<'2020-01-01' THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END) AS ""active_month"" FROM ""drivers"" WHERE ""join_date""<'2021-01-01') AS ""sub"" ON ""sub"".""active_month""=""months"".""month"" GROUP BY ""month"") AS ""t""), ""r_tbl"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""ride_month"",COALESCE(COUNT(DISTINCT ""driver_id""), 0) AS ""active"" FROM ""rides"" LEFT JOIN ""acceptedrides"" ON ""rides"".""ride_id""=""acceptedrides"".""ride_id"" WHERE ""requested_at"">='2020-01-01' AND ""requested_at""<'2021-01-01' GROUP BY EXTRACT(MONTH FROM ""requested_at"")) SELECT ""month"",ROUND(COALESCE(""active""/""n_driver""*100, 0), 2) AS ""working_percentage"" FROM ""av_drivers"" LEFT JOIN ""r_tbl"" ON ""av_drivers"".""month""=""r_tbl"".""ride_month"" ORDER BY ""month"""
162,"WITH RECURSIVE ""month"" AS (SELECT 1 AS ""month"" UNION SELECT ""month""+1 AS ""month"" FROM ""month"" WHERE ""month""<12), ""month_driver"" AS (SELECT CASE WHEN EXTRACT(YEAR FROM ""join_date"")<2020 THEN '1' ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""active_driver"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020 GROUP BY 1), ""work_driver"" AS (SELECT EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""month"",COUNT(DISTINCT ""ar"".""driver_id"") AS ""acc_driver"" FROM ""rides"" AS ""r"" JOIN ""acceptedrides"" AS ""ar"" ON ""r"".""ride_id""=""ar"".""ride_id"" WHERE EXTRACT(YEAR FROM ""r"".""requested_at"")='2020' GROUP BY 1) SELECT ""m"".""month"",ROUND(100*COALESCE(""wd"".""acc_driver""/SUM(""md"".""active_driver""), 0), 2) AS ""working_percentage"" FROM (""month"" AS ""m"" LEFT JOIN ""month_driver"" AS ""md"" ON ""md"".""month""<=""m"".""month"") LEFT JOIN ""work_driver"" AS ""wd"" ON ""wd"".""month""=""m"".""month"" GROUP BY 1 ORDER BY 1"
163,"WITH RECURSIVE ""m"" AS (SELECT 1 AS ""mth"" UNION ALL SELECT ""mth""+1 AS ""mth"" FROM ""m"" WHERE ""mth""<12), ""d"" AS (SELECT ""m"".""mth"",COALESCE(""accepted_ride"", 0) AS ""accepted_ride"" FROM ""m"" LEFT JOIN (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""mth"",COUNT(DISTINCT ""driver_id"") AS ""accepted_ride"" FROM ""rides"" AS ""r"" JOIN ""AcceptedRides"" AS ""a"" ON ""r"".""ride_id""=""a"".""ride_id"" WHERE EXTRACT(YEAR FROM ""r"".""requested_at"")=2020 GROUP BY 1) AS ""a"" ON ""m"".""mth""=""a"".""mth""), ""r"" AS (SELECT ""m"".""mth"",SUM(COALESCE(""a"".""driver_cnt"", 0)) OVER (ORDER BY ""m"".""mth"") AS ""driver_cnt"" FROM ""m"" LEFT JOIN (SELECT ""a"".""mth"",SUM(""a"".""driver_cnt"") AS ""driver_cnt"" FROM (SELECT 1 AS ""mth"",COUNT(""driver_id"") AS ""driver_cnt"" FROM ""drivers"" AS ""d"" WHERE EXTRACT(YEAR FROM ""d"".""join_date"")<2020 UNION ALL SELECT EXTRACT(MONTH FROM ""join_date""),COUNT(""driver_id"") AS ""driver_cnt"" FROM ""drivers"" AS ""d"" WHERE EXTRACT(YEAR FROM ""d"".""join_date"")=2020 GROUP BY 1) AS ""a"" GROUP BY 1) AS ""a"" ON ""m"".""mth""=""a"".""mth"" GROUP BY 1 ORDER BY 1) SELECT ""r"".""mth"" AS ""month"",COALESCE(ROUND((""accepted_ride""/""driver_cnt"")*100, 2), 0) AS ""working_percentage"" FROM ""r"" JOIN ""d"" ON ""r"".""mth""=""d"".""mth"" ORDER BY 1"
164,"WITH RECURSIVE ""monthcount"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 AS ""month"" FROM ""monthcount"" WHERE ""month""<12) SELECT ""t1"".""month"",ROUND(COALESCE(""t2"".""active_drivers""*100/""t1"".""available_drivers"", 0), 2) AS ""working_percentage"" FROM (SELECT ""m"".""month"",COUNT(""d"".""driver_id"") AS ""available_drivers"" FROM ""monthcount"" AS ""m"" LEFT JOIN ""drivers"" AS ""d"" ON ""d"".""join_date""<=LAST_DAY(CONCAT('2020-', ""m"".""month"", '-1')) GROUP BY ""m"".""month"") AS ""t1"" LEFT JOIN (SELECT EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""active_drivers"" FROM ""rides"" AS ""r"" JOIN ""acceptedrides"" AS ""ar"" ON ""r"".""ride_id""=""ar"".""ride_id"" AND EXTRACT(YEAR FROM ""r"".""requested_at"")=2020 GROUP BY EXTRACT(MONTH FROM ""r"".""requested_at"")) AS ""t2"" ON ""t1"".""month""=""t2"".""month"" ORDER BY ""t1"".""month"""
165,"WITH RECURSIVE ""cte"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""cte"" WHERE ""month""<12), ""t1"" AS (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(""driver_id"") OVER (ORDER BY ""join_date"") AS ""active_drivers"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020), ""t2"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""accepted_rides"" FROM ""rides"" AS ""r"" JOIN ""AcceptedRides"" AS ""ar"" ON ""r"".""ride_id""=""ar"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY EXTRACT(MONTH FROM ""requested_at"")) SELECT DISTINCT ""c"".""month"",ROUND(COALESCE(""accepted_rides""/COALESCE(MAX(""active_drivers"") OVER (ORDER BY ""c"".""month""), 0)*100, 0), 2) AS ""working_percentage"" FROM (""cte"" AS ""c"" LEFT JOIN ""t1"" ON ""c"".""month""=""t1"".""month"") LEFT JOIN ""t2"" ON ""c"".""month""=""t2"".""month"""
166,"WITH ""c1"" AS (SELECT CASE WHEN EXTRACT(YEAR FROM ""join_date"")<2020 THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""month"",COUNT(""driver_id"") AS ""active_drivers"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020 GROUP BY 1), ""c2"" AS (WITH RECURSIVE ""se"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 AS ""month"" FROM ""se"" WHERE ""month""<12) SELECT * FROM ""se""), ""c3"" AS (SELECT EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""month"",COUNT(DISTINCT ""a"".""driver_id"") AS ""working_drivers"" FROM ""Rides"" AS ""r"" LEFT JOIN ""AcceptedRides"" AS ""a"" ON ""r"".""ride_id""=""a"".""ride_id"" WHERE EXTRACT(YEAR FROM ""r"".""requested_at"")=2020 GROUP BY 1) SELECT ""c2"".""month"",ROUND(COALESCE(""c3"".""working_drivers""/SUM(COALESCE(""c1"".""active_drivers"", 0)) OVER (ORDER BY ""c2"".""month"")*100, 0), 2) AS ""working_percentage"" FROM (""c2"" LEFT JOIN ""c1"" ON ""c2"".""month""=""c1"".""month"") LEFT JOIN ""c3"" ON ""c2"".""month""=""c3"".""month"" ORDER BY 1"
167,"WITH RECURSIVE ""temp"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""temp"" WHERE ""month""<12), ""temp2"" AS (SELECT ""month"",COUNT(""driver_id"") AS ""driver_num"" FROM (SELECT ""driver_id"",""join_date"",CASE WHEN ""join_date""<'2020-01-01' THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""month"" FROM ""Drivers"" WHERE ""join_date""<='2020-12-31') AS ""a"" GROUP BY ""month"" ORDER BY ""month""), ""temp3"" AS (SELECT ""temp"".""month"",SUM(COALESCE(""driver_num"", 0)) OVER (ORDER BY ""month"") AS ""active_drivers"" FROM ""temp"" LEFT JOIN ""temp2"" ON ""temp"".""month""=""temp2"".""month""), ""temp4"" AS (SELECT ""AcceptedRides"".""ride_id"",""AcceptedRides"".""driver_id"",EXTRACT(MONTH FROM ""requested_at"") AS ""month"" FROM ""AcceptedRides"" LEFT JOIN ""Rides"" ON ""AcceptedRides"".""ride_id""=""Rides"".""ride_id"" WHERE ""requested_at"" BETWEEN '2020-01-01' AND '2020-12-31') SELECT ""temp"".""month"",ROUND(COALESCE(COALESCE(""accepted_rides"", 0)*100/""active_drivers"", 0), 2) AS ""working_percentage"" FROM (""temp"" LEFT JOIN ""temp3"" ON ""temp"".""month""=""temp3"".""month"") LEFT JOIN (SELECT ""month"",COUNT(DISTINCT ""driver_id"") AS ""accepted_rides"" FROM ""temp4"" GROUP BY ""month"") AS ""temp5"" ON ""temp"".""month""=""temp5"".""month"""
168,"WITH RECURSIVE ""all_month"" AS (SELECT '2020-01-01' AS ""mon"" UNION SELECT ""mon"" + INTERVAL '1 MONTH' AS ""mon"" FROM ""all_month"" WHERE ""mon"" + INTERVAL '1 MONTH'<='2020-12-31'), ""monthly_driver"" AS (SELECT EXTRACT(MONTH FROM ""m"".""mon"") AS ""month"",COUNT(DISTINCT ""d"".""driver_id"") AS ""n_monthly_driver"" FROM ""all_month"" AS ""m"" LEFT JOIN ""Drivers"" AS ""d"" ON TO_CHAR(""d"".""join_date"", 'YYYY%m')<=TO_CHAR(""m"".""mon"", 'YYYY%m') GROUP BY ""m"".""mon""), ""accepted"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""ar"".""driver_id"") AS ""n_driver"" FROM ""AcceptedRides"" AS ""ar"" LEFT JOIN ""Rides"" AS ""r"" ON ""ar"".""ride_id""=""r"".""ride_id"" WHERE ""r"".""requested_at"" BETWEEN '2020-01-01' AND '2020-12-31' GROUP BY ""month"") SELECT ""md"".""month"",CASE WHEN ""a"".""n_driver"">0 THEN ROUND(""a"".""n_driver""/""md"".""n_monthly_driver""*100, 2) ELSE 0 END AS ""working_percentage"" FROM ""monthly_driver"" AS ""md"" LEFT JOIN ""accepted"" AS ""a"" ON ""md"".""month""=""a"".""month"""
169,"WITH RECURSIVE ""months"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""months"" WHERE ""month""<12) SELECT ""m"".""month"",CASE WHEN COUNT(DISTINCT ""d"".""driver_id"")>0 THEN ROUND(COUNT(DISTINCT ""t"".""driver_id"")*100.0/COUNT(DISTINCT ""d"".""driver_id""), 2) ELSE 0 END AS ""working_percentage"" FROM (""months"" AS ""m"" LEFT JOIN ""Drivers"" AS ""d"" ON EXTRACT(YEAR FROM ""d"".""join_date"")<2020 OR (EXTRACT(YEAR FROM ""d"".""join_date"")=2020 AND EXTRACT(MONTH FROM ""d"".""join_date"")<=""m"".""month"")) LEFT JOIN (SELECT ""driver_id"",""requested_at"" FROM ""AcceptedRides"" AS ""a"" JOIN ""Rides"" AS ""r"" ON ""a"".""ride_id""=""r"".""ride_id"") AS ""t"" ON EXTRACT(YEAR FROM ""t"".""requested_at"")=2020 AND ""m"".""month""=EXTRACT(MONTH FROM ""t"".""requested_at"") AND ""d"".""driver_id""=""t"".""driver_id"" GROUP BY ""m"".""month"" ORDER BY ""m"".""month"""
170,"WITH RECURSIVE ""month_series"" AS (SELECT 1 AS ""mon"" UNION SELECT ""mon""+1 AS ""mon"" FROM ""month_series"" WHERE ""mon""<12), ""available_users_monthly"" AS (SELECT ""m"".""mon"",COALESCE(COUNT(DISTINCT ""d"".""driver_id""), 0.00) AS ""cnt"" FROM ""month_series"" AS ""m"" LEFT JOIN ""Drivers"" AS ""d"" ON (""d"".""join_date""<'2020-01-01' OR (EXTRACT(YEAR FROM ""d"".""join_date"")=2020 AND ""m"".""mon"">=EXTRACT(MONTH FROM ""d"".""join_date""))) GROUP BY ""m"".""mon""), ""working_drivers_monthly"" AS (SELECT ""m"".""mon"",COALESCE(COUNT(DISTINCT ""ar"".""driver_id""), 0.00) AS ""cnt"" FROM (""month_series"" AS ""m"" LEFT JOIN ""rides"" AS ""r"" ON (EXTRACT(YEAR FROM ""r"".""requested_at"")=2020 AND EXTRACT(MONTH FROM ""r"".""requested_at"")=""m"".""mon"")) LEFT JOIN ""AcceptedRides"" AS ""ar"" ON (""r"".""ride_id""=""ar"".""ride_id"") GROUP BY ""m"".""mon"") SELECT ""a"".""mon"" AS ""month"",COALESCE(ROUND((""w"".""cnt""*100.0)/""a"".""cnt"", 2), 0.00) AS ""working_percentage"" FROM ""available_users_monthly"" AS ""a"" JOIN ""working_drivers_monthly"" AS ""w"" ON (""a"".""mon""=""w"".""mon"")"
171,"WITH RECURSIVE ""cte"" (""month"") AS (SELECT 1 UNION ALL SELECT ""month""+1 FROM ""cte"" WHERE ""month""<12), ""t"" AS (SELECT ""a"".""join_date"",COUNT(DISTINCT ""b"".""driver_id"") AS ""drivers"" FROM ""Drivers"" AS ""a"" JOIN ""Drivers"" AS ""b"" WHERE ""a"".""join_date"">=""b"".""join_date"" GROUP BY ""a"".""join_date""), ""t1"" AS (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",MAX(""drivers"") AS ""drivers"" FROM ""t"" WHERE EXTRACT(YEAR FROM ""join_date"")='2020' GROUP BY ""month""), ""t2"" AS (SELECT ""cte"".""month"",CASE WHEN ""t1"".""drivers"" IS NULL THEN 0 ELSE ""drivers"" END AS ""drivers"" FROM ""cte"" LEFT JOIN ""t1"" ON ""cte"".""month""=""t1"".""month""), ""t3"" AS (SELECT ""a"".""month"",MAX(""b"".""drivers"") AS ""drivers"" FROM ""t2"" AS ""a"" JOIN ""t2"" AS ""b"" ON ""a"".""month"">=""b"".""month"" GROUP BY ""a"".""month""), ""t4"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""cnt"" FROM ""Rides"" AS ""r"" JOIN ""AcceptedRides"" AS ""a"" ON ""r"".""ride_id""=""a"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")='2020' GROUP BY ""month"") SELECT ""t3"".""month"",CASE WHEN ""cnt"" IS NULL THEN 0.00 ELSE ROUND(""cnt""/""drivers""*100, 2) END AS ""working_percentage"" FROM ""t3"" LEFT JOIN ""t4"" ON ""t3"".""month""=""t4"".""month"" ORDER BY ""month"""
172,"WITH RECURSIVE ""cte"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 AS ""month"" FROM ""cte"" WHERE ""month""<12), ""available_drivers_tbl"" AS (SELECT ""cte"".""month"",SUM(""available_drivers"") OVER (ORDER BY ""month"") AS ""avail_drivers"" FROM ""cte"" LEFT JOIN (SELECT CASE WHEN ""join_date""<'2020-01-01' THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""month"",COUNT(""driver_id"") AS ""available_drivers"" FROM ""Drivers"" WHERE ""join_date""<'2021-01-01' GROUP BY 1) AS ""tmp"" ON ""cte"".""month""=""tmp"".""month"") SELECT ""avail"".""month"",ROUND(100.0*COALESCE(""accepted"".""driver_cnt""/""avail"".""avail_drivers"", 0), 2) AS ""working_percentage"" FROM ""available_drivers_tbl"" AS ""avail"" LEFT JOIN (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""driver_cnt"" FROM ""AcceptedRides"" AS ""a"" JOIN ""Rides"" AS ""r"" ON ""a"".""ride_id""=""r"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY 1) AS ""accepted"" ON ""avail"".""month""=""accepted"".""month"" ORDER BY ""avail"".""month"""
173,"WITH RECURSIVE ""months"" (""month"") AS (SELECT 1 UNION ALL SELECT ""month""+1 FROM ""months"" WHERE ""month""<12), ""t1"" AS (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(""driver_id"") OVER (ORDER BY ""join_date"") AS ""active_drivers"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020), ""t2"" AS (SELECT EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""month"",COUNT(DISTINCT ""ar"".""driver_id"") AS ""drivers_accepted"" FROM ""AcceptedRides"" AS ""ar"" JOIN ""Rides"" AS ""r"" ON ""ar"".""ride_id""=""r"".""ride_id"" WHERE EXTRACT(YEAR FROM ""r"".""requested_at"")=2020 GROUP BY ""month"") SELECT DISTINCT ""m"".""month"",ROUND(COALESCE(""drivers_accepted""/MAX(""t1"".""active_drivers"") OVER (ORDER BY ""m"".""month"")*100, 0), 2) AS ""working_percentage"" FROM (""months"" AS ""m"" LEFT JOIN ""t1"" ON ""m"".""month""=""t1"".""month"") LEFT JOIN ""t2"" ON ""m"".""month""=""t2"".""month"""
174,"WITH RECURSIVE ""CTE1"" AS (SELECT 1 AS ""month"" UNION SELECT 1+""month"" FROM ""CTE1"" WHERE ""month""<12), ""CTE2"" AS (SELECT EXTRACT(MONTH FROM CASE WHEN ""join_date""<='2019-12-31' THEN '2020-01-01' ELSE ""join_date"" END) AS ""month"",COUNT(""driver_id"") AS ""den"" FROM ""Drivers"" WHERE ""join_date""<='2020-12-31' GROUP BY 1), ""CTE3"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""d2"".""driver_id"") AS ""num"" FROM ""Rides"" AS ""d1"" JOIN ""AcceptedRides"" AS ""d2"" ON ""d1"".""ride_id""=""d2"".""ride_id"" WHERE EXTRACT(YEAR FROM ""d1"".""requested_at"")=2020 GROUP BY 1) SELECT ""d1"".""month"",ROUND(100.00*COALESCE(""d3"".""num""/SUM(""den"") OVER (ORDER BY ""d1"".""month""), 0), 2) AS ""working_percentage"" FROM (""CTE1"" AS ""d1"" LEFT JOIN ""CTE2"" AS ""d2"" ON ""d1"".""month""=""d2"".""month"") LEFT JOIN ""CTE3"" AS ""d3"" ON ""d1"".""month""=""d3"".""month"" ORDER BY 1"
175,"WITH RECURSIVE ""months"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""months"" WHERE ""month""<12), ""driver_month"" AS (SELECT ""month"",SUM(""driver_cnt"") OVER (ORDER BY ""month"")+(SELECT COUNT(1) FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<2020) AS ""driver_cnt"" FROM (SELECT ""t1"".""month"",COALESCE(""t2"".""driver_cnt"", 0) AS ""driver_cnt"" FROM ""months"" AS ""t1"" LEFT JOIN (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(1) AS ""driver_cnt"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")=2020 GROUP BY EXTRACT(MONTH FROM ""join_date"")) AS ""t2"" ON ""t1"".""month""=""t2"".""month"") AS ""t""), ""working_driver_month"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""working_driver_cnt"" FROM ""AcceptedRides"" AS ""t1"" JOIN ""Rides"" AS ""t2"" ON ""t1"".""ride_id""=""t2"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY EXTRACT(MONTH FROM ""requested_at"")) SELECT ""t1"".""month"",COALESCE(ROUND(COALESCE(""working_driver_cnt"", 0)/""driver_cnt""*100, 2), 0.00) AS ""working_percentage"" FROM ""driver_month"" AS ""t1"" LEFT JOIN ""working_driver_month"" AS ""t2"" ON ""t1"".""month""=""t2"".""month"" ORDER BY ""t1"".""month"""
176,"WITH RECURSIVE ""active_driver"" AS (SELECT ""driver_id"",""join_date"",""join_date"" AS ""dur"" FROM ""drivers"" UNION SELECT ""driver_id"",""join_date"",""dur"" + INTERVAL '1 MONTH' AS ""dur"" FROM ""active_driver"" WHERE ""dur""<LAST_DAY(CURDATE()) + INTERVAL '1 MONTH'), ""datedim"" AS (SELECT 1 AS ""m"" UNION SELECT ""m""+1 FROM ""datedim"" WHERE ""m""<12) SELECT ""m"" AS ""month"",ROUND(COALESCE(""wd"".""working_driver"", 0)*100/COALESCE(""ad"".""monthly_ad"", 1), 2) AS ""working_percentage"" FROM (""datedim"" AS ""dd"" LEFT JOIN (SELECT EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""month"",COUNT(DISTINCT ""ar"".""driver_id"") AS ""working_driver"" FROM ""acceptedrides"" AS ""ar"" JOIN ""rides"" AS ""r"" ON ""r"".""ride_id""=""ar"".""ride_id"" WHERE EXTRACT(YEAR FROM ""r"".""requested_at"")=2020 GROUP BY EXTRACT(MONTH FROM ""r"".""requested_at"")) AS ""wd"" ON ""wd"".""month""=""dd"".""m"") LEFT JOIN (SELECT EXTRACT(MONTH FROM ""dur"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""monthly_ad"" FROM ""active_driver"" WHERE EXTRACT(YEAR FROM ""dur"")=2020 GROUP BY EXTRACT(MONTH FROM ""dur"")) AS ""ad"" ON ""ad"".""month""=""dd"".""m"""
177,"WITH RECURSIVE ""cte1"" (""day"") AS (SELECT STR_TO_DATE('2020-1-31', '%Y-%m-%d') UNION ALL SELECT LAST_DAY(""day"" + INTERVAL '1 MONTH') FROM ""cte1"" WHERE ""day""<'2020-12-1'), ""cte2"" AS (SELECT EXTRACT(MONTH FROM ""day"") AS ""month"",COUNT(""driver_id"") AS ""active_drivers"" FROM ""cte1"" LEFT JOIN ""drivers"" ON ""join_date""<=""day"" GROUP BY ""month""), ""cte3"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""working_drivers"" FROM ""AcceptedRides"" NATURAL JOIN ""Rides"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY ""month"") SELECT ""cte2"".""month"",(CASE WHEN ""active_drivers""=0 THEN ROUND(0, 2) ELSE ROUND(COALESCE(""working_drivers"", 0)/""active_drivers""*100, 2) END) AS ""working_percentage"" FROM ""cte2"" LEFT JOIN ""cte3"" ON ""cte2"".""month""=""cte3"".""month"" ORDER BY 1"
178,"WITH RECURSIVE ""month12"" AS (SELECT 1 AS ""month"" UNION SELECT ""month""+1 FROM ""month12"" WHERE ""month""<12), ""total_driver"" AS (SELECT ""month12"".""month"",COALESCE(MAX(""tmp"".""rolling_total"") OVER (ORDER BY ""month""), 0) AS ""total_driver"" FROM ""month12"" LEFT JOIN (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""join_month"",COUNT(""driver_id"") OVER (ORDER BY ""join_date"" ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS ""rolling_total"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020) AS ""tmp"" ON ""tmp"".""join_month""=""month12"".""month""), ""accept_driver"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""accept_month"",COUNT(DISTINCT ""driver_id"") AS ""accept_driver"" FROM ""acceptedrides"" AS ""ar"" JOIN ""rides"" AS ""r"" ON ""r"".""ride_id""=""ar"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY 1) SELECT ""month12"".""month"",COALESCE(ROUND(""accept_driver""/""total_driver""*100, 2), 0) AS ""working_percentage"" FROM (""month12"" LEFT JOIN ""total_driver"" ON ""total_driver"".""month""=""month12"".""month"") LEFT JOIN ""accept_driver"" ON ""accept_driver"".""accept_month""=""month12"".""month"" GROUP BY 1"
179,"WITH RECURSIVE ""CTE1"" AS (SELECT 1 AS ""month"" UNION SELECT ""month""+1 FROM ""CTE1"" WHERE ""month""<12), ""CTE2"" AS (SELECT ""month"",COUNT(DISTINCT ""driver_id"") AS ""drivers_den"" FROM (SELECT *,CASE WHEN ""join_date""<='2019-12-31' THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""month"" FROM ""Drivers"" WHERE ""join_date""<='2020-12-31') AS ""sub"" GROUP BY ""month""), ""CTE3"" AS (SELECT EXTRACT(MONTH FROM ""d1"".""requested_at"") AS ""month"",COUNT(DISTINCT ""d2"".""driver_id"") AS ""drivers_num"" FROM ""Rides"" AS ""d1"" JOIN ""AcceptedRides"" AS ""d2"" ON ""d1"".""ride_id""=""d2"".""ride_id"" WHERE ""d1"".""requested_at"" BETWEEN '2020-01-01' AND '2020-12-31' GROUP BY EXTRACT(MONTH FROM ""d1"".""requested_at"")) SELECT ""d1"".""month"",ROUND(100.00*COALESCE(""drivers_num""/SUM(""drivers_den"") OVER (ORDER BY ""month""), 0), 2) AS ""working_percentage"" FROM (""CTE1"" AS ""d1"" LEFT JOIN ""CTE2"" AS ""d2"" ON ""d1"".""month""=""d2"".""month"") LEFT JOIN ""CTE3"" AS ""d3"" ON ""d1"".""month""=""d3"".""month"" GROUP BY ""d1"".""month"" ORDER BY 1"
180,"WITH RECURSIVE ""CTE"" AS (SELECT 1 AS ""month"" UNION SELECT ""month""+1 FROM ""CTE"" WHERE ""month""<12), ""Available_Drivers"" AS (SELECT ""month"",SUM(""drivers"") OVER (ORDER BY ""month"") AS ""drivers"" FROM (SELECT ""c"".""month"",COALESCE(""a"".""drivers"", 0) AS ""drivers"" FROM ""CTE"" AS ""c"" LEFT JOIN (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(""driver_id"") AS ""drivers"" FROM ""Drivers"" WHERE ""join_date"" BETWEEN '2020-1-1' AND '2020-12-31' GROUP BY 1) AS ""a"" ON ""c"".""month""=""a"".""month"" UNION SELECT 0 AS ""month"",COUNT(""driver_id"") AS ""drivers"" FROM ""Drivers"" WHERE ""join_date""<'2020-1-1') AS ""accumulated_drivers""), ""Accepted_Drivers"" AS (SELECT ""c"".""month"",COALESCE(""ac"".""acpt_drivers"", 0) AS ""acpt_drivers"" FROM ""CTE"" AS ""c"" LEFT JOIN (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""acpt_drivers"" FROM (SELECT ""A"".""ride_id"",""A"".""driver_id"",""R"".""requested_at"" FROM ""AcceptedRides"" AS ""A"" JOIN ""Rides"" AS ""R"" ON ""A"".""ride_id""=""R"".""ride_id"" WHERE ""R"".""requested_at"" BETWEEN '2020-1-1' AND '2020-12-31') AS ""Accepted"" GROUP BY 1) AS ""ac"" ON ""c"".""month""=""ac"".""month"") SELECT ""avd"".""month"" AS ""month"",ROUND(COALESCE(""acd"".""acpt_drivers""/""avd"".""drivers"", 0)*100, 2) AS ""working_percentage"" FROM ""Available_Drivers"" AS ""avd"" JOIN ""Accepted_Drivers"" AS ""acd"" ON ""avd"".""month""=""acd"".""month"""
181,"WITH RECURSIVE ""months"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""months"" WHERE ""month""<12) SELECT ""t"".""month"",COALESCE(ROUND(100*(SELECT COUNT(DISTINCT ""driver_id"") FROM ""AcceptedRides"" AS ""a"" JOIN ""Rides"" AS ""b"" USING (""ride_id"") WHERE EXTRACT(MONTH FROM ""requested_at"")=""t"".""month"" AND EXTRACT(YEAR FROM ""requested_at"")=2020)/(SELECT COUNT(""driver_id"") FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<2021 AND (EXTRACT(MONTH FROM ""join_date"")<=""t"".""month"" OR EXTRACT(YEAR FROM ""join_date"")<2020)), 2), 0) AS ""working_percentage"" FROM ""months"" AS ""t"" ORDER BY ""month"""
182,"WITH RECURSIVE ""MONTHS"" AS (SELECT 1 AS ""MONTH"" UNION SELECT ""MONTH""+1 AS ""MONTH"" FROM ""MONTHS"" WHERE ""MONTH""<12), ""ACTIVE_DRIVERS"" AS (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(""driver_id"") OVER (ORDER BY ""join_date"") AS ""active_drivers"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020), ""ACCEPTED_DRIVERS"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""DRIVER_ID"") AS ""accepted_DRIVERS"" FROM ""AcceptedRides"" JOIN ""rides"" USING (""ride_id"") WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY ""month"") SELECT DISTINCT ""M"".""MONTH"" AS ""month"",CASE WHEN COALESCE(MAX(""active_drivers"") OVER (ORDER BY ""month""), 0)=0 THEN 0 ELSE ROUND(100*COALESCE(""accepted_DRIVERS"", 0)/COALESCE(MAX(""active_drivers"") OVER (ORDER BY ""month""), 0), 2) END AS ""working_percentage"" FROM (""MONTHS"" AS ""M"" LEFT JOIN ""ACTIVE_DRIVERS"" AS ""AD"" ON ""M"".""MONTH""=""AD"".""MONTH"") LEFT JOIN ""ACCEPTED_DRIVERS"" AS ""AD1"" ON ""M"".""MONTH""=""AD1"".""MONTH"""
183,"WITH RECURSIVE ""monthtable"" AS (SELECT 1 AS ""month_num"" UNION ALL SELECT ""month_num""+1 FROM ""monthtable"" WHERE ""month_num""<12), ""AvailableDrivers"" AS (SELECT ""month_num"",COUNT(""driver_id"") AS ""available_drivers_num"" FROM ""monthtable"" AS ""M1"" LEFT JOIN ""Drivers"" AS ""D1"" ON (""M1"".""month_num"">=EXTRACT(MONTH FROM ""join_date"") AND EXTRACT(YEAR FROM ""join_date"")=2020) OR EXTRACT(YEAR FROM ""join_date"")<2020 GROUP BY ""month_num""), ""WorkingDrivers"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month_num"",COUNT(DISTINCT ""driver_id"") AS ""working_drivers_num"" FROM ""AcceptedRides"" AS ""A1"" JOIN ""Rides"" AS ""R1"" ON ""A1"".""ride_id""=""R1"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY ""month_num"") SELECT ""A2"".""month_num"" AS ""month"",ROUND(COALESCE(""working_drivers_num""/COALESCE(""available_drivers_num"", 0), 0)*100, 2) AS ""working_percentage"" FROM ""AvailableDrivers"" AS ""A2"" LEFT JOIN ""WorkingDrivers"" AS ""W1"" ON ""A2"".""month_num""=""W1"".""month_num"" ORDER BY ""month"""
184,"WITH RECURSIVE ""tbMonth"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""tbMonth"" WHERE ""month""<12), ""tbWorkingD"" AS (SELECT EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""month"",COUNT(DISTINCT ""ar"".""driver_id"") AS ""cnt_working_drivers"" FROM ""AcceptedRides"" AS ""ar"" JOIN ""rides"" AS ""r"" ON ""ar"".""ride_id""=""r"".""ride_id"" WHERE EXTRACT(YEAR FROM ""r"".""requested_at"")=2020 GROUP BY EXTRACT(MONTH FROM ""r"".""requested_at"")), ""tbAvailableD"" AS (SELECT ""tbMonth"".""month"",COUNT(DISTINCT ""d"".""driver_id"") AS ""cnt_available_drivers"" FROM ""tbMonth"" LEFT JOIN ""drivers"" AS ""d"" ON (EXTRACT(YEAR FROM ""d"".""join_date"")<2020 OR (EXTRACT(YEAR FROM ""d"".""join_date"")=2020 AND ""tbMonth"".""month"">=EXTRACT(MONTH FROM ""d"".""join_date""))) GROUP BY ""tbMonth"".""month"") SELECT ""tbAvailableD"".""month"",ROUND(COALESCE(""tbWorkingD"".""cnt_working_drivers""/""tbAvailableD"".""cnt_available_drivers"", 0)*100, 2) AS ""working_percentage"" FROM ""tbAvailableD"" LEFT JOIN ""tbWorkingD"" ON ""tbWorkingD"".""month""=""tbAvailableD"".""month"""
185,"WITH RECURSIVE ""b"" AS (SELECT 1 AS ""month"",(SELECT COUNT(""driver_id"") FROM ""Drivers"" WHERE ""join_date""<'2020-02-01') AS ""active_drivers"" UNION ALL SELECT ""month""+1,(SELECT COUNT(""driver_id"") FROM ""Drivers"" WHERE ""join_date""<CASE WHEN ""month""+2>12 THEN '2021-01-01' ELSE CONCAT('2020-', ""month""+2, '-01') END) AS ""active_drivers"" FROM ""b"" WHERE ""month""<12), ""a"" AS (SELECT COUNT(DISTINCT ""ar"".""driver_id"") AS ""working_drivers"",TO_CHAR(""requested_at"", 'YYYY-%m') AS ""requested_at"" FROM ""Rides"" AS ""r"" JOIN ""AcceptedRides"" AS ""ar"" USING (""ride_id"") WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY 2), ""c"" AS (SELECT ""working_drivers"",CASE WHEN RIGHT(""requested_at"", 2) LIKE '0%' THEN RIGHT(""requested_at"", 1) ELSE RIGHT(""requested_at"", 2) END AS ""month"" FROM ""a""), ""d"" AS (SELECT ""b"".*,COALESCE(""working_drivers"", 0) AS ""working_drivers"" FROM ""b"" LEFT JOIN ""c"" USING (""month"")) SELECT ""month"",ROUND(CASE WHEN ""active_drivers""=0 THEN 0 ELSE 100*""working_drivers""/""active_drivers"" END, 2) AS ""working_percentage"" FROM ""d"""
186,"WITH ""months"" AS (SELECT 1 AS ""month"" UNION SELECT 2 AS ""month"" UNION SELECT 3 AS ""month"" UNION SELECT 4 AS ""month"" UNION SELECT 5 AS ""month"" UNION SELECT 6 AS ""month"" UNION SELECT 7 AS ""month"" UNION SELECT 8 AS ""month"" UNION SELECT 9 AS ""month"" UNION SELECT 10 AS ""month"" UNION SELECT 11 AS ""month"" UNION SELECT 12 AS ""month""), ""drivers_joined"" AS (SELECT ""month"",COUNT(DISTINCT ""driver_id"") AS ""n_drivers_joined"" FROM ""months"" AS ""a"" LEFT JOIN (SELECT * FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020) AS ""b"" ON ""a"".""month""=(CASE WHEN EXTRACT(YEAR FROM ""join_date"")<2020 THEN 1 ELSE EXTRACT(MONTH FROM ""b"".""join_date"") END) GROUP BY 1), ""drivers_accepted"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""n_drivers_active"" FROM ""Rides"" AS ""a"" LEFT JOIN ""AcceptedRides"" AS ""b"" ON ""a"".""ride_id""=""b"".""ride_id"" WHERE EXTRACT(YEAR FROM ""a"".""requested_at"")=2020 GROUP BY 1) SELECT ""a"".""month"",ROUND(COALESCE(""n_drivers_active""/SUM(""n_drivers_joined"") OVER (ORDER BY ""month"")*100, 0), 2) AS ""working_percentage"" FROM ""drivers_joined"" AS ""a"" LEFT JOIN ""drivers_accepted"" AS ""b"" ON ""a"".""month""=""b"".""month"""
187,"WITH RECURSIVE ""months"" (""month"") AS (SELECT 1 UNION ALL SELECT ""month""+1 FROM ""months"" WHERE ""month""<12), ""t1"" AS (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(""driver_id"") OVER (ORDER BY ""join_date"") AS ""driver_count"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020), ""t2"" AS (SELECT EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""month"",COUNT(DISTINCT ""a"".""driver_id"") AS ""active_driver"" FROM ""Rides"" AS ""r"" JOIN ""AcceptedRides"" AS ""a"" ON ""r"".""ride_id""=""a"".""ride_id"" WHERE EXTRACT(YEAR FROM ""r"".""requested_at"")=2020 GROUP BY EXTRACT(MONTH FROM ""r"".""requested_at"")) SELECT ""a"".""month"",ROUND(COALESCE(""a"".""act_cnt""/""a"".""tot_cnt""*100, 0), 2) AS ""working_percentage"" FROM (SELECT DISTINCT ""m"".""month"",COALESCE(MAX(""t1"".""driver_count"") OVER (ORDER BY ""m"".""month""), 0) AS ""tot_cnt"",COALESCE(""t2"".""active_driver"", 0) AS ""act_cnt"" FROM (""months"" AS ""m"" LEFT JOIN ""t1"" ON ""m"".""month""=""t1"".""month"") LEFT JOIN ""t2"" ON ""m"".""month""=""t2"".""month"") AS ""a"""
188,"WITH RECURSIVE ""s1"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""s1"" WHERE ""month""<12), ""s2a"" AS (SELECT (CASE WHEN EXTRACT(YEAR FROM ""join_date"")<2020 THEN 1 WHEN EXTRACT(YEAR FROM ""join_date"")=2020 THEN EXTRACT(MONTH FROM ""join_date"") ELSE 0 END) AS ""month"",COUNT(1) AS ""c1"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020 GROUP BY 1), ""s2b"" AS (SELECT ""s1"".""month"",SUM(""c1"") OVER (ORDER BY ""s1"".""month"" ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS ""drivers_available"" FROM ""s1"" LEFT JOIN ""s2a"" ON ""s1"".""month""=""s2a"".""month""), ""s3"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""accepted_rides"" FROM ""Rides"" AS ""r"" JOIN ""AcceptedRides"" AS ""a"" ON ""r"".""ride_id""=""a"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY 1) SELECT ""s2b"".""month"",ROUND(COALESCE(""s3"".""accepted_rides""/""s2b"".""drivers_available"", 0)*100, 2) AS ""working_percentage"" FROM ""s2b"" LEFT JOIN ""s3"" ON ""s2b"".""month""=""s3"".""month"""
189,"WITH RECURSIVE ""cte_month_spine"" AS (SELECT 1 AS ""n"" UNION ALL SELECT ""n""+1 AS ""n"" FROM ""cte_month_spine"" WHERE ""n""<12), ""cte_available_drivers"" AS (SELECT ""ms"".""n"" AS ""month"",COUNT(""driver_id"") AS ""available_drivers"" FROM ""cte_month_spine"" AS ""ms"" LEFT JOIN ""Drivers"" AS ""d"" ON LAST_DAY(CONCAT('2020-', ""ms"".""n"", '-01'))>=""d"".""join_date"" GROUP BY 1), ""cte_working_drivers"" AS (SELECT ""ms"".""n"" AS ""month"",COUNT(DISTINCT ""ar"".""driver_id"") AS ""working_drivers"" FROM (""cte_month_spine"" AS ""ms"" LEFT JOIN ""Rides"" AS ""r"" ON ""r"".""requested_at"" BETWEEN CONCAT('2020-', ""ms"".""n"", '-01') AND LAST_DAY(CONCAT('2020-', ""ms"".""n"", '-01'))) LEFT JOIN ""AcceptedRides"" AS ""ar"" ON ""r"".""ride_id""=""ar"".""ride_id"" GROUP BY 1), ""cte_final"" AS (SELECT ""ad"".""month"",ROUND(100*COALESCE(""working_drivers""/""available_drivers"", 0), 2) AS ""working_percentage"" FROM ""cte_available_drivers"" AS ""ad"" JOIN ""cte_working_drivers"" AS ""wd"" ON ""ad"".""month""=""wd"".""month"" ORDER BY 1) SELECT * FROM ""cte_final"""
190,"WITH RECURSIVE ""MONTHS"" AS (SELECT 1 AS ""MONTH"" UNION SELECT ""MONTH""+1 AS ""MONTH"" FROM ""MONTHS"" WHERE ""MONTH""<12), ""ACTIVE_DRIVERS"" AS (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(""driver_id"") OVER (ORDER BY ""join_date"") AS ""active_drivers"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020), ""ACCEPTED_DRIVERS"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""DRIVER_ID"") AS ""accepted_DRIVERS"" FROM ""AcceptedRides"" JOIN ""rides"" USING (""ride_id"") WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY ""month"") SELECT DISTINCT ""M"".""MONTH"" AS ""month"",COALESCE(ROUND(100*""accepted_DRIVERS""/MAX(""active_drivers"") OVER (ORDER BY ""month""), 2), 0) AS ""working_percentage"" FROM (""MONTHS"" AS ""M"" LEFT JOIN ""ACTIVE_DRIVERS"" AS ""AD"" ON ""M"".""MONTH""=""AD"".""MONTH"") LEFT JOIN ""ACCEPTED_DRIVERS"" AS ""AD1"" ON ""M"".""MONTH""=""AD1"".""MONTH"""
191,"WITH RECURSIVE ""CET"" AS (SELECT 1 AS ""month"" UNION ALL SELECT 1+""month"" AS ""month"" FROM ""CET"" WHERE 1+""month""<=12), ""CET2"" AS (SELECT SUM(CASE WHEN ""driver_id"" IS NOT NULL THEN 1 ELSE 0 END) AS ""driver_count"",""CET"".""month"" FROM ""CET"" LEFT JOIN (SELECT *,EXTRACT(MONTH FROM ""join_date"") AS ""month"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")=2020) AS ""d"" ON ""d"".""month""=""CET"".""month"" GROUP BY ""CET"".""month"" UNION ALL SELECT COUNT(""driver_id"") AS ""driver_count"",0 AS ""month"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<2020), ""CET3"" AS (SELECT COUNT(DISTINCT ""driver_id"") AS ""working_driver"",EXTRACT(MONTH FROM ""requested_at"") AS ""month"" FROM ""AcceptedRides"" AS ""a1"" LEFT JOIN ""Rides"" AS ""a2"" ON ""a1"".""ride_id""=""a2"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY EXTRACT(MONTH FROM ""requested_at"")) SELECT ""b1"".""month"",ROUND(COALESCE(""working_driver""/""driver_count""*100, 0), 2) AS ""working_percentage"" FROM (SELECT SUM(""driver_count"") OVER (ORDER BY ""month"") AS ""driver_count"",""month"" FROM ""CET2"") AS ""b1"" LEFT JOIN ""CET3"" ON ""b1"".""month""=""CET3"".""month"" WHERE ""b1"".""month""!=0"
192,"WITH RECURSIVE ""months"" (""month"") AS (SELECT 1 UNION ALL SELECT ""month""+1 FROM ""months"" WHERE ""month""<12), ""t1"" AS (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(""driver_id"") OVER (ORDER BY ""join_date"") AS ""driver_count"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020), ""t2"" AS (SELECT EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""month"",COUNT(DISTINCT ""a"".""driver_id"") AS ""active_driver"" FROM ""Rides"" AS ""r"" JOIN ""AcceptedRides"" AS ""a"" ON ""r"".""ride_id""=""a"".""ride_id"" WHERE EXTRACT(YEAR FROM ""r"".""requested_at"")=2020 GROUP BY EXTRACT(MONTH FROM ""r"".""requested_at"")) SELECT ""a"".""month"",ROUND(COALESCE(""a"".""act_cnt""/""a"".""tot_cnt""*100, 0), 2) AS ""working_percentage"" FROM (SELECT DISTINCT ""m"".""month"",COALESCE(MAX(""t1"".""driver_count"") OVER (ORDER BY ""m"".""month""), 0) AS ""tot_cnt"",COALESCE(""t2"".""active_driver"", 0) AS ""act_cnt"" FROM (""months"" AS ""m"" LEFT JOIN ""t1"" ON ""m"".""month""=""t1"".""month"") LEFT JOIN ""t2"" ON ""m"".""month""=""t2"".""month"") AS ""a"""
193,"WITH RECURSIVE ""cte1"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 AS ""month"" FROM ""cte1"" WHERE ""month""<12), ""d1"" AS (SELECT ""driver_id"",(CASE WHEN EXTRACT(YEAR FROM ""join_date"")<2020 THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END) AS ""join_month"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<2021), ""c1"" AS (SELECT ""cte1"".""month"",COUNT(DISTINCT ""driver_id"") AS ""active_drivers"" FROM ""cte1"" LEFT JOIN ""d1"" ON ""month"">=""join_month"" GROUP BY 1), ""c2"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""accepted_rides"" FROM ""rides"" JOIN ""acceptedrides"" USING (""ride_id"") WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY 1) SELECT ""month"",ROUND(CASE WHEN ""active_drivers""=0 THEN 0 ELSE 100*COALESCE(""accepted_rides"", 0)/""active_drivers"" END, 2) AS ""working_percentage"" FROM ""c1"" LEFT JOIN ""c2"" USING (""month"") ORDER BY 1"
194,"WITH RECURSIVE ""mons"" AS (SELECT 2020 AS ""year"",1 AS ""mon"" UNION ALL SELECT 2020 AS ""year"",""mon""+1 AS ""mon"" FROM ""mons"" WHERE ""mon""+1<=12), ""active_drivers"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""mon"",COUNT(DISTINCT ""driver_id"") AS ""ct"" FROM ""AcceptedRides"" AS ""a"" JOIN ""rides"" AS ""r"" ON ""a"".""ride_id""=""r"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY 1), ""dpm"" AS (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""mon"",EXTRACT(YEAR FROM ""join_date"") AS ""year"",COUNT(1) AS ""num_drivers"" FROM ""drivers"" GROUP BY 1,2), ""dpm1"" AS (SELECT COALESCE(""m"".""year"", ""d"".""year"") AS ""year"",COALESCE(""m"".""mon"", ""d"".""mon"") AS ""mon"",COALESCE(""num_drivers"", 0) AS ""num_drivers"" FROM ""dpm"" AS ""d"" LEFT JOIN ""mons"" AS ""m"" ON ""m"".""year""=""d"".""year"" AND ""m"".""mon""=""d"".""mon"" UNION ALL SELECT COALESCE(""m"".""year"", ""d"".""year"") AS ""year"",COALESCE(""m"".""mon"", ""d"".""mon"") AS ""mon"",COALESCE(""num_drivers"", 0) AS ""num_drivers"" FROM ""dpm"" AS ""d"" RIGHT JOIN ""mons"" AS ""m"" ON ""m"".""year""=""d"".""year"" AND ""m"".""mon""=""d"".""mon"" WHERE ""d"".""mon"" IS NULL), ""avail_drivers"" AS (SELECT ""year"",""mon"",SUM(""num_drivers"") OVER (ORDER BY ""year"",""mon"" ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS ""ct"" FROM ""dpm1"") SELECT ""t2"".""mon"" AS ""month"",COALESCE(CAST(COALESCE(""t1"".""ct"", 0)*100.0/""t2"".""ct"" AS DECIMAL(65, 2)), 0) AS ""working_percentage"" FROM ""active_drivers"" AS ""t1"" RIGHT JOIN ""avail_drivers"" AS ""t2"" ON ""t1"".""mon""=""t2"".""mon"" WHERE ""t2"".""year""=2020"
195,"WITH ""cte"" AS (SELECT SUM(""Jan"") AS ""Jan"",SUM(""Feb"") AS ""Feb"",SUM(""Mar"") AS ""Mar"",SUM(""Apr"") AS ""Apr"",SUM(""May"") AS ""May"",SUM(""Jun"") AS ""Jun"",SUM(""Jul"") AS ""Jul"",SUM(""Aug"") AS ""Aug"",SUM(""Sep"") AS ""Sep"",SUM(""Oct"") AS ""Oct"",SUM(""Nov"") AS ""Nov"",SUM(""Dece"") AS ""Dece"" FROM (SELECT *,CASE WHEN ""join_date""<='2020-01-31' THEN 1 ELSE 0 END AS ""Jan"",CASE WHEN ""join_date""<='2020-02-29' THEN 1 ELSE 0 END AS ""Feb"",CASE WHEN ""join_date""<='2020-03-31' THEN 1 ELSE 0 END AS ""Mar"",CASE WHEN ""join_date""<='2020-04-30' THEN 1 ELSE 0 END AS ""Apr"",CASE WHEN ""join_date""<='2020-05-31' THEN 1 ELSE 0 END AS ""May"",CASE WHEN ""join_date""<='2020-06-30' THEN 1 ELSE 0 END AS ""Jun"",CASE WHEN ""join_date""<='2020-07-31' THEN 1 ELSE 0 END AS ""Jul"",CASE WHEN ""join_date""<='2020-08-31' THEN 1 ELSE 0 END AS ""Aug"",CASE WHEN ""join_date""<='2020-09-30' THEN 1 ELSE 0 END AS ""Sep"",CASE WHEN ""join_date""<='2020-10-31' THEN 1 ELSE 0 END AS ""Oct"",CASE WHEN ""join_date""<='2020-11-30' THEN 1 ELSE 0 END AS ""Nov"",CASE WHEN ""join_date""<='2020-12-31' THEN 1 ELSE 0 END AS ""Dece"" FROM ""Drivers"") AS ""a""), ""cte1"" AS (SELECT 1 AS ""month"",""Jan"" AS ""active_driver"" FROM ""cte"" UNION ALL SELECT 2 AS ""month"",""Feb"" AS ""active_driver"" FROM ""cte"" UNION ALL SELECT 3 AS ""month"",""Mar"" AS ""active_driver"" FROM ""cte"" UNION ALL SELECT 4 AS ""month"",""Apr"" AS ""active_driver"" FROM ""cte"" UNION ALL SELECT 5 AS ""month"",""May"" AS ""active_driver"" FROM ""cte"" UNION ALL SELECT 6 AS ""month"",""Jun"" AS ""active_driver"" FROM ""cte"" UNION ALL SELECT 7 AS ""month"",""Jul"" AS ""active_driver"" FROM ""cte"" UNION ALL SELECT 8 AS ""month"",""Aug"" AS ""active_driver"" FROM ""cte"" UNION ALL SELECT 9 AS ""month"",""Sep"" AS ""active_driver"" FROM ""cte"" UNION ALL SELECT 10 AS ""month"",""Oct"" AS ""active_driver"" FROM ""cte"" UNION ALL SELECT 11 AS ""month"",""Nov"" AS ""active_driver"" FROM ""cte"" UNION ALL SELECT 12 AS ""month"",""Dece"" AS ""active_driver"" FROM ""cte""), ""cte2"" AS (SELECT ""month"",COUNT(DISTINCT ""driver_id"") AS ""activer_driver_w_rides"" FROM (SELECT *,EXTRACT(MONTH FROM ""requested_at"") AS ""month"" FROM (SELECT ""A"".*,""B"".""requested_at"" FROM ""AcceptedRides"" AS ""A"" LEFT JOIN ""Rides"" AS ""B"" ON ""A"".""ride_id""=""B"".""ride_id"") AS ""C"" WHERE ""requested_at"">='2020-01-01' AND ""requested_at""<='2020-12-31') AS ""D"" GROUP BY ""month"") SELECT ""month"",ROUND(COALESCE(""activer_driver_w_rides""/""active_driver""*100, 0), 2) AS ""working_percentage"" FROM (SELECT ""AA"".*,COALESCE(""BB"".""activer_driver_w_rides"", 0) AS ""activer_driver_w_rides"" FROM ""cte1"" AS ""AA"" LEFT JOIN ""cte2"" AS ""BB"" ON ""AA"".""month""=""BB"".""month"") AS ""CC"" ORDER BY ""month"""
196,"WITH RECURSIVE ""months"" AS (SELECT 1 AS ""month"" UNION SELECT ""month""+1 AS ""month"" FROM ""months"" WHERE ""month""<12), ""available_drivers"" AS (SELECT ""months"".""month"",COALESCE(MAX(""t1"".""active_driver"") OVER (ORDER BY ""month""), 0) AS ""active_driver"" FROM ""months"" LEFT JOIN (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(""driver_id"") OVER (ORDER BY ""join_date"" ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS ""active_driver"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020) AS ""t1"" ON ""t1"".""month""=""months"".""month""), ""working_drivers"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""working_driver"" FROM ""Rides"" AS ""R"" JOIN ""AcceptedRides"" AS ""A"" ON ""R"".""ride_id""=""A"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY EXTRACT(MONTH FROM ""requested_at"")) SELECT ""m"".""month"",COALESCE(ROUND(""working_driver""/""active_driver""*100, 2), 0) AS ""working_percentage"" FROM (""months"" AS ""m"" LEFT JOIN ""available_drivers"" AS ""a"" ON ""a"".""month""=""m"".""month"") LEFT JOIN ""working_drivers"" AS ""w"" ON ""w"".""month""=""m"".""month"" GROUP BY ""m"".""month"""
197,"SELECT ""t1"".""month"",ROUND(COALESCE(""t2"".""active_drivers""*100/""t1"".""available_drivers"", 0), 2) AS ""working_percentage"" FROM (SELECT ""m"".""month"",COUNT(""d"".""driver_id"") AS ""available_drivers"" FROM ((SELECT 1 AS ""month"") UNION (SELECT 2 AS ""month"") UNION (SELECT 3 AS ""month"") UNION (SELECT 4 AS ""month"") UNION (SELECT 5 AS ""month"") UNION (SELECT 6 AS ""month"") UNION (SELECT 7 AS ""month"") UNION (SELECT 8 AS ""month"") UNION (SELECT 9 AS ""month"") UNION (SELECT 10 AS ""month"") UNION (SELECT 11 AS ""month"") UNION (SELECT 12 AS ""month"")) AS ""m"" LEFT JOIN ""drivers"" AS ""d"" ON ""d"".""join_date""<=LAST_DAY(CONCAT('2020-', ""m"".""month"", '-1')) GROUP BY ""m"".""month"") AS ""t1"" LEFT JOIN (SELECT EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""active_drivers"" FROM ""rides"" AS ""r"" JOIN ""acceptedrides"" AS ""ar"" ON ""r"".""ride_id""=""ar"".""ride_id"" AND EXTRACT(YEAR FROM ""r"".""requested_at"")=2020 GROUP BY EXTRACT(MONTH FROM ""r"".""requested_at"")) AS ""t2"" ON ""t1"".""month""=""t2"".""month"" ORDER BY ""t1"".""month"""
198,"WITH RECURSIVE ""dummy"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""dummy"" WHERE ""month""+1<=12), ""driver_count"" AS (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COALESCE(COUNT(""driver_id""), 0) AS ""totalD"" FROM ""Drivers"" WHERE ""join_date"" BETWEEN '2020-01-01' AND '2020-12-31' GROUP BY EXTRACT(MONTH FROM ""join_date"") UNION ALL SELECT 1 AS ""month"",COUNT(1) AS ""totalD"" FROM ""Drivers"" WHERE ""join_date""<'2020-01-01'), ""driver_count_all"" AS (SELECT ""dummy"".""month"",COALESCE(SUM(""totalD""), 0) AS ""totalD"" FROM ""dummy"" LEFT JOIN ""driver_count"" ON ""dummy"".""month""=""driver_count"".""month"" GROUP BY ""dummy"".""month""), ""driver_count_cum"" AS (SELECT ""d1"".""month"",SUM(""d2"".""totalD"") AS ""totalD"" FROM ""driver_count_all"" AS ""d1"" JOIN ""driver_count_all"" AS ""d2"" WHERE ""d1"".""month"">=""d2"".""month"" GROUP BY ""d1"".""month""), ""working_drivers"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""no_of_drivers"" FROM ""AcceptedRides"" LEFT JOIN ""Rides"" ON ""AcceptedRides"".""ride_id""=""rides"".""ride_id"" WHERE ""requested_at"" BETWEEN '2020-01-01' AND '2020-12-31' GROUP BY EXTRACT(MONTH FROM ""requested_at"")) SELECT ""driver_count_cum"".""month"",COALESCE(ROUND(100*COALESCE(""no_of_drivers"", 0)/""totalD"", 2), 0) AS ""working_percentage"" FROM ""driver_count_cum"" LEFT JOIN ""working_drivers"" ON ""driver_count_cum"".""month""=""working_drivers"".""month"" ORDER BY 1"
199,"WITH ""calendar"" AS (SELECT 1 AS ""month"" UNION ALL SELECT 2 AS ""month"" UNION ALL SELECT 3 AS ""month"" UNION ALL SELECT 4 AS ""month"" UNION ALL SELECT 5 AS ""month"" UNION ALL SELECT 6 AS ""month"" UNION ALL SELECT 7 AS ""month"" UNION ALL SELECT 8 AS ""month"" UNION ALL SELECT 9 AS ""month"" UNION ALL SELECT 10 AS ""month"" UNION ALL SELECT 11 AS ""month"" UNION ALL SELECT 12 AS ""month""), ""avail_driver_tr1"" AS (SELECT ""join_date"",COUNT(""driver_id"") OVER (ORDER BY ""join_date"") AS ""driver_count"" FROM ""Drivers""), ""avail_driver_tr2"" AS (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",MAX(""driver_count"") AS ""driver_count"" FROM ""avail_driver_tr1"" WHERE EXTRACT(YEAR FROM ""join_date"")=2020 GROUP BY EXTRACT(YEAR FROM ""join_date""),EXTRACT(MONTH FROM ""join_date"")), ""avail_driver_tr3"" AS (SELECT ""c"".""month"" AS ""month"",MAX(""ad"".""driver_count"") AS ""driver_count"" FROM ""Calendar"" AS ""c"" LEFT JOIN ""avail_driver_tr2"" AS ""ad"" ON ""c"".""month"">=""ad"".""month"" GROUP BY ""c"".""month""), ""working_driver_tr1"" AS (SELECT EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""driver_count"" FROM ""Rides"" AS ""r"" JOIN ""AcceptedRides"" AS ""ar"" ON ""r"".""ride_id""=""ar"".""ride_id"" WHERE EXTRACT(YEAR FROM ""r"".""requested_at"")=2020 GROUP BY EXTRACT(MONTH FROM ""r"".""requested_at"")) SELECT ""c"".""month"" AS ""month"",CASE WHEN ""ad"".""driver_count"" IS NULL THEN 0.00 ELSE ROUND(COALESCE(""wd"".""driver_count"", 0)*100/""ad"".""driver_count"", 2) END AS ""working_percentage"" FROM (""calendar"" AS ""c"" JOIN ""avail_driver_tr3"" AS ""ad"" ON ""c"".""month""=""ad"".""month"") LEFT JOIN ""working_driver_tr1"" AS ""wd"" ON ""c"".""month""=""wd"".""month"""
200,"WITH RECURSIVE ""CTE1"" AS (SELECT 1 AS ""month"" UNION ALL SELECT 1+""month"" FROM ""CTE1"" WHERE 1+""month""<=12), ""CTE2"" AS (SELECT ""driver_id"",CASE WHEN EXTRACT(YEAR FROM ""join_date"")<2020 THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""month"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020), ""CTE3"" AS (SELECT ""CTE1"".""month"",COUNT(""CTE2"".""driver_id"") OVER (ORDER BY ""CTE1"".""month"") AS ""active_drivers"" FROM ""CTE1"" LEFT JOIN ""CTE2"" ON ""CTE1"".""month""=""CTE2"".""month""), ""CTE4"" AS (SELECT EXTRACT(MONTH FROM ""R"".""requested_at"") AS ""month"",""A"".""driver_id"" FROM (""Rides"" AS ""R"") JOIN ""AcceptedRIdes"" AS ""A"" WHERE ""R"".""ride_id""=""A"".""ride_id"" AND EXTRACT(YEAR FROM ""R"".""requested_at"")=2020), ""CTE5"" AS (SELECT ""CTE1"".""month"",COUNT(DISTINCT ""CTE4"".""driver_id"") AS ""accepted_rides"" FROM ""CTE1"" LEFT JOIN ""CTE4"" ON ""CTE1"".""month""=""CTE4"".""month"" GROUP BY ""CTE1"".""month"") SELECT DISTINCT ""CTE3"".""month"",ROUND(COALESCE(100*""CTE5"".""accepted_rides""/""CTE3"".""active_drivers"", 0), 2) AS ""working_percentage"" FROM (""CTE5"") JOIN ""CTE3"" WHERE ""CTE5"".""month""=""CTE3"".""month"""
201,"SELECT ""t1"".""month"",COALESCE(ROUND(100*COUNT(DISTINCT ""t3"".""driver_id"")/COUNT(DISTINCT ""t2"".""driver_id""), 2), 0) AS ""working_percentage"" FROM ((SELECT 1 AS ""month"" UNION SELECT 2 AS ""month"" UNION SELECT 3 AS ""month"" UNION SELECT 4 AS ""month"" UNION SELECT 5 AS ""month"" UNION SELECT 6 AS ""month"" UNION SELECT 7 AS ""month"" UNION SELECT 8 AS ""month"" UNION SELECT 9 AS ""month"" UNION SELECT 10 AS ""month"" UNION SELECT 11 AS ""month"" UNION SELECT 12 AS ""month"") AS ""t1"" LEFT JOIN (SELECT ""driver_id"",CASE WHEN EXTRACT(YEAR FROM ""join_date"")<2020 THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""month"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020) AS ""t2"" ON ""t2"".""month""<=""t1"".""month"") LEFT JOIN (SELECT ""t1"".""driver_id"",EXTRACT(MONTH FROM ""t2"".""requested_at"") AS ""month"" FROM ""acceptedrides"" AS ""t1"" JOIN ""rides"" AS ""t2"" ON ""t2"".""ride_id""=""t1"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020) AS ""t3"" ON ""t3"".""month""=""t1"".""month"" GROUP BY ""t1"".""month"""
202,"WITH RECURSIVE ""t1"" AS (SELECT 1 AS ""month"" UNION SELECT ""month""+1 FROM ""t1"" WHERE ""month""<12), ""t2"" AS (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",(SELECT SUM(""join_date""<'2020-01-01') FROM ""Drivers"")+SUM(COUNT(EXTRACT(MONTH FROM ""join_date""))) OVER (ORDER BY ""join_date"") AS ""avai"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")=2020 GROUP BY 1 ORDER BY 1), ""t3"" AS (SELECT ""t1"".""month"",COALESCE(MAX(""t2"".""avai"") OVER (ORDER BY ""t1"".""month""), 0) AS ""avlb"" FROM ""t1"" LEFT JOIN ""t2"" ON ""t1"".""month""=""t2"".""month""), ""t4"" AS (SELECT EXTRACT(MONTH FROM ""a"".""requested_at"") AS ""month"",COALESCE(COUNT(DISTINCT ""b"".""driver_id""), 0) AS ""act"" FROM ""Rides"" AS ""a"" JOIN ""AcceptedRides"" AS ""b"" ON ""a"".""ride_id""=""b"".""ride_id"" WHERE EXTRACT(YEAR FROM ""a"".""requested_at"")=2020 GROUP BY 1) SELECT ""t3"".""month"",COALESCE(ROUND(CASE WHEN ""t3"".""avlb""!=0 THEN ""t4"".""act""*100/""t3"".""avlb"" ELSE 0 END, 2), 0.00) AS ""working_percentage"" FROM ""t3"" LEFT JOIN ""t4"" ON ""t3"".""month""=""t4"".""month"" ORDER BY 1"
203,"WITH RECURSIVE ""mo_cte"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 AS ""month"" FROM ""mo_cte"" WHERE ""month""+1<=12), ""denom"" AS (SELECT ""m"".""month"",SUM(CASE WHEN EXTRACT(YEAR FROM ""t"".""join_date"")<2020 OR EXTRACT(MONTH FROM ""t"".""join_date"")<=""m"".""month"" THEN 1 ELSE 0 END) AS ""avail_dri"" FROM (""Drivers"" AS ""t"") JOIN ""mo_cte"" AS ""m"" WHERE ""t"".""join_date""<='2020-12-31' GROUP BY 1), ""nom"" AS (SELECT ""m"".""month"",COALESCE(COUNT(DISTINCT CASE WHEN ""m"".""month""=EXTRACT(MONTH FROM ""t"".""dt"") THEN ""t"".""driver_id"" ELSE NULL END), 0) AS ""acep_dri"" FROM (""mo_cte"" AS ""m"") JOIN (SELECT ""a"".""ride_id"",""a"".""driver_id"",""r"".""requested_at"" AS ""dt"" FROM ""AcceptedRides"" AS ""a"" LEFT JOIN ""Rides"" AS ""r"" ON ""a"".""ride_id""=""r"".""ride_id"" WHERE ""r"".""requested_at"" BETWEEN '2020-01-01' AND '2020-12-31') AS ""t"" GROUP BY 1) SELECT ""de"".""month"",CASE WHEN ""de"".""avail_dri""=0 THEN 0.00 ELSE ROUND(""nom"".""acep_dri""*100.0/""de"".""avail_dri"", 2) END AS ""working_percentage"" FROM ""denom"" AS ""de"" LEFT JOIN ""nom"" ON ""de"".""month""=""nom"".""month"" ORDER BY ""de"".""month"""
204,"WITH RECURSIVE ""year_cte"" AS (SELECT MIN(EXTRACT(YEAR FROM ""join_date"")) AS ""year"",MAX(EXTRACT(YEAR FROM ""join_date"")) AS ""max_year"" FROM ""drivers"" UNION ALL SELECT ""year""+1,""max_year"" FROM ""year_cte"" WHERE ""year""<""max_year""), ""header"" AS (SELECT ""year"",1 AS ""month"",12 AS ""max_month"" FROM ""year_cte"" UNION ALL SELECT ""year"",""month""+1,""max_month"" FROM ""header"" WHERE ""month""<""max_month""), ""drivers_count"" AS (SELECT MAX(EXTRACT(YEAR FROM ""join_date"")) AS ""year"",MAX(EXTRACT(MONTH FROM ""join_date"")) AS ""month"",COUNT(""driver_id"") AS ""drivers_count"" FROM ""drivers"" GROUP BY LEFT(""join_date"", 7)), ""working_drivers_count"" AS (SELECT MAX(EXTRACT(YEAR FROM ""r"".""requested_at"")) AS ""year"",MAX(EXTRACT(MONTH FROM ""r"".""requested_at"")) AS ""month"",COUNT(DISTINCT ""a"".""driver_id"") AS ""working_drivers"" FROM ""rides"" AS ""r"" LEFT JOIN ""acceptedrides"" AS ""a"" ON ""r"".""ride_id""=""a"".""ride_id"" GROUP BY LEFT(""r"".""requested_at"", 7)) SELECT ""month"",ROUND(COALESCE(""working_drivers""/""active_drivers""*100, 0), 2) AS ""working_percentage"" FROM (SELECT ""t1"".""month"",""t1"".""year"",COALESCE(SUM(""t2"".""drivers_count"") OVER (ORDER BY ""t1"".""year"",""t1"".""month""), 0) AS ""active_drivers"",COALESCE(""t3"".""working_drivers"", 0) AS ""working_drivers"" FROM (""header"" AS ""t1"" LEFT JOIN ""drivers_count"" AS ""t2"" ON ""t1"".""year""=""t2"".""year"" AND ""t1"".""month""=""t2"".""month"") LEFT JOIN ""working_drivers_count"" AS ""t3"" ON ""t1"".""year""=""t3"".""year"" AND ""t1"".""month""=""t3"".""month"") AS ""temp"" WHERE ""year""=2020"
205,"WITH RECURSIVE ""t2"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""mon"",COUNT(DISTINCT ""b"".""driver_id"") AS ""accept_cnt"" FROM ""rides"" AS ""a"" JOIN ""AcceptedRides"" AS ""b"" ON ""a"".""ride_id""=""b"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY 1), ""t3"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 AS ""month"" FROM ""t3"" WHERE ""month""<12) SELECT ""a"".""month"",CASE WHEN ""c"".""accept_cnt"" IS NULL OR COUNT(""b"".""driver_id"")=0 THEN ROUND(0.00, 2) ELSE ROUND(100*""c"".""accept_cnt""/COUNT(""b"".""driver_id""), 2) END AS ""working_percentage"" FROM (""t3"" AS ""a"" LEFT JOIN (SELECT * FROM ""drivers"") AS ""b"" ON (""a"".""month"">=EXTRACT(MONTH FROM ""b"".""join_date"") AND EXTRACT(YEAR FROM ""b"".""join_date"")=2020) OR EXTRACT(YEAR FROM ""b"".""join_date"")<2020) LEFT JOIN ""t2"" AS ""c"" ON ""a"".""month""=""c"".""mon"" GROUP BY ""a"".""month"",""c"".""accept_cnt"" ORDER BY 1"
206,"WITH RECURSIVE ""cte"" AS (SELECT 1 AS ""month"",0 AS ""driver_cnt"" UNION ALL SELECT ""month""+1 AS ""month"",0 AS ""driver_cnt"" FROM ""cte"" WHERE ""month""<12), ""cte1"" AS (SELECT ""month"" AS ""driver_month"",SUM(""driver_cnt"") OVER (ORDER BY ""month"") AS ""driver_cnt"" FROM (SELECT ""month"",SUM(""driver_cnt"") AS ""driver_cnt"" FROM (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(""driver_id"") AS ""driver_cnt"" FROM (SELECT CASE WHEN ""join_date""<'2020-01-01' THEN '2020-01-01' ELSE ""join_date"" END AS ""join_date"",""driver_id"" FROM ""Drivers"" WHERE ""join_date""<='2020-12-31') AS ""t0"" GROUP BY EXTRACT(MONTH FROM ""join_date"") UNION ALL SELECT ""month"",""driver_cnt"" FROM ""cte"") AS ""t1"" GROUP BY ""month"") AS ""t2""), ""cte2"" AS (SELECT ""ride_month"",COUNT(DISTINCT ""driver_id"") AS ""ride_driver_cnt"" FROM (SELECT ""driver_id"",EXTRACT(MONTH FROM ""requested_at"") AS ""ride_month"" FROM ""Rides"" AS ""r"" LEFT JOIN ""AcceptedRides"" AS ""a"" ON ""r"".""ride_id""=""a"".""ride_id"" AND EXTRACT(YEAR FROM ""requested_at"")='2020') AS ""t2"" GROUP BY ""ride_month"") SELECT ""driver_month"" AS ""month"",CASE ""driver_cnt"" WHEN 0 THEN 0 ELSE COALESCE(ROUND(100*(""ride_driver_cnt""/""driver_cnt""), 2), 0) END AS ""working_percentage"" FROM ""cte1"" LEFT JOIN ""cte2"" ON ""cte1"".""driver_month""=""cte2"".""ride_month"" ORDER BY ""cte1"".""driver_month"""
207,"WITH RECURSIVE ""t1"" AS (SELECT 1 AS ""month"" UNION SELECT ""month""+1 FROM ""t1"" WHERE ""month""<12), ""t2"" AS (SELECT CASE WHEN EXTRACT(YEAR FROM ""join_date"")<2020 THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""month"",COUNT(""driver_id"") AS ""new_drivers"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<2021 GROUP BY ""month""), ""t3"" AS (SELECT ""t1"".""month"",SUM(COALESCE(""new_drivers"", 0)) OVER (ORDER BY ""t1"".""month"") AS ""all_drivers"" FROM ""t1"" LEFT JOIN ""t2"" ON ""t1"".""month""=""t2"".""month""), ""t4"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""cnt"" FROM ""rides"" AS ""a"" JOIN ""acceptedrides"" AS ""b"" ON ""a"".""ride_id""=""b"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY ""month"") SELECT ""t3"".""month"",ROUND(100*COALESCE(""cnt""/""all_drivers"", 0), 2) AS ""working_percentage"" FROM ""t3"" LEFT JOIN ""t4"" ON ""t3"".""month""=""t4"".""month"""
208,"WITH RECURSIVE ""t1"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""t1"" WHERE ""month""<12), ""t2"" AS (SELECT CASE WHEN EXTRACT(YEAR FROM ""join_date"")<2020 THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""month"",COUNT(""driver_id"") AS ""new_drivers"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020 GROUP BY ""month""), ""t3"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""active_drivers"" FROM ""rides"" AS ""a"" JOIN ""acceptedrides"" AS ""b"" ON ""a"".""ride_id""=""b"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY ""month""), ""t4"" AS (SELECT ""t1"".""month"",SUM(COALESCE(""new_drivers"", 0)) OVER (ORDER BY ""t1"".""month"") AS ""all_drivers"" FROM ""t1"" LEFT JOIN ""t2"" ON ""t1"".""month""=""t2"".""month"") SELECT ""t4"".""month"",ROUND(100*COALESCE(""active_drivers""/""all_drivers"", 0), 2) AS ""working_percentage"" FROM ""t4"" LEFT JOIN ""t3"" ON ""t4"".""month""=""t3"".""month"""
209,"WITH RECURSIVE ""T1"" AS (SELECT 1 AS ""join_month"" UNION SELECT ""join_month""+1 FROM ""T1"" WHERE ""join_month""<12), ""T2"" AS (SELECT CASE WHEN EXTRACT(YEAR FROM ""join_date"")<'2020' THEN '1' ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""join_month"",COUNT(""driver_id"") AS ""driver_num"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<='2020' GROUP BY ""join_month""), ""T3"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""join_month"",COUNT(DISTINCT ""ar"".""driver_id"") AS ""ride_num"" FROM ""AcceptedRides"" AS ""ar"" LEFT JOIN ""Rides"" AS ""r"" ON ""ar"".""ride_id""=""r"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")='2020' GROUP BY ""join_month"") SELECT ""T1"".""join_month"" AS ""month"",ROUND(100*COALESCE(""T3"".""ride_num""/SUM(""T2"".""driver_num""), 0), 2) AS ""working_percentage"" FROM (""T1"" LEFT JOIN ""T2"" ON ""T1"".""join_month"">=""T2"".""join_month"") LEFT JOIN ""T3"" ON ""T1"".""join_month""=""T3"".""join_month"" GROUP BY ""T1"".""join_month"" ORDER BY ""T1"".""join_month"""
210,"WITH ""cte"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",CONVERT(COUNT(DISTINCT ""driver_id""), DECIMAL(12, 6)) AS ""adriver"" FROM ""Rides"" AS ""r"" JOIN ""AcceptedRides"" AS ""ar"" ON ""r"".""ride_id""=""ar"".""ride_id"" WHERE LEFT(""requested_at"", 4)=2020 GROUP BY EXTRACT(MONTH FROM ""requested_at"")), ""ctem"" AS (SELECT CONVERT('2020-1-31', DATE) AS ""dt"" UNION ALL SELECT '2020-2-29' UNION ALL SELECT '2020-3-31' UNION ALL SELECT '2020-4-30' UNION ALL SELECT '2020-5-31' UNION ALL SELECT '2020-6-30' UNION ALL SELECT '2020-7-31' UNION ALL SELECT '2020-8-31' UNION ALL SELECT '2020-9-30' UNION ALL SELECT '2020-10-31' UNION ALL SELECT '2020-11-30' UNION ALL SELECT '2020-12-31'), ""cte3"" AS (SELECT EXTRACT(MONTH FROM ""c"".""dt"") AS ""month"",COALESCE(NULLIF(COUNT(""d"".""driver_id""), 0), 100) AS ""alldrivers"" FROM ""ctem"" AS ""c"" LEFT JOIN ""Drivers"" AS ""d"" ON ""c"".""dt"">=""d"".""join_date"" GROUP BY ""c"".""dt"") SELECT ""c3"".""month"",ROUND(COALESCE(""adriver"", 0)/""alldrivers""*100, 2) AS ""working_percentage"" FROM ""cte3"" AS ""c3"" LEFT JOIN ""cte"" AS ""c1"" ON ""c3"".""month""=""c1"".""month"" ORDER BY 1"
211,"WITH RECURSIVE ""cte"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""cte"" WHERE ""month""<12), ""t1"" AS (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(""driver_id"") OVER (ORDER BY ""join_date"") AS ""active_drivers"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020), ""t2"" AS (SELECT EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""month"",COUNT(DISTINCT ""ar"".""driver_id"") AS ""accepted_rides"" FROM ""Rides"" AS ""r"" JOIN ""AcceptedRides"" AS ""ar"" ON ""ar"".""ride_id""=""r"".""ride_id"" WHERE EXTRACT(YEAR FROM ""r"".""requested_at"")=2020 GROUP BY ""month"") SELECT DISTINCT ""c"".""month"",ROUND(COALESCE(""accepted_rides""/MAX(""t1"".""active_drivers"") OVER (ORDER BY ""c"".""month"")*100, 0), 2) AS ""working_percentage"" FROM (""cte"" AS ""c"" LEFT JOIN ""t1"" ON ""c"".""month""=""t1"".""month"") LEFT JOIN ""t2"" ON ""c"".""month""=""t2"".""month"""
212,"WITH RECURSIVE ""m"" AS (SELECT 1 AS ""month"" UNION SELECT ""month""+1 FROM ""m"" WHERE ""month""<12), ""a"" AS (SELECT ""m"".""month"",COALESCE(MAX(""total_driver"") OVER (ORDER BY ""month""), 0) AS ""total_driver"" FROM ""m"" LEFT JOIN (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(""driver_id"") OVER (ORDER BY ""join_date"" ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS ""total_driver"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020) AS ""t1"" USING (""month"")), ""b"" AS (SELECT COUNT(DISTINCT ""driver_id"") AS ""accepted_driver"",EXTRACT(MONTH FROM ""requested_at"") AS ""month"" FROM ""acceptedrides"" AS ""a"" JOIN ""rides"" AS ""r"" USING (""ride_id"") WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY 2) SELECT ""a"".""month"",ROUND(COALESCE((""accepted_driver""/""total_driver""), 0)*100, 2) AS ""working_percentage"" FROM ""a"" LEFT JOIN ""b"" USING (""month"") GROUP BY 1"
213,"WITH RECURSIVE ""t1"" AS (SELECT 1 AS ""month"" UNION SELECT ""month""+1 FROM ""t1"" WHERE ""month""<12), ""t2"" AS (SELECT CASE WHEN EXTRACT(YEAR FROM ""join_date"")='2019' THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""month"",COUNT(""driver_id"") AS ""num_drivers"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<='2020' GROUP BY 1), ""t3"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""AcceptedRides"".""driver_id"") AS ""num_accepted_rides"" FROM ""Rides"" JOIN ""AcceptedRides"" ON ""Rides"".""ride_id""=""AcceptedRides"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")='2020' GROUP BY 1) SELECT ""t1"".""month"",ROUND(COALESCE(100*""t3"".""num_accepted_rides""/SUM(""t2"".""num_drivers""), 0), 2) AS ""working_percentage"" FROM (""t1"" LEFT JOIN ""t2"" ON ""t2"".""month""<=""t1"".""month"") LEFT JOIN ""t3"" ON ""t3"".""month""=""t1"".""month"" GROUP BY 1 ORDER BY 1"
214,"WITH RECURSIVE ""T1"" AS (SELECT 1 AS ""join_month"" UNION SELECT ""join_month""+1 FROM ""T1"" WHERE ""join_month""<12), ""T2"" AS (SELECT CASE WHEN EXTRACT(YEAR FROM ""join_date"")<'2020' THEN '1' ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""join_month"",COUNT(""driver_id"") AS ""driver_num"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<='2020' GROUP BY ""join_month""), ""T3"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""join_month"",COUNT(DISTINCT ""ar"".""driver_id"") AS ""ride_num"" FROM ""AcceptedRides"" AS ""ar"" LEFT JOIN ""Rides"" AS ""r"" ON ""ar"".""ride_id""=""r"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")='2020' GROUP BY ""join_month"") SELECT ""T1"".""join_month"" AS ""month"",ROUND(100*COALESCE(""T3"".""ride_num""/SUM(""T2"".""driver_num""), 0), 2) AS ""working_percentage"" FROM (""T1"" LEFT JOIN ""T2"" ON ""T1"".""join_month"">=""T2"".""join_month"") LEFT JOIN ""T3"" ON ""T1"".""join_month""=""T3"".""join_month"" GROUP BY ""T1"".""join_month"" ORDER BY ""T1"".""join_month"""
215,"WITH RECURSIVE ""t1"" (""n"") AS (SELECT 1 UNION ALL SELECT ""n""+1 FROM ""T1"" WHERE ""n""<12), ""t3"" AS (SELECT ""T2"".""year""*100+""T1"".""n"" AS ""ym"" FROM ""T1"" JOIN (SELECT 2019 AS ""year"" UNION SELECT 2020 AS ""year"" UNION SELECT 2021 AS ""year"") AS ""t2""), ""t6"" AS (SELECT ""ym""-202000 AS ""ym"",""cnt"" FROM (SELECT ""ym"",SUM(""cnt"") OVER (ORDER BY ""ym"") AS ""cnt"" FROM (SELECT ""t3"".""ym"",COALESCE(COUNT(""driver_id""), 0) AS ""cnt"" FROM ""Drivers"" AS ""d"" RIGHT JOIN ""t3"" ON EXTRACT(YEAR FROM ""join_date"")*100+EXTRACT(MONTH FROM ""join_date"")=""t3"".""ym"" GROUP BY ""t3"".""ym"") AS ""t4"") AS ""t5"" WHERE ""ym"" BETWEEN 202001 AND 202012), ""t7"" AS (SELECT ""t3"".""ym""-202000 AS ""ym"",COUNT(DISTINCT ""driver_id"") AS ""cnt"" FROM (""AcceptedRides"" AS ""ar"" JOIN ""Rides"" AS ""r"" ON ""ar"".""ride_id""=""r"".""ride_id"") RIGHT JOIN ""t3"" ON EXTRACT(YEAR FROM ""requested_at"")*100+EXTRACT(MONTH FROM ""requested_at"")=""t3"".""ym"" WHERE ""t3"".""ym"" BETWEEN 202001 AND 202012 GROUP BY ""t3"".""ym""-202000) SELECT ""t6"".""ym"" AS ""month"",COALESCE(ROUND(""t7"".""cnt""/""t6"".""cnt""*100, 2), 0) AS ""working_percentage"" FROM ""T6"" JOIN ""T7"" ON ""T6"".""ym""=""T7"".""ym"""
216,"SELECT ""months_drivers"".""month"",ROUND(COALESCE(100*COALESCE(""total_active_drivers"", 0)/""total_drivers"", 0), 2) AS ""working_percentage"" FROM (SELECT ""month"",COUNT(""driver_id"") AS ""total_drivers"" FROM ""Drivers"" AS ""a"" RIGHT JOIN (SELECT '2020-1-31' AS ""day"",1 AS ""month"" UNION SELECT '2020-2-29',2 UNION SELECT '2020-3-31',3 UNION SELECT '2020-4-30',4 UNION SELECT '2020-5-31',5 UNION SELECT '2020-6-30',6 UNION SELECT '2020-7-31',7 UNION SELECT '2020-8-31',8 UNION SELECT '2020-9-30',9 UNION SELECT '2020-10-31',10 UNION SELECT '2020-11-30',11 UNION SELECT '2020-12-31',12) AS ""months"" ON ""join_date""<=""day"" GROUP BY ""month"") AS ""months_drivers"" LEFT JOIN (SELECT ""month"",COUNT(DISTINCT ""b"".""driver_id"") AS ""total_active_drivers"" FROM (SELECT ""ride_id"",CAST(SUBSTR(""requested_at"", 6, 2) AS INTEGER) AS ""month"" FROM ""Rides"" WHERE SUBSTR(""requested_at"", 1, 4)='2020') AS ""month_rides"" JOIN ""AcceptedRides"" AS ""b"" ON ""month_rides"".""ride_id""=""b"".""ride_id"" GROUP BY ""month"") AS ""months_active_drivers"" ON ""months_drivers"".""month""=""months_active_drivers"".""month"""
217,"WITH RECURSIVE ""t1"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""t1"" WHERE ""month""<12), ""t2"" AS (SELECT CASE WHEN EXTRACT(YEAR FROM ""join_date"")<2020 THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""month"",COUNT(""driver_id"") AS ""new_drivers"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020 GROUP BY ""month""), ""t3"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""active_drivers"" FROM ""rides"" AS ""a"" JOIN ""acceptedrides"" AS ""b"" ON ""a"".""ride_id""=""b"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY ""month""), ""t4"" AS (SELECT ""t1"".""month"",SUM(COALESCE(""new_drivers"", 0)) OVER (ORDER BY ""t1"".""month"") AS ""all_drivers"" FROM ""t1"" LEFT JOIN ""t2"" ON ""t1"".""month""=""t2"".""month"") SELECT ""t4"".""month"",ROUND(100*COALESCE(""active_drivers""/""all_drivers"", 0), 2) AS ""working_percentage"" FROM ""t4"" LEFT JOIN ""t3"" ON ""t4"".""month""=""t3"".""month"""
218,"WITH RECURSIVE ""months"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""months"" WHERE ""month""<12), ""total_drivers"" AS (SELECT ""m"".""month"",COUNT(""d"".""driver_id"") AS ""active_drivers"" FROM (""months"" AS ""m"") JOIN ""Drivers"" AS ""d"" WHERE LAST_DAY(STR_TO_DATE(CONCAT(2020, ""m"".""month""), '%Y%m'))>=""d"".""join_date"" GROUP BY ""m"".""month""), ""working_drivers"" AS (SELECT EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""month"",COUNT(DISTINCT ""ar"".""driver_id"") AS ""working_drivers"" FROM (""Rides"" AS ""r"") JOIN ""AcceptedRides"" AS ""ar"" WHERE ""r"".""ride_id""=""ar"".""ride_id"" AND EXTRACT(YEAR FROM ""r"".""requested_at"")=2020 GROUP BY EXTRACT(MONTH FROM ""r"".""requested_at"")) SELECT ""m"".""month"",COALESCE(ROUND(COALESCE(""w"".""working_drivers"", 0)/""t"".""active_drivers""*100, 2), 0.00) AS ""working_percentage"" FROM (""months"" AS ""m"" LEFT JOIN ""total_drivers"" AS ""t"" ON ""m"".""month""=""t"".""month"") LEFT JOIN ""working_drivers"" AS ""w"" ON ""m"".""month""=""w"".""month"""
219,"WITH RECURSIVE ""cte"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""cte"" WHERE ""month""<12) SELECT ""c"".""month"",ROUND(COALESCE(COALESCE(""naccept"", 0)/MAX(COALESCE(""ndriver"", 0))*100, 0), 2) AS ""working_percentage"" FROM (""cte"" AS ""c"" LEFT JOIN (SELECT TRIM(BOTH '-' FROM RIGHT(LEFT(""requested_at"", 7), 2)) AS ""month"",COUNT(DISTINCT ""a"".""driver_id"") AS ""naccept"" FROM ""rides"" AS ""r"" JOIN ""AcceptedRides"" AS ""a"" ON ""r"".""ride_id""=""a"".""ride_id"" WHERE LEFT(""requested_at"", 4)='2020' GROUP BY TRIM(BOTH '-' FROM RIGHT(LEFT(""requested_at"", 7), 2))) AS ""r"" ON ""c"".""month""=""r"".""month"") LEFT JOIN (SELECT LEFT(""join_date"", 7) AS ""ymonth"",COUNT(""driver_id"") OVER (ORDER BY LEFT(""join_date"", 7)) AS ""ndriver"" FROM ""Drivers"") AS ""d"" ON TRIM(BOTH '-' FROM RIGHT(""d"".""ymonth"", 2))<=""c"".""month"" AND LEFT(""d"".""ymonth"", 4)='2020' GROUP BY ""month"" ORDER BY ""c"".""month"""
220,"WITH RECURSIVE ""months"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""months"" WHERE ""month""<12), ""available_drivers"" AS (SELECT ""months"".""month"",COALESCE(MAX(""t1"".""active_driver"") OVER (ORDER BY ""month""), 0) AS ""active_driver"" FROM ""months"" LEFT JOIN (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(""driver_id"") OVER (ORDER BY ""join_date"" ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS ""active_driver"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020) AS ""t1"" ON ""t1"".""month""=""months"".""month""), ""working_drivers"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""working_driver"" FROM ""Rides"" AS ""R"" JOIN ""AcceptedRides"" AS ""A"" ON ""R"".""ride_id""=""A"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY 1) SELECT ""months"".""month"",COALESCE(ROUND(""working_driver""/""active_driver""*100, 2), 0) AS ""working_percentage"" FROM (""months"" LEFT JOIN ""available_drivers"" ON ""available_drivers"".""month""=""months"".""month"") LEFT JOIN ""working_drivers"" ON ""working_drivers"".""month""=""months"".""month"" GROUP BY 1"
221,"SELECT ""t"".""month"",ROUND(COALESCE(COUNT(DISTINCT ""rides"".""driver_id"")/COUNT(DISTINCT ""d"".""driver_id"")*100.0, 0), 2) AS ""working_percentage"" FROM (((SELECT 1 AS ""month"") UNION (SELECT 2 AS ""month"") UNION (SELECT 3 AS ""month"") UNION (SELECT 4 AS ""month"") UNION (SELECT 5 AS ""month"") UNION (SELECT 6 AS ""month"") UNION (SELECT 7 AS ""month"") UNION (SELECT 8 AS ""month"") UNION (SELECT 9 AS ""month"") UNION (SELECT 10 AS ""month"") UNION (SELECT 11 AS ""month"") UNION (SELECT 12 AS ""month"")) AS ""t"" LEFT JOIN (SELECT ""driver_id"",(CASE WHEN EXTRACT(YEAR FROM ""join_date"")=2019 THEN '1' ELSE EXTRACT(MONTH FROM ""join_date"") END) AS ""month"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020) AS ""d"" ON ""d"".""month""<=""t"".""month"") LEFT JOIN (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",""a"".""ride_id"",""a"".""driver_id"" FROM ""AcceptedRides"" AS ""a"" JOIN ""Rides"" AS ""r"" ON ""r"".""ride_id""=""a"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020) AS ""rides"" ON ""t"".""month""=""rides"".""month"" GROUP BY ""t"".""month"" ORDER BY ""t"".""month"""
222,"WITH RECURSIVE ""seq"" AS (SELECT 1 AS ""month"" UNION SELECT 1+""month"" FROM ""seq"" WHERE ""month""<12), ""drive"" AS (SELECT ""driver_id"",CASE WHEN EXTRACT(YEAR FROM ""join_date"")<2020 THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""month"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020), ""acc_ride"" AS (SELECT ""a"".""driver_id"",EXTRACT(MONTH FROM ""requested_at"") AS ""month"" FROM ""AcceptedRides"" AS ""a"" JOIN ""Rides"" AS ""b"" ON ""a"".""ride_id""=""b"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020) SELECT ""a"".""month"",COALESCE(ROUND(100*COUNT(DISTINCT ""c"".""driver_id"")/COUNT(DISTINCT ""b"".""driver_id""), 2), 0) AS ""working_percentage"" FROM (""seq"" AS ""a"" LEFT JOIN ""drive"" AS ""b"" ON ""a"".""month"">=""b"".""month"") LEFT JOIN ""acc_ride"" AS ""c"" ON ""a"".""month""=""c"".""month"" GROUP BY 1 ORDER BY 1"
223,"WITH RECURSIVE ""CTE1"" AS (SELECT 1 AS ""month"" UNION ALL SELECT 1+""month"" FROM ""CTE1"" WHERE 1+""month""<=12), ""CTE2"" AS (SELECT ""driver_id"",CASE WHEN EXTRACT(YEAR FROM ""join_date"")<2020 THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""month"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020), ""CTE3"" AS (SELECT ""CTE1"".""month"",COUNT(""CTE2"".""driver_id"") OVER (ORDER BY ""CTE1"".""month"") AS ""active_drivers"" FROM ""CTE1"" LEFT JOIN ""CTE2"" ON ""CTE1"".""month""=""CTE2"".""month""), ""CTE4"" AS (SELECT EXTRACT(MONTH FROM ""R"".""requested_at"") AS ""month"",""A"".""driver_id"" FROM (""Rides"" AS ""R"") JOIN ""AcceptedRIdes"" AS ""A"" WHERE ""R"".""ride_id""=""A"".""ride_id"" AND EXTRACT(YEAR FROM ""R"".""requested_at"")=2020), ""CTE5"" AS (SELECT ""CTE1"".""month"",COUNT(DISTINCT ""CTE4"".""driver_id"") AS ""accepted_rides"" FROM ""CTE1"" LEFT JOIN ""CTE4"" ON ""CTE1"".""month""=""CTE4"".""month"" GROUP BY ""CTE1"".""month"") SELECT DISTINCT ""CTE3"".""month"",ROUND(COALESCE(100*""CTE5"".""accepted_rides""/""CTE3"".""active_drivers"", 0), 2) AS ""working_percentage"" FROM (""CTE5"") JOIN ""CTE3"" WHERE ""CTE5"".""month""=""CTE3"".""month"""
224,"WITH RECURSIVE ""CET"" AS (SELECT 1 AS ""month"" UNION ALL SELECT 1+""month"" AS ""month"" FROM ""CET"" WHERE 1+""month""<=12), ""CET2"" AS (SELECT SUM(CASE WHEN ""driver_id"" IS NOT NULL THEN 1 ELSE 0 END) AS ""driver_count"",""CET"".""month"" FROM ""CET"" LEFT JOIN (SELECT *,EXTRACT(MONTH FROM ""join_date"") AS ""month"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")=2020) AS ""d"" ON ""d"".""month""=""CET"".""month"" GROUP BY ""CET"".""month"" UNION ALL SELECT COUNT(""driver_id"") AS ""driver_count"",0 AS ""month"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<2020), ""CET3"" AS (SELECT COUNT(DISTINCT ""driver_id"") AS ""working_driver"",EXTRACT(MONTH FROM ""requested_at"") AS ""month"" FROM ""AcceptedRides"" AS ""a1"" LEFT JOIN ""Rides"" AS ""a2"" ON ""a1"".""ride_id""=""a2"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY EXTRACT(MONTH FROM ""requested_at"")) SELECT ""b1"".""month"",ROUND(COALESCE(""working_driver""/""driver_count""*100, 0), 2) AS ""working_percentage"" FROM (SELECT SUM(""driver_count"") OVER (ORDER BY ""month"") AS ""driver_count"",""month"" FROM ""CET2"") AS ""b1"" LEFT JOIN ""CET3"" ON ""b1"".""month""=""CET3"".""month"" WHERE ""b1"".""month""!=0"
225,"WITH RECURSIVE ""months"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""months"" WHERE ""month""<12), ""available_drivers"" AS (SELECT ""months"".""month"",COALESCE(MAX(""t1"".""active_driver"") OVER (ORDER BY ""month""), 0) AS ""active_driver"" FROM ""months"" LEFT JOIN (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(""driver_id"") OVER (ORDER BY ""join_date"" ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS ""active_driver"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020) AS ""t1"" ON ""t1"".""month""=""months"".""month""), ""working_drivers"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""working_driver"" FROM ""Rides"" AS ""R"" JOIN ""AcceptedRides"" AS ""A"" ON ""R"".""ride_id""=""A"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY 1) SELECT ""months"".""month"",COALESCE(ROUND(""working_driver""/""active_driver""*100, 2), 0) AS ""working_percentage"" FROM (""months"" LEFT JOIN ""available_drivers"" ON ""available_drivers"".""month""=""months"".""month"") LEFT JOIN ""working_drivers"" ON ""working_drivers"".""month""=""months"".""month"" GROUP BY 1"
226,"WITH RECURSIVE ""cte"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""cte"" WHERE ""month""<12), ""cte1"" AS (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COALESCE(MAX(""cnt""), 0) AS ""cnt"" FROM (SELECT ""join_date"",COUNT(""driver_id"") OVER (ORDER BY ""join_date"") AS ""cnt"" FROM ""drivers"") AS ""t1"" WHERE EXTRACT(YEAR FROM ""join_date"")='2020' GROUP BY 1), ""cte2"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""a"".""driver_id"") AS ""driver_cnt"" FROM ""rides"" AS ""r"" JOIN ""acceptedrides"" AS ""a"" ON ""r"".""ride_id""=""a"".""ride_id"" WHERE EXTRACT(YEAR FROM ""r"".""requested_at"")='2020' GROUP BY 1) SELECT ""cte"".""month"",ROUND(COALESCE(COALESCE(""cte2"".""driver_cnt"", 0)*100/(CASE WHEN ""cte1"".""cnt"" IS NULL THEN COALESCE(MAX(""cte1"".""cnt"") OVER (ORDER BY ""month""), 0) ELSE ""cte1"".""cnt"" END), 0), 2) AS ""working_percentage"" FROM (""cte"" LEFT JOIN ""cte1"" ON ""cte"".""month""=""cte1"".""month"") LEFT JOIN ""cte2"" ON ""cte"".""month""=""cte2"".""month"""
227,"WITH RECURSIVE ""months"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""months"" WHERE ""month""<12), ""driver_count"" AS (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(""driver_id"") OVER (ORDER BY ""join_date"") AS ""active_drivers"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020), ""driver_num"" AS (SELECT ""m"".""month"",MAX(""dc"".""active_drivers"") OVER (ORDER BY ""month"") AS ""active_drivers"" FROM ""months"" AS ""m"" LEFT JOIN ""driver_count"" AS ""dc"" ON ""m"".""month""=""dc"".""month""), ""driver_acc"" AS (SELECT EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""driver_num"" FROM ""rides"" AS ""r"" JOIN ""AcceptedRides"" AS ""a"" USING (""ride_id"") WHERE EXTRACT(YEAR FROM ""r"".""requested_at"")=2020 GROUP BY ""month"") SELECT DISTINCT ""dm"".""month"",ROUND(COALESCE(CASE WHEN ""dm"".""active_drivers""=0 THEN 0 ELSE ""da"".""driver_num""*100/""dm"".""active_drivers"" END, 0), 2) AS ""working_percentage"" FROM ""driver_num"" AS ""dm"" LEFT JOIN ""driver_acc"" AS ""da"" ON ""dm"".""month""=""da"".""month"""
228,"WITH RECURSIVE ""months"" (""month"") AS (SELECT 1 UNION ALL SELECT ""month""+1 FROM ""months"" WHERE ""month""<12), ""t1"" AS (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(""driver_id"") OVER (ORDER BY ""join_date"") AS ""driver_count"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020), ""t2"" AS (SELECT EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""month"",COUNT(DISTINCT ""a"".""driver_id"") AS ""active_driver"" FROM ""Rides"" AS ""r"" JOIN ""AcceptedRides"" AS ""a"" ON ""r"".""ride_id""=""a"".""ride_id"" WHERE EXTRACT(YEAR FROM ""r"".""requested_at"")=2020 GROUP BY EXTRACT(MONTH FROM ""r"".""requested_at"")) SELECT ""a"".""month"",ROUND(COALESCE(""a"".""act_cnt""/""a"".""tot_cnt""*100, 0), 2) AS ""working_percentage"" FROM (SELECT DISTINCT ""m"".""month"",COALESCE(MAX(""t1"".""driver_count"") OVER (ORDER BY ""m"".""month""), 0) AS ""tot_cnt"",COALESCE(""t2"".""active_driver"", 0) AS ""act_cnt"" FROM (""months"" AS ""m"" LEFT JOIN ""t1"" ON ""m"".""month""=""t1"".""month"") LEFT JOIN ""t2"" ON ""m"".""month""=""t2"".""month"") AS ""a"""
229,"WITH RECURSIVE ""cte"" AS (SELECT '2020-01-31' AS ""date"" UNION ALL SELECT LAST_DAY(""date"" + INTERVAL '1 MONTH') AS ""date"" FROM ""cte"" WHERE ""date""<'2020-12-31'), ""base"" AS (SELECT EXTRACT(MONTH FROM ""cte"".""date"") AS ""month"",COUNT(1) AS ""available_driver"" FROM ""cte"" LEFT JOIN ""Drivers"" ON ""cte"".""date"">=""Drivers"".""join_date"" GROUP BY 1 ORDER BY 1), ""base1"" AS (SELECT DISTINCT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""a"".""driver_id"") AS ""working_driver"" FROM ""AcceptedRides"" AS ""a"" LEFT JOIN ""Rides"" AS ""b"" ON ""a"".""ride_id""=""b"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY 1) SELECT DISTINCT ""base"".""month"",ROUND(COALESCE(""working_driver""/""available_driver""*100, 0), 2) AS ""working_percentage"" FROM ""base"" LEFT JOIN ""base1"" ON ""base"".""month""=""base1"".""month"" ORDER BY 1"
230,"WITH RECURSIVE ""getMonth"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 AS ""month"" FROM ""getMonth"" WHERE ""month""<12), ""getDates"" AS (SELECT ""month"",LAST_DAY(CONCAT('2020-', ""month"", '-01')) AS ""last_day"" FROM ""getMonth""), ""getRides"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month_"",COUNT(DISTINCT ""ar"".""driver_id"") AS ""accepted_drivers"" FROM ""Rides"" AS ""r"" JOIN ""AcceptedRides"" AS ""ar"" ON ""r"".""ride_id""=""ar"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")='2020' GROUP BY 1), ""getDrivers"" AS (SELECT ""month"",SUM(CASE WHEN ""Drivers"".""driver_id"" IS NOT NULL THEN 1 ELSE 0 END) AS ""active_drivers"" FROM ""getDates"" LEFT JOIN ""Drivers"" ON ""Drivers"".""join_date""<=""last_day"" GROUP BY 1) SELECT ""month"",COALESCE(ROUND((COALESCE(""accepted_drivers"", 0)/""active_drivers"")*100, 2), 0) AS ""working_percentage"" FROM ""getDrivers"" LEFT JOIN ""getRides"" ON ""month""=""month_"" ORDER BY 1"
231,"SELECT ""tmp2"".""month"",ROUND(COALESCE(""count_tmp3""*100/""count_tmp2"", 0), 2) AS ""working_percentage"" FROM (SELECT ""month"",SUM(COALESCE(""count_tmp1"", 0)) OVER (ORDER BY ""month"")+(SELECT COUNT(""d1"".""driver_id"") FROM ""drivers"" AS ""d1"" WHERE EXTRACT(YEAR FROM ""join_date"")<2020) AS ""count_tmp2"" FROM ((SELECT 1 AS ""month"") UNION (SELECT 2 AS ""month"") UNION (SELECT 3 AS ""month"") UNION (SELECT 4 AS ""month"") UNION (SELECT 5 AS ""month"") UNION (SELECT 6 AS ""month"") UNION (SELECT 7 AS ""month"") UNION (SELECT 8 AS ""month"") UNION (SELECT 9 AS ""month"") UNION (SELECT 10 AS ""month"") UNION (SELECT 11 AS ""month"") UNION (SELECT 12 AS ""month"")) AS ""month1"" LEFT JOIN (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month_tmp1"",COUNT(DISTINCT ""driver_id"") AS ""count_tmp1"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")=2020 GROUP BY EXTRACT(MONTH FROM ""join_date"")) AS ""tmp1"" ON ""month""=""month_tmp1"") AS ""tmp2"" LEFT JOIN (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""count_tmp3"" FROM ""AcceptedRides"" JOIN ""rides"" ON ""AcceptedRides"".""ride_id""=""rides"".""ride_id"" AND EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY EXTRACT(MONTH FROM ""requested_at"")) AS ""tmp3"" ON ""tmp2"".""month""=""tmp3"".""month"""
232,"WITH RECURSIVE ""months"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""months"" WHERE ""month""<12), ""available_drivers"" AS (SELECT ""months"".""month"",COALESCE(MAX(""t1"".""active_driver"") OVER (ORDER BY ""month""), 0) AS ""active_driver"" FROM ""months"" LEFT JOIN (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(""driver_id"") OVER (ORDER BY ""join_date"" ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS ""active_driver"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020) AS ""t1"" ON ""t1"".""month""=""months"".""month""), ""working_drivers"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""working_driver"" FROM ""Rides"" AS ""R"" JOIN ""AcceptedRides"" AS ""A"" ON ""R"".""ride_id""=""A"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY 1) SELECT ""months"".""month"",COALESCE(ROUND(""working_driver""/""active_driver""*100, 2), 0) AS ""working_percentage"" FROM (""months"" LEFT JOIN ""available_drivers"" ON ""available_drivers"".""month""=""months"".""month"") LEFT JOIN ""working_drivers"" ON ""working_drivers"".""month""=""months"".""month"" GROUP BY 1"
233,"WITH RECURSIVE ""months"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""months"" WHERE ""month""<12), ""driver_available"" AS (SELECT (CASE WHEN EXTRACT(YEAR FROM ""join_date"")<2020 THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END) AS ""month"",""driver_id"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020), ""driver_acceptedrides"" AS (SELECT EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""month"",""a"".""driver_id"" FROM ""rides"" AS ""r"" JOIN ""acceptedrides"" AS ""a"" ON ""r"".""ride_id""=""a"".""ride_id"" WHERE EXTRACT(YEAR FROM ""r"".""requested_at"")=2020) SELECT ""m"".""month"",ROUND(COALESCE(COUNT(DISTINCT ""a"".""driver_id"")/COUNT(DISTINCT ""da"".""driver_id""), 0)*100, 2) AS ""working_percentage"" FROM (""months"" AS ""m"" LEFT JOIN ""driver_available"" AS ""da"" ON ""m"".""month"">=""da"".""month"") LEFT JOIN ""driver_acceptedrides"" AS ""a"" ON ""m"".""month""=""a"".""month"" GROUP BY ""m"".""month"" ORDER BY ""m"".""month"""
234,"WITH RECURSIVE ""2020_m"" (""m"") AS (SELECT 1 UNION ALL SELECT ""m""+1 FROM ""2020_m"" WHERE ""m""<12), ""2020_month"" AS (SELECT ""m"".""m"" AS ""month"",COALESCE(""drv_cnt"", 0) AS ""drv_cnt"" FROM ""2020_m"" AS ""m"" LEFT JOIN (SELECT CASE WHEN ""join_date""<'2020-01-01' THEN '01' ELSE TO_CHAR(""join_date"", '%m') END AS ""month"",COUNT(""driver_id"") AS ""drv_cnt"" FROM ""Drivers"" WHERE ""join_date""<'2021-01-01' GROUP BY 1) AS ""d"" ON ""m"".""m""=""d"".""month""), ""cur_drv"" AS (SELECT ""month"",SUM(""drv_cnt"") OVER (ORDER BY ""month"") AS ""cum_drv"" FROM ""2020_month"") SELECT ""c"".""month"",ROUND(COALESCE(""a"".""cnt_acc""/""c"".""cum_drv"", 0)*100, 2) AS ""working_percentage"" FROM ""cur_drv"" AS ""c"" LEFT JOIN (SELECT TO_CHAR(""requested_at"", '%m') AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""cnt_acc"" FROM ""AcceptedRides"" AS ""a"" JOIN ""Rides"" AS ""r"" USING (""ride_id"") WHERE ""requested_at""<'2021-01-01' AND ""requested_at"">'2019-12-31' GROUP BY 1) AS ""a"" USING (""month"")"
235,"WITH RECURSIVE ""T1"" AS (SELECT 1 AS ""join_month"" UNION SELECT ""join_month""+1 FROM ""T1"" WHERE ""join_month""<12), ""T2"" AS (SELECT CASE WHEN EXTRACT(YEAR FROM ""join_date"")<'2020' THEN '1' ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""join_month"",COUNT(""driver_id"") AS ""driver_num"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<='2020' GROUP BY ""join_month""), ""T3"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""join_month"",COUNT(DISTINCT ""ar"".""driver_id"") AS ""ride_num"" FROM ""AcceptedRides"" AS ""ar"" LEFT JOIN ""Rides"" AS ""r"" ON ""ar"".""ride_id""=""r"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")='2020' GROUP BY ""join_month"") SELECT ""T1"".""join_month"" AS ""month"",ROUND(100*COALESCE(""T3"".""ride_num""/SUM(""T2"".""driver_num""), 0), 2) AS ""working_percentage"" FROM (""T1"" LEFT JOIN ""T2"" ON ""T1"".""join_month"">=""T2"".""join_month"") LEFT JOIN ""T3"" ON ""T1"".""join_month""=""T3"".""join_month"" GROUP BY ""T1"".""join_month"" ORDER BY ""T1"".""join_month"""
236,"WITH RECURSIVE ""month_list"" (""month"") AS (SELECT 1 UNION SELECT ""month""+1 FROM ""month_list"" WHERE ""month""<12), ""accept_rides"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",""driver_id"",COUNT(""ride_distance"") AS ""accepted_rides"" FROM ""Rides"" LEFT JOIN ""AcceptedRides"" USING (""ride_id"") WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY ""month"",""driver_id"") SELECT ""month_list"".""month"" AS ""month"",COALESCE(ROUND((COUNT(DISTINCT ""accept_rides"".""driver_id"")*100/COUNT(""Drivers"".""driver_id"")), 2), 0) AS ""working_percentage"" FROM (""month_list"" LEFT JOIN ""Drivers"" ON (EXTRACT(YEAR FROM ""join_date"")=2020 AND EXTRACT(MONTH FROM ""join_date"")<=""month_list"".""month"") OR (EXTRACT(YEAR FROM ""join_date"")<2020)) LEFT JOIN ""accept_rides"" ON ""month_list"".""month""=""accept_rides"".""month"" AND ""Drivers"".""driver_id""=""accept_rides"".""driver_id"" GROUP BY ""month_list"".""month"" ORDER BY ""month_list"".""month"""
237,"WITH RECURSIVE ""T1"" AS (SELECT 1 AS ""join_month"" UNION SELECT ""join_month""+1 FROM ""T1"" WHERE ""join_month""<12), ""T2"" AS (SELECT CASE WHEN EXTRACT(YEAR FROM ""join_date"")<'2020' THEN '1' ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""join_month"",COUNT(""driver_id"") AS ""driver_num"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<='2020' GROUP BY ""join_month""), ""T3"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""join_month"",COUNT(DISTINCT ""ar"".""driver_id"") AS ""ride_num"" FROM ""AcceptedRides"" AS ""ar"" LEFT JOIN ""Rides"" AS ""r"" ON ""ar"".""ride_id""=""r"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")='2020' GROUP BY ""join_month"") SELECT ""T1"".""join_month"" AS ""month"",ROUND(100*COALESCE(""T3"".""ride_num""/SUM(""T2"".""driver_num""), 0), 2) AS ""working_percentage"" FROM (""T1"" LEFT JOIN ""T2"" ON ""T1"".""join_month"">=""T2"".""join_month"") LEFT JOIN ""T3"" ON ""T1"".""join_month""=""T3"".""join_month"" GROUP BY ""T1"".""join_month"" ORDER BY ""T1"".""join_month"""
238,"WITH RECURSIVE ""cte"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""cte"" WHERE ""month""<12), ""temp1"" AS (SELECT ""month"",SUM(COALESCE(""avail_drivers"", 0)) OVER (ORDER BY ""month"") AS ""drivers"" FROM ""cte"" LEFT JOIN (SELECT EXTRACT(MONTH FROM CASE WHEN ""join_date""<'2020-01-01' THEN '2020-01-01' ELSE ""join_date"" END) AS ""mon"",COUNT(""driver_id"") AS ""avail_drivers"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<2021 GROUP BY EXTRACT(MONTH FROM CASE WHEN ""join_date""<'2020-01-01' THEN '2020-01-01' ELSE ""join_date"" END)) AS ""sub"" ON ""cte"".""month""=""sub"".""mon""), ""temp2"" AS (SELECT ""month"",COALESCE(COUNT(""driver_id""), 0) AS ""working"" FROM (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",""a"".""driver_id"" FROM ""Rides"" AS ""r"" JOIN ""AcceptedRides"" AS ""a"" ON ""r"".""ride_id""=""a"".""ride_id"" AND EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY EXTRACT(MONTH FROM ""requested_at""),""a"".""driver_id"" HAVING COUNT(""a"".""ride_id"")>0) AS ""sub"" GROUP BY ""month"") SELECT ""temp1"".""month"",ROUND(COALESCE(""working""/""drivers""*100, 0), 2) AS ""working_percentage"" FROM ""temp1"" LEFT JOIN ""temp2"" ON ""temp1"".""month""=""temp2"".""month"" ORDER BY ""month"""
239,"WITH RECURSIVE ""month_series"" AS (SELECT 1 AS ""mon"" UNION SELECT ""mon""+1 AS ""mon"" FROM ""month_series"" WHERE ""mon""<12), ""available_users_monthly"" AS (SELECT ""m"".""mon"",COALESCE(COUNT(DISTINCT ""d"".""driver_id""), 0.00) AS ""cnt"" FROM ""month_series"" AS ""m"" LEFT JOIN ""Drivers"" AS ""d"" ON (""d"".""join_date""<'2020-01-01' OR (EXTRACT(YEAR FROM ""d"".""join_date"")=2020 AND ""m"".""mon"">=EXTRACT(MONTH FROM ""d"".""join_date""))) GROUP BY ""m"".""mon""), ""working_drivers_monthly"" AS (SELECT ""m"".""mon"",COALESCE(COUNT(DISTINCT ""ar"".""driver_id""), 0.00) AS ""cnt"" FROM (""month_series"" AS ""m"" LEFT JOIN ""rides"" AS ""r"" ON (EXTRACT(YEAR FROM ""r"".""requested_at"")=2020 AND EXTRACT(MONTH FROM ""r"".""requested_at"")=""m"".""mon"")) LEFT JOIN ""AcceptedRides"" AS ""ar"" ON (""r"".""ride_id""=""ar"".""ride_id"") GROUP BY ""m"".""mon"") SELECT ""a"".""mon"" AS ""month"",COALESCE(ROUND((""w"".""cnt""*100.0)/""a"".""cnt"", 2), 0.00) AS ""working_percentage"" FROM ""available_users_monthly"" AS ""a"" JOIN ""working_drivers_monthly"" AS ""w"" ON (""a"".""mon""=""w"".""mon"")"
240,"WITH RECURSIVE ""months"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""months"" WHERE ""month""<12), ""driver"" AS (SELECT ""driver_id"",CASE WHEN EXTRACT(YEAR FROM ""join_date"")<2020 THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""month"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020), ""avail_driver"" AS (SELECT ""a"".""month"",COUNT(""b"".""driver_id"") AS ""avails"" FROM ""months"" AS ""a"" LEFT JOIN ""driver"" AS ""b"" ON ""a"".""month"">=""b"".""month"" GROUP BY 1), ""accept_rides"" AS (SELECT ""a"".""month"",COUNT(DISTINCT ""driver_id"") AS ""rides"" FROM ""months"" AS ""a"" LEFT JOIN (SELECT ""driver_id"",EXTRACT(MONTH FROM ""requested_at"") AS ""month"" FROM ""acceptedrides"" AS ""a"" LEFT JOIN ""rides"" AS ""b"" ON ""a"".""ride_id""=""b"".""ride_id"" WHERE ""requested_at"" LIKE '2020%') AS ""b"" ON ""a"".""month""=""b"".""month"" GROUP BY 1) SELECT ""a"".""month"",COALESCE(ROUND(100*""rides""/""avails"", 2), 0) AS ""working_percentage"" FROM ""accept_rides"" AS ""a"" JOIN ""avail_driver"" AS ""b"" ON ""a"".""month""=""b"".""month"" ORDER BY 1"
241,"WITH RECURSIVE ""t1"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""m"",COUNT(DISTINCT ""driver_id"") AS ""c"" FROM ""rides"" AS ""a"" JOIN ""acceptedrides"" AS ""b"" ON ""a"".""ride_id""=""b"".""ride_id"" WHERE ""requested_at"" BETWEEN '2020-01-01' AND '2020-12-31' GROUP BY EXTRACT(MONTH FROM ""requested_at"")), ""t2"" AS (SELECT 1 AS ""m"" UNION ALL SELECT ""m""+1 AS ""m"" FROM ""t2"" WHERE ""m""<12), ""t3"" AS (SELECT ""m"",SUM(CASE WHEN (EXTRACT(YEAR FROM ""join_date"")<=2019) OR (EXTRACT(YEAR FROM ""join_date"")=2020 AND EXTRACT(MONTH FROM ""join_date"")<=""m"") THEN 1 ELSE 0 END) AS ""available_drivers"" FROM ""t2"" AS ""a"" JOIN ""drivers"" AS ""b"" GROUP BY ""a"".""m""), ""t4"" AS (SELECT ""t2"".""m"",COALESCE(""t1"".""c"", 0) AS ""c"" FROM ""t2"" LEFT JOIN ""t1"" ON ""t2"".""m""=""t1"".""m"") SELECT ""t3"".""m"" AS ""month"",CASE WHEN ""t3"".""available_drivers""=0 THEN 0 ELSE ROUND(""t4"".""c""*100/""t3"".""available_drivers"", 2) END AS ""working_percentage"" FROM ""t3"" JOIN ""t4"" ON ""t3"".""m""=""t4"".""m"""
242,"WITH RECURSIVE ""t1"" AS (SELECT 1 AS ""month"" UNION SELECT ""month""+1 AS ""month"" FROM ""t1"" WHERE ""month""<12), ""t2"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""act_id"" FROM ""rides"" AS ""a"" JOIN ""AcceptedRides"" AS ""b"" USING (""ride_id"") WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY 1) SELECT ""a"".""month"",CASE WHEN COUNT(""b"".""driver_id"")=0 THEN ROUND(0, 2) ELSE ROUND(100*COALESCE(""act_id"", 0)/COUNT(""b"".""driver_id""), 2) END AS ""working_percentage"" FROM (""t1"" AS ""a"" LEFT JOIN ""drivers"" AS ""b"" ON (EXTRACT(YEAR FROM ""join_date"")=2020 AND EXTRACT(MONTH FROM ""join_date"")<=""a"".""month"") OR EXTRACT(YEAR FROM ""join_date"")<2020) LEFT JOIN ""t2"" AS ""c"" ON ""a"".""month""=""c"".""month"" GROUP BY 1 ORDER BY 1"
243,"WITH RECURSIVE ""CTE"" (""month"") AS (SELECT 1 UNION ALL SELECT ""month""+1 AS ""month"" FROM ""CTE"" WHERE ""month""<12), ""d"" AS (SELECT ""driver_id"",CASE WHEN EXTRACT(YEAR FROM ""join_date"")<2020 THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""month"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020), ""e"" AS (SELECT ""a"".""driver_id"",EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""month"" FROM ""Rides"" AS ""r"" LEFT JOIN ""AcceptedRides"" AS ""a"" ON ""r"".""ride_id""=""a"".""ride_id"" WHERE EXTRACT(YEAR FROM ""r"".""requested_at"")=2020) SELECT ""c"".""month"",COALESCE(ROUND(100*COUNT(DISTINCT ""e"".""driver_id"")/COUNT(DISTINCT ""d"".""driver_id""), 2), 0) AS ""working_percentage"" FROM (""CTE"" AS ""c"" LEFT JOIN ""d"" ON ""d"".""month""<=""c"".""month"") LEFT JOIN ""e"" ON ""e"".""month""=""c"".""month"" GROUP BY 1 ORDER BY 1"
244,"WITH ""months"" AS (SELECT 1 AS ""month"" UNION SELECT 2 AS ""month"" UNION SELECT 3 AS ""month"" UNION SELECT 4 AS ""month"" UNION SELECT 5 AS ""month"" UNION SELECT 6 AS ""month"" UNION SELECT 7 AS ""month"" UNION SELECT 8 AS ""month"" UNION SELECT 9 AS ""month"" UNION SELECT 10 AS ""month"" UNION SELECT 11 AS ""month"" UNION SELECT 12 AS ""month""), ""drivers_join"" AS (SELECT ""driver_id"",EXTRACT(MONTH FROM ""join_date"") AS ""month_j"",EXTRACT(YEAR FROM ""join_date"") AS ""year_j"" FROM ""drivers""), ""base"" AS (SELECT ""driver_id"",EXTRACT(MONTH FROM ""requested_at"") AS ""month_ride"" FROM ""rides"" AS ""ri"" JOIN ""AcceptedRides"" AS ""ac"" ON ""ri"".""ride_id""=""ac"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020) SELECT ""months"".""month"",COALESCE(ROUND(COUNT(DISTINCT ""base"".""driver_id"")/COUNT(DISTINCT ""dj"".""driver_id"")*100, 2), 0) AS ""working_percentage"" FROM (""months"" LEFT JOIN ""drivers_join"" AS ""dj"" ON 2020*100+""months"".""month"">=""dj"".""year_j""*100+""dj"".""month_j"") LEFT JOIN ""base"" ON ""dj"".""driver_id"" AND ""base"".""driver_id"" AND ""months"".""month""=""month_ride"" GROUP BY 1 ORDER BY ""month"""
245,"WITH RECURSIVE ""cte"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""cte"" WHERE ""month""<12) SELECT ""t"".""month"",COALESCE(ROUND(CAST((SELECT COUNT(DISTINCT ""a"".""driver_id"") FROM ""acceptedrides"" AS ""a"" JOIN ""rides"" AS ""b"" ON ""a"".""ride_id""=""b"".""ride_id"" AND ""b"".""requested_at"" BETWEEN '2020-01-01' AND '2020-12-31' AND EXTRACT(MONTH FROM ""b"".""requested_at"")=""t"".""month"") AS FLOAT)*100/CAST((SELECT COUNT(DISTINCT ""driver_id"") FROM ""drivers"" WHERE ""join_date""<'2021-01-01' AND (""join_date""<'2020-01-01' OR EXTRACT(MONTH FROM ""join_date"")<=""t"".""month"")) AS FLOAT), 2), 0.00) AS ""working_percentage"" FROM ""cte"" AS ""t"""
246,"WITH RECURSIVE ""t"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""t"" WHERE ""month""<12), ""t2"" AS (SELECT DISTINCT ""t"".""month"",COUNT(""drivers"".""driver_id"") OVER (PARTITION BY ""t"".""month"") AS ""valid_drivers"" FROM ""t"" LEFT JOIN (SELECT ""driver_id"",CASE WHEN ""join_date""<'2020-01-01' THEN '2020-01-01' ELSE ""join_date"" END AS ""new_date"" FROM ""drivers"") AS ""drivers"" ON ""t"".""month""=EXTRACT(MONTH FROM ""drivers"".""new_date"") AND EXTRACT(YEAR FROM ""drivers"".""new_Date"")=2020), ""t3"" AS (SELECT ""t"".""month"",COUNT(DISTINCT ""driver_id"") AS ""accepted_driver"" FROM (""rides"" RIGHT JOIN ""AcceptedRides"" ON ""rides"".""ride_id""=""acceptedRides"".""ride_id"") RIGHT JOIN ""t"" ON ""t"".""month""=EXTRACT(MONTH FROM ""rides"".""requested_at"") AND EXTRACT(YEAR FROM ""rides"".""requested_at"")=2020 GROUP BY ""t"".""month"") SELECT ""t2"".""month"",ROUND(COALESCE(""accepted_driver""/SUM(""valid_drivers"") OVER (ORDER BY ""t2"".""month"")*100, 0), 2) AS ""working_percentage"" FROM ""t2"" JOIN ""t3"" ON ""t2"".""month""=""t3"".""month"""
247,"WITH RECURSIVE ""calendar_months"" AS (SELECT 1 AS ""month"" UNION SELECT ""month""+1 FROM ""calendar_months"" WHERE ""month""<12) SELECT ""monthly_available_driver"".""month"",ROUND(COALESCE(""drivers_accepted_ride""/SUM(""available_drivers"") OVER (ORDER BY ""monthly_available_driver"".""month""), 0)*100, 2) AS ""working_percentage"" FROM (SELECT ""CM"".""month"",COALESCE(""D1"".""available_drivers"", 0) AS ""available_drivers"" FROM ""calendar_months"" AS ""CM"" LEFT JOIN (SELECT ""month"",CASE WHEN ""month""=1 THEN ""available_drivers""+(SELECT COUNT(DISTINCT ""driver_id"") FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<2020) ELSE ""available_drivers"" END AS ""available_drivers"" FROM (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(""driver_id"") AS ""available_drivers"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")=2020 GROUP BY ""month"") AS ""only_2020"") AS ""D1"" ON ""CM"".""month""=""D1"".""month"") AS ""monthly_available_driver"" LEFT JOIN (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""drivers_accepted_ride"" FROM ""Rides"" AS ""r"" LEFT JOIN ""AcceptedRides"" AS ""ar"" ON ""r"".""ride_id""=""ar"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY ""month"") AS ""monthly_accepted_rides"" ON ""monthly_available_driver"".""month""=""monthly_accepted_rides"".""month"""
248,"WITH RECURSIVE ""all_months"" (""month"") AS (SELECT 1 UNION ALL SELECT ""month""+1 FROM ""all_months"" WHERE ""month""<12), ""drivers_pm"" AS (SELECT EXTRACT(YEAR FROM ""join_date"") AS ""year"",EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(""driver_id"") AS ""num_drivers"" FROM ""Drivers"" WHERE 'year'<=2020 GROUP BY 1,2), ""drivers_pmc"" AS (SELECT ""d1"".""month"" AS ""month"",SUM(""d2"".""num_drivers"") AS ""num_available"" FROM ""all_months"" AS ""d1"" LEFT JOIN ""drivers_pm"" AS ""d2"" ON (2020>""d2"".""year"" OR (2020=""d2"".""year"" AND ""d1"".""month"">=""d2"".""month"")) GROUP BY ""d1"".""month"") SELECT ""drivers_pmc"".""month"" AS ""month"",COALESCE(ROUND((100.0*""t1"".""num_working"")/""drivers_pmc"".""num_available"", 2), 0) AS ""working_percentage"" FROM ""drivers_pmc"" LEFT JOIN (SELECT EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""num_working"" FROM ""AcceptedRides"" AS ""ar"" JOIN ""Rides"" AS ""r"" ON ""ar"".""ride_id""=""r"".""ride_id"" WHERE EXTRACT(YEAR FROM ""r"".""requested_at"")=2020 GROUP BY ""month"") AS ""t1"" ON ""drivers_pmc"".""month""=""t1"".""month"" ORDER BY ""month"""
249,"WITH RECURSIVE ""active_driver"" AS (SELECT ""driver_id"",""join_date"",""join_date"" AS ""dur"" FROM ""drivers"" UNION SELECT ""driver_id"",""join_date"",""dur"" + INTERVAL '1 MONTH' AS ""dur"" FROM ""active_driver"" WHERE ""dur""<LAST_DAY(CURDATE()) + INTERVAL '1 MONTH'), ""datedim"" AS (SELECT 1 AS ""m"" UNION SELECT ""m""+1 FROM ""datedim"" WHERE ""m""<12) SELECT ""m"" AS ""month"",ROUND(COALESCE(""wd"".""working_driver"", 0)*100/COALESCE(""ad"".""monthly_ad"", 1), 2) AS ""working_percentage"" FROM (""datedim"" AS ""dd"" LEFT JOIN (SELECT EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""month"",COUNT(DISTINCT ""ar"".""driver_id"") AS ""working_driver"" FROM ""acceptedrides"" AS ""ar"" JOIN ""rides"" AS ""r"" ON ""r"".""ride_id""=""ar"".""ride_id"" WHERE EXTRACT(YEAR FROM ""r"".""requested_at"")=2020 GROUP BY EXTRACT(MONTH FROM ""r"".""requested_at"")) AS ""wd"" ON ""wd"".""month""=""dd"".""m"") LEFT JOIN (SELECT EXTRACT(MONTH FROM ""dur"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""monthly_ad"" FROM ""active_driver"" WHERE EXTRACT(YEAR FROM ""dur"")=2020 GROUP BY EXTRACT(MONTH FROM ""dur"")) AS ""ad"" ON ""ad"".""month""=""dd"".""m"""
250,"WITH RECURSIVE ""m"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""m"" WHERE ""month""<12), ""ad"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",""driver_id"" FROM ""AcceptedRides"" JOIN ""Rides"" USING (""ride_id"") WHERE EXTRACT(YEAR FROM ""requested_at"")=2020), ""d"" AS (SELECT CASE WHEN EXTRACT(YEAR FROM ""join_date"")<=2019 THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""month"",""driver_id"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020) SELECT ""m"".""month"",ROUND(COALESCE(COUNT(DISTINCT ""ad"".""driver_id"")/SUM(COUNT(DISTINCT ""d"".""driver_id"")) OVER (ORDER BY ""m"".""month"")*100, 0), 2) AS ""working_percentage"" FROM (""m"" LEFT JOIN ""ad"" ON ""m"".""month""=""ad"".""month"") LEFT JOIN ""d"" ON ""m"".""month""=""d"".""month"" GROUP BY 1"
251,"SELECT ""t1"".""month"",ROUND(COALESCE(""t2"".""active_drivers""*100/""t1"".""available_drivers"", 0), 2) AS ""working_percentage"" FROM (SELECT ""m"".""month"",COUNT(""d"".""driver_id"") AS ""available_drivers"" FROM ((SELECT 1 AS ""month"") UNION (SELECT 2 AS ""month"") UNION (SELECT 3 AS ""month"") UNION (SELECT 4 AS ""month"") UNION (SELECT 5 AS ""month"") UNION (SELECT 6 AS ""month"") UNION (SELECT 7 AS ""month"") UNION (SELECT 8 AS ""month"") UNION (SELECT 9 AS ""month"") UNION (SELECT 10 AS ""month"") UNION (SELECT 11 AS ""month"") UNION (SELECT 12 AS ""month"")) AS ""m"" LEFT JOIN ""drivers"" AS ""d"" ON ""d"".""join_date""<=LAST_DAY(CONCAT('2020-', ""m"".""month"", '-1')) GROUP BY ""m"".""month"") AS ""t1"" LEFT JOIN (SELECT EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""active_drivers"" FROM ""rides"" AS ""r"" JOIN ""acceptedrides"" AS ""ar"" ON ""r"".""ride_id""=""ar"".""ride_id"" AND EXTRACT(YEAR FROM ""r"".""requested_at"")=2020 GROUP BY EXTRACT(MONTH FROM ""r"".""requested_at"")) AS ""t2"" ON ""t1"".""month""=""t2"".""month"" ORDER BY ""t1"".""month"""
252,"WITH RECURSIVE ""cte_month_spine"" AS (SELECT 1 AS ""n"" UNION ALL SELECT ""n""+1 AS ""n"" FROM ""cte_month_spine"" WHERE ""n""<12), ""cte_available_drivers"" AS (SELECT ""ms"".""n"" AS ""month"",COUNT(""driver_id"") AS ""available_drivers"" FROM ""cte_month_spine"" AS ""ms"" LEFT JOIN ""Drivers"" AS ""d"" ON LAST_DAY(CONCAT('2020-', ""ms"".""n"", '-01'))>=""d"".""join_date"" GROUP BY 1), ""cte_working_drivers"" AS (SELECT ""ms"".""n"" AS ""month"",COUNT(DISTINCT ""ar"".""driver_id"") AS ""working_drivers"" FROM (""cte_month_spine"" AS ""ms"" LEFT JOIN ""Rides"" AS ""r"" ON ""r"".""requested_at"" BETWEEN CONCAT('2020-', ""ms"".""n"", '-01') AND LAST_DAY(CONCAT('2020-', ""ms"".""n"", '-01'))) LEFT JOIN ""AcceptedRides"" AS ""ar"" ON ""r"".""ride_id""=""ar"".""ride_id"" GROUP BY 1), ""cte_final"" AS (SELECT ""ad"".""month"",ROUND(100*COALESCE(""working_drivers""/""available_drivers"", 0), 2) AS ""working_percentage"" FROM ""cte_available_drivers"" AS ""ad"" JOIN ""cte_working_drivers"" AS ""wd"" ON ""ad"".""month""=""wd"".""month"" ORDER BY 1) SELECT * FROM ""cte_final"""
253,"WITH RECURSIVE ""a"" AS (SELECT DISTINCT '2020-01-01' AS ""m_start"" FROM ""drivers"" UNION ALL SELECT ""m_start"" + INTERVAL '+1 MONTH' FROM ""a"" WHERE ""m_start""<'2020-12-01'), ""b"" AS (SELECT *,CASE WHEN TO_CHAR(""join_date"", 'YYYY-%m')<=TO_CHAR(""m_start"", 'YYYY-%m') THEN 1 ELSE 0 END AS ""joined"" FROM ""drivers"" JOIN ""a""), ""t1"" AS (SELECT ""m_start"",SUM(""joined"") AS ""num_avail_drivers"" FROM ""b"" GROUP BY ""m_start""), ""t2"" AS (SELECT ""m_start"",COUNT(DISTINCT ""driver_id"") AS ""num_active_drivers"" FROM (SELECT ""ar"".""driver_id"",""r"".""requested_at"" - INTERVAL 'DAYOFMONTH(""r"".""requested_at"")-1 DAY' AS ""m_start"" FROM ""rides"" AS ""r"" RIGHT JOIN ""acceptedrides"" AS ""ar"" ON ""r"".""ride_id""=""ar"".""ride_id"") AS ""temp"" GROUP BY ""m_start"") SELECT ""month"",CASE WHEN ""working_percentage"" IS NULL THEN 0 ELSE ""working_percentage"" END AS ""working_percentage"" FROM (SELECT EXTRACT(MONTH FROM ""t1"".""m_start"") AS ""month"",ROUND(100*CASE WHEN ""t2"".""num_active_drivers"" IS NULL THEN 0 ELSE ""t2"".""num_active_drivers"" END/CASE WHEN ""t1"".""num_avail_drivers"" IS NULL THEN 0 ELSE ""t1"".""num_avail_drivers"" END, 2) AS ""working_percentage"" FROM ""t1"" LEFT JOIN ""t2"" ON ""t1"".""m_start""=""t2"".""m_start"" ORDER BY ""t1"".""m_start"") AS ""temp"""
254,"WITH RECURSIVE ""months"" (""month"") AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""months"" WHERE ""month""<12), ""t1"" AS (SELECT ""r"".""ride_id"",""requested_at"",""ar"".""driver_id"" FROM (""Rides"" AS ""r"") JOIN ""AcceptedRides"" AS ""ar"" WHERE ""r"".""ride_id""=""ar"".""ride_id"" AND EXTRACT(YEAR FROM ""requested_at"")=2020) SELECT ""m"".""month"",ROUND(COALESCE(COUNT(DISTINCT ""t1"".""driver_id"")/COUNT(DISTINCT ""d"".""driver_id"")*100, 0), 2) AS ""working_percentage"" FROM (""months"" AS ""m"" LEFT JOIN ""Drivers"" AS ""d"" ON ""d"".""join_date""<CONCAT('2020-', ""m"".""month"", '-01') + INTERVAL '1 MONTH') LEFT JOIN ""t1"" ON ""t1"".""driver_id""=""d"".""driver_id"" AND EXTRACT(MONTH FROM ""t1"".""requested_at"")=""m"".""month"" GROUP BY ""m"".""month"" ORDER BY 1"
255,"WITH ""t"" (""Month"") AS (SELECT 1 UNION ALL SELECT 2 UNION ALL SELECT 3 UNION ALL SELECT 4 UNION ALL SELECT 5 UNION ALL SELECT 6 UNION ALL SELECT 7 UNION ALL SELECT 8 UNION ALL SELECT 9 UNION ALL SELECT 10 UNION ALL SELECT 11 UNION ALL SELECT 12) SELECT ""t"".""month"",CASE WHEN COUNT(DISTINCT ""x"".""driver_id"")+0.00=0.00 OR COUNT(DISTINCT ""d"".""Driver_id"")+0.00=0.00 THEN 0.00 ELSE ROUND((COUNT(DISTINCT ""x"".""driver_id"")+0.00)*100/(COUNT(DISTINCT ""d"".""Driver_id"")+0.00), 2) END AS ""Working_percentage"" FROM (""t"" LEFT JOIN ""Drivers"" AS ""d"" ON (EXTRACT(MONTH FROM ""d"".""join_Date"")<=""t"".""month"" AND EXTRACT(YEAR FROM ""d"".""JOIN_DATE"")=2020) OR EXTRACT(YEAR FROM ""d"".""join_date"")<2020) LEFT JOIN (SELECT ""a"".""driver_id"",""r"".""requested_at"" FROM ""Rides"" AS ""r"" JOIN ""acceptedrides"" AS ""a"" ON ""a"".""ride_id""=""r"".""ride_id"" WHERE EXTRACT(YEAR FROM ""r"".""requested_at"")=2020) AS ""x"" ON ""t"".""Month""=EXTRACT(MONTH FROM ""x"".""requested_at"") GROUP BY ""t"".""month"" ORDER BY ""t"".""month"""
256,"WITH RECURSIVE ""months"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""months"" WHERE ""month""<12) SELECT ""m"".""month"",CASE WHEN COUNT(DISTINCT ""d"".""driver_id"")>0 THEN ROUND(COUNT(DISTINCT ""t"".""driver_id"")*100.0/COUNT(DISTINCT ""d"".""driver_id""), 2) ELSE 0 END AS ""working_percentage"" FROM (""months"" AS ""m"" LEFT JOIN ""Drivers"" AS ""d"" ON EXTRACT(YEAR FROM ""d"".""join_date"")<2020 OR (EXTRACT(YEAR FROM ""d"".""join_date"")=2020 AND EXTRACT(MONTH FROM ""d"".""join_date"")<=""m"".""month"")) LEFT JOIN (SELECT ""driver_id"",""requested_at"" FROM ""AcceptedRides"" AS ""a"" JOIN ""Rides"" AS ""r"" ON ""a"".""ride_id""=""r"".""ride_id"") AS ""t"" ON EXTRACT(YEAR FROM ""t"".""requested_at"")=2020 AND ""m"".""month""=EXTRACT(MONTH FROM ""t"".""requested_at"") GROUP BY ""m"".""month"" ORDER BY ""m"".""month"""
257,"WITH RECURSIVE ""months"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""months"" WHERE ""month""<12), ""available_drivers"" AS (SELECT ""months"".""month"",COALESCE(MAX(""t1"".""active_driver"") OVER (ORDER BY ""month""), 0) AS ""active_driver"" FROM ""months"" LEFT JOIN (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(""driver_id"") OVER (ORDER BY ""join_date"" ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS ""active_driver"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020) AS ""t1"" ON ""t1"".""month""=""months"".""month""), ""working_drivers"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""working_driver"" FROM ""Rides"" AS ""R"" JOIN ""AcceptedRides"" AS ""A"" ON ""R"".""ride_id""=""A"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY 1) SELECT ""months"".""month"",COALESCE(ROUND(""working_driver""/""active_driver""*100, 2), 0) AS ""working_percentage"" FROM (""months"" LEFT JOIN ""available_drivers"" ON ""available_drivers"".""month""=""months"".""month"") LEFT JOIN ""working_drivers"" ON ""working_drivers"".""month""=""months"".""month"" GROUP BY 1"
258,"WITH RECURSIVE ""months"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""months"" WHERE ""month""<12), ""available_drivers"" AS (SELECT ""months"".""month"",COALESCE(MAX(""t1"".""active_driver"") OVER (ORDER BY ""month""), 0) AS ""active_driver"" FROM ""months"" LEFT JOIN (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(""driver_id"") OVER (ORDER BY ""join_date"" ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS ""active_driver"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020) AS ""t1"" ON ""t1"".""month""=""months"".""month""), ""working_drivers"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""working_driver"" FROM ""Rides"" AS ""R"" JOIN ""AcceptedRides"" AS ""A"" ON ""R"".""ride_id""=""A"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY 1) SELECT ""months"".""month"",COALESCE(ROUND(""working_driver""/""active_driver""*100, 2), 0) AS ""working_percentage"" FROM (""months"" LEFT JOIN ""available_drivers"" ON ""available_drivers"".""month""=""months"".""month"") LEFT JOIN ""working_drivers"" ON ""working_drivers"".""month""=""months"".""month"" GROUP BY 1"
259,"WITH RECURSIVE ""months"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""months"" WHERE ""month""<12), ""available_drivers"" AS (SELECT ""months"".""month"",COALESCE(MAX(""t1"".""active_driver"") OVER (ORDER BY ""month""), 0) AS ""active_driver"" FROM ""months"" LEFT JOIN (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(""driver_id"") OVER (ORDER BY ""join_date"" ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS ""active_driver"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020) AS ""t1"" ON ""t1"".""month""=""months"".""month""), ""working_drivers"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""working_driver"" FROM ""Rides"" AS ""R"" JOIN ""AcceptedRides"" AS ""A"" ON ""R"".""ride_id""=""A"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY 1) SELECT ""months"".""month"",COALESCE(ROUND(""working_driver""/""active_driver""*100, 2), 0) AS ""working_percentage"" FROM (""months"" LEFT JOIN ""available_drivers"" ON ""available_drivers"".""month""=""months"".""month"") LEFT JOIN ""working_drivers"" ON ""working_drivers"".""month""=""months"".""month"" GROUP BY 1"
260,"WITH RECURSIVE ""cte1"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 AS ""month"" FROM ""cte1"" WHERE ""month""<12), ""d1"" AS (SELECT ""driver_id"",(CASE WHEN EXTRACT(YEAR FROM ""join_date"")<2020 THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END) AS ""join_month"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<2021), ""c1"" AS (SELECT ""cte1"".""month"",COUNT(DISTINCT ""driver_id"") AS ""active_drivers"" FROM ""cte1"" LEFT JOIN ""d1"" ON ""month"">=""join_month"" GROUP BY 1), ""c2"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""accepted_rides"" FROM ""rides"" JOIN ""acceptedrides"" USING (""ride_id"") WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY 1) SELECT ""month"",ROUND(CASE WHEN ""active_drivers""=0 THEN 0 ELSE 100*COALESCE(""accepted_rides"", 0)/""active_drivers"" END, 2) AS ""working_percentage"" FROM ""c1"" LEFT JOIN ""c2"" USING (""month"") ORDER BY 1"
261,"WITH ""m"" (""month"") AS (SELECT '2020-01' UNION ALL SELECT '2020-02' UNION ALL SELECT '2020-03' UNION ALL SELECT '2020-04' UNION ALL SELECT '2020-05' UNION ALL SELECT '2020-06' UNION ALL SELECT '2020-07' UNION ALL SELECT '2020-08' UNION ALL SELECT '2020-09' UNION ALL SELECT '2020-10' UNION ALL SELECT '2020-11' UNION ALL SELECT '2020-12'), ""num_drivers_month"" AS (SELECT LEFT(""join_date"", 7) AS ""join_month"",COUNT(1) AS ""drivers_avail_month"" FROM ""drivers"" AS ""d"" GROUP BY LEFT(""join_date"", 7)), ""num_drivers"" AS (SELECT ""join_month"",SUM(""drivers_avail_month"") OVER (ORDER BY ""join_month"") AS ""drivers_avail"" FROM ""num_drivers_month""), ""num_acc"" AS (SELECT LEFT(""r"".""requested_at"", 7) AS ""request_month"",COUNT(DISTINCT ""ar"".""driver_id"") AS ""drivers_accepted"" FROM ""rides"" AS ""r"" JOIN ""acceptedrides"" AS ""ar"" ON ""r"".""ride_id""=""ar"".""ride_id"" GROUP BY LEFT(""r"".""requested_at"", 7)), ""driver_months"" AS (SELECT ""m"".""month"",(SELECT MAX(""join_month"") AS ""month"" FROM ""num_drivers"" WHERE ""join_month""<=""m"".""month"") AS ""driver_join_month"" FROM ""m"") SELECT CAST(RIGHT(""dm"".""month"", 2) AS INTEGER) AS ""month"",ROUND(CASE WHEN ""nd"".""drivers_avail"">0 THEN COALESCE(""na"".""drivers_accepted"", 0)/""nd"".""drivers_avail""*100 ELSE 0 END, 2) AS ""working_percentage"" FROM (""driver_months"" AS ""dm"" LEFT JOIN ""num_drivers"" AS ""nd"" ON ""dm"".""driver_join_month""=""nd"".""join_month"") LEFT JOIN ""num_acc"" AS ""na"" ON ""dm"".""month""=""na"".""request_month"" ORDER BY ""dm"".""month"""
262,"WITH RECURSIVE ""month_tbl"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 AS ""month"" FROM ""month_tbl"" WHERE ""month""<12), ""driver_tbl"" AS (SELECT CASE WHEN EXTRACT(YEAR FROM ""join_date"")=2019 THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""month"",COUNT(""driver_id"") AS ""driver_nums"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<2021 GROUP BY 1), ""ride_tbl"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""ride_nums"" FROM ""Rides"" AS ""r"" JOIN ""AcceptedRides"" AS ""a"" ON ""r"".""ride_id""=""a"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY 1) SELECT ""m"".""month"" AS ""month"",ROUND(COALESCE((""ride_nums""/SUM(""driver_nums"") OVER (ORDER BY ""month"")), 0)*100, 2) AS ""working_percentage"" FROM (""month_tbl"" AS ""m"" LEFT JOIN ""driver_tbl"" AS ""d"" ON ""m"".""month""=""d"".""month"") LEFT JOIN ""ride_tbl"" AS ""r"" ON ""m"".""month""=""r"".""month"""
263,"WITH RECURSIVE ""months"" AS (SELECT '2020-01' AS ""month"" UNION SELECT LEFT(CONCAT(""month"", '-01') + INTERVAL '1 MONTH', 7) FROM ""months"" WHERE ""month""<'2020-12'), ""a"" AS (SELECT ""month"",SUM(""driver_cnt"") OVER (ORDER BY ""month"") AS ""driver_cnt"" FROM (SELECT LEFT(""join_date"", 7) AS ""month"",COUNT(1) AS ""driver_cnt"" FROM ""Drivers"" GROUP BY ""month"") AS ""t""), ""a_drivers"" AS (SELECT ""m"".""month"",COALESCE(MAX(""driver_cnt"") OVER (ORDER BY ""month""), 0) AS ""driver_cnt"" FROM ""months"" AS ""m"" LEFT JOIN ""a"" ON ""m"".""month""=""a"".""month""), ""ac"" AS (SELECT LEFT(""requested_at"", 7) AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""ac_driver_cnt"" FROM ""AcceptedRides"" AS ""ar"" JOIN ""Rides"" AS ""r"" ON ""ar"".""ride_id""=""r"".""ride_id"" GROUP BY ""month""), ""ac_drivers"" AS (SELECT ""m"".""month"",COALESCE(""ac_driver_cnt"", 0) AS ""ac_driver_cnt"" FROM ""months"" AS ""m"" LEFT JOIN ""ac"" ON ""m"".""month""=""ac"".""month"") SELECT CAST(RIGHT(""a_drivers"".""month"", 2) AS INTEGER) AS ""month"",ROUND(100*COALESCE(""ac_driver_cnt""/""driver_cnt"", 0), 2) AS ""working_percentage"" FROM ""a_drivers"" JOIN ""ac_drivers"" ON ""a_drivers"".""month""=""ac_drivers"".""month"" ORDER BY ""month"""
264,"WITH RECURSIVE ""cte1"" (""month"") AS (SELECT 1 AS ""month"" UNION SELECT ""month""+1 FROM ""cte1"" WHERE ""month""<12), ""cte2"" AS (SELECT CASE WHEN EXTRACT(YEAR FROM ""join_date"")<2020 THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""month"",""driver_id"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020), ""cte3"" AS (SELECT DISTINCT ""cte1"".""month"",COUNT(""driver_id"") OVER (ORDER BY ""cte1"".""month"") AS ""active_drivers"" FROM ""cte1"" LEFT JOIN ""cte2"" USING (""month"")), ""cte4"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",""driver_id"" AS ""accepting_driver"" FROM ""AcceptedRides"" JOIN ""Rides"" USING (""ride_id"") WHERE EXTRACT(YEAR FROM ""requested_at"")=2020), ""cte5"" AS (SELECT ""cte1"".""month"",COUNT(DISTINCT ""accepting_driver"") AS ""total_accepting_drivers"" FROM ""cte1"" LEFT JOIN ""cte4"" USING (""month"") GROUP BY ""cte1"".""month"") SELECT ""cte3"".""month"",CASE WHEN ""total_accepting_drivers""=0 THEN 0 ELSE ROUND((""total_accepting_drivers""/""active_drivers"")*100, 2) END AS ""working_percentage"" FROM ""cte3"" JOIN ""cte5"" USING (""month"")"
265,"WITH RECURSIVE ""months"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""months"" WHERE ""month""<12), ""available_drivers"" AS (SELECT ""months"".""month"",COALESCE(MAX(""t1"".""active_driver"") OVER (ORDER BY ""month""), 0) AS ""active_driver"" FROM ""months"" LEFT JOIN (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(""driver_id"") OVER (ORDER BY ""join_date"" ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS ""active_driver"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020) AS ""t1"" ON ""t1"".""month""=""months"".""month""), ""working_drivers"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""working_driver"" FROM ""Rides"" AS ""R"" JOIN ""AcceptedRides"" AS ""A"" ON ""R"".""ride_id""=""A"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY 1) SELECT ""months"".""month"",COALESCE(ROUND(""working_driver""/""active_driver""*100, 2), 0) AS ""working_percentage"" FROM (""months"" LEFT JOIN ""available_drivers"" ON ""available_drivers"".""month""=""months"".""month"") LEFT JOIN ""working_drivers"" ON ""working_drivers"".""month""=""months"".""month"" GROUP BY 1"
266,"WITH RECURSIVE ""active_driver"" AS (SELECT ""driver_id"",""join_date"",""join_date"" AS ""dur"" FROM ""drivers"" UNION SELECT ""driver_id"",""join_date"",""dur"" + INTERVAL '1 MONTH' AS ""dur"" FROM ""active_driver"" WHERE ""dur""<LAST_DAY(CURDATE()) + INTERVAL '1 MONTH'), ""datedim"" AS (SELECT 1 AS ""m"" UNION SELECT ""m""+1 FROM ""datedim"" WHERE ""m""<12) SELECT ""m"" AS ""month"",ROUND(COALESCE(""wd"".""working_driver"", 0)*100/COALESCE(""ad"".""monthly_ad"", 1), 2) AS ""working_percentage"" FROM (""datedim"" AS ""dd"" LEFT JOIN (SELECT EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""month"",COUNT(DISTINCT ""ar"".""driver_id"") AS ""working_driver"" FROM ""acceptedrides"" AS ""ar"" JOIN ""rides"" AS ""r"" ON ""r"".""ride_id""=""ar"".""ride_id"" WHERE EXTRACT(YEAR FROM ""r"".""requested_at"")=2020 GROUP BY EXTRACT(MONTH FROM ""r"".""requested_at"")) AS ""wd"" ON ""wd"".""month""=""dd"".""m"") LEFT JOIN (SELECT EXTRACT(MONTH FROM ""dur"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""monthly_ad"" FROM ""active_driver"" WHERE EXTRACT(YEAR FROM ""dur"")=2020 GROUP BY EXTRACT(MONTH FROM ""dur"")) AS ""ad"" ON ""ad"".""month""=""dd"".""m"""
267,"WITH RECURSIVE ""months"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""months"" WHERE ""month""<12) SELECT ""m"".""month"",ROUND(CASE WHEN COUNT(DISTINCT ""d"".""driver_id"")>0 THEN COUNT(DISTINCT ""t"".""driver_id"")*100.0/COUNT(DISTINCT ""d"".""driver_id"") ELSE 0 END, 2) AS ""working_percentage"" FROM (""months"" AS ""m"" LEFT JOIN ""Drivers"" AS ""d"" ON EXTRACT(YEAR FROM ""d"".""join_date"")<2020 OR (EXTRACT(YEAR FROM ""d"".""join_date"")=2020 AND EXTRACT(MONTH FROM ""d"".""join_date"")<=""m"".""month"")) LEFT JOIN (SELECT ""driver_id"",""requested_at"" FROM ""AcceptedRides"" AS ""a"" JOIN ""Rides"" AS ""r"" ON ""a"".""ride_id""=""r"".""ride_id"") AS ""t"" ON EXTRACT(YEAR FROM ""t"".""requested_at"")=2020 AND ""m"".""month""=EXTRACT(MONTH FROM ""t"".""requested_at"") AND ""d"".""driver_id""=""t"".""driver_id"" GROUP BY ""m"".""month"" ORDER BY ""m"".""month"""
268,"WITH ""Month"" AS (SELECT * FROM (SELECT 1 AS ""month"" UNION ALL SELECT 2 AS ""month"" UNION ALL SELECT 3 AS ""month"" UNION ALL SELECT 4 AS ""month"" UNION ALL SELECT 5 AS ""month"" UNION ALL SELECT 6 AS ""month"" UNION ALL SELECT 7 AS ""month"" UNION ALL SELECT 8 AS ""month"" UNION ALL SELECT 9 AS ""month"" UNION ALL SELECT 10 AS ""month"" UNION ALL SELECT 11 AS ""month"" UNION ALL SELECT 12 AS ""month"") AS ""A""), ""T1"" AS (SELECT EXTRACT(MONTH FROM ""R"".""requested_at"") AS ""month"",COUNT(DISTINCT ""A"".""driver_id"") AS ""accepted_num"" FROM ""AcceptedRides"" AS ""A"" JOIN ""Rides"" AS ""R"" ON ""A"".""ride_id""=""R"".""ride_id"" WHERE EXTRACT(YEAR FROM ""R"".""requested_at"")=2020 GROUP BY ""month""), ""T2"" AS (SELECT ""M"".""month"",COALESCE(MAX(""t1"".""active_driver"") OVER (ORDER BY ""M"".""month""), 0) AS ""available_num"" FROM ""Month"" AS ""M"" LEFT JOIN (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(""driver_id"") OVER (ORDER BY ""join_date"" ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS ""active_driver"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020) AS ""t1"" ON ""t1"".""month""=""M"".""month"") SELECT ""M"".""month"",COALESCE(ROUND(AVG((""T1"".""accepted_num""/""T2"".""available_num"")*100), 2), 0) AS ""working_percentage"" FROM (""Month"" AS ""M"" LEFT JOIN ""T1"" ON ""M"".""month""=""T1"".""month"") LEFT JOIN ""T2"" ON ""M"".""month""=""T2"".""month"" GROUP BY ""M"".""month"" ORDER BY ""M"".""month"""
269,"WITH RECURSIVE ""m"" AS (SELECT 1 AS ""mth"" UNION ALL SELECT ""mth""+1 AS ""mth"" FROM ""m"" WHERE ""mth""<12), ""d"" AS (SELECT ""m"".""mth"",COALESCE(""accepted_ride"", 0) AS ""accepted_ride"" FROM ""m"" LEFT JOIN (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""mth"",COUNT(DISTINCT ""driver_id"") AS ""accepted_ride"" FROM ""rides"" AS ""r"" JOIN ""AcceptedRides"" AS ""a"" ON ""r"".""ride_id""=""a"".""ride_id"" WHERE EXTRACT(YEAR FROM ""r"".""requested_at"")=2020 GROUP BY 1) AS ""a"" ON ""m"".""mth""=""a"".""mth""), ""r"" AS (SELECT ""m"".""mth"",SUM(COALESCE(""a"".""driver_cnt"", 0)) OVER (ORDER BY ""m"".""mth"") AS ""driver_cnt"" FROM ""m"" LEFT JOIN (SELECT ""a"".""mth"",SUM(""a"".""driver_cnt"") AS ""driver_cnt"" FROM (SELECT 1 AS ""mth"",COUNT(""driver_id"") AS ""driver_cnt"" FROM ""drivers"" AS ""d"" WHERE EXTRACT(YEAR FROM ""d"".""join_date"")<2020 UNION ALL SELECT EXTRACT(MONTH FROM ""join_date""),COUNT(""driver_id"") AS ""driver_cnt"" FROM ""drivers"" AS ""d"" WHERE EXTRACT(YEAR FROM ""d"".""join_date"")=2020 GROUP BY 1) AS ""a"" GROUP BY 1) AS ""a"" ON ""m"".""mth""=""a"".""mth"" GROUP BY 1 ORDER BY 1) SELECT ""r"".""mth"" AS ""month"",COALESCE(ROUND((""accepted_ride""/""driver_cnt"")*100, 2), 0) AS ""working_percentage"" FROM ""r"" JOIN ""d"" ON ""r"".""mth""=""d"".""mth"" ORDER BY 1"
270,"WITH RECURSIVE ""monthcount"" AS (SELECT 1 AS ""month"" UNION SELECT ""month""+1 AS ""month"" FROM ""monthcount"" WHERE ""month""<12) SELECT ""month"",ROUND(COALESCE(COUNT(DISTINCT ""a"".""driver_id"")/COUNT(DISTINCT ""d"".""driver_id"")*100, 0), 2) AS ""working_percentage"" FROM ((""monthcount"" AS ""m"" LEFT JOIN ""Drivers"" AS ""d"" ON (EXTRACT(YEAR FROM ""d"".""join_date"")<2020) OR (""m"".""month"">=EXTRACT(MONTH FROM ""join_date"") AND EXTRACT(YEAR FROM ""d"".""join_date"")=2020)) LEFT JOIN ""Rides"" AS ""r"" ON (""m"".""month""=EXTRACT(MONTH FROM ""r"".""requested_at"") AND EXTRACT(YEAR FROM ""r"".""requested_at"")=2020)) LEFT JOIN ""AcceptedRides"" AS ""a"" ON ""a"".""ride_id""=""r"".""ride_id"" GROUP BY 1"
271,"WITH RECURSIVE ""t"" (""Month"") AS (SELECT 1 AS ""Month"" UNION ALL SELECT ""Month""+1 FROM ""t"" WHERE ""Month""<12) SELECT ""t"".""month"",CASE WHEN COUNT(DISTINCT ""x"".""driver_id"")+0.00=0.00 OR COUNT(DISTINCT ""d"".""Driver_id"")+0.00=0.00 THEN 0.00 ELSE ROUND((COUNT(DISTINCT ""x"".""driver_id"")+0.00)*100/(COUNT(DISTINCT ""d"".""Driver_id"")+0.00), 2) END AS ""Working_percentage"" FROM (""t"" LEFT JOIN ""Drivers"" AS ""d"" ON EXTRACT(YEAR FROM ""d"".""join_date"")<2020 OR (EXTRACT(MONTH FROM ""d"".""join_Date"")<=""t"".""month"" AND EXTRACT(YEAR FROM ""d"".""JOIN_DATE"")<=2020)) LEFT JOIN (SELECT ""a"".""driver_id"",""r"".""requested_at"" FROM ""Rides"" AS ""r"" JOIN ""acceptedrides"" AS ""a"" ON ""a"".""ride_id""=""r"".""ride_id"" WHERE EXTRACT(YEAR FROM ""r"".""requested_at"")=2020) AS ""x"" ON ""t"".""Month""=EXTRACT(MONTH FROM ""x"".""requested_at"") GROUP BY ""t"".""month"" ORDER BY ""t"".""month"""
272,"WITH RECURSIVE ""cte"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""cte"" WHERE ""month""<12) SELECT ""t"".""month"",COALESCE(ROUND(CAST((SELECT COUNT(DISTINCT ""a"".""driver_id"") FROM ""acceptedrides"" AS ""a"" JOIN ""rides"" AS ""b"" ON ""a"".""ride_id""=""b"".""ride_id"" AND ""b"".""requested_at"" BETWEEN '2020-01-01' AND '2020-12-31' AND EXTRACT(MONTH FROM ""b"".""requested_at"")=""t"".""month"") AS FLOAT)*100/CAST((SELECT COUNT(DISTINCT ""driver_id"") FROM ""drivers"" WHERE ""join_date""<'2021-01-01' AND (""join_date""<'2020-01-01' OR EXTRACT(MONTH FROM ""join_date"")<=""t"".""month"")) AS FLOAT), 2), 0.00) AS ""working_percentage"" FROM ""cte"" AS ""t"""
273,"WITH ""t"" (""Month"") AS (SELECT 1 UNION ALL SELECT 2 UNION ALL SELECT 3 UNION ALL SELECT 4 UNION ALL SELECT 5 UNION ALL SELECT 6 UNION ALL SELECT 7 UNION ALL SELECT 8 UNION ALL SELECT 9 UNION ALL SELECT 10 UNION ALL SELECT 11 UNION ALL SELECT 12) SELECT ""t"".""month"",CASE WHEN COUNT(DISTINCT ""x"".""driver_id"")+0.00=0.00 OR COUNT(DISTINCT ""d"".""Driver_id"")+0.00=0.00 THEN 0.00 ELSE ROUND((COUNT(DISTINCT ""x"".""driver_id"")+0.00)*100/(COUNT(DISTINCT ""d"".""Driver_id"")+0.00), 2) END AS ""Working_percentage"" FROM (""t"" LEFT JOIN ""Drivers"" AS ""d"" ON EXTRACT(YEAR FROM ""d"".""join_date"")<2020 OR (EXTRACT(MONTH FROM ""d"".""join_Date"")<=""t"".""month"" AND EXTRACT(YEAR FROM ""d"".""JOIN_DATE"")=2020)) LEFT JOIN (SELECT ""a"".""driver_id"",""r"".""requested_at"" FROM ""Rides"" AS ""r"" JOIN ""acceptedrides"" AS ""a"" ON ""a"".""ride_id""=""r"".""ride_id"" WHERE EXTRACT(YEAR FROM ""r"".""requested_at"")=2020) AS ""x"" ON ""t"".""Month""=EXTRACT(MONTH FROM ""x"".""requested_at"") GROUP BY ""t"".""month"" ORDER BY ""t"".""month"""
274,"WITH ""t"" (""Month"") AS (SELECT 1 UNION ALL SELECT 2 UNION ALL SELECT 3 UNION ALL SELECT 4 UNION ALL SELECT 5 UNION ALL SELECT 6 UNION ALL SELECT 7 UNION ALL SELECT 8 UNION ALL SELECT 9 UNION ALL SELECT 10 UNION ALL SELECT 11 UNION ALL SELECT 12) SELECT ""t"".""month"",CASE WHEN COUNT(DISTINCT ""a"".""driver_id"")+0.00=0.00 OR COUNT(DISTINCT ""d"".""Driver_id"")+0.00=0.00 THEN 0.00 ELSE ROUND((COUNT(DISTINCT ""a"".""driver_id"")+0.00)*100/(COUNT(DISTINCT ""d"".""Driver_id"")+0.00), 2) END AS ""Working_percentage"" FROM ((""t"" LEFT JOIN ""Drivers"" AS ""d"" ON (EXTRACT(MONTH FROM ""d"".""join_Date"")<=""t"".""month"" AND EXTRACT(YEAR FROM ""d"".""JOIN_DATE"")=2020) OR EXTRACT(YEAR FROM ""d"".""join_date"")<2020) LEFT JOIN ""Rides"" AS ""r"" ON ""t"".""Month""=EXTRACT(MONTH FROM ""r"".""requested_at"") AND EXTRACT(YEAR FROM ""r"".""requested_at"")=2020) LEFT JOIN ""AcceptedRides"" AS ""a"" ON ""r"".""ride_id""=""a"".""ride_id"" GROUP BY ""t"".""month"" ORDER BY ""t"".""month"""
275,"WITH RECURSIVE ""MONTHS"" AS (SELECT 1 AS ""MONTH"" UNION SELECT ""MONTH""+1 AS ""MONTH"" FROM ""MONTHS"" WHERE ""MONTH""<12), ""ACTIVE_DRIVERS"" AS (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(""driver_id"") OVER (ORDER BY ""join_date"") AS ""active_drivers"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020), ""ACCEPTED_DRIVERS"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""DRIVER_ID"") AS ""accepted_DRIVERS"" FROM ""AcceptedRides"" JOIN ""rides"" USING (""ride_id"") WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY ""month"") SELECT DISTINCT ""M"".""MONTH"" AS ""month"",CASE WHEN COALESCE(MAX(""active_drivers"") OVER (ORDER BY ""month""), 0)=0 THEN 0 ELSE COALESCE(ROUND(100*""accepted_DRIVERS""/MAX(""active_drivers"") OVER (ORDER BY ""month""), 2), 0) END AS ""working_percentage"" FROM (""MONTHS"" AS ""M"" LEFT JOIN ""ACTIVE_DRIVERS"" AS ""AD"" ON ""M"".""MONTH""=""AD"".""MONTH"") LEFT JOIN ""ACCEPTED_DRIVERS"" AS ""AD1"" ON ""M"".""MONTH""=""AD1"".""MONTH"""
276,"WITH RECURSIVE ""t1"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 AS ""month"" FROM ""t1"" WHERE ""month""<12), ""t2"" AS (SELECT ""t1"".""month"",COUNT(""driver_id"") AS ""num_drivers_available"" FROM ""t1"" LEFT JOIN ""Drivers"" AS ""d"" ON ""d"".""join_date""<=LAST_DAY(CONCAT('2020-', ""t1"".""month"", '-1')) GROUP BY ""t1"".""month""), ""t3"" AS (SELECT EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""month"",COUNT(DISTINCT ""a"".""driver_id"") AS ""num_drivers_accepted"" FROM ""AcceptedRides"" AS ""a"" JOIN ""Rides"" AS ""r"" ON ""a"".""ride_id""=""r"".""ride_id"" WHERE ""r"".""requested_at"" BETWEEN '2020-1-1' AND '2020-12-31' GROUP BY ""month"") SELECT ""t2"".""month"",ROUND(COALESCE(""t3"".""num_drivers_accepted""/""t2"".""num_drivers_available""*100, 0), 2) AS ""working_percentage"" FROM ""t2"" LEFT JOIN ""t3"" ON ""t2"".""month""=""t3"".""month"" ORDER BY ""t2"".""month"""
277,"WITH RECURSIVE ""all_month"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""all_month"" WHERE ""month""<12), ""available_drivers"" AS (SELECT ""am"".""month"",SUM(COALESCE(""drivers_avbl"", 0)) OVER (ORDER BY ""am"".""month"") AS ""avbl_drivers"" FROM ""all_month"" AS ""am"" LEFT JOIN (SELECT (CASE WHEN EXTRACT(YEAR FROM ""join_date"")<2020 THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END) AS ""join_month"",COUNT(""join_date"") AS ""drivers_avbl"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020 GROUP BY ""join_month"") AS ""md"" ON ""am"".""month""=""md"".""join_month""), ""monthly_active_drivers"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""active_drivers"" FROM ""AcceptedRides"" AS ""ar"" JOIN ""Rides"" AS ""r"" ON ""ar"".""ride_id""=""r"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY ""month"") SELECT ""ad"".""month"",ROUND(CASE WHEN ""avbl_drivers""=0 THEN 0 ELSE (COALESCE(""active_drivers"", 0)/""avbl_drivers"")*100 END, 2) AS ""working_percentage"" FROM ""available_drivers"" AS ""ad"" LEFT JOIN ""monthly_active_drivers"" AS ""mad"" ON ""ad"".""month""=""mad"".""month"""
278,"WITH RECURSIVE ""t0"" (""m"") AS (SELECT '2020-02-01' AS ""m"" UNION ALL SELECT ""m"" + INTERVAL '1 MONTH' FROM ""t0"" WHERE ""m""<'2021-01-01'), ""t1"" AS (SELECT ""m"" - INTERVAL '1 DAY' AS ""mon"" FROM ""t0""), ""t2"" AS (SELECT ""t1"".""mon"",COUNT(""driver_id"") AS ""active_drivers"" FROM ""t1"" LEFT JOIN ""Drivers"" AS ""d"" ON ""t1"".""mon"">=""d"".""join_date"" GROUP BY 1), ""t3"" AS (SELECT ""t1"".""mon"",""driver_id"" FROM ""t1"" LEFT JOIN (SELECT ""a"".""ride_id"",""a"".""driver_id"",""r"".""requested_at"" FROM ""AcceptedRides"" AS ""a"" LEFT JOIN ""Rides"" AS ""r"" ON ""a"".""ride_id""=""r"".""ride_id"") AS ""tmp"" ON TO_CHAR(""requested_at"", 'YYYY-%m')=TO_CHAR(""t1"".""mon"", 'YYYY-%m') GROUP BY 1,2 HAVING COUNT(""ride_id"")>=1), ""t4"" AS (SELECT ""mon"",COUNT(""driver_id"") AS ""driver_one_ride"" FROM ""t3"" GROUP BY 1) SELECT EXTRACT(MONTH FROM ""t2"".""mon"") AS ""month"",ROUND(COALESCE(""driver_one_ride""/""active_drivers""*100, 0), 2) AS ""working_percentage"" FROM ""t2"" LEFT JOIN ""t4"" ON ""t2"".""mon""=""t4"".""mon"""
279,"WITH ""t"" (""Month"") AS (SELECT 1 UNION ALL SELECT 2 UNION ALL SELECT 3 UNION ALL SELECT 4 UNION ALL SELECT 5 UNION ALL SELECT 6 UNION ALL SELECT 7 UNION ALL SELECT 8 UNION ALL SELECT 9 UNION ALL SELECT 10 UNION ALL SELECT 11 UNION ALL SELECT 12) SELECT ""t"".""month"",CASE WHEN COUNT(DISTINCT ""x"".""driver_id"")+0.00=0.00 OR COUNT(DISTINCT ""d"".""Driver_id"")+0.00=0.00 THEN 0.00 ELSE ROUND((COUNT(DISTINCT ""x"".""driver_id"")+0.00)*100/(COUNT(DISTINCT ""d"".""Driver_id"")+0.00), 2) END AS ""Working_percentage"" FROM (""t"" LEFT JOIN ""Drivers"" AS ""d"" ON EXTRACT(YEAR FROM ""d"".""join_date"")<2020 OR (EXTRACT(MONTH FROM ""d"".""join_Date"")<=""t"".""month"" AND EXTRACT(YEAR FROM ""d"".""JOIN_DATE"")=2020)) LEFT JOIN (SELECT ""a"".""driver_id"",""r"".""requested_at"" FROM ""Rides"" AS ""r"" JOIN ""acceptedrides"" AS ""a"" ON ""a"".""ride_id""=""r"".""ride_id"" WHERE EXTRACT(YEAR FROM ""r"".""requested_at"")=2020) AS ""x"" ON ""t"".""Month""=EXTRACT(MONTH FROM ""x"".""requested_at"") GROUP BY ""t"".""month"" ORDER BY ""t"".""month"""
280,"WITH RECURSIVE ""cte1"" (""month"") AS (SELECT 1 AS ""month"" UNION SELECT ""month""+1 FROM ""cte1"" WHERE ""month""<12), ""cte2"" AS (SELECT CASE WHEN EXTRACT(YEAR FROM ""join_date"")<2020 THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""month"",""driver_id"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020), ""cte3"" AS (SELECT DISTINCT ""cte1"".""month"",COUNT(""driver_id"") OVER (ORDER BY ""cte1"".""month"") AS ""active_drivers"" FROM ""cte1"" LEFT JOIN ""cte2"" USING (""month"")), ""cte4"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",""driver_id"" AS ""accepting_driver"" FROM ""AcceptedRides"" JOIN ""Rides"" USING (""ride_id"") WHERE EXTRACT(YEAR FROM ""requested_at"")=2020), ""cte5"" AS (SELECT ""cte1"".""month"",COUNT(DISTINCT ""accepting_driver"") AS ""total_accepting_drivers"" FROM ""cte1"" LEFT JOIN ""cte4"" USING (""month"") GROUP BY ""cte1"".""month"") SELECT ""cte3"".""month"",CASE WHEN ""total_accepting_drivers""=0 THEN 0 ELSE ROUND((""total_accepting_drivers""/""active_drivers"")*100, 2) END AS ""working_percentage"" FROM ""cte3"" JOIN ""cte5"" USING (""month"")"
281,"WITH RECURSIVE ""months"" AS (SELECT 1 AS ""num"" UNION ALL SELECT ""num""+1 AS ""num"" FROM ""months"" WHERE ""num""<12), ""workdrivers"" AS (SELECT DISTINCT EXTRACT(MONTH FROM ""a"".""requested_at"") AS ""work_month"",""b"".""driver_id"" FROM ""Rides"" AS ""a"" RIGHT JOIN ""AcceptedRides"" AS ""b"" USING (""ride_id"") WHERE EXTRACT(YEAR FROM ""a"".""requested_at"")=2020), ""availdrivers"" AS (SELECT ""x"".""num"" AS ""av_month"",SUM(""m"".""work_drivers"") OVER (ORDER BY ""x"".""num"") AS ""av_drivers"" FROM (SELECT CASE WHEN EXTRACT(YEAR FROM ""join_date"")<2020 THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""av_month"",COUNT(DISTINCT ""driver_id"") AS ""work_drivers"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020 GROUP BY 1) AS ""m"" RIGHT JOIN ""months"" AS ""x"" ON ""x"".""num""=""m"".""av_month"" GROUP BY 1) SELECT ""x"".""num"" AS ""month"",ROUND(COALESCE(COALESCE(""y"".""work_drivers"", 0)/COALESCE(""z"".""av_drivers"", 0)*100, 0), 2) AS ""working_percentage"" FROM (""months"" AS ""x"" LEFT JOIN (SELECT ""work_month"",COUNT(""driver_id"") AS ""work_drivers"" FROM ""workdrivers"" GROUP BY 1) AS ""y"" ON ""x"".""num""=""y"".""work_month"") LEFT JOIN ""availdrivers"" AS ""z"" ON ""x"".""num""=""z"".""av_month"" ORDER BY 1"
282,"WITH RECURSIVE ""a"" AS (SELECT 1 AS ""m"" UNION ALL SELECT ""m""+1 FROM ""a"" WHERE ""m""<12), ""b"" AS (SELECT ""driver_id"",CASE WHEN ""join_date""<'2020-01-01' THEN 0 ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""m"" FROM ""Drivers"" WHERE ""join_date""<'2021-01-01'), ""c"" AS (SELECT ""m"",COUNT(""driver_id"") AS ""s"" FROM ""b"" WHERE ""m""=0 UNION SELECT ""m"",COUNT(""driver_id"") AS ""s"" FROM ""b"" GROUP BY ""m""), ""z"" AS (SELECT 0 AS ""m"" UNION ALL SELECT ""m""+1 FROM ""z"" WHERE ""m""<12), ""d"" AS (SELECT ""z"".""m"",SUM(COALESCE(""s"", 0)) OVER (ORDER BY ""m"") AS ""s"" FROM ""c"" RIGHT JOIN ""z"" ON ""c"".""m""=""z"".""m""), ""e"" AS (SELECT COUNT(DISTINCT ""ac"".""driver_id"") AS ""ri"",EXTRACT(MONTH FROM ""requested_at"") AS ""m"" FROM ""Rides"" AS ""r"" JOIN ""AcceptedRides"" AS ""ac"" ON ""r"".""ride_id""=""ac"".""ride_id"" WHERE ""r"".""requested_at"" BETWEEN '2020-01-01' AND '2020-12-31' GROUP BY EXTRACT(MONTH FROM ""requested_at"")), ""f"" AS (SELECT ""a"".""m"",COALESCE(""ri"", 0) AS ""ri"" FROM ""e"" RIGHT JOIN ""a"" ON ""e"".""m""=""a"".""m"") SELECT ""f"".""m"" AS ""month"",COALESCE(ROUND(100*""f"".""ri""/""d"".""s"", 2), 0.00) AS ""working_percentage"" FROM ""f"" JOIN ""d"" ON ""f"".""m""=""d"".""m"" ORDER BY ""f"".""m"""
283,"WITH RECURSIVE ""months"" AS (SELECT 1 AS ""month"",2020 AS ""year"" UNION ALL SELECT ""m"".""month""+1 AS ""month"",""m"".""year"" FROM ""months"" AS ""m"" WHERE ""m"".""month""+1<=12), ""active_drivers"" AS (SELECT ""m1"".""month"",COUNT(""d"".""driver_id"") AS ""active_drives_count"" FROM ""months"" AS ""m1"" LEFT JOIN ""Drivers"" AS ""d"" ON EXTRACT(YEAR FROM ""d"".""join_date"")<""m1"".""year"" OR (EXTRACT(YEAR FROM ""d"".""join_date"")=""m1"".""year"" AND EXTRACT(MONTH FROM ""d"".""join_date"")<=""m1"".""month"") GROUP BY ""m1"".""month""), ""active_accepted_drivers_table"" AS (SELECT ""m1"".""month"",COUNT(DISTINCT ""t"".""driver_id"") AS ""active_accepted_driver"" FROM ""months"" AS ""m1"" LEFT JOIN (SELECT ""a"".""ride_id"",""a"".""driver_id"",""r"".""requested_at"" FROM ""AcceptedRides"" AS ""a"" JOIN ""Rides"" AS ""r"" ON ""a"".""ride_id""=""r"".""ride_id"") AS ""t"" ON EXTRACT(YEAR FROM ""t"".""requested_at"")=""m1"".""year"" AND EXTRACT(MONTH FROM ""t"".""requested_at"")=""m1"".""month"" GROUP BY ""m1"".""month"") SELECT ""a1"".""month"",ROUND(CASE WHEN ""a1"".""active_drives_count""=0 THEN 0 ELSE ""a2"".""active_accepted_driver""/""a1"".""active_drives_count"" END*100, 2) AS ""working_percentage"" FROM ""active_drivers"" AS ""a1"" LEFT JOIN ""active_accepted_drivers_table"" AS ""a2"" ON ""a1"".""month""=""a2"".""month"" ORDER BY ""month"""
284,"WITH RECURSIVE ""T1"" AS (SELECT 1 AS ""join_month"" UNION SELECT ""join_month""+1 FROM ""T1"" WHERE ""join_month""<12), ""T2"" AS (SELECT CASE WHEN EXTRACT(YEAR FROM ""join_date"")<'2020' THEN '1' ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""join_month"",COUNT(""driver_id"") AS ""driver_num"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<='2020' GROUP BY ""join_month""), ""T3"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""join_month"",COUNT(DISTINCT ""ar"".""driver_id"") AS ""ride_num"" FROM ""AcceptedRides"" AS ""ar"" LEFT JOIN ""Rides"" AS ""r"" ON ""ar"".""ride_id""=""r"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")='2020' GROUP BY ""join_month"") SELECT ""T1"".""join_month"" AS ""month"",ROUND(100*COALESCE(""T3"".""ride_num""/SUM(""T2"".""driver_num""), 0), 2) AS ""working_percentage"" FROM (""T1"" LEFT JOIN ""T2"" ON ""T1"".""join_month"">=""T2"".""join_month"") LEFT JOIN ""T3"" ON ""T1"".""join_month""=""T3"".""join_month"" GROUP BY ""T1"".""join_month"" ORDER BY ""T1"".""join_month"""
285,"WITH RECURSIVE ""m"" AS (SELECT 1 AS ""month"" UNION SELECT ""month""+1 FROM ""m"" WHERE ""month""<12), ""a"" AS (SELECT ""m"".""month"",COALESCE(MAX(""total_driver"") OVER (ORDER BY ""month""), 0) AS ""total_driver"" FROM ""m"" LEFT JOIN (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(""driver_id"") OVER (ORDER BY ""join_date"" ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS ""total_driver"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020) AS ""t1"" USING (""month"")), ""b"" AS (SELECT COUNT(DISTINCT ""driver_id"") AS ""accepted_driver"",EXTRACT(MONTH FROM ""requested_at"") AS ""month"" FROM ""acceptedrides"" AS ""a"" JOIN ""rides"" AS ""r"" USING (""ride_id"") WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY 2) SELECT ""m"".""month"",ROUND(COALESCE((""accepted_driver""/""total_driver""), 0)*100, 2) AS ""working_percentage"" FROM (""m"" LEFT JOIN ""a"" USING (""month"")) LEFT JOIN ""b"" USING (""month"") GROUP BY 1"
286,"WITH ""t"" (""Month"") AS (SELECT 1 UNION ALL SELECT 2 UNION ALL SELECT 3 UNION ALL SELECT 4 UNION ALL SELECT 5 UNION ALL SELECT 6 UNION ALL SELECT 7 UNION ALL SELECT 8 UNION ALL SELECT 9 UNION ALL SELECT 10 UNION ALL SELECT 11 UNION ALL SELECT 12) SELECT ""t"".""month"",CASE WHEN COUNT(DISTINCT ""a"".""driver_id"")+0.00=0.00 OR COUNT(DISTINCT ""d"".""Driver_id"")+0.00=0.00 THEN 0.00 ELSE ROUND((COUNT(DISTINCT ""a"".""driver_id"")+0.00)*100/(COUNT(DISTINCT ""d"".""Driver_id"")+0.00), 2) END AS ""Working_percentage"" FROM ((""t"" LEFT JOIN ""Drivers"" AS ""d"" ON (EXTRACT(MONTH FROM ""d"".""join_Date"")<=""t"".""month"" AND EXTRACT(YEAR FROM ""d"".""JOIN_DATE"")=2020) OR EXTRACT(YEAR FROM ""d"".""join_date"")<2020) LEFT JOIN ""Rides"" AS ""r"" ON ""t"".""Month""=EXTRACT(MONTH FROM ""r"".""requested_at"") AND EXTRACT(YEAR FROM ""r"".""requested_at"")=2020) LEFT JOIN ""AcceptedRides"" AS ""a"" ON ""r"".""ride_id""=""a"".""ride_id"" GROUP BY ""t"".""month"" ORDER BY ""t"".""month"""
287,"WITH RECURSIVE ""s"" (""month"") AS (SELECT 1 UNION ALL SELECT ""month""+1 FROM ""s"" WHERE ""month""<12), ""c1"" AS (SELECT ""month"",""driver_id"",""cum_sum"" FROM (SELECT ""join_date"",EXTRACT(MONTH FROM ""join_date"") AS ""month"",""driver_id"",ROW_NUMBER() OVER (ORDER BY ""join_date"") AS ""cum_sum"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<'2021') AS ""a"" WHERE EXTRACT(YEAR FROM ""a"".""join_date"")='2020'), ""c2"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""num_rides"" FROM ""rides"" JOIN ""acceptedrides"" AS ""r"" USING (""ride_id"") WHERE EXTRACT(YEAR FROM ""requested_at"")='2020' AND ""ride_id"" IN (SELECT ""ride_id"" FROM ""acceptedrides"") GROUP BY 1) SELECT ""s"".""month"",ROUND(COALESCE(""num_rides""/MAX(""cum_sum""), 0)*100, 2) AS ""working_percentage"" FROM (""c1"" RIGHT JOIN ""s"" ON ""s"".""month"">=""c1"".""month"") LEFT JOIN ""c2"" ON ""s"".""month""=""c2"".""month"" GROUP BY 1"
288,"WITH ""Canlendar"" AS (SELECT 1 AS ""month"" UNION SELECT 2 AS ""month"" UNION SELECT 3 AS ""month"" UNION SELECT 4 AS ""month"" UNION SELECT 5 AS ""month"" UNION SELECT 1 AS ""month"" UNION SELECT 6 AS ""month"" UNION SELECT 7 AS ""month"" UNION SELECT 8 AS ""month"" UNION SELECT 9 AS ""month"" UNION SELECT 10 AS ""month"" UNION SELECT 11 AS ""month"" UNION SELECT 12 AS ""month""), ""Temp"" AS (SELECT EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""month"",COUNT(""ar"".""ride_id"") AS ""accepted_rides"" FROM (""AcceptedRides"" AS ""ar"" LEFT JOIN ""Drivers"" AS ""d"" ON ""d"".""driver_id""=""ar"".""driver_id"") LEFT JOIN ""Rides"" AS ""r"" ON ""r"".""ride_id""=""ar"".""ride_id"" WHERE EXTRACT(YEAR FROM ""r"".""requested_at"")=2020 GROUP BY EXTRACT(MONTH FROM ""r"".""requested_at"")), ""T_available_driver"" AS (SELECT ""c"".""month"",COUNT(""d"".""driver_id"") AS ""available_drivers"" FROM (""Canlendar"" AS ""c"" LEFT JOIN ""Temp"" AS ""t"" ON ""t"".""month""=""c"".""month"") LEFT JOIN ""Drivers"" AS ""d"" ON EXTRACT(YEAR FROM ""d"".""join_date"")<2020 OR (EXTRACT(YEAR FROM ""d"".""join_date"")=2020 AND EXTRACT(MONTH FROM ""d"".""join_date"")<=""c"".""month"") GROUP BY ""c"".""month"" ORDER BY ""c"".""month""), ""T_active_driver"" AS (SELECT EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""month"",COUNT(DISTINCT (""a"".""driver_id"")) AS ""active_drivers"" FROM ""AcceptedRides"" AS ""a"" LEFT JOIN ""Rides"" AS ""r"" ON ""a"".""ride_id""=""r"".""ride_id"" WHERE EXTRACT(YEAR FROM ""r"".""requested_at"")=2020 GROUP BY EXTRACT(MONTH FROM ""r"".""requested_at"")) SELECT ""t_ava"".""month"",(CASE WHEN ""t_act"".""active_drivers"" IS NULL THEN 0 ELSE ROUND((""t_act"".""active_drivers""/""t_ava"".""available_drivers"")*100, 2) END) AS ""working_percentage"" FROM ""T_available_driver"" AS ""t_ava"" LEFT JOIN ""T_active_driver"" AS ""t_act"" ON ""t_act"".""month""=""t_ava"".""month"" ORDER BY ""t_ava"".""month"""
289,"WITH RECURSIVE ""monthtable"" AS (SELECT 1 AS ""month"",2020 AS ""year"" UNION ALL SELECT ""month""+1 AS ""month"",""year"" FROM ""monthtable"" WHERE ""month""<12), ""drivertable"" AS (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",EXTRACT(YEAR FROM ""join_date"") AS ""year"",COUNT(""driver_id"") OVER (ORDER BY ""join_date"") AS ""active_driver"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020), ""ridetable"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",""a"".""driver_id"" FROM ""rides"" AS ""r"" JOIN ""AcceptedRides"" AS ""a"" USING (""ride_id"") WHERE EXTRACT(YEAR FROM ""requested_at"")=2020) SELECT DISTINCT ""m"".""month"",COALESCE(ROUND(COUNT(DISTINCT ""r"".""driver_id"")/""m"".""numdrivers""*100, 2), 0) AS ""working_percentage"" FROM (SELECT ""m"".""month"",COALESCE(MAX(""d"".""active_driver"") OVER (ORDER BY ""m"".""month""), 0) AS ""numdrivers"" FROM ""monthtable"" AS ""m"" LEFT JOIN ""drivertable"" AS ""d"" USING (""month"")) AS ""m"" LEFT JOIN ""ridetable"" AS ""r"" USING (""month"") GROUP BY ""m"".""month"" ORDER BY ""m"".""month"""
290,"WITH RECURSIVE ""monthtable"" (""month"") AS (SELECT 1 UNION ALL SELECT ""month""+1 FROM ""monthtable"" WHERE ""month""<12), ""drivertable"" AS (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(""driver_id"") OVER (ORDER BY ""join_date"") AS ""num_drivers"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020), ""ridetable"" AS (SELECT ""a"".""ride_id"",""a"".""driver_id"",""r"".""user_id"",EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""month"" FROM ""AcceptedRides"" AS ""a"" JOIN ""Rides"" AS ""r"" USING (""ride_id"") WHERE EXTRACT(YEAR FROM ""requested_at"")=2020) SELECT DISTINCT ""m"".""month"",COALESCE(ROUND(COUNT(DISTINCT ""r"".""driver_id"")/""d"".""availabledrivers""*100, 2), 0) AS ""working_percentage"" FROM (""monthtable"" AS ""m"" LEFT JOIN ""ridetable"" AS ""r"" USING (""month"")) LEFT JOIN (SELECT ""m"".""month"",COALESCE(MAX(""d"".""num_drivers"") OVER (ORDER BY ""m"".""month""), 0) AS ""availabledrivers"" FROM ""monthtable"" AS ""m"" LEFT JOIN ""drivertable"" AS ""d"" USING (""month"")) AS ""d"" USING (""month"") GROUP BY ""m"".""month"" ORDER BY ""m"".""month"""
291,"WITH RECURSIVE ""cte_month_spine"" AS (SELECT 1 AS ""n"" UNION ALL SELECT ""n""+1 AS ""n"" FROM ""cte_month_spine"" WHERE ""n""<12), ""cte_available_drivers"" AS (SELECT ""ms"".""n"" AS ""month"",COUNT(""driver_id"") AS ""available_drivers"" FROM ""cte_month_spine"" AS ""ms"" LEFT JOIN ""Drivers"" AS ""d"" ON LAST_DAY(CONCAT('2020-', ""ms"".""n"", '-01'))>=""d"".""join_date"" GROUP BY 1), ""cte_working_drivers"" AS (SELECT ""ms"".""n"" AS ""month"",COUNT(DISTINCT ""ar"".""driver_id"") AS ""working_drivers"" FROM (""cte_month_spine"" AS ""ms"" LEFT JOIN ""Rides"" AS ""r"" ON ""r"".""requested_at"" BETWEEN CONCAT('2020-', ""ms"".""n"", '-01') AND LAST_DAY(CONCAT('2020-', ""ms"".""n"", '-01'))) LEFT JOIN ""AcceptedRides"" AS ""ar"" ON ""r"".""ride_id""=""ar"".""ride_id"" GROUP BY 1), ""cte_final"" AS (SELECT ""ad"".""month"",ROUND(100*COALESCE(""working_drivers""/""available_drivers"", 0), 2) AS ""working_percentage"" FROM ""cte_available_drivers"" AS ""ad"" JOIN ""cte_working_drivers"" AS ""wd"" ON ""ad"".""month""=""wd"".""month"" ORDER BY 1) SELECT * FROM ""cte_final"""
292,"WITH RECURSIVE ""T1"" AS (SELECT 1 AS ""join_month"" UNION SELECT ""join_month""+1 FROM ""T1"" WHERE ""join_month""<12), ""T2"" AS (SELECT CASE WHEN EXTRACT(YEAR FROM ""join_date"")<'2020' THEN '1' ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""join_month"",COUNT(""driver_id"") AS ""driver_num"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<='2020' GROUP BY ""join_month""), ""T3"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""join_month"",COUNT(DISTINCT ""ar"".""driver_id"") AS ""ride_num"" FROM ""AcceptedRides"" AS ""ar"" LEFT JOIN ""Rides"" AS ""r"" ON ""ar"".""ride_id""=""r"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")='2020' GROUP BY ""join_month"") SELECT ""T1"".""join_month"" AS ""month"",ROUND(100*COALESCE(""T3"".""ride_num""/SUM(""T2"".""driver_num""), 0), 2) AS ""working_percentage"" FROM (""T1"" LEFT JOIN ""T2"" ON ""T1"".""join_month"">=""T2"".""join_month"") LEFT JOIN ""T3"" ON ""T1"".""join_month""=""T3"".""join_month"" GROUP BY ""T1"".""join_month"" ORDER BY ""T1"".""join_month"""
293,"WITH RECURSIVE ""months"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""months"" WHERE ""month""<12), ""available_drivers"" AS (SELECT ""months"".""month"",COALESCE(MAX(""t1"".""active_driver"") OVER (ORDER BY ""month""), 0) AS ""active_driver"" FROM ""months"" LEFT JOIN (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(""driver_id"") OVER (ORDER BY ""join_date"" ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS ""active_driver"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020) AS ""t1"" ON ""t1"".""month""=""months"".""month""), ""working_drivers"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""working_driver"" FROM ""Rides"" AS ""R"" JOIN ""AcceptedRides"" AS ""A"" ON ""R"".""ride_id""=""A"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY 1) SELECT DISTINCT ""ad"".""month"",COALESCE(ROUND(""working_driver""/""active_driver""*100, 2), 0) AS ""working_percentage"" FROM ""available_drivers"" AS ""ad"" LEFT JOIN ""working_drivers"" AS ""wd"" ON ""wd"".""month""=""ad"".""month"""
294,"SELECT ""t1"".""month"",ROUND(COALESCE(""t2"".""active_drivers""*100/""t1"".""available_drivers"", 0), 2) AS ""working_percentage"" FROM (SELECT ""m"".""month"",COUNT(""d"".""driver_id"") AS ""available_drivers"" FROM ((SELECT 1 AS ""month"") UNION (SELECT 2 AS ""month"") UNION (SELECT 3 AS ""month"") UNION (SELECT 4 AS ""month"") UNION (SELECT 5 AS ""month"") UNION (SELECT 6 AS ""month"") UNION (SELECT 7 AS ""month"") UNION (SELECT 8 AS ""month"") UNION (SELECT 9 AS ""month"") UNION (SELECT 10 AS ""month"") UNION (SELECT 11 AS ""month"") UNION (SELECT 12 AS ""month"")) AS ""m"" LEFT JOIN ""drivers"" AS ""d"" ON ""d"".""join_date""<=LAST_DAY(CONCAT('2020-', ""m"".""month"", '-1')) GROUP BY ""m"".""month"") AS ""t1"" LEFT JOIN (SELECT EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""active_drivers"" FROM ""rides"" AS ""r"" JOIN ""acceptedrides"" AS ""ar"" ON ""r"".""ride_id""=""ar"".""ride_id"" AND EXTRACT(YEAR FROM ""r"".""requested_at"")=2020 GROUP BY EXTRACT(MONTH FROM ""r"".""requested_at"")) AS ""t2"" ON ""t1"".""month""=""t2"".""month"" ORDER BY ""t1"".""month"""
295,"WITH RECURSIVE ""cte1"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 AS ""month"" FROM ""cte1"" WHERE ""month""<12), ""d1"" AS (SELECT ""driver_id"",(CASE WHEN EXTRACT(YEAR FROM ""join_date"")<2020 THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END) AS ""join_month"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<2021), ""c1"" AS (SELECT ""cte1"".""month"",COUNT(DISTINCT ""driver_id"") AS ""active_drivers"" FROM ""cte1"" LEFT JOIN ""d1"" ON ""month"">=""join_month"" GROUP BY 1), ""c2"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""accepted_rides"" FROM ""rides"" JOIN ""acceptedrides"" USING (""ride_id"") WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY 1) SELECT ""month"",ROUND(CASE WHEN ""active_drivers""=0 THEN 0 ELSE 100*COALESCE(""accepted_rides"", 0)/""active_drivers"" END, 2) AS ""working_percentage"" FROM ""c1"" LEFT JOIN ""c2"" USING (""month"") ORDER BY 1"
296,"WITH ""t"" (""Month"") AS (SELECT 1 UNION ALL SELECT 2 UNION ALL SELECT 3 UNION ALL SELECT 4 UNION ALL SELECT 5 UNION ALL SELECT 6 UNION ALL SELECT 7 UNION ALL SELECT 8 UNION ALL SELECT 9 UNION ALL SELECT 10 UNION ALL SELECT 11 UNION ALL SELECT 12) SELECT ""t"".""month"",CASE WHEN COUNT(DISTINCT ""a"".""driver_id"")+0.00=0.00 OR COUNT(DISTINCT ""d"".""Driver_id"")+0.00=0.00 THEN 0.00 ELSE ROUND((COUNT(DISTINCT ""a"".""driver_id"")+0.00)*100/(COUNT(DISTINCT ""d"".""Driver_id"")+0.00), 2) END AS ""Working_percentage"" FROM ((""t"" LEFT JOIN ""Drivers"" AS ""d"" ON (EXTRACT(MONTH FROM ""d"".""join_Date"")<=""t"".""month"" AND EXTRACT(YEAR FROM ""d"".""JOIN_DATE"")=2020) OR EXTRACT(YEAR FROM ""d"".""join_date"")<2020) LEFT JOIN ""Rides"" AS ""r"" ON ""t"".""Month""=EXTRACT(MONTH FROM ""r"".""requested_at"") AND EXTRACT(YEAR FROM ""r"".""requested_at"")=2020) LEFT JOIN ""AcceptedRides"" AS ""a"" ON ""r"".""ride_id""=""a"".""ride_id"" GROUP BY ""t"".""month"" ORDER BY ""t"".""month"""
297,"WITH RECURSIVE ""r"" AS (SELECT 1 AS ""month"" UNION SELECT 1+""month"" FROM ""r"" WHERE ""month""<12), ""a"" AS (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(1) OVER (ORDER BY ""join_date"") AS ""active_drivers"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<='2020'), ""b"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""accepted_drivers"" FROM ""rides"" JOIN ""acceptedrides"" USING (""ride_id"") WHERE EXTRACT(YEAR FROM ""requested_at"")='2020' GROUP BY 1) SELECT DISTINCT ""r"".""month"",COALESCE(ROUND(""accepted_drivers""/MAX(""active_drivers"") OVER (ORDER BY ""month"")*100, 2), 0) AS ""working_percentage"" FROM (""r"" LEFT JOIN ""a"" USING (""month"")) LEFT JOIN ""b"" USING (""month"")"
298,"WITH RECURSIVE ""tmp"" AS (SELECT 1 AS ""month"" UNION SELECT ""month""+1 FROM ""tmp"" WHERE ""month""<12), ""tmp2"" AS (SELECT * FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")=2020), ""tmp3"" AS (SELECT ""month"",SUM(COUNT(""join_date"")) OVER (ORDER BY ""month"")+(SELECT COUNT(1) FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<2020) AS ""total_drivers"" FROM ""tmp"" LEFT JOIN ""tmp2"" ON ""month""=EXTRACT(MONTH FROM ""join_date"") GROUP BY 1), ""tmp4"" AS (SELECT ""driver_id"",""requested_at"" FROM ""rides"" NATURAL JOIN ""acceptedrides"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020), ""tmp5"" AS (SELECT ""month"",COUNT(DISTINCT ""driver_id"") AS ""active_drivers"" FROM ""tmp"" LEFT JOIN ""tmp4"" ON ""month""=EXTRACT(MONTH FROM ""requested_at"") GROUP BY 1) SELECT ""month"",COALESCE(ROUND(""active_drivers""/""total_drivers""*100, 2), 0) AS ""working_percentage"" FROM ""tmp3"" NATURAL JOIN ""tmp5"" ORDER BY 1"
299,"WITH RECURSIVE ""DATE_TAB"" AS (SELECT '202001' AS ""MON_YY"",1 AS ""MON_ID"" UNION ALL SELECT ""MON_YY""+1,""MON_ID""+1 FROM ""DATE_TAB"" WHERE ""MON_ID""<12), ""TRIP_CNT"" AS (SELECT TO_CHAR(""REQUESTED_AT"", 'YYYY%m') AS ""REQ_MON_YY"",COUNT(DISTINCT ""D"".""DRIVER_ID"") AS ""DRIVER_CNT"",COUNT(DISTINCT ""A"".""DRIVER_ID"") AS ""TRIP_CNT"" FROM (""ACCEPTEDRIDES"" AS ""A"" JOIN ""RIDES"" AS ""R"" ON ""A"".""RIDE_ID""=""R"".""RIDE_ID"") JOIN ""DRIVERS"" AS ""D"" ON TO_CHAR(""R"".""REQUESTED_AT"", 'YYYY%m')>=TO_CHAR(""D"".""JOIN_DATE"", 'YYYY%m') WHERE ""R"".""REQUESTED_AT""<='2020-12-31' AND ""R"".""REQUESTED_AT"">='2020-01-01' GROUP BY 1) SELECT ""DT"".""MON_ID"" AS ""month"",COALESCE(ROUND((""TC"".""TRIP_CNT""/""TC"".""DRIVER_CNT"")*100, 2), 0.00) AS ""working_percentage"" FROM ""DATE_TAB"" AS ""DT"" LEFT JOIN ""TRIP_CNT"" AS ""TC"" ON ""DT"".""MON_YY""=""TC"".""REQ_MON_YY"""
300,"WITH RECURSIVE ""months"" AS (SELECT 1 AS ""month"",2020 AS ""year"" UNION ALL SELECT ""m"".""month""+1 AS ""month"",""m"".""year"" FROM ""months"" AS ""m"" WHERE ""m"".""month""+1<=12), ""active_drivers"" AS (SELECT ""m1"".""month"",COUNT(""d"".""driver_id"") AS ""active_drives_count"" FROM ""months"" AS ""m1"" LEFT JOIN ""Drivers"" AS ""d"" ON EXTRACT(YEAR FROM ""d"".""join_date"")<""m1"".""year"" OR (EXTRACT(YEAR FROM ""d"".""join_date"")=""m1"".""year"" AND EXTRACT(MONTH FROM ""d"".""join_date"")<=""m1"".""month"") GROUP BY ""m1"".""month""), ""active_accepted_drivers_table"" AS (SELECT ""m1"".""month"",COUNT(DISTINCT ""t"".""driver_id"") AS ""active_accepted_driver"" FROM ""months"" AS ""m1"" LEFT JOIN (SELECT ""a"".""ride_id"",""a"".""driver_id"",""r"".""requested_at"" FROM ""AcceptedRides"" AS ""a"" JOIN ""Rides"" AS ""r"" ON ""a"".""ride_id""=""r"".""ride_id"") AS ""t"" ON EXTRACT(YEAR FROM ""t"".""requested_at"")=""m1"".""year"" AND EXTRACT(MONTH FROM ""t"".""requested_at"")=""m1"".""month"" GROUP BY ""m1"".""month"") SELECT ""a1"".""month"",ROUND(CASE WHEN ""a1"".""active_drives_count""=0 THEN 0 ELSE ""a2"".""active_accepted_driver""/""a1"".""active_drives_count"" END*100, 2) AS ""working_percentage"" FROM ""active_drivers"" AS ""a1"" LEFT JOIN ""active_accepted_drivers_table"" AS ""a2"" ON ""a1"".""month""=""a2"".""month"" ORDER BY ""month"""
301,"WITH ""t"" (""Month"") AS (SELECT 1 UNION ALL SELECT 2 UNION ALL SELECT 3 UNION ALL SELECT 4 UNION ALL SELECT 5 UNION ALL SELECT 6 UNION ALL SELECT 7 UNION ALL SELECT 8 UNION ALL SELECT 9 UNION ALL SELECT 10 UNION ALL SELECT 11 UNION ALL SELECT 12) SELECT ""t"".""month"",CASE WHEN COUNT(DISTINCT ""x"".""driver_id"")+0.00=0.00 OR COUNT(DISTINCT ""d"".""Driver_id"")+0.00=0.00 THEN 0.00 ELSE ROUND((COUNT(DISTINCT ""x"".""driver_id"")+0.00)*100/(COUNT(DISTINCT ""d"".""Driver_id"")+0.00), 2) END AS ""Working_percentage"" FROM (""t"" LEFT JOIN ""Drivers"" AS ""d"" ON (EXTRACT(MONTH FROM ""d"".""join_Date"")<=""t"".""month"" AND EXTRACT(YEAR FROM ""d"".""JOIN_DATE"")=2020) OR EXTRACT(YEAR FROM ""d"".""join_date"")<2020) LEFT JOIN (SELECT ""a"".""driver_id"",""r"".""requested_at"" FROM ""Rides"" AS ""r"" JOIN ""acceptedrides"" AS ""a"" ON ""a"".""ride_id""=""r"".""ride_id"" WHERE EXTRACT(YEAR FROM ""r"".""requested_at"")=2020) AS ""x"" ON ""t"".""Month""=EXTRACT(MONTH FROM ""x"".""requested_at"") GROUP BY ""t"".""month"" ORDER BY ""t"".""month"""
302,"WITH ""DATE_TAB"" AS (SELECT '202001' AS ""MON_YY"",1 AS ""MON_ID"" UNION ALL SELECT '202002' AS ""MON_YY"",2 AS ""MON_ID"" UNION ALL SELECT '202003' AS ""MON_YY"",3 AS ""MON_ID"" UNION ALL SELECT '202004' AS ""MON_YY"",4 AS ""MON_ID"" UNION ALL SELECT '202005' AS ""MON_YY"",5 AS ""MON_ID"" UNION ALL SELECT '202006' AS ""MON_YY"",6 AS ""MON_ID"" UNION ALL SELECT '202007' AS ""MON_YY"",7 AS ""MON_ID"" UNION ALL SELECT '202008' AS ""MON_YY"",8 AS ""MON_ID"" UNION ALL SELECT '202009' AS ""MON_YY"",9 AS ""MON_ID"" UNION ALL SELECT '202010' AS ""MON_YY"",10 AS ""MON_ID"" UNION ALL SELECT '202011' AS ""MON_YY"",11 AS ""MON_ID"" UNION ALL SELECT '202012' AS ""MON_YY"",12 AS ""MON_ID""), ""TRIP_CNT"" AS (SELECT TO_CHAR(""REQUESTED_AT"", 'YYYY%m') AS ""REQ_MON_YY"",COUNT(DISTINCT ""D"".""DRIVER_ID"") AS ""DRIVER_CNT"",COUNT(DISTINCT ""A"".""DRIVER_ID"") AS ""TRIP_CNT"" FROM (""ACCEPTEDRIDES"" AS ""A"" JOIN ""RIDES"" AS ""R"" ON ""A"".""RIDE_ID""=""R"".""RIDE_ID"") JOIN ""DRIVERS"" AS ""D"" ON TO_CHAR(""R"".""REQUESTED_AT"", 'YYYY%m')>=TO_CHAR(""D"".""JOIN_DATE"", 'YYYY%m') WHERE ""R"".""REQUESTED_AT""<='2020-12-31' AND ""R"".""REQUESTED_AT"">='2020-01-01' GROUP BY 1) SELECT ""DT"".""MON_ID"" AS ""month"",COALESCE(ROUND((""TC"".""TRIP_CNT""/""TC"".""DRIVER_CNT"")*100, 2), 0.00) AS ""working_percentage"" FROM ""DATE_TAB"" AS ""DT"" LEFT JOIN ""TRIP_CNT"" AS ""TC"" ON ""DT"".""MON_YY""=""TC"".""REQ_MON_YY"""
303,"WITH RECURSIVE ""s"" (""month"") AS (SELECT 1 UNION ALL SELECT ""month""+1 FROM ""s"" WHERE ""month""<12), ""c1"" AS (SELECT ""month"",""driver_id"",""cum_sum"" FROM (SELECT ""join_date"",EXTRACT(MONTH FROM ""join_date"") AS ""month"",""driver_id"",ROW_NUMBER() OVER (ORDER BY ""join_date"") AS ""cum_sum"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<'2021') AS ""a"" WHERE EXTRACT(YEAR FROM ""a"".""join_date"")='2020'), ""c2"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""num_rides"" FROM ""rides"" JOIN ""acceptedrides"" AS ""r"" USING (""ride_id"") WHERE EXTRACT(YEAR FROM ""requested_at"")='2020' AND ""ride_id"" IN (SELECT ""ride_id"" FROM ""acceptedrides"") GROUP BY 1) SELECT ""s"".""month"",ROUND(COALESCE(""num_rides""/MAX(""cum_sum""), 0)*100, 2) AS ""working_percentage"" FROM (""c1"" RIGHT JOIN ""s"" ON ""s"".""month"">=""c1"".""month"") LEFT JOIN ""c2"" ON ""s"".""month""=""c2"".""month"" GROUP BY 1"
304,"WITH RECURSIVE ""months"" (""month"") AS (SELECT 1 UNION ALL SELECT ""month""+1 FROM ""months"" WHERE ""month""<12), ""t1"" AS (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(""driver_id"") OVER (ORDER BY ""join_date"") AS ""driver_count"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020), ""t2"" AS (SELECT EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""month"",COUNT(DISTINCT ""a"".""driver_id"") AS ""active_driver"" FROM ""Rides"" AS ""r"" JOIN ""AcceptedRides"" AS ""a"" ON ""r"".""ride_id""=""a"".""ride_id"" WHERE EXTRACT(YEAR FROM ""r"".""requested_at"")=2020 GROUP BY EXTRACT(MONTH FROM ""r"".""requested_at"")) SELECT ""a"".""month"",ROUND(COALESCE(""a"".""act_cnt""/""a"".""tot_cnt""*100, 0), 2) AS ""working_percentage"" FROM (SELECT DISTINCT ""m"".""month"",COALESCE(MAX(""t1"".""driver_count"") OVER (ORDER BY ""m"".""month""), 0) AS ""tot_cnt"",COALESCE(""t2"".""active_driver"", 0) AS ""act_cnt"" FROM (""months"" AS ""m"" LEFT JOIN ""t1"" ON ""m"".""month""=""t1"".""month"") LEFT JOIN ""t2"" ON ""m"".""month""=""t2"".""month"") AS ""a"""
305,"WITH ""t"" (""Month"") AS (SELECT 1 UNION ALL SELECT 2 UNION ALL SELECT 3 UNION ALL SELECT 4 UNION ALL SELECT 5 UNION ALL SELECT 6 UNION ALL SELECT 7 UNION ALL SELECT 8 UNION ALL SELECT 9 UNION ALL SELECT 10 UNION ALL SELECT 11 UNION ALL SELECT 12) SELECT ""t"".""month"",CASE WHEN COUNT(DISTINCT ""a"".""driver_id"")+0.00=0.00 OR COUNT(DISTINCT ""d"".""Driver_id"")+0.00=0.00 THEN 0.00 ELSE ROUND((COUNT(DISTINCT ""a"".""driver_id"")+0.00)*100/(COUNT(DISTINCT ""d"".""Driver_id"")+0.00), 2) END AS ""Working_percentage"" FROM ((""t"" LEFT JOIN ""Drivers"" AS ""d"" ON (EXTRACT(MONTH FROM ""d"".""join_Date"")<=""t"".""month"" AND EXTRACT(YEAR FROM ""d"".""JOIN_DATE"")=2020) OR EXTRACT(YEAR FROM ""d"".""join_date"")<2020) LEFT JOIN ""Rides"" AS ""r"" ON ""t"".""Month""=EXTRACT(MONTH FROM ""r"".""requested_at"") AND EXTRACT(YEAR FROM ""r"".""requested_at"")=2020) LEFT JOIN ""AcceptedRides"" AS ""a"" ON ""r"".""ride_id""=""a"".""ride_id"" GROUP BY ""t"".""month"" ORDER BY ""t"".""month"""
306,"WITH RECURSIVE ""month"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 AS ""month"" FROM ""month"" WHERE ""month""<12), ""active_driver"" AS (SELECT ""month"".""month"" AS ""month"",COUNT(""d"".""driver_id"") AS ""num_of_driver"" FROM ""Drivers"" AS ""d"" JOIN ""month"" WHERE (EXTRACT(YEAR FROM ""d"".""join_date"")<'2020') OR (EXTRACT(YEAR FROM ""d"".""join_date"")='2020' AND EXTRACT(MONTH FROM ""d"".""join_date"")<=""month"".""month"") GROUP BY ""month"".""month""), ""working_driver"" AS (SELECT EXTRACT(MONTH FROM ""r"".""requested_at"") AS ""run_time"",COUNT(DISTINCT ""driver_id"") AS ""num_of_working_driver"" FROM ""Rides"" AS ""r"" LEFT JOIN ""AcceptedRides"" AS ""a"" ON ""r"".""ride_id""=""a"".""ride_id"" WHERE EXTRACT(YEAR FROM ""r"".""requested_at"")='2020' GROUP BY ""run_time"") SELECT ""m"".""month"" AS ""month"",ROUND(COALESCE(""w"".""num_of_working_driver""/""a"".""num_of_driver""*100, 0.00), 2) AS ""working_percentage"" FROM (""month"" AS ""m"" LEFT JOIN ""active_driver"" AS ""a"" ON ""m"".""month""=""a"".""month"") LEFT JOIN ""working_driver"" AS ""w"" ON ""m"".""month""=""w"".""run_time"" ORDER BY ""month"""
307,"WITH RECURSIVE ""mo_cte"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 AS ""month"" FROM ""mo_cte"" WHERE ""month""+1<=12), ""denom"" AS (SELECT ""m"".""month"",SUM(CASE WHEN EXTRACT(YEAR FROM ""t"".""join_date"")<2020 OR EXTRACT(MONTH FROM ""t"".""join_date"")<=""m"".""month"" THEN 1 ELSE 0 END) AS ""avail_dri"" FROM (""Drivers"" AS ""t"") JOIN ""mo_cte"" AS ""m"" WHERE ""t"".""join_date""<='2020-12-31' GROUP BY 1), ""nom"" AS (SELECT ""m"".""month"",COALESCE(COUNT(DISTINCT CASE WHEN ""m"".""month""=EXTRACT(MONTH FROM ""t"".""dt"") THEN ""t"".""driver_id"" ELSE NULL END), 0) AS ""acep_dri"" FROM (""mo_cte"" AS ""m"") JOIN (SELECT ""a"".""ride_id"",""a"".""driver_id"",""r"".""requested_at"" AS ""dt"" FROM ""AcceptedRides"" AS ""a"" LEFT JOIN ""Rides"" AS ""r"" ON ""a"".""ride_id""=""r"".""ride_id"" WHERE ""r"".""requested_at"" BETWEEN '2020-01-01' AND '2020-12-31') AS ""t"" GROUP BY 1) SELECT ""de"".""month"",CASE WHEN ""de"".""avail_dri""=0 THEN 0.00 ELSE ROUND(""nom"".""acep_dri""*100.0/""de"".""avail_dri"", 2) END AS ""working_percentage"" FROM ""denom"" AS ""de"" LEFT JOIN ""nom"" ON ""de"".""month""=""nom"".""month"" ORDER BY ""de"".""month"""
308,"WITH RECURSIVE ""monthid"" AS (SELECT 1 AS ""m"" UNION SELECT ""m""+1 AS ""m"" FROM ""monthid"" WHERE ""m""<12), ""t"" AS (SELECT ""driver_id"",""join_date"" FROM ""Drivers"" UNION ALL SELECT ""driver_id"",""join_date"" + INTERVAL '1 MONTH' FROM ""t"" WHERE ""join_date""<STR_TO_DATE('20201201', '%Y%m%d')), ""t2"" AS (SELECT TO_CHAR(""join_date"", 'YYYY-%m-01') AS ""date"",COUNT(DISTINCT ""driver_id"") AS ""counts"" FROM ""t"" WHERE TO_CHAR(""join_date"", 'YYYY-%m')<='2020-12' AND TO_CHAR(""join_date"", 'YYYY-%m')>='2020-01' GROUP BY 1), ""t3"" AS (SELECT EXTRACT(MONTH FROM ""date"") AS ""months"",""counts"" FROM ""t2"" GROUP BY 1), ""t4"" AS (SELECT ""driver_id"",""requested_at"" FROM ""Rides"" JOIN ""AcceptedRides"" USING (""ride_id"")), ""t5"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""months"",COUNT(DISTINCT ""driver_id"") AS ""counts"" FROM ""t4"" WHERE TO_CHAR(""requested_at"", 'YYYY-%m')<='2020-12' AND TO_CHAR(""requested_at"", 'YYYY-%m')>='2020-01' GROUP BY 1) SELECT ""m"" AS ""month"",COALESCE(ROUND((COALESCE(""t5"".""counts"", 0)/COALESCE(""t3"".""counts"", 0)*100), 2), 0) AS ""working_percentage"" FROM (""monthid"" LEFT JOIN ""t3"" ON ""m""=""t3"".""months"") LEFT JOIN ""t5"" ON ""m""=""t5"".""months"" GROUP BY 1 ORDER BY 1"
309,"WITH RECURSIVE ""months"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""months"" WHERE ""month""<12), ""available_drivers"" AS (SELECT ""months"".""month"",COALESCE(MAX(""t1"".""active_driver"") OVER (ORDER BY ""month""), 0) AS ""active_driver"" FROM ""months"" LEFT JOIN (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(""driver_id"") OVER (ORDER BY ""join_date"" ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS ""active_driver"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020) AS ""t1"" ON ""t1"".""month""=""months"".""month""), ""working_drivers"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""working_driver"" FROM ""Rides"" AS ""R"" JOIN ""AcceptedRides"" AS ""A"" ON ""R"".""ride_id""=""A"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY 1) SELECT ""months"".""month"",COALESCE(ROUND(""working_driver""/""active_driver""*100, 2), 0) AS ""working_percentage"" FROM (""months"" LEFT JOIN ""available_drivers"" ON ""available_drivers"".""month""=""months"".""month"") LEFT JOIN ""working_drivers"" ON ""working_drivers"".""month""=""months"".""month"" GROUP BY 1"
310,"WITH RECURSIVE ""years"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""years"" WHERE ""month""<12), ""no_drivers"" AS (SELECT ""month"",""no_drivers"" FROM (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",ROW_NUMBER() OVER (ORDER BY ""join_date"") AS ""no_drivers"",""join_date"" FROM ""Drivers"") AS ""a"" WHERE EXTRACT(YEAR FROM ""join_date"")='2020'), ""driver_years"" AS (SELECT DISTINCT ""y"".""month"",MAX(""no_drivers"") OVER (ORDER BY ""y"".""month"") AS ""no_drivers"" FROM ""years"" AS ""y"" LEFT JOIN ""no_drivers"" AS ""nd"" ON ""y"".""month""=""nd"".""month""), ""rides_accept"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""a"".""driver_id"") AS ""no_accept"" FROM ""Rides"" AS ""r"" JOIN ""AcceptedRides"" AS ""a"" ON ""r"".""ride_id""=""a"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")='2020' GROUP BY EXTRACT(MONTH FROM ""requested_at"")) SELECT ""d"".""month"",ROUND(100*(COALESCE(""no_accept""/""no_drivers"", 0)), 2) AS ""working_percentage"" FROM ""driver_years"" AS ""d"" LEFT JOIN ""rides_accept"" AS ""r"" ON ""d"".""month""=""r"".""month"""
311,"SELECT ""t1"".""mth"" AS ""month"",CASE WHEN ""t1"".""total""=0 THEN 0.00 ELSE ROUND(""t1"".""active""/""t1"".""total""*100, 2) END AS ""working_percentage"" FROM (SELECT ""mth"",(SELECT COUNT(1) FROM ""drivers"" AS ""d1"" WHERE EXTRACT(YEAR FROM ""d1"".""join_date"")<2020 OR (EXTRACT(YEAR FROM ""d1"".""join_date"")=2020 AND EXTRACT(MONTH FROM ""d1"".""join_date"")<=""mth"")) AS ""total"",(SELECT COUNT(DISTINCT ""a1"".""driver_id"") FROM (""rides"" AS ""r1"") JOIN ""AcceptedRides"" AS ""a1"" WHERE ""r1"".""ride_id""=""a1"".""ride_id"" AND EXTRACT(YEAR FROM ""r1"".""requested_at"")=2020 AND EXTRACT(MONTH FROM ""r1"".""requested_at"")=""mth"") AS ""active"" FROM (SELECT 1 AS ""mth"" UNION SELECT 2 AS ""mth"" UNION SELECT 3 AS ""mth"" UNION SELECT 4 AS ""mth"" UNION SELECT 5 AS ""mth"" UNION SELECT 6 AS ""mth"" UNION SELECT 7 AS ""mth"" UNION SELECT 8 AS ""mth"" UNION SELECT 9 AS ""mth"" UNION SELECT 10 AS ""mth"" UNION SELECT 11 AS ""mth"" UNION SELECT 12 AS ""mth"") AS ""t_months"") AS ""t1"" ORDER BY ""t1"".""mth"""
312,"WITH RECURSIVE ""months"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""months"" WHERE ""month""<12), ""available_drivers"" AS (SELECT ""months"".""month"",COALESCE(MAX(""t1"".""active_driver"") OVER (ORDER BY ""month""), 0) AS ""active_driver"" FROM ""months"" LEFT JOIN (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(""driver_id"") OVER (ORDER BY ""join_date"" ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS ""active_driver"" FROM ""drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020) AS ""t1"" ON ""t1"".""month""=""months"".""month""), ""working_drivers"" AS (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""working_driver"" FROM ""Rides"" AS ""R"" JOIN ""AcceptedRides"" AS ""A"" ON ""R"".""ride_id""=""A"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY 1) SELECT ""months"".""month"",COALESCE(ROUND(""working_driver""/""active_driver""*100, 2), 0) AS ""working_percentage"" FROM (""months"" LEFT JOIN ""available_drivers"" ON ""available_drivers"".""month""=""months"".""month"") LEFT JOIN ""working_drivers"" ON ""working_drivers"".""month""=""months"".""month"" GROUP BY 1"
313,"WITH RECURSIVE ""cte"" AS (SELECT 1 AS ""month"",0 AS ""driver_cnt"" UNION ALL SELECT ""month""+1 AS ""month"",0 AS ""driver_cnt"" FROM ""cte"" WHERE ""month""<12), ""cte1"" AS (SELECT ""month"" AS ""driver_month"",SUM(""driver_cnt"") OVER (ORDER BY ""month"") AS ""driver_cnt"" FROM (SELECT ""month"",SUM(""driver_cnt"") AS ""driver_cnt"" FROM (SELECT EXTRACT(MONTH FROM ""join_date"") AS ""month"",COUNT(""driver_id"") AS ""driver_cnt"" FROM (SELECT CASE WHEN ""join_date""<'2020-01-01' THEN '2020-01-01' ELSE ""join_date"" END AS ""join_date"",""driver_id"" FROM ""Drivers"" WHERE ""join_date""<='2020-12-31') AS ""t0"" GROUP BY EXTRACT(MONTH FROM ""join_date"") UNION ALL SELECT ""month"",""driver_cnt"" FROM ""cte"") AS ""t1"" GROUP BY ""month"") AS ""t2""), ""cte2"" AS (SELECT ""ride_month"",COUNT(DISTINCT ""driver_id"") AS ""ride_driver_cnt"" FROM (SELECT ""driver_id"",EXTRACT(MONTH FROM ""requested_at"") AS ""ride_month"" FROM ""Rides"" AS ""r"" LEFT JOIN ""AcceptedRides"" AS ""a"" ON ""r"".""ride_id""=""a"".""ride_id"" AND EXTRACT(YEAR FROM ""requested_at"")='2020') AS ""t2"" GROUP BY ""ride_month"") SELECT ""driver_month"" AS ""month"",CASE ""driver_cnt"" WHEN 0 THEN 0 ELSE COALESCE(ROUND(100*(""ride_driver_cnt""/""driver_cnt""), 2), 0) END AS ""working_percentage"" FROM ""cte1"" LEFT JOIN ""cte2"" ON ""cte1"".""driver_month""=""cte2"".""ride_month"""
314,"WITH RECURSIVE ""temp1"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""temp1"" WHERE ""month""<12), ""temp2"" AS (SELECT EXTRACT(YEAR FROM ""a"".""join_date"") AS ""join_year"",EXTRACT(MONTH FROM ""a"".""join_date"") AS ""join_month"",COUNT(DISTINCT ""b"".""driver_id"") AS ""cum_driver"" FROM ""Drivers"" AS ""a"" LEFT JOIN ""Drivers"" AS ""b"" ON ""a"".""join_date"">=""b"".""join_date"" GROUP BY 1,2 ORDER BY 1,2), ""temp3"" AS (SELECT COUNT(DISTINCT ""a"".""driver_id"") AS ""cnt"",EXTRACT(MONTH FROM ""b"".""requested_at"") AS ""requested_month"" FROM ""AcceptedRides"" AS ""a"" JOIN ""Rides"" AS ""b"" ON ""a"".""ride_id""=""b"".""ride_id"" WHERE EXTRACT(YEAR FROM ""b"".""requested_at"")=2020 GROUP BY 2), ""temp4"" AS (SELECT ""a"".""month"",MAX(""b"".""cum_driver"") AS ""cum_driver"" FROM ""temp1"" AS ""a"" LEFT JOIN ""temp2"" AS ""b"" ON ""a"".""month"">=""b"".""join_month"" AND ""b"".""join_year""=2020 GROUP BY 1 ORDER BY 1) SELECT ""a"".""month"",ROUND(COALESCE(""b"".""cnt""/""a"".""cum_driver"", 0)*100.00, 2) AS ""working_percentage"" FROM ""temp4"" AS ""a"" LEFT JOIN ""temp3"" AS ""b"" ON ""a"".""month""=""b"".""requested_month"" ORDER BY 1"
315,"WITH RECURSIVE ""DATE_TAB"" AS (SELECT '202001' AS ""MON_YY"",1 AS ""MON_ID"" UNION ALL SELECT ""MON_YY""+1,""MON_ID""+1 FROM ""DATE_TAB"" WHERE ""MON_ID""<12), ""TRIP_CNT"" AS (SELECT TO_CHAR(""REQUESTED_AT"", 'YYYY%m') AS ""REQ_MON_YY"",COUNT(DISTINCT ""D"".""DRIVER_ID"") AS ""DRIVER_CNT"",COUNT(DISTINCT ""A"".""DRIVER_ID"") AS ""TRIP_CNT"" FROM (""ACCEPTEDRIDES"" AS ""A"" JOIN ""RIDES"" AS ""R"" ON ""A"".""RIDE_ID""=""R"".""RIDE_ID"") JOIN ""DRIVERS"" AS ""D"" ON TO_CHAR(""R"".""REQUESTED_AT"", 'YYYY%m')>=TO_CHAR(""D"".""JOIN_DATE"", 'YYYY%m') WHERE ""R"".""REQUESTED_AT""<='2020-12-31' AND ""R"".""REQUESTED_AT"">='2020-01-01' GROUP BY 1) SELECT ""DT"".""MON_ID"" AS ""month"",COALESCE(ROUND((""TC"".""TRIP_CNT""/""TC"".""DRIVER_CNT"")*100, 2), 0.00) AS ""working_percentage"" FROM ""DATE_TAB"" AS ""DT"" LEFT JOIN ""TRIP_CNT"" AS ""TC"" ON ""DT"".""MON_YY""=""TC"".""REQ_MON_YY"""
316,"WITH RECURSIVE ""cte"" (""month"") AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 FROM ""CTE"" WHERE ""month""<12), ""driver2"" AS (SELECT ""a"".""month"",COUNT(DISTINCT COALESCE(""driver_id"", 0)) AS ""n_driver"" FROM ""cte"" AS ""a"" LEFT JOIN (SELECT ""driver_id"",""join_date"",CASE WHEN EXTRACT(YEAR FROM ""join_date"")<2020 THEN 1 ELSE EXTRACT(MONTH FROM ""join_date"") END AS ""join_month"" FROM ""Drivers"" WHERE EXTRACT(YEAR FROM ""join_date"")<=2020) AS ""b"" ON ""a"".""month"">=""b"".""join_month"" GROUP BY ""a"".""month"") SELECT ""d"".""month"",ROUND(COALESCE(""drivers"", 0)*100/""n_driver"", 2) AS ""working_percentage"" FROM ""driver2"" AS ""d"" LEFT JOIN (SELECT EXTRACT(MONTH FROM ""requested_at"") AS ""month"",COUNT(DISTINCT ""driver_id"") AS ""drivers"" FROM ""AcceptedRides"" AS ""a"" LEFT JOIN ""Rides"" AS ""b"" ON ""a"".""ride_id""=""b"".""ride_id"" WHERE EXTRACT(YEAR FROM ""requested_at"")=2020 GROUP BY EXTRACT(MONTH FROM ""requested_at"")) AS ""c"" ON ""d"".""month""=""c"".""month"""
317,"WITH ""t"" (""Month"") AS (SELECT 1 UNION ALL SELECT 2 UNION ALL SELECT 3 UNION ALL SELECT 4 UNION ALL SELECT 5 UNION ALL SELECT 6 UNION ALL SELECT 7 UNION ALL SELECT 8 UNION ALL SELECT 9 UNION ALL SELECT 10 UNION ALL SELECT 11 UNION ALL SELECT 12) SELECT ""t"".""month"",CASE WHEN COUNT(DISTINCT ""a"".""driver_id"")+0.00=0.00 OR COUNT(DISTINCT ""d"".""Driver_id"")+0.00=0.00 THEN 0.00 ELSE ROUND((COUNT(DISTINCT ""a"".""driver_id"")+0.00)*100/(COUNT(DISTINCT ""d"".""Driver_id"")+0.00), 2) END AS ""Working_percentage"" FROM ((""t"" LEFT JOIN ""Drivers"" AS ""d"" ON (EXTRACT(MONTH FROM ""d"".""join_Date"")<=""t"".""month"" AND EXTRACT(YEAR FROM ""d"".""JOIN_DATE"")=2020) OR EXTRACT(YEAR FROM ""d"".""join_date"")<2020) LEFT JOIN ""Rides"" AS ""r"" ON ""t"".""Month""=EXTRACT(MONTH FROM ""r"".""requested_at"") AND EXTRACT(YEAR FROM ""r"".""requested_at"")=2020) LEFT JOIN ""AcceptedRides"" AS ""a"" ON ""r"".""ride_id""=""a"".""ride_id"" GROUP BY ""t"".""month"" ORDER BY ""t"".""month"""
318,"WITH RECURSIVE ""m"" AS (SELECT 1 AS ""month"" UNION ALL SELECT ""month""+1 AS ""month"" FROM ""m"" WHERE ""month""<12) SELECT ""m"".""month"" AS ""month"",ROUND(COALESCE(COUNT(DISTINCT ""a"".""driver_id"")/COUNT(DISTINCT ""d"".""driver_id"")*100, 0), 2) AS ""working_percentage"" FROM ((""m"" LEFT JOIN ""rides"" AS ""r"" ON ""m"".""month""=EXTRACT(MONTH FROM ""r"".""requested_at"") AND EXTRACT(YEAR FROM ""r"".""requested_at"")=2020) LEFT JOIN ""acceptedrides"" AS ""a"" ON ""r"".""ride_id""=""a"".""ride_id"") LEFT JOIN ""drivers"" AS ""d"" ON (""m"".""month"">=EXTRACT(MONTH FROM ""d"".""join_date"") AND EXTRACT(YEAR FROM ""d"".""join_date"")=2020) OR EXTRACT(YEAR FROM ""d"".""join_date"")<2020 GROUP BY ""m"".""month"""
319,"WITH ""t"" (""Month"") AS (SELECT 1 UNION ALL SELECT 2 UNION ALL SELECT 3 UNION ALL SELECT 4 UNION ALL SELECT 5 UNION ALL SELECT 6 UNION ALL SELECT 7 UNION ALL SELECT 8 UNION ALL SELECT 9 UNION ALL SELECT 10 UNION ALL SELECT 11 UNION ALL SELECT 12) SELECT ""t"".""month"",CASE WHEN COUNT(DISTINCT ""a"".""driver_id"")+0.00=0.00 OR COUNT(DISTINCT ""d"".""Driver_id"")+0.00=0.00 THEN 0.00 ELSE ROUND((COUNT(DISTINCT ""a"".""driver_id"")+0.00)*100/(COUNT(DISTINCT ""d"".""Driver_id"")+0.00), 2) END AS ""Working_percentage"" FROM ((""t"" LEFT JOIN ""Drivers"" AS ""d"" ON (EXTRACT(MONTH FROM ""d"".""join_Date"")<=""t"".""month"" AND EXTRACT(YEAR FROM ""d"".""JOIN_DATE"")=2020) OR EXTRACT(YEAR FROM ""d"".""join_date"")<2020) LEFT JOIN ""Rides"" AS ""r"" ON ""t"".""Month""=EXTRACT(MONTH FROM ""r"".""requested_at"") AND EXTRACT(YEAR FROM ""r"".""requested_at"")=2020) LEFT JOIN ""AcceptedRides"" AS ""a"" ON ""r"".""ride_id""=""a"".""ride_id"" GROUP BY ""t"".""month"" ORDER BY ""t"".""month"""
320,"WITH ""DATE_TAB"" AS (SELECT '202001' AS ""MON_YY"",1 AS ""MON_ID"" UNION ALL SELECT '202002' AS ""MON_YY"",2 AS ""MON_ID"" UNION ALL SELECT '202003' AS ""MON_YY"",3 AS ""MON_ID"" UNION ALL SELECT '202004' AS ""MON_YY"",4 AS ""MON_ID"" UNION ALL SELECT '202005' AS ""MON_YY"",5 AS ""MON_ID"" UNION ALL SELECT '202006' AS ""MON_YY"",6 AS ""MON_ID"" UNION ALL SELECT '202007' AS ""MON_YY"",7 AS ""MON_ID"" UNION ALL SELECT '202008' AS ""MON_YY"",8 AS ""MON_ID"" UNION ALL SELECT '202009' AS ""MON_YY"",9 AS ""MON_ID"" UNION ALL SELECT '202010' AS ""MON_YY"",10 AS ""MON_ID"" UNION ALL SELECT '202011' AS ""MON_YY"",11 AS ""MON_ID"" UNION ALL SELECT '202012' AS ""MON_YY"",12 AS ""MON_ID""), ""TRIP_CNT"" AS (SELECT TO_CHAR(""REQUESTED_AT"", 'YYYY%m') AS ""REQ_MON_YY"",COUNT(DISTINCT ""D"".""DRIVER_ID"") AS ""DRIVER_CNT"",COUNT(DISTINCT ""A"".""DRIVER_ID"") AS ""TRIP_CNT"" FROM (""ACCEPTEDRIDES"" AS ""A"" JOIN ""RIDES"" AS ""R"" ON ""A"".""RIDE_ID""=""R"".""RIDE_ID"") JOIN ""DRIVERS"" AS ""D"" ON TO_CHAR(""R"".""REQUESTED_AT"", 'YYYY%m')>=TO_CHAR(""D"".""JOIN_DATE"", 'YYYY%m') WHERE ""R"".""REQUESTED_AT""<='2020-12-31' AND ""R"".""REQUESTED_AT"">='2020-01-01' GROUP BY 1) SELECT ""DT"".""MON_ID"" AS ""month"",COALESCE(ROUND((""TC"".""TRIP_CNT""/""TC"".""DRIVER_CNT"")*100, 2), 0.00) AS ""working_percentage"" FROM ""DATE_TAB"" AS ""DT"" LEFT JOIN ""TRIP_CNT"" AS ""TC"" ON ""DT"".""MON_YY""=""TC"".""REQ_MON_YY"""
