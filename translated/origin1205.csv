id,original query
1,"WITH ""cte1"" AS (SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",COUNT(""id"") AS ""approved_count"",SUM(""amount"") AS ""approved_amount"" FROM ""transactions"" WHERE ""state""='approved' GROUP BY 1,2), ""cte2"" AS (SELECT TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"",""country"",COUNT(1) AS ""chargeback_count"",SUM(""amount"") AS ""chargeback_amount"" FROM ""chargebacks"" AS ""c"" JOIN ""transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" GROUP BY 1,2) SELECT ""cte1"".""month"",""cte1"".""country"",""approved_count"",""approved_amount"",COALESCE(""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""cte1"" LEFT JOIN ""cte2"" ON ""cte1"".""month""=""cte2"".""month"" AND ""cte1"".""country""=""cte2"".""country"" UNION ALL SELECT ""cte2"".""month"",""cte2"".""country"",COALESCE(""approved_count"", 0) AS ""approved_count"",COALESCE(""approved_amount"", 0) AS ""approved_amount"",""chargeback_count"",""chargeback_amount"" FROM ""cte1"" RIGHT JOIN ""cte2"" ON ""cte1"".""month""=""cte2"".""month"" AND ""cte1"".""country""=""cte2"".""country"" WHERE ""cte1"".""month"" IS NULL"
2,"SELECT ""month"",""country"",SUM(""state""='approved') AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(""state""='back') AS ""chargeback_count"",SUM(CASE WHEN ""state""='back' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT LEFT(""c"".""trans_date"", 7) AS ""month"",""country"",'back' AS ""state"",""amount"" FROM ""Chargebacks"" AS ""c"" JOIN ""Transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" UNION ALL SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",""state"",""amount"" FROM ""Transactions"" WHERE ""state""='approved') AS ""a"" GROUP BY ""month"",""country"""
3,"SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='back' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='back' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT LEFT(""chargebacks"".""trans_date"", 7) AS ""month"",""country"",'back' AS ""state"",""amount"" FROM ""chargebacks"" JOIN ""transactions"" ON ""chargebacks"".""trans_id""=""transactions"".""id"" UNION ALL SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",""state"",""amount"" FROM ""transactions"" WHERE ""state""='approved') AS ""s"" GROUP BY ""month"",""country"""
4,"SELECT ""s1"".""month"",""s1"".""country"",COALESCE(SUM(CASE WHEN ""s2"".""state""='approved' THEN 1 ELSE 0 END), 0) AS ""approved_count"",COALESCE(SUM(CASE WHEN ""s2"".""state""='approved' THEN ""amount"" ELSE 0 END), 0) AS ""approved_amount"",COALESCE(""s3"".""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""s3"".""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ((SELECT DISTINCT SUBSTRING(""trans_date"", 1, 7) AS ""month"",""country"" FROM ""transactions"" WHERE ""state""='approved' UNION (SELECT DISTINCT SUBSTRING(""a"".""trans_date"", 1, 7) AS ""month"",""country"" FROM ""chargebacks"" AS ""a"" LEFT JOIN ""transactions"" AS ""b"" ON ""a"".""trans_id""=""b"".""id"")) AS ""s1"" LEFT JOIN ""transactions"" AS ""s2"" ON ""s1"".""month""=SUBSTRING(""s2"".""trans_date"", 1, 7) AND ""s2"".""country""=""s1"".""country"") LEFT JOIN (SELECT SUBSTRING(""b"".""trans_date"", 1, 7) AS ""month"",""a"".""country"",COUNT(DISTINCT ""b"".""trans_id"") AS ""chargeback_count"",SUM(CASE WHEN ""b"".""trans_id"" IS NOT NULL THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""transactions"" AS ""a"" LEFT JOIN ""chargebacks"" AS ""b"" ON ""a"".""id""=""b"".""trans_id"" GROUP BY 1,2) AS ""s3"" ON ""s1"".""month""=""s3"".""month"" AND ""s1"".""country""=""s3"".""country"" GROUP BY 1,2"
5,"WITH ""Approved"" AS (SELECT ""country"",TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",COUNT(1) AS ""cnt"",SUM(""amount"") AS ""amnt"" FROM ""Transactions"" WHERE ""state""='approved' GROUP BY ""country"",""month""), ""Charged"" AS (SELECT ""t"".""country"",TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"",COUNT(1) AS ""cnt"",SUM(""t"".""amount"") AS ""amnt"" FROM ""Chargebacks"" AS ""c"" LEFT JOIN ""Transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" GROUP BY ""t"".""country"",""month"") SELECT ""a1"".""month"",""a1"".""country"",""a1"".""cnt"" AS ""approved_count"",""a1"".""amnt"" AS ""approved_amount"",COALESCE(""c1"".""cnt"", 0) AS ""chargeback_count"",COALESCE(""c1"".""amnt"", 0) AS ""chargeback_amount"" FROM ""Approved"" AS ""a1"" LEFT JOIN ""Charged"" AS ""c1"" ON ""a1"".""month""=""c1"".""month"" AND ""a1"".""country""=""c1"".""country"" UNION ALL SELECT ""c2"".""month"",""c2"".""country"",COALESCE(""a2"".""cnt"", 0) AS ""approved_count"",COALESCE(""a2"".""amnt"", 0) AS ""approved_amount"",""c2"".""cnt"" AS ""chargeback_count"",""c2"".""amnt"" AS ""chargeback_amount"" FROM ""Charged"" AS ""c2"" LEFT JOIN ""Approved"" AS ""a2"" ON ""c2"".""month""=""a2"".""month"" AND ""c2"".""country""=""a2"".""country"" WHERE COALESCE(""a2"".""cnt"", 0)=0"
6,"WITH ""tmp"" AS (SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",""state"",""amount"" FROM ""Transactions"" WHERE ""state""='approved' UNION ALL SELECT TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"",""t"".""country"",'chargeback' AS ""state"",""t"".""amount"" AS ""amount"" FROM ""Chargebacks"" AS ""c"" JOIN ""Transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"") SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='chargeback' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""tmp"" GROUP BY ""month"",""country"""
7,"SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(""state""='approved') AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(""state""='chargeback') AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT * FROM ""Transactions"" WHERE ""state""='approved' UNION ALL SELECT ""C"".""trans_id"" AS ""id"",""T"".""country"",'chargeback' AS ""state"",""T"".""amount"",""C"".""trans_date"" FROM ""Chargebacks"" AS ""C"" LEFT JOIN ""Transactions"" AS ""T"" ON ""C"".""trans_id""=""T"".""id"") AS ""final"" GROUP BY ""month"",""country"""
8,"SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(""state""='approved') AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(""state""='chargeback') AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT DISTINCT * FROM ""Transactions"" WHERE ""state""='approved' UNION ALL SELECT DISTINCT ""C"".""trans_id"" AS ""id"",""T"".""country"",'chargeback' AS ""state"",""T"".""amount"",""C"".""trans_date"" FROM ""Chargebacks"" AS ""C"" LEFT JOIN ""Transactions"" AS ""T"" ON ""C"".""trans_id""=""T"".""id"") AS ""final"" GROUP BY ""month"",""country"""
9,"SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='back' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='back' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT LEFT(""c"".""trans_date"", 7) AS ""month"",""country"",""amount"",'back' AS ""state"" FROM ""transactions"" AS ""t"" JOIN ""chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"" UNION ALL SELECT LEFT(""trans_date"", 7),""country"",""amount"",""state"" FROM ""transactions"" WHERE ""state""='approved') AS ""sub"" GROUP BY 1,2"
10,"SELECT DISTINCT ""t_all"".* FROM (SELECT ""cb_agg"".""month"",""cb_agg"".""country"",COALESCE(""tr_agg"".""approved_count"", 0) AS ""approved_count"",COALESCE(""tr_agg"".""approved_amount"", 0) AS ""approved_amount"",""cb_agg"".""chargeback_count"",""cb_agg"".""chargeback_amount"" FROM (SELECT ""t1"".""month"",""t1"".""country"",COUNT(1) AS ""chargeback_count"",SUM(""t1"".""amount"") AS ""chargeback_amount"" FROM (SELECT CONCAT(CAST(EXTRACT(YEAR FROM ""cb"".""trans_date"") AS CHAR(4)), '-', RIGHT(CONCAT('0', CAST(EXTRACT(MONTH FROM ""cb"".""trans_date"") AS CHAR(2))), 2)) AS ""month"",""tr"".""country"",""tr"".""amount"" FROM (""Transactions"" AS ""tr"") CROSS JOIN ""Chargebacks"" AS ""cb"" WHERE ""tr"".""id""=""cb"".""trans_id"") AS ""t1"" GROUP BY ""t1"".""month"",""t1"".""country"") AS ""cb_agg"" LEFT JOIN (SELECT ""t2"".""month"",""t2"".""country"",COUNT(1) AS ""approved_count"",SUM(""t2"".""amount"") AS ""approved_amount"" FROM (SELECT CONCAT(CAST(EXTRACT(YEAR FROM ""trans_date"") AS CHAR(4)), '-', RIGHT(CONCAT('0', CAST(EXTRACT(MONTH FROM ""trans_date"") AS CHAR(2))), 2)) AS ""month"",""country"",""amount"" FROM ""Transactions"" WHERE ""state""='approved') AS ""t2"" GROUP BY ""t2"".""month"",""t2"".""country"") AS ""tr_agg"" ON ""cb_agg"".""month""=""tr_agg"".""month"" AND ""cb_agg"".""country""=""tr_agg"".""country"" UNION SELECT ""tr_agg"".""month"",""tr_agg"".""country"",""tr_agg"".""approved_count"",""tr_agg"".""approved_amount"",COALESCE(""cb_agg"".""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""cb_agg"".""chargeback_amount"", 0) AS ""chargeback_amount"" FROM (SELECT ""t1"".""month"",""t1"".""country"",COUNT(1) AS ""chargeback_count"",SUM(""t1"".""amount"") AS ""chargeback_amount"" FROM (SELECT CONCAT(CAST(EXTRACT(YEAR FROM ""cb"".""trans_date"") AS CHAR(4)), '-', RIGHT(CONCAT('0', CAST(EXTRACT(MONTH FROM ""cb"".""trans_date"") AS CHAR(2))), 2)) AS ""month"",""tr"".""country"",""tr"".""amount"" FROM (""Transactions"" AS ""tr"") CROSS JOIN ""Chargebacks"" AS ""cb"" WHERE ""tr"".""id""=""cb"".""trans_id"") AS ""t1"" GROUP BY ""t1"".""month"",""t1"".""country"") AS ""cb_agg"" RIGHT JOIN (SELECT ""t2"".""month"",""t2"".""country"",COUNT(1) AS ""approved_count"",SUM(""t2"".""amount"") AS ""approved_amount"" FROM (SELECT CONCAT(CAST(EXTRACT(YEAR FROM ""trans_date"") AS CHAR(4)), '-', RIGHT(CONCAT('0', CAST(EXTRACT(MONTH FROM ""trans_date"") AS CHAR(2))), 2)) AS ""month"",""country"",""amount"" FROM ""Transactions"" WHERE ""state""='approved') AS ""t2"" GROUP BY ""t2"".""month"",""t2"".""country"") AS ""tr_agg"" ON ""cb_agg"".""month""=""tr_agg"".""month"" AND ""cb_agg"".""country""=""tr_agg"".""country"") AS ""t_all"" ORDER BY ""t_all"".""month"",""t_all"".""country"" DESC"
11,"SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",COUNT(CASE WHEN ""state""='approved' THEN ""trans_id"" ELSE NULL END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",COUNT(CASE WHEN ""state""='chargeback' THEN ""trans_id"" ELSE NULL END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT ""trans_id"",""country"",'chargeback' AS ""state"",""amount"",""chargebacks"".""trans_date"" FROM ""chargebacks"" JOIN ""transactions"" ON ""chargebacks"".""trans_id""=""transactions"".""id"" UNION SELECT ""id"",""country"",""state"",""amount"",""trans_date"" FROM ""transactions"") AS ""t"" WHERE ""state"" IN ('approved','chargeback') GROUP BY 1,2 ORDER BY 1,2"
12,"SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",SUM(""state""='approved') AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(""state""='chargeback') AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT * FROM ""transactions"" UNION ALL (SELECT DISTINCT ""trans_id"" AS ""id"",""country"",'chargeback' AS ""state"",""amount"",""charge"".""trans_date"" FROM ""chargebacks"" AS ""charge"" LEFT JOIN ""transactions"" AS ""trans"" ON ""charge"".""trans_id""=""trans"".""id"")) AS ""temp1"" WHERE ""state"" IN ('approved','chargeback') GROUP BY ""country"",""month"""
13,"WITH ""union_cte"" AS (SELECT * FROM ""Transactions"" UNION SELECT ""t"".""id"",""t"".""country"",'chargeback' AS ""state"",""t"".""amount"",""c"".""trans_date"" FROM ""Transactions"" AS ""t"" JOIN ""Chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id""), ""final_cte"" AS (SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",COUNT(CASE WHEN ""state""='approved' THEN ""state"" END) AS ""approved_count"",COALESCE(SUM(CASE WHEN ""state""='approved' THEN ""amount"" END), 0) AS ""approved_amount"",COUNT(CASE WHEN ""state""='chargeback' THEN ""state"" END) AS ""chargeback_count"",COALESCE(SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" END), 0) AS ""chargeback_amount"" FROM ""union_cte"" GROUP BY ""month"",""country"") SELECT * FROM ""final_cte"" WHERE ""approved_count""!=0 OR ""approved_amount""!=0 OR ""chargeback_count""!=0 OR ""chargeback_amount""!=0"
14,"WITH ""t1"" AS (SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",COUNT(1) AS ""approved_count"",SUM(""amount"") AS ""approved_amount"" FROM ""Transactions"" WHERE ""state""='approved' GROUP BY ""month"",""country""), ""t2"" AS (SELECT TO_CHAR(""Chargebacks"".""trans_date"", 'YYYY-%m') AS ""month"",""country"",COUNT(1) AS ""chargeback_count"",SUM(""amount"") AS ""chargeback_amount"" FROM ""Transactions"" RIGHT JOIN ""Chargebacks"" ON ""Transactions"".""id""=""Chargebacks"".""trans_id"" GROUP BY ""month"",""country"") SELECT ""t1"".*,COALESCE(""t2"".""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""t2"".""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""t1"" LEFT JOIN ""t2"" ON ""t1"".""month""=""t2"".""month"" AND ""t1"".""country""=""t2"".""country"" UNION SELECT ""t2"".""month"",""t2"".""country"",COALESCE(""t1"".""approved_count"", 0) AS ""approved_count"",COALESCE(""t1"".""approved_amount"", 0) AS ""approved_amount"",COALESCE(""t2"".""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""t2"".""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""t1"" RIGHT JOIN ""t2"" ON ""t1"".""month""=""t2"".""month"" AND ""t1"".""country""=""t2"".""country"""
15,"WITH ""u"" AS ((SELECT * FROM ""Transactions"" WHERE ""state""='approved') UNION ALL (SELECT ""t"".""id"",""country"",'chargebacks' AS ""state"",""amount"",""c"".""trans_date"" FROM ""Transactions"" AS ""t"" RIGHT JOIN ""Chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"")) SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",COUNT(CASE WHEN ""state""='approved' THEN 1 ELSE NULL END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",COUNT(CASE WHEN ""state""='chargebacks' THEN 1 ELSE NULL END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargebacks' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""u"" GROUP BY 1,2"
16,"WITH ""main"" AS (SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",COUNT(""id"") AS ""approved_count"",SUM(""amount"") AS ""approved_amount"",0 AS ""chargeback_count"",0 AS ""chargeback_amount"" FROM ""Transactions"" WHERE ""state""='approved' GROUP BY ""month"",""country"" UNION SELECT LEFT(""C"".""trans_date"", 7) AS ""month"",""country"",0 AS ""approved_count"",0 AS ""approved_amount"",COUNT(""trans_id"") AS ""chargeback_count"",SUM(""amount"") AS ""chargeback_amount"" FROM ""Chargebacks"" AS ""C"" JOIN ""Transactions"" AS ""T"" ON ""C"".""trans_id""=""T"".""id"" GROUP BY ""month"",""country"") SELECT ""month"",""country"",SUM(""approved_count"") AS ""approved_count"",SUM(""approved_amount"") AS ""approved_amount"",SUM(""chargeback_count"") AS ""chargeback_count"",SUM(""chargeback_amount"") AS ""chargeback_amount"" FROM ""main"" GROUP BY ""month"",""country"" HAVING ""approved_count""+""chargeback_count"">0"
17,"SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='back' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='back' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT LEFT(""chargebacks"".""trans_date"", 7) AS ""month"",""country"",'back' AS ""state"",""amount"" FROM ""chargebacks"" JOIN ""transactions"" ON ""chargebacks"".""trans_id""=""transactions"".""id"" UNION ALL SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",""state"",""amount"" FROM ""transactions"" WHERE ""state""='approved') AS ""s"" GROUP BY ""month"",""country"""
18,"SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='chargebacks' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargebacks' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT ""c"".""trans_id"",""t"".""country"",'chargebacks' AS ""state"",""t"".""amount"",""c"".""trans_date"" FROM ""chargebacks"" AS ""c"" JOIN ""transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" UNION ALL SELECT * FROM ""transactions"") AS ""cte"" GROUP BY 1,2 HAVING ""chargeback_amount"">0 OR ""approved_amount"">0 ORDER BY 1"
19,"SELECT ""month"",""country"",COALESCE(SUM(CASE WHEN ""state""='approved' THEN ""approved_count"" END), 0) AS ""approved_count"",COALESCE(SUM(CASE WHEN ""state""='approved' THEN ""approved_amount"" END), 0) AS ""approved_amount"",COALESCE(SUM(CASE WHEN ""state""='chargeback' THEN ""approved_count"" END), 0) AS ""chargeback_count"",COALESCE(SUM(CASE WHEN ""state""='chargeback' THEN ""approved_amount"" END), 0) AS ""chargeback_amount"" FROM (SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",COUNT(""state"") AS ""approved_count"",SUM(""amount"") AS ""approved_amount"",'approved' AS ""state"" FROM ""Transactions"" WHERE ""state""='approved' GROUP BY LEFT(""trans_date"", 7),""country"" UNION SELECT LEFT(""c"".""trans_date"", 7) AS ""month"",""country"",COUNT(""c"".""trans_id"") AS ""chargeback_count"",SUM(""t"".""amount"") AS ""chargeback_amount"",'chargeback' AS ""state"" FROM ""Chargebacks"" AS ""c"" JOIN ""Transactions"" AS ""t"" ON ""t"".""id""=""c"".""trans_id"" GROUP BY LEFT(""c"".""trans_date"", 7),""country"") AS ""tc"" GROUP BY ""month"",""country"""
20,"WITH ""x"" AS (SELECT ""t"".*,""c"".""trans_date"" AS ""chargeback_date"" FROM ""transactions"" AS ""t"" LEFT JOIN ""chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"") SELECT * FROM (SELECT TO_CHAR(""t"".""trans_date"", 'YYYY-%m') AS ""month"",""t"".""country"",SUM(CASE WHEN ""t"".""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""t"".""state""='approved' THEN ""t"".""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""t"".""state""='chargeback' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""t"".""state""='chargeback' THEN ""t"".""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT ""id"",""country"",""state"",""amount"",""trans_date"" FROM ""x"" UNION ALL SELECT ""id"",""country"",'chargeback' AS ""state"",""amount"",""chargeback_date"" AS ""trans_date"" FROM ""x"" WHERE ""chargeback_date"" IS NOT NULL) AS ""t"" GROUP BY 1,2) AS ""a"" WHERE ""approved_count""!=0 OR ""approved_amount""!=0 OR ""chargeback_count""!=0 OR ""chargeback_amount""!=0"
21,"SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(""state""='approved') AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(""state""='chargeback') AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT * FROM ""Transactions"" WHERE ""state""='approved' UNION ALL SELECT DISTINCT ""C"".""trans_id"" AS ""id"",""T"".""country"",'chargeback' AS ""state"",""T"".""amount"",""C"".""trans_date"" FROM ""Chargebacks"" AS ""C"" LEFT JOIN ""Transactions"" AS ""T"" ON ""C"".""trans_id""=""T"".""id"") AS ""final"" GROUP BY ""month"",""country"""
22,"SELECT ""month"",""country"",COALESCE(COUNT(CASE WHEN ""state""='approved' THEN 1 ELSE NULL END), 0) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",COALESCE(COUNT(CASE WHEN ""state""='cback' THEN 1 ELSE NULL END), 0) AS ""chargeback_count"",SUM(CASE WHEN ""state""='cback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT ""trans_id"",""country"",'cback' AS ""state"",""amount"",LEFT(""Chargebacks"".""trans_date"", 7) AS ""month"" FROM ""Chargebacks"" JOIN ""Transactions"" ON ""Chargebacks"".""trans_id""=""Transactions"".""id"" UNION ALL SELECT ""id"",""country"",""state"",""amount"",LEFT(""trans_date"", 7) AS ""month"" FROM ""Transactions"" WHERE ""state""='approved') AS ""temp1"" GROUP BY ""month"",""country"""
23,"SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='chargeback' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT ""c"".""trans_id"" AS ""id"",""t"".""country"",'chargeback' AS ""state"",""t"".""amount"",""c"".""trans_date"" FROM ""transactions"" AS ""t"" JOIN ""chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"" UNION ALL SELECT * FROM ""Transactions"" WHERE ""state""='approved') AS ""temp"" GROUP BY ""month"",""country"""
24,"WITH ""t"" AS (SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",""amount"",'ap' AS ""ap_cb"" FROM ""transactions"" WHERE ""state""='approved' UNION ALL SELECT TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"",""country"",""amount"",'cb' AS ""ap_cb"" FROM ""chargebacks"" AS ""c"" JOIN ""transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"") SELECT ""month"",""country"",COUNT(CASE WHEN ""ap_cb""='ap' THEN 1 ELSE NULL END) AS ""approved_count"",SUM(CASE WHEN ""ap_cb""='ap' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",COUNT(CASE WHEN ""ap_cb""='cb' THEN 1 ELSE NULL END) AS ""chargeback_count"",SUM(CASE WHEN ""ap_cb""='cb' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""t"" GROUP BY ""month"",""country"""
25,"SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",COALESCE(SUM(""state""='approved'), 0) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",COALESCE(SUM(""state""='chargeback'), 0) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT ""trans_id"" AS ""id"",""country"",'chargeback' AS ""state"",""amount"",""b"".""trans_date"" FROM ""transactions"" AS ""a"" JOIN ""chargebacks"" AS ""b"" ON ""a"".""id""=""b"".""trans_id"" UNION SELECT * FROM ""transactions"" WHERE ""state""='approved') AS ""t"" GROUP BY 1,2"
26,"WITH ""u"" AS ((SELECT * FROM ""Transactions"" WHERE ""state""='approved') UNION ALL (SELECT ""t"".""id"",""country"",'chargebacks' AS ""state"",""amount"",""c"".""trans_date"" FROM ""Transactions"" AS ""t"" RIGHT JOIN ""Chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"")) SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",COUNT(CASE WHEN ""state""='approved' THEN 1 ELSE NULL END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",COUNT(CASE WHEN ""state""='chargebacks' THEN 1 ELSE NULL END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargebacks' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""u"" GROUP BY 1,2"
27,"WITH ""temp_table"" AS (SELECT *,SUBSTRING_INDEX(""trans_date"", '-', 2) AS ""month"" FROM ""transactions"" UNION ALL SELECT ""c"".""trans_id"" AS ""id"",""t"".""country"",'chargeback' AS ""state"",""t"".""amount"" AS ""amount"",""c"".""trans_date"" AS ""trans_date"",SUBSTRING_INDEX(""c"".""trans_date"", '-', 2) AS ""month"" FROM ""transactions"" AS ""t"" JOIN ""chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"") SELECT * FROM (SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='chargeback' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""temp_table"" GROUP BY ""month"",""country"" ORDER BY ""month"") AS ""a"" WHERE ""approved_count""+""approved_amount""+""chargeback_count""+""chargeback_amount"">0"
28,"WITH ""x"" AS (SELECT * FROM ""transactions"" WHERE ""state""='approved' UNION SELECT ""c"".""trans_id"" AS ""id"",""t"".""country"",'chargeback' AS ""state"",""t"".""amount"",""c"".""trans_date"" FROM ""chargebacks"" AS ""c"" JOIN ""transactions"" AS ""t"" ON ""t"".""id""=""c"".""trans_id"") SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",SUM(""state""='approved') AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(""state""='chargeback') AS ""chargeback_count"",SUM(CASE WHEN (""state""='chargeback') THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""x"" GROUP BY 1,2"
29,"WITH ""temp"" AS (SELECT * FROM ""Transactions"" UNION ALL SELECT ""c"".""trans_id"" AS ""id"",""t"".""country"",'chargeback' AS ""state"",""t"".""amount"",""c"".""trans_date"" FROM ""Transactions"" AS ""t"" RIGHT JOIN ""Chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"") SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='chargeback' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""temp"" GROUP BY EXTRACT(MONTH FROM ""trans_date""),""country"" HAVING ""approved_count""!=0 OR ""chargeback_count""!=0"
30,"WITH ""cte"" AS (SELECT ""id"",""country"",""state"",""amount"",""trans_date"" FROM ""Transactions"" UNION ALL SELECT ""c"".""trans_id"" AS ""id"",""t"".""country"",'chargebacks' AS ""state"",""t"".""amount"",""c"".""trans_date"" FROM ""Chargebacks"" AS ""c"" JOIN ""Transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"") SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='chargebacks' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargebacks' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""cte"" GROUP BY 1,2 HAVING ""approved_count""+""approved_amount""+""chargeback_count""+""chargeback_amount""!=0 ORDER BY 1,2"
31,"SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='chargeback' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT * FROM ""transactions"" AS ""t"" WHERE ""state""='approved' UNION SELECT ""t"".""id"",""t"".""country"",'chargeback',""t"".""amount"",""c"".""trans_date"" FROM ""chargebacks"" AS ""c"" LEFT JOIN ""transactions"" AS ""t"" ON ""t"".""id""=""c"".""trans_id"") AS ""tmp"" GROUP BY 1,2"
32,"WITH ""m"" AS (SELECT DISTINCT LEFT(""trans_date"", 7) AS ""month"" FROM ""Transactions"" UNION SELECT DISTINCT LEFT(""trans_date"", 7) AS ""month"" FROM ""Chargebacks""), ""a"" AS (SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",COUNT(""id"") AS ""approved_count"",SUM(""amount"") AS ""approved_amount"" FROM ""Transactions"" WHERE ""state""='approved' GROUP BY ""month"",""country""), ""c"" AS (SELECT LEFT(""c"".""trans_date"", 7) AS ""month"",""country"",COUNT(""trans_id"") AS ""chargeback_count"",SUM(""amount"") AS ""chargeback_amount"" FROM ""Chargebacks"" AS ""c"" JOIN ""Transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" GROUP BY ""month"",""country""), ""d"" AS (SELECT DISTINCT ""month"",""country"" FROM ""a"" UNION SELECT DISTINCT ""month"",""country"" FROM ""c"") SELECT ""d"".""month"",""d"".""country"",COALESCE(""approved_count"", 0) AS ""approved_count"",COALESCE(""approved_amount"", 0) AS ""approved_amount"",COALESCE(""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""chargeback_amount"", 0) AS ""chargeback_amount"" FROM (""d"" LEFT JOIN ""a"" ON ""d"".""month""=""a"".""month"" AND ""d"".""country""=""a"".""country"") LEFT JOIN ""c"" ON ""d"".""month""=""c"".""month"" AND ""d"".""country""=""c"".""country"""
33,"SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='chargeback' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT ""c"".""trans_id"",""t"".""country"",'chargeback' AS ""state"",""t"".""amount"",""c"".""trans_date"" FROM ""Chargebacks"" AS ""c"" JOIN ""Transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" UNION ALL SELECT * FROM ""Transactions"") AS ""t1"" GROUP BY ""country"",""month"" HAVING ""approved_amount"">0 OR ""chargeback_amount"">0"
34,"SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='declined' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='declined' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT LEFT(""chargebacks"".""trans_date"", 7) AS ""month"",""country"",'declined' AS ""state"",""amount"" FROM ""chargebacks"" JOIN ""transactions"" ON ""chargebacks"".""trans_id""=""transactions"".""id"" UNION ALL SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",""state"",""amount"" FROM ""transactions"" WHERE ""state""='approved') AS ""s"" GROUP BY ""month"",""country"""
35,"WITH ""ap"" AS (SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",COUNT(1) AS ""approved_count"",SUM(""amount"") AS ""approved_amount"" FROM ""transactions"" WHERE ""state""='approved' GROUP BY TO_CHAR(""trans_date"", 'YYYY-%m'),""country""), ""cb"" AS (SELECT TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"",""country"",COUNT(1) AS ""chargeback_count"",SUM(""amount"") AS ""chargeback_amount"" FROM ""chargebacks"" AS ""c"" JOIN ""transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" GROUP BY TO_CHAR(""c"".""trans_date"", 'YYYY-%m'),""country"") SELECT ""ap"".""month"" AS ""month"",""ap"".""country"" AS ""country"",""approved_count"",""approved_amount"",COALESCE(""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""ap"" LEFT JOIN ""cb"" ON ""ap"".""month""=""cb"".""month"" AND ""ap"".""country""=""cb"".""country"" UNION SELECT ""cb"".""month"" AS ""month"",""cb"".""country"" AS ""country"",COALESCE(""approved_count"", 0) AS ""approved_count"",COALESCE(""approved_amount"", 0) AS ""approved_amount"",""chargeback_count"",""chargeback_amount"" FROM ""ap"" RIGHT JOIN ""cb"" ON ""ap"".""month""=""cb"".""month"" AND ""ap"".""country""=""cb"".""country"""
36,"WITH ""main"" AS (SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",COUNT(""id"") AS ""approved_count"",SUM(""amount"") AS ""approved_amount"",0 AS ""chargeback_count"",0 AS ""chargeback_amount"" FROM ""Transactions"" WHERE ""state""='approved' GROUP BY ""month"",""country"" UNION SELECT LEFT(""C"".""trans_date"", 7) AS ""month"",""country"",0 AS ""approved_count"",0 AS ""approved_amount"",COUNT(""trans_id"") AS ""chargeback_count"",SUM(""amount"") AS ""chargeback_amount"" FROM ""Chargebacks"" AS ""C"" JOIN ""Transactions"" AS ""T"" ON ""C"".""trans_id""=""T"".""id"" GROUP BY ""month"",""country"") SELECT ""month"",""country"",SUM(""approved_count"") AS ""approved_count"",SUM(""approved_amount"") AS ""approved_amount"",SUM(""chargeback_count"") AS ""chargeback_count"",SUM(""chargeback_amount"") AS ""chargeback_amount"" FROM ""main"" GROUP BY ""month"",""country"""
37,"WITH ""u"" AS ((SELECT * FROM ""Transactions"" WHERE ""state""='approved') UNION ALL (SELECT ""t"".""id"",""country"",'chargebacks' AS ""state"",""amount"",""c"".""trans_date"" FROM ""Transactions"" AS ""t"" RIGHT JOIN ""Chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"")) SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",COUNT(CASE WHEN ""state""='approved' THEN 1 ELSE NULL END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",COUNT(CASE WHEN ""state""='chargebacks' THEN 1 ELSE NULL END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargebacks' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""u"" GROUP BY 1,2"
38,"SELECT ""month"",""country"",SUM(""state""='approved') AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(""state""='chargeback') AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",""state"",""amount"" FROM ""transactions"" WHERE ""state""='approved' UNION ALL SELECT LEFT(""c"".""trans_date"", 7) AS ""month"",""country"",'chargeback' AS ""state"",""amount"" FROM ""chargebacks"" AS ""c"" JOIN ""transactions"" AS ""t"" ON ""t"".""id""=""c"".""trans_id"") AS ""temp"" GROUP BY 1,2"
39,"SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='back' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='back' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"",""trans_id"",""country"",'back' AS ""state"",""amount"" FROM ""Chargebacks"" AS ""c"" LEFT JOIN ""Transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" UNION SELECT TO_CHAR(""t"".""trans_date"", 'YYYY-%m') AS ""month"",""id"" AS ""trans_id"",""country"",""state"",""amount"" FROM ""Transactions"" AS ""t"" WHERE ""state""='approved') AS ""tb1"" GROUP BY 1,2"
40,"SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='chargeback' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT ""c"".""trans_id"",""t"".""country"",'chargeback' AS ""state"",""t"".""amount"",""c"".""trans_date"" FROM ""Chargebacks"" AS ""c"" JOIN ""Transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" UNION ALL SELECT * FROM ""Transactions"") AS ""t1"" GROUP BY ""country"",""month"" HAVING ""approved_amount"">0 OR ""chargeback_amount"">0"
41,"SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='back' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='back' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT LEFT(""chargebacks"".""trans_date"", 7) AS ""month"",""country"",'back' AS ""state"",""amount"" FROM ""chargebacks"" LEFT JOIN ""transactions"" ON ""chargebacks"".""trans_id""=""transactions"".""id"" UNION ALL SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",""state"",""amount"" FROM ""transactions"" WHERE ""state""='approved') AS ""s"" GROUP BY ""month"",""country"""
42,"SELECT SUBSTR(""trans_date"", 1, 7) AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='chargeback' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT ""T1"".* FROM ""Transactions"" AS ""T1"" WHERE ""state""='approved' UNION ALL SELECT ""C"".""trans_id"",""T2"".""country"",'chargeback',""T2"".""amount"",""C"".""trans_date"" FROM ""Chargebacks"" AS ""C"" LEFT JOIN ""Transactions"" AS ""T2"" ON ""id""=""trans_id"") AS ""temp"" GROUP BY 1,2"
43,"SELECT TO_CHAR(CASE WHEN ""trans_date"" IS NULL THEN ""chargeback_date"" ELSE ""trans_date"" END, 'YYYY-%m') AS ""month"",""country"",SUM(CASE WHEN ""chargeback_date"" IS NULL THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""chargeback_date"" IS NULL THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""trans_date"" IS NULL THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""trans_date"" IS NULL THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT ""a"".""id"",""a"".""country"",""a"".""state"",""a"".""amount"",""a"".""trans_date"",NULL AS ""chargeback_date"" FROM ""transactions"" AS ""a"" WHERE ""state""='approved' UNION SELECT ""a"".""id"",""a"".""country"",""a"".""state"",""a"".""amount"",NULL,""b"".""trans_date"" AS ""chargeback_date"" FROM ""transactions"" AS ""a"" RIGHT JOIN ""chargebacks"" AS ""b"" ON ""a"".""id""=""b"".""trans_id"") AS ""a"" GROUP BY 1,2"
44,"SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='chargeback' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"",""country"",'chargeback' AS ""state"",""amount"" FROM ""Chargebacks"" AS ""c"" JOIN ""Transactions"" AS ""t"" ON ""t"".""id""=""c"".""trans_id"" UNION ALL SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",""state"",""amount"" FROM ""Transactions"" WHERE ""state""='approved') AS ""a"" GROUP BY ""month"",""country"""
45,"WITH ""CTE1"" AS (SELECT SUBSTR(""trans_date"", 1, 7) AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"" FROM ""Transactions"" GROUP BY SUBSTR(""trans_date"", 1, 7),""country""), ""CTE2"" AS (SELECT ""country"",""amount"",SUBSTR(""Chargebacks"".""trans_date"", 1, 7) AS ""month"" FROM ""Transactions"" JOIN ""Chargebacks"" ON ""Transactions"".""id""=""Chargebacks"".""trans_id""), ""CTE3"" AS (SELECT ""month"",""country"",COUNT(1) AS ""chargeback_count"",SUM(""amount"") AS ""chargeback_amount"" FROM ""CTE2"" GROUP BY ""month"",""country""), ""mt"" AS (SELECT ""month"",""country"" FROM ""CTE1"" UNION SELECT ""month"",""country"" FROM ""CTE3""), ""F"" AS (SELECT ""mt"".""month"",""mt"".""country"",COALESCE(""CTE1"".""approved_count"", 0) AS ""approved_count"",COALESCE(""CTE1"".""approved_amount"", 0) AS ""approved_amount"" FROM ""mt"" LEFT JOIN ""CTE1"" ON ""mt"".""month""=""CTE1"".""month"" AND ""mt"".""country""=""CTE1"".""COUNTRY""), ""G"" AS (SELECT ""F"".*,COALESCE(""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""F"" LEFT JOIN ""CTE3"" ON ""F"".""month""=""CTE3"".""month"" AND ""F"".""country""=""CTE3"".""country"") SELECT * FROM ""G"" WHERE ""approved_amount""!=0 OR ""chargeback_amount""!=0"
46,"WITH ""union_cte"" AS (SELECT * FROM ""Transactions"" UNION SELECT ""t"".""id"",""t"".""country"",CASE WHEN ""t"".""state"" THEN 'chargeback' END AS ""state"",""t"".""amount"",""c"".""trans_date"" FROM ""Transactions"" AS ""t"" JOIN ""Chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id""), ""final_cte"" AS (SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",COUNT(CASE WHEN ""state""='approved' THEN ""state"" END) AS ""approved_count"",COALESCE(SUM(CASE WHEN ""state""='approved' THEN ""amount"" END), 0) AS ""approved_amount"",COUNT(CASE WHEN ""state""='chargeback' THEN ""state"" END) AS ""chargeback_count"",COALESCE(SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" END), 0) AS ""chargeback_amount"" FROM ""union_cte"" GROUP BY ""month"",""country"") SELECT * FROM ""final_cte"" WHERE ""approved_count""!=0 OR ""approved_amount""!=0 OR ""chargeback_count""!=0 OR ""chargeback_amount""!=0"
47,"WITH ""temp_table"" AS (SELECT *,SUBSTRING_INDEX(""trans_date"", '-', 2) AS ""month"" FROM ""transactions"" UNION ALL SELECT ""c"".""trans_id"" AS ""id"",""t"".""country"",'chargeback' AS ""state"",""t"".""amount"" AS ""amount"",""c"".""trans_date"" AS ""trans_date"",SUBSTRING_INDEX(""c"".""trans_date"", '-', 2) AS ""month"" FROM ""transactions"" AS ""t"" JOIN ""chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"") SELECT * FROM (SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='chargeback' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""temp_table"" GROUP BY ""month"",""country"" ORDER BY ""month"") AS ""a"" WHERE ""approved_count""+""approved_amount""+""chargeback_count""+""chargeback_amount"">0"
48,"WITH ""all_info"" AS (SELECT TO_CHAR(""t"".""trans_date"", 'YYYY-%m') AS ""month"",""country"",""state"",""amount"" FROM ""transactions"" AS ""t"" WHERE ""state""='approved' UNION ALL SELECT TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"",""t1"".""country"",'chargeback' AS ""state"",""t1"".""amount"" FROM ""chargebacks"" AS ""c"" JOIN ""transactions"" AS ""t1"" ON ""c"".""trans_id""=""t1"".""id"") SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='chargeback' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""all_info"" GROUP BY ""month"",""country"""
49,"SELECT SUBSTRING(""trans_date"", 1, 7) AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(""chargeback"") AS ""chargeback_count"",SUM(CASE WHEN ""chargeback""=1 THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT *,0 AS ""chargeback"" FROM ""Transactions"" UNION ALL SELECT ""id"",""country"",'chargeback' AS ""state"",""amount"",""C"".""trans_date"",1 AS ""chargeback"" FROM ""Transactions"" AS ""T"" JOIN ""Chargebacks"" AS ""C"" ON ""C"".""trans_id""=""T"".""id"" ORDER BY ""trans_date"") AS ""tmp"" GROUP BY SUBSTRING(""trans_date"", 1, 7),""country"" HAVING ""approved_count""!=0 OR ""approved_amount""!=0 OR ""chargeback_count""!=0 OR ""chargeback_amount""!=0"
50,"WITH ""cb"" AS (SELECT ""trans_id"" AS ""id"",""t"".""country"",'chargeback' AS ""state"",""t"".""amount"" AS ""amount"",""c"".""trans_date"" FROM ""Chargebacks"" AS ""c"" JOIN ""Transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id""), ""combined"" AS (SELECT * FROM ""Transactions"" UNION SELECT * FROM ""cb"") SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(""state""='approved') AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(""state""='chargeback') AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""combined"" GROUP BY ""month"",""country"" HAVING ""approved_count"">0 OR ""chargeback_count"">0"
51,"WITH ""comb_data"" AS (SELECT ""trans_id"",""country"",'chargeback' AS ""state"",""amount"",""c"".""trans_date"" FROM (""Transactions"" AS ""t"") CROSS JOIN ""Chargebacks"" AS ""c"" WHERE ""t"".""id""=""c"".""trans_id"" UNION ALL SELECT * FROM ""Transactions"") SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='chargeback' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""comb_data"" GROUP BY ""month"",""country"" HAVING ""approved_amount"">0 OR ""chargeback_amount"">0"
52,"WITH ""cte1"" AS (SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"" FROM ""transactions"" GROUP BY ""month"",""country""), ""cte2"" AS (SELECT TO_CHAR(""chargebacks"".""trans_date"", 'YYYY-%m') AS ""month"",""transactions"".""country"",COUNT(""transactions"".""id"") AS ""chargeback_count"",SUM(""transactions"".""amount"") AS ""chargeback_amount"" FROM ""chargebacks"" JOIN ""transactions"" ON ""chargebacks"".""trans_id""=""transactions"".""id"" GROUP BY ""month"",""country"") (SELECT ""c2"".""month"",""c2"".""country"",COALESCE(""c1"".""approved_count"", 0) AS ""approved_count"",COALESCE(""c1"".""approved_amount"", 0) AS ""approved_amount"",""c2"".""chargeback_count"",""c2"".""chargeback_amount"" FROM ""cte1"" AS ""c1"" RIGHT JOIN ""cte2"" AS ""c2"" ON (""c1"".""month""=""c2"".""month"" AND ""c1"".""country""=""c2"".""country"")) UNION (SELECT ""c1"".""month"",""c1"".""country"",""c1"".""approved_count"",""c1"".""approved_amount"",COALESCE(""c2"".""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""c2"".""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""cte1"" AS ""c1"" LEFT JOIN ""cte2"" AS ""c2"" ON (""c1"".""month""=""c2"".""month"" AND ""c1"".""country""=""c2"".""country"") WHERE ""c1"".""approved_count""!=0) ORDER BY ""month"",""country"""
53,"SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"" AS ""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='chargeback' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT ""c"".""trans_id"",""c"".""trans_date"",""t"".""country"",'chargeback' AS ""state"",""t"".""amount"" FROM ""Transactions"" AS ""t"" JOIN ""Chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"" UNION ALL SELECT ""id"",""trans_date"",""country"",""state"",""amount"" FROM ""Transactions"" WHERE ""state""='approved') AS ""lv1"" GROUP BY TO_CHAR(""trans_date"", 'YYYY-%m'),""country"""
54,"SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='back' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='back' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT LEFT(""c"".""trans_date"", 7) AS ""month"",'back' AS ""state"",""amount"",""country"" FROM ""Chargebacks"" AS ""c"" JOIN ""Transactions"" AS ""t"" ON ""t"".""id""=""c"".""trans_id"" UNION ALL SELECT LEFT(""trans_date"", 7) AS ""month"",""state"",""amount"",""country"" FROM ""Transactions"" WHERE ""state""='approved') AS ""t"" GROUP BY 1,2"
55,"SELECT ""tr"".""month"",""tr"".""country"",""tr"".""count_tr"" AS ""approved_count"",""tr"".""total_tr"" AS ""approved_amount"",COALESCE(""cb"".""count_cb"", 0) AS ""chargeback_count"",COALESCE(""cb"".""total_cb"", 0) AS ""chargeback_amount"" FROM (SELECT ""country"",COUNT(""amount"") AS ""count_tr"",SUM(""amount"") AS ""total_tr"",LEFT(""trans_date"", 7) AS ""month"" FROM ""transactions"" WHERE ""state""='approved' GROUP BY ""country"",""month"") AS ""tr"" LEFT JOIN (SELECT ""t"".""country"",COUNT(""t"".""amount"") AS ""count_cb"",SUM(""t"".""amount"") AS ""total_cb"",LEFT(""c"".""trans_date"", 7) AS ""month"" FROM ""transactions"" AS ""t"" JOIN ""chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"" GROUP BY ""t"".""country"",""month"") AS ""cb"" ON (""tr"".""month""=""cb"".""month"" AND ""tr"".""country""=""cb"".""country"") UNION SELECT ""cb"".""month"",""cb"".""country"",COALESCE(""tr"".""count_tr"", 0) AS ""approved_count"",COALESCE(""tr"".""total_tr"", 0) AS ""approved_amount"",""cb"".""count_cb"" AS ""chargeback_count"",""cb"".""total_cb"" AS ""chargeback_amount"" FROM (SELECT ""country"",COUNT(""amount"") AS ""count_tr"",SUM(""amount"") AS ""total_tr"",LEFT(""trans_date"", 7) AS ""month"" FROM ""transactions"" WHERE ""state""='approved' GROUP BY ""country"",""month"") AS ""tr"" RIGHT JOIN (SELECT ""t"".""country"",COUNT(""t"".""amount"") AS ""count_cb"",SUM(""t"".""amount"") AS ""total_cb"",LEFT(""c"".""trans_date"", 7) AS ""month"" FROM ""transactions"" AS ""t"" JOIN ""chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"" GROUP BY ""t"".""country"",""month"") AS ""cb"" ON (""tr"".""month""=""cb"".""month"" AND ""tr"".""country""=""cb"".""country"")"
56,"SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(""state""='approved') AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(""state""='chargeback') AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ((SELECT ""id"",""country"",""state"",""amount"",""trans_date"" FROM ""transactions"") UNION ALL (SELECT ""t"".""id"",""t"".""country"",'chargeback' AS ""state"",""t"".""amount"",""c"".""trans_date"" FROM ""transactions"" AS ""t"" JOIN ""chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"")) AS ""a"" GROUP BY TO_CHAR(""trans_date"", 'YYYY-%m'),""country"" HAVING SUM(""state""='approved')>0 OR SUM(""state""='chargeback')>0"
57,"SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='back' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='back' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT LEFT(""chargebacks"".""trans_date"", 7) AS ""month"",""country"",'back' AS ""state"",""amount"" FROM ""chargebacks"" JOIN ""transactions"" ON ""chargebacks"".""trans_id""=""transactions"".""id"" UNION ALL SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",""state"",""amount"" FROM ""transactions"" WHERE ""state""='approved') AS ""s"" GROUP BY ""month"",""country"""
58,"SELECT ""g"".""month"" AS ""month"",""c"".""country"",SUM(CASE WHEN ""c"".""state""='approved' AND SUBSTR(""c"".""trans_date"", 1, 7)=""g"".""month"" THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""c"".""state""='approved' AND SUBSTR(""c"".""trans_date"", 1, 7)=""g"".""month"" THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN SUBSTR(""d"".""trans_date"", 1, 7)=""g"".""month"" THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN SUBSTR(""d"".""trans_date"", 1, 7)=""g"".""month"" THEN ""c"".""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (""Transactions"" AS ""c"" LEFT JOIN ""Chargebacks"" AS ""d"" ON ""c"".""id""=""d"".""trans_id"") CROSS JOIN (SELECT SUBSTR(""a"".""trans_date"", 1, 7) AS ""month"" FROM ""Transactions"" AS ""a"" UNION SELECT SUBSTR(""b"".""trans_date"", 1, 7) FROM ""Chargebacks"" AS ""b"") AS ""g"" GROUP BY ""g"".""month"",""c"".""country"" HAVING ""approved_count""!=0 OR ""approved_amount""!=0 OR ""chargeback_count""!=0 OR ""chargeback_amount""!=0"
59,"SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='back' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='back' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",'approved' AS ""state"",""amount"" FROM ""Transactions"" WHERE ""state""='approved' UNION ALL SELECT LEFT(""c"".""trans_date"", 7) AS ""month"",""t"".""country"",'back' AS ""state"",""t"".""amount"" FROM ""Transactions"" AS ""t"" JOIN ""Chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"") AS ""t"" GROUP BY 1,2"
60,"WITH ""all_months"" AS (SELECT DISTINCT ""country"",TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"" FROM ""transactions"" UNION SELECT DISTINCT ""t"".""country"",TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"" FROM ""chargebacks"" AS ""c"" JOIN ""transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id""), ""trans_sum"" AS (SELECT ""id"" AS ""trans_id"",TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",""amount"" FROM ""transactions"" WHERE ""state""='approved'), ""cb_sum"" AS (SELECT ""c"".""trans_id"",""t"".""amount"" AS ""chargeback_amount"",""t"".""country"",TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"" FROM ""chargebacks"" AS ""c"" JOIN ""transactions"" AS ""t"" ON ""t"".""id""=""c"".""trans_id"") SELECT ""month"",""country"",COALESCE(""approved_count"", 0) AS ""approved_count"",COALESCE(""approved_amount"", 0) AS ""approved_amount"",COALESCE(""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""chargeback_amount"", 0) AS ""chargeback_amount"" FROM (SELECT ""a"".""month"",""a"".""country"",""approved_count"" AS ""approved_count"",""approved_amount"" AS ""approved_amount"",COUNT(DISTINCT ""c"".""trans_id"") AS ""chargeback_count"",SUM(""chargeback_amount"") AS ""chargeback_amount"" FROM (SELECT ""a"".""month"",""a"".""country"",COUNT(DISTINCT ""t"".""trans_id"") AS ""approved_count"",SUM(""t"".""amount"") AS ""approved_amount"" FROM ""all_months"" AS ""a"" LEFT JOIN ""trans_sum"" AS ""t"" ON ""t"".""month""=""a"".""month"" AND ""t"".""country""=""a"".""country"" GROUP BY 1,2) AS ""a"" LEFT JOIN ""cb_sum"" AS ""c"" ON ""c"".""month""=""a"".""month"" AND ""c"".""country""=""a"".""country"" GROUP BY 1,2,3,4) AS ""result_table"" WHERE ""approved_count""+""chargeback_count""!=0"
61,"SELECT SUBSTRING(""trans_date"", 1, 7) AS ""month"",""country"",SUM(""state""='approved') AS ""approved_count"",COALESCE(SUM(CASE ""state"" WHEN 'approved' THEN ""amount"" END), 0) AS ""approved_amount"",SUM(""state""='chargeback') AS ""chargeback_count"",COALESCE(SUM(CASE ""state"" WHEN 'chargeback' THEN ""amount"" END), 0) AS ""chargeback_amount"" FROM (SELECT * FROM ""Transactions"" UNION (SELECT ""id"",""country"",'chargeback' AS ""state"",""amount"",""c"".""trans_date"" AS ""trans_date"" FROM ""Chargebacks"" AS ""c"" JOIN ""Transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"")) AS ""combine"" GROUP BY ""month"",""country"" HAVING (SUM(""state""='approved')+SUM(""state""='chargeback'))>0"
62,"WITH ""cte"" AS (SELECT TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"",""t"".""country"",0 AS ""state"",""t"".""amount"" FROM ""transactions"" AS ""t"" JOIN ""chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"" UNION ALL SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",1 AS ""state"",""amount"" FROM ""transactions"" WHERE ""state""='approved') SELECT ""month"",""country"",SUM(""state"") AS ""approved_count"",SUM(""amount""*""state"") AS ""approved_amount"",COUNT(""state"")-SUM(""state"") AS ""chargeback_count"",SUM(""amount"")-SUM(""amount""*""state"") AS ""chargeback_amount"" FROM ""cte"" GROUP BY 1,2 ORDER BY ""month"""
63,"WITH RECURSIVE ""a"" AS (SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_acount"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"" FROM ""Transactions"" GROUP BY TO_CHAR(""trans_date"", 'YYYY-%m'),""country""), ""b"" AS (SELECT TO_CHAR(""b"".""trans_date"", 'YYYY-%m') AS ""cb_month"",""a"".""country"" AS ""cb_country"",COUNT(""b"".""trans_id"") AS ""chargeback_count"",SUM(""a"".""amount"") AS ""chargeback_amount"" FROM ""Chargebacks"" AS ""b"" LEFT JOIN ""Transactions"" AS ""a"" ON ""b"".""trans_id""=""a"".""id"" GROUP BY TO_CHAR(""b"".""trans_date"", 'YYYY-%m'),""a"".""country"") SELECT ""m"".""month"",""m"".""country"",COALESCE(""a"".""approved_acount"", 0) AS ""approved_count"",COALESCE(""a"".""approved_amount"", 0) AS ""approved_amount"",COALESCE(""b"".""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""b"".""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ((SELECT ""month"",""country"" FROM ""a"" UNION SELECT ""cb_month"",""cb_country"" FROM ""b"") AS ""m"" LEFT JOIN ""a"" ON ""m"".""month""=""a"".""month"" AND ""m"".""country""=""a"".""country"") LEFT JOIN ""b"" ON ""m"".""month""=""b"".""cb_month"" AND ""m"".""country""=""b"".""cb_country"" WHERE COALESCE(""a"".""approved_acount"", 0)!=0 OR COALESCE(""b"".""chargeback_count"", 0)!=0"
64,"WITH ""cte"" AS (SELECT TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"",""t"".""country"",0 AS ""state"",0 AS ""amountstate"",""t"".""amount"" AS ""amount"" FROM ""transactions"" AS ""t"" JOIN ""chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"" UNION ALL SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",1 AS ""state"",""amount"" AS ""amountstate"",0 AS ""amount"" FROM ""transactions"" WHERE ""state""='approved') SELECT ""month"",""country"",SUM(""state"") AS ""approved_count"",SUM(""amountstate"") AS ""approved_amount"",COUNT(""state"")-SUM(""state"") AS ""chargeback_count"",SUM(""amount"") AS ""chargeback_amount"" FROM ""cte"" GROUP BY 1,2 ORDER BY ""month"""
65,"WITH ""u"" AS ((SELECT * FROM ""Transactions"" WHERE ""state""='approved') UNION ALL (SELECT ""t"".""id"",""country"",'chargebacks' AS ""state"",""amount"",""c"".""trans_date"" FROM ""Transactions"" AS ""t"" RIGHT JOIN ""Chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"")) SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",COUNT(CASE WHEN ""state""='approved' THEN 1 ELSE NULL END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",COUNT(CASE WHEN ""state""='chargebacks' THEN 1 ELSE NULL END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargebacks' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""u"" GROUP BY 1,2"
66,"WITH ""approved_trans"" AS (SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"" FROM ""Transactions"" GROUP BY 1,2), ""chargeback_trans"" AS (SELECT TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"",""t"".""country"",COUNT(""c"".""trans_id"") AS ""chargeback_count"",SUM(""t"".""amount"") AS ""chargeback_amount"" FROM ""Chargebacks"" AS ""c"" LEFT JOIN ""Transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" GROUP BY 1,2) SELECT * FROM (SELECT ""a"".""month"",""a"".""country"",COALESCE(""a"".""approved_count"", 0) AS ""approved_count"",COALESCE(""a"".""approved_amount"", 0) AS ""approved_amount"",COALESCE(""b"".""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""b"".""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""approved_trans"" AS ""a"" LEFT JOIN ""chargeback_trans"" AS ""b"" ON ""a"".""month""=""b"".""month"" AND ""a"".""country""=""b"".""country"" UNION SELECT ""b"".""month"",""b"".""country"",COALESCE(""a"".""approved_count"", 0) AS ""approved_count"",COALESCE(""a"".""approved_amount"", 0) AS ""approved_amount"",COALESCE(""b"".""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""b"".""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""approved_trans"" AS ""a"" RIGHT JOIN ""chargeback_trans"" AS ""b"" ON ""a"".""month""=""b"".""month"" AND ""a"".""country""=""b"".""country"") AS ""sub"" WHERE ""approved_count""+""chargeback_count"">0"
67,"WITH ""ChargeDet"" AS (SELECT ""t"".""id"",""t"".""country"",""t"".""amount"",TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"" FROM ""Transactions"" AS ""t"" JOIN ""Chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id""), ""ApproveTransDet"" AS (SELECT ""id"",""country"",""amount"",TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"" FROM ""Transactions"" WHERE ""state""='approved'), ""Summary"" AS (SELECT ""month"",""country"",COUNT(1) AS ""approved_count"",SUM(""amount"") AS ""approved_amount"",'approved' AS ""type"" FROM ""ApproveTransDet"" GROUP BY ""month"",""country"" UNION ALL SELECT ""month"",""country"",COUNT(1) AS ""chargeback_count"",SUM(""amount"") AS ""chargeback_amount"",'chargebacks' AS ""type"" FROM ""ChargeDet"" GROUP BY ""month"",""country"") SELECT ""month"",""country"",SUM(CASE WHEN ""type""='approved' THEN ""approved_count"" ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""type""='approved' THEN ""approved_amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""type""='chargebacks' THEN ""approved_count"" ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""type""='chargebacks' THEN ""approved_amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""summary"" GROUP BY ""month"",""country"" ORDER BY ""month"""
68,"WITH ""approved"" AS (SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",COUNT(DISTINCT ""id"") AS ""approved_count"",SUM(""amount"") AS ""approved_amount"" FROM ""transactions"" GROUP BY ""country"",""month"",""state"" HAVING ""state""='approved'), ""charged"" AS (SELECT ""month"",""country"",COUNT(DISTINCT ""id"") AS ""chargeback_count"",SUM(""amount"") AS ""chargeback_amount"" FROM (SELECT ""t"".""id"",TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"",""t"".""country"",""t"".""amount"" FROM ""chargebacks"" AS ""c"" JOIN ""transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"") AS ""sub"" GROUP BY ""month"",""country"") SELECT ""a"".""month"",""a"".""country"",""a"".""approved_count"",""a"".""approved_amount"",COALESCE(""c"".""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""c"".""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""approved"" AS ""a"" LEFT JOIN ""charged"" AS ""c"" ON ""a"".""month""=""c"".""month"" AND ""a"".""country""=""c"".""country"" UNION SELECT ""c"".""month"",""c"".""country"",COALESCE(""a"".""approved_count"", 0) AS ""approved_count"",COALESCE(""a"".""approved_amount"", 0) AS ""approved_amount"",""c"".""chargeback_count"",""c"".""chargeback_amount"" FROM ""approved"" AS ""a"" RIGHT JOIN ""charged"" AS ""c"" ON ""a"".""month""=""c"".""month"" AND ""a"".""country""=""c"".""country"""
69,"SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",SUM(""state""='approved') AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(""state""='chargeback') AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT ""t"".""id"",""country"",""state"",""amount"",""t"".""trans_date"" FROM ""Transactions"" AS ""t"" LEFT JOIN ""ChargeBacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"" UNION SELECT ""c"".""trans_id"",""country"",'chargeback',""amount"",""c"".""trans_date"" FROM ""Transactions"" AS ""t"" RIGHT JOIN ""Chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"") AS ""temp"" GROUP BY ""month"",""country"" HAVING ""approved_count""+""approved_amount""+""chargeback_count""+""chargeback_amount""!=0"
70,"WITH ""CTE"" AS (SELECT ""id"",""state"",""amount"",""trans_date"",""country"" FROM ""transactions"" AS ""t"" WHERE ""state""='approved' UNION ALL SELECT ""trans_id"",'chargebacks' AS ""state"",""amount"",""c"".""trans_date"",""country"" FROM ""chargebacks"" AS ""c"" JOIN ""transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"") SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",COALESCE(SUM(CASE WHEN ""state""='approved' THEN 1 END), 0) AS ""approved_count"",COALESCE(SUM(CASE WHEN ""state""='approved' THEN ""amount"" END), 0) AS ""approved_amount"",COALESCE(SUM(CASE WHEN ""state""='chargebacks' THEN 1 END), 0) AS ""chargeback_count"",COALESCE(SUM(CASE WHEN ""state""='chargebacks' THEN ""amount"" END), 0) AS ""chargeback_amount"" FROM ""CTE"" GROUP BY 1,2 ORDER BY 1"
71,"SELECT ""month"",""country"",SUM(""approved_count"") AS ""approved_count"",SUM(""approved_amount"") AS ""approved_amount"",SUM(""chargeback_count"") AS ""chargeback_count"",SUM(""chargeback_amount"") AS ""chargeback_amount"" FROM (SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",COUNT(1) AS ""approved_count"",SUM(""amount"") AS ""approved_amount"",0 AS ""chargeback_count"",0 AS ""chargeback_amount"" FROM ""Transactions"" WHERE ""state""='approved' GROUP BY ""month"",""country"" UNION ALL SELECT LEFT(""c"".""trans_date"", 7) AS ""month"",""t"".""country"" AS ""country"",0 AS ""approved_count"",0 AS ""approved_amount"",COUNT(1) AS ""chargeback_count"",SUM(""amount"") AS ""chargeback_amount"" FROM ""Chargebacks"" AS ""c"" JOIN ""Transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" GROUP BY ""month"",""country"") AS ""tab"" GROUP BY ""month"",""country"""
72,"SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",SUM(""state""='approved') AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(""state""='chargebacks') AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargebacks' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ((SELECT * FROM ""Transactions"" WHERE ""state""='approved') UNION ALL (SELECT ""a"".""id"",""country"",'chargebacks' AS ""state"",""amount"",""b"".""trans_date"" FROM ""Transactions"" AS ""a"" RIGHT JOIN ""Chargebacks"" AS ""b"" ON ""a"".""id""=""b"".""trans_id"")) AS ""c"" GROUP BY 1,2"
73,"SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='back' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='back' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT LEFT(""chargebacks"".""trans_date"", 7) AS ""month"",""country"",'back' AS ""state"",""amount"" FROM ""chargebacks"" JOIN ""transactions"" ON ""chargebacks"".""trans_id""=""transactions"".""id"" UNION ALL SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",""state"",""amount"" FROM ""transactions"" WHERE ""state""='approved') AS ""s"" GROUP BY ""month"",""country"""
74,"SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='back' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='back' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT ""id"",""country"",'back' AS ""state"",""amount"",""C"".""trans_date"" FROM ""Transactions"" AS ""T"" JOIN ""Chargebacks"" AS ""C"" ON ""T"".""id""=""C"".""trans_id"" UNION ALL SELECT ""id"",""country"",""state"",""amount"",""trans_date"" FROM ""Transactions"" WHERE ""state""='approved') AS ""tbl"" GROUP BY 1,2 ORDER BY 1,2"
75,"SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='CB' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='CB' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT ""id"",""country"",'CB' AS ""state"",""amount"",""c"".""trans_date"" FROM ""transactions"" AS ""t"" RIGHT JOIN ""chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"" UNION ALL SELECT * FROM ""transactions"") AS ""a"" GROUP BY 1,2 HAVING ""approved_count""+""approved_amount""+""chargeback_count""+""chargeback_amount""!=0"
76,"SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='chargeback' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT ""a"".""trans_id"" AS ""id"",""b"".""country"" AS ""country"",'chargeback' AS ""state"",""b"".""amount"" AS ""amount"",""a"".""trans_date"" AS ""trans_date"" FROM ""chargebacks"" AS ""a"" LEFT JOIN ""transactions"" AS ""b"" ON ""a"".""trans_id""=""b"".""id"" UNION ALL SELECT * FROM ""transactions"") AS ""a"" GROUP BY 1,2 HAVING ROW(""approved_count"",""approved_amount"",""chargeback_count"",""chargeback_amount"")!=ROW(0,0,0,0)"
77,"SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='back' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='back' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT ""C"".""trans_date"",""country"",'back' AS ""state"",""amount"" FROM ""Chargebacks"" AS ""C"" JOIN ""Transactions"" AS ""T"" ON ""C"".""trans_id""=""T"".""id"" UNION SELECT ""trans_date"",""country"",""state"",""amount"" FROM ""Transactions"" AS ""T"" WHERE ""state""='approved') AS ""new"" GROUP BY ""month"",""country"""
78,"WITH ""all_months"" AS (SELECT DISTINCT ""country"",TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"" FROM ""transactions"" UNION SELECT DISTINCT ""t"".""country"",TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"" FROM ""chargebacks"" AS ""c"" JOIN ""transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id""), ""trans_sum"" AS (SELECT ""id"" AS ""trans_id"",TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",""amount"" FROM ""transactions"" WHERE ""state""='approved'), ""cb_sum"" AS (SELECT ""c"".""trans_id"",""t"".""country"",TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"",""t"".""amount"" AS ""chargeback_amount"" FROM ""chargebacks"" AS ""c"" JOIN ""transactions"" AS ""t"" ON ""t"".""id""=""c"".""trans_id"") SELECT ""month"",""country"",COALESCE(""approved_count"", 0) AS ""approved_count"",COALESCE(""approved_amount"", 0) AS ""approved_amount"",COALESCE(""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""chargeback_amount"", 0) AS ""chargeback_amount"" FROM (SELECT ""a"".""month"",""a"".""country"",""approved_count"",""approved_amount"",COUNT(DISTINCT ""c"".""trans_id"") AS ""chargeback_count"",SUM(""chargeback_amount"") AS ""chargeback_amount"" FROM (SELECT ""a"".""month"",""a"".""country"",COUNT(DISTINCT ""t"".""trans_id"") AS ""approved_count"",SUM(""t"".""amount"") AS ""approved_amount"" FROM ""all_months"" AS ""a"" LEFT JOIN ""trans_sum"" AS ""t"" ON ""t"".""month""=""a"".""month"" AND ""t"".""country""=""a"".""country"" GROUP BY 1,2) AS ""a"" LEFT JOIN ""cb_sum"" AS ""c"" ON ""c"".""month""=""a"".""month"" AND ""c"".""country""=""a"".""country"" GROUP BY 1,2,3,4) AS ""result_table"" WHERE ""approved_count""+""chargeback_count""!=0"
79,"SELECT ""T1"".""month"",""T1"".""country"",SUM(""approved_count"") AS ""approved_count"",SUM(""approved_amount"") AS ""approved_amount"",SUM(""chargeback_count"") AS ""chargeback_count"",SUM(""chargeback_amount"") AS ""chargeback_amount"" FROM (SELECT LEFT(""C"".""trans_date"", 7) AS ""month"",""country"",0 AS ""approved_count"",0 AS ""approved_amount"",COUNT(""amount"") AS ""chargeback_count"",SUM(""amount"") AS ""chargeback_amount"" FROM ""Transactions"" AS ""T"" RIGHT JOIN ""Chargebacks"" AS ""C"" ON ""T"".""id""=""C"".""trans_id"" GROUP BY 1,2 UNION ALL SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",COUNT(""amount""),SUM(""amount""),0,0 FROM ""Transactions"" WHERE ""state""='approved' GROUP BY 1,2) AS ""T1"" GROUP BY 1,2"
80,"SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='chargeback' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT * FROM ""transactions"" UNION SELECT ""c"".""trans_id"" AS ""id"",""t"".""country"",'chargeback' AS ""state"",""t"".""amount"",""c"".""trans_date"" FROM ""chargebacks"" AS ""c"" JOIN ""transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"") AS ""a"" GROUP BY 1,2 HAVING NOT (""approved_count""=0 AND ""approved_amount""=0 AND ""chargeback_count""=0 AND ""chargeback_amount""=0)"
81,"WITH ""t"" AS (SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",""amount"",'ap' AS ""ap_cb"" FROM ""transactions"" WHERE ""state""='approved' UNION ALL SELECT TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"",""country"",""amount"",'cb' AS ""ap_cb"" FROM ""chargebacks"" AS ""c"" JOIN ""transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"") SELECT ""month"",""country"",COUNT(CASE WHEN ""ap_cb""='ap' THEN 1 ELSE NULL END) AS ""approved_count"",SUM(CASE WHEN ""ap_cb""='ap' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",COUNT(CASE WHEN ""ap_cb""='cb' THEN 1 ELSE NULL END) AS ""chargeback_count"",SUM(CASE WHEN ""ap_cb""='cb' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""t"" GROUP BY ""month"",""country"""
82,"WITH ""cte1"" AS (SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",COUNT(""id"") AS ""approved_count"",SUM(""amount"") AS ""approved_amount"" FROM ""transactions"" WHERE ""state""='approved' GROUP BY 1,2), ""cte2"" AS (SELECT TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"",""t"".""country"",COUNT(""c"".""trans_id"") AS ""chargeback_count"",SUM(""t"".""amount"") AS ""chargeback_amount"" FROM ""chargebacks"" AS ""c"" JOIN ""transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" GROUP BY 1,2) (SELECT ""c1"".""month"",""c1"".""country"",""c1"".""approved_count"",""c1"".""approved_amount"",COALESCE(""c2"".""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""c2"".""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""cte1"" AS ""c1"" LEFT JOIN ""cte2"" AS ""c2"" ON ""c1"".""month""=""c2"".""month"" AND ""c1"".""country""=""c2"".""country"") UNION (SELECT ""c2"".""month"",""c2"".""country"",COALESCE(""c1"".""approved_count"", 0) AS ""approved_count"",COALESCE(""c1"".""approved_amount"", 0) AS ""approved_amount"",""c2"".""chargeback_count"",""c2"".""chargeback_amount"" FROM ""cte2"" AS ""c2"" LEFT JOIN ""cte1"" AS ""c1"" ON ""c1"".""month""=""c2"".""month"" AND ""c1"".""country""=""c2"".""country"")"
83,"SELECT SUBSTRING(""sub"".""trans_date"", 1, 7) AS ""month"",""country"",SUM(CASE WHEN ""sub"".""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""sub"".""state""='approved' THEN ""sub"".""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""sub"".""state""='charge_back' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""sub"".""state""='charge_back' THEN ""sub"".""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT * FROM ""Transactions"" UNION ALL SELECT ""C"".""trans_id"" AS ""id"",""T"".""country"",'charge_back' AS ""status"",""T"".""amount"" AS ""amount"",""C"".""trans_date"" FROM ""Chargebacks"" AS ""C"" JOIN ""Transactions"" AS ""T"" ON ""C"".""trans_id""=""T"".""id"") AS ""sub"" GROUP BY SUBSTRING(""sub"".""trans_date"", 1, 7),""country"" HAVING ""approved_count"">0 OR ""approved_amount"">0 OR ""chargeback_count"">0 OR ""chargeback_amount"">0"
84,"SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",COALESCE(COUNT(CASE WHEN ""state""='approved' THEN ""id"" ELSE NULL END), 0) AS ""approved_count"",COALESCE(SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END), 0) AS ""approved_amount"",COALESCE(COUNT(CASE WHEN ""state""='chargeback' THEN ""id"" ELSE NULL END), 0) AS ""chargeback_count"",COALESCE(SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END), 0) AS ""chargeback_amount"" FROM (SELECT ""a"".""id"",""country"",'chargeback' AS ""state"",""amount"",""b"".""trans_date"" FROM ""Transactions"" AS ""a"" JOIN ""Chargebacks"" AS ""b"" ON ""a"".""id""=""b"".""trans_id"" UNION ALL SELECT * FROM ""Transactions"") AS ""t"" GROUP BY TO_CHAR(""trans_date"", 'YYYY-%m'),""country"" HAVING ""approved_count"">0 OR ""chargeback_count"">0 ORDER BY TO_CHAR(""trans_date"", 'YYYY-%m'),""country"""
85,"WITH ""tmp2"" AS (SELECT LEFT(""a"".""trans_date"", 7) AS ""month"",""country"",COUNT(""trans_id"") AS ""chargeback_count"",SUM(""amount"") AS ""chargeback_amount"" FROM ""Chargebacks"" AS ""a"" JOIN ""Transactions"" AS ""b"" ON ""a"".""trans_id""=""b"".""id"" GROUP BY 1,2), ""tmp1"" AS (SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",COUNT(CASE WHEN ""state""='approved' THEN ""id"" END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"" FROM ""Transactions"" GROUP BY 1,2) SELECT * FROM (SELECT ""tmp1"".*,COALESCE(""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""tmp1"" LEFT JOIN ""tmp2"" USING (""month"",""country"") WHERE ""tmp2"".""month"" IS NULL AND ""tmp2"".""country"" IS NULL UNION SELECT COALESCE(""tmp1"".""month"", ""tmp2"".""month"") AS ""month"",COALESCE(""tmp1"".""country"", ""tmp2"".""country"") AS ""country"",COALESCE(""approved_count"", 0) AS ""approved_count"",COALESCE(""approved_amount"", 0) AS ""approved_amount"",""chargeback_count"",""chargeback_amount"" FROM ""tmp1"" RIGHT JOIN ""tmp2"" USING (""month"",""country"")) AS ""t"" WHERE !(""approved_count""=0 AND ""approved_amount""=0 AND ""chargeback_count""=0 AND ""chargeback_amount""=0)"
86,"SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",COALESCE(COUNT(DISTINCT CASE WHEN ""state""='approved' THEN ""id"" ELSE NULL END), 0) AS ""approved_count"",COALESCE(SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END), 0) AS ""approved_amount"",COALESCE(COUNT(DISTINCT CASE WHEN ""state""='chargeback' THEN ""id"" ELSE NULL END), 0) AS ""chargeback_count"",COALESCE(SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END), 0) AS ""chargeback_amount"" FROM ((SELECT * FROM ""transactions"" WHERE ""state""='approved') UNION ALL (SELECT ""c"".""trans_id"" AS ""id"",""t"".""country"",'chargeback' AS ""state"",""t"".""amount"",""c"".""trans_date"" FROM ""chargebacks"" AS ""c"" LEFT JOIN ""Transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"")) AS ""_"" GROUP BY 1,2"
87,"WITH ""CTE"" AS (SELECT * FROM ""Transactions"" UNION SELECT ""C"".""trans_id"" AS ""id"",""T"".""country"",'chargeback' AS ""state"",""T"".""amount"",""C"".""trans_date"" FROM ""Chargebacks"" AS ""C"" LEFT JOIN ""Transactions"" AS ""T"" ON ""C"".""trans_id""=""T"".""id"") SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='chargeback' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""CTE"" WHERE ""state"" IN ('approved','chargeback') GROUP BY 1,2"
88,"SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='back' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='back' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT ""trans_id"",LEFT(""chargebacks"".""trans_date"", 7) AS ""month"",""country"",'back' AS ""state"",""amount"" FROM ""chargebacks"" LEFT JOIN ""transactions"" ON ""chargebacks"".""trans_id""=""transactions"".""id"" UNION SELECT ""id"",LEFT(""trans_date"", 7) AS ""month"",""country"",""state"",""amount"" FROM ""transactions"" WHERE ""state""='approved') AS ""temp"" GROUP BY ""month"",""country"""
89,"WITH ""tmp2"" AS (SELECT LEFT(""a"".""trans_date"", 7) AS ""month"",""country"",COUNT(""trans_id"") AS ""chargeback_count"",SUM(""amount"") AS ""chargeback_amount"" FROM ""Chargebacks"" AS ""a"" JOIN ""Transactions"" AS ""b"" ON ""a"".""trans_id""=""b"".""id"" GROUP BY 1,2), ""tmp1"" AS (SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",COUNT(CASE WHEN ""state""='approved' THEN ""id"" END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"" FROM ""Transactions"" GROUP BY 1,2) SELECT * FROM (SELECT ""tmp1"".*,COALESCE(""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""tmp1"" LEFT JOIN ""tmp2"" USING (""month"",""country"") WHERE ""tmp2"".""month"" IS NULL AND ""tmp2"".""country"" IS NULL UNION SELECT COALESCE(""tmp1"".""month"", ""tmp2"".""month"") AS ""month"",COALESCE(""tmp1"".""country"", ""tmp2"".""country"") AS ""country"",COALESCE(""approved_count"", 0) AS ""approved_count"",COALESCE(""approved_amount"", 0) AS ""approved_amount"",""chargeback_count"",""chargeback_amount"" FROM ""tmp1"" RIGHT JOIN ""tmp2"" USING (""month"",""country"")) AS ""t"" WHERE ""approved_count""!=0 OR ""approved_amount""!=0 OR ""chargeback_count""!=0 OR ""chargeback_amount""!=0"
90,"WITH ""cte1"" AS (SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",COUNT(""id"") AS ""approved_count"",SUM(""amount"") AS ""approved_amount"",NULL AS ""chargeback_count"",NULL AS ""chargeback_amount"" FROM ""transactions"" WHERE ""state""='approved' GROUP BY 1,2 UNION ALL SELECT TO_CHAR(""cg"".""trans_date"", 'YYYY-%m') AS ""month"",""country"",NULL AS ""approved_count"",NULL AS ""approved_amount"",COUNT(""cg"".""trans_id"") AS ""chargeback_count"",SUM(""amount"") AS ""chargeback_amount"" FROM ""Chargebacks"" AS ""cg"" LEFT JOIN ""transactions"" AS ""t"" ON ""cg"".""trans_id""=""t"".""id"" GROUP BY 1,2) SELECT ""month"",""country"",COALESCE(SUM(""approved_count""), 0) AS ""approved_count"",COALESCE(SUM(""approved_amount""), 0) AS ""approved_amount"",COALESCE(SUM(""chargeback_count""), 0) AS ""chargeback_count"",COALESCE(SUM(""chargeback_amount""), 0) AS ""chargeback_amount"" FROM ""cte1"" GROUP BY ""month"",""country"""
91,"WITH ""cte"" AS (SELECT LEFT(""c"".""trans_date"", 7) AS ""month"",""country"",'chargebacks' AS ""state"",""amount"" FROM ""chargebacks"" AS ""c"" JOIN ""transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" UNION ALL SELECT LEFT(""t"".""trans_date"", 7) AS ""month"",""country"",""state"",""amount"" FROM ""transactions"" AS ""t"" WHERE ""state""='approved') SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='chargebacks' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargebacks' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""cte"" GROUP BY 1,2 ORDER BY 1"
92,"WITH ""stacked"" AS (SELECT TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"",""country"",NULL AS ""approved_count"",NULL AS ""approved_amount"",COUNT(1) AS ""chargeback_count"",SUM(""amount"") AS ""chargeback_amount"" FROM ""chargebacks"" AS ""c"" LEFT JOIN ""transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" GROUP BY 1,2 UNION ALL SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",NULL AS ""chargeback_count"",NULL AS ""chargeback_amount"" FROM ""transactions"" GROUP BY 1,2) SELECT ""month"",""country"",COALESCE(SUM(""approved_count""), 0) AS ""approved_count"",COALESCE(SUM(""approved_amount""), 0) AS ""approved_amount"",COALESCE(SUM(""chargeback_count""), 0) AS ""chargeback_count"",COALESCE(SUM(""chargeback_amount""), 0) AS ""chargeback_amount"" FROM ""stacked"" GROUP BY 1,2 HAVING COALESCE(SUM(""approved_count""), 0)+COALESCE(SUM(""approved_amount""), 0)+COALESCE(SUM(""chargeback_count""), 0)+COALESCE(SUM(""chargeback_amount""), 0)!=0"
93,"WITH ""cte"" AS (SELECT ""trans_id"" AS ""id"",""t"".""country"" AS ""country"",'Chargebacks' AS ""state"",""amount"",""c"".""trans_date"" AS ""trans_date"" FROM ""chargebacks"" AS ""c"" LEFT JOIN ""transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" UNION SELECT * FROM ""transactions"" WHERE ""state""='approved') SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='chargebacks' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargebacks' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""cte"" GROUP BY ""month"",""country"""
94,"SELECT * FROM (SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='chargeback' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT ""c"".""trans_id"",""t"".""country"",'chargeback' AS ""state"",""t"".""amount"",""c"".""trans_date"" FROM ""Chargebacks"" AS ""c"" JOIN ""Transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" UNION ALL SELECT * FROM ""Transactions"") AS ""temp"" GROUP BY ""month"",""country"") AS ""temp1"" WHERE ROW(""approved_count"",""approved_amount"",""chargeback_count"",""chargeback_amount"")!=ROW(0,0,0,0)"
95,"SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='chargeback' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT LEFT(""c"".""trans_date"", 7) AS ""month"",""country"",""amount"",'chargeback' AS ""state"" FROM ""Chargebacks"" AS ""c"" JOIN ""Transactions"" AS ""t"" ON ""t"".""id""=""c"".""trans_id"" UNION ALL SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",""amount"",""state"" FROM ""Transactions"" WHERE ""state""='approved') AS ""a"" GROUP BY 1,2"
96,"WITH ""cte"" AS (SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"" FROM ""transactions"" UNION SELECT TO_CHAR(""a"".""trans_date"", 'YYYY-%m') AS ""month"",""b"".""country"" FROM ""chargebacks"" AS ""a"" LEFT JOIN ""transactions"" AS ""b"" ON ""a"".""trans_id""=""b"".""id"") SELECT ""a"".*,COALESCE(""b"".""approved_count"", 0) AS ""approved_count"",COALESCE(""b"".""approved_amount"", 0) AS ""approved_amount"",COALESCE(""c"".""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""c"".""chargeback_amount"", 0) AS ""chargeback_amount"" FROM (""cte"" AS ""a"" LEFT JOIN (SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",COUNT(DISTINCT ""id"") AS ""approved_count"",SUM(""amount"") AS ""approved_amount"" FROM ""transactions"" WHERE ""state""='approved' GROUP BY 1,2) AS ""b"" ON ""a"".""month""=""b"".""month"" AND ""a"".""country""=""b"".""country"") LEFT JOIN (SELECT TO_CHAR(""a"".""trans_date"", 'YYYY-%m') AS ""month"",""b"".""country"",COUNT(DISTINCT ""a"".""trans_id"") AS ""chargeback_count"",SUM(""b"".""amount"") AS ""chargeback_amount"" FROM ""chargebacks"" AS ""a"" LEFT JOIN ""transactions"" AS ""b"" ON ""a"".""trans_id""=""b"".""id"" GROUP BY 1,2) AS ""c"" ON ""a"".""month""=""c"".""month"" AND ""a"".""country""=""c"".""country"" WHERE ""approved_count"">0 OR ""chargeback_count"">0 ORDER BY 1,2"
97,"WITH ""sub"" AS (SELECT ""id"",""country"",'Chargeback' AS ""state"",""amount"",""c"".""trans_date"" FROM ""Transactions"" AS ""t"" RIGHT JOIN ""Chargebacks"" AS ""c"" ON ""c"".""trans_id""=""t"".""id"" UNION SELECT ""id"",""country"",""state"",""amount"",""trans_date"" FROM ""Transactions"" AS ""t"") SELECT SUBSTRING(""trans_date"", 1, 7) AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='Chargeback' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='Chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""sub"" WHERE ""state"" IN ('approved','chargeback') GROUP BY 1,2"
98,"WITH ""income"" AS (SELECT ""country"",LEFT(""Transactions"".""trans_date"", 7) AS ""month"",COUNT(""Transactions"".""id"") AS ""approved_count"",SUM(""Transactions"".""amount"") AS ""approved_amount"" FROM ""Transactions"" WHERE ""state""='approved' GROUP BY ""country"",LEFT(""Transactions"".""trans_date"", 7)), ""chargeback"" AS (SELECT LEFT(""C"".""trans_date"", 7) AS ""month"",""country"",COUNT(""Transactions"".""id"") AS ""chargeback_count"",SUM(""Transactions"".""amount"") AS ""chargeback_amount"" FROM ""Transactions"" JOIN ""Chargebacks"" AS ""C"" ON ""Transactions"".""id""=""C"".""trans_id"" GROUP BY ""country"",LEFT(""C"".""trans_date"", 7)) SELECT ""month"",""country"",COALESCE(""approved_count"", 0) AS ""approved_count"",COALESCE(""approved_amount"", 0) AS ""approved_amount"",COALESCE(""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""income"" LEFT JOIN ""chargeback"" USING (""country"",""month"") UNION SELECT ""month"",""country"",COALESCE(""approved_count"", 0) AS ""approved_count"",COALESCE(""approved_amount"", 0) AS ""approved_amount"",COALESCE(""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""income"" RIGHT JOIN ""chargeback"" USING (""country"",""month"")"
99,"WITH ""cte"" AS (SELECT ""t"".* FROM ""transactions"" AS ""t"" WHERE ""state""='approved' UNION ALL SELECT ""trans_id"",""t"".""country"",'back' AS ""state"",""t"".""amount"",""c"".""trans_date"" FROM ""chargebacks"" AS ""c"" LEFT JOIN ""transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"") SELECT SUBSTR(""trans_date"", 1, 7) AS ""month"",""country"",SUM(""state""='approved') AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(""state""='back') AS ""chargeback_count"",SUM(CASE WHEN ""state""='back' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""cte"" GROUP BY 1,""country"""
100,"SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='back' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='back' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"",""country"",'back' AS ""state"",""amount"" FROM ""chargebacks"" AS ""c"" JOIN ""transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" UNION ALL SELECT TO_CHAR(""t"".""trans_date"", 'YYYY-%m') AS ""month"",""country"",""state"",""amount"" FROM ""transactions"" AS ""t"" WHERE ""state""='approved') AS ""a"" GROUP BY ""month"",""country"""
101,"WITH ""temp"" AS (SELECT ""t"".""id"",""country"",""state"",""amount"",""t"".""trans_date"" FROM ""Transactions"" AS ""t"" UNION SELECT ""c"".""trans_id"",""country"",'chargebacks',""amount"",""c"".""trans_date"" FROM ""Transactions"" AS ""t"" RIGHT JOIN ""Chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"") SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",COUNT(CASE WHEN ""state""='approved' THEN 1 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",COUNT(CASE WHEN ""state""='chargebacks' THEN 1 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargebacks' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""temp"" GROUP BY ""month"",""country"" HAVING ""approved_count""+""chargeback_count""!=0"
102,"WITH ""income"" AS (SELECT ""country"",TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",COUNT(""id"") AS ""approved_count"",SUM(""amount"") AS ""approved_amount"" FROM ""Transactions"" WHERE ""state""='approved' GROUP BY 1,2), ""chargeback"" AS (SELECT TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"",""country"",COUNT(""t"".""id"") AS ""chargeback_count"",SUM(""t"".""amount"") AS ""chargeback_amount"" FROM ""Transactions"" AS ""t"" JOIN ""Chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"" GROUP BY 2,1) SELECT ""month"",""country"",COALESCE(""approved_count"", 0) AS ""approved_count"",COALESCE(""approved_amount"", 0) AS ""approved_amount"",COALESCE(""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""income"" LEFT JOIN ""chargeback"" USING (""country"",""month"") UNION SELECT ""month"",""country"",COALESCE(""approved_count"", 0) AS ""approved_count"",COALESCE(""approved_amount"", 0) AS ""approved_amount"",COALESCE(""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""income"" RIGHT JOIN ""chargeback"" USING (""country"",""month"")"
103,"WITH ""cte"" AS (SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",COUNT(""id"") AS ""approved_count"",SUM(""amount"") AS ""approved_amount"" FROM ""Transactions"" WHERE ""state""='approved' GROUP BY 1,2), ""cte2"" AS (SELECT LEFT(""c"".""trans_date"", 7) AS ""month"",""t"".""country"",COUNT(1) AS ""chargeback_count"",SUM(""t"".""amount"") AS ""chargeback_amount"" FROM ""Chargebacks"" AS ""c"" JOIN ""Transactions"" AS ""t"" ON ""t"".""id""=""c"".""trans_id"" GROUP BY 1,2) SELECT ""cte"".""month"",""cte"".""country"",""approved_count"",""approved_amount"",COALESCE(""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""cte"" LEFT JOIN ""cte2"" ON ""cte"".""month""=""cte2"".""month"" AND ""cte"".""country""=""cte2"".""country"" UNION SELECT ""cte2"".""month"",""cte2"".""country"",COALESCE(""approved_count"", 0) AS ""approved_count"",COALESCE(""approved_amount"", 0) AS ""approved_amount"",""chargeback_count"",""chargeback_amount"" FROM ""cte2"" LEFT JOIN ""cte"" ON ""cte"".""month""=""cte2"".""month"" AND ""cte"".""country""=""cte2"".""country"""
104,"WITH ""a"" AS (SELECT ""c"".""trans_id"",""t"".""country"",'Chargebacks' AS ""state"",""t"".""amount"",""c"".""trans_date"" FROM ""chargebacks"" AS ""c"" LEFT JOIN ""transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" UNION ALL SELECT * FROM ""transactions"" ORDER BY 1,3) SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(""state""='approved') AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(""state""='chargebacks') AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargebacks' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""a"" GROUP BY 1,2 HAVING ""approved_count"">0 OR ""chargeback_count"">0"
105,"SELECT TO_CHAR(CASE WHEN ""trans_date"" IS NULL THEN ""chargeback_date"" ELSE ""trans_date"" END, 'YYYY-%m') AS ""month"",""country"",SUM(CASE WHEN ""chargeback_date"" IS NULL THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""chargeback_date"" IS NULL THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""trans_date"" IS NULL THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""trans_date"" IS NULL THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT ""a"".""id"",""a"".""country"",""a"".""state"",""a"".""amount"",""a"".""trans_date"",NULL AS ""chargeback_date"" FROM ""transactions"" AS ""a"" WHERE ""state""='approved' UNION SELECT ""a"".""id"",""a"".""country"",""a"".""state"",""a"".""amount"",NULL,""b"".""trans_date"" AS ""chargeback_date"" FROM ""transactions"" AS ""a"" RIGHT JOIN ""chargebacks"" AS ""b"" ON ""a"".""id""=""b"".""trans_id"") AS ""a"" GROUP BY 1,2"
106,"WITH ""t"" AS (SELECT ""t"".""id"",""country"",""state"",""amount"",""t"".""trans_date"" FROM ""Transactions"" AS ""t"" UNION SELECT ""c"".""trans_id"",""country"",'chargeback',""amount"",""c"".""trans_date"" FROM ""Transactions"" AS ""t"" RIGHT JOIN ""Chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"") SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(""state""='approved') AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(""state""='chargeback') AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""t"" GROUP BY ""month"",""country"" HAVING ""approved_count""+""approved_amount""+""chargeback_count""+""chargeback_amount""!=0"
107,"SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='chargeback' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT LEFT(""c"".""trans_date"", 7) AS ""month"",""t"".""country"",'chargeback' AS ""state"",""amount"" FROM ""chargebacks"" AS ""c"" JOIN ""transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" UNION ALL SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",""state"",""amount"" FROM ""transactions"" WHERE ""state""='approved') AS ""cba"" GROUP BY ""month"",""country"""
108,"SELECT ""month"",""country"",SUM(CASE WHEN ""type""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""type""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""type""='chargeback' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""type""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ((SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",""amount"",'approved' AS ""type"" FROM ""transactions"" WHERE ""state""='approved') UNION ALL (SELECT LEFT(""c"".""trans_date"", 7) AS ""month"",""t"".""country"",""amount"",'chargeback' AS ""type"" FROM ""transactions"" AS ""t"" JOIN ""chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"")) AS ""tt"" GROUP BY ""tt"".""month"",""tt"".""country"""
109,"SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='back' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='back' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT LEFT(""chargebacks"".""trans_date"", 7) AS ""month"",""country"",'back' AS ""state"",""amount"" FROM ""chargebacks"" JOIN ""transactions"" ON ""chargebacks"".""trans_id""=""transactions"".""id"" UNION ALL SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",""state"",""amount"" FROM ""transactions"" WHERE ""state""='approved') AS ""s"" GROUP BY ""month"",""country"""
110,"WITH ""cte"" AS (SELECT ""id"",""country"",'bc' AS ""state"",""amount"",""c"".""trans_date"" FROM ""Transactions"" AS ""t"" RIGHT JOIN ""Chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"" UNION ALL SELECT ""id"",""country"",""state"",""amount"",""trans_date"" FROM ""Transactions"") SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='bc' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='bc' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""cte"" GROUP BY 2,1 HAVING ""approved_count""+""approved_amount""+""chargeback_count""+""chargeback_amount""!=0"
111,"WITH ""income"" AS (SELECT ""country"",LEFT(""Transactions"".""trans_date"", 7) AS ""month"",COUNT(""Transactions"".""id"") AS ""approved_count"",SUM(""Transactions"".""amount"") AS ""approved_amount"" FROM ""Transactions"" WHERE ""state""='approved' GROUP BY ""country"",LEFT(""Transactions"".""trans_date"", 7)), ""chargeback"" AS (SELECT LEFT(""C"".""trans_date"", 7) AS ""month"",""country"",COUNT(""Transactions"".""id"") AS ""chargeback_count"",SUM(""Transactions"".""amount"") AS ""chargeback_amount"" FROM ""Transactions"" JOIN ""Chargebacks"" AS ""C"" ON ""Transactions"".""id""=""C"".""trans_id"" GROUP BY ""country"",LEFT(""C"".""trans_date"", 7)) SELECT ""month"",""country"",COALESCE(""approved_count"", 0) AS ""approved_count"",COALESCE(""approved_amount"", 0) AS ""approved_amount"",COALESCE(""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""income"" LEFT JOIN ""chargeback"" USING (""country"",""month"") UNION SELECT ""month"",""country"",COALESCE(""approved_count"", 0) AS ""approved_count"",COALESCE(""approved_amount"", 0) AS ""approved_amount"",COALESCE(""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""income"" RIGHT JOIN ""chargeback"" USING (""country"",""month"")"
112,"SELECT ""day"" AS ""month"",""country"",SUM(CASE WHEN ""type""='trans' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""type""='trans' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""type""='charge' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""type""='charge' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT ""C"".""trans_id"" AS ""id"",LEFT(""C"".""trans_date"", 7) AS ""day"",""T"".""amount"",""T"".""country"",'charge' AS ""type"" FROM ""Chargebacks"" AS ""C"" JOIN ""Transactions"" AS ""T"" ON ""C"".""trans_id""=""T"".""id"" UNION ALL SELECT ""id"",LEFT(""trans_date"", 7) AS ""day"",""amount"",""country"",'trans' AS ""type"" FROM ""Transactions"" WHERE ""state""='approved') AS ""T"" GROUP BY ""day"",""country"" ORDER BY ""day"""
113,"WITH ""tmp"" AS (SELECT TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"",""country"",NULL AS ""approved_count"",NULL AS ""approved_amount"",COUNT(1) AS ""chargeback_count"",SUM(""amount"") AS ""chargeback_amount"" FROM ""Chargebacks"" AS ""c"" LEFT JOIN ""Transactions"" AS ""t"" ON ""t"".""id""=""c"".""trans_id"" GROUP BY ""month"",""country"" UNION ALL SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(""state""='approved') AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",NULL AS ""chargeback_count"",NULL AS ""chargeback_amount"" FROM ""Transactions"" GROUP BY ""month"",""country"") SELECT ""month"",""country"",COALESCE(SUM(""approved_count""), 0) AS ""approved_count"",COALESCE(SUM(""approved_amount""), 0) AS ""approved_amount"",COALESCE(SUM(""chargeback_count""), 0) AS ""chargeback_count"",COALESCE(SUM(""chargeback_amount""), 0) AS ""chargeback_amount"" FROM ""tmp"" GROUP BY ""month"",""country"" HAVING COALESCE(SUM(""approved_count""), 0)+COALESCE(SUM(""approved_amount""), 0)+COALESCE(SUM(""chargeback_count""), 0)+COALESCE(SUM(""chargeback_amount""), 0)!=0"
114,"WITH ""chargebacks_new"" AS (SELECT ""c"".""trans_id"" AS ""id"",""t"".""country"",'chargeback' AS ""state"",""t"".""amount"",""c"".""trans_date"" FROM ""Chargebacks"" AS ""c"" JOIN ""Transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" UNION ALL SELECT * FROM ""Transactions"") SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",COALESCE(SUM(CASE WHEN ""state""='approved' THEN 1 END), 0) AS ""approved_count"",COALESCE(SUM(CASE WHEN ""state""='approved' THEN ""amount"" END), 0) AS ""approved_amount"",COALESCE(SUM(CASE WHEN ""state""='chargeback' THEN 1 END), 0) AS ""chargeback_count"",COALESCE(SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" END), 0) AS ""chargeback_amount"" FROM ""chargebacks_new"" GROUP BY 1,2 HAVING (""approved_amount""+""chargeback_amount"")!=0"
115,"WITH ""temp_trans"" AS (SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",""state"",""amount"" FROM ""Transactions"" WHERE ""state""='approved' UNION ALL SELECT LEFT(""c"".""trans_date"", 7) AS ""month"",""country"",'back' AS ""state"",""amount"" FROM ""Chargebacks"" AS ""c"" JOIN ""Transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"") SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='back' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='back' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""temp_trans"" GROUP BY 1,2 ORDER BY 1"
116,"WITH ""main"" AS (SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",COUNT(""id"") AS ""approved_count"",SUM(""amount"") AS ""approved_amount"",0 AS ""chargeback_count"",0 AS ""chargeback_amount"" FROM ""Transactions"" WHERE ""state""='approved' GROUP BY ""month"",""country"" UNION SELECT LEFT(""C"".""trans_date"", 7) AS ""month"",""country"",0 AS ""approved_count"",0 AS ""approved_amount"",COUNT(""trans_id"") AS ""chargeback_count"",SUM(""amount"") AS ""chargeback_amount"" FROM ""Chargebacks"" AS ""C"" JOIN ""Transactions"" AS ""T"" ON ""C"".""trans_id""=""T"".""id"" GROUP BY ""month"",""country"") SELECT ""month"",""country"",SUM(""approved_count"") AS ""approved_count"",SUM(""approved_amount"") AS ""approved_amount"",SUM(""chargeback_count"") AS ""chargeback_count"",SUM(""chargeback_amount"") AS ""chargeback_amount"" FROM ""main"" GROUP BY ""month"",""country"""
117,"WITH ""temp"" AS ((SELECT ""T"".""id"",""T"".""country"",'chargeback' AS ""state"",""T"".""amount"",""C"".""trans_date"" FROM ""Transactions"" AS ""T"" JOIN ""Chargebacks"" AS ""C"" ON ""T"".""id""=""C"".""trans_id"") UNION ALL (SELECT * FROM ""Transactions"" AS ""T2"" WHERE ""T2"".""state""='approved')) SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='chargeback' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""temp"" GROUP BY ""month"",""country"""
118,"WITH ""T1"" AS (SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",COUNT(1) AS ""approved_count"",SUM(""amount"") AS ""approved_amount"" FROM ""Transactions"" WHERE ""state""='approved' GROUP BY LEFT(""trans_date"", 7),""country""), ""T2"" AS (SELECT LEFT(""C"".""trans_date"", 7) AS ""month"",""country"",COUNT(""C"".""trans_id"") AS ""chargeback_count"",SUM(""amount"") AS ""chargeback_amount"" FROM ""Transactions"" AS ""T"" JOIN ""Chargebacks"" AS ""C"" ON ""T"".""id""=""C"".""trans_id"" GROUP BY LEFT(""C"".""trans_date"", 7),""country""), ""T3"" AS (SELECT LEFT(""trans_date"", 7) AS ""month"",""country"" FROM ""Transactions"" UNION SELECT LEFT(""CB"".""trans_date"", 7) AS ""month"",""country"" FROM ""Chargebacks"" AS ""CB"" JOIN ""Transactions"" AS ""TR"" ON ""CB"".""trans_id""=""TR"".""id"") SELECT ""T3"".""month"",""T3"".""country"",COALESCE(""approved_count"", 0) AS ""approved_count"",COALESCE(""approved_amount"", 0) AS ""approved_amount"",COALESCE(""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""chargeback_amount"", 0) AS ""chargeback_amount"" FROM (""T3"" LEFT JOIN ""T1"" ON ""T1"".""month""=""T3"".""month"" AND ""T1"".""country""=""T3"".""country"") LEFT JOIN ""T2"" ON ""T2"".""month""=""T3"".""month"" AND ""T2"".""country""=""T3"".""country"" GROUP BY ""T3"".""month"",""T3"".""country"" HAVING ""approved_count""+""approved_amount""+""chargeback_count""+""chargeback_amount""!=0"
119,"SELECT * FROM (SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='chargeback' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT ""c"".""trans_id"",""t"".""country"",'chargeback' AS ""state"",""t"".""amount"",""c"".""trans_date"" FROM ""Chargebacks"" AS ""c"" JOIN ""Transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" UNION ALL SELECT * FROM ""Transactions"") AS ""temp"" GROUP BY ""month"",""country"") AS ""temp1"" WHERE ROW(""approved_count"",""approved_amount"",""chargeback_count"",""chargeback_amount"")!=ROW(0,0,0,0)"
120,"WITH ""total"" AS (SELECT ""trans_id"" AS ""id"",""t"".""country"",'chargeback' AS ""state"",""t"".""amount"" AS ""amount"",LEFT(""c"".""trans_date"", 7) AS ""month"" FROM ""Chargebacks"" AS ""c"" JOIN ""Transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" UNION ALL SELECT ""id"",""country"",""state"",""amount"",LEFT(""trans_date"", 7) AS ""month"" FROM ""Transactions""), ""total1"" AS (SELECT ""id"",""country"",CASE WHEN ""state""='approved' THEN 1 ELSE 0 END AS ""approved"",CASE WHEN ""state""='chargeback' THEN 1 ELSE 0 END AS ""chargeback"",""month"",""amount"" FROM ""total"") SELECT ""month"",""country"",SUM(""approved"") AS ""approved_count"",SUM(""approved""*""amount"") AS ""approved_amount"",SUM(""chargeback"") AS ""chargeback_count"",SUM(""chargeback""*""amount"") AS ""chargeback_amount"" FROM ""total1"" GROUP BY ""month"",""country"" HAVING ""approved_count"">0 OR ""chargeback_count"">0"
121,"WITH ""Chargebacks_merged"" AS (SELECT ""c"".""trans_date"",""t"".""country"",NULL AS ""state"",""t"".""amount"",'chargebacks' AS ""cat"" FROM ""Chargebacks"" AS ""c"" JOIN ""Transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id""), ""total"" AS (SELECT ""trans_date"",""country"",""state"",""amount"",'transactions' AS ""cat"" FROM ""Transactions"" UNION ALL SELECT ""trans_date"",""country"",""state"",""amount"",""cat"" FROM ""Chargebacks_merged"") SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""cat""='chargebacks' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""cat""='chargebacks' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""total"" WHERE ""state""='approved' OR ""cat""='chargebacks' GROUP BY ""month"",""country"""
122,"WITH ""a"" AS (SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",COUNT(""id"") AS ""approved_count"",SUM(""amount"") AS ""approved_amount"" FROM ""transactions"" WHERE ""state""='approved' GROUP BY 1,2), ""b"" AS (SELECT LEFT(""c"".""trans_date"", 7) AS ""month"",""t"".""country"",COUNT(1) AS ""chargeback_count"",SUM(""t"".""amount"") AS ""chargeback_amount"" FROM ""chargebacks"" AS ""c"" LEFT JOIN ""transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" GROUP BY 1,2), ""c"" AS (SELECT ""b"".""month"",""b"".""country"",COALESCE(""a"".""approved_count"", 0) AS ""approved_count"",COALESCE(""a"".""approved_amount"", 0) AS ""approved_amount"",""b"".""chargeback_count"",""b"".""chargeback_amount"" FROM ""b"" LEFT JOIN ""a"" ON ""a"".""month""=""b"".""month"" AND ""a"".""country""=""b"".""country"" ORDER BY 1), ""d"" AS (SELECT ""a"".""month"",""a"".""country"",""a"".""approved_count"",""a"".""approved_amount"",COALESCE(""b"".""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""b"".""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""a"" LEFT JOIN ""b"" ON ""a"".""month""=""b"".""month"" AND ""a"".""country""=""b"".""country"" ORDER BY 1) SELECT * FROM ""c"" UNION SELECT * FROM ""d"""
123,"SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='back' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='back' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT LEFT(""chargebacks"".""trans_date"", 7) AS ""month"",""country"",'back' AS ""state"",""amount"" FROM ""chargebacks"" JOIN ""transactions"" ON ""chargebacks"".""trans_id""=""transactions"".""id"" UNION ALL SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",""state"",""amount"" FROM ""transactions"" WHERE ""state""='approved') AS ""s"" GROUP BY ""month"",""country"""
124,"WITH ""t1"" AS (SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(""amount"") AS ""approved_amount"" FROM (SELECT ""id"",""country"",""state"",""amount"",TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"" FROM ""transactions"" WHERE ""state""='approved') AS ""t"" GROUP BY ""month"",""country""), ""t2"" AS (SELECT ""month"",""country"",COUNT(1) AS ""chargeback_count"",SUM(""amount"") AS ""chargeback_amount"" FROM (SELECT TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"",""tr"".""country"",""tr"".""amount"" FROM ""chargebacks"" AS ""c"" JOIN ""transactions"" AS ""tr"" ON ""c"".""trans_id""=""tr"".""id"") AS ""temp"" GROUP BY ""month"",""country"") SELECT COALESCE(""t1"".""month"", ""t2"".""month"") AS ""month"",COALESCE(""t1"".""country"", ""t2"".""country"") AS ""country"",COALESCE(""t1"".""approved_count"", 0) AS ""approved_count"",COALESCE(""t1"".""approved_amount"", 0) AS ""approved_amount"",COALESCE(""t2"".""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""t2"".""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""t1"" LEFT JOIN ""t2"" USING (""month"",""country"") UNION SELECT COALESCE(""t1"".""month"", ""t2"".""month"") AS ""month"",COALESCE(""t1"".""country"", ""t2"".""country"") AS ""country"",COALESCE(""t1"".""approved_count"", 0) AS ""approved_count"",COALESCE(""t1"".""approved_amount"", 0) AS ""approved_amount"",COALESCE(""t2"".""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""t2"".""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""t1"" RIGHT JOIN ""t2"" USING (""month"",""country"")"
125,"SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='back' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='back' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",""state"",""amount"" FROM ""Transactions"" WHERE ""state""='approved' UNION ALL SELECT LEFT(""c"".""trans_date"", 7) AS ""month"",""country"",'back' AS ""state"",""amount"" FROM ""Transactions"" AS ""t"" JOIN ""Chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"") AS ""t"" GROUP BY ""month"",""country"""
126,"WITH ""approved"" AS (SELECT ""id"",TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",COUNT(""id"") AS ""approved_count"",SUM(""amount"") AS ""approved_amount"" FROM ""Transactions"" WHERE ""state""='approved' GROUP BY TO_CHAR(""trans_date"", 'YYYY-%m'),""country""), ""Charged"" AS (SELECT TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"",""t"".""country"" AS ""country"",COUNT(""c"".""trans_id"") AS ""chargeback_count"",SUM(""t"".""amount"") AS ""chargeback_amount"" FROM ""Chargebacks"" AS ""c"" LEFT JOIN ""Transactions"" AS ""t"" ON ""t"".""id""=""c"".""trans_id"" GROUP BY TO_CHAR(""c"".""trans_date"", 'YYYY-%m'),""t"".""country""), ""t3"" AS (SELECT ""a"".""month"",""country"" FROM ""approved"" AS ""a"" UNION SELECT ""c"".""month"",""country"" FROM ""Charged"" AS ""c"") SELECT ""t3"".""month"",""t3"".""country"",COALESCE(""approved_count"", 0) AS ""approved_count"",COALESCE(""approved_amount"", 0) AS ""approved_amount"",COALESCE(""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""chargeback_amount"", 0) AS ""chargeback_amount"" FROM (""t3"" LEFT JOIN ""approved"" AS ""a"" ON ""t3"".""month""=""a"".""month"" AND ""t3"".""country""=""a"".""country"") LEFT JOIN ""Charged"" AS ""c"" ON ""t3"".""month""=""c"".""month"" AND ""t3"".""country""=""c"".""country"""
127,"WITH ""A"" AS (SELECT CASE WHEN ""trans_id""=""t"".""id"" AND ""state""='declined' THEN TO_CHAR(""c"".""trans_date"", 'YYYY-%m') ELSE TO_CHAR(""t"".""trans_date"", 'YYYY-%m') END AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"" FROM ""transactions"" AS ""t"" LEFT JOIN ""chargebacks"" AS ""c"" ON ""c"".""trans_id""=""t"".""id"" GROUP BY 1,2), ""B"" AS (SELECT TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"",""country"",COUNT(""c"".""trans_date"") AS ""chargeback_count"",SUM(CASE WHEN ""trans_id""=""id"" THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""chargebacks"" AS ""c"" JOIN ""Transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" GROUP BY 1,2) SELECT * FROM (SELECT ""A"".""month"",""A"".""country"",COALESCE(""approved_count"", 0) AS ""approved_count"",COALESCE(""approved_amount"", 0) AS ""approved_amount"",COALESCE(""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""A"" LEFT JOIN ""B"" ON ""A"".""month""=""B"".""month"" AND ""A"".""country""=""B"".""country"" UNION SELECT ""B"".""month"",""B"".""country"",COALESCE(""approved_count"", 0) AS ""approved_count"",COALESCE(""approved_amount"", 0) AS ""approved_amount"",COALESCE(""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""A"" RIGHT JOIN ""B"" ON ""A"".""month""=""B"".""month"" AND ""A"".""country""=""B"".""country"") AS ""C"" WHERE ""approved_count""+""chargeback_count""!=0"
128,"WITH ""cte"" AS (SELECT TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"",""country"",NULL AS ""approved_count"",NULL AS ""approved_amount"",COUNT(""trans_id"") AS ""Chargeback_count"",SUM(""amount"") AS ""chargeback_amount"" FROM ""chargebacks"" AS ""c"" LEFT JOIN ""transactions"" AS ""t"" ON ""t"".""id""=""c"".""trans_id"" GROUP BY 1,2 UNION ALL SELECT TO_CHAR(""t"".""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(""state""='Approved') AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",NULL AS ""chargeback_count"",NULL AS ""chargeback_amount"" FROM ""transactions"" AS ""t"" GROUP BY 1,2) SELECT ""month"",""country"",COALESCE(SUM(""approved_count""), 0) AS ""approved_count"",COALESCE(SUM(""approved_amount""), 0) AS ""approved_amount"",COALESCE(SUM(""chargeback_count""), 0) AS ""chargeback_count"",COALESCE(SUM(""chargeback_amount""), 0) AS ""chargeback_amount"" FROM ""cte"" GROUP BY 1,2 HAVING COALESCE(SUM(""approved_count""), 0)+COALESCE(SUM(""approved_amount""), 0)+COALESCE(SUM(""chargeback_count""), 0)+COALESCE(SUM(""chargeback_amount""), 0)!=0"
129,"SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='back' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='back' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT LEFT(""chargebacks"".""trans_date"", 7) AS ""month"",""country"",'back' AS ""state"",""amount"" FROM ""chargebacks"" JOIN ""transactions"" ON ""chargebacks"".""trans_id""=""transactions"".""id"" UNION ALL SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",""state"",""amount"" FROM ""transactions"" WHERE ""state""='approved') AS ""s"" GROUP BY ""month"",""country"""
130,"WITH ""cte1"" AS (SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",COUNT(""state"") AS ""approved_count"",SUM(""amount"") AS ""approved_amount"" FROM ""Transactions"" WHERE ""state""='approved' GROUP BY 1,2), ""cte2"" AS (SELECT TO_CHAR(""C"".""trans_date"", 'YYYY-%m') AS ""month"",""country"",COUNT(""trans_id"") AS ""chargeback_count"",SUM(""amount"") AS ""chargeback_amount"" FROM ""Chargebacks"" AS ""C"" LEFT JOIN ""Transactions"" AS ""T"" ON ""C"".""trans_id""=""T"".""id"" GROUP BY 1,2) SELECT CASE WHEN ""cte1"".""month"" IS NULL THEN ""cte2"".""month"" ELSE ""cte1"".""month"" END AS ""month"",CASE WHEN ""cte1"".""country"" IS NULL THEN ""cte2"".""country"" ELSE ""cte1"".""country"" END AS ""country"",CASE WHEN ""approved_count"" IS NULL THEN 0 ELSE ""approved_count"" END AS ""approved_count"",CASE WHEN ""approved_amount"" IS NULL THEN 0 ELSE ""approved_amount"" END AS ""approved_amount"",CASE WHEN ""chargeback_count"" IS NULL THEN 0 ELSE ""chargeback_count"" END AS ""chargeback_count"",CASE WHEN ""chargeback_amount"" IS NULL THEN 0 ELSE ""chargeback_amount"" END AS ""chargeback_amount"" FROM ""cte2"" LEFT JOIN ""cte1"" ON ""cte2"".""month""=""cte1"".""month"" AND ""cte2"".""country""=""cte1"".""country"" UNION SELECT CASE WHEN ""cte1"".""month"" IS NULL THEN ""cte2"".""month"" ELSE ""cte1"".""month"" END AS ""month"",CASE WHEN ""cte1"".""country"" IS NULL THEN ""cte2"".""country"" ELSE ""cte1"".""country"" END AS ""country"",CASE WHEN ""approved_count"" IS NULL THEN 0 ELSE ""approved_count"" END AS ""approved_count"",CASE WHEN ""approved_amount"" IS NULL THEN 0 ELSE ""approved_amount"" END AS ""approved_amount"",CASE WHEN ""chargeback_count"" IS NULL THEN 0 ELSE ""chargeback_count"" END AS ""chargeback_count"",CASE WHEN ""chargeback_amount"" IS NULL THEN 0 ELSE ""chargeback_amount"" END AS ""chargeback_amount"" FROM ""cte2"" RIGHT JOIN ""cte1"" ON ""cte2"".""month""=""cte1"".""month"" AND ""cte2"".""country""=""cte1"".""country"" ORDER BY 1,2"
131,"WITH ""cb"" AS (SELECT LEFT(""c"".""trans_date"", 7) AS ""month"",""country"",""amount"",'chargeback' AS ""status"" FROM ""Transactions"" AS ""t"" JOIN ""Chargebacks"" AS ""c"" ON ""t"".""id""=""trans_id"") SELECT ""month"",""country"",SUM(CASE WHEN ""status""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""status""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""status""='chargeback' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""status""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT LEFT(""t"".""trans_date"", 7) AS ""month"",""t"".""country"",""t"".""amount"",'approved' AS ""status"" FROM ""Transactions"" AS ""t"" WHERE ""t"".""state""='approved' UNION ALL SELECT * FROM ""cb"") AS ""t2"" GROUP BY ""month"",""country"""
132,"WITH ""stacked"" AS (SELECT TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"",""country"",NULL AS ""approved_count"",NULL AS ""approved_amount"",COUNT(1) AS ""chargeback_count"",SUM(""amount"") AS ""chargeback_amount"" FROM ""chargebacks"" AS ""c"" LEFT JOIN ""transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" GROUP BY 1,2 UNION ALL SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(""state""='approved') AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",NULL AS ""chargeback_count"",NULL AS ""chargeback_amount"" FROM ""transactions"" GROUP BY 1,2) SELECT ""month"",""country"",COALESCE(SUM(""approved_count""), 0) AS ""approved_count"",COALESCE(SUM(""approved_amount""), 0) AS ""approved_amount"",COALESCE(SUM(""chargeback_count""), 0) AS ""chargeback_count"",COALESCE(SUM(""chargeback_amount""), 0) AS ""chargeback_amount"" FROM ""stacked"" GROUP BY 1,2 HAVING COALESCE(SUM(""approved_count""), 0)+COALESCE(SUM(""approved_amount""), 0)+COALESCE(SUM(""chargeback_count""), 0)+COALESCE(SUM(""chargeback_amount""), 0)!=0"
133,"WITH ""approve"" AS (SELECT ""country"",TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",SUM(CASE WHEN ""state""='approved' THEN 1 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" END) AS ""approved_amount"" FROM ""Transactions"" AS ""T"" GROUP BY ""country"",""month""), ""chargeback"" AS (SELECT ""T"".""country"",TO_CHAR(""C"".""trans_date"", 'YYYY-%m') AS ""month"",COUNT(""C"".""trans_id"") AS ""chargeback_count"",SUM(""T"".""amount"") AS ""chargeback_amount"" FROM (""Transactions"" AS ""T"") CROSS JOIN ""Chargebacks"" AS ""C"" WHERE ""T"".""id""=""C"".""trans_id"" GROUP BY ""country"",""month"") (SELECT ""A1"".""month"",""A1"".""country"",""A1"".""approved_count"",""A1"".""approved_amount"",COALESCE(""C1"".""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""C1"".""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""approve"" AS ""A1"" LEFT JOIN ""chargeback"" AS ""C1"" ON (""A1"".""country""=""C1"".""country"" AND ""A1"".""month""=""C1"".""month"") WHERE ""A1"".""approved_count""!=0) UNION (SELECT ""C1"".""month"",""C1"".""country"",COALESCE(""A1"".""approved_count"", 0) AS ""approved_count"",COALESCE(""A1"".""approved_amount"", 0) AS ""approved_amount"",""C1"".""chargeback_count"",""C1"".""chargeback_amount"" FROM ""approve"" AS ""A1"" RIGHT JOIN ""chargeback"" AS ""C1"" ON (""A1"".""country""=""C1"".""country"" AND ""A1"".""month""=""C1"".""month"")) ORDER BY ""month"",""country"""
134,"WITH ""temp_chargeback"" AS (SELECT LEFT(""c"".""trans_date"", 7) AS ""month"",""country"",'back' AS ""state"",""amount"" FROM ""Chargebacks"" AS ""c"" JOIN ""Transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" UNION ALL SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",""state"",""amount"" FROM ""Transactions"" AS ""t"" WHERE ""state""='approved') SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='back' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='back' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""temp_chargeback"" GROUP BY 1,2 ORDER BY 1"
135,"SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='chargeback' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT ""c"".""trans_id"",""t"".""country"",'chargeback' AS ""state"",""t"".""amount"",""c"".""trans_date"" FROM ""Chargebacks"" AS ""c"" JOIN ""Transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" UNION ALL SELECT * FROM ""Transactions"") AS ""t1"" GROUP BY ""country"",""month"" HAVING ""approved_amount"">0 OR ""chargeback_amount"">0"
136,"SELECT ""month"",""country"",COUNT(CASE WHEN ""state""='approved' THEN 1 ELSE NULL END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",COUNT(CASE WHEN ""state""='back' THEN 1 ELSE NULL END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='back' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT LEFT(""c"".""trans_date"", 7) AS ""month"",""country"",'back' AS ""state"",""amount"" FROM ""chargebacks"" AS ""c"" JOIN ""transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" UNION ALL SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",""state"",""amount"" FROM ""transactions"" WHERE ""state""='approved') AS ""backs_and_approvs"" GROUP BY 1,2"
137,"WITH ""cte1"" AS (SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",COUNT(""id"") AS ""approved_count"",SUM(""amount"") AS ""approved_amount"",NULL AS ""chargeback_count"",NULL AS ""chargeback_amount"" FROM ""transactions"" WHERE ""state""='approved' GROUP BY 1,2 UNION ALL SELECT TO_CHAR(""cg"".""trans_date"", 'YYYY-%m') AS ""month"",""country"",NULL AS ""approved_count"",NULL AS ""approved_amount"",COUNT(""cg"".""trans_id"") AS ""chargeback_count"",SUM(""amount"") AS ""chargeback_amount"" FROM ""Chargebacks"" AS ""cg"" LEFT JOIN ""transactions"" AS ""t"" ON ""cg"".""trans_id""=""t"".""id"" GROUP BY 1,2) SELECT ""month"",""country"",COALESCE(SUM(""approved_count""), 0) AS ""approved_count"",COALESCE(SUM(""approved_amount""), 0) AS ""approved_amount"",COALESCE(SUM(""chargeback_count""), 0) AS ""chargeback_count"",COALESCE(SUM(""chargeback_amount""), 0) AS ""chargeback_amount"" FROM ""cte1"" GROUP BY ""month"",""country"""
138,"WITH ""alltransa"" AS ((SELECT * FROM ""Transactions"" WHERE ""state""='approved') UNION ALL (SELECT ""a"".""id"",""country"",'chargebacks' AS ""state"",""amount"",""b"".""trans_date"" FROM ""Transactions"" AS ""a"" RIGHT JOIN ""Chargebacks"" AS ""b"" ON ""a"".""id""=""b"".""trans_id"")) SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",SUM(""state""='approved') AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(""state""='chargebacks') AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargebacks' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""alltransa"" GROUP BY 1,2"
139,"SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='back' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='back' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT LEFT(""chargebacks"".""trans_date"", 7) AS ""month"",""country"",'back' AS ""state"",""amount"" FROM ""chargebacks"" JOIN ""transactions"" ON ""chargebacks"".""trans_id""=""transactions"".""id"" UNION ALL SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",""state"",""amount"" FROM ""transactions"" WHERE ""state""='approved') AS ""s"" GROUP BY ""month"",""country"""
140,"SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",SUM(""state""='approved') AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(""state""='chargeback') AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ((SELECT * FROM ""Transactions"") UNION ALL (SELECT ""t"".""id"",""t"".""country"",'chargeback' AS ""state"",""t"".""amount"",""c"".""trans_date"" FROM ""Chargebacks"" AS ""c"" LEFT JOIN ""Transactions"" AS ""t"" ON ""t"".""id""=""c"".""trans_id"")) AS ""a"" GROUP BY ""month"",""country"" HAVING ""approved_amount"">0 OR ""chargeback_amount"">0"
141,"WITH ""CTE"" AS (SELECT ""trans_id"" AS ""id"",""country"",'chargebacks' AS ""state"",""amount"",""Chargebacks"".""trans_date"" FROM ""Transactions"" JOIN ""Chargebacks"" ON ""id""=""trans_id"" UNION ALL SELECT * FROM ""Transactions"") SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='chargebacks' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargebacks' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""CTE"" GROUP BY 1,2 HAVING ""approved_count""+""approved_amount""+""chargeback_count""+""chargeback_amount""!=0 ORDER BY 1,2"
142,"WITH ""cb"" AS (SELECT ""trans_id"" AS ""id"",""t"".""country"",'chargeback' AS ""state"",""t"".""amount"" AS ""amount"",""c"".""trans_date"" FROM ""Chargebacks"" AS ""c"" JOIN ""Transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id""), ""combined"" AS (SELECT * FROM ""Transactions"" UNION SELECT * FROM ""cb""), ""cte"" AS (SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",""state"",""amount"",""trans_date"" FROM ""combined"") SELECT ""month"",""country"",SUM(""state""='approved') AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(""state""='chargeback') AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""cte"" GROUP BY ""month"",""country"" HAVING ""approved_count"">0 OR ""chargeback_count"">0"
143,"WITH ""cte"" AS (SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",'approved' AS ""state"",""amount"" FROM ""Transactions"" WHERE ""state""='approved' UNION ALL SELECT LEFT(""c"".""trans_date"", 7) AS ""month"",""country"",'back' AS ""state"",""amount"" FROM ""Chargebacks"" AS ""c"" JOIN ""Transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"") SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='back' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='back' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""cte"" GROUP BY 1,2 ORDER BY 1"
144,"WITH ""txn"" AS (SELECT LEFT(""t"".""trans_date"", 7) AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",0 AS ""chargeback_count"",0 AS ""chargeback_amount"" FROM ""transactions"" AS ""t"" GROUP BY 1,2 UNION ALL SELECT LEFT(""c"".""trans_date"", 7) AS ""month"",""country"",0 AS ""approved_count"",0 AS ""approved_amount"",SUM(CASE WHEN ""trans_id"" IS NOT NULL THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""trans_id"" IS NOT NULL THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""transactions"" AS ""t"" LEFT JOIN ""chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"" GROUP BY 1,2) SELECT ""month"",""country"",SUM(""txn"".""approved_count"") AS ""approved_count"",SUM(""txn"".""approved_amount"") AS ""approved_amount"",SUM(""chargeback_count"") AS ""chargeback_count"",SUM(""chargeback_amount"") AS ""chargeback_amount"" FROM ""txn"" GROUP BY 1,2 HAVING ""approved_count""+""approved_amount""+""chargeback_count""+""chargeback_amount""!=0"
145,"WITH ""temp_table"" AS (SELECT *,SUBSTRING_INDEX(""trans_date"", '-', 2) AS ""month"" FROM ""transactions"" UNION ALL SELECT ""c"".""trans_id"" AS ""id"",""t"".""country"",'chargeback' AS ""state"",""t"".""amount"" AS ""amount"",""c"".""trans_date"" AS ""trans_date"",SUBSTRING_INDEX(""c"".""trans_date"", '-', 2) AS ""month"" FROM ""transactions"" AS ""t"" JOIN ""chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"") SELECT * FROM (SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='chargeback' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""temp_table"" GROUP BY ""month"",""country"" ORDER BY ""month"") AS ""a"" WHERE ""approved_count""+""approved_amount""+""chargeback_count""+""chargeback_amount"">0"
146,"WITH ""trans_table"" AS ((SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",COUNT(""id"") AS ""approved_count"",SUM(""amount"") AS ""approved_amount"",NULL AS ""chargeback_count"",NULL AS ""chargeback_amount"" FROM ""Transactions"" WHERE ""state""='approved' GROUP BY TO_CHAR(""trans_date"", 'YYYY-%m'),""country"") UNION (SELECT TO_CHAR(""a"".""trans_date"", 'YYYY-%m') AS ""month"",""b"".""country"" AS ""country"",NULL AS ""approved_count"",NULL AS ""approved_amount"",COUNT(""a"".""trans_id"") AS ""chargeback_count"",SUM(""b"".""amount"") AS ""chargeback_amount"" FROM ""Chargebacks"" AS ""a"" JOIN ""Transactions"" AS ""b"" ON ""a"".""trans_id""=""b"".""id"" GROUP BY TO_CHAR(""a"".""trans_date"", 'YYYY-%m'),""b"".""country"")) SELECT ""month"",""country"",COALESCE(SUM(""approved_count""), 0) AS ""approved_count"",COALESCE(SUM(""approved_amount""), 0) AS ""approved_amount"",COALESCE(SUM(""chargeback_count""), 0) AS ""chargeback_count"",COALESCE(SUM(""chargeback_amount""), 0) AS ""chargeback_amount"" FROM ""trans_table"" GROUP BY ""month"",""country"""
147,"SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='chargeback' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"",""country"",'chargeback' AS ""state"",""amount"" FROM ""Chargebacks"" AS ""c"" JOIN ""Transactions"" AS ""t"" ON ""t"".""id""=""c"".""trans_id"" UNION ALL SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",""state"",""amount"" FROM ""Transactions"" WHERE ""state""='approved') AS ""a"" GROUP BY ""month"",""country"""
148,"WITH ""tmp"" AS (SELECT ""a"".""trans_id"" AS ""id"",""b"".""country"",'checkback' AS ""state"",""b"".""amount"",""a"".""trans_date"" FROM ""chargebacks"" AS ""a"" LEFT JOIN ""transactions"" AS ""b"" ON ""a"".""trans_id""=""b"".""id"" UNION ALL SELECT * FROM ""transactions"" WHERE ""state""='approved') SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='checkback' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='checkback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""tmp"" GROUP BY ""month"",""country"""
149,"WITH ""t"" AS (SELECT LEFT(""c"".""trans_date"", 7) AS ""month"",""country"",'chargeback' AS ""state"",""amount"" FROM ""chargebacks"" AS ""c"" JOIN ""transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" UNION ALL SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",""state"",""amount"" FROM ""transactions"" AS ""t"" WHERE ""state""='approved') SELECT ""month"",""country"",SUM(""state""='approved') AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(""state""='chargeback') AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""t"" GROUP BY ""month"",""country"""
150,"WITH ""all_transactions"" AS (SELECT TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"",""t"".""country"",'chargeback' AS ""state"",""t"".""amount"" AS ""amount"" FROM ""Chargebacks"" AS ""c"" JOIN ""Transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" UNION ALL SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",""state"",""amount"" FROM ""Transactions"") SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='chargeback' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""all_transactions"" GROUP BY 1,2 HAVING ""approved_count""+""approved_amount""+""chargeback_count""+""chargeback_amount""!=0 ORDER BY ""month"""
151,"WITH ""tmp"" AS (SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",""id"",""state"",""amount"" FROM ""transactions"" WHERE ""state""='approved' UNION ALL SELECT LEFT(""a"".""trans_date"", 7) AS ""month"",""country"",""id"",'cb' AS ""state"",""amount"" FROM ""chargebacks"" AS ""a"" JOIN ""transactions"" AS ""b"" ON ""a"".""trans_id""=""b"".""id"") SELECT ""month"",""country"",COUNT(CASE WHEN ""state""='approved' THEN ""id"" ELSE NULL END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",COUNT(CASE WHEN ""state""='cb' THEN ""id"" ELSE NULL END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='cb' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""tmp"" GROUP BY 1,2 ORDER BY 1,2"
152,"WITH ""stacked"" AS (SELECT TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"",""country"",NULL AS ""approved_count"",NULL AS ""approved_amount"",COUNT(1) AS ""chargeback_count"",SUM(""amount"") AS ""chargeback_amount"" FROM ""chargebacks"" AS ""c"" LEFT JOIN ""transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" GROUP BY 1,2 UNION ALL SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(""state""='approved') AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",NULL AS ""chargeback_count"",NULL AS ""chargeback_amount"" FROM ""transactions"" GROUP BY 1,2) SELECT ""month"",""country"",COALESCE(SUM(""approved_count""), 0) AS ""approved_count"",COALESCE(SUM(""approved_amount""), 0) AS ""approved_amount"",COALESCE(SUM(""chargeback_count""), 0) AS ""chargeback_count"",COALESCE(SUM(""chargeback_amount""), 0) AS ""chargeback_amount"" FROM ""stacked"" GROUP BY 1,2 HAVING COALESCE(SUM(""approved_count""), 0)+COALESCE(SUM(""approved_amount""), 0)+COALESCE(SUM(""chargeback_count""), 0)+COALESCE(SUM(""chargeback_amount""), 0)!=0"
153,"SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='chargebacks' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargebacks' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT ""trans_id"" AS ""id"",""country"",'chargebacks' AS ""state"",""amount"",""Chargebacks"".""trans_date"" FROM ""Chargebacks"" JOIN ""Transactions"" ON ""Chargebacks"".""trans_id""=""Transactions"".""id"" UNION SELECT * FROM ""Transactions"" WHERE ""state""='approved') AS ""t"" GROUP BY ""month"",""country"""
154,"WITH ""t1"" AS (SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",COUNT(1) AS ""cnt1"",SUM(""amount"") AS ""sum1"" FROM ""transactions"" WHERE ""state""='approved' GROUP BY 1,2), ""t2"" AS (SELECT LEFT(""a"".""trans_date"", 7) AS ""month"",""country"",COUNT(1) AS ""cnt2"",SUM(""amount"") AS ""sum2"" FROM ""chargebacks"" AS ""a"" JOIN ""transactions"" AS ""b"" ON ""a"".""trans_id""=""b"".""id"" GROUP BY 1,2), ""t3"" AS (SELECT ""t1"".""month"",""country"" FROM ""t1"" UNION SELECT ""t2"".""month"",""country"" FROM ""t2"") SELECT ""t3"".""month"",""t3"".""country"",COALESCE(""cnt1"", 0) AS ""approved_count"",COALESCE(""sum1"", 0) AS ""approved_amount"",COALESCE(""cnt2"", 0) AS ""chargeback_count"",COALESCE(""sum2"", 0) AS ""chargeback_amount"" FROM (""t3"" LEFT JOIN ""t1"" ON ""t3"".""month""=""t1"".""month"" AND ""t3"".""country""=""t1"".""country"") LEFT JOIN ""t2"" ON ""t3"".""month""=""t2"".""month"" AND ""t3"".""country""=""t2"".""country"""
155,"WITH ""t1"" AS (SELECT *,LEFT(""trans_date"", 7) AS ""month"" FROM ""transactions"" WHERE ""state""='approved'), ""t2"" AS (SELECT ""month"",""country"",COUNT(DISTINCT ""id"") AS ""approved_count"",SUM(""amount"") AS ""approved_amount"" FROM ""t1"" GROUP BY ""month"",""country""), ""c1"" AS (SELECT ""c"".*,LEFT(""c"".""trans_date"", 7) AS ""month"",""amount"",""country"" FROM ""chargebacks"" AS ""c"" LEFT JOIN ""transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id""), ""c2"" AS (SELECT ""month"",""country"",COUNT(DISTINCT ""trans_id"") AS ""chargeback_count"",SUM(""amount"") AS ""chargeback_amount"" FROM ""c1"" GROUP BY ""month"",""country"") SELECT ""month"",""country"",COALESCE(""approved_count"", 0) AS ""approved_count"",COALESCE(""approved_amount"", 0) AS ""approved_amount"",COALESCE(""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""c2"" LEFT JOIN ""t2"" USING (""month"",""country"") UNION SELECT ""month"",""country"",COALESCE(""approved_count"", 0) AS ""approved_count"",COALESCE(""approved_amount"", 0) AS ""approved_amount"",COALESCE(""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""c2"" RIGHT JOIN ""t2"" USING (""month"",""country"")"
156,"SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='chargeback' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT ""c"".""trans_id"",""t"".""country"",'chargeback' AS ""state"",""t"".""amount"",""c"".""trans_date"" FROM ""Chargebacks"" AS ""c"" JOIN ""Transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" UNION ALL SELECT * FROM ""Transactions"") AS ""t1"" GROUP BY ""country"",""month"" HAVING ""approved_amount"">0 OR ""chargeback_amount"">0"
157,"WITH ""getApproved"" AS (SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"" FROM ""Transactions"" GROUP BY 1,2), ""getCharge"" AS (SELECT TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"",""t"".""country"",COUNT(1) AS ""chargeback_count"",SUM(""t"".""amount"") AS ""chargeback_amount"" FROM ""Chargebacks"" AS ""c"" JOIN ""Transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" GROUP BY 1,2), ""getUnion"" AS (SELECT COALESCE(""getApproved"".""month"", ""getCharge"".""month"") AS ""month"",COALESCE(""getApproved"".""country"", ""getCharge"".""country"") AS ""country"",COALESCE(""getApproved"".""approved_count"", 0) AS ""approved_count"",COALESCE(""getApproved"".""approved_amount"", 0) AS ""approved_amount"",COALESCE(""getCharge"".""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""getCharge"".""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""getApproved"" LEFT JOIN ""getCharge"" ON ""getApproved"".""month""=""getCharge"".""month"" AND ""getApproved"".""country""=""getCharge"".""country"" UNION SELECT COALESCE(""getApproved"".""month"", ""getCharge"".""month"") AS ""month"",COALESCE(""getApproved"".""country"", ""getCharge"".""country"") AS ""country"",COALESCE(""getApproved"".""approved_count"", 0) AS ""approved_count"",COALESCE(""getApproved"".""approved_amount"", 0) AS ""approved_amount"",COALESCE(""getCharge"".""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""getCharge"".""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""getApproved"" RIGHT JOIN ""getCharge"" ON ""getApproved"".""month""=""getCharge"".""month"" AND ""getApproved"".""country""=""getCharge"".""country"") SELECT * FROM ""getUnion"" WHERE ""approved_count""+""approved_amount""+""chargeback_count""+""chargeback_amount"">0"
158,"WITH ""temp"" AS ((SELECT * FROM ""Transactions"" WHERE ""state""='approved') UNION ALL (SELECT ""t"".""id"",""country"",'chargebacks' AS ""state"",""amount"",""c"".""trans_date"" FROM ""Transactions"" AS ""t"" RIGHT JOIN ""Chargebacks"" AS ""c"" ON ""c"".""trans_id""=""t"".""id"")) SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='chargebacks' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargebacks' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""temp"" GROUP BY 1,2"
159,"SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='back' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='back' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT LEFT(""c"".""trans_date"", 7) AS ""month"",""country"",'back' AS ""state"",""amount"" FROM ""Chargebacks"" AS ""c"" JOIN ""Transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" UNION ALL SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",""state"",""amount"" FROM ""Transactions"" WHERE ""state""='approved') AS ""tb"" GROUP BY ""month"",""country"""
160,"WITH ""cte"" AS ((SELECT * FROM ""Transactions"" WHERE ""state""='approved') UNION ALL SELECT ""t"".""id"",""country"",'chargebacks' AS ""state"",""amount"",""c"".""trans_date"" FROM ""Transactions"" AS ""t"" RIGHT JOIN ""Chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"") SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",COUNT(CASE WHEN ""state""='chargebacks' THEN 1 ELSE NULL END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargebacks' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""cte"" GROUP BY 1,2"
161,"WITH ""temp"" AS (SELECT ""t"".""id"",""country"",'chargebacks' AS ""state"",""amount"",TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"" FROM ""chargebacks"" AS ""c"" LEFT JOIN ""transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" UNION SELECT ""id"",""country"",""state"",""amount"",TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"" FROM ""transactions"" AS ""t"" WHERE ""state""='approved') SELECT ""month"",""country"",COUNT(CASE WHEN ""state""='approved' THEN ""id"" ELSE NULL END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",COUNT(CASE WHEN ""state""='chargebacks' THEN ""id"" ELSE NULL END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargebacks' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""temp"" GROUP BY ""month"",""country"""
162,"WITH ""cte"" AS (SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",""state"",""amount"" FROM ""Transactions"" AS ""a"" WHERE ""state""='approved' UNION ALL SELECT LEFT(""a"".""trans_date"", 7) AS ""month"",""b"".""country"",'back' AS ""state"",""b"".""amount"" FROM ""Chargebacks"" AS ""a"" LEFT JOIN ""Transactions"" AS ""b"" ON ""a"".""trans_id""=""b"".""id"") SELECT ""month"",""country"",SUM(""state""='approved') AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(""state""='back') AS ""chargeback_count"",SUM(CASE WHEN ""state""='back' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""cte"" GROUP BY ""month"",""country"""
163,"WITH ""CTE"" AS (SELECT ""trans_id"",""country"",'Chargebacks' AS ""state"",""amount"",""C1"".""trans_date"" FROM ""Chargebacks"" AS ""C1"" LEFT JOIN ""Transactions"" AS ""T1"" ON ""C1"".""trans_id""=""T1"".""id"" WHERE ""C1"".""trans_id"" IS NOT NULL UNION ALL SELECT * FROM ""Transactions"" WHERE ""state""!='declined') SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",SUM(""state""='approved') AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(""state""='Chargebacks') AS ""chargeback_count"",SUM(CASE WHEN ""state""='Chargebacks' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""CTE"" GROUP BY 1,2 ORDER BY 1,2"
164,"SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",COUNT(CASE WHEN ""state""='approved' THEN ""id"" ELSE NULL END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",COUNT(CASE WHEN ""state""='chargeback' THEN ""id"" ELSE NULL END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT ""id"",""country"",""state"",""amount"",""trans_date"" FROM ""Transactions"" WHERE ""state""='approved' UNION ALL SELECT ""a"".""id"",""a"".""country"",'chargeback' AS ""state"",""a"".""amount"",""b"".""trans_date"" FROM ""Transactions"" AS ""a"" JOIN ""Chargebacks"" AS ""b"" ON ""a"".""id""=""b"".""trans_id"") AS ""a"" GROUP BY ""month"",""country"""
165,"SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='chargebacks' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargebacks' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",""state"",""amount"",""id"" FROM ""Transactions"" UNION ALL SELECT TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"",""t"".""country"",'chargebacks' AS ""state"",""t"".""amount"",""c"".""trans_id"" FROM ""chargebacks"" AS ""c"" LEFT JOIN ""transactions"" AS ""t"" ON ""t"".""id""=""c"".""trans_id"") AS ""b"" GROUP BY 1,2 HAVING SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END)!=0 OR SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END)!=0 OR SUM(CASE WHEN ""state""='chargebacks' THEN 1 ELSE 0 END)!=0 OR SUM(CASE WHEN ""state""='chargebacks' THEN ""amount"" ELSE 0 END)!=0"
166,"WITH ""cte"" AS (SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",CASE WHEN ""state""='approved' THEN 1 ELSE 0 END AS ""approved_count"",CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END AS ""approved_amount"",0 AS ""chargeback_count"",0 AS ""chargeback_amount"" FROM ""Transactions"" UNION ALL SELECT LEFT(""c"".""trans_date"", 7) AS ""month"",""t"".""country"" AS ""country"",0 AS ""approved_count"",0 AS ""approved_amount"",1 AS ""chargeback_count"",""t"".""amount"" AS ""chargeback_amount"" FROM ""Chargebacks"" AS ""c"" LEFT JOIN ""Transactions"" AS ""t"" ON ""t"".""id""=""c"".""trans_id"") SELECT ""month"",""country"",SUM(""approved_count"") AS ""approved_count"",SUM(""approved_amount"") AS ""approved_amount"",SUM(""chargeback_count"") AS ""chargeback_count"",SUM(""chargeback_amount"") AS ""chargeback_amount"" FROM ""cte"" GROUP BY ""month"",""country"" HAVING SUM(""approved_count"")>0 OR SUM(""approved_amount"")>0 OR SUM(""chargeback_count"")>0 OR SUM(""chargeback_amount"")>0"
167,"WITH ""cte"" AS (SELECT ""id"",""country"",'bc' AS ""state"",""amount"",""c"".""trans_date"" FROM ""Transactions"" AS ""t"" RIGHT JOIN ""Chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"" UNION ALL SELECT ""id"",""country"",""state"",""amount"",""trans_date"" FROM ""Transactions"") SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='bc' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='bc' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""cte"" GROUP BY 1,2 HAVING ""approved_count""+""approved_amount""+""chargeback_count""+""chargeback_amount""!=0"
168,"WITH ""cte"" AS (SELECT ""t"".""id"",""country"",""state"",""amount"",""t"".""trans_date"" FROM ""Transactions"" AS ""t"" LEFT JOIN ""Chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"" UNION SELECT ""c"".""trans_id"",""country"",'chargeback',""amount"",""c"".""trans_date"" FROM ""Transactions"" AS ""t"" RIGHT JOIN ""Chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"") SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(""state""='chargeback') AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""cte"" GROUP BY ""month"",""country"" HAVING ""approved_count""+""approved_amount""+""chargeback_count""+""chargeback_amount""!=0"
169,"SELECT ""month"",""country"",SUM(""approved_count"") AS ""approved_count"",SUM(""approved_amount"") AS ""approved_amount"",SUM(""chargeback_count"") AS ""chargeback_count"",SUM(""chargeback_amount"") AS ""chargeback_amount"" FROM (SELECT TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"",""t"".""country"",0 AS ""approved_count"",0 AS ""approved_amount"",COUNT(""c"".""trans_id"") AS ""chargeback_count"",SUM(""t"".""amount"") AS ""chargeback_amount"" FROM ""Transactions"" AS ""t"" JOIN ""chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"" GROUP BY 1,2 UNION SELECT TO_CHAR(""t"".""trans_date"", 'YYYY-%m') AS ""month"",""country"",COALESCE(COUNT(DISTINCT CASE WHEN ""state""='approved' THEN ""t"".""id"" END), 0) AS ""approved_count"",COALESCE(SUM(CASE WHEN ""state""='approved' THEN ""amount"" END), 0) AS ""approved_amount"",0 AS ""chargeback_count"",0 AS ""chargeback_amount"" FROM ""Transactions"" AS ""t"" LEFT JOIN ""chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"" GROUP BY 1,2) AS ""a"" GROUP BY 1,2 HAVING (""approved_count""+""approved_amount""+""chargeback_count""+""chargeback_amount"")>0"
170,"SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='chargeback' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT LEFT(""a"".""trans_date"", 7) AS ""month"",""country"",'chargeback' AS ""state"",""amount"" FROM ""Chargebacks"" AS ""a"" JOIN ""Transactions"" AS ""b"" ON ""a"".""trans_id""=""b"".""id"" UNION ALL SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",""state"",""amount"" FROM ""Transactions"" WHERE ""state""='approved') AS ""CTE"" GROUP BY ""month"",""country"""
171,"WITH ""temp_transaction"" AS (SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"" FROM ""transactions"" WHERE ""state""='approved' GROUP BY TO_CHAR(""trans_date"", 'YYYY-%m'),""country""), ""temp_chargeback"" AS (SELECT TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"",""t"".""country"",COUNT(""trans_id"") AS ""chargeback_count"",SUM(""t"".""amount"") AS ""chargeback_amount"" FROM ""chargebacks"" AS ""c"" LEFT JOIN ""transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" GROUP BY 1,2) SELECT ""t1"".""month"",""t1"".""country"",""approved_count"",""approved_amount"",CASE WHEN ""chargeback_count"" IS NULL THEN 0 ELSE ""chargeback_count"" END AS ""chargeback_count"",CASE WHEN ""chargeback_amount"" IS NULL THEN 0 ELSE ""chargeback_amount"" END AS ""chargeback_amount"" FROM ""temp_transaction"" AS ""t1"" LEFT JOIN ""temp_chargeback"" AS ""t2"" ON ""t1"".""month""=""t2"".""month"" AND ""t1"".""country""=""t2"".""country"" UNION SELECT ""t2"".""month"",""t2"".""country"",CASE WHEN ""approved_count"" IS NULL THEN 0 ELSE ""approved_count"" END AS ""approved_count"",CASE WHEN ""approved_amount"" IS NULL THEN 0 ELSE ""approved_amount"" END AS ""approved_amount"",""chargeback_count"",""chargeback_amount"" FROM ""temp_chargeback"" AS ""t2"" LEFT JOIN ""temp_transaction"" AS ""t1"" ON ""t1"".""month""=""t2"".""month"" AND ""t1"".""country""=""t2"".""country"""
172,"WITH ""cte1"" AS (SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"" FROM ""Transactions"" GROUP BY 1,2), ""cte2"" AS (SELECT TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"",""t"".""country"",COUNT(""c"".""trans_id"") AS ""chargeback_count"",SUM(""t"".""amount"") AS ""chargeback_amount"" FROM ""Transactions"" AS ""t"" JOIN ""Chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"" GROUP BY 1,2) (SELECT ""c2"".""month"",""c2"".""country"",COALESCE(""approved_count"", 0) AS ""approved_count"",COALESCE(""approved_amount"", 0) AS ""approved_amount"",""chargeback_count"",""chargeback_amount"" FROM ""cte2"" AS ""c2"" LEFT JOIN ""cte1"" AS ""c1"" ON ""c2"".""month""=""c1"".""month"" AND ""c2"".""country""=""c1"".""country"") UNION (SELECT ""c1"".""month"",""c1"".""country"",""approved_count"",""approved_amount"",COALESCE(""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""cte1"" AS ""c1"" LEFT JOIN ""cte2"" AS ""c2"" ON ""c2"".""month""=""c1"".""month"" AND ""c2"".""country""=""c1"".""country"" WHERE ""approved_count""!=0) ORDER BY 1,2"
173,"SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='chargeback' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT * FROM ""Transactions"" UNION SELECT ""C"".""trans_id"" AS ""id"",""T"".""country"",'chargeback' AS ""state"",""T"".""amount"",""C"".""trans_date"" AS ""trans_date"" FROM (""Transactions"" AS ""T"") CROSS JOIN ""Chargebacks"" AS ""C"" WHERE ""C"".""trans_id""=""T"".""id"") AS ""temp"" GROUP BY ""month"",""country"" HAVING (""approved_count""+""approved_amount""+""chargeback_count""+""chargeback_amount"")>0"
174,"SELECT ""month"",""country"",SUM(""approved_count"") AS ""approved_count"",SUM(""approved_amount"") AS ""approved_amount"",SUM(""chargeback_count"") AS ""chargeback_count"",SUM(""chargeback_amount"") AS ""chargeback_amount"" FROM (SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",COUNT(""id"") AS ""approved_count"",SUM(""amount"") AS ""approved_amount"",0 AS ""chargeback_count"",0 AS ""chargeback_amount"" FROM ""transactions"" WHERE ""state""='approved' GROUP BY ""month"",""country"" UNION ALL SELECT TO_CHAR(""b"".""trans_date"", 'YYYY-%m') AS ""month"",""a"".""country"",0 AS ""approved_count"",0 AS ""approved_amount"",COUNT(""b"".""trans_id"") AS ""chargeback_count"",SUM(""a"".""amount"") AS ""chargeback_amount"" FROM ""chargebacks"" AS ""b"" JOIN ""transactions"" AS ""a"" ON ""b"".""trans_id""=""a"".""id"" GROUP BY ""month"",""country"") AS ""sub"" GROUP BY ""month"",""country"""
175,"SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='back' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='back' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT LEFT(""chargebacks"".""trans_date"", 7) AS ""month"",""country"",'back' AS ""state"",""amount"" FROM ""chargebacks"" JOIN ""transactions"" ON ""chargebacks"".""trans_id""=""transactions"".""id"" UNION ALL SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",""state"",""amount"" FROM ""transactions"" WHERE ""state""='approved') AS ""s"" GROUP BY ""month"",""country"""
176,"SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='back' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='back' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT SUBSTR(""trans_date"", 1, 7) AS ""month"",""country"",'approved' AS ""state"",""amount"" FROM ""Transactions"" WHERE ""state""='approved' UNION ALL SELECT SUBSTR(""c"".""trans_date"", 1, 7) AS ""month"",""t"".""country"",'back' AS ""state"",""t"".""amount"" FROM ""Chargebacks"" AS ""c"" JOIN ""Transactions"" AS ""t"" ON ""t"".""id""=""c"".""trans_id"") AS ""tc"" GROUP BY 1,2"
177,"WITH ""approved"" AS (SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",COUNT(""state"") AS ""approved_count"",SUM(""amount"") AS ""approved_amount"" FROM ""Transactions"" WHERE ""state""='approved' GROUP BY TO_CHAR(""trans_date"", 'YYYY-%m'),""country""), ""chargeback"" AS (SELECT TO_CHAR(""b"".""trans_date"", 'YYYY-%m') AS ""month"",""a"".""country"",COUNT(""a"".""id"") AS ""chargeback_count"",SUM(""a"".""amount"") AS ""chargeback_amount"" FROM (""Transactions"" AS ""a"") CROSS JOIN ""Chargebacks"" AS ""b"" WHERE ""a"".""id""=""b"".""trans_id"" GROUP BY TO_CHAR(""b"".""trans_date"", 'YYYY-%m'),""a"".""country"") (SELECT ""t2"".""month"",""t2"".""country"",COALESCE(""t1"".""approved_count"", 0) AS ""approved_count"",COALESCE(""t1"".""approved_amount"", 0) AS ""approved_amount"",""t2"".""chargeback_count"",""t2"".""chargeback_amount"" FROM ""approved"" AS ""t1"" RIGHT JOIN ""chargeback"" AS ""t2"" ON (""t1"".""month""=""t2"".""month"" AND ""t1"".""country""=""t2"".""country"") ORDER BY ""t2"".""month"",""t2"".""country"") UNION (SELECT ""t1"".""month"",""t1"".""country"",""t1"".""approved_count"" AS ""approved_count"",""t1"".""approved_amount"" AS ""approved_amount"",COALESCE(""t2"".""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""t2"".""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""approved"" AS ""t1"" LEFT JOIN ""chargeback"" AS ""t2"" ON (""t1"".""month""=""t2"".""month"" AND ""t1"".""country""=""t2"".""country"") ORDER BY ""t1"".""month"",""t1"".""country"")"
178,"WITH ""mod_chargeback"" AS (SELECT ""t"".""country"" AS ""country"",""t"".""amount"",'Chargeback' AS ""state"",TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"" FROM ""transactions"" AS ""t"" JOIN ""Chargebacks"" AS ""c"" ON ""c"".""trans_id""=""t"".""id"") SELECT ""m1"".""month"",""m1"".""country"",COALESCE(SUM(CASE WHEN ""m1"".""state""='approved' THEN 1 ELSE 0 END), 0) AS ""approved_count"",COALESCE(SUM(CASE WHEN ""m1"".""state""='approved' THEN ""m1"".""amount"" ELSE 0 END), 0) AS ""approved_amount"",COALESCE(SUM(CASE WHEN ""m1"".""state""='Chargeback' THEN 1 ELSE 0 END), 0) AS ""chargeback_count"",COALESCE(SUM(CASE WHEN ""m1"".""state""='Chargeback' THEN ""m1"".""amount"" ELSE 0 END), 0) AS ""chargeback_amount"" FROM (SELECT TO_CHAR(""t"".""trans_date"", 'YYYY-%m') AS ""month"",""t"".""country"",""t"".""amount"",""t"".""state"" FROM ""transactions"" AS ""t"" UNION ALL SELECT ""m"".""month"",""m"".""country"",""m"".""amount"",""m"".""state"" FROM ""mod_chargeback"" AS ""m"") AS ""m1"" WHERE ""m1"".""state""!='declined' GROUP BY 1,2"
179,"SELECT SUBSTR(""trans_date"", 1, 7) AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='chargeback' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT ""c"".""trans_id"" AS ""id"",""t"".""country"",'chargeback' AS ""state"",""t"".""amount"",""c"".""trans_date"" FROM ""Chargebacks"" AS ""c"" JOIN ""Transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" UNION ALL SELECT * FROM ""Transactions"") AS ""a"" GROUP BY 1,2 HAVING ""approved_count"">0 OR ""chargeback_count"">0"
180,"WITH ""table1"" AS (SELECT ""country"",TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",COUNT(""id"") AS ""approved_count"",SUM(""amount"") AS ""approved_amount"" FROM ""Transactions"" WHERE ""state""='approved' GROUP BY ""country"",""month""), ""table2"" AS (SELECT ""country"",TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"",COUNT(""trans_id"") AS ""chargeback_count"",SUM(""amount"") AS ""chargeback_amount"" FROM ""Chargebacks"" AS ""c"" JOIN ""Transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" GROUP BY ""country"",""month""), ""table3"" AS (SELECT ""country"",""month"",""approved_count"",""approved_amount"",NULL AS ""chargeback_count"",NULL AS ""chargeback_amount"" FROM ""table1"" UNION ALL SELECT ""country"",""month"",NULL AS ""approved_count"",NULL AS ""approved_amount"",""chargeback_count"",""chargeback_amount"" FROM ""table2"") SELECT ""country"",""month"",SUM(COALESCE(""approved_count"", 0)) AS ""approved_count"",SUM(COALESCE(""approved_amount"", 0)) AS ""approved_amount"",SUM(COALESCE(""chargeback_count"", 0)) AS ""chargeback_count"",SUM(COALESCE(""chargeback_amount"", 0)) AS ""chargeback_amount"" FROM ""table3"" GROUP BY ""country"",""month"""
181,"SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",SUM(""state""='approved') AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(""state""='chargebacks') AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargebacks' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ((SELECT * FROM ""Transactions"" WHERE ""state""='approved') UNION ALL (SELECT ""a"".""id"",""country"",'chargebacks' AS ""state"",""amount"",""b"".""trans_date"" FROM ""Transactions"" AS ""a"" RIGHT JOIN ""Chargebacks"" AS ""b"" ON ""a"".""id""=""b"".""trans_id"")) AS ""c"" GROUP BY LEFT(""trans_date"", 7),""country"""
182,"SELECT ""month"",""country"",SUM(""state""='approved') AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(""state""='back') AS ""chargeback_count"",SUM(CASE WHEN ""state""='back' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT LEFT(""c"".""trans_date"", 7) AS ""month"",""t"".""country"",'back' AS ""state"",""t"".""amount"" AS ""amount"" FROM ""Chargebacks"" AS ""c"" JOIN ""Transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" UNION ALL SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",""state"",""amount"" FROM ""Transactions"" WHERE ""state""='approved') AS ""t"" GROUP BY ""month"",""country"""
183,"SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(""state""='approved') AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(""state""='chargeback') AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT DISTINCT * FROM ""Transactions"" WHERE ""state""='approved' UNION ALL SELECT DISTINCT ""C"".""trans_id"" AS ""id"",""T"".""country"",'chargeback' AS ""state"",""T"".""amount"",""C"".""trans_date"" FROM ""Chargebacks"" AS ""C"" LEFT JOIN ""Transactions"" AS ""T"" ON ""C"".""trans_id""=""T"".""id"") AS ""final"" GROUP BY ""month"",""country"""
184,"WITH ""cte1"" AS (SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"" FROM ""transactions"" GROUP BY ""month"",""country""), ""cte2"" AS (SELECT TO_CHAR(""chargebacks"".""trans_date"", 'YYYY-%m') AS ""month"",""transactions"".""country"",COUNT(""transactions"".""id"") AS ""chargeback_count"",SUM(""transactions"".""amount"") AS ""chargeback_amount"" FROM ""chargebacks"" JOIN ""transactions"" ON ""chargebacks"".""trans_id""=""transactions"".""id"" GROUP BY ""month"",""country"") (SELECT ""c2"".""month"",""c2"".""country"",COALESCE(""c1"".""approved_count"", 0) AS ""approved_count"",COALESCE(""c1"".""approved_amount"", 0) AS ""approved_amount"",""c2"".""chargeback_count"",""c2"".""chargeback_amount"" FROM ""cte1"" AS ""c1"" RIGHT JOIN ""cte2"" AS ""c2"" ON (""c1"".""month""=""c2"".""month"" AND ""c1"".""country""=""c2"".""country"")) UNION (SELECT ""c1"".""month"",""c1"".""country"",""c1"".""approved_count"",""c1"".""approved_amount"",COALESCE(""c2"".""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""c2"".""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""cte1"" AS ""c1"" LEFT JOIN ""cte2"" AS ""c2"" ON (""c1"".""month""=""c2"".""month"" AND ""c1"".""country""=""c2"".""country"") WHERE ""c1"".""approved_count""!=0) ORDER BY ""month"",""country"""
185,"SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='back' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='back' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT LEFT(""chargebacks"".""trans_date"", 7) AS ""month"",""country"",'back' AS ""state"",""amount"" FROM ""chargebacks"" JOIN ""transactions"" ON ""chargebacks"".""trans_id""=""transactions"".""id"" UNION ALL SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",""state"",""amount"" FROM ""transactions"" WHERE ""state""='approved') AS ""s"" GROUP BY ""month"",""country"""
186,"WITH ""chargebackswamount"" AS (SELECT TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"",""t"".""country"",SUM(""t"".""amount"") AS ""chargeback_amount"",COUNT(""t"".""amount"") AS ""chargeback_count"" FROM ""Chargebacks"" AS ""c"" JOIN ""Transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" GROUP BY TO_CHAR(""c"".""trans_date"", 'YYYY-%m'),""t"".""country""), ""transactionall"" AS (SELECT TO_CHAR(""t"".""trans_date"", 'YYYY-%m') AS ""month"",""t"".""country"",SUM(CASE WHEN ""t"".""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""t"".""state""='approved' THEN ""t"".""amount"" ELSE 0 END) AS ""approved_amount"" FROM ""Transactions"" AS ""t"" GROUP BY TO_CHAR(""t"".""trans_date"", 'YYYY-%m'),""t"".""country"") SELECT ""t"".""month"",""t"".""country"",""t"".""approved_count"",""t"".""approved_amount"",COALESCE(""c"".""chargeback_amount"", 0) AS ""chargeback_amount"",COALESCE(""c"".""chargeback_count"", 0) AS ""chargeback_count"" FROM ""transactionall"" AS ""t"" LEFT JOIN ""chargebackswamount"" AS ""c"" ON ""t"".""month""=""c"".""month"" AND ""t"".""country""=""c"".""country"" HAVING ""chargeback_count"">0 OR ""approved_count"">0 UNION SELECT ""c"".""month"",""c"".""country"",COALESCE(""t"".""approved_count"", 0) AS ""approved_count"",COALESCE(""t"".""approved_amount"", 0) AS ""approved_amount"",""c"".""chargeback_amount"",""c"".""chargeback_count"" FROM ""chargebackswamount"" AS ""c"" LEFT JOIN ""transactionall"" AS ""t"" ON ""t"".""month""=""c"".""month"" AND ""t"".""country""=""c"".""country"" HAVING ""chargeback_count"">0 OR ""approved_count"">0"
187,"SELECT ""T1"".""month"",""T1"".""country"",SUM(""approved_count"") AS ""approved_count"",SUM(""approved_amount"") AS ""approved_amount"",SUM(""chargeback_count"") AS ""chargeback_count"",SUM(""chargeback_amount"") AS ""chargeback_amount"" FROM (SELECT LEFT(""C"".""trans_date"", 7) AS ""month"",""country"",0 AS ""approved_count"",0 AS ""approved_amount"",COUNT(""amount"") AS ""chargeback_count"",SUM(""amount"") AS ""chargeback_amount"" FROM ""Transactions"" AS ""T"" RIGHT JOIN ""Chargebacks"" AS ""C"" ON ""T"".""id""=""C"".""trans_id"" GROUP BY 1,2 UNION ALL SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",COUNT(""amount""),SUM(""amount""),0,0 FROM ""Transactions"" WHERE ""state""='approved' GROUP BY 1,2) AS ""T1"" GROUP BY 1,2"
188,"SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='chargeback' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ((SELECT LEFT(""t"".""trans_date"", 7) AS ""month"",""t"".""country"",""amount"",'approved' AS ""state"" FROM ""Transactions"" AS ""t"" WHERE ""state""='approved') UNION ALL (SELECT LEFT(""c"".""trans_date"", 7) AS ""month"",""t"".""country"",""amount"",'chargeback' AS ""state"" FROM ""Transactions"" AS ""t"" JOIN ""Chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"")) AS ""t2"" GROUP BY ""t2"".""month"",""t2"".""country"""
189,"SELECT ""a"".""month"",""a"".""country"",SUM(""a"".""approved_count"") AS ""approved_count"",SUM(""a"".""approved_amount"") AS ""approved_amount"",SUM(""a"".""chargeback_count"") AS ""chargeback_count"",SUM(""a"".""chargeback_amount"") AS ""chargeback_amount"" FROM (SELECT SUBSTRING(""trans_date"", 1, 7) AS ""month"",""country"",COUNT(1) AS ""approved_count"",SUM(""amount"") AS ""approved_amount"",0 AS ""chargeback_count"",0 AS ""chargeback_amount"" FROM ""Transactions"" AS ""t"" WHERE ""state""='approved' GROUP BY ""month"",""country"" UNION ALL SELECT SUBSTRING(""c"".""trans_date"", 1, 7) AS ""month"",""t"".""country"" AS ""country"",0 AS ""approved_count"",0 AS ""approved_amount"",COUNT(1) AS ""chargeback_count"",SUM(""t"".""amount"") AS ""chargeback_amount"" FROM ""Chargebacks"" AS ""c"" JOIN ""Transactions"" AS ""t"" ON ""t"".""id""=""c"".""trans_id"" GROUP BY ""month"",""country"") AS ""a"" GROUP BY ""a"".""month"",""a"".""country"""
190,"WITH ""t1"" AS (SELECT ""id"",""country"",""state"",""amount"",LEFT(""trans_date"", 7) AS ""month"" FROM ""Transactions""), ""t2"" AS (SELECT ""trans_id"" AS ""id"",LEFT(""trans_date"", 7) AS ""month"" FROM ""Chargebacks"") SELECT ""t3"".""month"",""t3"".""country"",""t3"".""approved_count"",""t3"".""approved_amount"",COALESCE(""t4"".""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""t4"".""chargeback_amount"", 0) AS ""chargeback_amount"" FROM (SELECT ""month"",""country"",COALESCE(COUNT(""id""), 0) AS ""approved_count"",COALESCE(SUM(""amount""), 0) AS ""approved_amount"" FROM ""t1"" WHERE ""state""='approved' GROUP BY ""month"",""country"") AS ""t3"" LEFT JOIN (SELECT ""month"",""country"",COALESCE(COUNT(""id""), 0) AS ""chargeback_count"",COALESCE(SUM(""amount""), 0) AS ""chargeback_amount"" FROM (SELECT ""t2"".""id"",""t2"".""month"",""t1"".""country"",""t1"".""amount"" FROM ""t1"" JOIN ""t2"" ON ""t1"".""id""=""t2"".""id"") AS ""t"" GROUP BY ""month"",""country"") AS ""t4"" ON ""t3"".""month""=""t4"".""month"" AND ""t3"".""country""=""t4"".""country"" WHERE ""approved_count""!=0 OR ""approved_amount""!=0 OR ""chargeback_count""!=0 OR ""chargeback_amount""!=0 UNION SELECT ""t6"".""month"",""t6"".""country"",COALESCE(""t5"".""approved_count"", 0) AS ""chargeback_count"",COALESCE(""t5"".""approved_amount"", 0) AS ""chargeback_amount"",""t6"".""chargeback_count"",""t6"".""chargeback_amount"" FROM (SELECT ""month"",""country"",COALESCE(COUNT(""id""), 0) AS ""approved_count"",COALESCE(SUM(""amount""), 0) AS ""approved_amount"" FROM ""t1"" WHERE ""state""='approved' GROUP BY ""month"",""country"") AS ""t5"" RIGHT JOIN (SELECT ""month"",""country"",COALESCE(COUNT(""id""), 0) AS ""chargeback_count"",COALESCE(SUM(""amount""), 0) AS ""chargeback_amount"" FROM (SELECT ""t2"".""id"",""t2"".""month"",""t1"".""country"",""t1"".""amount"" FROM ""t1"" JOIN ""t2"" ON ""t1"".""id""=""t2"".""id"") AS ""t0"" GROUP BY ""month"",""country"") AS ""t6"" ON ""t5"".""month""=""t6"".""month"" AND ""t5"".""country""=""t6"".""country"" WHERE ""approved_count""!=0 OR ""approved_amount""!=0 OR ""chargeback_count""!=0 OR ""chargeback_amount""!=0"
191,"SELECT ""month"",""country"",SUM(CASE WHEN ""tag""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""tag""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""tag""='chargeback' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""tag""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",""amount"",'approved' AS ""tag"" FROM ""Transactions"" WHERE ""state""='approved' UNION ALL SELECT LEFT(""c2"".""trans_date"", 7) AS ""month"",""country"",""amount"",'chargeback' AS ""tag"" FROM ""Chargebacks"" AS ""c2"" LEFT JOIN ""Transactions"" AS ""t2"" ON ""t2"".""id""=""c2"".""trans_id"") AS ""temp"" GROUP BY ""country"",""month"""
192,"WITH ""ap"" AS (SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",COUNT(1) AS ""approved_count"",SUM(""amount"") AS ""approved_amount"" FROM ""transactions"" WHERE ""state""='approved' GROUP BY TO_CHAR(""trans_date"", 'YYYY-%m'),""country""), ""cb"" AS (SELECT TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"",""country"",COUNT(1) AS ""chargeback_count"",SUM(""amount"") AS ""chargeback_amount"" FROM ""chargebacks"" AS ""c"" JOIN ""transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" GROUP BY TO_CHAR(""c"".""trans_date"", 'YYYY-%m'),""country"") SELECT ""ap"".""month"" AS ""month"",""ap"".""country"" AS ""country"",""approved_count"",""approved_amount"",COALESCE(""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""ap"" LEFT JOIN ""cb"" ON ""ap"".""month""=""cb"".""month"" AND ""ap"".""country""=""cb"".""country"" UNION SELECT ""cb"".""month"" AS ""month"",""cb"".""country"" AS ""country"",COALESCE(""approved_count"", 0) AS ""approved_count"",COALESCE(""approved_amount"", 0) AS ""approved_amount"",""chargeback_count"",""chargeback_amount"" FROM ""ap"" RIGHT JOIN ""cb"" ON ""ap"".""month""=""cb"".""month"" AND ""ap"".""country""=""cb"".""country"""
193,"WITH ""sub"" AS (SELECT ""id"",""country"",'Chargeback' AS ""state"",""amount"",""c"".""trans_date"" FROM ""Transactions"" AS ""t"" RIGHT JOIN ""Chargebacks"" AS ""c"" ON ""c"".""trans_id""=""t"".""id"" UNION SELECT ""id"",""country"",""state"",""amount"",""trans_date"" FROM ""Transactions"" AS ""t"") SELECT SUBSTRING(""trans_date"", 1, 7) AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='Chargeback' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='Chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""sub"" WHERE ""state"" IN ('approved','chargeback') GROUP BY 1,2"
194,"SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='back' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='back' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT LEFT(""chargebacks"".""trans_date"", 7) AS ""month"",""country"",'back' AS ""state"",""amount"" FROM ""chargebacks"" JOIN ""transactions"" ON ""chargebacks"".""trans_id""=""transactions"".""id"" UNION ALL SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",""state"",""amount"" FROM ""transactions"" WHERE ""state""='approved') AS ""s"" GROUP BY ""month"",""country"""
195,"WITH ""AllTxns"" AS (SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",""state"",""amount"" FROM ""Transactions"" WHERE ""state""='approved' UNION ALL SELECT LEFT(""C"".""trans_date"", 7) AS ""month"",""T"".""country"",'chargeback' AS ""state"",""T"".""amount"" FROM ""Chargebacks"" AS ""C"" JOIN ""Transactions"" AS ""T"" ON ""T"".""id""=""C"".""trans_id"") SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='chargeback' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""AllTxns"" GROUP BY ""month"",""country"""
196,"SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",COUNT(CASE WHEN ""state""='approved' THEN 1 ELSE NULL END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",COUNT(CASE WHEN ""state""='chargeback' THEN 1 ELSE NULL END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT ""c"".""trans_id"",""t"".""country"",'chargeback' AS ""state"",""amount"",""c"".""trans_date"" FROM ""Chargebacks"" AS ""c"" JOIN ""Transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" UNION ALL SELECT ""id"",""country"",""state"",""amount"",""trans_date"" FROM ""Transactions"") AS ""a"" GROUP BY 1,2 HAVING ""approved_amount""!=0 OR ""chargeback_amount""!=0 ORDER BY 1,2"
197,"WITH ""temp"" AS (SELECT ""id"",""country"",'charge' AS ""state"",""amount"",LEFT(""Chargebacks"".""trans_date"", 7) AS ""month"" FROM ""Chargebacks"" LEFT JOIN ""Transactions"" ON ""Transactions"".""id""=""Chargebacks"".""trans_id"" UNION SELECT ""id"",""country"",""state"",""amount"",LEFT(""Transactions"".""trans_date"", 7) AS ""month"" FROM ""Transactions"" WHERE ""state""='approved') SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='charge' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='charge' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""temp"" GROUP BY ""month"",""country"""
198,"WITH ""temp1"" AS (SELECT LEFT(""Transactions"".""trans_date"", 7) AS ""month"",""country"",COUNT(""Transactions"".""id"") AS ""approved_count"",SUM(""Transactions"".""amount"") AS ""approved_amount"" FROM ""Transactions"" WHERE ""state""='approved' GROUP BY LEFT(""Transactions"".""trans_date"", 7),""country""), ""temp2"" AS (SELECT LEFT(""c"".""trans_date"", 7) AS ""month"",""t"".""country"",COUNT(""trans_id"") AS ""chargeback_count"",SUM(""t"".""amount"") AS ""chargeback_amount"" FROM ""chargebacks"" AS ""c"" LEFT JOIN ""transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" GROUP BY 1,2 ORDER BY 1,2) SELECT ""month"",""country"",COALESCE(""approved_count"", 0) AS ""approved_count"",COALESCE(""approved_amount"", 0) AS ""approved_amount"",COALESCE(""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""temp1"" LEFT JOIN ""temp2"" USING (""month"",""country"") UNION SELECT ""month"",""country"",COALESCE(""approved_count"", 0) AS ""approved_count"",COALESCE(""approved_amount"", 0) AS ""approved_amount"",COALESCE(""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""temp1"" RIGHT JOIN ""temp2"" USING (""month"",""country"")"
199,"WITH ""t1"" AS (SELECT LEFT(""c"".""trans_date"", 7) AS ""month"",SUM(""amount"") AS ""chargeback_amount"",COUNT(""trans_id"") AS ""chargeback_count"",""country"" FROM ""chargebacks"" AS ""c"" LEFT JOIN ""transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" GROUP BY LEFT(""c"".""trans_date"", 7),""country""), ""t2"" AS (SELECT LEFT(""trans_date"", 7) AS ""month"",SUM(""amount"") AS ""approved_amount"",COUNT(""id"") AS ""approved_count"",""country"" FROM ""transactions"" WHERE ""state""='approved' GROUP BY LEFT(""trans_date"", 7),""country""), ""t3"" AS (SELECT ""month"",""country"" FROM ""t1"" UNION SELECT ""month"",""country"" FROM ""t2"") SELECT ""month"",""country"",COALESCE(""approved_count"", 0) AS ""approved_count"",COALESCE(""approved_amount"", 0) AS ""approved_amount"",COALESCE(""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""chargeback_amount"", 0) AS ""chargeback_amount"" FROM (""t3"" LEFT JOIN ""t1"" USING (""month"",""country"")) LEFT JOIN ""t2"" USING (""month"",""country"") ORDER BY ""month"""
200,"WITH ""AGG_TRANSACTION"" AS (SELECT TO_CHAR(""TRANS_DATE"", 'YYYY-%m') AS ""MONTH"",""COUNTRY"",SUM(CASE WHEN ""STATE""='APPROVED' THEN 1 ELSE 0 END) AS ""APPROVED_COUNT"",SUM(CASE WHEN ""STATE""='APPROVED' THEN ""AMOUNT"" ELSE 0 END) AS ""APPROVED_AMOUNT"" FROM ""TRANSACTIONS"" GROUP BY TO_CHAR(""TRANS_DATE"", 'YYYY-%m'),""COUNTRY""), ""AGG_CHARGEBACKS"" AS (SELECT TO_CHAR(""C"".""TRANS_DATE"", 'YYYY-%m') AS ""MONTH"",""T"".""COUNTRY"",COUNT(""TRANS_ID"") AS ""chargeback_count"",SUM(""AMOUNT"") AS ""chargeback_amount"" FROM ""CHARGEBACKS"" AS ""C"" JOIN ""TRANSACTIONS"" AS ""T"" ON ""C"".""TRANS_ID""=""T"".""ID"" GROUP BY TO_CHAR(""C"".""TRANS_DATE"", 'YYYY-%m'),""T"".""COUNTRY"") SELECT ""T"".*,COALESCE(""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""AGG_TRANSACTION"" AS ""T"" LEFT JOIN ""AGG_CHARGEBACKS"" AS ""C"" USING (""MONTH"",""COUNTRY"") WHERE ""APPROVED_COUNT""!=0 UNION SELECT ""C"".""MONTH"",""C"".""COUNTRY"",COALESCE(""APPROVED_COUNT"", 0) AS ""APPROVED_COUNT"",COALESCE(""APPROVED_AMOUNT"", 0) AS ""APPROVED_AMOUNT"",""chargeback_count"",""chargeback_amount"" FROM ""AGG_TRANSACTION"" AS ""T"" RIGHT JOIN ""AGG_CHARGEBACKS"" AS ""C"" USING (""MONTH"",""COUNTRY"")"
201,"SELECT TO_CHAR(""a"".""trans_date"", 'YYYY-%m') AS ""month"",""a"".""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='chargeback' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT * FROM ""transactions"" UNION ALL SELECT ""t"".""id"",""t"".""country"",'chargeback' AS ""state"",""t"".""amount"",""c"".""trans_date"" FROM ""chargebacks"" AS ""c"" LEFT JOIN ""transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"") AS ""a"" GROUP BY TO_CHAR(""a"".""trans_date"", 'YYYY-%m'),""a"".""country"" HAVING ""approved_count"" OR ""chargeback_count"""
202,"SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='back' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='back' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT LEFT(""chargebacks"".""trans_date"", 7) AS ""month"",""country"",'back' AS ""state"",""amount"" FROM ""chargebacks"" JOIN ""transactions"" ON ""chargebacks"".""trans_id""=""transactions"".""id"" UNION ALL SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",""state"",""amount"" FROM ""transactions"" WHERE ""state""='approved') AS ""s"" GROUP BY ""month"",""country"""
203,"WITH ""t"" AS (SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",""amount"",'ap' AS ""ap_cb"" FROM ""transactions"" WHERE ""state""='approved' UNION ALL SELECT TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"",""country"",""amount"",'cb' AS ""ap_cb"" FROM ""chargebacks"" AS ""c"" JOIN ""transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"") SELECT ""month"",""country"",COUNT(CASE WHEN ""ap_cb""='ap' THEN 1 ELSE NULL END) AS ""approved_count"",SUM(CASE WHEN ""ap_cb""='ap' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",COUNT(CASE WHEN ""ap_cb""='cb' THEN 1 ELSE NULL END) AS ""chargeback_count"",SUM(CASE WHEN ""ap_cb""='cb' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""t"" GROUP BY ""month"",""country"""
204,"WITH ""chargebacks_two"" AS (SELECT ""c"".""trans_id"",""t"".""country"",'chargeback' AS ""state"",""t"".""amount"",""c"".""trans_date"" FROM ""Chargebacks"" AS ""c"" LEFT JOIN ""Transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"") SELECT TO_CHAR(""sub"".""trans_date"", 'YYYY-%m') AS ""month"",""sub"".""country"",SUM(CASE WHEN ""sub"".""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""sub"".""state""='approved' THEN ""sub"".""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""sub"".""state""='chargeback' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""sub"".""state""='chargeback' THEN ""sub"".""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT * FROM ""chargebacks_two"" UNION ALL (SELECT * FROM ""Transactions"" WHERE ""state""='approved')) AS ""sub"" GROUP BY 1,2"
205,"WITH ""cte"" AS (SELECT ""t"".* FROM ""transactions"" AS ""t"" WHERE ""state""='approved' UNION ALL SELECT ""trans_id"",""t"".""country"",'back' AS ""state"",""t"".""amount"",""c"".""trans_date"" FROM ""chargebacks"" AS ""c"" LEFT JOIN ""transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"") SELECT SUBSTR(""trans_date"", 1, 7) AS ""month"",""country"",SUM(""state""='approved') AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(""state""='back') AS ""chargeback_count"",SUM(CASE WHEN ""state""='back' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""cte"" GROUP BY 1,""country"""
206,"WITH ""approved_chargbacked_TABLE"" AS (SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",""state"",""amount"" FROM ""Transactions"" WHERE ""state""='approved' UNION ALL SELECT TO_CHAR(""C"".""trans_date"", 'YYYY-%m') AS ""month"",""country"",'chargbacked' AS ""state"",""amount"" FROM ""Chargebacks"" AS ""C"" JOIN ""Transactions"" AS ""T"" ON ""C"".""trans_id""=""T"".""id"") SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='chargbacked' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargbacked' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""approved_chargbacked_TABLE"" GROUP BY 1,2"
207,"SELECT LEFT(""temp"".""trans_date"", 7) AS ""month"",""temp"".""country"",SUM(""temp"".""state""='approved') AS ""approved_count"",SUM(CASE WHEN ""temp"".""state""='approved' THEN ""temp"".""amount"" ELSE 0 END) AS ""approved_amount"",SUM(""temp"".""state""='chargeback') AS ""chargeback_count"",SUM(CASE WHEN ""temp"".""state""='chargeback' THEN ""temp"".""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT * FROM ""transactions"" UNION ALL SELECT ""c"".""trans_id"" AS ""id"",""t"".""country"",'chargeback' AS ""state"",""t"".""amount"",""c"".""trans_date"" FROM ""chargebacks"" AS ""c"" LEFT JOIN ""transactions"" AS ""t"" ON ""t"".""id""=""c"".""trans_id"") AS ""temp"" GROUP BY LEFT(""temp"".""trans_date"", 7),""temp"".""country"" HAVING SUM(""temp"".""state""='approved')+SUM(CASE WHEN ""temp"".""state""='approved' THEN ""temp"".""amount"" ELSE 0 END)+SUM(""temp"".""state""='chargeback')+SUM(CASE WHEN ""temp"".""state""='chargeback' THEN ""temp"".""amount"" ELSE 0 END)!=0"
208,"WITH ""cte"" AS (SELECT * FROM ""Transactions"" UNION SELECT ""c"".""trans_id"",""country"",'chargeback',""amount"",""c"".""trans_date"" FROM ""Transactions"" AS ""t"" RIGHT JOIN ""Chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"") SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(""state""='approved') AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(""state""='chargeback') AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""cte"" GROUP BY ""month"",""country"" HAVING ""approved_count""+""chargeback_count""!=0"
209,"WITH ""trans_table"" AS (SELECT SUBSTRING(""trans_date"", 1, 7) AS ""month"",""country"",COUNT(1) AS ""approved_count"",SUM(""amount"") AS ""approved_amount"" FROM ""Transactions"" WHERE ""state""='approved' GROUP BY SUBSTRING(""trans_date"", 1, 7),""country""), ""chargeback_table"" AS (SELECT SUBSTRING(""c"".""trans_date"", 1, 7) AS ""month"",""t"".""country"" AS ""country"",COUNT(""c"".""trans_id"") AS ""chargeback_count"",SUM(""t"".""amount"") AS ""chargeback_amount"" FROM ""Chargebacks"" AS ""c"" LEFT JOIN ""Transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" GROUP BY 1,2) (SELECT ""tt"".""month"" AS ""month"",""tt"".""country"" AS ""country"",""tt"".""approved_count"" AS ""approved_count"",""tt"".""approved_amount"" AS ""approved_amount"",COALESCE(""ct"".""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""ct"".""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""trans_table"" AS ""tt"" LEFT JOIN ""chargeback_table"" AS ""ct"" ON ""tt"".""month""=""ct"".""month"" AND ""tt"".""country""=""ct"".""country"") UNION (SELECT ""ct"".""month"" AS ""month"",""ct"".""country"" AS ""country"",COALESCE(""tt"".""approved_count"", 0) AS ""approved_count"",COALESCE(""tt"".""approved_amount"", 0) AS ""approved_amount"",""ct"".""chargeback_count"" AS ""chargeback_count"",""ct"".""chargeback_amount"" AS ""chargeback_amount"" FROM ""trans_table"" AS ""tt"" RIGHT JOIN ""chargeback_table"" AS ""ct"" ON ""tt"".""month""=""ct"".""month"" AND ""tt"".""country""=""ct"".""country"")"
210,"WITH ""approved_transactions"" AS (SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",""amount"",'approved' AS ""type"" FROM ""Transactions"" WHERE ""state""='approved'), ""chargebacks_and_transactions"" AS (SELECT TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"",""t"".""country"" AS ""country"",""t"".""amount"" AS ""amount"",'chargeback' AS ""type"" FROM ""Chargebacks"" AS ""c"" JOIN ""Transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"") SELECT ""temp"".""month"" AS ""month"",""temp"".""country"" AS ""country"",SUM(CASE WHEN ""type""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""type""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""type""='chargeback' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""type""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT * FROM ""approved_transactions"" UNION ALL SELECT * FROM ""chargebacks_and_transactions"") AS ""temp"" GROUP BY 1,2 ORDER BY 2,1"
211,"WITH ""cte1"" AS (SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"" FROM ""transactions"" GROUP BY ""month"",""country""), ""cte2"" AS (SELECT TO_CHAR(""chargebacks"".""trans_date"", 'YYYY-%m') AS ""month"",""transactions"".""country"",COUNT(""transactions"".""id"") AS ""chargeback_count"",SUM(""transactions"".""amount"") AS ""chargeback_amount"" FROM ""chargebacks"" JOIN ""transactions"" ON ""chargebacks"".""trans_id""=""transactions"".""id"" GROUP BY ""month"",""country"") (SELECT ""c2"".""month"",""c2"".""country"",COALESCE(""c1"".""approved_count"", 0) AS ""approved_count"",COALESCE(""c1"".""approved_amount"", 0) AS ""approved_amount"",""c2"".""chargeback_count"",""c2"".""chargeback_amount"" FROM ""cte1"" AS ""c1"" RIGHT JOIN ""cte2"" AS ""c2"" ON (""c1"".""month""=""c2"".""month"" AND ""c1"".""country""=""c2"".""country"")) UNION (SELECT ""c1"".""month"",""c1"".""country"",""c1"".""approved_count"",""c1"".""approved_amount"",COALESCE(""c2"".""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""c2"".""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""cte1"" AS ""c1"" LEFT JOIN ""cte2"" AS ""c2"" ON (""c1"".""month""=""c2"".""month"" AND ""c1"".""country""=""c2"".""country"") WHERE ""c1"".""approved_count""!=0) ORDER BY ""month"",""country"""
212,"WITH ""approvals"" AS (SELECT SUBSTR(""trans_date"", 1, 7) AS ""month"",""country"",COUNT(""id"") AS ""approved_count"",SUM(""amount"") AS ""approved_amount"" FROM ""Transactions"" WHERE ""state""='approved' GROUP BY 1,2), ""charges"" AS (SELECT SUBSTR(""c"".""trans_date"", 1, 7) AS ""month"",""t"".""country"",COUNT(""c"".""trans_id"") AS ""chargeback_count"",SUM(""amount"") AS ""chargeback_amount"" FROM ""Chargebacks"" AS ""c"" JOIN ""Transactions"" AS ""t"" ON ""t"".""id""=""c"".""trans_id"" GROUP BY 1,2) SELECT ""a"".""month"",""a"".""country"",COALESCE(""a"".""approved_count"", 0) AS ""approved_count"",COALESCE(""a"".""approved_amount"", 0) AS ""approved_amount"",COALESCE(""c"".""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""c"".""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""approvals"" AS ""a"" LEFT JOIN ""charges"" AS ""c"" ON ""a"".""month""=""c"".""month"" AND ""a"".""country""=""c"".""country"" UNION SELECT ""c"".""month"",""c"".""country"",COALESCE(""a"".""approved_count"", 0) AS ""approved_count"",COALESCE(""a"".""approved_amount"", 0) AS ""approved_amount"",COALESCE(""c"".""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""c"".""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""approvals"" AS ""a"" RIGHT JOIN ""charges"" AS ""c"" ON ""a"".""month""=""c"".""month"" AND ""a"".""country""=""c"".""country"""
213,"WITH ""cte1"" AS (SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",COUNT(1) AS ""approved_count"",SUM(""amount"") AS ""approved_amount"" FROM ""transactions"" WHERE ""state""='approved' GROUP BY LEFT(""trans_date"", 7),""country""), ""cte2"" AS (SELECT COUNT(1) AS ""chargeback_count"",SUM(""amount"") AS ""chargeback_amount"",LEFT(""c"".""trans_date"", 7) AS ""month"",""country"" FROM ""chargebacks"" AS ""c"" LEFT JOIN ""transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" GROUP BY LEFT(""c"".""trans_date"", 7),""country"") SELECT ""cte1"".""month"",""cte1"".""country"",""cte1"".""approved_count"",""cte1"".""approved_amount"",COALESCE(""cte2"".""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""cte2"".""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""cte1"" LEFT JOIN ""cte2"" ON ""cte1"".""month""=""cte2"".""month"" AND ""cte1"".""country""=""cte2"".""country"" UNION SELECT ""cte2"".""month"",""cte2"".""country"",COALESCE(""cte1"".""approved_count"", 0),COALESCE(""cte1"".""approved_amount"", 0),""cte2"".""chargeback_count"",""cte2"".""chargeback_amount"" FROM ""cte1"" RIGHT JOIN ""cte2"" ON ""cte1"".""month""=""cte2"".""month"" AND ""cte1"".""country""=""cte2"".""country"""
214,"WITH ""t1"" AS (SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",COUNT(1) AS ""cnt1"",SUM(""amount"") AS ""sum1"" FROM ""transactions"" WHERE ""state""='approved' GROUP BY 1,2), ""t2"" AS (SELECT LEFT(""a"".""trans_date"", 7) AS ""month"",""country"",COUNT(1) AS ""cnt2"",SUM(""amount"") AS ""sum2"" FROM ""chargebacks"" AS ""a"" JOIN ""transactions"" AS ""b"" ON ""a"".""trans_id""=""b"".""id"" GROUP BY 1,2), ""t3"" AS (SELECT ""t1"".""month"",""country"" FROM ""t1"" UNION SELECT ""t2"".""month"",""country"" FROM ""t2"") SELECT ""t3"".""month"",""t3"".""country"",COALESCE(""cnt1"", 0) AS ""approved_count"",COALESCE(""sum1"", 0) AS ""approved_amount"",COALESCE(""cnt2"", 0) AS ""chargeback_count"",COALESCE(""sum2"", 0) AS ""chargeback_amount"" FROM (""t3"" LEFT JOIN ""t1"" ON ""t3"".""month""=""t1"".""month"" AND ""t3"".""country""=""t1"".""country"") LEFT JOIN ""t2"" ON ""t3"".""month""=""t2"".""month"" AND ""t3"".""country""=""t2"".""country"""
215,"SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='back' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='back' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT LEFT(""Chargebacks"".""trans_date"", 7) AS ""month"",""country"",'back' AS ""state"",""amount"" FROM ""Chargebacks"" JOIN ""Transactions"" ON ""Chargebacks"".""trans_id""=""Transactions"".""id"" UNION ALL SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",""state"",""amount"" FROM ""Transactions"" WHERE ""state""='approved') AS ""t"" GROUP BY ""month"",""country"""
216,"WITH ""cte"" AS (SELECT TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"",""t"".""amount"",""t"".""country"",'chargeback' AS ""state"" FROM ""chargebacks"" AS ""c"" LEFT JOIN ""transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"") SELECT ""temp"".""month"",""temp"".""country"",SUM(CASE WHEN ""temp"".""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""temp"".""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""temp"".""state""='chargeback' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""temp"".""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT TO_CHAR(""t"".""trans_date"", 'YYYY-%m') AS ""month"",""t"".""amount"",""t"".""country"",""t"".""state"" FROM ""transactions"" AS ""t"" UNION ALL SELECT * FROM ""cte"") AS ""temp"" GROUP BY 1,2 HAVING SUM(CASE WHEN ""temp"".""state""='approved' THEN 1 ELSE 0 END)!=0 OR SUM(CASE WHEN ""temp"".""state""='chargeback' THEN 1 ELSE 0 END)!=0 ORDER BY 1,2"
217,"SELECT ""T1"".""month"",""T1"".""country"",SUM(""approved_count"") AS ""approved_count"",SUM(""approved_amount"") AS ""approved_amount"",SUM(""chargeback_count"") AS ""chargeback_count"",SUM(""chargeback_amount"") AS ""chargeback_amount"" FROM (SELECT LEFT(""C"".""trans_date"", 7) AS ""month"",""country"",0 AS ""approved_count"",0 AS ""approved_amount"",COUNT(""amount"") AS ""chargeback_count"",SUM(""amount"") AS ""chargeback_amount"" FROM ""Transactions"" AS ""T"" RIGHT JOIN ""Chargebacks"" AS ""C"" ON ""T"".""id""=""C"".""trans_id"" GROUP BY 1,2 UNION ALL SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",COUNT(""amount""),SUM(""amount""),0,0 FROM ""Transactions"" WHERE ""state""='approved' GROUP BY 1,2) AS ""T1"" GROUP BY 1,2"
218,"SELECT LEFT(""cte"".""trans_date"", 7) AS ""month"",""cte"".""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='chargeback' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT ""c"".""trans_id"",""t"".""country"",'chargeback' AS ""state"",""t"".""amount"",""c"".""trans_date"" FROM ""Chargebacks"" AS ""c"" JOIN ""Transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" UNION ALL SELECT * FROM ""Transactions"") AS ""cte"" GROUP BY 1,2 HAVING ""approved_amount"">0 OR ""chargeback_amount"">0 ORDER BY 1"
219,"WITH ""ChargebackGroup"" AS (SELECT ""T"".""country"",LEFT(""C"".""trans_date"", 7) AS ""month"",COUNT(""T"".""amount"") AS ""chargeback_count"",SUM(""T"".""amount"") AS ""chargeback_amount"" FROM ""Chargebacks"" AS ""C"" JOIN ""Transactions"" AS ""T"" ON ""C"".""trans_id""=""T"".""id"" GROUP BY ""month"",""country""), ""ApprovedGroup"" AS (SELECT LEFT(""T"".""trans_date"", 7) AS ""month"",""country"",SUM(""state""='approved') AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"" FROM ""Transactions"" AS ""T"" GROUP BY ""month"",""country"") SELECT ""A"".""month"",""A"".""country"",COALESCE(""approved_count"", 0) AS ""approved_count"",COALESCE(""approved_amount"", 0) AS ""approved_amount"",COALESCE(""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""ApprovedGroup"" AS ""A"" LEFT JOIN ""ChargebackGroup"" AS ""C"" ON ""A"".""month""=""C"".""month"" AND ""A"".""country""=""C"".""country"" WHERE ""approved_count"">0 UNION SELECT ""C"".""month"",""C"".""country"",COALESCE(""approved_count"", 0) AS ""approved_count"",COALESCE(""approved_amount"", 0) AS ""approved_amount"",COALESCE(""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""ApprovedGroup"" AS ""A"" RIGHT JOIN ""ChargebackGroup"" AS ""C"" ON ""A"".""month""=""C"".""month"" AND ""A"".""country""=""C"".""country"""
220,"WITH ""AGG_TRANSACTION"" AS (SELECT TO_CHAR(""TRANS_DATE"", 'YYYY-%m') AS ""MONTH"",""COUNTRY"",SUM(CASE WHEN ""STATE""='APPROVED' THEN 1 ELSE 0 END) AS ""APPROVED_COUNT"",SUM(CASE WHEN ""STATE""='APPROVED' THEN ""AMOUNT"" ELSE 0 END) AS ""APPROVED_AMOUNT"" FROM ""TRANSACTIONS"" GROUP BY TO_CHAR(""TRANS_DATE"", 'YYYY-%m'),""COUNTRY""), ""AGG_CHARGEBACKS"" AS (SELECT TO_CHAR(""C"".""TRANS_DATE"", 'YYYY-%m') AS ""MONTH"",""T"".""COUNTRY"",COUNT(""TRANS_ID"") AS ""chargeback_count"",SUM(""AMOUNT"") AS ""chargeback_amount"" FROM ""CHARGEBACKS"" AS ""C"" JOIN ""TRANSACTIONS"" AS ""T"" ON ""C"".""TRANS_ID""=""T"".""ID"" GROUP BY TO_CHAR(""C"".""TRANS_DATE"", 'YYYY-%m'),""T"".""COUNTRY"") SELECT ""T"".*,COALESCE(""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""AGG_TRANSACTION"" AS ""T"" LEFT JOIN ""AGG_CHARGEBACKS"" AS ""C"" USING (""MONTH"",""COUNTRY"") WHERE ""APPROVED_COUNT""!=0 UNION SELECT ""C"".""MONTH"",""C"".""COUNTRY"",COALESCE(""APPROVED_COUNT"", 0) AS ""APPROVED_COUNT"",COALESCE(""APPROVED_AMOUNT"", 0) AS ""APPROVED_AMOUNT"",""chargeback_count"",""chargeback_amount"" FROM ""AGG_TRANSACTION"" AS ""T"" RIGHT JOIN ""AGG_CHARGEBACKS"" AS ""C"" USING (""MONTH"",""COUNTRY"")"
221,"WITH ""MergeTrans"" AS (SELECT ""t"".""id"",""t"".""country"",""t"".""state"",""t"".""amount"",""t"".""trans_date"" FROM ""Transactions"" AS ""t"" WHERE ""t"".""state""='approved' UNION ALL SELECT ""t"".""id"",""t"".""country"",'chargeback' AS ""state"",""t"".""amount"",""c"".""trans_date"" FROM ""Transactions"" AS ""t"" JOIN ""Chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"") SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='chargeback' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""MergeTrans"" GROUP BY TO_CHAR(""trans_date"", 'YYYY-%m'),""country"" ORDER BY 1"
222,"WITH ""cte"" AS ((SELECT ""t"".""id"",""country"",""state"",""amount"",""t"".""trans_date"" FROM ""Transactions"" AS ""t"" LEFT JOIN ""Chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"") UNION (SELECT ""c"".""trans_id"",""country"",'chargeback',""amount"",""c"".""trans_date"" FROM ""Transactions"" AS ""t"" RIGHT JOIN ""Chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"")) SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(""state""='approved') AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(""state""='chargeback') AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""cte"" GROUP BY ""month"",""country"" HAVING ""approved_count""+""approved_amount""+""chargeback_count""+""chargeback_amount""!=0"
223,"WITH ""chbk"" AS (SELECT ""c"".""trans_id"" AS ""id"",""t"".""country"",'chargeback' AS ""state"",""t"".""amount"" AS ""amount"",""c"".""trans_date"" FROM ""Transactions"" AS ""t"" RIGHT JOIN ""Chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id""), ""trans"" AS (SELECT * FROM ""Transactions"" AS ""t"") SELECT ""country"",LEFT(""trans_date"", 7) AS ""month"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='chargeback' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT ""id"",""country"",""state"",""amount"",""trans_date"" FROM ""chbk"" UNION ALL SELECT ""id"",""country"",""state"",""amount"",""trans_date"" FROM ""trans"") AS ""a"" GROUP BY ""country"",LEFT(""trans_date"", 7) HAVING ""approved_amount"">0 OR ""chargeback_amount"">0"
224,"WITH ""cte1"" AS (SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"" FROM ""transactions"" GROUP BY ""month"",""country""), ""cte2"" AS (SELECT TO_CHAR(""chargebacks"".""trans_date"", 'YYYY-%m') AS ""month"",""transactions"".""country"",COUNT(""transactions"".""id"") AS ""chargeback_count"",SUM(""transactions"".""amount"") AS ""chargeback_amount"" FROM ""chargebacks"" JOIN ""transactions"" ON ""chargebacks"".""trans_id""=""transactions"".""id"" GROUP BY ""month"",""country"") (SELECT ""c2"".""month"",""c2"".""country"",COALESCE(""c1"".""approved_count"", 0) AS ""approved_count"",COALESCE(""c1"".""approved_amount"", 0) AS ""approved_amount"",""c2"".""chargeback_count"",""c2"".""chargeback_amount"" FROM ""cte1"" AS ""c1"" RIGHT JOIN ""cte2"" AS ""c2"" ON (""c1"".""month""=""c2"".""month"" AND ""c1"".""country""=""c2"".""country"")) UNION (SELECT ""c1"".""month"",""c1"".""country"",""c1"".""approved_count"",""c1"".""approved_amount"",COALESCE(""c2"".""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""c2"".""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""cte1"" AS ""c1"" LEFT JOIN ""cte2"" AS ""c2"" ON (""c1"".""month""=""c2"".""month"" AND ""c1"".""country""=""c2"".""country"") WHERE ""c1"".""approved_count""!=0) ORDER BY ""month"",""country"""
225,"WITH ""t1"" AS (SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",'approved' AS ""state"",""amount"" FROM ""transactions"" WHERE ""state""='approved' UNION ALL SELECT TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"",""country"",'back' AS ""state"",""amount"" FROM ""chargebacks"" AS ""c"" JOIN ""transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"") SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='back' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='back' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""t1"" GROUP BY 1,2"
226,"WITH ""cte1"" AS (SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"" FROM ""transactions"" GROUP BY ""month"",""country""), ""cte2"" AS (SELECT TO_CHAR(""chargebacks"".""trans_date"", 'YYYY-%m') AS ""month"",""transactions"".""country"",COUNT(""transactions"".""id"") AS ""chargeback_count"",SUM(""transactions"".""amount"") AS ""chargeback_amount"" FROM ""chargebacks"" JOIN ""transactions"" ON ""chargebacks"".""trans_id""=""transactions"".""id"" GROUP BY ""month"",""country"") (SELECT ""c2"".""month"",""c2"".""country"",COALESCE(""c1"".""approved_count"", 0) AS ""approved_count"",COALESCE(""c1"".""approved_amount"", 0) AS ""approved_amount"",""c2"".""chargeback_count"",""c2"".""chargeback_amount"" FROM ""cte1"" AS ""c1"" RIGHT JOIN ""cte2"" AS ""c2"" ON (""c1"".""month""=""c2"".""month"" AND ""c1"".""country""=""c2"".""country"") ORDER BY ""c2"".""month"",""c2"".""country"") UNION (SELECT ""c1"".""month"",""c1"".""country"",""c1"".""approved_count"",""c1"".""approved_amount"",COALESCE(""c2"".""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""c2"".""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""cte1"" AS ""c1"" LEFT JOIN ""cte2"" AS ""c2"" ON (""c1"".""month""=""c2"".""month"" AND ""c1"".""country""=""c2"".""country"") WHERE ""c1"".""approved_count""!=0 ORDER BY ""c2"".""month"",""c2"".""country"")"
227,"WITH ""t1"" AS (SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",COUNT(1) AS ""cnt1"",SUM(""amount"") AS ""sum1"" FROM ""transactions"" WHERE ""state""='approved' GROUP BY 1,2), ""t2"" AS (SELECT LEFT(""a"".""trans_date"", 7) AS ""month"",""country"",COUNT(1) AS ""cnt2"",SUM(""amount"") AS ""sum2"" FROM ""chargebacks"" AS ""a"" JOIN ""transactions"" AS ""b"" ON ""a"".""trans_id""=""b"".""id"" GROUP BY 1,2), ""t3"" AS (SELECT ""t1"".""month"",""country"" FROM ""t1"" UNION SELECT ""t2"".""month"",""country"" FROM ""t2"") SELECT ""t3"".""month"",""t3"".""country"",COALESCE(""cnt1"", 0) AS ""approved_count"",COALESCE(""sum1"", 0) AS ""approved_amount"",COALESCE(""cnt2"", 0) AS ""chargeback_count"",COALESCE(""sum2"", 0) AS ""chargeback_amount"" FROM (""t3"" LEFT JOIN ""t1"" ON ""t3"".""month""=""t1"".""month"" AND ""t3"".""country""=""t1"".""country"") LEFT JOIN ""t2"" ON ""t3"".""month""=""t2"".""month"" AND ""t3"".""country""=""t2"".""country"""
228,"SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='declined' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='declined' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT LEFT(""chargebacks"".""trans_date"", 7) AS ""month"",""country"",'declined' AS ""state"",""amount"" FROM ""chargebacks"" JOIN ""transactions"" ON ""chargebacks"".""trans_id""=""transactions"".""id"" UNION ALL SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",""state"",""amount"" FROM ""transactions"" WHERE ""state""='approved') AS ""s"" GROUP BY ""month"",""country"""
229,"SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='back' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='back' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT LEFT(""chargebacks"".""trans_date"", 7) AS ""month"",""country"",'back' AS ""state"",""amount"" FROM ""chargebacks"" JOIN ""transactions"" ON ""chargebacks"".""trans_id""=""transactions"".""id"" UNION ALL SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",""state"",""amount"" FROM ""transactions"" WHERE ""state""='approved') AS ""s"" GROUP BY ""month"",""country"""
230,"WITH ""cte"" AS (SELECT TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"",""t"".""country"",0 AS ""state"",""t"".""amount"" FROM ""transactions"" AS ""t"" JOIN ""chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"" UNION ALL SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",1 AS ""state"",""amount"" FROM ""transactions"" WHERE ""state""='approved') SELECT ""month"",""country"",SUM(""state"") AS ""approved_count"",SUM(""amount""*""state"") AS ""approved_amount"",COUNT(""state"")-SUM(""state"") AS ""chargeback_count"",SUM(""amount"")-SUM(""amount""*""state"") AS ""chargeback_amount"" FROM ""cte"" GROUP BY 1,2 ORDER BY ""month"""
231,"SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='back' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='back' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT LEFT(""chargebacks"".""trans_date"", 7) AS ""month"",""country"",'back' AS ""state"",""amount"" FROM ""chargebacks"" JOIN ""transactions"" ON ""chargebacks"".""trans_id""=""transactions"".""id"" UNION ALL SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",""state"",""amount"" FROM ""transactions"" WHERE ""state""='approved') AS ""s"" GROUP BY ""month"",""country"""
232,"WITH ""CTE"" AS (SELECT ""country"",'back' AS ""state"",""amount"",TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"" FROM ""Chargebacks"" AS ""c"" JOIN ""Transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" UNION ALL SELECT ""country"",""state"",""amount"",TO_CHAR(""t"".""trans_date"", 'YYYY-%m') AS ""month"" FROM ""Transactions"" AS ""t"" WHERE ""t"".""state""='approved') SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='back' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='back' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""cte"" GROUP BY ""month"",""country"""
233,"WITH ""income"" AS (SELECT ""country"",LEFT(""Transactions"".""trans_date"", 7) AS ""month"",COUNT(""Transactions"".""id"") AS ""approved_count"",SUM(""Transactions"".""amount"") AS ""approved_amount"" FROM ""Transactions"" WHERE ""state""='approved' GROUP BY ""country"",LEFT(""Transactions"".""trans_date"", 7)), ""chargeback"" AS (SELECT LEFT(""C"".""trans_date"", 7) AS ""month"",""country"",COUNT(""Transactions"".""id"") AS ""chargeback_count"",SUM(""Transactions"".""amount"") AS ""chargeback_amount"" FROM ""Transactions"" JOIN ""Chargebacks"" AS ""C"" ON ""Transactions"".""id""=""C"".""trans_id"" GROUP BY ""country"",LEFT(""C"".""trans_date"", 7)) SELECT ""month"",""country"",COALESCE(""approved_count"", 0) AS ""approved_count"",COALESCE(""approved_amount"", 0) AS ""approved_amount"",COALESCE(""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""income"" LEFT JOIN ""chargeback"" USING (""country"",""month"") UNION SELECT ""month"",""country"",COALESCE(""approved_count"", 0) AS ""approved_count"",COALESCE(""approved_amount"", 0) AS ""approved_amount"",COALESCE(""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""income"" RIGHT JOIN ""chargeback"" USING (""country"",""month"")"
234,"WITH ""A"" AS (SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"" FROM ""transactions"" GROUP BY LEFT(""trans_date"", 7),""country"" HAVING SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END)>0), ""B"" AS (SELECT LEFT(""c"".""trans_date"", 7) AS ""month"",""t"".""country"",COUNT(""c"".""trans_id"") AS ""chargeback_count"",SUM(""t"".""amount"") AS ""chargeback_amount"" FROM ""transactions"" AS ""t"" JOIN ""chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"" GROUP BY LEFT(""c"".""trans_date"", 7),""t"".""country"" HAVING COUNT(""c"".""trans_id"")>0) SELECT COALESCE(""a"".""month"", ""b"".""month"") AS ""month"",COALESCE(""a"".""country"", ""b"".""country"") AS ""country"",COALESCE(""a"".""approved_count"", 0) AS ""approved_count"",COALESCE(""a"".""approved_amount"", 0) AS ""approved_amount"",COALESCE(""b"".""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""b"".""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""a"" LEFT JOIN ""b"" ON ""a"".""month""=""b"".""month"" AND ""a"".""country""=""b"".""country"" UNION SELECT COALESCE(""a"".""month"", ""b"".""month"") AS ""month"",COALESCE(""a"".""country"", ""b"".""country"") AS ""country"",COALESCE(""a"".""approved_count"", 0) AS ""approved_count"",COALESCE(""a"".""approved_amount"", 0) AS ""approved_amount"",COALESCE(""b"".""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""b"".""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""a"" RIGHT JOIN ""b"" ON ""a"".""month""=""b"".""month"" AND ""a"".""country""=""b"".""country"""
235,"WITH ""ALLTxns"" AS (SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",""state"",""amount"" FROM ""Transactions"" WHERE ""state""='approved' UNION ALL SELECT LEFT(""C"".""trans_date"", 7) AS ""month"",""T"".""country"",'chargeback' AS ""state"",""T"".""amount"" FROM ""Chargebacks"" AS ""C"" JOIN ""Transactions"" AS ""T"" ON ""T"".""id""=""C"".""trans_id"") SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='chargeback' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""AllTxns"" GROUP BY ""month"",""country"""
236,"SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='back' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='back' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT LEFT(""chargebacks"".""trans_date"", 7) AS ""month"",""country"",'back' AS ""state"",""amount"" FROM ""chargebacks"" JOIN ""transactions"" ON ""chargebacks"".""trans_id""=""transactions"".""id"" UNION ALL SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",""state"",""amount"" FROM ""transactions"" WHERE ""state""='approved') AS ""s"" GROUP BY ""month"",""country"" ORDER BY ""month"",""country"""
237,"WITH ""all_trans"" AS (SELECT * FROM ""Transactions"" UNION ALL SELECT ""t"".""id"",""t"".""country"",'chargeback' AS ""state"",""t"".""amount"",""c"".""trans_date"" FROM ""Transactions"" AS ""t"" JOIN ""Chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"") SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(""state""='approved') AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(""state""='chargeback') AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""all_trans"" WHERE ""state""!='declined' GROUP BY 1,2"
238,"WITH ""CTE"" AS ((SELECT ""id"",""country"",'chargeback' AS ""state"",""amount"",LEFT(""C"".""trans_date"", 7) AS ""trans_date"" FROM ""Chargebacks"" AS ""C"" JOIN ""Transactions"" AS ""T"" ON ""C"".""trans_id""=""T"".""id"") UNION ALL SELECT * FROM ""Transactions"") SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",SUM(""state""='approved') AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(""state""='chargeback') AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""CTE"" GROUP BY 1,2 HAVING ""approved_count"">0 OR ""approved_amount"">0 OR ""chargeback_count"">0 OR ""chargeback_amount"">0"
239,"WITH ""cte"" AS (SELECT ""t"".""id"",""country"",""state"",""amount"",""t"".""trans_date"" FROM ""Transactions"" AS ""t"" LEFT JOIN ""Chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"" UNION SELECT ""c"".""trans_id"",""country"",'chargeback',""amount"",""c"".""trans_date"" FROM ""Transactions"" AS ""t"" RIGHT JOIN ""Chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"") SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(""state""='approved') AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(""state""='chargeback') AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""cte"" GROUP BY ""month"",""country"" HAVING ""approved_count""+""approved_amount""+""chargeback_count""+""chargeback_amount""!=0"
240,"SELECT ""month"",""country"",SUM(""state""='approved') AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(""state""='back') AS ""chargeback_count"",SUM(CASE WHEN ""state""='back' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT TO_CHAR(""t1"".""trans_date"", 'YYYY-%m') AS ""month"",""country"",'back' AS ""state"",""amount"" FROM ""chargebacks"" AS ""t1"" JOIN ""transactions"" AS ""t2"" ON ""t1"".""trans_id""=""t2"".""id"" UNION ALL SELECT TO_CHAR(""t3"".""trans_date"", 'YYYY-%m') AS ""month"",""country"",""state"",""amount"" FROM ""transactions"" AS ""t3"" WHERE ""state""='approved') AS ""t4"" GROUP BY ""month"",""country"""
241,"WITH ""stacked"" AS (SELECT TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"",""country"",NULL AS ""approved_count"",NULL AS ""approved_amount"",COUNT(1) AS ""chargeback_count"",SUM(""amount"") AS ""chargeback_amount"" FROM ""chargebacks"" AS ""c"" LEFT JOIN ""transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" GROUP BY 1,2 UNION ALL SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(""state""='approved') AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",NULL AS ""chargeback_count"",NULL AS ""chargeback_amount"" FROM ""transactions"" GROUP BY 1,2) SELECT ""month"",""country"",COALESCE(SUM(""approved_count""), 0) AS ""approved_count"",COALESCE(SUM(""approved_amount""), 0) AS ""approved_amount"",COALESCE(SUM(""chargeback_count""), 0) AS ""chargeback_count"",COALESCE(SUM(""chargeback_amount""), 0) AS ""chargeback_amount"" FROM ""stacked"" GROUP BY 1,2 HAVING COALESCE(SUM(""approved_count""), 0)+COALESCE(SUM(""approved_amount""), 0)+COALESCE(SUM(""chargeback_count""), 0)+COALESCE(SUM(""chargeback_amount""), 0)!=0"
242,"WITH ""temp"" AS (SELECT ""t"".""id"",""t"".""country"",'back' AS ""state"",""t"".""amount"",TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"" FROM ""Transactions"" AS ""t"" JOIN ""Chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"" UNION SELECT ""id"",""country"",""state"",""amount"",TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"" FROM ""Transactions"" WHERE ""state""='approved') SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='back' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='back' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""temp"" GROUP BY ""month"",""country"" ORDER BY 1"
243,"WITH ""alldate"" AS (SELECT LEFT(""trans_date"", 7) AS ""trans_date"",""country"" FROM ""Transactions"" GROUP BY LEFT(""trans_date"", 7),""country"" UNION ALL SELECT LEFT(""a"".""trans_date"", 7) AS ""trans_date"",""b"".""country"" FROM ""Chargebacks"" AS ""a"" JOIN ""Transactions"" AS ""b"" ON ""a"".""trans_id""=""b"".""id"" GROUP BY LEFT(""a"".""trans_date"", 7),""b"".""country""), ""ChargebacksTrans"" AS (SELECT LEFT(""a"".""trans_date"", 7) AS ""trans_date"",""b"".""country"",SUM(""b"".""amount"") AS ""amount"",COUNT(LEFT(""a"".""trans_date"", 7)) AS ""countTotal"" FROM ""Chargebacks"" AS ""a"" JOIN ""Transactions"" AS ""b"" ON ""a"".""trans_id""=""b"".""id"" GROUP BY LEFT(""a"".""trans_date"", 7),""b"".""country""), ""NewTransactions"" AS (SELECT LEFT(""trans_date"", 7) AS ""trans_date"",""country"",SUM(""amount"") AS ""amount"",COUNT(LEFT(""trans_date"", 7)) AS ""countTotal"" FROM ""Transactions"" WHERE ""state""='approved' GROUP BY LEFT(""trans_date"", 7),""country"") SELECT ""a"".""trans_date"" AS ""month"",""a"".""country"",COALESCE(""c"".""countTotal"", 0) AS ""approved_count"",COALESCE(""c"".""amount"", 0) AS ""approved_amount"",COALESCE(""b"".""countTotal"", 0) AS ""chargeback_count"",COALESCE(""b"".""amount"", 0) AS ""chargeback_amount"" FROM (""alldate"" AS ""a"" LEFT JOIN ""ChargebacksTrans"" AS ""b"" ON ""a"".""trans_date""=""b"".""trans_date"" AND ""a"".""country""=""b"".""country"") LEFT JOIN ""NewTransactions"" AS ""c"" ON ""a"".""trans_date""=""c"".""trans_date"" AND ""a"".""country""=""c"".""country"" WHERE (COALESCE(""c"".""countTotal"", 0)>0 OR COALESCE(""c"".""amount"", 0)>0 OR COALESCE(""b"".""countTotal"", 0)>0 OR COALESCE(""b"".""amount"", 0)>0) GROUP BY ""a"".""trans_date"",""a"".""country"" ORDER BY 1"
244,"SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='back' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='back' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT LEFT(""chargebacks"".""trans_date"", 7) AS ""month"",""country"",'back' AS ""state"",""amount"" FROM ""chargebacks"" JOIN ""transactions"" ON ""chargebacks"".""trans_id""=""transactions"".""id"" UNION ALL SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",""state"",""amount"" FROM ""transactions"" WHERE ""state""='approved') AS ""s"" GROUP BY ""month"",""country"""
245,"SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",SUM(""state""='approved') AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(""state""='chargebacks') AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargebacks' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT * FROM ""transactions"" WHERE ""state""='approved' UNION ALL SELECT ""trans_id"" AS ""id"",""country"",'chargebacks' AS ""state"",""amount"",""c"".""trans_date"" FROM ""chargebacks"" AS ""c"" LEFT JOIN ""transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"") AS ""t"" GROUP BY 1,2"
246,"SELECT ""month"",""country"",COALESCE(COUNT(CASE WHEN ""state""='approved' THEN 1 END), 0) AS ""approved_count"",COALESCE(SUM(CASE WHEN ""state""='approved' THEN ""amount"" END), 0) AS ""approved_amount"",COALESCE(COUNT(CASE WHEN ""state""='back' THEN 1 END), 0) AS ""chargeback_count"",COALESCE(SUM(CASE WHEN ""state""='back' THEN ""amount"" END), 0) AS ""chargeback_amount"" FROM (SELECT LEFT(""c"".""trans_date"", 7) AS ""month"",""country"",'back' AS ""state"",""amount"" FROM ""Chargebacks"" AS ""c"" JOIN ""Transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" UNION ALL SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",""state"",""amount"" FROM ""Transactions"" WHERE ""state""='approved') AS ""tb"" GROUP BY ""month"",""country"""
247,"SELECT ""a"".""month"",""a"".""country"",COUNT(CASE WHEN ""a"".""state""='approved' THEN 1 ELSE NULL END) AS ""approved_count"",SUM(CASE WHEN ""a"".""state""='approved' THEN ""a"".""amount"" ELSE 0 END) AS ""approved_amount"",COUNT(CASE WHEN ""a"".""state""='chargeback' THEN 1 ELSE NULL END) AS ""chargeback_count"",SUM(CASE WHEN ""a"".""state""='chargeback' THEN ""a"".""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"",""t"".""country"",""t"".""amount"",'chargeback' AS ""state"" FROM ""Transactions"" AS ""t"" JOIN ""Chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"" UNION ALL SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",""amount"",""state"" FROM ""Transactions"" WHERE ""state""='approved') AS ""a"" GROUP BY 1,2"
248,"WITH ""temp"" AS (SELECT ""t"".""id"",""country"",""state"",""amount"",""Chargebacks"".""trans_date"" FROM ""Transactions"" AS ""t"" RIGHT JOIN ""Chargebacks"" ON ""t"".""id""=""Chargebacks"".""trans_id""), ""chargebacks"" AS (SELECT TO_CHAR(""temp"".""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(""amount"") AS ""chargeback_amount"",COUNT(1) AS ""chargeback_count"" FROM ""temp"" GROUP BY TO_CHAR(""temp"".""trans_date"", 'YYYY-%m'),""country""), ""approved"" AS (SELECT TO_CHAR(""Transactions"".""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(""amount"") AS ""approved_amount"",COUNT(1) AS ""approved_count"" FROM ""Transactions"" WHERE ""state""='approved' GROUP BY TO_CHAR(""Transactions"".""trans_date"", 'YYYY-%m'),""country"") SELECT COALESCE(""approved"".""month"", ""chargebacks"".""month"") AS ""month"",COALESCE(""approved"".""country"", ""chargebacks"".""country"") AS ""country"",COALESCE(""approved_count"", 0) AS ""approved_count"",COALESCE(""approved_amount"", 0) AS ""approved_amount"",COALESCE(""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""approved"" LEFT JOIN ""chargebacks"" ON ""chargebacks"".""month""=""approved"".""month"" AND ""chargebacks"".""country""=""approved"".""country"" UNION SELECT COALESCE(""approved"".""month"", ""chargebacks"".""month"") AS ""month"",COALESCE(""approved"".""country"", ""chargebacks"".""country"") AS ""country"",COALESCE(""approved_count"", 0) AS ""approved_count"",COALESCE(""approved_amount"", 0) AS ""approved_amount"",COALESCE(""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""approved"" RIGHT JOIN ""chargebacks"" ON ""chargebacks"".""month""=""approved"".""month"" AND ""chargebacks"".""country""=""approved"".""country"""
249,"SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='back' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='back' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT LEFT(""chargebacks"".""trans_date"", 7) AS ""month"",""country"",'back' AS ""state"",""amount"" FROM ""chargebacks"" JOIN ""transactions"" ON ""chargebacks"".""trans_id""=""transactions"".""id"" UNION ALL SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",""state"",""amount"" FROM ""transactions"" WHERE ""state""='approved') AS ""s"" GROUP BY ""month"",""country"""
250,"SELECT ""month"",""country"",SUM(""state""='approved') AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(""state""='back') AS ""chargeback_count"",SUM(CASE WHEN ""state""='back' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT LEFT(""chargebacks"".""trans_date"", 7) AS ""month"",""country"",'back' AS ""state"",""amount"" FROM ""chargebacks"" JOIN ""transactions"" ON ""chargebacks"".""trans_id""=""transactions"".""id"" UNION ALL SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",""state"",""amount"" FROM ""transactions"" WHERE ""state""='approved') AS ""s"" GROUP BY ""month"",""country"""
251,"WITH RECURSIVE ""cte_date_range"" AS (SELECT ""trans_date"" FROM ""Transactions"" UNION ALL SELECT ""trans_date"" FROM ""Chargebacks""), ""cte_date_spine"" AS (SELECT MIN(""trans_date"") AS ""dt"" FROM ""cte_date_range"" UNION ALL SELECT ""dt"" + INTERVAL ''1' DAY' FROM ""cte_date_spine"" WHERE ""dt""<(SELECT MAX(""trans_date"") FROM ""cte_date_range"")), ""cte_spine"" AS (SELECT ""dt"",""country"" FROM ""cte_date_spine"" CROSS JOIN (SELECT DISTINCT ""country"" FROM ""Transactions"") AS ""countries""), ""cte_chargebacks_wide"" AS (SELECT ""cb"".""trans_date"",""t"".""amount"",""t"".""country"" FROM ""Chargebacks"" AS ""cb"" JOIN ""Transactions"" AS ""t"" ON ""cb"".""trans_id""=""t"".""id""), ""cte_txns_agg"" AS (SELECT CONCAT(EXTRACT(YEAR FROM ""s"".""dt""), '-', LPAD(EXTRACT(MONTH FROM ""s"".""dt""), 2, 0)) AS ""month"",""s"".""country"",SUM(CASE WHEN ""t"".""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""t"".""state""='approved' THEN ""t"".""amount"" ELSE 0 END) AS ""approved_amount"" FROM ""cte_spine"" AS ""s"" LEFT JOIN ""Transactions"" AS ""t"" ON ""s"".""dt""=""t"".""trans_date"" AND ""s"".""country""=""t"".""country"" GROUP BY 1,2), ""cte_cbs_agg"" AS (SELECT CONCAT(EXTRACT(YEAR FROM ""s"".""dt""), '-', LPAD(EXTRACT(MONTH FROM ""s"".""dt""), 2, 0)) AS ""month"",""s"".""country"",SUM(CASE WHEN ""cb"".""trans_date"" IS NOT NULL THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""cb"".""trans_date"" IS NOT NULL THEN ""cb"".""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""cte_spine"" AS ""s"" LEFT JOIN ""cte_chargebacks_wide"" AS ""cb"" ON ""s"".""dt""=""cb"".""trans_date"" AND ""s"".""country""=""cb"".""country"" GROUP BY 1,2), ""cte_txn_cb_join"" AS (SELECT ""t"".""month"",""t"".""country"",COALESCE(""approved_count"", 0) AS ""approved_count"",COALESCE(""approved_amount"", 0) AS ""approved_amount"",COALESCE(""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""cte_txns_agg"" AS ""t"" JOIN ""cte_cbs_agg"" AS ""cb"" ON ""t"".""month""=""cb"".""month"" AND ""t"".""country""=""cb"".""country""), ""cte_final"" AS (SELECT * FROM ""cte_txn_cb_join"" WHERE NOT (""approved_count""+""approved_amount""+""chargeback_count""+""chargeback_amount""=0) ORDER BY 1,2) SELECT * FROM ""cte_final"""
252,"SELECT ""MONTH"",""COUNTRY"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='back' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='back' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT LEFT(""chargebacks"".""trans_date"", 7) AS ""month"",""country"",'back' AS ""state"",""amount"" FROM ""chargebacks"" JOIN ""transactions"" ON ""chargebacks"".""trans_id""=""transactions"".""id"" UNION ALL SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",""state"",""amount"" FROM ""transactions"" WHERE ""state""='approved') AS ""X"" GROUP BY ""month"",""COUNTRY"""
253,"WITH ""union_cte"" AS (SELECT * FROM ""Transactions"" UNION SELECT ""t"".""id"",""t"".""country"",'chargeback' AS ""state"",""t"".""amount"",""c"".""trans_date"" FROM ""Transactions"" AS ""t"" JOIN ""Chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"") SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",COUNT(CASE WHEN ""state""='approved' THEN ""state"" END) AS ""approved_count"",COALESCE(SUM(CASE WHEN ""state""='approved' THEN ""amount"" END), 0) AS ""approved_amount"",COUNT(CASE WHEN ""state""='chargeback' THEN ""state"" END) AS ""chargeback_count"",COALESCE(SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" END), 0) AS ""chargeback_amount"" FROM ""union_cte"" GROUP BY ""month"",""country"" HAVING ""approved_count""!=0 OR ""approved_amount""!=0 OR ""chargeback_count""!=0 OR ""chargeback_amount""!=0"
254,"WITH ""approved"" AS (SELECT TO_CHAR(""A"".""trans_date"", 'YYYY-%m') AS ""month"",""country"",COUNT(1) AS ""approved_count"",SUM(""amount"") AS ""approved_amount"" FROM ""Transactions"" AS ""A"" WHERE ""state""='approved' GROUP BY 1,2), ""chargeback"" AS (SELECT TO_CHAR(""B"".""trans_date"", 'YYYY-%m') AS ""month"",""country"",COUNT(1) AS ""chargeback_count"",SUM(""amount"") AS ""chargeback_amount"" FROM ""Transactions"" AS ""A"" RIGHT JOIN ""Chargebacks"" AS ""B"" ON ""A"".""id""=""B"".""trans_id"" GROUP BY 1,2) SELECT ""A"".""month"",""A"".""country"",COALESCE(""approved_count"", 0) AS ""approved_count"",COALESCE(""approved_amount"", 0) AS ""approved_amount"",COALESCE(""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""approved"" AS ""A"" LEFT JOIN ""chargeback"" AS ""B"" ON ""A"".""month""=""B"".""month"" AND ""A"".""country""=""B"".""country"" UNION SELECT ""B"".""month"",""B"".""country"",COALESCE(""approved_count"", 0) AS ""approved_count"",COALESCE(""approved_amount"", 0) AS ""approved_amount"",COALESCE(""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""approved"" AS ""A"" RIGHT JOIN ""chargeback"" AS ""B"" ON ""A"".""month""=""B"".""month"" AND ""A"".""country""=""B"".""country"""
255,"SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='chargeback' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT DISTINCT * FROM ""Transactions"" WHERE ""state""='approved' UNION ALL SELECT DISTINCT ""C"".""trans_id"" AS ""id"",""T"".""country"",'chargeback' AS ""state"",""T"".""amount"",""C"".""trans_date"" FROM ""Chargebacks"" AS ""C"" LEFT JOIN ""Transactions"" AS ""T"" ON ""C"".""trans_id""=""T"".""id"") AS ""a"" GROUP BY ""month"",""country"""
256,"SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='back' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='back' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT LEFT(""chargebacks"".""trans_date"", 7) AS ""month"",""country"",'back' AS ""state"",""amount"" FROM ""chargebacks"" JOIN ""transactions"" ON ""chargebacks"".""trans_id""=""transactions"".""id"" UNION ALL SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",""state"",""amount"" FROM ""transactions"" WHERE ""state""='approved') AS ""s"" GROUP BY ""month"",""country"""
257,"WITH ""income"" AS (SELECT ""country"",LEFT(""Transactions"".""trans_date"", 7) AS ""month"",COUNT(""Transactions"".""id"") AS ""approved_count"",SUM(""Transactions"".""amount"") AS ""approved_amount"" FROM ""Transactions"" WHERE ""state""='approved' GROUP BY ""country"",LEFT(""Transactions"".""trans_date"", 7)), ""chargeback"" AS (SELECT LEFT(""C"".""trans_date"", 7) AS ""month"",""country"",COUNT(""Transactions"".""id"") AS ""chargeback_count"",SUM(""Transactions"".""amount"") AS ""chargeback_amount"" FROM ""Transactions"" JOIN ""Chargebacks"" AS ""C"" ON ""Transactions"".""id""=""C"".""trans_id"" GROUP BY ""country"",LEFT(""C"".""trans_date"", 7)) SELECT ""month"",""country"",COALESCE(""approved_count"", 0) AS ""approved_count"",COALESCE(""approved_amount"", 0) AS ""approved_amount"",COALESCE(""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""income"" LEFT JOIN ""chargeback"" USING (""country"",""month"") UNION SELECT ""month"",""country"",COALESCE(""approved_count"", 0) AS ""approved_count"",COALESCE(""approved_amount"", 0) AS ""approved_amount"",COALESCE(""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""income"" RIGHT JOIN ""chargeback"" USING (""country"",""month"")"
258,"WITH ""t1"" AS (SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",COUNT(1) AS ""cnt1"",SUM(""amount"") AS ""sum1"" FROM ""transactions"" WHERE ""state""='approved' GROUP BY 1,2), ""t2"" AS (SELECT LEFT(""a"".""trans_date"", 7) AS ""month"",""country"",COUNT(1) AS ""cnt2"",SUM(""amount"") AS ""sum2"" FROM ""chargebacks"" AS ""a"" JOIN ""transactions"" AS ""b"" ON ""a"".""trans_id""=""b"".""id"" GROUP BY 1,2), ""t3"" AS (SELECT ""t1"".""month"",""country"" FROM ""t1"" UNION SELECT ""t2"".""month"",""country"" FROM ""t2"") SELECT ""t3"".""month"",""t3"".""country"",COALESCE(""cnt1"", 0) AS ""approved_count"",COALESCE(""sum1"", 0) AS ""approved_amount"",COALESCE(""cnt2"", 0) AS ""chargeback_count"",COALESCE(""sum2"", 0) AS ""chargeback_amount"" FROM (""t3"" LEFT JOIN ""t1"" ON ""t3"".""month""=""t1"".""month"" AND ""t3"".""country""=""t1"".""country"") LEFT JOIN ""t2"" ON ""t3"".""month""=""t2"".""month"" AND ""t3"".""country""=""t2"".""country"""
259,"SELECT TO_CHAR(""a"".""trans_date"", 'YYYY-%m') AS ""month"",""a"".""country"",SUM(CASE WHEN ""a"".""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""a"".""state""='approved' THEN ""a"".""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""a"".""state""='Chargeback' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""a"".""state""='Chargeback' THEN ""a"".""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT ""T"".""id"",""T"".""country"",""T"".""trans_date"",""T"".""state"",""T"".""amount"" FROM ""Transactions"" AS ""T"" WHERE ""T"".""state""='approved' UNION SELECT ""C"".""trans_id"" AS ""id"",""T"".""country"",""C"".""trans_date"",'Chargeback' AS ""state"",""T"".""amount"" FROM ""Transactions"" AS ""T"" RIGHT JOIN ""Chargebacks"" AS ""C"" ON ""T"".""id""=""C"".""trans_id"") AS ""a"" GROUP BY TO_CHAR(""a"".""trans_date"", 'YYYY-%m'),""a"".""country"""
260,"SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='chargeback' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT ""c"".""trans_id"",""t"".""country"",'chargeback' AS ""state"",""t"".""amount"",""c"".""trans_date"" FROM ""Chargebacks"" AS ""c"" JOIN ""Transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" UNION ALL SELECT * FROM ""Transactions"") AS ""t1"" GROUP BY ""country"",""month"" HAVING ""approved_amount"">0 OR ""chargeback_amount"">0"
261,"WITH ""cte"" AS (SELECT ""id"",""country"",'bc' AS ""state"",""amount"",""c"".""trans_date"" FROM ""Transactions"" AS ""t"" RIGHT JOIN ""Chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"" UNION ALL SELECT ""id"",""country"",""state"",""amount"",""trans_date"" FROM ""Transactions"") SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='bc' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='bc' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""cte"" GROUP BY ""country"",""month"" HAVING ""approved_count""+""approved_amount""+""chargeback_count""+""chargeback_amount""!=0"
262,"SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='chargeback' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT ""c"".""trans_id"",""t"".""country"",'chargeback' AS ""state"",""t"".""amount"",""c"".""trans_date"" FROM ""Transactions"" AS ""t"" JOIN ""Chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"" UNION SELECT * FROM ""Transactions"") AS ""a"" GROUP BY TO_CHAR(""trans_date"", 'YYYY-%m'),""country"" HAVING ""approved_count""+""approved_amount""+""chargeback_count""+""chargeback_amount""!=0 ORDER BY TO_CHAR(""trans_date"", 'YYYY-%m')"
263,"WITH ""stacked"" AS (SELECT TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"",""country"",NULL AS ""approved_count"",NULL AS ""approved_amount"",COUNT(1) AS ""chargeback_count"",SUM(""amount"") AS ""chargeback_amount"" FROM ""chargebacks"" AS ""c"" LEFT JOIN ""transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" GROUP BY 1,2 UNION ALL SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(""state""='approved') AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",NULL AS ""chargeback_count"",NULL AS ""chargeback_amount"" FROM ""transactions"" GROUP BY 1,2) SELECT ""month"",""country"",COALESCE(SUM(""approved_count""), 0) AS ""approved_count"",COALESCE(SUM(""approved_amount""), 0) AS ""approved_amount"",COALESCE(SUM(""chargeback_count""), 0) AS ""chargeback_count"",COALESCE(SUM(""chargeback_amount""), 0) AS ""chargeback_amount"" FROM ""stacked"" GROUP BY 1,2 HAVING COALESCE(SUM(""approved_count""), 0)+COALESCE(SUM(""approved_amount""), 0)+COALESCE(SUM(""chargeback_count""), 0)+COALESCE(SUM(""chargeback_amount""), 0)!=0"
264,"SELECT SUBSTRING(""trans_date"", 1, 7) AS ""month"",""country"",SUM(""state""='approved') AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(""state""='chargeback') AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT ""trans_id"" AS ""id"",""country"",'chargeback' AS ""state"",""amount"",""c"".""trans_date"" FROM ""chargebacks"" AS ""c"" LEFT JOIN ""transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" UNION SELECT * FROM ""transactions"") AS ""t"" GROUP BY 1,2 HAVING SUM(""state""='approved')!=0 OR SUM(""state""='chargeback')!=0"
265,"SELECT ""month"",""country"",SUM(CASE WHEN ""type""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""type""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""type""='chargeback' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""type""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ((SELECT LEFT(""t"".""trans_date"", 7) AS ""month"",""t"".""country"",""amount"",'approved' AS ""type"" FROM ""Transactions"" AS ""t"" WHERE ""state""='approved') UNION ALL (SELECT LEFT(""c"".""trans_date"", 7) AS ""month"",""t"".""country"",""amount"",'chargeback' AS ""type"" FROM ""Transactions"" AS ""t"" JOIN ""Chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"")) AS ""tt"" GROUP BY ""tt"".""month"",""tt"".""country"""
266,"SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='back' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='back' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT LEFT(""Chargebacks"".""trans_date"", 7) AS ""month"",""country"",'back' AS ""state"",""amount"" FROM ""Chargebacks"" JOIN ""Transactions"" ON ""Chargebacks"".""trans_id""=""Transactions"".""id"" UNION ALL SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",""state"",""amount"" FROM ""Transactions"" WHERE ""state""='approved') AS ""temp1"" GROUP BY ""month"",""country"""
267,"WITH ""cte1"" AS (SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",COUNT(""state"") AS ""approved_count"",SUM(""amount"") AS ""approved_amount"" FROM ""Transactions"" WHERE ""state""='approved' GROUP BY ""month"",""country""), ""cte2"" AS (SELECT TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"",""country"",COUNT(""trans_id"") AS ""chargeback_count"",SUM(""amount"") AS ""chargeback_amount"" FROM ""Transactions"" AS ""t"" RIGHT JOIN ""Chargebacks"" AS ""c"" ON ""trans_id""=""id"" GROUP BY ""month"",""country"") SELECT ""cte1"".""month"",""cte1"".""country"",CASE WHEN ""cte1"".""approved_count"" IS NULL THEN 0 ELSE ""cte1"".""approved_count"" END AS ""approved_count"",CASE WHEN ""cte1"".""approved_amount"" IS NULL THEN 0 ELSE ""cte1"".""approved_amount"" END AS ""approved_amount"",CASE WHEN ""cte2"".""chargeback_count"" IS NULL THEN 0 ELSE ""cte2"".""chargeback_count"" END AS ""chargeback_count"",CASE WHEN ""cte2"".""chargeback_amount"" IS NULL THEN 0 ELSE ""cte2"".""chargeback_amount"" END AS ""chargeback_amount"" FROM ""cte1"" LEFT JOIN ""cte2"" ON ""cte1"".""month""=""cte2"".""month"" AND ""cte1"".""country""=""cte2"".""country"" UNION SELECT ""cte2"".""month"",""cte2"".""country"",CASE WHEN ""cte1"".""approved_count"" IS NULL THEN 0 ELSE ""cte1"".""approved_count"" END AS ""approved_count"",CASE WHEN ""cte1"".""approved_amount"" IS NULL THEN 0 ELSE ""cte1"".""approved_amount"" END AS ""approved_amount"",CASE WHEN ""cte2"".""chargeback_count"" IS NULL THEN 0 ELSE ""cte2"".""chargeback_count"" END AS ""chargeback_count"",CASE WHEN ""cte2"".""chargeback_amount"" IS NULL THEN 0 ELSE ""cte2"".""chargeback_amount"" END AS ""chargeback_amount"" FROM ""cte1"" RIGHT JOIN ""cte2"" ON ""cte1"".""month""=""cte2"".""month"" AND ""cte1"".""country""=""cte2"".""country"""
268,"SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",SUM(""state""='approved') AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(""state""='chargeback') AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT DISTINCT * FROM ""Transactions"" WHERE ""state""='approved' UNION ALL SELECT DISTINCT ""C"".""trans_id"" AS ""id"",""T"".""country"",'chargeback' AS ""state"",""T"".""amount"",""C"".""trans_date"" FROM ""Chargebacks"" AS ""C"" LEFT JOIN ""Transactions"" AS ""T"" ON ""C"".""trans_id""=""T"".""id"") AS ""final"" GROUP BY 1,2"
269,"WITH ""sub"" AS (SELECT ""id"",""country"",'Chargeback' AS ""state"",""amount"",""c"".""trans_date"" FROM ""Transactions"" AS ""t"" RIGHT JOIN ""Chargebacks"" AS ""c"" ON ""c"".""trans_id""=""t"".""id"" UNION SELECT ""id"",""country"",""state"",""amount"",""trans_date"" FROM ""Transactions"" AS ""t"") SELECT SUBSTRING(""trans_date"", 1, 7) AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='Chargeback' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='Chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""sub"" WHERE ""state"" IN ('approved','chargeback') GROUP BY 1,2"
270,"SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='chargeback' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT ""id"",LEFT(""c"".""trans_date"", 7) AS ""month"",""country"",'chargeback' AS ""state"",""amount"" FROM (""Transactions"" AS ""a"") CROSS JOIN ""Chargebacks"" AS ""c"" WHERE ""a"".""id""=""c"".""trans_id"" UNION ALL SELECT ""id"",LEFT(""trans_date"", 7) AS ""month"",""country"",""state"",""amount"" FROM ""Transactions"" WHERE ""state""='approved') AS ""combine"" GROUP BY ""month"",""country"""
271,"WITH ""cte"" AS (SELECT ""t"".""id"",""country"",""state"",""amount"",""t"".""trans_date"" FROM ""Transactions"" AS ""t"" LEFT JOIN ""Chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"" UNION SELECT ""c"".""trans_id"",""country"",'chargeback',""amount"",""c"".""trans_date"" FROM ""Transactions"" AS ""t"" RIGHT JOIN ""Chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"") SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(""state""='approved') AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(""state""='chargeback') AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""cte"" GROUP BY ""month"",""country"" HAVING ""approved_count""+""approved_amount""+""chargeback_count""+""chargeback_amount""!=0"
272,"WITH ""t1"" AS (SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"" FROM ""transactions"" GROUP BY 1,2), ""t2"" AS (SELECT TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"",""t"".""country"",COUNT(1) AS ""chargeback_count"",SUM(""t"".""amount"") AS ""chargeback_amount"" FROM ""chargebacks"" AS ""c"" JOIN ""transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" GROUP BY 1,2) SELECT ""t1"".""month"",""t1"".""country"",""t1"".""approved_count"",""t1"".""approved_amount"",COALESCE(""t2"".""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""t2"".""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""t1"" LEFT JOIN ""t2"" ON ""t1"".""month""=""t2"".""month"" AND ""t1"".""country""=""t2"".""country"" WHERE ""approved_count""!=0 OR ""approved_amount""!=0 UNION SELECT ""t2"".""month"",""t2"".""country"",COALESCE(""t1"".""approved_count"", 0) AS ""approved_count"",COALESCE(""t1"".""approved_amount"", 0) AS ""approved_amount"",""t2"".""chargeback_count"",""t2"".""chargeback_amount"" FROM ""t1"" RIGHT JOIN ""t2"" ON ""t1"".""month""=""t2"".""month"" AND ""t1"".""country""=""t2"".""country"" WHERE ""chargeback_count""!=0 OR ""chargeback_amount""!=0"
273,"SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='back' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='back' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT LEFT(""chargebacks"".""trans_date"", 7) AS ""month"",""country"",'back' AS ""state"",""amount"" FROM ""chargebacks"" JOIN ""transactions"" ON ""chargebacks"".""trans_id""=""transactions"".""id"" UNION ALL SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",""state"",""amount"" FROM ""transactions"" WHERE ""state""='approved') AS ""s"" GROUP BY ""month"",""country"""
274,"SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='chargedback' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargedback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT * FROM ""transactions"" WHERE ""state""='approved' UNION ALL SELECT ""c"".""trans_id"",COALESCE(""t"".""country"", NULL) AS ""country"",'chargedback' AS ""state"",COALESCE(""t"".""amount"", 0) AS ""amount"",""c"".""trans_date"" FROM ""chargebacks"" AS ""c"" JOIN ""transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"") AS ""t1"" GROUP BY ""month"",""country"""
275,"SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(""state""='approved') AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(""state""='chargeback') AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT * FROM ""Transactions"" WHERE ""state""='approved' UNION ALL SELECT DISTINCT ""C"".""trans_id"" AS ""id"",""T"".""country"",'chargeback' AS ""state"",""T"".""amount"",""C"".""trans_date"" FROM ""Chargebacks"" AS ""C"" LEFT JOIN ""Transactions"" AS ""T"" ON ""C"".""trans_id""=""T"".""id"") AS ""final"" GROUP BY ""month"",""country"""
276,"SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state"" IS NULL THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state"" IS NULL THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",""state"",""amount"" FROM ""Transactions"" UNION ALL SELECT LEFT(""a"".""trans_date"", 7) AS ""month"",""b"".""country"",NULL AS ""state"",""b"".""amount"" FROM ""Chargebacks"" AS ""a"" JOIN ""Transactions"" AS ""b"" ON ""a"".""trans_id""=""b"".""id"") AS ""sub"" GROUP BY ""month"",""country"" HAVING ""approved_count""+""approved_amount""+""chargeback_count""+""chargeback_amount""!=0"
277,"WITH ""temp"" AS (SELECT ""id"",""country"",""state"",""amount"",TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"" FROM ""transactions"" UNION (SELECT ""c"".""trans_id"",""country"",'chargeback',""amount"",TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"" FROM ""transactions"" AS ""t"" RIGHT JOIN ""chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"")) SELECT * FROM (SELECT DISTINCT ""month"",""country"",COALESCE(COUNT(CASE WHEN ""state""='approved' THEN 1 END) OVER (PARTITION BY ""month"", ""country""), 0) AS ""approved_count"",COALESCE(SUM(CASE WHEN ""state""='approved' THEN ""amount"" END) OVER (PARTITION BY ""month"", ""country""), 0) AS ""approved_amount"",COALESCE(COUNT(CASE WHEN ""state""='chargeback' THEN 1 END) OVER (PARTITION BY ""month"", ""country""), 0) AS ""chargeback_count"",COALESCE(SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" END) OVER (PARTITION BY ""month"", ""country""), 0) AS ""chargeback_amount"" FROM ""temp"") AS ""temp2"" WHERE ""approved_count""+""approved_amount""+""chargeback_count""+""chargeback_amount""!=0"
278,"WITH ""base"" AS (SELECT ""country"",TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",0 AS ""chargeback_count"",0 AS ""chargeback_amount"" FROM ""transactions"" GROUP BY 1,2 UNION ALL SELECT ""country"",TO_CHAR(""a"".""trans_date"", 'YYYY-%m') AS ""month"",0 AS ""approved_count"",0 AS ""approved_amount"",COUNT(DISTINCT ""a"".""trans_id"") AS ""chargeback_count"",SUM(""b"".""amount"") AS ""chargeback_amount"" FROM ""Chargebacks"" AS ""a"" LEFT JOIN ""Transactions"" AS ""b"" ON ""a"".""trans_id""=""b"".""id"" GROUP BY 1,2) SELECT DISTINCT ""month"",""country"",SUM(""approved_count"") AS ""approved_count"",SUM(""approved_amount"") AS ""approved_amount"",SUM(""chargeback_count"") AS ""chargeback_count"",SUM(""chargeback_amount"") AS ""chargeback_amount"" FROM ""base"" WHERE ""approved_count""!=0 OR ""approved_amount""!=0 AND ""chargeback_count""!=0 OR ""chargeback_amount""!=0 GROUP BY 1,2"
279,"WITH ""cte"" AS (SELECT * FROM ""transactions"" WHERE ""state""='approved' UNION ALL SELECT ""c"".""trans_id"",""t"".""country"",'chargebacks' AS ""state"",""t"".""amount"",""c"".""trans_date"" FROM ""Chargebacks"" AS ""c"" LEFT JOIN ""transactions"" AS ""t"" ON ""t"".""id""=""c"".""trans_id"") SELECT SUBSTR(""trans_date"", 1, 7) AS ""month"",""country"",SUM(""state""='approved') AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(""state""='chargebacks') AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargebacks' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""cte"" GROUP BY SUBSTR(""trans_date"", 1, 7),""country"""
280,"SELECT ""C"".""month"",""C"".""country"",COALESCE(""approved_count"", 0) AS ""approved_count"",COALESCE(""approved_amount"", 0) AS ""approved_amount"",COALESCE(""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ((SELECT LEFT(""t"".""trans_date"", 7) AS ""month"",""t"".""country"" FROM ""transactions"" AS ""t"" UNION SELECT LEFT(""c"".""trans_date"", 7) AS ""month"",""t"".""country"" FROM ""transactions"" AS ""t"" JOIN ""chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"") AS ""C"" LEFT JOIN (SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"" FROM ""transactions"" GROUP BY LEFT(""trans_date"", 7),""country"") AS ""A"" ON ""A"".""month""=""C"".""month"" AND ""A"".""country""=""C"".""country"") LEFT JOIN (SELECT LEFT(""c"".""trans_date"", 7) AS ""month"",""country"",COUNT(""trans_id"") AS ""chargeback_count"",SUM(""amount"") AS ""chargeback_amount"" FROM ""transactions"" AS ""t"" RIGHT JOIN ""chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"" GROUP BY LEFT(""c"".""trans_date"", 7),""country"") AS ""B"" ON ""C"".""month""=""B"".""month"" AND ""C"".""country""=""B"".""country"" WHERE COALESCE(""approved_count"", 0)!=0 OR COALESCE(""approved_amount"", 0)!=0 OR COALESCE(""chargeback_count"", 0)!=0 OR COALESCE(""chargeback_amount"", 0)!=0"
281,"WITH ""trans"" AS (SELECT SUBSTRING(""trans_date"", 1, 7) AS ""month"",""country"",COUNT(1) AS ""approved_count"",SUM(""amount"") AS ""approved_amount"" FROM ""Transactions"" WHERE ""state""='approved' GROUP BY 1,2), ""charge"" AS (SELECT SUBSTRING(""c"".""trans_date"", 1, 7) AS ""month"",""country"",COUNT(1) AS ""chargeback_count"",SUM(""amount"") AS ""chargeback_amount"" FROM ""Chargebacks"" AS ""c"" JOIN ""Transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" GROUP BY 1,2), ""all_months"" AS (SELECT ""month"",""country"" FROM ""trans"" UNION SELECT ""month"",""country"" FROM ""charge"") SELECT ""a"".""month"",""a"".""country"",COALESCE(""t"".""approved_count"", 0) AS ""approved_count"",COALESCE(""t"".""approved_amount"", 0) AS ""approved_amount"",COALESCE(""c"".""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""c"".""chargeback_amount"", 0) AS ""chargeback_amount"" FROM (""all_months"" AS ""a"" LEFT JOIN ""trans"" AS ""t"" ON ""t"".""month""=""a"".""month"" AND ""t"".""country""=""a"".""country"") LEFT JOIN ""charge"" AS ""c"" ON ""a"".""month""=""c"".""month"" AND ""a"".""country""=""c"".""country"""
282,"WITH ""temp"" AS (SELECT SUBSTR(""trans_date"", 1, 7) AS ""month"",""country"" AS ""country"",COUNT(DISTINCT ""id"") AS ""approved_count"",SUM(""amount"") AS ""approved_amount"" FROM ""transactions"" WHERE ""state""='approved' GROUP BY SUBSTR(""trans_date"", 1, 7),""country""), ""temp2"" AS (SELECT SUBSTR(""c"".""trans_date"", 1, 7) AS ""month"",""t"".""country"" AS ""country"",COUNT(""c"".""trans_id"") AS ""chargeback_count"",SUM(""t"".""amount"") AS ""chargeback_amount"" FROM (""chargebacks"" AS ""c"") CROSS JOIN ""transactions"" AS ""t"" WHERE ""c"".""trans_id""=""t"".""id"" GROUP BY SUBSTR(""c"".""trans_date"", 1, 7),""t"".""country"") SELECT ""t"".""month"",""t"".""country"",""t"".""approved_count"",""t"".""approved_amount"",COALESCE(""t2"".""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""t2"".""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""temp"" AS ""t"" LEFT JOIN ""temp2"" AS ""t2"" ON ""t"".""month""=""t2"".""month"" AND ""t"".""country""=""t2"".""country"" UNION SELECT ""t2"".""month"",""t2"".""country"",COALESCE(""t"".""approved_count"", 0) AS ""approved_count"",COALESCE(""t"".""approved_amount"", 0) AS ""approved_amount"",""t2"".""chargeback_count"",""t2"".""chargeback_amount"" FROM ""temp2"" AS ""t2"" LEFT JOIN ""temp"" AS ""t"" ON ""t2"".""month""=""t"".""month"" AND ""t2"".""country""=""t"".""country"""
283,"SELECT ""mnth"" AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='Chargeback' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='Chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT CONCAT(EXTRACT(YEAR FROM ""trans_date""), '-0', EXTRACT(MONTH FROM ""trans_date"")) AS ""mnth"",""country"",""state"",""amount"" FROM ""transactions"" WHERE ""state""='approved' UNION ALL SELECT CONCAT(EXTRACT(YEAR FROM ""c"".""trans_date""), '-0', EXTRACT(MONTH FROM ""c"".""trans_date"")) AS ""mnth"",""country"",'Chargeback' AS ""state"",""amount"" FROM ""chargebacks"" AS ""c"" LEFT JOIN ""transactions"" AS ""t"" ON ""t"".""id""=""c"".""trans_id"") AS ""a"" GROUP BY ""mnth"",""country"""
284,"WITH ""cte"" AS (SELECT ""id"",""country"",""state"",""amount"",""trans_date"" FROM ""Transactions"" UNION SELECT ""c"".""trans_id"",""country"",'chargeback',""amount"",""c"".""trans_date"" FROM ""Transactions"" AS ""t"" RIGHT JOIN ""Chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"") SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(""state""='approved') AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(""state""='chargeback') AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""cte"" GROUP BY ""month"",""country"" HAVING ""approved_count""+""approved_amount""+""chargeback_count""+""chargeback_amount""!=0"
285,"WITH ""tmp"" AS (SELECT * FROM ""transactions"" WHERE ""state""='approved' UNION ALL SELECT ""id"",""country"",'back' AS ""state"",""amount"",""c"".""trans_date"" FROM ""transactions"" JOIN ""chargebacks"" AS ""c"" ON ""id""=""trans_id"") SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='back' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='back' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""tmp"" GROUP BY LEFT(""trans_date"", 7),""country"""
286,"WITH ""mnth"" AS (SELECT DISTINCT SUBSTR(""trans_date"", 1, 7) AS ""month"" FROM (SELECT ""trans_date"" FROM ""transactions"" UNION SELECT ""trans_date"" FROM ""chargebacks"") AS ""t""), ""temp"" AS (SELECT SUBSTR(""trans_date"", 1, 7) AS ""month"",""country"" AS ""country"",COUNT(DISTINCT ""id"") AS ""approved_count"",SUM(""amount"") AS ""approved_amount"" FROM ""transactions"" WHERE ""state""='approved' GROUP BY SUBSTR(""trans_date"", 1, 7),""country""), ""temp2"" AS (SELECT SUBSTR(""c"".""trans_date"", 1, 7) AS ""month"",""t"".""country"" AS ""country"",COUNT(""c"".""trans_id"") AS ""chargeback_count"",SUM(""t"".""amount"") AS ""chargeback_amount"" FROM (""chargebacks"" AS ""c"") CROSS JOIN ""transactions"" AS ""t"" WHERE ""c"".""trans_id""=""t"".""id"" GROUP BY SUBSTR(""c"".""trans_date"", 1, 7),""t"".""country"") SELECT ""t"".""month"",""t"".""country"",""t"".""approved_count"",""t"".""approved_amount"",COALESCE(""t2"".""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""t2"".""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""temp"" AS ""t"" LEFT JOIN ""temp2"" AS ""t2"" ON ""t"".""month""=""t2"".""month"" AND ""t"".""country""=""t2"".""country"" UNION SELECT ""t2"".""month"",""t2"".""country"",COALESCE(""t"".""approved_count"", 0) AS ""approved_count"",COALESCE(""t"".""approved_amount"", 0) AS ""approved_amount"",""t2"".""chargeback_count"",""t2"".""chargeback_amount"" FROM ""temp2"" AS ""t2"" LEFT JOIN ""temp"" AS ""t"" ON ""t2"".""month""=""t"".""month"" AND ""t2"".""country""=""t"".""country"""
287,"SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='back' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='back' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT LEFT(""chargebacks"".""trans_date"", 7) AS ""month"",""country"",'back' AS ""state"",""amount"" FROM ""chargebacks"" JOIN ""transactions"" ON ""chargebacks"".""trans_id""=""transactions"".""id"" UNION ALL SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",""state"",""amount"" FROM ""transactions"" WHERE ""state""='approved') AS ""s"" GROUP BY ""month"",""country"""
288,"SELECT * FROM (SELECT ""b"".""month"",""b"".""country"",COALESCE(""b"".""approved_count"", 0) AS ""approved_count"",COALESCE(""b"".""approved_amount"", 0) AS ""approved_amount"",COALESCE(""D"".""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""D"".""chargeback_amount"", 0) AS ""chargeback_amount"" FROM (SELECT ""trans_month"" AS ""month"",""country"",SUM(""approve"") AS ""approved_count"",SUM(""amount""*""approve"") AS ""approved_amount"" FROM (SELECT *,TO_CHAR(""trans_date"", 'YYYY-%m') AS ""trans_month"",CASE WHEN ""state""='approved' THEN 1 ELSE 0 END AS ""approve"" FROM ""Transactions"") AS ""a"" GROUP BY ""trans_month"",""country"") AS ""b"" LEFT JOIN (SELECT ""month"",""country"",COUNT(""amount"") AS ""chargeback_count"",SUM(""amount"") AS ""chargeback_amount"" FROM (SELECT ""A"".""month"",""B"".""country"",""B"".""amount"" FROM (SELECT ""trans_id"",TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"" FROM ""Chargebacks"") AS ""A"" LEFT JOIN ""Transactions"" AS ""B"" ON ""A"".""trans_id""=""B"".""id"") AS ""C"" GROUP BY ""month"",""country"") AS ""D"" ON ""b"".""month""=""D"".""month"" AND ""b"".""country""=""D"".""country"" UNION SELECT ""D"".""month"",""D"".""country"",COALESCE(""b"".""approved_count"", 0) AS ""approved_count"",COALESCE(""b"".""approved_amount"", 0) AS ""approved_amount"",COALESCE(""D"".""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""D"".""chargeback_amount"", 0) AS ""chargeback_amount"" FROM (SELECT ""trans_month"" AS ""month"",""country"",SUM(""approve"") AS ""approved_count"",SUM(""amount""*""approve"") AS ""approved_amount"" FROM (SELECT *,TO_CHAR(""trans_date"", 'YYYY-%m') AS ""trans_month"",CASE WHEN ""state""='approved' THEN 1 ELSE 0 END AS ""approve"" FROM ""Transactions"") AS ""a"" GROUP BY ""trans_month"",""country"") AS ""b"" RIGHT JOIN (SELECT ""month"",""country"",COUNT(""amount"") AS ""chargeback_count"",SUM(""amount"") AS ""chargeback_amount"" FROM (SELECT ""A"".""month"",""B"".""country"",""B"".""amount"" FROM (SELECT ""trans_id"",TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"" FROM ""Chargebacks"") AS ""A"" LEFT JOIN ""Transactions"" AS ""B"" ON ""A"".""trans_id""=""B"".""id"") AS ""C"" GROUP BY ""month"",""country"") AS ""D"" ON ""b"".""month""=""D"".""month"" AND ""b"".""country""=""D"".""country"") AS ""G"" WHERE ""approved_count""!=0 OR ""approved_amount""!=0 OR ""chargeback_count""!=0 OR ""chargeback_amount""!=0"
289,"WITH ""app"" AS (SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""trans_date"",""country"",SUM(""amount"") AS ""amount"",COUNT(""amount"") AS ""approved_count"" FROM ""Transactions"" WHERE ""state""='approved' GROUP BY TO_CHAR(""trans_date"", 'YYYY-%m'),""country""), ""chargeback"" AS (SELECT TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""trans_date"",""country"",SUM(""amount"") AS ""amount"",COUNT(""amount"") AS ""chargeback_count"" FROM ""Transactions"" AS ""t"" JOIN ""Chargebacks"" AS ""c"" ON ""c"".""trans_id""=""t"".""id"" GROUP BY TO_CHAR(""c"".""trans_date"", 'YYYY-%m'),""country"") SELECT COALESCE(""a"".""trans_date"", ""c"".""trans_date"") AS ""month"",COALESCE(""a"".""country"", ""c"".""country"") AS ""country"",COALESCE(""a"".""approved_count"", 0) AS ""approved_count"",COALESCE(""a"".""amount"", 0) AS ""approved_amount"",COALESCE(""c"".""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""c"".""amount"", 0) AS ""chargeback_amount"" FROM ""app"" AS ""a"" LEFT JOIN ""chargeback"" AS ""c"" ON ""a"".""trans_date""=""c"".""trans_date"" AND ""c"".""country""=""a"".""country"" UNION SELECT COALESCE(""a"".""trans_date"", ""c"".""trans_date"") AS ""month"",COALESCE(""a"".""country"", ""c"".""country"") AS ""country"",COALESCE(""a"".""approved_count"", 0) AS ""approved_count"",COALESCE(""a"".""amount"", 0) AS ""approved_amount"",COALESCE(""c"".""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""c"".""amount"", 0) AS ""chargeback_amount"" FROM ""app"" AS ""a"" RIGHT JOIN ""chargeback"" AS ""c"" ON ""a"".""trans_date""=""c"".""trans_date"" AND ""c"".""country""=""a"".""country"""
290,"WITH ""cte1"" AS (SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"" FROM ""transactions"" GROUP BY ""month"",""country""), ""cte2"" AS (SELECT TO_CHAR(""chargebacks"".""trans_date"", 'YYYY-%m') AS ""month"",""transactions"".""country"",COUNT(""transactions"".""id"") AS ""chargeback_count"",SUM(""transactions"".""amount"") AS ""chargeback_amount"" FROM ""chargebacks"" JOIN ""transactions"" ON ""chargebacks"".""trans_id""=""transactions"".""id"" GROUP BY ""month"",""country"") (SELECT ""c2"".""month"",""c2"".""country"",COALESCE(""c1"".""approved_count"", 0) AS ""approved_count"",COALESCE(""c1"".""approved_amount"", 0) AS ""approved_amount"",""c2"".""chargeback_count"",""c2"".""chargeback_amount"" FROM ""cte1"" AS ""c1"" RIGHT JOIN ""cte2"" AS ""c2"" ON (""c1"".""month""=""c2"".""month"" AND ""c1"".""country""=""c2"".""country"")) UNION (SELECT ""c1"".""month"",""c1"".""country"",""c1"".""approved_count"",""c1"".""approved_amount"",COALESCE(""c2"".""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""c2"".""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""cte1"" AS ""c1"" LEFT JOIN ""cte2"" AS ""c2"" ON (""c1"".""month""=""c2"".""month"" AND ""c1"".""country""=""c2"".""country"") WHERE ""c1"".""approved_count""!=0) ORDER BY ""month"",""country"""
291,"WITH ""cte1"" AS (SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",COUNT(""state"") AS ""approved_count"",SUM(""amount"") AS ""approved_amount"" FROM ""Transactions"" AS ""t"" WHERE ""state""='approved' GROUP BY LEFT(""trans_date"", 7),""country""), ""cte2"" AS (SELECT LEFT(""c"".""trans_date"", 7) AS ""month"",""t"".""country"",COUNT(""c"".""trans_date"") AS ""chargeback_count"",SUM(""t"".""amount"") AS ""chargeback_amount"" FROM ""Chargebacks"" AS ""c"" JOIN ""Transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" GROUP BY LEFT(""c"".""trans_date"", 7),""t"".""country""), ""cte3"" AS (SELECT ""month"",""country"" FROM (SELECT ""month"",""country"" FROM ""cte1"" UNION SELECT ""month"",""country"" FROM ""cte2"") AS ""t""), ""cte4"" AS (SELECT ""month"",""country"" FROM ""cte3"" GROUP BY ""month"",""country""), ""cte5"" AS (SELECT ""c4"".""month"",""c4"".""country"",COALESCE(""c1"".""approved_count"", 0) AS ""approved_count"",COALESCE(""c1"".""approved_amount"", 0) AS ""approved_amount"",COALESCE(""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""chargeback_amount"", 0) AS ""chargeback_amount"" FROM (""cte4"" AS ""c4"" LEFT JOIN ""cte1"" AS ""c1"" ON ""c4"".""month""=""c1"".""month"" AND ""c4"".""country""=""c1"".""country"") LEFT JOIN ""cte2"" AS ""c2"" ON ""c4"".""month""=""c2"".""month"" AND ""c4"".""country""=""c2"".""country"" ORDER BY ""month"",""country"") SELECT * FROM ""cte5"""
292,"WITH ""cte"" AS (SELECT ""t"".* FROM ""transactions"" AS ""t"" WHERE ""state""='approved' UNION ALL SELECT ""trans_id"",""t"".""country"",'back' AS ""state"",""t"".""amount"",""c"".""trans_date"" FROM ""chargebacks"" AS ""c"" LEFT JOIN ""transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"") SELECT SUBSTR(""trans_date"", 1, 7) AS ""month"",""country"",SUM(""state""='approved') AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(""state""='back') AS ""chargeback_count"",SUM(CASE WHEN ""state""='back' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""cte"" GROUP BY 1,""country"""
293,"WITH ""t"" AS (SELECT ""c"".""trans_id"",TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"",""country"",'chargeback' AS ""state"",""amount"" FROM ""Chargebacks"" AS ""c"" JOIN ""Transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" UNION SELECT ""t"".""id"",TO_CHAR(""t"".""trans_date"", 'YYYY-%m') AS ""month"",""country"",""state"",""amount"" FROM ""Transactions"" AS ""t"") SELECT ""month"",""country"",SUM(""state""='approved') AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(""state""='chargeback') AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""t"" GROUP BY ""month"",""country"" HAVING ""approved_count""+""approved_amount""+""chargeback_count""+""chargeback_amount""!=0"
294,"WITH ""cte_appr"" AS (SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",COUNT(1) AS ""approved_count"",SUM(""amount"") AS ""approved_amount"" FROM ""Transactions"" WHERE ""state""='approved' GROUP BY 1,2), ""cte_char"" AS (SELECT LEFT(""tab1"".""trans_date"", 7) AS ""month"",""tab2"".""country"",COUNT(1) AS ""chargeback_count"",SUM(""tab2"".""amount"") AS ""chargeback_amount"" FROM ""Chargebacks"" AS ""tab1"" LEFT JOIN ""Transactions"" AS ""tab2"" ON ""tab1"".""trans_id""=""tab2"".""id"" GROUP BY 1,2) SELECT ""tab1"".""month"",""tab1"".""country"",""tab1"".""approved_count"",""tab1"".""approved_amount"",COALESCE(""tab2"".""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""tab2"".""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""cte_appr"" AS ""tab1"" LEFT JOIN ""cte_char"" AS ""tab2"" ON ""tab1"".""month""=""tab2"".""month"" AND ""tab1"".""country""=""tab2"".""country"" UNION SELECT ""tab2"".""month"",""tab2"".""country"",COALESCE(""tab1"".""approved_count"", 0) AS ""approved_count"",COALESCE(""tab1"".""approved_amount"", 0) AS ""approved_amount"",""tab2"".""chargeback_count"",""tab2"".""chargeback_amount"" FROM ""cte_appr"" AS ""tab1"" RIGHT JOIN ""cte_char"" AS ""tab2"" ON ""tab1"".""month""=""tab2"".""month"" AND ""tab1"".""country""=""tab2"".""country"" WHERE ""tab1"".""month"" IS NULL AND ""tab1"".""country"" IS NULL"
295,"SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='back' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='back' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT LEFT(""chargebacks"".""trans_date"", 7) AS ""month"",""country"",'back' AS ""state"",""amount"" FROM ""chargebacks"" JOIN ""transactions"" ON ""chargebacks"".""trans_id""=""transactions"".""id"" UNION ALL SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",""state"",""amount"" FROM ""transactions"" WHERE ""state""='approved') AS ""s"" GROUP BY ""month"",""country"""
296,"WITH ""x"" AS (SELECT * FROM ""transactions"" WHERE ""state""='approved' UNION SELECT ""c"".""trans_id"" AS ""id"",""t"".""country"",'chargeback' AS ""state"",""t"".""amount"",""c"".""trans_date"" FROM ""chargebacks"" AS ""c"" LEFT JOIN ""transactions"" AS ""t"" ON ""t"".""id""=""c"".""trans_id"") SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",SUM(""state""='approved') AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(""state""='chargeback') AS ""chargeback_count"",SUM(CASE WHEN (""state""='chargeback') THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""x"" GROUP BY 1,2"
297,"WITH ""trans_sum"" AS (SELECT ""id"" AS ""trans_id"",TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",""amount"" FROM ""transactions"" WHERE ""state""='approved'), ""cb_sum"" AS (SELECT ""c"".""trans_id"",""t"".""country"",TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"",""t"".""amount"" AS ""chargeback_amount"" FROM ""chargebacks"" AS ""c"" JOIN ""transactions"" AS ""t"" ON ""t"".""id""=""c"".""trans_id""), ""all_months"" AS (SELECT DISTINCT ""country"",TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"" FROM ""transactions"" UNION SELECT DISTINCT ""t"".""country"",TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"" FROM ""chargebacks"" AS ""c"" JOIN ""transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"") SELECT ""month"",""country"",COALESCE(""approved_count"", 0) AS ""approved_count"",COALESCE(""approved_amount"", 0) AS ""approved_amount"",COALESCE(""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""chargeback_amount"", 0) AS ""chargeback_amount"" FROM (SELECT ""a"".""month"",""a"".""country"",""approved_count"" AS ""approved_count"",""approved_amount"" AS ""approved_amount"",COUNT(DISTINCT ""c"".""trans_id"") AS ""chargeback_count"",SUM(""chargeback_amount"") AS ""chargeback_amount"" FROM (SELECT ""a"".""month"",""a"".""country"",COUNT(DISTINCT ""t"".""trans_id"") AS ""approved_count"",SUM(""t"".""amount"") AS ""approved_amount"" FROM ""all_months"" AS ""a"" LEFT JOIN ""trans_sum"" AS ""t"" ON ""t"".""month""=""a"".""month"" AND ""t"".""country""=""a"".""country"" GROUP BY 1,2) AS ""a"" LEFT JOIN ""cb_sum"" AS ""c"" ON ""c"".""month""=""a"".""month"" AND ""c"".""country""=""a"".""country"" GROUP BY 1,2,3,4) AS ""result_table"" WHERE ""approved_count""+""chargeback_count""!=0"
298,"SELECT ""a"".""month"",""a"".""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='back' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='back' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT DISTINCT ""id"",LEFT(""trans_date"", 7) AS ""month"",""country"",""state"",""amount"" FROM ""transactions"" WHERE ""state""='approved' UNION ALL SELECT ""b"".""id"",LEFT(""a"".""trans_date"", 7) AS ""month"",""b"".""country"",'back' AS ""state"",""b"".""amount"" FROM ""chargebacks"" AS ""a"" JOIN ""transactions"" AS ""b"" ON ""a"".""trans_id""=""b"".""id"") AS ""a"" GROUP BY ""a"".""month"",""a"".""country"""
299,"WITH ""tab1"" AS (SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",COUNT(""state"") AS ""approved_count"",SUM(""amount"") AS ""approved_amount"" FROM ""transactions"" WHERE ""state""='approved' GROUP BY TO_CHAR(""trans_date"", 'YYYY-%m'),""country""), ""tab2"" AS (SELECT TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"",""t"".""country"",COUNT(""c"".""trans_id"") AS ""chargeback_count"",SUM(""t"".""amount"") AS ""chargeback_amount"" FROM ""chargebacks"" AS ""c"" JOIN ""transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" GROUP BY TO_CHAR(""c"".""trans_date"", 'YYYY-%m'),""t"".""country"") SELECT ""tab1"".""month"",""tab1"".""country"",""tab1"".""approved_count"",""tab1"".""approved_amount"",COALESCE(""tab2"".""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""tab2"".""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""tab1"" LEFT JOIN ""tab2"" ON ""tab1"".""month""=""tab2"".""month"" AND ""tab1"".""country""=""tab2"".""country"" UNION SELECT ""tab2"".""month"",""tab2"".""country"",COALESCE(""tab1"".""approved_count"", 0) AS ""approved_count"",COALESCE(""tab1"".""approved_amount"", 0) AS ""approved_amount"",""tab2"".""chargeback_count"",""tab2"".""chargeback_amount"" FROM ""tab1"" RIGHT JOIN ""tab2"" ON ""tab1"".""month""=""tab2"".""month"" AND ""tab1"".""country""=""tab2"".""country"""
300,"WITH ""master_table"" AS ((SELECT ""trans_id"",""country"",TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""date"",""amount"" AS ""chargeback_amount"",0 AS ""approved_amount"" FROM ""Chargebacks"" AS ""c"" LEFT JOIN ""Transactions"" AS ""t"" ON ""t"".""id""=""c"".""trans_id"") UNION ALL (SELECT ""id"",""country"",TO_CHAR(""trans_date"", 'YYYY-%m') AS ""date"",0 AS ""chargeback_amount"",CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END AS ""approved_amount"" FROM ""Transactions"")) SELECT ""date"" AS ""month"",""country"",COUNT(CASE WHEN ""approved_amount""!=0 THEN ""approved_amount"" ELSE NULL END) AS ""approved_count"",SUM(""approved_amount"") AS ""approved_amount"",COUNT(CASE WHEN ""chargeback_amount""!=0 THEN ""chargeback_amount"" ELSE NULL END) AS ""chargeback_count"",SUM(""chargeback_amount"") AS ""chargeback_amount"" FROM ""master_table"" GROUP BY 1,2 HAVING ""approved_amount""!=0 OR ""chargeback_amount""!=0"
301,"WITH ""trans"" AS (SELECT DISTINCT * FROM ""transactions"" WHERE ""state""='approved' UNION ALL SELECT DISTINCT ""t"".""id"",""t"".""country"",'chargeback' AS ""state"",""t"".""amount"",""c"".""trans_date"" FROM ""transactions"" AS ""t"" JOIN ""chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"") SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(""state""='approved') AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(""state""='chargeback') AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""trans"" GROUP BY 1,2"
302,"SELECT ""month"",""country"",SUM(""a"".""approved_count"") AS ""approved_count"",SUM(""a"".""approved_amount"") AS ""approved_amount"",SUM(""a"".""chargeback_count"") AS ""chargeback_count"",SUM(""a"".""chargeback_amount"") AS ""chargeback_amount"" FROM (SELECT LEFT(""c"".""trans_date"", 7) AS ""month"",""country"",0 AS ""approved_count"",0 AS ""approved_amount"",COUNT(1) AS ""chargeback_count"",SUM(""amount"") AS ""chargeback_amount"" FROM ""Chargebacks"" AS ""c"" LEFT JOIN ""Transactions"" AS ""t"" ON ""t"".""id""=""c"".""trans_id"" GROUP BY ""month"",""country"" UNION ALL SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",0 AS ""chargeback_count"",0 AS ""chargeback_amount"" FROM ""Transactions"" GROUP BY ""month"",""country"") AS ""a"" WHERE ROW(""approved_count"",""approved_amount"",""chargeback_count"",""chargeback_amount"")!=ROW(0,0,0,0) GROUP BY ""a"".""month"",""a"".""country"""
303,"SELECT ""t1"".""month"",""t1"".""country"",COALESCE(""t1"".""approved_count"", 0) AS ""approved_count"",COALESCE(""t1"".""approved_amount"", 0) AS ""approved_amount"",COALESCE(""t2"".""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""t2"".""chargeback_amount"", 0) AS ""chargeback_amount"" FROM (SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",COUNT(""id"") AS ""approved_count"",SUM(""amount"") AS ""approved_amount"" FROM ""Transactions"" WHERE ""state""='approved' GROUP BY ""month"",""country"") AS ""t1"" LEFT JOIN (SELECT LEFT(""a"".""trans_date"", 7) AS ""month"",""b"".""country"",COUNT(""a"".""trans_id"") AS ""chargeback_count"",SUM(""b"".""amount"") AS ""chargeback_amount"" FROM ""Chargebacks"" AS ""a"" LEFT JOIN ""Transactions"" AS ""b"" ON ""a"".""trans_id""=""b"".""id"" GROUP BY ""month"",""country"") AS ""t2"" ON ""t1"".""month""=""t2"".""month"" AND ""t1"".""country""=""t2"".""country"" UNION SELECT ""t2"".""month"",""t2"".""country"",COALESCE(""t1"".""approved_count"", 0) AS ""approved_count"",COALESCE(""t1"".""approved_amount"", 0) AS ""approved_amount"",COALESCE(""t2"".""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""t2"".""chargeback_amount"", 0) AS ""chargeback_amount"" FROM (SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",COUNT(""id"") AS ""approved_count"",SUM(""amount"") AS ""approved_amount"" FROM ""Transactions"" WHERE ""state""='approved' GROUP BY ""month"",""country"") AS ""t1"" RIGHT JOIN (SELECT LEFT(""a"".""trans_date"", 7) AS ""month"",""b"".""country"",COUNT(""a"".""trans_id"") AS ""chargeback_count"",SUM(""b"".""amount"") AS ""chargeback_amount"" FROM ""Chargebacks"" AS ""a"" LEFT JOIN ""Transactions"" AS ""b"" ON ""a"".""trans_id""=""b"".""id"" GROUP BY ""month"",""country"") AS ""t2"" ON ""t1"".""month""=""t2"".""month"" AND ""t1"".""country""=""t2"".""country"""
304,"SELECT ""month"",""country"",MAX(CASE WHEN ""state""='approved' THEN ""cnt"" ELSE 0 END) AS ""approved_count"",MAX(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",MAX(CASE WHEN ""state""='chargeback' THEN ""cnt"" ELSE 0 END) AS ""chargeback_count"",MAX(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ((SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",""state"",COUNT(DISTINCT ""id"") AS ""cnt"",SUM(""amount"") AS ""amount"" FROM ""transactions"" WHERE ""state""='approved' GROUP BY 1,2) UNION ALL (SELECT LEFT(""c"".""trans_date"", 7) AS ""month"",""t"".""country"",'chargeback' AS ""state"",COUNT(DISTINCT ""c"".""trans_id"") AS ""cnt"",SUM(""t"".""amount"") AS ""amount"" FROM ""chargebacks"" AS ""c"" LEFT JOIN ""transactions"" AS ""t"" ON ""t"".""id""=""c"".""trans_id"" AND ""t"".""trans_date""<=""c"".""trans_date"" GROUP BY 1,2)) AS ""t"" GROUP BY 1,2"
305,"WITH ""approved_table"" AS (SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"" FROM ""transactions"" GROUP BY ""month"",""country""), ""charge_back"" AS (SELECT TO_CHAR(""chargebacks"".""trans_date"", 'YYYY-%m') AS ""month"",""country"",COUNT(1) AS ""chargeback_count"",SUM(""amount"") AS ""chargeback_amount"" FROM ""transactions"" JOIN ""chargebacks"" ON ""transactions"".""id""=""chargebacks"".""trans_id"" GROUP BY ""month"",""country"") SELECT * FROM (SELECT ""approved_table"".""month"",""approved_table"".""country"",""approved_count"",""approved_amount"",COALESCE(""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""approved_table"" LEFT JOIN ""charge_back"" ON ""charge_back"".""month""=""approved_table"".""month"" AND ""charge_back"".""country""=""approved_table"".""country"" UNION ALL SELECT ""charge_back"".""month"",""charge_back"".""country"",COALESCE(""approved_count"", 0),COALESCE(""approved_amount"", 0),""chargeback_count"",""chargeback_amount"" FROM ""approved_table"" RIGHT JOIN ""charge_back"" ON ""charge_back"".""month""=""approved_table"".""month"" AND ""charge_back"".""country""=""approved_table"".""country"" WHERE ""approved_count"" IS NULL) AS ""temp"" WHERE ""approved_count""!=0 OR ""chargeback_count""!=0"
306,"WITH ""cte1"" AS (SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"" FROM ""transactions"" GROUP BY ""month"",""country""), ""cte2"" AS (SELECT TO_CHAR(""chargebacks"".""trans_date"", 'YYYY-%m') AS ""month"",""transactions"".""country"",COUNT(""transactions"".""id"") AS ""chargeback_count"",SUM(""transactions"".""amount"") AS ""chargeback_amount"" FROM ""chargebacks"" JOIN ""transactions"" ON ""chargebacks"".""trans_id""=""transactions"".""id"" GROUP BY ""month"",""country"") (SELECT ""c2"".""month"",""c2"".""country"",COALESCE(""c1"".""approved_count"", 0) AS ""approved_count"",COALESCE(""c1"".""approved_amount"", 0) AS ""approved_amount"",""c2"".""chargeback_count"",""c2"".""chargeback_amount"" FROM ""cte1"" AS ""c1"" RIGHT JOIN ""cte2"" AS ""c2"" ON (""c1"".""month""=""c2"".""month"" AND ""c1"".""country""=""c2"".""country"")) UNION (SELECT ""c1"".""month"",""c1"".""country"",""c1"".""approved_count"",""c1"".""approved_amount"",COALESCE(""c2"".""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""c2"".""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""cte1"" AS ""c1"" LEFT JOIN ""cte2"" AS ""c2"" ON (""c1"".""month""=""c2"".""month"" AND ""c1"".""country""=""c2"".""country"") WHERE ""c1"".""approved_count""!=0) ORDER BY ""month"",""country"""
307,"SELECT ""f1"".""month"",""f1"".""country"",""approved_count"",""approved_amount"",COALESCE(""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""chargeback_amount"", 0) AS ""chargeback_amount"" FROM (SELECT LEFT(""t"".""trans_date"", 7) AS ""month"",""t"".""country"",COUNT(1) AS ""approved_count"",SUM(""amount"") AS ""approved_amount"" FROM ""transactions"" AS ""t"" WHERE ""state""='approved' GROUP BY LEFT(""t"".""trans_date"", 7),""country"") AS ""f1"" LEFT JOIN (SELECT LEFT(""c"".""trans_date"", 7) AS ""month"",""country"",COUNT(""trans_id"") AS ""chargeback_count"",SUM(""amount"") AS ""chargeback_amount"" FROM ""chargebacks"" AS ""c"" JOIN ""transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" GROUP BY LEFT(""c"".""trans_date"", 7),""country"") AS ""f2"" ON ""f1"".""month""=""f2"".""month"" AND ""f1"".""country""=""f2"".""country"" UNION SELECT ""f4"".""month"",""f4"".""country"",COALESCE(""approved_count"", 0) AS ""approved_count"",COALESCE(""approved_amount"", 0) AS ""approved_amount"",""chargeback_count"",""chargeback_amount"" FROM (SELECT LEFT(""t"".""trans_date"", 7) AS ""month"",""t"".""country"",COUNT(1) AS ""approved_count"",SUM(""amount"") AS ""approved_amount"" FROM ""transactions"" AS ""t"" WHERE ""state""='approved' GROUP BY LEFT(""t"".""trans_date"", 7),""country"") AS ""f3"" RIGHT JOIN (SELECT LEFT(""c"".""trans_date"", 7) AS ""month"",""country"",COUNT(""trans_id"") AS ""chargeback_count"",SUM(""amount"") AS ""chargeback_amount"" FROM ""chargebacks"" AS ""c"" JOIN ""transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" GROUP BY LEFT(""c"".""trans_date"", 7),""country"") AS ""f4"" ON ""f3"".""month""=""f4"".""month"" AND ""f3"".""country""=""f4"".""country"" ORDER BY ""month"",""country"""
308,"WITH ""cte_all"" AS (SELECT ""id"",""country"",""state"",""amount"",""trans_date"" FROM ""Transactions"" WHERE ""state""='approved' UNION SELECT ""t"".""id"",""t"".""country"",'chargeback' AS ""state"",""amount"",""c"".""trans_date"" FROM ""Transactions"" AS ""t"" JOIN ""Chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"") SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='chargeback' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""cte_all"" GROUP BY TO_CHAR(""trans_date"", 'YYYY-%m'),""country"""
309,"WITH ""cte"" AS (SELECT ""id"",""country"",'chargebacks' AS ""state"",""amount"",""c"".""trans_date"" FROM ""Transactions"" AS ""t"" RIGHT JOIN ""Chargebacks"" AS ""c"" ON ""c"".""trans_id""=""t"".""id"" UNION SELECT * FROM ""Transactions"" WHERE ""state""='approved') SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='chargebacks' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargebacks' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""cte"" GROUP BY LEFT(""trans_date"", 7),""country"""
310,"SELECT * FROM (SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='chargeback' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT ""c"".""trans_id"",""t"".""country"",'chargeback' AS ""state"",""t"".""amount"",""c"".""trans_date"" FROM ""Chargebacks"" AS ""c"" JOIN ""Transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" UNION ALL SELECT * FROM ""Transactions"") AS ""temp"" GROUP BY ""month"",""country"") AS ""temp1"" WHERE ROW(""approved_count"",""approved_amount"",""chargeback_count"",""chargeback_amount"")!=ROW(0,0,0,0)"
311,"WITH ""cte"" AS (SELECT * FROM ""Transactions"" UNION ALL SELECT ""t"".""id"",""t"".""country"",'charge_back' AS ""state"",""t"".""amount"",""c"".""trans_date"" FROM ""Transactions"" AS ""t"" JOIN ""Chargebacks"" AS ""c"" ON ""c"".""trans_id""=""t"".""id"") SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='charge_back' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='charge_back' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM ""cte"" GROUP BY 1,2 HAVING ""approved_amount"">0 OR ""chargeback_amount"">0"
312,"WITH ""stacked"" AS (SELECT TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"",""country"",NULL AS ""approved_count"",NULL AS ""approved_amount"",COUNT(1) AS ""chargeback_count"",SUM(""amount"") AS ""chargeback_amount"" FROM ""chargebacks"" AS ""c"" LEFT JOIN ""transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" GROUP BY 1,2 UNION ALL SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",NULL AS ""chargeback_count"",NULL AS ""chargeback_amount"" FROM ""transactions"" GROUP BY 1,2) SELECT ""month"",""country"",COALESCE(SUM(""approved_count""), 0) AS ""approved_count"",COALESCE(SUM(""approved_amount""), 0) AS ""approved_amount"",COALESCE(SUM(""chargeback_count""), 0) AS ""chargeback_count"",COALESCE(SUM(""chargeback_amount""), 0) AS ""chargeback_amount"" FROM ""stacked"" GROUP BY 1,2 HAVING COALESCE(SUM(""approved_count""), 0)+COALESCE(SUM(""approved_amount""), 0)+COALESCE(SUM(""chargeback_count""), 0)+COALESCE(SUM(""chargeback_amount""), 0)!=0"
313,"WITH ""t1"" AS (SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",COUNT(1) AS ""cnt1"",SUM(""amount"") AS ""sum1"" FROM ""transactions"" WHERE ""state""='approved' GROUP BY 1,2), ""t2"" AS (SELECT LEFT(""a"".""trans_date"", 7) AS ""month"",""country"",COUNT(1) AS ""cnt2"",SUM(""amount"") AS ""sum2"" FROM ""chargebacks"" AS ""a"" JOIN ""transactions"" AS ""b"" ON ""a"".""trans_id""=""b"".""id"" GROUP BY 1,2), ""t3"" AS (SELECT ""t1"".""month"",""country"" FROM ""t1"" UNION SELECT ""t2"".""month"",""country"" FROM ""t2"") SELECT ""t3"".""month"",""t3"".""country"",COALESCE(""cnt1"", 0) AS ""approved_count"",COALESCE(""sum1"", 0) AS ""approved_amount"",COALESCE(""cnt2"", 0) AS ""chargeback_count"",COALESCE(""sum2"", 0) AS ""chargeback_amount"" FROM (""t3"" LEFT JOIN ""t1"" ON ""t3"".""month""=""t1"".""month"" AND ""t3"".""country""=""t1"".""country"") LEFT JOIN ""t2"" ON ""t3"".""month""=""t2"".""month"" AND ""t3"".""country""=""t2"".""country"""
314,"WITH ""approved"" AS (SELECT TO_CHAR(""A"".""trans_date"", 'YYYY-%m') AS ""month"",""country"",COUNT(1) AS ""approved_count"",SUM(""amount"") AS ""approved_amount"" FROM ""Transactions"" AS ""A"" WHERE ""state""='approved' GROUP BY 1,2), ""chargeback"" AS (SELECT TO_CHAR(""B"".""trans_date"", 'YYYY-%m') AS ""month"",""country"",COUNT(1) AS ""chargeback_count"",SUM(""amount"") AS ""chargeback_amount"" FROM ""Transactions"" AS ""A"" RIGHT JOIN ""Chargebacks"" AS ""B"" ON ""A"".""id""=""B"".""trans_id"" GROUP BY 1,2) SELECT ""A"".""month"",""A"".""country"",COALESCE(""approved_count"", 0) AS ""approved_count"",COALESCE(""approved_amount"", 0) AS ""approved_amount"",COALESCE(""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""approved"" AS ""A"" LEFT JOIN ""chargeback"" AS ""B"" ON ""A"".""month""=""B"".""month"" AND ""A"".""country""=""B"".""country"" UNION SELECT ""B"".""month"",""B"".""country"",COALESCE(""approved_count"", 0) AS ""approved_count"",COALESCE(""approved_amount"", 0) AS ""approved_amount"",COALESCE(""chargeback_count"", 0) AS ""chargeback_count"",COALESCE(""chargeback_amount"", 0) AS ""chargeback_amount"" FROM ""approved"" AS ""A"" RIGHT JOIN ""chargeback"" AS ""B"" ON ""A"".""month""=""B"".""month"" AND ""A"".""country""=""B"".""country"""
315,"SELECT ""month"",""country"",COUNT(CASE WHEN ""sr""='income' THEN ""amount"" ELSE NULL END) AS ""approved_count"",SUM(CASE WHEN ""sr""='income' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",COUNT(CASE WHEN ""sr""='chargeback' THEN ""amount"" ELSE NULL END) AS ""chargeback_count"",SUM(CASE WHEN ""sr""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT ""country"",""amount"",LEFT(""trans_date"", 7) AS ""month"",'income' AS ""sr"" FROM ""transactions"" WHERE ""state""='approved' UNION ALL SELECT ""t"".""country"",""t"".""amount"",LEFT(""c"".""trans_date"", 7) AS ""month"",'chargeback' AS ""sr"" FROM ""transactions"" AS ""t"" JOIN ""chargebacks"" AS ""c"" ON ""t"".""id""=""c"".""trans_id"") AS ""final"" GROUP BY ""month"",""country"""
316,"SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='back' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='back' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT LEFT(""chargebacks"".""trans_date"", 7) AS ""month"",""country"",'back' AS ""state"",""amount"" FROM ""chargebacks"" JOIN ""transactions"" ON ""chargebacks"".""trans_id""=""transactions"".""id"" UNION ALL SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",""state"",""amount"" FROM ""transactions"" WHERE ""state""='approved') AS ""s"" GROUP BY ""month"",""country"""
317,"SELECT SUBSTRING(""trans_date"", 1, 7) AS ""month"",""country"",SUM(""state""='approved') AS ""approved_count"",SUM(CASE ""state"" WHEN 'approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(""state""='chargeback') AS ""chargeback_count"",SUM(CASE ""state"" WHEN 'chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT * FROM ""Transactions"" UNION (SELECT ""id"",""country"",'chargeback' AS ""state"",""amount"",""c"".""trans_date"" AS ""trans_date"" FROM ""Chargebacks"" AS ""c"" JOIN ""Transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"")) AS ""combine"" GROUP BY ""month"",""country"" HAVING (SUM(""state""='approved')+SUM(""state""='chargeback'))>0"
318,"SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='back' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='back' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT LEFT(""chargebacks"".""trans_date"", 7) AS ""month"",""country"",'back' AS ""state"",""amount"" FROM ""chargebacks"" JOIN ""transactions"" ON ""chargebacks"".""trans_id""=""transactions"".""id"" UNION ALL SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",""state"",""amount"" FROM ""transactions"" WHERE ""state""='approved') AS ""s"" GROUP BY ""month"",""country"""
319,"SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='chargeback' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='chargeback' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT * FROM ""transactions"" AS ""t"" UNION SELECT ""t"".""id"",""t"".""country"",'chargeback',""t"".""amount"",""c"".""trans_date"" FROM ""chargebacks"" AS ""c"" LEFT JOIN ""transactions"" AS ""t"" ON ""t"".""id""=""c"".""trans_id"") AS ""tmp"" GROUP BY 1,2 HAVING ""approved_count""!=0 OR ""approved_amount""!=0 OR ""chargeback_count""!=0 OR ""chargeback_amount""!=0"
320,"SELECT ""month"",""country"",SUM(CASE WHEN ""state""='approved' THEN 1 ELSE 0 END) AS ""approved_count"",SUM(CASE WHEN ""state""='approved' THEN ""amount"" ELSE 0 END) AS ""approved_amount"",SUM(CASE WHEN ""state""='back' THEN 1 ELSE 0 END) AS ""chargeback_count"",SUM(CASE WHEN ""state""='back' THEN ""amount"" ELSE 0 END) AS ""chargeback_amount"" FROM (SELECT LEFT(""chargebacks"".""trans_date"", 7) AS ""month"",""country"",'back' AS ""state"",""amount"" FROM ""chargebacks"" JOIN ""transactions"" ON ""chargebacks"".""trans_id""=""transactions"".""id"" UNION ALL SELECT LEFT(""trans_date"", 7) AS ""month"",""country"",""state"",""amount"" FROM ""transactions"" WHERE ""state""='approved') AS ""s"" GROUP BY ""month"",""country"""
321,"WITH ""summary"" AS (SELECT TO_CHAR(""c"".""trans_date"", 'YYYY-%m') AS ""month"",""t"".""country"",0 AS ""approved_count"",0 AS ""approved_amount"",COUNT(1) AS ""chargeback_count"",SUM(""t"".""amount"") AS ""chargeback_amount"" FROM ""chargebacks"" AS ""c"" JOIN ""transactions"" AS ""t"" ON ""c"".""trans_id""=""t"".""id"" GROUP BY ""month"",""t"".""country"" UNION ALL SELECT TO_CHAR(""trans_date"", 'YYYY-%m') AS ""month"",""country"",COUNT(1) AS ""approved_count"",SUM(""amount"") AS ""approved_amount"",0 AS ""chargeback_count"",0 AS ""chargeback_amount"" FROM ""transactions"" WHERE ""state""='approved' GROUP BY ""month"",""country"") SELECT ""month"",""country"",SUM(""approved_count"") AS ""approved_count"",SUM(""approved_amount"") AS ""approved_amount"",SUM(""chargeback_count"") AS ""chargeback_count"",SUM(""chargeback_amount"") AS ""chargeback_amount"" FROM ""summary"" GROUP BY ""month"",""country"""
